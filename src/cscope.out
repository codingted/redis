cscope 15 $HOME/git/liang/redis/src -q 0000010183 0001880044
	@adlist.c

32 
	~<¡dlib.h
>

33 
	~"adli¡.h
"

34 
	~"zm®loc.h
"

41 
li¡
 *
	$li¡C»©e
()

43 
li¡
 *list;

45 ià((
li¡
 = 
	`zm®loc
((*li¡))è=ğ
NULL
)

46  
NULL
;

47 
li¡
->
h—d
 =†i¡->

 = 
NULL
;

48 
li¡
->
Ën
 = 0;

49 
li¡
->
dup
 = 
NULL
;

50 
li¡
->
ä“
 = 
NULL
;

51 
li¡
->
m©ch
 = 
NULL
;

52  
li¡
;

53 
	}
}

56 
	$li¡Em±y
(
li¡
 *list)

58 
Ën
;

59 
li¡Node
 *
cu¼’t
, *
Ãxt
;

61 
cu¼’t
 = 
li¡
->
h—d
;

62 
Ën
 = 
li¡
->len;

63 
Ën
--) {

64 
Ãxt
 = 
cu¼’t
->next;

65 ià(
li¡
->
ä“
èli¡->
	`ä“
(
cu¼’t
->
v®ue
);

66 
	`zä“
(
cu¼’t
);

67 
cu¼’t
 = 
Ãxt
;

69 
li¡
->
h—d
 =†i¡->

 = 
NULL
;

70 
li¡
->
Ën
 = 0;

71 
	}
}

76 
	$li¡R–—£
(
li¡
 *list)

78 
	`li¡Em±y
(
li¡
);

79 
	`zä“
(
li¡
);

80 
	}
}

88 
li¡
 *
	$li¡AddNodeH—d
(
li¡
 *li¡, *
v®ue
)

90 
li¡Node
 *
node
;

92 ià((
node
 = 
	`zm®loc
((*node))è=ğ
NULL
)

93  
NULL
;

94 
node
->
v®ue
 = value;

95 ià(
li¡
->
Ën
 == 0) {

96 
li¡
->
h—d
 =†i¡->

 = 
node
;

97 
node
->
´ev
 =‚ode->
Ãxt
 = 
NULL
;

99 
node
->
´ev
 = 
NULL
;

100 
node
->
Ãxt
 = 
li¡
->
h—d
;

101 
li¡
->
h—d
->
´ev
 = 
node
;

102 
li¡
->
h—d
 = 
node
;

104 
li¡
->
Ën
++;

105  
li¡
;

106 
	}
}

114 
li¡
 *
	$li¡AddNodeTa
(
li¡
 *li¡, *
v®ue
)

116 
li¡Node
 *
node
;

118 ià((
node
 = 
	`zm®loc
((*node))è=ğ
NULL
)

119  
NULL
;

120 
node
->
v®ue
 = value;

121 ià(
li¡
->
Ën
 == 0) {

122 
li¡
->
h—d
 =†i¡->

 = 
node
;

123 
node
->
´ev
 =‚ode->
Ãxt
 = 
NULL
;

125 
node
->
´ev
 = 
li¡
->

;

126 
node
->
Ãxt
 = 
NULL
;

127 
li¡
->

->
Ãxt
 = 
node
;

128 
li¡
->

 = 
node
;

130 
li¡
->
Ën
++;

131  
li¡
;

132 
	}
}

134 
li¡
 *
	$li¡In£¹Node
(
li¡
 *li¡, 
li¡Node
 *
Şd_node
, *
v®ue
, 
aá”
) {

135 
li¡Node
 *
node
;

137 ià((
node
 = 
	`zm®loc
((*node))è=ğ
NULL
)

138  
NULL
;

139 
node
->
v®ue
 = value;

140 ià(
aá”
) {

141 
node
->
´ev
 = 
Şd_node
;

142 
node
->
Ãxt
 = 
Şd_node
->next;

143 ià(
li¡
->

 =ğ
Şd_node
) {

144 
li¡
->

 = 
node
;

147 
node
->
Ãxt
 = 
Şd_node
;

148 
node
->
´ev
 = 
Şd_node
->prev;

149 ià(
li¡
->
h—d
 =ğ
Şd_node
) {

150 
li¡
->
h—d
 = 
node
;

153 ià(
node
->
´ev
 !ğ
NULL
) {

154 
node
->
´ev
->
Ãxt
 =‚ode;

156 ià(
node
->
Ãxt
 !ğ
NULL
) {

157 
node
->
Ãxt
->
´ev
 =‚ode;

159 
li¡
->
Ën
++;

160  
li¡
;

161 
	}
}

167 
	$li¡D–Node
(
li¡
 *li¡, 
li¡Node
 *
node
)

169 ià(
node
->
´ev
)

170 
node
->
´ev
->
Ãxt
 =‚ode->next;

172 
li¡
->
h—d
 = 
node
->
Ãxt
;

173 ià(
node
->
Ãxt
)

174 
node
->
Ãxt
->
´ev
 =‚ode->prev;

176 
li¡
->

 = 
node
->
´ev
;

177 ià(
li¡
->
ä“
èli¡->
	`ä“
(
node
->
v®ue
);

178 
	`zä“
(
node
);

179 
li¡
->
Ën
--;

180 
	}
}

186 
li¡I‹r
 *
	$li¡G‘I‹¿tÜ
(
li¡
 *li¡, 
dœeùiÚ
)

188 
li¡I‹r
 *
™”
;

190 ià((
™”
 = 
	`zm®loc
((*™”))è=ğ
NULL
)  NULL;

191 ià(
dœeùiÚ
 =ğ
AL_START_HEAD
)

192 
™”
->
Ãxt
 = 
li¡
->
h—d
;

194 
™”
->
Ãxt
 = 
li¡
->

;

195 
™”
->
dœeùiÚ
 = direction;

196  
™”
;

197 
	}
}

200 
	$li¡R–—£I‹¿tÜ
(
li¡I‹r
 *
™”
) {

201 
	`zä“
(
™”
);

202 
	}
}

205 
	$li¡Rewšd
(
li¡
 *li¡, 
li¡I‹r
 *
li
) {

206 
li
->
Ãxt
 = 
li¡
->
h—d
;

207 
li
->
dœeùiÚ
 = 
AL_START_HEAD
;

208 
	}
}

210 
	$li¡RewšdTa
(
li¡
 *li¡, 
li¡I‹r
 *
li
) {

211 
li
->
Ãxt
 = 
li¡
->

;

212 
li
->
dœeùiÚ
 = 
AL_START_TAIL
;

213 
	}
}

229 
li¡Node
 *
	$li¡Next
(
li¡I‹r
 *
™”
)

231 
li¡Node
 *
cu¼’t
 = 
™”
->
Ãxt
;

233 ià(
cu¼’t
 !ğ
NULL
) {

234 ià(
™”
->
dœeùiÚ
 =ğ
AL_START_HEAD
)

235 
™”
->
Ãxt
 = 
cu¼’t
->next;

237 
™”
->
Ãxt
 = 
cu¼’t
->
´ev
;

239  
cu¼’t
;

240 
	}
}

250 
li¡
 *
	$li¡Dup
(
li¡
 *
Üig
)

252 
li¡
 *
cİy
;

253 
li¡I‹r
 
™”
;

254 
li¡Node
 *
node
;

256 ià((
cİy
 = 
	`li¡C»©e
()è=ğ
NULL
)

257  
NULL
;

258 
cİy
->
dup
 = 
Üig
->dup;

259 
cİy
->
ä“
 = 
Üig
->free;

260 
cİy
->
m©ch
 = 
Üig
->match;

261 
	`li¡Rewšd
(
Üig
, &
™”
);

262 (
node
 = 
	`li¡Next
(&
™”
)è!ğ
NULL
) {

263 *
v®ue
;

265 ià(
cİy
->
dup
) {

266 
v®ue
 = 
cİy
->
	`dup
(
node
->value);

267 ià(
v®ue
 =ğ
NULL
) {

268 
	`li¡R–—£
(
cİy
);

269  
NULL
;

272 
v®ue
 = 
node
->value;

273 ià(
	`li¡AddNodeTa
(
cİy
, 
v®ue
è=ğ
NULL
) {

274 
	`li¡R–—£
(
cİy
);

275  
NULL
;

278  
cİy
;

279 
	}
}

290 
li¡Node
 *
	$li¡S—rchKey
(
li¡
 *li¡, *
key
)

292 
li¡I‹r
 
™”
;

293 
li¡Node
 *
node
;

295 
	`li¡Rewšd
(
li¡
, &
™”
);

296 (
node
 = 
	`li¡Next
(&
™”
)è!ğ
NULL
) {

297 ià(
li¡
->
m©ch
) {

298 ià(
li¡
->
	`m©ch
(
node
->
v®ue
, 
key
)) {

299  
node
;

302 ià(
key
 =ğ
node
->
v®ue
) {

303  
node
;

307  
NULL
;

308 
	}
}

315 
li¡Node
 *
	$li¡Index
(
li¡
 *li¡, 
šdex
) {

316 
li¡Node
 *
n
;

318 ià(
šdex
 < 0) {

319 
šdex
 = (-index)-1;

320 
n
 = 
li¡
->

;

321 
šdex
-- && 
n
èÀğn->
´ev
;

323 
n
 = 
li¡
->
h—d
;

324 
šdex
-- && 
n
èÀğn->
Ãxt
;

326  
n
;

327 
	}
}

330 
	$li¡RÙ©e
(
li¡
 *list) {

331 
li¡Node
 *

 = 
li¡
->tail;

333 ià(
	`li¡L’gth
(
li¡
) <= 1) ;

336 
li¡
->

 =a->
´ev
;

337 
li¡
->

->
Ãxt
 = 
NULL
;

339 
li¡
->
h—d
->
´ev
 = 

;

340 

->
´ev
 = 
NULL
;

341 

->
Ãxt
 = 
li¡
->
h—d
;

342 
li¡
->
h—d
 = 

;

343 
	}
}

347 
	$li¡Još
(
li¡
 *
l
,†i¡ *
o
) {

348 ià(
o
->
h—d
)

349 
o
->
h—d
->
´ev
 = 
l
->

;

351 ià(
l
->

)

352 
l
->

->
Ãxt
 = 
o
->
h—d
;

354 
l
->
h—d
 = 
o
->head;

356 
l
->

 = 
o
->tail;

357 
l
->
Ën
 +ğ
o
->len;

360 
o
->
h—d
 = o->

 = 
NULL
;

361 
o
->
Ën
 = 0;

362 
	}
}

	@adlist.h

31 #iâdeà
__ADLIST_H__


32 
	#__ADLIST_H__


	)

36 
	sli¡Node
 {

37 
li¡Node
 *
	m´ev
;

38 
li¡Node
 *
	mÃxt
;

39 *
	mv®ue
;

40 } 
	tli¡Node
;

42 
	sli¡I‹r
 {

43 
li¡Node
 *
	mÃxt
;

44 
	mdœeùiÚ
;

45 } 
	tli¡I‹r
;

47 
	sli¡
 {

48 
li¡Node
 *
	mh—d
;

49 
li¡Node
 *
	m
;

50 *(*
	mdup
)(*
	m±r
);

51 (*
	mä“
)(*
	m±r
);

52 (*
	mm©ch
)(*
	m±r
, *
	mkey
);

53 
	mËn
;

54 } 
	tli¡
;

57 
	#li¡L’gth
(
l
è(Ö)->
Ën
)

	)

58 
	#li¡Fœ¡
(
l
è(Ö)->
h—d
)

	)

59 
	#li¡La¡
(
l
è(Ö)->

)

	)

60 
	#li¡P»vNode
(
n
è(Ò)->
´ev
)

	)

61 
	#li¡NextNode
(
n
è(Ò)->
Ãxt
)

	)

62 
	#li¡NodeV®ue
(
n
è(Ò)->
v®ue
)

	)

64 
	#li¡S‘DupM‘hod
(
l
,
m
è(Ö)->
dup
 = (m))

	)

65 
	#li¡S‘F»eM‘hod
(
l
,
m
è(Ö)->
ä“
 = (m))

	)

66 
	#li¡S‘M©chM‘hod
(
l
,
m
è(Ö)->
m©ch
 = (m))

	)

68 
	#li¡G‘DupM‘hod
(
l
è(Ö)->
dup
)

	)

69 
	#li¡G‘F»e
(
l
è(Ö)->
ä“
)

	)

70 
	#li¡G‘M©chM‘hod
(
l
è(Ö)->
m©ch
)

	)

73 
li¡
 *
li¡C»©e
();

74 
li¡R–—£
(
li¡
 *list);

75 
li¡Em±y
(
li¡
 *list);

76 
li¡
 *
li¡AddNodeH—d
Öi¡ *li¡, *
v®ue
);

77 
li¡
 *
li¡AddNodeTa
Öi¡ *li¡, *
v®ue
);

78 
li¡
 *
li¡In£¹Node
Öi¡ *li¡, 
li¡Node
 *
Şd_node
, *
v®ue
, 
aá”
);

79 
li¡D–Node
(
li¡
 *li¡, 
li¡Node
 *
node
);

80 
li¡I‹r
 *
li¡G‘I‹¿tÜ
(
li¡
 *li¡, 
dœeùiÚ
);

81 
li¡Node
 *
li¡Next
(
li¡I‹r
 *
™”
);

82 
li¡R–—£I‹¿tÜ
(
li¡I‹r
 *
™”
);

83 
li¡
 *
li¡Dup
Öi¡ *
Üig
);

84 
li¡Node
 *
li¡S—rchKey
(
li¡
 *li¡, *
key
);

85 
li¡Node
 *
li¡Index
(
li¡
 *li¡, 
šdex
);

86 
li¡Rewšd
(
li¡
 *li¡, 
li¡I‹r
 *
li
);

87 
li¡RewšdTa
(
li¡
 *li¡, 
li¡I‹r
 *
li
);

88 
li¡RÙ©e
(
li¡
 *list);

89 
li¡Još
(
li¡
 *
l
,†i¡ *
o
);

92 
	#AL_START_HEAD
 0

	)

93 
	#AL_START_TAIL
 1

	)

	@ae.c

33 
	~<¡dio.h
>

34 
	~<sys/time.h
>

35 
	~<sys/ty³s.h
>

36 
	~<uni¡d.h
>

37 
	~<¡dlib.h
>

38 
	~<pŞl.h
>

39 
	~<¡ršg.h
>

40 
	~<time.h
>

41 
	~<”ºo.h
>

43 
	~"«.h
"

44 
	~"zm®loc.h
"

45 
	~"cÚfig.h
"

49 #ifdeà
HAVE_EVPORT


50 
	~"«_evpÜt.c
"

52 #ifdeà
HAVE_EPOLL


53 
	~"«_•Şl.c
"

55 #ifdeà
HAVE_KQUEUE


56 
	~"«_kqueue.c
"

58 
	~"«_£Ëù.c
"

63 
«Ev’tLoİ
 *
	$«C»©eEv’tLoİ
(
£tsize
) {

64 
«Ev’tLoİ
 *
ev’tLoİ
;

65 
i
;

67 ià((
ev’tLoİ
 = 
	`zm®loc
((*ev’tLoİ))è=ğ
NULL
è
”r
;

68 
ev’tLoİ
->
ev’ts
 = 
	`zm®loc
((
«FeEv’t
)*
£tsize
);

69 
ev’tLoİ
->
fœed
 = 
	`zm®loc
((
«FœedEv’t
)*
£tsize
);

70 ià(
ev’tLoİ
->
ev’ts
 =ğ
NULL
 ||ƒv’tLoİ->
fœed
 =ğNULLè
”r
;

71 
ev’tLoİ
->
£tsize
 = setsize;

72 
ev’tLoİ
->
Ï¡Time
 = 
	`time
(
NULL
);

73 
ev’tLoİ
->
timeEv’tH—d
 = 
NULL
;

74 
ev’tLoİ
->
timeEv’tNextId
 = 0;

75 
ev’tLoİ
->
¡İ
 = 0;

76 
ev’tLoİ
->
maxfd
 = -1;

77 
ev’tLoİ
->
befÜe¦“p
 = 
NULL
;

78 
ev’tLoİ
->
aá”¦“p
 = 
NULL
;

79 ià(
	`«ApiC»©e
(
ev’tLoİ
è=ğ-1è
”r
;

82 
i
 = 0; i < 
£tsize
; i++)

83 
ev’tLoİ
->
ev’ts
[
i
].
mask
 = 
AE_NONE
;

84  
ev’tLoİ
;

86 
”r
:

87 ià(
ev’tLoİ
) {

88 
	`zä“
(
ev’tLoİ
->
ev’ts
);

89 
	`zä“
(
ev’tLoİ
->
fœed
);

90 
	`zä“
(
ev’tLoİ
);

92  
NULL
;

93 
	}
}

96 
	$«G‘S‘Size
(
«Ev’tLoİ
 *
ev’tLoİ
) {

97  
ev’tLoİ
->
£tsize
;

98 
	}
}

107 
	$«ResizeS‘Size
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

108 
i
;

110 ià(
£tsize
 =ğ
ev’tLoİ
->£tsizeè 
AE_OK
;

111 ià(
ev’tLoİ
->
maxfd
 >ğ
£tsize
è 
AE_ERR
;

112 ià(
	`«ApiResize
(
ev’tLoİ
,
£tsize
è=ğ-1è 
AE_ERR
;

114 
ev’tLoİ
->
ev’ts
 = 
	`z»®loc
Óv’tLoİ->ev’ts,(
«FeEv’t
)*
£tsize
);

115 
ev’tLoİ
->
fœed
 = 
	`z»®loc
Óv’tLoİ->fœed,(
«FœedEv’t
)*
£tsize
);

116 
ev’tLoİ
->
£tsize
 = setsize;

120 
i
 = 
ev’tLoİ
->
maxfd
+1; i < 
£tsize
; i++)

121 
ev’tLoİ
->
ev’ts
[
i
].
mask
 = 
AE_NONE
;

122  
AE_OK
;

123 
	}
}

125 
	$«D–‘eEv’tLoİ
(
«Ev’tLoİ
 *
ev’tLoİ
) {

126 
	`«ApiF»e
(
ev’tLoİ
);

127 
	`zä“
(
ev’tLoİ
->
ev’ts
);

128 
	`zä“
(
ev’tLoİ
->
fœed
);

129 
	`zä“
(
ev’tLoİ
);

130 
	}
}

132 
	$«Stİ
(
«Ev’tLoİ
 *
ev’tLoİ
) {

133 
ev’tLoİ
->
¡İ
 = 1;

134 
	}
}

136 
	$«C»©eFeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
,

137 
«FeProc
 *
´oc
, *
ş›ÁD©a
)

139 ià(
fd
 >ğ
ev’tLoİ
->
£tsize
) {

140 
”ºo
 = 
ERANGE
;

141  
AE_ERR
;

143 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[
fd
];

145 ià(
	`«ApiAddEv’t
(
ev’tLoİ
, 
fd
, 
mask
) == -1)

146  
AE_ERR
;

147 
ã
->
mask
 |= mask;

148 ià(
mask
 & 
AE_READABLE
è
ã
->
rfeProc
 = 
´oc
;

149 ià(
mask
 & 
AE_WRITABLE
è
ã
->
wfeProc
 = 
´oc
;

150 
ã
->
ş›ÁD©a
 = clientData;

151 ià(
fd
 > 
ev’tLoİ
->
maxfd
)

152 
ev’tLoİ
->
maxfd
 = 
fd
;

153  
AE_OK
;

154 
	}
}

156 
	$«D–‘eFeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
)

158 ià(
fd
 >ğ
ev’tLoİ
->
£tsize
) ;

159 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[
fd
];

160 ià(
ã
->
mask
 =ğ
AE_NONE
) ;

162 
	`«ApiD–Ev’t
(
ev’tLoİ
, 
fd
, 
mask
);

163 
ã
->
mask
 = fe->mask & (~mask);

164 ià(
fd
 =ğ
ev’tLoİ
->
maxfd
 && 
ã
->
mask
 =ğ
AE_NONE
) {

166 
j
;

168 
j
 = 
ev’tLoİ
->
maxfd
-1; j >= 0; j--)

169 ià(
ev’tLoİ
->
ev’ts
[
j
].
mask
 !ğ
AE_NONE
) ;

170 
ev’tLoİ
->
maxfd
 = 
j
;

172 
	}
}

174 
	$«G‘FeEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
) {

175 ià(
fd
 >ğ
ev’tLoİ
->
£tsize
)  0;

176 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[
fd
];

178  
ã
->
mask
;

179 
	}
}

181 
	$«G‘Time
(*
£cÚds
, *
mli£cÚds
)

183 
timev®
 
tv
;

185 
	`g‘timeofday
(&
tv
, 
NULL
);

186 *
£cÚds
 = 
tv
.
tv_£c
;

187 *
mli£cÚds
 = 
tv
.
tv_u£c
/1000;

188 
	}
}

190 
	$«AddMli£cÚdsToNow
(
mli£cÚds
, *
£c
, *
ms
) {

191 
cur_£c
, 
cur_ms
, 
wh’_£c
, 
wh’_ms
;

193 
	`«G‘Time
(&
cur_£c
, &
cur_ms
);

194 
wh’_£c
 = 
cur_£c
 + 
mli£cÚds
/1000;

195 
wh’_ms
 = 
cur_ms
 + 
mli£cÚds
%1000;

196 ià(
wh’_ms
 >= 1000) {

197 
wh’_£c
 ++;

198 
wh’_ms
 -= 1000;

200 *
£c
 = 
wh’_£c
;

201 *
ms
 = 
wh’_ms
;

202 
	}
}

204 
	$«C»©eTimeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
mli£cÚds
,

205 
«TimeProc
 *
´oc
, *
ş›ÁD©a
,

206 
«Ev’tFš®iz”Proc
 *
fš®iz”Proc
)

208 
id
 = 
ev’tLoİ
->
timeEv’tNextId
++;

209 
«TimeEv’t
 *
‹
;

211 
‹
 = 
	`zm®loc
((*te));

212 ià(
‹
 =ğ
NULL
è 
AE_ERR
;

213 
‹
->
id
 = id;

214 
	`«AddMli£cÚdsToNow
(
mli£cÚds
,&
‹
->
wh’_£c
,&‹->
wh’_ms
);

215 
‹
->
timeProc
 = 
´oc
;

216 
‹
->
fš®iz”Proc
 = finalizerProc;

217 
‹
->
ş›ÁD©a
 = clientData;

218 
‹
->
Ãxt
 = 
ev’tLoİ
->
timeEv’tH—d
;

219 
ev’tLoİ
->
timeEv’tH—d
 = 
‹
;

220  
id
;

221 
	}
}

223 
	$«D–‘eTimeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
)

225 
«TimeEv’t
 *
‹
 = 
ev’tLoİ
->
timeEv’tH—d
;

226 
‹
) {

227 ià(
‹
->
id
 == id) {

228 
‹
->
id
 = 
AE_DELETED_EVENT_ID
;

229  
AE_OK
;

231 
‹
 =e->
Ãxt
;

233  
AE_ERR
;

234 
	}
}

247 
«TimeEv’t
 *
	$«S—rchN—»¡Tim”
(
«Ev’tLoİ
 *
ev’tLoİ
)

249 
«TimeEv’t
 *
‹
 = 
ev’tLoİ
->
timeEv’tH—d
;

250 
«TimeEv’t
 *
Ã¬e¡
 = 
NULL
;

252 
‹
) {

253 ià(!
Ã¬e¡
 || 
‹
->
wh’_£c
 <‚earest->when_sec ||

254 (
‹
->
wh’_£c
 =ğ
Ã¬e¡
->when_sec &&

255 
‹
->
wh’_ms
 < 
Ã¬e¡
->when_ms))

256 
Ã¬e¡
 = 
‹
;

257 
‹
 =e->
Ãxt
;

259  
Ã¬e¡
;

260 
	}
}

263 
	$´oûssTimeEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
) {

264 
´oûs£d
 = 0;

265 
«TimeEv’t
 *
‹
, *
´ev
;

266 
maxId
;

267 
time_t
 
now
 = 
	`time
(
NULL
);

277 ià(
now
 < 
ev’tLoİ
->
Ï¡Time
) {

278 
‹
 = 
ev’tLoİ
->
timeEv’tH—d
;

279 
‹
) {

280 
‹
->
wh’_£c
 = 0;

281 
‹
 =e->
Ãxt
;

284 
ev’tLoİ
->
Ï¡Time
 = 
now
;

286 
´ev
 = 
NULL
;

287 
‹
 = 
ev’tLoİ
->
timeEv’tH—d
;

288 
maxId
 = 
ev’tLoİ
->
timeEv’tNextId
-1;

289 
‹
) {

290 
now_£c
, 
now_ms
;

291 
id
;

294 ià(
‹
->
id
 =ğ
AE_DELETED_EVENT_ID
) {

295 
«TimeEv’t
 *
Ãxt
 = 
‹
->next;

296 ià(
´ev
 =ğ
NULL
)

297 
ev’tLoİ
->
timeEv’tH—d
 = 
‹
->
Ãxt
;

299 
´ev
->
Ãxt
 = 
‹
->next;

300 ià(
‹
->
fš®iz”Proc
)

301 
‹
->
	`fš®iz”Proc
(
ev’tLoİ
,e->
ş›ÁD©a
);

302 
	`zä“
(
‹
);

303 
‹
 = 
Ãxt
;

312 ià(
‹
->
id
 > 
maxId
) {

313 
‹
 =e->
Ãxt
;

316 
	`«G‘Time
(&
now_£c
, &
now_ms
);

317 ià(
now_£c
 > 
‹
->
wh’_£c
 ||

318 (
now_£c
 =ğ
‹
->
wh’_£c
 && 
now_ms
 >ğ‹->
wh’_ms
))

320 
»tv®
;

322 
id
 = 
‹
->id;

323 
»tv®
 = 
‹
->
	`timeProc
(
ev’tLoİ
, 
id
,e->
ş›ÁD©a
);

324 
´oûs£d
++;

325 ià(
»tv®
 !ğ
AE_NOMORE
) {

326 
	`«AddMli£cÚdsToNow
(
»tv®
,&
‹
->
wh’_£c
,&‹->
wh’_ms
);

328 
‹
->
id
 = 
AE_DELETED_EVENT_ID
;

331 
´ev
 = 
‹
;

332 
‹
 =e->
Ãxt
;

334  
´oûs£d
;

335 
	}
}

351 
	$«ProûssEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
, 
æags
)

353 
´oûs£d
 = 0, 
numev’ts
;

356 ià(!(
æags
 & 
AE_TIME_EVENTS
è&& !(æag & 
AE_FILE_EVENTS
))  0;

362 ià(
ev’tLoİ
->
maxfd
 != -1 ||

363 ((
æags
 & 
AE_TIME_EVENTS
è&& !(æag & 
AE_DONT_WAIT
))) {

364 
j
;

365 
«TimeEv’t
 *
shÜ‹¡
 = 
NULL
;

366 
timev®
 
tv
, *
tvp
;

368 ià(
æags
 & 
AE_TIME_EVENTS
 && !(æag & 
AE_DONT_WAIT
))

369 
shÜ‹¡
 = 
	`«S—rchN—»¡Tim”
(
ev’tLoİ
);

370 ià(
shÜ‹¡
) {

371 
now_£c
, 
now_ms
;

373 
	`«G‘Time
(&
now_£c
, &
now_ms
);

374 
tvp
 = &
tv
;

378 
ms
 =

379 (
shÜ‹¡
->
wh’_£c
 - 
now_£c
)*1000 +

380 
shÜ‹¡
->
wh’_ms
 - 
now_ms
;

382 ià(
ms
 > 0) {

383 
tvp
->
tv_£c
 = 
ms
/1000;

384 
tvp
->
tv_u£c
 = (
ms
 % 1000)*1000;

386 
tvp
->
tv_£c
 = 0;

387 
tvp
->
tv_u£c
 = 0;

393 ià(
æags
 & 
AE_DONT_WAIT
) {

394 
tv
.
tv_£c
 =v.
tv_u£c
 = 0;

395 
tvp
 = &
tv
;

398 
tvp
 = 
NULL
;

404 
numev’ts
 = 
	`«ApiPŞl
(
ev’tLoİ
, 
tvp
);

407 ià(
ev’tLoİ
->
aá”¦“p
 !ğ
NULL
 && 
æags
 & 
AE_CALL_AFTER_SLEEP
)

408 
ev’tLoİ
->
	`aá”¦“p
(eventLoop);

410 
j
 = 0; j < 
numev’ts
; j++) {

411 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[ev’tLoİ->
fœed
[
j
].
fd
];

412 
mask
 = 
ev’tLoİ
->
fœed
[
j
].mask;

413 
fd
 = 
ev’tLoİ
->
fœed
[
j
].fd;

414 
rfœed
 = 0;

419 ià(
ã
->
mask
 & mask & 
AE_READABLE
) {

420 
rfœed
 = 1;

421 
ã
->
	`rfeProc
(
ev’tLoİ
,
fd
,ã->
ş›ÁD©a
,
mask
);

423 ià(
ã
->
mask
 & mask & 
AE_WRITABLE
) {

424 ià(!
rfœed
 || 
ã
->
wfeProc
 !ğã->
rfeProc
)

425 
ã
->
	`wfeProc
(
ev’tLoİ
,
fd
,ã->
ş›ÁD©a
,
mask
);

427 
´oûs£d
++;

431 ià(
æags
 & 
AE_TIME_EVENTS
)

432 
´oûs£d
 +ğ
	`´oûssTimeEv’ts
(
ev’tLoİ
);

434  
´oûs£d
;

435 
	}
}

439 
	$«Wa™
(
fd
, 
mask
, 
mli£cÚds
) {

440 
pŞlfd
 
pfd
;

441 
»tmask
 = 0, 
»tv®
;

443 
	`mem£t
(&
pfd
, 0, (pfd));

444 
pfd
.
fd
 = fd;

445 ià(
mask
 & 
AE_READABLE
è
pfd
.
ev’ts
 |ğ
POLLIN
;

446 ià(
mask
 & 
AE_WRITABLE
è
pfd
.
ev’ts
 |ğ
POLLOUT
;

448 ià((
»tv®
 = 
	`pŞl
(&
pfd
, 1, 
mli£cÚds
))== 1) {

449 ià(
pfd
.
»v’ts
 & 
POLLIN
è
»tmask
 |ğ
AE_READABLE
;

450 ià(
pfd
.
»v’ts
 & 
POLLOUT
è
»tmask
 |ğ
AE_WRITABLE
;

451 ià(
pfd
.
»v’ts
 & 
POLLERR
è
»tmask
 |ğ
AE_WRITABLE
;

452 ià(
pfd
.
»v’ts
 & 
POLLHUP
è
»tmask
 |ğ
AE_WRITABLE
;

453  
»tmask
;

455  
»tv®
;

457 
	}
}

459 
	$«Maš
(
«Ev’tLoİ
 *
ev’tLoİ
) {

460 
ev’tLoİ
->
¡İ
 = 0;

461 !
ev’tLoİ
->
¡İ
) {

462 ià(
ev’tLoİ
->
befÜe¦“p
 !ğ
NULL
)

463 
ev’tLoİ
->
	`befÜe¦“p
(eventLoop);

464 
	`«ProûssEv’ts
(
ev’tLoİ
, 
AE_ALL_EVENTS
|
AE_CALL_AFTER_SLEEP
);

466 
	}
}

468 *
	$«G‘ApiName
() {

469  
	`«ApiName
();

470 
	}
}

472 
	$«S‘BefÜeSË•Proc
(
«Ev’tLoİ
 *
ev’tLoİ
, 
«BefÜeSË•Proc
 *
befÜe¦“p
) {

473 
ev’tLoİ
->
befÜe¦“p
 = beforesleep;

474 
	}
}

476 
	$«S‘Aá”SË•Proc
(
«Ev’tLoİ
 *
ev’tLoİ
, 
«BefÜeSË•Proc
 *
aá”¦“p
) {

477 
ev’tLoİ
->
aá”¦“p
 =‡ftersleep;

478 
	}
}

	@ae.h

33 #iâdeà
__AE_H__


34 
	#__AE_H__


	)

36 
	~<time.h
>

38 
	#AE_OK
 0

	)

39 
	#AE_ERR
 -1

	)

41 
	#AE_NONE
 0

	)

42 
	#AE_READABLE
 1

	)

43 
	#AE_WRITABLE
 2

	)

45 
	#AE_FILE_EVENTS
 1

	)

46 
	#AE_TIME_EVENTS
 2

	)

47 
	#AE_ALL_EVENTS
 (
AE_FILE_EVENTS
|
AE_TIME_EVENTS
)

	)

48 
	#AE_DONT_WAIT
 4

	)

49 
	#AE_CALL_AFTER_SLEEP
 8

	)

51 
	#AE_NOMORE
 -1

	)

52 
	#AE_DELETED_EVENT_ID
 -1

	)

55 
	#AE_NOTUSED
(
V
è((èV)

	)

57 
	g«Ev’tLoİ
;

60 
	t«FeProc
(
	t«Ev’tLoİ
 *
	tev’tLoİ
, 
	tfd
, *
	tş›ÁD©a
, 
	tmask
);

61 
	t«TimeProc
(
	t«Ev’tLoİ
 *
	tev’tLoİ
, 
	tid
, *
	tş›ÁD©a
);

62 
	t«Ev’tFš®iz”Proc
(
	t«Ev’tLoİ
 *
	tev’tLoİ
, *
	tş›ÁD©a
);

63 
	t«BefÜeSË•Proc
(
	t«Ev’tLoİ
 *
	tev’tLoİ
);

66 
	s«FeEv’t
 {

67 
	mmask
;

68 
«FeProc
 *
	mrfeProc
;

69 
«FeProc
 *
	mwfeProc
;

70 *
	mş›ÁD©a
;

71 } 
	t«FeEv’t
;

74 
	s«TimeEv’t
 {

75 
	mid
;

76 
	mwh’_£c
;

77 
	mwh’_ms
;

78 
«TimeProc
 *
	mtimeProc
;

79 
«Ev’tFš®iz”Proc
 *
	mfš®iz”Proc
;

80 *
	mş›ÁD©a
;

81 
«TimeEv’t
 *
	mÃxt
;

82 } 
	t«TimeEv’t
;

85 
	s«FœedEv’t
 {

86 
	mfd
;

87 
	mmask
;

88 } 
	t«FœedEv’t
;

91 
	s«Ev’tLoİ
 {

92 
	mmaxfd
;

93 
	m£tsize
;

94 
	mtimeEv’tNextId
;

95 
time_t
 
	mÏ¡Time
;

96 
«FeEv’t
 *
	mev’ts
;

97 
«FœedEv’t
 *
	mfœed
;

98 
«TimeEv’t
 *
	mtimeEv’tH—d
;

99 
	m¡İ
;

100 *
	m­id©a
;

101 
«BefÜeSË•Proc
 *
	mbefÜe¦“p
;

102 
«BefÜeSË•Proc
 *
	maá”¦“p
;

103 } 
	t«Ev’tLoİ
;

106 
«Ev’tLoİ
 *
«C»©eEv’tLoİ
(
£tsize
);

107 
«D–‘eEv’tLoİ
(
«Ev’tLoİ
 *
ev’tLoİ
);

108 
«Stİ
(
«Ev’tLoİ
 *
ev’tLoİ
);

109 
«C»©eFeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
,

110 
«FeProc
 *
´oc
, *
ş›ÁD©a
);

111 
«D–‘eFeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
);

112 
«G‘FeEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
);

113 
«C»©eTimeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
mli£cÚds
,

114 
«TimeProc
 *
´oc
, *
ş›ÁD©a
,

115 
«Ev’tFš®iz”Proc
 *
fš®iz”Proc
);

116 
«D–‘eTimeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
);

117 
«ProûssEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
, 
æags
);

118 
«Wa™
(
fd
, 
mask
, 
mli£cÚds
);

119 
«Maš
(
«Ev’tLoİ
 *
ev’tLoİ
);

120 *
«G‘ApiName
();

121 
«S‘BefÜeSË•Proc
(
«Ev’tLoİ
 *
ev’tLoİ
, 
«BefÜeSË•Proc
 *
befÜe¦“p
);

122 
«S‘Aá”SË•Proc
(
«Ev’tLoİ
 *
ev’tLoİ
, 
«BefÜeSË•Proc
 *
aá”¦“p
);

123 
«G‘S‘Size
(
«Ev’tLoİ
 *
ev’tLoİ
);

124 
«ResizeS‘Size
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
);

	@ae_epoll.c

32 
	~<sys/•Şl.h
>

34 
	s«ApiS‹
 {

35 
	m•fd
;

36 
•Şl_ev’t
 *
	mev’ts
;

37 } 
	t«ApiS‹
;

39 
	$«ApiC»©e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

40 
«ApiS‹
 *
¡©e
 = 
	`zm®loc
((aeApiState));

42 ià(!
¡©e
)  -1;

43 
¡©e
->
ev’ts
 = 
	`zm®loc
((
•Şl_ev’t
)*
ev’tLoİ
->
£tsize
);

44 ià(!
¡©e
->
ev’ts
) {

45 
	`zä“
(
¡©e
);

48 
¡©e
->
•fd
 = 
	`•Şl_ü—‹
(1024);

49 ià(
¡©e
->
•fd
 == -1) {

50 
	`zä“
(
¡©e
->
ev’ts
);

51 
	`zä“
(
¡©e
);

54 
ev’tLoİ
->
­id©a
 = 
¡©e
;

56 
	}
}

58 
	$«ApiResize
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

59 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

61 
¡©e
->
ev’ts
 = 
	`z»®loc
(¡©e->ev’ts, (
•Şl_ev’t
)*
£tsize
);

63 
	}
}

65 
	$«ApiF»e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

66 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

68 
	`şo£
(
¡©e
->
•fd
);

69 
	`zä“
(
¡©e
->
ev’ts
);

70 
	`zä“
(
¡©e
);

71 
	}
}

73 
	$«ApiAddEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

74 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

75 
•Şl_ev’t
 
“
 = {0};

78 
İ
 = 
ev’tLoİ
->
ev’ts
[
fd
].
mask
 =ğ
AE_NONE
 ?

79 
EPOLL_CTL_ADD
 : 
EPOLL_CTL_MOD
;

81 
“
.
ev’ts
 = 0;

82 
mask
 |ğ
ev’tLoİ
->
ev’ts
[
fd
].mask;

83 ià(
mask
 & 
AE_READABLE
è
“
.
ev’ts
 |ğ
EPOLLIN
;

84 ià(
mask
 & 
AE_WRITABLE
è
“
.
ev’ts
 |ğ
EPOLLOUT
;

85 
“
.
d©a
.
fd
 = fd;

86 ià(
	`•Şl_ùl
(
¡©e
->
•fd
,
İ
,
fd
,&
“
) == -1)  -1;

88 
	}
}

90 
	$«ApiD–Ev’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
d–mask
) {

91 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

92 
•Şl_ev’t
 
“
 = {0};

93 
mask
 = 
ev’tLoİ
->
ev’ts
[
fd
].mask & (~
d–mask
);

95 
“
.
ev’ts
 = 0;

96 ià(
mask
 & 
AE_READABLE
è
“
.
ev’ts
 |ğ
EPOLLIN
;

97 ià(
mask
 & 
AE_WRITABLE
è
“
.
ev’ts
 |ğ
EPOLLOUT
;

98 
“
.
d©a
.
fd
 = fd;

99 ià(
mask
 !ğ
AE_NONE
) {

100 
	`•Şl_ùl
(
¡©e
->
•fd
,
EPOLL_CTL_MOD
,
fd
,&
“
);

104 
	`•Şl_ùl
(
¡©e
->
•fd
,
EPOLL_CTL_DEL
,
fd
,&
“
);

106 
	}
}

108 
	$«ApiPŞl
(
«Ev’tLoİ
 *
ev’tLoİ
, 
timev®
 *
tvp
) {

109 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

110 
»tv®
, 
numev’ts
 = 0;

112 
»tv®
 = 
	`•Şl_wa™
(
¡©e
->
•fd
,¡©e->
ev’ts
,
ev’tLoİ
->
£tsize
,

113 
tvp
 ? (tvp->
tv_£c
*1000 +vp->
tv_u£c
/1000) : -1);

114 ià(
»tv®
 > 0) {

115 
j
;

117 
numev’ts
 = 
»tv®
;

118 
j
 = 0; j < 
numev’ts
; j++) {

119 
mask
 = 0;

120 
•Şl_ev’t
 *
e
 = 
¡©e
->
ev’ts
+
j
;

122 ià(
e
->
ev’ts
 & 
EPOLLIN
è
mask
 |ğ
AE_READABLE
;

123 ià(
e
->
ev’ts
 & 
EPOLLOUT
è
mask
 |ğ
AE_WRITABLE
;

124 ià(
e
->
ev’ts
 & 
EPOLLERR
è
mask
 |ğ
AE_WRITABLE
;

125 ià(
e
->
ev’ts
 & 
EPOLLHUP
è
mask
 |ğ
AE_WRITABLE
;

126 
ev’tLoİ
->
fœed
[
j
].
fd
 = 
e
->
d©a
.fd;

127 
ev’tLoİ
->
fœed
[
j
].
mask
 = mask;

130  
numev’ts
;

131 
	}
}

133 *
	$«ApiName
() {

135 
	}
}

	@ae_evport.c

31 
	~<as£¹.h
>

32 
	~<”ºo.h
>

33 
	~<pÜt.h
>

34 
	~<pŞl.h
>

36 
	~<sys/ty³s.h
>

37 
	~<sys/time.h
>

39 
	~<¡dio.h
>

41 
	gevpÜt_debug
 = 0;

66 
	#MAX_EVENT_BATCHSZ
 512

	)

68 
	s«ApiS‹
 {

69 
	mpÜtfd
;

70 
	mÅ’dšg
;

71 
	m³ndšg_fds
[
MAX_EVENT_BATCHSZ
];

72 
	m³ndšg_masks
[
MAX_EVENT_BATCHSZ
];

73 } 
	t«ApiS‹
;

75 
	$«ApiC»©e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

76 
i
;

77 
«ApiS‹
 *
¡©e
 = 
	`zm®loc
((aeApiState));

78 ià(!
¡©e
)  -1;

80 
¡©e
->
pÜtfd
 = 
	`pÜt_ü—‹
();

81 ià(
¡©e
->
pÜtfd
 == -1) {

82 
	`zä“
(
¡©e
);

86 
¡©e
->
Å’dšg
 = 0;

88 
i
 = 0; i < 
MAX_EVENT_BATCHSZ
; i++) {

89 
¡©e
->
³ndšg_fds
[
i
] = -1;

90 
¡©e
->
³ndšg_masks
[
i
] = 
AE_NONE
;

93 
ev’tLoİ
->
­id©a
 = 
¡©e
;

95 
	}
}

97 
	$«ApiResize
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

100 
	}
}

102 
	$«ApiF»e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

103 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

105 
	`şo£
(
¡©e
->
pÜtfd
);

106 
	`zä“
(
¡©e
);

107 
	}
}

109 
	$«ApiLookupP’dšg
(
«ApiS‹
 *
¡©e
, 
fd
) {

110 
i
;

112 
i
 = 0; i < 
¡©e
->
Å’dšg
; i++) {

113 ià(
¡©e
->
³ndšg_fds
[
i
] =ğ
fd
)

114  (
i
);

118 
	}
}

123 
	$«ApiAssocŸ‹
(cÚ¡ *
wh”e
, 
pÜtfd
, 
fd
, 
mask
) {

124 
ev’ts
 = 0;

125 
rv
, 
”r
;

127 ià(
mask
 & 
AE_READABLE
)

128 
ev’ts
 |ğ
POLLIN
;

129 ià(
mask
 & 
AE_WRITABLE
)

130 
ev’ts
 |ğ
POLLOUT
;

132 ià(
evpÜt_debug
)

133 
	`årštf
(
¡d”r
, "%s:…Üt_assocŸ‹(%d, 0x%xèğ", 
wh”e
, 
fd
, 
ev’ts
);

135 
rv
 = 
	`pÜt_assocŸ‹
(
pÜtfd
, 
PORT_SOURCE_FD
, 
fd
, 
ev’ts
,

136 (*)(
ušŒ_t
)
mask
);

137 
”r
 = 
”ºo
;

139 ià(
evpÜt_debug
)

140 
	`årštf
(
¡d”r
, "%d (%s)\n", 
rv
,„v =ğ0 ? "nØ”rÜ" : 
	`¡»¼Ü
(
”r
));

142 ià(
rv
 == -1) {

143 
	`årštf
(
¡d”r
, "%s:…Üt_assocŸ‹: %s\n", 
wh”e
, 
	`¡»¼Ü
(
”r
));

145 ià(
”r
 =ğ
EAGAIN
)

146 
	`årštf
(
¡d”r
, "aeApiAssociate:ƒvent…ort†imitƒxceeded.");

149  
rv
;

150 
	}
}

152 
	$«ApiAddEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

153 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

154 
fuÎmask
, 
pfd
;

156 ià(
evpÜt_debug
)

157 
	`årštf
(
¡d”r
, "«ApiAddEv’t: fd %d mask 0x%x\n", 
fd
, 
mask
);

164 
fuÎmask
 = 
mask
 | 
ev’tLoİ
->
ev’ts
[
fd
].mask;

165 
pfd
 = 
	`«ApiLookupP’dšg
(
¡©e
, 
fd
);

167 ià(
pfd
 != -1) {

174 ià(
evpÜt_debug
)

175 
	`årštf
(
¡d”r
, "«ApiAddEv’t:‡ddšgØ³ndšg fd %d\n", 
fd
);

176 
¡©e
->
³ndšg_masks
[
pfd
] |ğ
fuÎmask
;

180  (
	`«ApiAssocŸ‹
("«ApiAddEv’t", 
¡©e
->
pÜtfd
, 
fd
, 
fuÎmask
));

181 
	}
}

183 
	$«ApiD–Ev’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

184 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

185 
fuÎmask
, 
pfd
;

187 ià(
evpÜt_debug
)

188 
	`årštf
(
¡d”r
, "d– fd %d mask 0x%x\n", 
fd
, 
mask
);

190 
pfd
 = 
	`«ApiLookupP’dšg
(
¡©e
, 
fd
);

192 ià(
pfd
 != -1) {

193 ià(
evpÜt_debug
)

194 
	`årštf
(
¡d”r
, "d–‘šgƒv’ˆäom…’dšg fd %d\n", 
fd
);

201 
¡©e
->
³ndšg_masks
[
pfd
] &ğ~
mask
;

203 ià(
¡©e
->
³ndšg_masks
[
pfd
] =ğ
AE_NONE
)

204 
¡©e
->
³ndšg_fds
[
pfd
] = -1;

217 
fuÎmask
 = 
ev’tLoİ
->
ev’ts
[
fd
].
mask
;

218 ià(
fuÎmask
 =ğ
AE_NONE
) {

223 ià(
evpÜt_debug
)

224 
	`årštf
(
¡d”r
, "«ApiD–Ev’t:…Üt_dissocŸ‹(%d)\n", 
fd
);

226 ià(
	`pÜt_dissocŸ‹
(
¡©e
->
pÜtfd
, 
PORT_SOURCE_FD
, 
fd
) != 0) {

227 
	`³¼Ü
("aeApiDelEvent:…ort_dissociate");

228 
	`abÜt
();

230 } ià(
	`«ApiAssocŸ‹
("«ApiD–Ev’t", 
¡©e
->
pÜtfd
, 
fd
,

231 
fuÎmask
) != 0) {

239 
	`abÜt
();

241 
	}
}

243 
	$«ApiPŞl
(
«Ev’tLoİ
 *
ev’tLoİ
, 
timev®
 *
tvp
) {

244 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

245 
time¥ec
 
timeout
, *
t¥
;

246 
mask
, 
i
;

247 
ušt_t
 
Ãv’ts
;

248 
pÜt_ev’t_t
 
ev’t
[
MAX_EVENT_BATCHSZ
];

255 
i
 = 0; i < 
¡©e
->
Å’dšg
; i++) {

256 ià(
¡©e
->
³ndšg_fds
[
i
] == -1)

260 ià(
	`«ApiAssocŸ‹
("«ApiPŞl", 
¡©e
->
pÜtfd
,

261 
¡©e
->
³ndšg_fds
[
i
], s‹->
³ndšg_masks
[i]) != 0) {

263 
	`abÜt
();

266 
¡©e
->
³ndšg_masks
[
i
] = 
AE_NONE
;

267 
¡©e
->
³ndšg_fds
[
i
] = -1;

270 
¡©e
->
Å’dšg
 = 0;

272 ià(
tvp
 !ğ
NULL
) {

273 
timeout
.
tv_£c
 = 
tvp
->tv_sec;

274 
timeout
.
tv_n£c
 = 
tvp
->
tv_u£c
 * 1000;

275 
t¥
 = &
timeout
;

277 
t¥
 = 
NULL
;

284 
Ãv’ts
 = 1;

285 ià(
	`pÜt_g‘n
(
¡©e
->
pÜtfd
, 
ev’t
, 
MAX_EVENT_BATCHSZ
, &
Ãv’ts
,

286 
t¥
è=ğ-1 && (
”ºo
 !ğ
ETIME
 || 
Ãv’ts
 == 0)) {

287 ià(
”ºo
 =ğ
ETIME
 ||ƒ¼nØ=ğ
EINTR
)

291 
	`³¼Ü
("aeApiPoll:…ort_get");

292 
	`abÜt
();

295 
¡©e
->
Å’dšg
 = 
Ãv’ts
;

297 
i
 = 0; i < 
Ãv’ts
; i++) {

298 
mask
 = 0;

299 ià(
ev’t
[
i
].
pÜ‹v_ev’ts
 & 
POLLIN
)

300 
mask
 |ğ
AE_READABLE
;

301 ià(
ev’t
[
i
].
pÜ‹v_ev’ts
 & 
POLLOUT
)

302 
mask
 |ğ
AE_WRITABLE
;

304 
ev’tLoİ
->
fœed
[
i
].
fd
 = 
ev’t
[i].
pÜ‹v_objeù
;

305 
ev’tLoİ
->
fœed
[
i
].
mask
 = mask;

307 ià(
evpÜt_debug
)

308 
	`årštf
(
¡d”r
, "aeApiPoll: fd %d mask 0x%x\n",

309 ()
ev’t
[
i
].
pÜ‹v_objeù
, 
mask
);

311 
¡©e
->
³ndšg_fds
[
i
] = 
ev’t
[i].
pÜ‹v_objeù
;

312 
¡©e
->
³ndšg_masks
[
i
] = (
ušŒ_t
)
ev’t
[i].
pÜ‹v_u£r
;

315  
Ãv’ts
;

316 
	}
}

318 *
	$«ApiName
() {

320 
	}
}

	@ae_kqueue.c

32 
	~<sys/ty³s.h
>

33 
	~<sys/ev’t.h
>

34 
	~<sys/time.h
>

36 
	s«ApiS‹
 {

37 
	mkqfd
;

38 
kev’t
 *
	mev’ts
;

39 } 
	t«ApiS‹
;

41 
	$«ApiC»©e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

42 
«ApiS‹
 *
¡©e
 = 
	`zm®loc
((aeApiState));

44 ià(!
¡©e
)  -1;

45 
¡©e
->
ev’ts
 = 
	`zm®loc
((
kev’t
)*
ev’tLoİ
->
£tsize
);

46 ià(!
¡©e
->
ev’ts
) {

47 
	`zä“
(
¡©e
);

50 
¡©e
->
kqfd
 = 
	`kqueue
();

51 ià(
¡©e
->
kqfd
 == -1) {

52 
	`zä“
(
¡©e
->
ev’ts
);

53 
	`zä“
(
¡©e
);

56 
ev’tLoİ
->
­id©a
 = 
¡©e
;

58 
	}
}

60 
	$«ApiResize
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

61 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

63 
¡©e
->
ev’ts
 = 
	`z»®loc
(¡©e->ev’ts, (
kev’t
)*
£tsize
);

65 
	}
}

67 
	$«ApiF»e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

68 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

70 
	`şo£
(
¡©e
->
kqfd
);

71 
	`zä“
(
¡©e
->
ev’ts
);

72 
	`zä“
(
¡©e
);

73 
	}
}

75 
	$«ApiAddEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

76 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

77 
kev’t
 
ke
;

79 ià(
mask
 & 
AE_READABLE
) {

80 
	`EV_SET
(&
ke
, 
fd
, 
EVFILT_READ
, 
EV_ADD
, 0, 0, 
NULL
);

81 ià(
	`kev’t
(
¡©e
->
kqfd
, &
ke
, 1, 
NULL
, 0, NULL) == -1)  -1;

83 ià(
mask
 & 
AE_WRITABLE
) {

84 
	`EV_SET
(&
ke
, 
fd
, 
EVFILT_WRITE
, 
EV_ADD
, 0, 0, 
NULL
);

85 ià(
	`kev’t
(
¡©e
->
kqfd
, &
ke
, 1, 
NULL
, 0, NULL) == -1)  -1;

88 
	}
}

90 
	$«ApiD–Ev’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

91 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

92 
kev’t
 
ke
;

94 ià(
mask
 & 
AE_READABLE
) {

95 
	`EV_SET
(&
ke
, 
fd
, 
EVFILT_READ
, 
EV_DELETE
, 0, 0, 
NULL
);

96 
	`kev’t
(
¡©e
->
kqfd
, &
ke
, 1, 
NULL
, 0, NULL);

98 ià(
mask
 & 
AE_WRITABLE
) {

99 
	`EV_SET
(&
ke
, 
fd
, 
EVFILT_WRITE
, 
EV_DELETE
, 0, 0, 
NULL
);

100 
	`kev’t
(
¡©e
->
kqfd
, &
ke
, 1, 
NULL
, 0, NULL);

102 
	}
}

104 
	$«ApiPŞl
(
«Ev’tLoİ
 *
ev’tLoİ
, 
timev®
 *
tvp
) {

105 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

106 
»tv®
, 
numev’ts
 = 0;

108 ià(
tvp
 !ğ
NULL
) {

109 
time¥ec
 
timeout
;

110 
timeout
.
tv_£c
 = 
tvp
->tv_sec;

111 
timeout
.
tv_n£c
 = 
tvp
->
tv_u£c
 * 1000;

112 
»tv®
 = 
	`kev’t
(
¡©e
->
kqfd
, 
NULL
, 0, s‹->
ev’ts
, 
ev’tLoİ
->
£tsize
,

113 &
timeout
);

115 
»tv®
 = 
	`kev’t
(
¡©e
->
kqfd
, 
NULL
, 0, s‹->
ev’ts
, 
ev’tLoİ
->
£tsize
,

116 
NULL
);

119 ià(
»tv®
 > 0) {

120 
j
;

122 
numev’ts
 = 
»tv®
;

123 
j
 = 0; j < 
numev’ts
; j++) {

124 
mask
 = 0;

125 
kev’t
 *
e
 = 
¡©e
->
ev’ts
+
j
;

127 ià(
e
->
f‹r
 =ğ
EVFILT_READ
è
mask
 |ğ
AE_READABLE
;

128 ià(
e
->
f‹r
 =ğ
EVFILT_WRITE
è
mask
 |ğ
AE_WRITABLE
;

129 
ev’tLoİ
->
fœed
[
j
].
fd
 = 
e
->
id’t
;

130 
ev’tLoİ
->
fœed
[
j
].
mask
 = mask;

133  
numev’ts
;

134 
	}
}

136 *
	$«ApiName
() {

138 
	}
}

	@ae_select.c

32 
	~<sys/£Ëù.h
>

33 
	~<¡ršg.h
>

35 
	s«ApiS‹
 {

36 
fd_£t
 
	mrfds
, 
	mwfds
;

39 
fd_£t
 
	m_rfds
, 
	m_wfds
;

40 } 
	t«ApiS‹
;

42 
	$«ApiC»©e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

43 
«ApiS‹
 *
¡©e
 = 
	`zm®loc
((aeApiState));

45 ià(!
¡©e
)  -1;

46 
	`FD_ZERO
(&
¡©e
->
rfds
);

47 
	`FD_ZERO
(&
¡©e
->
wfds
);

48 
ev’tLoİ
->
­id©a
 = 
¡©e
;

50 
	}
}

52 
	$«ApiResize
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

54 ià(
£tsize
 >ğ
FD_SETSIZE
)  -1;

56 
	}
}

58 
	$«ApiF»e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

59 
	`zä“
(
ev’tLoİ
->
­id©a
);

60 
	}
}

62 
	$«ApiAddEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

63 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

65 ià(
mask
 & 
AE_READABLE
è
	`FD_SET
(
fd
,&
¡©e
->
rfds
);

66 ià(
mask
 & 
AE_WRITABLE
è
	`FD_SET
(
fd
,&
¡©e
->
wfds
);

68 
	}
}

70 
	$«ApiD–Ev’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

71 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

73 ià(
mask
 & 
AE_READABLE
è
	`FD_CLR
(
fd
,&
¡©e
->
rfds
);

74 ià(
mask
 & 
AE_WRITABLE
è
	`FD_CLR
(
fd
,&
¡©e
->
wfds
);

75 
	}
}

77 
	$«ApiPŞl
(
«Ev’tLoİ
 *
ev’tLoİ
, 
timev®
 *
tvp
) {

78 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

79 
»tv®
, 
j
, 
numev’ts
 = 0;

81 
	`memıy
(&
¡©e
->
_rfds
,&¡©e->
rfds
,(
fd_£t
));

82 
	`memıy
(&
¡©e
->
_wfds
,&¡©e->
wfds
,(
fd_£t
));

84 
»tv®
 = 
	`£Ëù
(
ev’tLoİ
->
maxfd
+1,

85 &
¡©e
->
_rfds
,&¡©e->
_wfds
,
NULL
,
tvp
);

86 ià(
»tv®
 > 0) {

87 
j
 = 0; j <ğ
ev’tLoİ
->
maxfd
; j++) {

88 
mask
 = 0;

89 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[
j
];

91 ià(
ã
->
mask
 =ğ
AE_NONE
) ;

92 ià(
ã
->
mask
 & 
AE_READABLE
 && 
	`FD_ISSET
(
j
,&
¡©e
->
_rfds
))

93 
mask
 |ğ
AE_READABLE
;

94 ià(
ã
->
mask
 & 
AE_WRITABLE
 && 
	`FD_ISSET
(
j
,&
¡©e
->
_wfds
))

95 
mask
 |ğ
AE_WRITABLE
;

96 
ev’tLoİ
->
fœed
[
numev’ts
].
fd
 = 
j
;

97 
ev’tLoİ
->
fœed
[
numev’ts
].
mask
 = mask;

98 
numev’ts
++;

101  
numev’ts
;

102 
	}
}

104 *
	$«ApiName
() {

106 
	}
}

	@anet.c

31 
	~"fmaüos.h
"

33 
	~<sys/ty³s.h
>

34 
	~<sys/sock‘.h
>

35 
	~<sys/¡©.h
>

36 
	~<sys/un.h
>

37 
	~<sys/time.h
>

38 
	~<Ãtš‘/š.h
>

39 
	~<Ãtš‘/tı.h
>

40 
	~<¬·/š‘.h
>

41 
	~<uni¡d.h
>

42 
	~<fú.h
>

43 
	~<¡ršg.h
>

44 
	~<Ãtdb.h
>

45 
	~<”ºo.h
>

46 
	~<¡d¬g.h
>

47 
	~<¡dio.h
>

49 
	~"ª‘.h
"

51 
	$ª‘S‘E¼Ü
(*
”r
, cÚ¡ *
fmt
, ...)

53 
va_li¡
 
­
;

55 ià(!
”r
) ;

56 
	`va_¡¬t
(
­
, 
fmt
);

57 
	`v¢´štf
(
”r
, 
ANET_ERR_LEN
, 
fmt
, 
­
);

58 
	`va_’d
(
­
);

59 
	}
}

61 
	$ª‘S‘Block
(*
”r
, 
fd
, 
nÚ_block
) {

62 
æags
;

67 ià((
æags
 = 
	`fú
(
fd
, 
F_GETFL
)) == -1) {

68 
	`ª‘S‘E¼Ü
(
”r
, "fú(F_GETFL): %s", 
	`¡»¼Ü
(
”ºo
));

69  
ANET_ERR
;

72 ià(
nÚ_block
)

73 
æags
 |ğ
O_NONBLOCK
;

75 
æags
 &ğ~
O_NONBLOCK
;

77 ià(
	`fú
(
fd
, 
F_SETFL
, 
æags
) == -1) {

78 
	`ª‘S‘E¼Ü
(
”r
, "fú(F_SETFL,O_NONBLOCK): %s", 
	`¡»¼Ü
(
”ºo
));

79  
ANET_ERR
;

81  
ANET_OK
;

82 
	}
}

84 
	$ª‘NÚBlock
(*
”r
, 
fd
) {

85  
	`ª‘S‘Block
(
”r
,
fd
,1);

86 
	}
}

88 
	$ª‘Block
(*
”r
, 
fd
) {

89  
	`ª‘S‘Block
(
”r
,
fd
,0);

90 
	}
}

95 
	$ª‘K“pAlive
(*
”r
, 
fd
, 
š‹rv®
)

97 
v®
 = 1;

99 ià(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_KEEPALIVE
, &
v®
, (val)) == -1)

101 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆSO_KEEPALIVE: %s", 
	`¡»¼Ü
(
”ºo
));

102  
ANET_ERR
;

105 #ifdeà
__lšux__


111 
v®
 = 
š‹rv®
;

112 ià(
	`£tsockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_KEEPIDLE
, &
v®
, (val)) < 0) {

113 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆTCP_KEEPIDLE: %s\n", 
	`¡»¼Ü
(
”ºo
));

114  
ANET_ERR
;

120 
v®
 = 
š‹rv®
/3;

121 ià(
v®
 == 0) val = 1;

122 ià(
	`£tsockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_KEEPINTVL
, &
v®
, (val)) < 0) {

123 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆTCP_KEEPINTVL: %s\n", 
	`¡»¼Ü
(
”ºo
));

124  
ANET_ERR
;

129 
v®
 = 3;

130 ià(
	`£tsockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_KEEPCNT
, &
v®
, (val)) < 0) {

131 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆTCP_KEEPCNT: %s\n", 
	`¡»¼Ü
(
”ºo
));

132  
ANET_ERR
;

135 ((è
š‹rv®
);

138  
ANET_OK
;

139 
	}
}

141 
	$ª‘S‘TıNoD–ay
(*
”r
, 
fd
, 
v®
)

143 ià(
	`£tsockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_NODELAY
, &
v®
, (val)) == -1)

145 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆTCP_NODELAY: %s", 
	`¡»¼Ü
(
”ºo
));

146  
ANET_ERR
;

148  
ANET_OK
;

149 
	}
}

151 
	$ª‘EÇbËTıNoD–ay
(*
”r
, 
fd
)

153  
	`ª‘S‘TıNoD–ay
(
”r
, 
fd
, 1);

154 
	}
}

156 
	$ª‘Di§bËTıNoD–ay
(*
”r
, 
fd
)

158  
	`ª‘S‘TıNoD–ay
(
”r
, 
fd
, 0);

159 
	}
}

162 
	$ª‘S‘S’dBufãr
(*
”r
, 
fd
, 
buffsize
)

164 ià(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_SNDBUF
, &
buffsize
, (buffsize)) == -1)

166 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆSO_SNDBUF: %s", 
	`¡»¼Ü
(
”ºo
));

167  
ANET_ERR
;

169  
ANET_OK
;

170 
	}
}

172 
	$ª‘TıK“pAlive
(*
”r
, 
fd
)

174 
yes
 = 1;

175 ià(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_KEEPALIVE
, &
yes
, (yes)) == -1) {

176 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆSO_KEEPALIVE: %s", 
	`¡»¼Ü
(
”ºo
));

177  
ANET_ERR
;

179  
ANET_OK
;

180 
	}
}

184 
	$ª‘S’dTimeout
(*
”r
, 
fd
, 
ms
) {

185 
timev®
 
tv
;

187 
tv
.
tv_£c
 = 
ms
/1000;

188 
tv
.
tv_u£c
 = (
ms
%1000)*1000;

189 ià(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_SNDTIMEO
, &
tv
, (tv)) == -1) {

190 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆSO_SNDTIMEO: %s", 
	`¡»¼Ü
(
”ºo
));

191  
ANET_ERR
;

193  
ANET_OK
;

194 
	}
}

203 
	$ª‘G’”icResŞve
(*
”r
, *
ho¡
, *
buf
, 
size_t
 
buf_Ën
,

204 
æags
)

206 
addršfo
 
hšts
, *
šfo
;

207 
rv
;

209 
	`mem£t
(&
hšts
,0,(hints));

210 ià(
æags
 & 
ANET_IP_ONLY
è
hšts
.
ai_æags
 = 
AI_NUMERICHOST
;

211 
hšts
.
ai_çmy
 = 
AF_UNSPEC
;

212 
hšts
.
ai_sockty³
 = 
SOCK_STREAM
;

214 ià((
rv
 = 
	`g‘addršfo
(
ho¡
, 
NULL
, &
hšts
, &
šfo
)) != 0) {

215 
	`ª‘S‘E¼Ü
(
”r
, "%s", 
	`gai_¡»¼Ü
(
rv
));

216  
ANET_ERR
;

218 ià(
šfo
->
ai_çmy
 =ğ
AF_INET
) {

219 
sockaddr_š
 *
§
 = (sockaddr_š *)
šfo
->
ai_addr
;

220 
	`š‘_Áİ
(
AF_INET
, &(
§
->
sš_addr
), 
buf
, 
buf_Ën
);

222 
sockaddr_š6
 *
§
 = (sockaddr_š6 *)
šfo
->
ai_addr
;

223 
	`š‘_Áİ
(
AF_INET6
, &(
§
->
sš6_addr
), 
buf
, 
buf_Ën
);

226 
	`ä“addršfo
(
šfo
);

227  
ANET_OK
;

228 
	}
}

230 
	$ª‘ResŞve
(*
”r
, *
ho¡
, *
buf
, 
size_t
 
buf_Ën
) {

231  
	`ª‘G’”icResŞve
(
”r
,
ho¡
,
buf
,
buf_Ën
,
ANET_NONE
);

232 
	}
}

234 
	$ª‘ResŞveIP
(*
”r
, *
ho¡
, *
buf
, 
size_t
 
buf_Ën
) {

235  
	`ª‘G’”icResŞve
(
”r
,
ho¡
,
buf
,
buf_Ën
,
ANET_IP_ONLY
);

236 
	}
}

238 
	$ª‘S‘Reu£Addr
(*
”r
, 
fd
) {

239 
yes
 = 1;

242 ià(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
yes
, (yes)) == -1) {

243 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆSO_REUSEADDR: %s", 
	`¡»¼Ü
(
”ºo
));

244  
ANET_ERR
;

246  
ANET_OK
;

247 
	}
}

249 
	$ª‘C»©eSock‘
(*
”r
, 
domaš
) {

250 
s
;

251 ià((
s
 = 
	`sock‘
(
domaš
, 
SOCK_STREAM
, 0)) == -1) {

252 
	`ª‘S‘E¼Ü
(
”r
, "ü—tšg sock‘: %s", 
	`¡»¼Ü
(
”ºo
));

253  
ANET_ERR
;

258 ià(
	`ª‘S‘Reu£Addr
(
”r
,
s
è=ğ
ANET_ERR
) {

259 
	`şo£
(
s
);

260  
ANET_ERR
;

262  
s
;

263 
	}
}

265 
	#ANET_CONNECT_NONE
 0

	)

266 
	#ANET_CONNECT_NONBLOCK
 1

	)

267 
	#ANET_CONNECT_BE_BINDING
 2

	)

268 
	$ª‘TıG’”icCÚÃù
(*
”r
, *
addr
, 
pÜt
,

269 *
sourû_addr
, 
æags
)

271 
s
 = 
ANET_ERR
, 
rv
;

272 
pÜt¡r
[6];

273 
addršfo
 
hšts
, *
£rvšfo
, *
b£rvšfo
, *
p
, *
b
;

275 
	`¢´štf
(
pÜt¡r
,ÕÜt¡r),"%d",
pÜt
);

276 
	`mem£t
(&
hšts
,0,(hints));

277 
hšts
.
ai_çmy
 = 
AF_UNSPEC
;

278 
hšts
.
ai_sockty³
 = 
SOCK_STREAM
;

280 ià((
rv
 = 
	`g‘addršfo
(
addr
,
pÜt¡r
,&
hšts
,&
£rvšfo
)) != 0) {

281 
	`ª‘S‘E¼Ü
(
”r
, "%s", 
	`gai_¡»¼Ü
(
rv
));

282  
ANET_ERR
;

284 
p
 = 
£rvšfo
;… !ğ
NULL
;… =…->
ai_Ãxt
) {

288 ià((
s
 = 
	`sock‘
(
p
->
ai_çmy
,p->
ai_sockty³
,p->
ai_´ÙocŞ
)) == -1)

290 ià(
	`ª‘S‘Reu£Addr
(
”r
,
s
è=ğ
ANET_ERR
è
”rÜ
;

291 ià(
æags
 & 
ANET_CONNECT_NONBLOCK
 && 
	`ª‘NÚBlock
(
”r
,
s
è!ğ
ANET_OK
)

292 
”rÜ
;

293 ià(
sourû_addr
) {

294 
bound
 = 0;

296 ià((
rv
 = 
	`g‘addršfo
(
sourû_addr
, 
NULL
, &
hšts
, &
b£rvšfo
)) != 0)

298 
	`ª‘S‘E¼Ü
(
”r
, "%s", 
	`gai_¡»¼Ü
(
rv
));

299 
”rÜ
;

301 
b
 = 
b£rvšfo
; b !ğ
NULL
; b = b->
ai_Ãxt
) {

302 ià(
	`bšd
(
s
,
b
->
ai_addr
,b->
ai_add¾’
) != -1) {

303 
bound
 = 1;

307 
	`ä“addršfo
(
b£rvšfo
);

308 ià(!
bound
) {

309 
	`ª‘S‘E¼Ü
(
”r
, "bšd: %s", 
	`¡»¼Ü
(
”ºo
));

310 
”rÜ
;

313 ià(
	`cÚÃù
(
s
,
p
->
ai_addr
,p->
ai_add¾’
) == -1) {

316 ià(
”ºo
 =ğ
EINPROGRESS
 && 
æags
 & 
ANET_CONNECT_NONBLOCK
)

317 
’d
;

318 
	`şo£
(
s
);

319 
s
 = 
ANET_ERR
;

325 
’d
;

327 ià(
p
 =ğ
NULL
)

328 
	`ª‘S‘E¼Ü
(
”r
, "ü—tšg sock‘: %s", 
	`¡»¼Ü
(
”ºo
));

330 
”rÜ
:

331 ià(
s
 !ğ
ANET_ERR
) {

332 
	`şo£
(
s
);

333 
s
 = 
ANET_ERR
;

336 
’d
:

337 
	`ä“addršfo
(
£rvšfo
);

341 ià(
s
 =ğ
ANET_ERR
 && 
sourû_addr
 && (
æags
 & 
ANET_CONNECT_BE_BINDING
)) {

342  
	`ª‘TıG’”icCÚÃù
(
”r
,
addr
,
pÜt
,
NULL
,
æags
);

344  
s
;

346 
	}
}

348 
	$ª‘TıCÚÃù
(*
”r
, *
addr
, 
pÜt
)

350  
	`ª‘TıG’”icCÚÃù
(
”r
,
addr
,
pÜt
,
NULL
,
ANET_CONNECT_NONE
);

351 
	}
}

353 
	$ª‘TıNÚBlockCÚÃù
(*
”r
, *
addr
, 
pÜt
)

355  
	`ª‘TıG’”icCÚÃù
(
”r
,
addr
,
pÜt
,
NULL
,
ANET_CONNECT_NONBLOCK
);

356 
	}
}

358 
	$ª‘TıNÚBlockBšdCÚÃù
(*
”r
, *
addr
, 
pÜt
,

359 *
sourû_addr
)

361  
	`ª‘TıG’”icCÚÃù
(
”r
,
addr
,
pÜt
,
sourû_addr
,

362 
ANET_CONNECT_NONBLOCK
);

363 
	}
}

365 
	$ª‘TıNÚBlockBe¡EffÜtBšdCÚÃù
(*
”r
, *
addr
, 
pÜt
,

366 *
sourû_addr
)

368  
	`ª‘TıG’”icCÚÃù
(
”r
,
addr
,
pÜt
,
sourû_addr
,

369 
ANET_CONNECT_NONBLOCK
|
ANET_CONNECT_BE_BINDING
);

370 
	}
}

372 
	$ª‘UnixG’”icCÚÃù
(*
”r
, *
·th
, 
æags
)

374 
s
;

375 
sockaddr_un
 
§
;

377 ià((
s
 = 
	`ª‘C»©eSock‘
(
”r
,
AF_LOCAL
)è=ğ
ANET_ERR
)

378  
ANET_ERR
;

380 
§
.
sun_çmy
 = 
AF_LOCAL
;

381 
	`¡ºıy
(
§
.
sun_·th
,
·th
,(sa.sun_path)-1);

382 ià(
æags
 & 
ANET_CONNECT_NONBLOCK
) {

383 ià(
	`ª‘NÚBlock
(
”r
,
s
è!ğ
ANET_OK
) {

384 
	`şo£
(
s
);

385  
ANET_ERR
;

388 ià(
	`cÚÃù
(
s
,(
sockaddr
*)&
§
,(sa)) == -1) {

389 ià(
”ºo
 =ğ
EINPROGRESS
 &&

390 
æags
 & 
ANET_CONNECT_NONBLOCK
)

391  
s
;

393 
	`ª‘S‘E¼Ü
(
”r
, "cÚÃù: %s", 
	`¡»¼Ü
(
”ºo
));

394 
	`şo£
(
s
);

395  
ANET_ERR
;

397  
s
;

398 
	}
}

400 
	$ª‘UnixCÚÃù
(*
”r
, *
·th
)

402  
	`ª‘UnixG’”icCÚÃù
(
”r
,
·th
,
ANET_CONNECT_NONE
);

403 
	}
}

405 
	$ª‘UnixNÚBlockCÚÃù
(*
”r
, *
·th
)

407  
	`ª‘UnixG’”icCÚÃù
(
”r
,
·th
,
ANET_CONNECT_NONBLOCK
);

408 
	}
}

412 
	$ª‘R—d
(
fd
, *
buf
, 
couÁ
)

414 
ssize_t
 
Ä—d
, 
tÙËn
 = 0;

415 
tÙËn
 !ğ
couÁ
) {

416 
Ä—d
 = 
	`»ad
(
fd
,
buf
,
couÁ
-
tÙËn
);

417 ià(
Ä—d
 =ğ0è 
tÙËn
;

418 ià(
Ä—d
 == -1)  -1;

419 
tÙËn
 +ğ
Ä—d
;

420 
buf
 +ğ
Ä—d
;

422  
tÙËn
;

423 
	}
}

427 
	$ª‘Wr™e
(
fd
, *
buf
, 
couÁ
)

429 
ssize_t
 
nwr™‹n
, 
tÙËn
 = 0;

430 
tÙËn
 !ğ
couÁ
) {

431 
nwr™‹n
 = 
	`wr™e
(
fd
,
buf
,
couÁ
-
tÙËn
);

432 ià(
nwr™‹n
 =ğ0è 
tÙËn
;

433 ià(
nwr™‹n
 == -1)  -1;

434 
tÙËn
 +ğ
nwr™‹n
;

435 
buf
 +ğ
nwr™‹n
;

437  
tÙËn
;

438 
	}
}

440 
	$ª‘Li¡’
(*
”r
, 
s
, 
sockaddr
 *
§
, 
sockËn_t
 
Ën
, 
backlog
) {

441 ià(
	`bšd
(
s
,
§
,
Ën
) == -1) {

442 
	`ª‘S‘E¼Ü
(
”r
, "bšd: %s", 
	`¡»¼Ü
(
”ºo
));

443 
	`şo£
(
s
);

444  
ANET_ERR
;

447 ià(
	`li¡’
(
s
, 
backlog
) == -1) {

448 
	`ª‘S‘E¼Ü
(
”r
, "li¡’: %s", 
	`¡»¼Ü
(
”ºo
));

449 
	`şo£
(
s
);

450  
ANET_ERR
;

452  
ANET_OK
;

453 
	}
}

455 
	$ª‘V6OÆy
(*
”r
, 
s
) {

456 
yes
 = 1;

457 ià(
	`£tsockİt
(
s
,
IPPROTO_IPV6
,
IPV6_V6ONLY
,&
yes
,(yes)) == -1) {

458 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİt: %s", 
	`¡»¼Ü
(
”ºo
));

459 
	`şo£
(
s
);

460  
ANET_ERR
;

462  
ANET_OK
;

463 
	}
}

465 
	$_ª‘TıS”v”
(*
”r
, 
pÜt
, *
bšdaddr
, 
af
, 
backlog
)

467 
s
 = -1, 
rv
;

468 
_pÜt
[6];

469 
addršfo
 
hšts
, *
£rvšfo
, *
p
;

471 
	`¢´štf
(
_pÜt
,6,"%d",
pÜt
);

472 
	`mem£t
(&
hšts
,0,(hints));

473 
hšts
.
ai_çmy
 = 
af
;

474 
hšts
.
ai_sockty³
 = 
SOCK_STREAM
;

475 
hšts
.
ai_æags
 = 
AI_PASSIVE
;

477 ià((
rv
 = 
	`g‘addršfo
(
bšdaddr
,
_pÜt
,&
hšts
,&
£rvšfo
)) != 0) {

478 
	`ª‘S‘E¼Ü
(
”r
, "%s", 
	`gai_¡»¼Ü
(
rv
));

479  
ANET_ERR
;

481 
p
 = 
£rvšfo
;… !ğ
NULL
;… =…->
ai_Ãxt
) {

482 ià((
s
 = 
	`sock‘
(
p
->
ai_çmy
,p->
ai_sockty³
,p->
ai_´ÙocŞ
)) == -1)

485 ià(
af
 =ğ
AF_INET6
 && 
	`ª‘V6OÆy
(
”r
,
s
è=ğ
ANET_ERR
è
”rÜ
;

486 ià(
	`ª‘S‘Reu£Addr
(
”r
,
s
è=ğ
ANET_ERR
è
”rÜ
;

487 ià(
	`ª‘Li¡’
(
”r
,
s
,
p
->
ai_addr
,p->
ai_add¾’
,
backlog
è=ğ
ANET_ERR
è
”rÜ
;

488 
’d
;

490 ià(
p
 =ğ
NULL
) {

491 
	`ª‘S‘E¼Ü
(
”r
, "uÇbËØbšd sock‘,ƒ¼no: %d", 
”ºo
);

492 
”rÜ
;

495 
”rÜ
:

496 ià(
s
 !ğ-1è
	`şo£
(s);

497 
s
 = 
ANET_ERR
;

498 
’d
:

499 
	`ä“addršfo
(
£rvšfo
);

500  
s
;

501 
	}
}

503 
	$ª‘TıS”v”
(*
”r
, 
pÜt
, *
bšdaddr
, 
backlog
)

505  
	`_ª‘TıS”v”
(
”r
, 
pÜt
, 
bšdaddr
, 
AF_INET
, 
backlog
);

506 
	}
}

508 
	$ª‘Tı6S”v”
(*
”r
, 
pÜt
, *
bšdaddr
, 
backlog
)

510  
	`_ª‘TıS”v”
(
”r
, 
pÜt
, 
bšdaddr
, 
AF_INET6
, 
backlog
);

511 
	}
}

513 
	$ª‘UnixS”v”
(*
”r
, *
·th
, 
mode_t
 
³rm
, 
backlog
)

515 
s
;

516 
sockaddr_un
 
§
;

518 ià((
s
 = 
	`ª‘C»©eSock‘
(
”r
,
AF_LOCAL
)è=ğ
ANET_ERR
)

519  
ANET_ERR
;

521 
	`mem£t
(&
§
,0,(sa));

522 
§
.
sun_çmy
 = 
AF_LOCAL
;

523 
	`¡ºıy
(
§
.
sun_·th
,
·th
,(sa.sun_path)-1);

524 ià(
	`ª‘Li¡’
(
”r
,
s
,(
sockaddr
*)&
§
,(§),
backlog
è=ğ
ANET_ERR
)

525  
ANET_ERR
;

526 ià(
³rm
)

527 
	`chmod
(
§
.
sun_·th
, 
³rm
);

528  
s
;

529 
	}
}

531 
	$ª‘G’”icAcû±
(*
”r
, 
s
, 
sockaddr
 *
§
, 
sockËn_t
 *
Ën
) {

532 
fd
;

534 
fd
 = 
	`acû±
(
s
,
§
,
Ën
);

535 ià(
fd
 == -1) {

536 ià(
”ºo
 =ğ
EINTR
)

539 
	`ª‘S‘E¼Ü
(
”r
, "acû±: %s", 
	`¡»¼Ü
(
”ºo
));

540  
ANET_ERR
;

545  
fd
;

546 
	}
}

548 
	$ª‘TıAcû±
(*
”r
, 
s
, *

, 
size_t
 
_Ën
, *
pÜt
) {

549 
fd
;

550 
sockaddr_¡Üage
 
§
;

551 
sockËn_t
 
§Ën
 = (
§
);

552 ià((
fd
 = 
	`ª‘G’”icAcû±
(
”r
,
s
,(
sockaddr
*)&
§
,&
§Ën
)) == -1)

553  
ANET_ERR
;

555 ià(
§
.
ss_çmy
 =ğ
AF_INET
) {

556 
sockaddr_š
 *
s
 = (sockaddr_š *)&
§
;

557 ià(

è
	`š‘_Áİ
(
AF_INET
,(*)&(
s
->
sš_addr
),,
_Ën
);

558 ià(
pÜt
è*pÜˆğ
	`Áohs
(
s
->
sš_pÜt
);

560 
sockaddr_š6
 *
s
 = (sockaddr_š6 *)&
§
;

561 ià(

è
	`š‘_Áİ
(
AF_INET6
,(*)&(
s
->
sš6_addr
),,
_Ën
);

562 ià(
pÜt
è*pÜˆğ
	`Áohs
(
s
->
sš6_pÜt
);

564  
fd
;

565 
	}
}

567 
	$ª‘UnixAcû±
(*
”r
, 
s
) {

568 
fd
;

569 
sockaddr_un
 
§
;

570 
sockËn_t
 
§Ën
 = (
§
);

571 ià((
fd
 = 
	`ª‘G’”icAcû±
(
”r
,
s
,(
sockaddr
*)&
§
,&
§Ën
)) == -1)

572  
ANET_ERR
;

574  
fd
;

575 
	}
}

577 
	$ª‘P“rToSŒšg
(
fd
, *

, 
size_t
 
_Ën
, *
pÜt
) {

578 
sockaddr_¡Üage
 
§
;

579 
sockËn_t
 
§Ën
 = (
§
);

581 ià(
	`g‘³”Çme
(
fd
,(
sockaddr
*)&
§
,&
§Ën
è=ğ-1è
”rÜ
;

582 ià(
_Ën
 =ğ0è
”rÜ
;

584 ià(
§
.
ss_çmy
 =ğ
AF_INET
) {

585 
sockaddr_š
 *
s
 = (sockaddr_š *)&
§
;

586 ià(

è
	`š‘_Áİ
(
AF_INET
,(*)&(
s
->
sš_addr
),,
_Ën
);

587 ià(
pÜt
è*pÜˆğ
	`Áohs
(
s
->
sš_pÜt
);

588 } ià(
§
.
ss_çmy
 =ğ
AF_INET6
) {

589 
sockaddr_š6
 *
s
 = (sockaddr_š6 *)&
§
;

590 ià(

è
	`š‘_Áİ
(
AF_INET6
,(*)&(
s
->
sš6_addr
),,
_Ën
);

591 ià(
pÜt
è*pÜˆğ
	`Áohs
(
s
->
sš6_pÜt
);

592 } ià(
§
.
ss_çmy
 =ğ
AF_UNIX
) {

593 ià(

è
	`¡ºıy
(,"/unixsock‘",
_Ën
);

594 ià(
pÜt
) *port = 0;

596 
”rÜ
;

600 
”rÜ
:

601 ià(

) {

602 ià(
_Ën
 >= 2) {

603 

[0] = '?';

604 

[1] = '\0';

605 } ià(
_Ën
 == 1) {

606 

[0] = '\0';

609 ià(
pÜt
) *port = 0;

611 
	}
}

616 
	$ª‘FÜm©Addr
(*
buf
, 
size_t
 
buf_Ën
, *

, 
pÜt
) {

617  
	`¢´štf
(
buf
,
buf_Ën
, 
	`¡rchr
(

,':') ?

618 "[%s]:%d" : "%s:%d", 

, 
pÜt
);

619 
	}
}

622 
	$ª‘FÜm©P“r
(
fd
, *
buf
, 
size_t
 
buf_Ën
) {

623 

[
INET6_ADDRSTRLEN
];

624 
pÜt
;

626 
	`ª‘P“rToSŒšg
(
fd
,

,(),&
pÜt
);

627  
	`ª‘FÜm©Addr
(
buf
, 
buf_Ën
, 

, 
pÜt
);

628 
	}
}

630 
	$ª‘SockName
(
fd
, *

, 
size_t
 
_Ën
, *
pÜt
) {

631 
sockaddr_¡Üage
 
§
;

632 
sockËn_t
 
§Ën
 = (
§
);

634 ià(
	`g‘sockÇme
(
fd
,(
sockaddr
*)&
§
,&
§Ën
) == -1) {

635 ià(
pÜt
) *port = 0;

636 

[0] = '?';

637 

[1] = '\0';

640 ià(
§
.
ss_çmy
 =ğ
AF_INET
) {

641 
sockaddr_š
 *
s
 = (sockaddr_š *)&
§
;

642 ià(

è
	`š‘_Áİ
(
AF_INET
,(*)&(
s
->
sš_addr
),,
_Ën
);

643 ià(
pÜt
è*pÜˆğ
	`Áohs
(
s
->
sš_pÜt
);

645 
sockaddr_š6
 *
s
 = (sockaddr_š6 *)&
§
;

646 ià(

è
	`š‘_Áİ
(
AF_INET6
,(*)&(
s
->
sš6_addr
),,
_Ën
);

647 ià(
pÜt
è*pÜˆğ
	`Áohs
(
s
->
sš6_pÜt
);

650 
	}
}

652 
	$ª‘FÜm©Sock
(
fd
, *
fmt
, 
size_t
 
fmt_Ën
) {

653 

[
INET6_ADDRSTRLEN
];

654 
pÜt
;

656 
	`ª‘SockName
(
fd
,

,(),&
pÜt
);

657  
	`ª‘FÜm©Addr
(
fmt
, 
fmt_Ën
, 

, 
pÜt
);

658 
	}
}

	@anet.h

31 #iâdeà
ANET_H


32 
	#ANET_H


	)

34 
	~<sys/ty³s.h
>

36 
	#ANET_OK
 0

	)

37 
	#ANET_ERR
 -1

	)

38 
	#ANET_ERR_LEN
 256

	)

41 
	#ANET_NONE
 0

	)

42 
	#ANET_IP_ONLY
 (1<<0)

	)

44 #ià
defšed
(
__sun
è|| defšed(
_AIX
)

45 
	#AF_LOCAL
 
AF_UNIX


	)

48 #ifdeà
_AIX


49 #undeà
_Ën


52 
ª‘TıCÚÃù
(*
”r
, *
addr
, 
pÜt
);

53 
ª‘TıNÚBlockCÚÃù
(*
”r
, *
addr
, 
pÜt
);

54 
ª‘TıNÚBlockBšdCÚÃù
(*
”r
, *
addr
, 
pÜt
, *
sourû_addr
);

55 
ª‘TıNÚBlockBe¡EffÜtBšdCÚÃù
(*
”r
, *
addr
, 
pÜt
, *
sourû_addr
);

56 
ª‘UnixCÚÃù
(*
”r
, *
·th
);

57 
ª‘UnixNÚBlockCÚÃù
(*
”r
, *
·th
);

58 
ª‘R—d
(
fd
, *
buf
, 
couÁ
);

59 
ª‘ResŞve
(*
”r
, *
ho¡
, *
buf
, 
size_t
 
buf_Ën
);

60 
ª‘ResŞveIP
(*
”r
, *
ho¡
, *
buf
, 
size_t
 
buf_Ën
);

61 
ª‘TıS”v”
(*
”r
, 
pÜt
, *
bšdaddr
, 
backlog
);

62 
ª‘Tı6S”v”
(*
”r
, 
pÜt
, *
bšdaddr
, 
backlog
);

63 
ª‘UnixS”v”
(*
”r
, *
·th
, 
mode_t
 
³rm
, 
backlog
);

64 
ª‘TıAcû±
(*
”r
, 
£rv”sock
, *

, 
size_t
 
_Ën
, *
pÜt
);

65 
ª‘UnixAcû±
(*
”r
, 
£rv”sock
);

66 
ª‘Wr™e
(
fd
, *
buf
, 
couÁ
);

67 
ª‘NÚBlock
(*
”r
, 
fd
);

68 
ª‘Block
(*
”r
, 
fd
);

69 
ª‘EÇbËTıNoD–ay
(*
”r
, 
fd
);

70 
ª‘Di§bËTıNoD–ay
(*
”r
, 
fd
);

71 
ª‘TıK“pAlive
(*
”r
, 
fd
);

72 
ª‘S’dTimeout
(*
”r
, 
fd
, 
ms
);

73 
ª‘P“rToSŒšg
(
fd
, *

, 
size_t
 
_Ën
, *
pÜt
);

74 
ª‘K“pAlive
(*
”r
, 
fd
, 
š‹rv®
);

75 
ª‘SockName
(
fd
, *

, 
size_t
 
_Ën
, *
pÜt
);

76 
ª‘FÜm©Addr
(*
fmt
, 
size_t
 
fmt_Ën
, *

, 
pÜt
);

77 
ª‘FÜm©P“r
(
fd
, *
fmt
, 
size_t
 
fmt_Ën
);

78 
ª‘FÜm©Sock
(
fd
, *
fmt
, 
size_t
 
fmt_Ën
);

	@aof.c

30 
	~"£rv”.h
"

31 
	~"bio.h
"

32 
	~"rio.h
"

34 
	~<sigÇl.h
>

35 
	~<fú.h
>

36 
	~<sys/¡©.h
>

37 
	~<sys/ty³s.h
>

38 
	~<sys/time.h
>

39 
	~<sys/»sourû.h
>

40 
	~<sys/wa™.h
>

41 
	~<sys/·¿m.h
>

43 
aofUpd©eCu¼’tSize
();

44 
aofClo£Pes
();

60 
	#AOF_RW_BUF_BLOCK_SIZE
 (1024*1024*10è

	)

62 
	saoäwblock
 {

63 
	mu£d
, 
	mä“
;

64 
	mbuf
[
AOF_RW_BUF_BLOCK_SIZE
];

65 } 
	taoäwblock
;

70 
	$aofRewr™eBufãrRe£t
() {

71 ià(
£rv”
.
aof_»wr™e_buf_blocks
)

72 
	`li¡R–—£
(
£rv”
.
aof_»wr™e_buf_blocks
);

74 
£rv”
.
aof_»wr™e_buf_blocks
 = 
	`li¡C»©e
();

75 
	`li¡S‘F»eM‘hod
(
£rv”
.
aof_»wr™e_buf_blocks
,
zä“
);

76 
	}
}

79 
	$aofRewr™eBufãrSize
() {

80 
li¡Node
 *
Ê
;

81 
li¡I‹r
 
li
;

82 
size
 = 0;

84 
	`li¡Rewšd
(
£rv”
.
aof_»wr™e_buf_blocks
,&
li
);

85 (
Ê
 = 
	`li¡Next
(&
li
))) {

86 
aoäwblock
 *
block
 = 
	`li¡NodeV®ue
(
Ê
);

87 
size
 +ğ
block
->
u£d
;

89  
size
;

90 
	}
}

95 
	$aofChdWr™eDiffD©a
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

96 
li¡Node
 *
Ê
;

97 
aoäwblock
 *
block
;

98 
ssize_t
 
nwr™‹n
;

99 
	`UNUSED
(
–
);

100 
	`UNUSED
(
fd
);

101 
	`UNUSED
(
´ivd©a
);

102 
	`UNUSED
(
mask
);

105 
Ê
 = 
	`li¡Fœ¡
(
£rv”
.
aof_»wr™e_buf_blocks
);

106 
block
 = 
Ê
 ?†n->
v®ue
 : 
NULL
;

107 ià(
£rv”
.
aof_¡İ_£ndšg_diff
 || !
block
) {

108 
	`«D–‘eFeEv’t
(
£rv”
.
–
,£rv”.
aof_pe_wr™e_d©a_to_chd
,

109 
AE_WRITABLE
);

112 ià(
block
->
u£d
 > 0) {

113 
nwr™‹n
 = 
	`wr™e
(
£rv”
.
aof_pe_wr™e_d©a_to_chd
,

114 
block
->
buf
,block->
u£d
);

115 ià(
nwr™‹n
 <= 0) ;

116 
	`memmove
(
block
->
buf
,block->buf+
nwr™‹n
,block->
u£d
-nwritten);

117 
block
->
u£d
 -ğ
nwr™‹n
;

118 
block
->
ä“
 +ğ
nwr™‹n
;

120 ià(
block
->
u£d
 =ğ0è
	`li¡D–Node
(
£rv”
.
aof_»wr™e_buf_blocks
,
Ê
);

122 
	}
}

125 
	$aofRewr™eBufãrAµ’d
(*
s
, 
Ën
) {

126 
li¡Node
 *
Ê
 = 
	`li¡La¡
(
£rv”
.
aof_»wr™e_buf_blocks
);

127 
aoäwblock
 *
block
 = 
Ê
 ?†n->
v®ue
 : 
NULL
;

129 
Ën
) {

132 ià(
block
) {

133 
thi¦’
 = (
block
->
ä“
 < 
Ën
) ? block->free :†en;

134 ià(
thi¦’
) {

135 
	`memıy
(
block
->
buf
+block->
u£d
, 
s
, 
thi¦’
);

136 
block
->
u£d
 +ğ
thi¦’
;

137 
block
->
ä“
 -ğ
thi¦’
;

138 
s
 +ğ
thi¦’
;

139 
Ën
 -ğ
thi¦’
;

143 ià(
Ën
) {

144 
numblocks
;

146 
block
 = 
	`zm®loc
((*block));

147 
block
->
ä“
 = 
AOF_RW_BUF_BLOCK_SIZE
;

148 
block
->
u£d
 = 0;

149 
	`li¡AddNodeTa
(
£rv”
.
aof_»wr™e_buf_blocks
,
block
);

153 
numblocks
 = 
	`li¡L’gth
(
£rv”
.
aof_»wr™e_buf_blocks
);

154 ià(((
numblocks
+1) % 10) == 0) {

155 
Ëv–
 = ((
numblocks
+1è% 100è=ğ0 ? 
LL_WARNING
 :

156 
LL_NOTICE
;

157 
	`£rv”Log
(
Ëv–
,"Background AOF buffer size: %lu MB",

158 
	`aofRewr™eBufãrSize
()/(1024*1024));

165 ià(
	`«G‘FeEv’ts
(
£rv”
.
–
,£rv”.
aof_pe_wr™e_d©a_to_chd
) == 0) {

166 
	`«C»©eFeEv’t
(
£rv”
.
–
, s”v”.
aof_pe_wr™e_d©a_to_chd
,

167 
AE_WRITABLE
, 
aofChdWr™eDiffD©a
, 
NULL
);

169 
	}
}

174 
ssize_t
 
	$aofRewr™eBufãrWr™e
(
fd
) {

175 
li¡Node
 *
Ê
;

176 
li¡I‹r
 
li
;

177 
ssize_t
 
couÁ
 = 0;

179 
	`li¡Rewšd
(
£rv”
.
aof_»wr™e_buf_blocks
,&
li
);

180 (
Ê
 = 
	`li¡Next
(&
li
))) {

181 
aoäwblock
 *
block
 = 
	`li¡NodeV®ue
(
Ê
);

182 
ssize_t
 
nwr™‹n
;

184 ià(
block
->
u£d
) {

185 
nwr™‹n
 = 
	`wr™e
(
fd
,
block
->
buf
,block->
u£d
);

186 ià(
nwr™‹n
 !ğ(
ssize_t
)
block
->
u£d
) {

187 ià(
nwr™‹n
 =ğ0è
”ºo
 = 
EIO
;

190 
couÁ
 +ğ
nwr™‹n
;

193  
couÁ
;

194 
	}
}

202 
	$aof_background_fsync
(
fd
) {

203 
	`bioC»©eBackgroundJob
(
BIO_AOF_FSYNC
,(*)()
fd
,
NULL
,NULL);

204 
	}
}

208 
	$¡İAµ’dOÆy
() {

209 
	`£rv”As£¹
(
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
);

210 
	`æushAµ’dOÆyFe
(1);

211 
	`aof_fsync
(
£rv”
.
aof_fd
);

212 
	`şo£
(
£rv”
.
aof_fd
);

214 
£rv”
.
aof_fd
 = -1;

215 
£rv”
.
aof_£Ëùed_db
 = -1;

216 
£rv”
.
aof_¡©e
 = 
AOF_OFF
;

218 ià(
£rv”
.
aof_chd_pid
 != -1) {

219 
¡©loc
;

221 
	`£rv”Log
(
LL_NOTICE
,"Killing„unning AOF„ewrite child: %ld",

222 (è
£rv”
.
aof_chd_pid
);

223 ià(
	`kl
(
£rv”
.
aof_chd_pid
,
SIGUSR1
) != -1) {

224 
	`wa™3
(&
¡©loc
,0,
NULL
è!ğ
£rv”
.
aof_chd_pid
);

227 
	`aofRewr™eBufãrRe£t
();

228 
	`aofRemoveTempFe
(
£rv”
.
aof_chd_pid
);

229 
£rv”
.
aof_chd_pid
 = -1;

230 
£rv”
.
aof_»wr™e_time_¡¬t
 = -1;

232 
	`aofClo£Pes
();

234 
	}
}

238 
	$¡¬tAµ’dOÆy
() {

239 
cwd
[
MAXPATHLEN
];

241 
£rv”
.
aof_Ï¡_fsync
 = s”v”.
unixtime
;

242 
£rv”
.
aof_fd
 = 
	`İ’
(£rv”.
aof_f’ame
,
O_WRONLY
|
O_APPEND
|
O_CREAT
,0644);

243 
	`£rv”As£¹
(
£rv”
.
aof_¡©e
 =ğ
AOF_OFF
);

244 ià(
£rv”
.
aof_fd
 == -1) {

245 *
cwdp
 = 
	`g‘cwd
(
cwd
,
MAXPATHLEN
);

247 
	`£rv”Log
(
LL_WARNING
,

250 
£rv”
.
aof_f’ame
,

251 
cwdp
 ? cwdp : "unknown",

252 
	`¡»¼Ü
(
”ºo
));

253  
C_ERR
;

255 ià(
£rv”
.
rdb_chd_pid
 != -1) {

256 
£rv”
.
aof_»wr™e_scheduËd
 = 1;

257 
	`£rv”Log
(
LL_WARNING
,"AOF wasƒnabled buthere is‡lready‡ child…rocess saving‡n RDB file on disk. An AOF background was scheduledo start when…ossible.");

258 } ià(
	`»wr™eAµ’dOÆyFeBackground
(è=ğ
C_ERR
) {

259 
	`şo£
(
£rv”
.
aof_fd
);

260 
	`£rv”Log
(
LL_WARNING
,"Redis‚eedsoƒnablehe AOF but can'trigger‡ background AOF„ewrite operation. Checkhe‡bove†ogs for more info‡boutheƒrror.");

261  
C_ERR
;

265 
£rv”
.
aof_¡©e
 = 
AOF_WAIT_REWRITE
;

266  
C_OK
;

267 
	}
}

287 
	#AOF_WRITE_LOG_ERROR_RATE
 30

	)

288 
	$æushAµ’dOÆyFe
(
fÜû
) {

289 
ssize_t
 
nwr™‹n
;

290 
sync_š_´og»ss
 = 0;

291 
m¡ime_t
 
Ï‹ncy
;

293 ià(
	`sd¦’
(
£rv”
.
aof_buf
) == 0) ;

295 ià(
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_EVERYSEC
)

296 
sync_š_´og»ss
 = 
	`bioP’dšgJobsOfTy³
(
BIO_AOF_FSYNC
) != 0;

298 ià(
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_EVERYSEC
 && !
fÜû
) {

302 ià(
sync_š_´og»ss
) {

303 ià(
£rv”
.
aof_æush_po¡pÚed_¡¬t
 == 0) {

306 
£rv”
.
aof_æush_po¡pÚed_¡¬t
 = s”v”.
unixtime
;

308 } ià(
£rv”
.
unixtime
 - s”v”.
aof_æush_po¡pÚed_¡¬t
 < 2) {

315 
£rv”
.
aof_d–ayed_fsync
++;

316 
	`£rv”Log
(
LL_NOTICE
,"Asynchronous AOF fsync isakingoo†ong (disk is busy?). Writinghe AOF buffer without waiting for fsynco complete,his may slow down Redis.");

325 
	`Ï‹ncyS¹MÚ™Ü
(
Ï‹ncy
);

326 
nwr™‹n
 = 
	`wr™e
(
£rv”
.
aof_fd
,£rv”.
aof_buf
,
	`sd¦’
(server.aof_buf));

327 
	`Ï‹ncyEndMÚ™Ü
(
Ï‹ncy
);

333 ià(
sync_š_´og»ss
) {

334 
	`Ï‹ncyAddSam¶eIfN“ded
("aof-wr™e-³ndšg-fsync",
Ï‹ncy
);

335 } ià(
£rv”
.
aof_chd_pid
 !ğ-1 || s”v”.
rdb_chd_pid
 != -1) {

336 
	`Ï‹ncyAddSam¶eIfN“ded
("aof-wr™e-aùive-chd",
Ï‹ncy
);

338 
	`Ï‹ncyAddSam¶eIfN“ded
("aof-wr™e-®Úe",
Ï‹ncy
);

340 
	`Ï‹ncyAddSam¶eIfN“ded
("aof-wr™e",
Ï‹ncy
);

343 
£rv”
.
aof_æush_po¡pÚed_¡¬t
 = 0;

345 ià(
nwr™‹n
 !ğ(sigÃd)
	`sd¦’
(
£rv”
.
aof_buf
)) {

346 
time_t
 
Ï¡_wr™e_”rÜ_log
 = 0;

347 
ÿn_log
 = 0;

350 ià((
£rv”
.
unixtime
 - 
Ï¡_wr™e_”rÜ_log
è> 
AOF_WRITE_LOG_ERROR_RATE
) {

351 
ÿn_log
 = 1;

352 
Ï¡_wr™e_”rÜ_log
 = 
£rv”
.
unixtime
;

356 ià(
nwr™‹n
 == -1) {

357 ià(
ÿn_log
) {

358 
	`£rv”Log
(
LL_WARNING
,"Error writingohe AOF file: %s",

359 
	`¡»¼Ü
(
”ºo
));

360 
£rv”
.
aof_Ï¡_wr™e_”ºo
 = 
”ºo
;

363 ià(
ÿn_log
) {

364 
	`£rv”Log
(
LL_WARNING
,"Short write while writingo "

367 ()
nwr™‹n
,

368 ()
	`sd¦’
(
£rv”
.
aof_buf
));

371 ià(
	`árunÿ‹
(
£rv”
.
aof_fd
, s”v”.
aof_cu¼’t_size
) == -1) {

372 ià(
ÿn_log
) {

373 
	`£rv”Log
(
LL_WARNING
, "Could‚ot„emove short write "

376 "árunÿ‹: %s", 
	`¡»¼Ü
(
”ºo
));

381 
nwr™‹n
 = -1;

383 
£rv”
.
aof_Ï¡_wr™e_”ºo
 = 
ENOSPC
;

387 ià(
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_ALWAYS
) {

392 
	`£rv”Log
(
LL_WARNING
,"Can't„ecover from AOF writeƒrror whenhe AOF fsync…olicy is 'always'. Exiting...");

393 
	`ex™
(1);

398 
£rv”
.
aof_Ï¡_wr™e_¡©us
 = 
C_ERR
;

402 ià(
nwr™‹n
 > 0) {

403 
£rv”
.
aof_cu¼’t_size
 +ğ
nwr™‹n
;

404 
	`sd¤ªge
(
£rv”
.
aof_buf
,
nwr™‹n
,-1);

411 ià(
£rv”
.
aof_Ï¡_wr™e_¡©us
 =ğ
C_ERR
) {

412 
	`£rv”Log
(
LL_WARNING
,

414 
£rv”
.
aof_Ï¡_wr™e_¡©us
 = 
C_OK
;

417 
£rv”
.
aof_cu¼’t_size
 +ğ
nwr™‹n
;

421 ià((
	`sd¦’
(
£rv”
.
aof_buf
)+
	`sd§va
(server.aof_buf)) < 4000) {

422 
	`sdsş—r
(
£rv”
.
aof_buf
);

424 
	`sdsä“
(
£rv”
.
aof_buf
);

425 
£rv”
.
aof_buf
 = 
	`sd£m±y
();

430 ià(
£rv”
.
aof_no_fsync_Ú_»wr™e
 &&

431 (
£rv”
.
aof_chd_pid
 !ğ-1 || s”v”.
rdb_chd_pid
 != -1))

435 ià(
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_ALWAYS
) {

438 
	`Ï‹ncyS¹MÚ™Ü
(
Ï‹ncy
);

439 
	`aof_fsync
(
£rv”
.
aof_fd
);

440 
	`Ï‹ncyEndMÚ™Ü
(
Ï‹ncy
);

441 
	`Ï‹ncyAddSam¶eIfN“ded
("aof-fsync-®ways",
Ï‹ncy
);

442 
£rv”
.
aof_Ï¡_fsync
 = s”v”.
unixtime
;

443 } ià((
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_EVERYSEC
 &&

444 
£rv”
.
unixtime
 > s”v”.
aof_Ï¡_fsync
)) {

445 ià(!
sync_š_´og»ss
è
	`aof_background_fsync
(
£rv”
.
aof_fd
);

446 
£rv”
.
aof_Ï¡_fsync
 = s”v”.
unixtime
;

448 
	}
}

450 
sds
 
	$ÿtAµ’dOÆyG’”icCommªd
(
sds
 
d¡
, 
¬gc
, 
robj
 **
¬gv
) {

451 
buf
[32];

452 
Ën
, 
j
;

453 
robj
 *
o
;

455 
buf
[0] = '*';

456 
Ën
 = 1+
	`Î2¡ršg
(
buf
+1,(buf)-1,
¬gc
);

457 
buf
[
Ën
++] = '\r';

458 
buf
[
Ën
++] = '\n';

459 
d¡
 = 
	`sdsÿ’
(d¡,
buf
,
Ën
);

461 
j
 = 0; j < 
¬gc
; j++) {

462 
o
 = 
	`g‘DecodedObjeù
(
¬gv
[
j
]);

463 
buf
[0] = '$';

464 
Ën
 = 1+
	`Î2¡ršg
(
buf
+1,(buf)-1,
	`sd¦’
(
o
->
±r
));

465 
buf
[
Ën
++] = '\r';

466 
buf
[
Ën
++] = '\n';

467 
d¡
 = 
	`sdsÿ’
(d¡,
buf
,
Ën
);

468 
d¡
 = 
	`sdsÿ’
(d¡,
o
->
±r
,
	`sd¦’
(o->ptr));

469 
d¡
 = 
	`sdsÿ’
(dst,"\r\n",2);

470 
	`deüRefCouÁ
(
o
);

472  
d¡
;

473 
	}
}

482 
sds
 
	$ÿtAµ’dOÆyExpœeAtCommªd
(
sds
 
buf
, 
»disCommªd
 *
cmd
, 
robj
 *
key
,„obj *
£cÚds
) {

483 
wh’
;

484 
robj
 *
¬gv
[3];

487 
£cÚds
 = 
	`g‘DecodedObjeù
(seconds);

488 
wh’
 = 
	`¡¹Şl
(
£cÚds
->
±r
,
NULL
,10);

490 ià(
cmd
->
´oc
 =ğ
expœeCommªd
 || cmd->´oø=ğ
£‹xCommªd
 ||

491 
cmd
->
´oc
 =ğ
expœ—tCommªd
)

493 
wh’
 *= 1000;

496 ià(
cmd
->
´oc
 =ğ
expœeCommªd
 || cmd->´oø=ğ
³xpœeCommªd
 ||

497 
cmd
->
´oc
 =ğ
£‹xCommªd
 || cmd->´oø=ğ
p£‹xCommªd
)

499 
wh’
 +ğ
	`m¡ime
();

501 
	`deüRefCouÁ
(
£cÚds
);

503 
¬gv
[0] = 
	`ü—‹SŒšgObjeù
("PEXPIREAT",9);

504 
¬gv
[1] = 
key
;

505 
¬gv
[2] = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
wh’
);

506 
buf
 = 
	`ÿtAµ’dOÆyG’”icCommªd
(buf, 3, 
¬gv
);

507 
	`deüRefCouÁ
(
¬gv
[0]);

508 
	`deüRefCouÁ
(
¬gv
[2]);

509  
buf
;

510 
	}
}

512 
	$ãedAµ’dOÆyFe
(
»disCommªd
 *
cmd
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
) {

513 
sds
 
buf
 = 
	`sd£m±y
();

514 
robj
 *
tm·rgv
[3];

518 ià(
diùid
 !ğ
£rv”
.
aof_£Ëùed_db
) {

519 
£ldb
[64];

521 
	`¢´štf
(
£ldb
,(£ldb),"%d",
diùid
);

522 
buf
 = 
	`sdsÿrštf
(buf,"*2\r\n$6\r\nSELECT\r\n$%lu\r\n%s\r\n",

523 ()
	`¡¾’
(
£ldb
),seldb);

524 
£rv”
.
aof_£Ëùed_db
 = 
diùid
;

527 ià(
cmd
->
´oc
 =ğ
expœeCommªd
 || cmd->´oø=ğ
³xpœeCommªd
 ||

528 
cmd
->
´oc
 =ğ
expœ—tCommªd
) {

530 
buf
 = 
	`ÿtAµ’dOÆyExpœeAtCommªd
(buf,
cmd
,
¬gv
[1],argv[2]);

531 } ià(
cmd
->
´oc
 =ğ
£‹xCommªd
 || cmd->´oø=ğ
p£‹xCommªd
) {

533 
tm·rgv
[0] = 
	`ü—‹SŒšgObjeù
("SET",3);

534 
tm·rgv
[1] = 
¬gv
[1];

535 
tm·rgv
[2] = 
¬gv
[3];

536 
buf
 = 
	`ÿtAµ’dOÆyG’”icCommªd
(buf,3,
tm·rgv
);

537 
	`deüRefCouÁ
(
tm·rgv
[0]);

538 
buf
 = 
	`ÿtAµ’dOÆyExpœeAtCommªd
(buf,
cmd
,
¬gv
[1],argv[2]);

539 } ià(
cmd
->
´oc
 =ğ
£tCommªd
 && 
¬gc
 > 3) {

540 
i
;

541 
robj
 *
ex¬g
 = 
NULL
, *
px¬g
 = NULL;

543 
buf
 = 
	`ÿtAµ’dOÆyG’”icCommªd
(buf,3,
¬gv
);

544 
i
 = 3; i < 
¬gc
; i ++) {

545 ià(!
	`¡rÿ£cmp
(
¬gv
[
i
]->
±r
, "ex")è
ex¬g
 =‡rgv[i+1];

546 ià(!
	`¡rÿ£cmp
(
¬gv
[
i
]->
±r
, "px")è
px¬g
 =‡rgv[i+1];

548 
	`£rv”As£¹
(!(
ex¬g
 && 
px¬g
));

549 ià(
ex¬g
)

550 
buf
 = 
	`ÿtAµ’dOÆyExpœeAtCommªd
(buf,
£rv”
.
expœeCommªd
,
¬gv
[1],

551 
ex¬g
);

552 ià(
px¬g
)

553 
buf
 = 
	`ÿtAµ’dOÆyExpœeAtCommªd
(buf,
£rv”
.
³xpœeCommªd
,
¬gv
[1],

554 
px¬g
);

559 
buf
 = 
	`ÿtAµ’dOÆyG’”icCommªd
(buf,
¬gc
,
¬gv
);

565 ià(
£rv”
.
aof_¡©e
 =ğ
AOF_ON
)

566 
£rv”
.
aof_buf
 = 
	`sdsÿ’
(£rv”.aof_buf,
buf
,
	`sd¦’
(buf));

572 ià(
£rv”
.
aof_chd_pid
 != -1)

573 
	`aofRewr™eBufãrAµ’d
((*)
buf
,
	`sd¦’
(buf));

575 
	`sdsä“
(
buf
);

576 
	}
}

584 
ş›Á
 *
	$ü—‹FakeCl›Á
() {

585 
ş›Á
 *
c
 = 
	`zm®loc
((*c));

587 
	`£ËùDb
(
c
,0);

588 
c
->
fd
 = -1;

589 
c
->
Çme
 = 
NULL
;

590 
c
->
qu”ybuf
 = 
	`sd£m±y
();

591 
c
->
qu”ybuf_³ak
 = 0;

592 
c
->
¬gc
 = 0;

593 
c
->
¬gv
 = 
NULL
;

594 
c
->
buåos
 = 0;

595 
c
->
æags
 = 0;

596 
c
->
bty³
 = 
BLOCKED_NONE
;

599 
c
->
»¶¡©e
 = 
SLAVE_STATE_WAIT_BGSAVE_START
;

600 
c
->
»¶y
 = 
	`li¡C»©e
();

601 
c
->
»¶y_by‹s
 = 0;

602 
c
->
obuf_soá_lim™_»ached_time
 = 0;

603 
c
->
w©ched_keys
 = 
	`li¡C»©e
();

604 
c
->
³”id
 = 
NULL
;

605 
	`li¡S‘F»eM‘hod
(
c
->
»¶y
,
deüRefCouÁVoid
);

606 
	`li¡S‘DupM‘hod
(
c
->
»¶y
,
dupCl›ÁR•lyV®ue
);

607 
	`š™Cl›ÁMuÉiS‹
(
c
);

608  
c
;

609 
	}
}

611 
	$ä“FakeCl›ÁArgv
(
ş›Á
 *
c
) {

612 
j
;

614 
j
 = 0; j < 
c
->
¬gc
; j++)

615 
	`deüRefCouÁ
(
c
->
¬gv
[
j
]);

616 
	`zä“
(
c
->
¬gv
);

617 
	}
}

619 
	$ä“FakeCl›Á
(
ş›Á
 *
c
) {

620 
	`sdsä“
(
c
->
qu”ybuf
);

621 
	`li¡R–—£
(
c
->
»¶y
);

622 
	`li¡R–—£
(
c
->
w©ched_keys
);

623 
	`ä“Cl›ÁMuÉiS‹
(
c
);

624 
	`zä“
(
c
);

625 
	}
}

630 
	$lßdAµ’dOÆyFe
(*
f’ame
) {

631 
ş›Á
 *
çkeCl›Á
;

632 
FILE
 *
å
 = 
	`fİ’
(
f’ame
,"r");

633 
»dis_¡©
 
sb
;

634 
Şd_aof_¡©e
 = 
£rv”
.
aof_¡©e
;

635 
loİs
 = 0;

636 
off_t
 
v®id_up_to
 = 0;

638 ià(
å
 =ğ
NULL
) {

639 
	`£rv”Log
(
LL_WARNING
,"F©®ƒ¼Ü: cª'ˆİ’h­³nd†og ffÜ„—dšg: %s",
	`¡»¼Ü
(
”ºo
));

640 
	`ex™
(1);

647 ià(
å
 && 
	`»dis_f¡©
(
	`f’o
(å),&
sb
è!ğ-1 && sb.
¡_size
 == 0) {

648 
£rv”
.
aof_cu¼’t_size
 = 0;

649 
	`fşo£
(
å
);

650  
C_ERR
;

655 
£rv”
.
aof_¡©e
 = 
AOF_OFF
;

657 
çkeCl›Á
 = 
	`ü—‹FakeCl›Á
();

658 
	`¡¬tLßdšg
(
å
);

662 
sig
[5];

663 ià(
	`ä—d
(
sig
,1,5,
å
è!ğ5 || 
	`memcmp
(sig,"REDIS",5) != 0) {

665 ià(
	`f£ek
(
å
,0,
SEEK_SET
è=ğ-1è
»ad”r
;

668 
rio
 
rdb
;

670 
	`£rv”Log
(
LL_NOTICE
,"Reading RDB…reamble from AOF file...");

671 ià(
	`f£ek
(
å
,0,
SEEK_SET
è=ğ-1è
»ad”r
;

672 
	`rioIn™W™hFe
(&
rdb
,
å
);

673 ià(
	`rdbLßdRio
(&
rdb
,
NULL
è!ğ
C_OK
) {

674 
	`£rv”Log
(
LL_WARNING
,"Error„eadinghe RDB…reamble ofhe AOF file, AOF†oading‡borted");

675 
»ad”r
;

677 
	`£rv”Log
(
LL_NOTICE
,"Readinghe„emaining AOFail...");

683 
¬gc
, 
j
;

684 
Ën
;

685 
robj
 **
¬gv
;

686 
buf
[128];

687 
sds
 
¬gsds
;

688 
»disCommªd
 *
cmd
;

691 ià(!(
loİs
++ % 1000)) {

692 
	`lßdšgProg»ss
(
	`á–lo
(
å
));

693 
	`´oûssEv’tsWheBlocked
();

696 ià(
	`fg‘s
(
buf
,(buf),
å
è=ğ
NULL
) {

697 ià(
	`ãof
(
å
))

700 
»ad”r
;

702 ià(
buf
[0] !ğ'*'è
fm‹¼
;

703 ià(
buf
[1] =ğ'\0'è
»ad”r
;

704 
¬gc
 = 
	`©oi
(
buf
+1);

705 ià(
¬gc
 < 1è
fm‹¼
;

707 
¬gv
 = 
	`zm®loc
((
robj
*)*
¬gc
);

708 
çkeCl›Á
->
¬gc
 =‡rgc;

709 
çkeCl›Á
->
¬gv
 =‡rgv;

711 
j
 = 0; j < 
¬gc
; j++) {

712 ià(
	`fg‘s
(
buf
,(buf),
å
è=ğ
NULL
) {

713 
çkeCl›Á
->
¬gc
 = 
j
;

714 
	`ä“FakeCl›ÁArgv
(
çkeCl›Á
);

715 
»ad”r
;

717 ià(
buf
[0] !ğ'$'è
fm‹¼
;

718 
Ën
 = 
	`¡¹Ş
(
buf
+1,
NULL
,10);

719 
¬gsds
 = 
	`sd¢ewËn
(
NULL
,
Ën
);

720 ià(
Ën
 && 
	`ä—d
(
¬gsds
,Ën,1,
å
) == 0) {

721 
	`sdsä“
(
¬gsds
);

722 
çkeCl›Á
->
¬gc
 = 
j
;

723 
	`ä“FakeCl›ÁArgv
(
çkeCl›Á
);

724 
»ad”r
;

726 
¬gv
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,
¬gsds
);

727 ià(
	`ä—d
(
buf
,2,1,
å
) == 0) {

728 
çkeCl›Á
->
¬gc
 = 
j
+1;

729 
	`ä“FakeCl›ÁArgv
(
çkeCl›Á
);

730 
»ad”r
;

735 
cmd
 = 
	`lookupCommªd
(
¬gv
[0]->
±r
);

736 ià(!
cmd
) {

737 
	`£rv”Log
(
LL_WARNING
,"UnknowÀcommªd '%s'„—dšgh­³nd oÆy fe", (*)
¬gv
[0]->
±r
);

738 
	`ex™
(1);

742 
çkeCl›Á
->
cmd
 = cmd;

743 
cmd
->
	`´oc
(
çkeCl›Á
);

746 
	`£rv”As£¹
(
çkeCl›Á
->
buåos
 =ğ0 && 
	`li¡L’gth
(çkeCl›Á->
»¶y
) == 0);

748 
	`£rv”As£¹
((
çkeCl›Á
->
æags
 & 
CLIENT_BLOCKED
) == 0);

752 
	`ä“FakeCl›ÁArgv
(
çkeCl›Á
);

753 
çkeCl›Á
->
cmd
 = 
NULL
;

754 ià(
£rv”
.
aof_lßd_Œunÿ‹d
è
v®id_up_to
 = 
	`á–lo
(
å
);

759 ià(
çkeCl›Á
->
æags
 & 
CLIENT_MULTI
è
uxeof
;

761 
lßded_ok
:

762 
	`fşo£
(
å
);

763 
	`ä“FakeCl›Á
(
çkeCl›Á
);

764 
£rv”
.
aof_¡©e
 = 
Şd_aof_¡©e
;

765 
	`¡İLßdšg
();

766 
	`aofUpd©eCu¼’tSize
();

767 
£rv”
.
aof_»wr™e_ba£_size
 = s”v”.
aof_cu¼’t_size
;

768  
C_OK
;

770 
»ad”r
:

771 ià(!
	`ãof
(
å
)) {

772 ià(
çkeCl›Á
è
	`ä“FakeCl›Á
(fakeClient);

773 
	`£rv”Log
(
LL_WARNING
,"UÄecov”abËƒ¼Ü„—dšgh­³nd oÆy fe: %s", 
	`¡»¼Ü
(
”ºo
));

774 
	`ex™
(1);

777 
uxeof
:

778 ià(
£rv”
.
aof_lßd_Œunÿ‹d
) {

779 
	`£rv”Log
(
LL_WARNING
,"!!! Warning: short„ead while†oadinghe AOF file !!!");

780 
	`£rv”Log
(
LL_WARNING
,"!!! Truncatinghe AOF‡t offset %llu !!!",

781 (è
v®id_up_to
);

782 ià(
v®id_up_to
 =ğ-1 || 
	`Œunÿ‹
(
f’ame
,valid_up_to) == -1) {

783 ià(
v®id_up_to
 == -1) {

784 
	`£rv”Log
(
LL_WARNING
,"Last valid command offset is invalid");

786 
	`£rv”Log
(
LL_WARNING
,"Errorruncatinghe AOF file: %s",

787 
	`¡»¼Ü
(
”ºo
));

792 ià(
£rv”
.
aof_fd
 !ğ-1 && 
	`l£ek
(£rv”.aof_fd,0,
SEEK_END
) == -1) {

793 
	`£rv”Log
(
LL_WARNING
,"Can't seekheƒnd ofhe AOF file: %s",

794 
	`¡»¼Ü
(
”ºo
));

796 
	`£rv”Log
(
LL_WARNING
,

798 
lßded_ok
;

802 ià(
çkeCl›Á
è
	`ä“FakeCl›Á
(fakeClient);

803 
	`£rv”Log
(
LL_WARNING
,"Unexpectedƒnd of file„eadinghe‡ppend only file. You can: 1) Make‡ backup of your AOF file,hen use ./redis-check-aof --fix <filename>. 2) Alternatively you can sethe 'aof-load-truncated' configuration optiono yes‡nd„estarthe server.");

804 
	`ex™
(1);

806 
fm‹¼
:

807 ià(
çkeCl›Á
è
	`ä“FakeCl›Á
(fakeClient);

808 
	`£rv”Log
(
LL_WARNING
,"Bad file format„eadinghe‡ppend only file: make‡ backup of your AOF file,hen use ./redis-check-aof --fix <filename>");

809 
	`ex™
(1);

810 
	}
}

818 
	$rioWr™eBulkObjeù
(
rio
 *
r
, 
robj
 *
obj
) {

821 ià(
obj
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

822  
	`rioWr™eBulkLÚgLÚg
(
r
,()
obj
->
±r
);

823 } ià(
	`sdsEncodedObjeù
(
obj
)) {

824  
	`rioWr™eBulkSŒšg
(
r
,
obj
->
±r
,
	`sd¦’
(obj->ptr));

826 
	`£rv”Pªic
("Unknown stringƒncoding");

828 
	}
}

832 
	$»wr™eLi¡Objeù
(
rio
 *
r
, 
robj
 *
key
,„obj *
o
) {

833 
couÁ
 = 0, 
™ems
 = 
	`li¡Ty³L’gth
(
o
);

835 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

836 
quickli¡
 *
li¡
 = 
o
->
±r
;

837 
quickli¡I‹r
 *
li
 = 
	`quickli¡G‘I‹¿tÜ
(
li¡
, 
AL_START_HEAD
);

838 
quickli¡EÁry
 
’Œy
;

840 
	`quickli¡Next
(
li
,&
’Œy
)) {

841 ià(
couÁ
 == 0) {

842 
cmd_™ems
 = (
™ems
 > 
AOF_REWRITE_ITEMS_PER_CMD
) ?

843 
AOF_REWRITE_ITEMS_PER_CMD
 : 
™ems
;

844 ià(
	`rioWr™eBulkCouÁ
(
r
,'*',2+
cmd_™ems
) == 0)  0;

845 ià(
	`rioWr™eBulkSŒšg
(
r
,"RPUSH",5) == 0)  0;

846 ià(
	`rioWr™eBulkObjeù
(
r
,
key
) == 0)  0;

849 ià(
’Œy
.
v®ue
) {

850 ià(
	`rioWr™eBulkSŒšg
(
r
,(*)
’Œy
.
v®ue
,’Œy.
sz
) == 0)  0;

852 ià(
	`rioWr™eBulkLÚgLÚg
(
r
,
’Œy
.
lÚgv®
) == 0)  0;

854 ià(++
couÁ
 =ğ
AOF_REWRITE_ITEMS_PER_CMD
) count = 0;

855 
™ems
--;

857 
	`quickli¡R–—£I‹¿tÜ
(
li
);

859 
	`£rv”Pªic
("Unknown†istƒncoding");

862 
	}
}

866 
	$»wr™eS‘Objeù
(
rio
 *
r
, 
robj
 *
key
,„obj *
o
) {

867 
couÁ
 = 0, 
™ems
 = 
	`£tTy³Size
(
o
);

869 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

870 
ii
 = 0;

871 
št64_t
 
Îv®
;

873 
	`št£tG‘
(
o
->
±r
,
ii
++,&
Îv®
)) {

874 ià(
couÁ
 == 0) {

875 
cmd_™ems
 = (
™ems
 > 
AOF_REWRITE_ITEMS_PER_CMD
) ?

876 
AOF_REWRITE_ITEMS_PER_CMD
 : 
™ems
;

878 ià(
	`rioWr™eBulkCouÁ
(
r
,'*',2+
cmd_™ems
) == 0)  0;

879 ià(
	`rioWr™eBulkSŒšg
(
r
,"SADD",4) == 0)  0;

880 ià(
	`rioWr™eBulkObjeù
(
r
,
key
) == 0)  0;

882 ià(
	`rioWr™eBulkLÚgLÚg
(
r
,
Îv®
) == 0)  0;

883 ià(++
couÁ
 =ğ
AOF_REWRITE_ITEMS_PER_CMD
) count = 0;

884 
™ems
--;

886 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

887 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
o
->
±r
);

888 
diùEÁry
 *
de
;

890 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

891 
sds
 
–e
 = 
	`diùG‘Key
(
de
);

892 ià(
couÁ
 == 0) {

893 
cmd_™ems
 = (
™ems
 > 
AOF_REWRITE_ITEMS_PER_CMD
) ?

894 
AOF_REWRITE_ITEMS_PER_CMD
 : 
™ems
;

896 ià(
	`rioWr™eBulkCouÁ
(
r
,'*',2+
cmd_™ems
) == 0)  0;

897 ià(
	`rioWr™eBulkSŒšg
(
r
,"SADD",4) == 0)  0;

898 ià(
	`rioWr™eBulkObjeù
(
r
,
key
) == 0)  0;

900 ià(
	`rioWr™eBulkSŒšg
(
r
,
–e
,
	`sd¦’
(ele)) == 0)  0;

901 ià(++
couÁ
 =ğ
AOF_REWRITE_ITEMS_PER_CMD
) count = 0;

902 
™ems
--;

904 
	`diùR–—£I‹¿tÜ
(
di
);

906 
	`£rv”Pªic
("Unknown setƒncoding");

909 
	}
}

913 
	$»wr™eSÜ‹dS‘Objeù
(
rio
 *
r
, 
robj
 *
key
,„obj *
o
) {

914 
couÁ
 = 0, 
™ems
 = 
	`z£tL’gth
(
o
);

916 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

917 *
zl
 = 
o
->
±r
;

918 *
•Œ
, *
¥Œ
;

919 *
v¡r
;

920 
vËn
;

921 
vÎ
;

922 
scÜe
;

924 
•Œ
 = 
	`zli¡Index
(
zl
,0);

925 
	`£rv”As£¹
(
•Œ
 !ğ
NULL
);

926 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

927 
	`£rv”As£¹
(
¥Œ
 !ğ
NULL
);

929 
•Œ
 !ğ
NULL
) {

930 
	`£rv”As£¹
(
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vÎ
));

931 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

933 ià(
couÁ
 == 0) {

934 
cmd_™ems
 = (
™ems
 > 
AOF_REWRITE_ITEMS_PER_CMD
) ?

935 
AOF_REWRITE_ITEMS_PER_CMD
 : 
™ems
;

937 ià(
	`rioWr™eBulkCouÁ
(
r
,'*',2+
cmd_™ems
*2) == 0)  0;

938 ià(
	`rioWr™eBulkSŒšg
(
r
,"ZADD",4) == 0)  0;

939 ià(
	`rioWr™eBulkObjeù
(
r
,
key
) == 0)  0;

941 ià(
	`rioWr™eBulkDoubË
(
r
,
scÜe
) == 0)  0;

942 ià(
v¡r
 !ğ
NULL
) {

943 ià(
	`rioWr™eBulkSŒšg
(
r
,(*)
v¡r
,
vËn
) == 0)  0;

945 ià(
	`rioWr™eBulkLÚgLÚg
(
r
,
vÎ
) == 0)  0;

947 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

948 ià(++
couÁ
 =ğ
AOF_REWRITE_ITEMS_PER_CMD
) count = 0;

949 
™ems
--;

951 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

952 
z£t
 *
zs
 = 
o
->
±r
;

953 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
zs
->
diù
);

954 
diùEÁry
 *
de
;

956 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

957 
sds
 
–e
 = 
	`diùG‘Key
(
de
);

958 *
scÜe
 = 
	`diùG‘V®
(
de
);

960 ià(
couÁ
 == 0) {

961 
cmd_™ems
 = (
™ems
 > 
AOF_REWRITE_ITEMS_PER_CMD
) ?

962 
AOF_REWRITE_ITEMS_PER_CMD
 : 
™ems
;

964 ià(
	`rioWr™eBulkCouÁ
(
r
,'*',2+
cmd_™ems
*2) == 0)  0;

965 ià(
	`rioWr™eBulkSŒšg
(
r
,"ZADD",4) == 0)  0;

966 ià(
	`rioWr™eBulkObjeù
(
r
,
key
) == 0)  0;

968 ià(
	`rioWr™eBulkDoubË
(
r
,*
scÜe
) == 0)  0;

969 ià(
	`rioWr™eBulkSŒšg
(
r
,
–e
,
	`sd¦’
(ele)) == 0)  0;

970 ià(++
couÁ
 =ğ
AOF_REWRITE_ITEMS_PER_CMD
) count = 0;

971 
™ems
--;

973 
	`diùR–—£I‹¿tÜ
(
di
);

975 
	`£rv”Pªic
("Unknown sorted zsetƒncoding");

978 
	}
}

986 
	$rioWr™eHashI‹¿tÜCursÜ
(
rio
 *
r
, 
hashTy³I‹¿tÜ
 *
hi
, 
wh©
) {

987 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

988 *
v¡r
 = 
NULL
;

989 
vËn
 = 
UINT_MAX
;

990 
vÎ
 = 
LLONG_MAX
;

992 
	`hashTy³Cu¼’tFromZli¡
(
hi
, 
wh©
, &
v¡r
, &
vËn
, &
vÎ
);

993 ià(
v¡r
)

994  
	`rioWr™eBulkSŒšg
(
r
, (*)
v¡r
, 
vËn
);

996  
	`rioWr™eBulkLÚgLÚg
(
r
, 
vÎ
);

997 } ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

998 
sds
 
v®ue
 = 
	`hashTy³Cu¼’tFromHashTabË
(
hi
, 
wh©
);

999  
	`rioWr™eBulkSŒšg
(
r
, 
v®ue
, 
	`sd¦’
(value));

1002 
	`£rv”Pªic
("Unknown hashƒncoding");

1004 
	}
}

1008 
	$»wr™eHashObjeù
(
rio
 *
r
, 
robj
 *
key
,„obj *
o
) {

1009 
hashTy³I‹¿tÜ
 *
hi
;

1010 
couÁ
 = 0, 
™ems
 = 
	`hashTy³L’gth
(
o
);

1012 
hi
 = 
	`hashTy³In™I‹¿tÜ
(
o
);

1013 
	`hashTy³Next
(
hi
è!ğ
C_ERR
) {

1014 ià(
couÁ
 == 0) {

1015 
cmd_™ems
 = (
™ems
 > 
AOF_REWRITE_ITEMS_PER_CMD
) ?

1016 
AOF_REWRITE_ITEMS_PER_CMD
 : 
™ems
;

1018 ià(
	`rioWr™eBulkCouÁ
(
r
,'*',2+
cmd_™ems
*2) == 0)  0;

1019 ià(
	`rioWr™eBulkSŒšg
(
r
,"HMSET",5) == 0)  0;

1020 ià(
	`rioWr™eBulkObjeù
(
r
,
key
) == 0)  0;

1023 ià(
	`rioWr™eHashI‹¿tÜCursÜ
(
r
, 
hi
, 
OBJ_HASH_KEY
) == 0)  0;

1024 ià(
	`rioWr™eHashI‹¿tÜCursÜ
(
r
, 
hi
, 
OBJ_HASH_VALUE
) == 0)  0;

1025 ià(++
couÁ
 =ğ
AOF_REWRITE_ITEMS_PER_CMD
) count = 0;

1026 
™ems
--;

1029 
	`hashTy³R–—£I‹¿tÜ
(
hi
);

1032 
	}
}

1037 
	$»wr™eModuËObjeù
(
rio
 *
r
, 
robj
 *
key
,„obj *
o
) {

1038 
RedisModuËIO
 
io
;

1039 
moduËV®ue
 *
mv
 = 
o
->
±r
;

1040 
moduËTy³
 *
mt
 = 
mv
->
ty³
;

1041 
	`moduËIn™IOCÚ‹xt
(
io
,
mt
,
r
);

1042 
mt
->
	`aof_»wr™e
(&
io
,
key
,
mv
->
v®ue
);

1043 ià(
io
.
ùx
) {

1044 
	`moduËF»eCÚ‹xt
(
io
.
ùx
);

1045 
	`zä“
(
io
.
ùx
);

1047  
io
.
”rÜ
 ? 0 : 1;

1048 
	}
}

1053 
ssize_t
 
	$aofR—dDiffFromP¬’t
() {

1054 
buf
[65536];

1055 
ssize_t
 
Ä—d
, 
tÙ®
 = 0;

1057 (
Ä—d
 =

1058 
	`»ad
(
£rv”
.
aof_pe_»ad_d©a_äom_·»Á
,
buf
,(buf))) > 0) {

1059 
£rv”
.
aof_chd_diff
 = 
	`sdsÿ’
(£rv”.aof_chd_diff,
buf
,
Ä—d
);

1060 
tÙ®
 +ğ
Ä—d
;

1062  
tÙ®
;

1063 
	}
}

1065 
	$»wr™eAµ’dOÆyFeRio
(
rio
 *
aof
) {

1066 
diùI‹¿tÜ
 *
di
 = 
NULL
;

1067 
diùEÁry
 *
de
;

1068 
size_t
 
´oûs£d
 = 0;

1069 
now
 = 
	`m¡ime
();

1070 
j
;

1072 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

1073 
£Ëùcmd
[] = "*2\r\n$6\r\nSELECT\r\n";

1074 
»disDb
 *
db
 = 
£rv”
.db+
j
;

1075 
diù
 *
d
 = 
db
->dict;

1076 ià(
	`diùSize
(
d
) == 0) ;

1077 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
d
);

1080 ià(
	`rioWr™e
(
aof
,
£Ëùcmd
,(£Ëùcmd)-1è=ğ0è
w”r
;

1081 ià(
	`rioWr™eBulkLÚgLÚg
(
aof
,
j
è=ğ0è
w”r
;

1084 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1085 
sds
 
key¡r
;

1086 
robj
 
key
, *
o
;

1087 
expœ‘ime
;

1089 
key¡r
 = 
	`diùG‘Key
(
de
);

1090 
o
 = 
	`diùG‘V®
(
de
);

1091 
	`š™SticSŒšgObjeù
(
key
,
key¡r
);

1093 
expœ‘ime
 = 
	`g‘Expœe
(
db
,&
key
);

1096 ià(
expœ‘ime
 !ğ-1 &&ƒxpœ‘im< 
now
) ;

1099 ià(
o
->
ty³
 =ğ
OBJ_STRING
) {

1101 
cmd
[]="*3\r\n$3\r\nSET\r\n";

1102 ià(
	`rioWr™e
(
aof
,
cmd
,(cmd)-1è=ğ0è
w”r
;

1104 ià(
	`rioWr™eBulkObjeù
(
aof
,&
key
è=ğ0è
w”r
;

1105 ià(
	`rioWr™eBulkObjeù
(
aof
,
o
è=ğ0è
w”r
;

1106 } ià(
o
->
ty³
 =ğ
OBJ_LIST
) {

1107 ià(
	`»wr™eLi¡Objeù
(
aof
,&
key
,
o
è=ğ0è
w”r
;

1108 } ià(
o
->
ty³
 =ğ
OBJ_SET
) {

1109 ià(
	`»wr™eS‘Objeù
(
aof
,&
key
,
o
è=ğ0è
w”r
;

1110 } ià(
o
->
ty³
 =ğ
OBJ_ZSET
) {

1111 ià(
	`»wr™eSÜ‹dS‘Objeù
(
aof
,&
key
,
o
è=ğ0è
w”r
;

1112 } ià(
o
->
ty³
 =ğ
OBJ_HASH
) {

1113 ià(
	`»wr™eHashObjeù
(
aof
,&
key
,
o
è=ğ0è
w”r
;

1114 } ià(
o
->
ty³
 =ğ
OBJ_MODULE
) {

1115 ià(
	`»wr™eModuËObjeù
(
aof
,&
key
,
o
è=ğ0è
w”r
;

1117 
	`£rv”Pªic
("Unknown objectype");

1120 ià(
expœ‘ime
 != -1) {

1121 
cmd
[]="*3\r\n$9\r\nPEXPIREAT\r\n";

1122 ià(
	`rioWr™e
(
aof
,
cmd
,(cmd)-1è=ğ0è
w”r
;

1123 ià(
	`rioWr™eBulkObjeù
(
aof
,&
key
è=ğ0è
w”r
;

1124 ià(
	`rioWr™eBulkLÚgLÚg
(
aof
,
expœ‘ime
è=ğ0è
w”r
;

1127 ià(
aof
->
´oûs£d_by‹s
 > 
´oûs£d
+
AOF_READ_DIFF_INTERVAL_BYTES
) {

1128 
´oûs£d
 = 
aof
->
´oûs£d_by‹s
;

1129 
	`aofR—dDiffFromP¬’t
();

1132 
	`diùR–—£I‹¿tÜ
(
di
);

1133 
di
 = 
NULL
;

1135  
C_OK
;

1137 
w”r
:

1138 ià(
di
è
	`diùR–—£I‹¿tÜ
(di);

1139  
C_ERR
;

1140 
	}
}

1149 
	$»wr™eAµ’dOÆyFe
(*
f’ame
) {

1150 
rio
 
aof
;

1151 
FILE
 *
å
;

1152 
tmpfe
[256];

1153 
by‹
;

1157 
	`¢´štf
(
tmpfe
,256,"‹mp-»wr™—of-%d.aof", (è
	`g‘pid
());

1158 
å
 = 
	`fİ’
(
tmpfe
,"w");

1159 ià(!
å
) {

1160 
	`£rv”Log
(
LL_WARNING
, "O³nšgh‹m°ffÜ AOF„ewr™š„ewr™eAµ’dOÆyFe(): %s", 
	`¡»¼Ü
(
”ºo
));

1161  
C_ERR
;

1164 
£rv”
.
aof_chd_diff
 = 
	`sd£m±y
();

1165 
	`rioIn™W™hFe
(&
aof
,
å
);

1167 ià(
£rv”
.
aof_»wr™e_šüem’l_fsync
)

1168 
	`rioS‘AutoSync
(&
aof
,
AOF_AUTOSYNC_BYTES
);

1170 ià(
£rv”
.
aof_u£_rdb_´—mbË
) {

1171 
”rÜ
;

1172 ià(
	`rdbSaveRio
(&
aof
,&
”rÜ
,
RDB_SAVE_AOF_PREAMBLE
,
NULL
è=ğ
C_ERR
) {

1173 
”ºo
 = 
”rÜ
;

1174 
w”r
;

1177 ià(
	`»wr™eAµ’dOÆyFeRio
(&
aof
è=ğ
C_ERR
è
w”r
;

1182 ià(
	`fæush
(
å
è=ğ
EOF
è
w”r
;

1183 ià(
	`fsync
(
	`f’o
(
å
)è=ğ-1è
w”r
;

1191 
nod©a
 = 0;

1192 
m¡ime_t
 
¡¬t
 = 
	`m¡ime
();

1193 
	`m¡ime
()-
¡¬t
 < 1000 && 
nod©a
 < 20) {

1194 ià(
	`«Wa™
(
£rv”
.
aof_pe_»ad_d©a_äom_·»Á
, 
AE_READABLE
, 1) <= 0)

1196 
nod©a
++;

1199 
nod©a
 = 0;

1201 
	`aofR—dDiffFromP¬’t
();

1205 ià(
	`wr™e
(
£rv”
.
aof_pe_wr™e_ack_to_·»Á
,"!",1è!ğ1è
w”r
;

1206 ià(
	`ª‘NÚBlock
(
NULL
,
£rv”
.
aof_pe_»ad_ack_äom_·»Á
è!ğ
ANET_OK
)

1207 
w”r
;

1211 ià(
	`syncR—d
(
£rv”
.
aof_pe_»ad_ack_äom_·»Á
,&
by‹
,1,5000) != 1 ||

1212 
by‹
 !ğ'!'è
w”r
;

1213 
	`£rv”Log
(
LL_NOTICE
,"Parent‡greedo stop sending diffs. Finalizing AOF...");

1216 
	`aofR—dDiffFromP¬’t
();

1219 
	`£rv”Log
(
LL_NOTICE
,

1221 (è
	`sd¦’
(
£rv”
.
aof_chd_diff
) / (1024*1024));

1222 ià(
	`rioWr™e
(&
aof
,
£rv”
.
aof_chd_diff
,
	`sd¦’
(server.aof_child_diff)) == 0)

1223 
w”r
;

1226 ià(
	`fæush
(
å
è=ğ
EOF
è
w”r
;

1227 ià(
	`fsync
(
	`f’o
(
å
)è=ğ-1è
w”r
;

1228 ià(
	`fşo£
(
å
è=ğ
EOF
è
w”r
;

1232 ià(
	`»Çme
(
tmpfe
,
f’ame
) == -1) {

1233 
	`£rv”Log
(
LL_WARNING
,"E¼Ü movšgem°­³nd oÆy fÚhfš® de¡š©iÚ: %s", 
	`¡»¼Ü
(
”ºo
));

1234 
	`uÆšk
(
tmpfe
);

1235  
C_ERR
;

1237 
	`£rv”Log
(
LL_NOTICE
,"SYNC‡ppend only file„ewrite…erformed");

1238  
C_OK
;

1240 
w”r
:

1241 
	`£rv”Log
(
LL_WARNING
,"Wr™”rÜ wr™šg‡µ’d oÆy fÚ disk: %s", 
	`¡»¼Ü
(
”ºo
));

1242 
	`fşo£
(
å
);

1243 
	`uÆšk
(
tmpfe
);

1244  
C_ERR
;

1245 
	}
}

1254 
	$aofChdPeR—dabË
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

1255 
by‹
;

1256 
	`UNUSED
(
–
);

1257 
	`UNUSED
(
´ivd©a
);

1258 
	`UNUSED
(
mask
);

1260 ià(
	`»ad
(
fd
,&
by‹
,1) == 1 && byte == '!') {

1261 
	`£rv”Log
(
LL_NOTICE
,"AOF„ewrite child‡skso stop sending diffs.");

1262 
£rv”
.
aof_¡İ_£ndšg_diff
 = 1;

1263 ià(
	`wr™e
(
£rv”
.
aof_pe_wr™e_ack_to_chd
,"!",1) != 1) {

1268 
	`£rv”Log
(
LL_WARNING
,"Can't send ACKo AOF child: %s",

1269 
	`¡»¼Ü
(
”ºo
));

1274 
	`«D–‘eFeEv’t
(
£rv”
.
–
,£rv”.
aof_pe_»ad_ack_äom_chd
,
AE_READABLE
);

1275 
	}
}

1282 
	$aofC»©ePes
() {

1283 
fds
[6] = {-1, -1, -1, -1, -1, -1};

1284 
j
;

1286 ià(
	`pe
(
fds
è=ğ-1è
”rÜ
;

1287 ià(
	`pe
(
fds
+2è=ğ-1è
”rÜ
;

1288 ià(
	`pe
(
fds
+4è=ğ-1è
”rÜ
;

1290 ià(
	`ª‘NÚBlock
(
NULL
,
fds
[0]è!ğ
ANET_OK
è
”rÜ
;

1291 ià(
	`ª‘NÚBlock
(
NULL
,
fds
[1]è!ğ
ANET_OK
è
”rÜ
;

1292 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
, 
fds
[2], 
AE_READABLE
, 
aofChdPeR—dabË
, 
NULL
è=ğ
AE_ERR
è
”rÜ
;

1294 
£rv”
.
aof_pe_wr™e_d©a_to_chd
 = 
fds
[1];

1295 
£rv”
.
aof_pe_»ad_d©a_äom_·»Á
 = 
fds
[0];

1296 
£rv”
.
aof_pe_wr™e_ack_to_·»Á
 = 
fds
[3];

1297 
£rv”
.
aof_pe_»ad_ack_äom_chd
 = 
fds
[2];

1298 
£rv”
.
aof_pe_wr™e_ack_to_chd
 = 
fds
[5];

1299 
£rv”
.
aof_pe_»ad_ack_äom_·»Á
 = 
fds
[4];

1300 
£rv”
.
aof_¡İ_£ndšg_diff
 = 0;

1301  
C_OK
;

1303 
”rÜ
:

1304 
	`£rv”Log
(
LL_WARNING
,"Error opening /setting AOF„ewrite IPC…ipes: %s",

1305 
	`¡»¼Ü
(
”ºo
));

1306 
j
 = 0; j < 6; j++èif(
fds
[j] !ğ-1è
	`şo£
(fds[j]);

1307  
C_ERR
;

1308 
	}
}

1310 
	$aofClo£Pes
() {

1311 
	`«D–‘eFeEv’t
(
£rv”
.
–
,£rv”.
aof_pe_»ad_ack_äom_chd
,
AE_READABLE
);

1312 
	`«D–‘eFeEv’t
(
£rv”
.
–
,£rv”.
aof_pe_wr™e_d©a_to_chd
,
AE_WRITABLE
);

1313 
	`şo£
(
£rv”
.
aof_pe_wr™e_d©a_to_chd
);

1314 
	`şo£
(
£rv”
.
aof_pe_»ad_d©a_äom_·»Á
);

1315 
	`şo£
(
£rv”
.
aof_pe_wr™e_ack_to_·»Á
);

1316 
	`şo£
(
£rv”
.
aof_pe_»ad_ack_äom_chd
);

1317 
	`şo£
(
£rv”
.
aof_pe_wr™e_ack_to_chd
);

1318 
	`şo£
(
£rv”
.
aof_pe_»ad_ack_äom_·»Á
);

1319 
	}
}

1337 
	$»wr™eAµ’dOÆyFeBackground
() {

1338 
pid_t
 
chdpid
;

1339 
¡¬t
;

1341 ià(
£rv”
.
aof_chd_pid
 !ğ-1 || s”v”.
rdb_chd_pid
 !ğ-1è 
C_ERR
;

1342 ià(
	`aofC»©ePes
(è!ğ
C_OK
è 
C_ERR
;

1343 
	`İ’ChdInfoPe
();

1344 
¡¬t
 = 
	`u¡ime
();

1345 ià((
chdpid
 = 
	`fÜk
()) == 0) {

1346 
tmpfe
[256];

1349 
	`şo£Li¡’šgSock‘s
(0);

1350 
	`»disS‘ProcT™Ë
("redis-aof-rewrite");

1351 
	`¢´štf
(
tmpfe
,256,"‹mp-»wr™—of-bg-%d.aof", (è
	`g‘pid
());

1352 ià(
	`»wr™eAµ’dOÆyFe
(
tmpfe
è=ğ
C_OK
) {

1353 
size_t
 
´iv©e_dœty
 = 
	`zm®loc_g‘_´iv©e_dœty
(-1);

1355 ià(
´iv©e_dœty
) {

1356 
	`£rv”Log
(
LL_NOTICE
,

1358 
´iv©e_dœty
/(1024*1024));

1361 
£rv”
.
chd_šfo_d©a
.
cow_size
 = 
´iv©e_dœty
;

1362 
	`£ndChdInfo
(
CHILD_INFO_TYPE_AOF
);

1363 
	`ex™FromChd
(0);

1365 
	`ex™FromChd
(1);

1369 
£rv”
.
¡©_fÜk_time
 = 
	`u¡ime
()-
¡¬t
;

1370 
£rv”
.
¡©_fÜk_¿‹
 = (è
	`zm®loc_u£d_memÜy
(è* 1000000 / s”v”.
¡©_fÜk_time
 / (1024*1024*1024);

1371 
	`Ï‹ncyAddSam¶eIfN“ded
("fÜk",
£rv”
.
¡©_fÜk_time
/1000);

1372 ià(
chdpid
 == -1) {

1373 
	`şo£ChdInfoPe
();

1374 
	`£rv”Log
(
LL_WARNING
,

1376 
	`¡»¼Ü
(
”ºo
));

1377 
	`aofClo£Pes
();

1378  
C_ERR
;

1380 
	`£rv”Log
(
LL_NOTICE
,

1381 "Background‡µ’d oÆy f»wr™šg s¹ed by…id %d",
chdpid
);

1382 
£rv”
.
aof_»wr™e_scheduËd
 = 0;

1383 
£rv”
.
aof_»wr™e_time_¡¬t
 = 
	`time
(
NULL
);

1384 
£rv”
.
aof_chd_pid
 = 
chdpid
;

1385 
	`upd©eDiùResizePŞicy
();

1390 
£rv”
.
aof_£Ëùed_db
 = -1;

1391 
	`»¶iÿtiÚSütCacheFlush
();

1392  
C_OK
;

1394  
C_OK
;

1395 
	}
}

1397 
	$bg»wr™—ofCommªd
(
ş›Á
 *
c
) {

1398 ià(
£rv”
.
aof_chd_pid
 != -1) {

1399 
	`addR•lyE¼Ü
(
c
,"Background‡ppend only file„ewriting‡lready in…rogress");

1400 } ià(
£rv”
.
rdb_chd_pid
 != -1) {

1401 
£rv”
.
aof_»wr™e_scheduËd
 = 1;

1402 
	`addR•lyStus
(
c
,"Background‡ppend only file„ewriting scheduled");

1403 } ià(
	`»wr™eAµ’dOÆyFeBackground
(è=ğ
C_OK
) {

1404 
	`addR•lyStus
(
c
,"Background‡ppend only file„ewriting started");

1406 
	`addR•ly
(
c
,
sh¬ed
.
”r
);

1408 
	}
}

1410 
	$aofRemoveTempFe
(
pid_t
 
chdpid
) {

1411 
tmpfe
[256];

1413 
	`¢´štf
(
tmpfe
,256,"‹mp-»wr™—of-bg-%d.aof", (è
chdpid
);

1414 
	`uÆšk
(
tmpfe
);

1415 
	}
}

1421 
	$aofUpd©eCu¼’tSize
() {

1422 
»dis_¡©
 
sb
;

1423 
m¡ime_t
 
Ï‹ncy
;

1425 
	`Ï‹ncyS¹MÚ™Ü
(
Ï‹ncy
);

1426 ià(
	`»dis_f¡©
(
£rv”
.
aof_fd
,&
sb
) == -1) {

1427 
	`£rv”Log
(
LL_WARNING
,"Unableo obtainhe AOF file†ength. stat: %s",

1428 
	`¡»¼Ü
(
”ºo
));

1430 
£rv”
.
aof_cu¼’t_size
 = 
sb
.
¡_size
;

1432 
	`Ï‹ncyEndMÚ™Ü
(
Ï‹ncy
);

1433 
	`Ï‹ncyAddSam¶eIfN“ded
("aof-f¡©",
Ï‹ncy
);

1434 
	}
}

1438 
	$backgroundRewr™eDÚeHªdËr
(
ex™code
, 
bysigÇl
) {

1439 ià(!
bysigÇl
 && 
ex™code
 == 0) {

1440 
Ãwfd
, 
Şdfd
;

1441 
tmpfe
[256];

1442 
now
 = 
	`u¡ime
();

1443 
m¡ime_t
 
Ï‹ncy
;

1445 
	`£rv”Log
(
LL_NOTICE
,

1450 
	`Ï‹ncyS¹MÚ™Ü
(
Ï‹ncy
);

1451 
	`¢´štf
(
tmpfe
,256,"temp-rewriteaof-bg-%d.aof",

1452 ()
£rv”
.
aof_chd_pid
);

1453 
Ãwfd
 = 
	`İ’
(
tmpfe
,
O_WRONLY
|
O_APPEND
);

1454 ià(
Ãwfd
 == -1) {

1455 
	`£rv”Log
(
LL_WARNING
,

1456 "UÇbËØİ’h‹mpÜ¬y AOF…roduûd byhchd: %s", 
	`¡»¼Ü
(
”ºo
));

1457 
ş—nup
;

1460 ià(
	`aofRewr™eBufãrWr™e
(
Ãwfd
) == -1) {

1461 
	`£rv”Log
(
LL_WARNING
,

1462 "E¼ÜryšgØæushh·»Á difàtØth»wr™‹ÀAOF: %s", 
	`¡»¼Ü
(
”ºo
));

1463 
	`şo£
(
Ãwfd
);

1464 
ş—nup
;

1466 
	`Ï‹ncyEndMÚ™Ü
(
Ï‹ncy
);

1467 
	`Ï‹ncyAddSam¶eIfN“ded
("aof-»wr™e-diff-wr™e",
Ï‹ncy
);

1469 
	`£rv”Log
(
LL_NOTICE
,

1470 "Residu®…¬’ˆdifàsucûssfuÎy flushedØth»wr™‹ÀAOF (%.2àMB)", (è
	`aofRewr™eBufãrSize
() / (1024*1024));

1499 ià(
£rv”
.
aof_fd
 == -1) {

1505 
Şdfd
 = 
	`İ’
(
£rv”
.
aof_f’ame
,
O_RDONLY
|
O_NONBLOCK
);

1508 
Şdfd
 = -1;

1513 
	`Ï‹ncyS¹MÚ™Ü
(
Ï‹ncy
);

1514 ià(
	`»Çme
(
tmpfe
,
£rv”
.
aof_f’ame
) == -1) {

1515 
	`£rv”Log
(
LL_WARNING
,

1517 
tmpfe
,

1518 
£rv”
.
aof_f’ame
,

1519 
	`¡»¼Ü
(
”ºo
));

1520 
	`şo£
(
Ãwfd
);

1521 ià(
Şdfd
 !ğ-1è
	`şo£
(oldfd);

1522 
ş—nup
;

1524 
	`Ï‹ncyEndMÚ™Ü
(
Ï‹ncy
);

1525 
	`Ï‹ncyAddSam¶eIfN“ded
("aof-»Çme",
Ï‹ncy
);

1527 ià(
£rv”
.
aof_fd
 == -1) {

1530 
	`şo£
(
Ãwfd
);

1533 
Şdfd
 = 
£rv”
.
aof_fd
;

1534 
£rv”
.
aof_fd
 = 
Ãwfd
;

1535 ià(
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_ALWAYS
)

1536 
	`aof_fsync
(
Ãwfd
);

1537 ià(
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_EVERYSEC
)

1538 
	`aof_background_fsync
(
Ãwfd
);

1539 
£rv”
.
aof_£Ëùed_db
 = -1;

1540 
	`aofUpd©eCu¼’tSize
();

1541 
£rv”
.
aof_»wr™e_ba£_size
 = s”v”.
aof_cu¼’t_size
;

1545 
	`sdsä“
(
£rv”
.
aof_buf
);

1546 
£rv”
.
aof_buf
 = 
	`sd£m±y
();

1549 
£rv”
.
aof_Ï¡bg»wr™e_¡©us
 = 
C_OK
;

1551 
	`£rv”Log
(
LL_NOTICE
, "Background AOF„ewrite finished successfully");

1553 ià(
£rv”
.
aof_¡©e
 =ğ
AOF_WAIT_REWRITE
)

1554 
£rv”
.
aof_¡©e
 = 
AOF_ON
;

1557 ià(
Şdfd
 !ğ-1è
	`bioC»©eBackgroundJob
(
BIO_CLOSE_FILE
,(*)()Şdfd,
NULL
,NULL);

1559 
	`£rv”Log
(
LL_VERBOSE
,

1560 "Background AOF„ewr™sigÇÈhªdË¸took %Îdus", 
	`u¡ime
()-
now
);

1561 } ià(!
bysigÇl
 && 
ex™code
 != 0) {

1564 ià(
bysigÇl
 !ğ
SIGUSR1
)

1565 
£rv”
.
aof_Ï¡bg»wr™e_¡©us
 = 
C_ERR
;

1566 
	`£rv”Log
(
LL_WARNING
,

1569 
£rv”
.
aof_Ï¡bg»wr™e_¡©us
 = 
C_ERR
;

1571 
	`£rv”Log
(
LL_WARNING
,

1572 "Background AOF„ewr™‹rmš©ed by sigÇÈ%d", 
bysigÇl
);

1575 
ş—nup
:

1576 
	`aofClo£Pes
();

1577 
	`aofRewr™eBufãrRe£t
();

1578 
	`aofRemoveTempFe
(
£rv”
.
aof_chd_pid
);

1579 
£rv”
.
aof_chd_pid
 = -1;

1580 
£rv”
.
aof_»wr™e_time_Ï¡
 = 
	`time
(
NULL
)-£rv”.
aof_»wr™e_time_¡¬t
;

1581 
£rv”
.
aof_»wr™e_time_¡¬t
 = -1;

1583 ià(
£rv”
.
aof_¡©e
 =ğ
AOF_WAIT_REWRITE
)

1584 
£rv”
.
aof_»wr™e_scheduËd
 = 1;

1585 
	}
}

	@asciilogo.h

30 *
	gascii_logo
 =

	@atomicvar.h

60 
	~<±h»ad.h
>

62 #iâdeà
__ATOMIC_VAR_H


63 
	#__ATOMIC_VAR_H


	)

71 #ià!
defšed
(
__ATOMIC_VAR_FORCE_SYNC_MACROS
è&& defšed(
__ATOMIC_RELAXED
è&& !defšed(
__sun
è&& (!defšed(
__şªg__
è|| !defšed(
__APPLE__
è|| 
__­¶e_bud_v”siÚ__
 > 4210057)

74 
	#©omicInü
(
v¬
,
couÁ
è
	`__©omic_add_ãtch
(&v¬,(couÁ),
__ATOMIC_RELAXED
)

	)

75 
	#©omicG‘Inü
(
v¬
,
Şdv®ue_v¬
,
couÁ
) do { \

76 
Şdv®ue_v¬
 = 
	`__©omic_ãtch_add
(&
v¬
,(
couÁ
),
__ATOMIC_RELAXED
); \

77 } 0)

	)

78 
	#©omicDeü
(
v¬
,
couÁ
è
	`__©omic_sub_ãtch
(&v¬,(couÁ),
__ATOMIC_RELAXED
)

	)

79 
	#©omicG‘
(
v¬
,
d¡v¬
) do { \

80 
d¡v¬
 = 
	`__©omic_lßd_n
(&
v¬
,
__ATOMIC_RELAXED
); \

81 } 0)

	)

82 
	#©omicS‘
(
v¬
,
v®ue
è
	`__©omic_¡Üe_n
(&v¬,v®ue,
__ATOMIC_RELAXED
)

	)

83 
	#REDIS_ATOMIC_API
 "©omic-butš"

	)

85 #–ià
defšed
(
HAVE_ATOMIC
)

88 
	#©omicInü
(
v¬
,
couÁ
è
	`__sync_add_ªd_ãtch
(&v¬,(couÁ))

	)

89 
	#©omicG‘Inü
(
v¬
,
Şdv®ue_v¬
,
couÁ
) do { \

90 
Şdv®ue_v¬
 = 
	`__sync_ãtch_ªd_add
(&
v¬
,(
couÁ
)); \

91 } 0)

	)

92 
	#©omicDeü
(
v¬
,
couÁ
è
	`__sync_sub_ªd_ãtch
(&v¬,(couÁ))

	)

93 
	#©omicG‘
(
v¬
,
d¡v¬
) do { \

94 
d¡v¬
 = 
	`__sync_sub_ªd_ãtch
(&
v¬
,0); \

95 } 0)

	)

96 
	#©omicS‘
(
v¬
,
v®ue
) do { \

97 !
	`__sync_boŞ_com·»_ªd_sw­
(&
v¬
,v¬,
v®ue
)); \

98 } 0)

	)

99 
	#REDIS_ATOMIC_API
 "sync-butš"

	)

104 
	#©omicInü
(
v¬
,
couÁ
) do { \

105 
	`±h»ad_mu‹x_lock
(&
v¬
 ## 
_mu‹x
); \

106 
v¬
 +ğ(
couÁ
); \

107 
	`±h»ad_mu‹x_uÆock
(&
v¬
 ## 
_mu‹x
); \

108 } 0)

	)

109 
	#©omicG‘Inü
(
v¬
,
Şdv®ue_v¬
,
couÁ
) do { \

110 
	`±h»ad_mu‹x_lock
(&
v¬
 ## 
_mu‹x
); \

111 
Şdv®ue_v¬
 = 
v¬
; \

112 
v¬
 +ğ(
couÁ
); \

113 
	`±h»ad_mu‹x_uÆock
(&
v¬
 ## 
_mu‹x
); \

114 } 0)

	)

115 
	#©omicDeü
(
v¬
,
couÁ
) do { \

116 
	`±h»ad_mu‹x_lock
(&
v¬
 ## 
_mu‹x
); \

117 
v¬
 -ğ(
couÁ
); \

118 
	`±h»ad_mu‹x_uÆock
(&
v¬
 ## 
_mu‹x
); \

119 } 0)

	)

120 
	#©omicG‘
(
v¬
,
d¡v¬
) do { \

121 
	`±h»ad_mu‹x_lock
(&
v¬
 ## 
_mu‹x
); \

122 
d¡v¬
 = 
v¬
; \

123 
	`±h»ad_mu‹x_uÆock
(&
v¬
 ## 
_mu‹x
); \

124 } 0)

	)

125 
	#©omicS‘
(
v¬
,
v®ue
) do { \

126 
	`±h»ad_mu‹x_lock
(&
v¬
 ## 
_mu‹x
); \

127 
v¬
 = 
v®ue
; \

128 
	`±h»ad_mu‹x_uÆock
(&
v¬
 ## 
_mu‹x
); \

129 } 0)

	)

130 
	#REDIS_ATOMIC_API
 "±h»ad-mu‹x"

	)

	@bio.c

61 
	~"£rv”.h
"

62 
	~"bio.h
"

64 
±h»ad_t
 
	gbio_th»ads
[
BIO_NUM_OPS
];

65 
±h»ad_mu‹x_t
 
	gbio_mu‹x
[
BIO_NUM_OPS
];

66 
±h»ad_cÚd_t
 
	gbio_Ãwjob_cÚd
[
BIO_NUM_OPS
];

67 
±h»ad_cÚd_t
 
	gbio_¡•_cÚd
[
BIO_NUM_OPS
];

68 
li¡
 *
	gbio_jobs
[
BIO_NUM_OPS
];

75 
	gbio_³ndšg
[
BIO_NUM_OPS
];

79 
	sbio_job
 {

80 
time_t
 
	mtime
;

83 *
	m¬g1
, *
	m¬g2
, *
	m¬g3
;

86 *
bioProûssBackgroundJobs
(*
¬g
);

87 
Ïzyä“F»eObjeùFromBioTh»ad
(
robj
 *
o
);

88 
Ïzyä“F»eD©aba£FromBioTh»ad
(
diù
 *
ht1
, diù *
ht2
);

89 
Ïzyä“F»eSlÙsM­FromBioTh»ad
(
zskli¡
 *
¦
);

93 
	#REDIS_THREAD_STACK_SIZE
 (1024*1024*4)

	)

96 
	$bioIn™
() {

97 
±h»ad_©Œ_t
 
©Œ
;

98 
±h»ad_t
 
th»ad
;

99 
size_t
 
¡acksize
;

100 
j
;

103 
j
 = 0; j < 
BIO_NUM_OPS
; j++) {

104 
	`±h»ad_mu‹x_š™
(&
bio_mu‹x
[
j
],
NULL
);

105 
	`±h»ad_cÚd_š™
(&
bio_Ãwjob_cÚd
[
j
],
NULL
);

106 
	`±h»ad_cÚd_š™
(&
bio_¡•_cÚd
[
j
],
NULL
);

107 
bio_jobs
[
j
] = 
	`li¡C»©e
();

108 
bio_³ndšg
[
j
] = 0;

112 
	`±h»ad_©Œ_š™
(&
©Œ
);

113 
	`±h»ad_©Œ_g‘¡acksize
(&
©Œ
,&
¡acksize
);

114 ià(!
¡acksize
) stacksize = 1;

115 
¡acksize
 < 
REDIS_THREAD_STACK_SIZE
) stacksize *= 2;

116 
	`±h»ad_©Œ_£t¡acksize
(&
©Œ
, 
¡acksize
);

121 
j
 = 0; j < 
BIO_NUM_OPS
; j++) {

122 *
¬g
 = (*)(è
j
;

123 ià(
	`±h»ad_ü—‹
(&
th»ad
,&
©Œ
,
bioProûssBackgroundJobs
,
¬g
) != 0) {

124 
	`£rv”Log
(
LL_WARNING
,"Fatal: Can't initialize Background Jobs.");

125 
	`ex™
(1);

127 
bio_th»ads
[
j
] = 
th»ad
;

129 
	}
}

131 
	$bioC»©eBackgroundJob
(
ty³
, *
¬g1
, *
¬g2
, *
¬g3
) {

132 
bio_job
 *
job
 = 
	`zm®loc
((*job));

134 
job
->
time
 = 
	`time
(
NULL
);

135 
job
->
¬g1
 =‡rg1;

136 
job
->
¬g2
 =‡rg2;

137 
job
->
¬g3
 =‡rg3;

138 
	`±h»ad_mu‹x_lock
(&
bio_mu‹x
[
ty³
]);

139 
	`li¡AddNodeTa
(
bio_jobs
[
ty³
],
job
);

140 
bio_³ndšg
[
ty³
]++;

141 
	`±h»ad_cÚd_sigÇl
(&
bio_Ãwjob_cÚd
[
ty³
]);

142 
	`±h»ad_mu‹x_uÆock
(&
bio_mu‹x
[
ty³
]);

143 
	}
}

145 *
	$bioProûssBackgroundJobs
(*
¬g
) {

146 
bio_job
 *
job
;

147 
ty³
 = (è
¬g
;

148 
sig£t_t
 
sig£t
;

151 ià(
ty³
 >ğ
BIO_NUM_OPS
) {

152 
	`£rv”Log
(
LL_WARNING
,

153 "W¬nšg: biØth»ad s¹ed w™h wrÚgy³ %lu",
ty³
);

154  
NULL
;

159 
	`±h»ad_£tÿnûl¡©e
(
PTHREAD_CANCEL_ENABLE
, 
NULL
);

160 
	`±h»ad_£tÿnûÉy³
(
PTHREAD_CANCEL_ASYNCHRONOUS
, 
NULL
);

162 
	`±h»ad_mu‹x_lock
(&
bio_mu‹x
[
ty³
]);

165 
	`sigem±y£t
(&
sig£t
);

166 
	`sigadd£t
(&
sig£t
, 
SIGALRM
);

167 ià(
	`±h»ad_sigmask
(
SIG_BLOCK
, &
sig£t
, 
NULL
))

168 
	`£rv”Log
(
LL_WARNING
,

169 "W¬nšg: cª'ˆmask SIGALRM iÀbio.øth»ad: %s", 
	`¡»¼Ü
(
”ºo
));

172 
li¡Node
 *
Ê
;

175 ià(
	`li¡L’gth
(
bio_jobs
[
ty³
]) == 0) {

176 
	`±h»ad_cÚd_wa™
(&
bio_Ãwjob_cÚd
[
ty³
],&
bio_mu‹x
[type]);

180 
Ê
 = 
	`li¡Fœ¡
(
bio_jobs
[
ty³
]);

181 
job
 = 
Ê
->
v®ue
;

184 
	`±h»ad_mu‹x_uÆock
(&
bio_mu‹x
[
ty³
]);

187 ià(
ty³
 =ğ
BIO_CLOSE_FILE
) {

188 
	`şo£
(()
job
->
¬g1
);

189 } ià(
ty³
 =ğ
BIO_AOF_FSYNC
) {

190 
	`aof_fsync
(()
job
->
¬g1
);

191 } ià(
ty³
 =ğ
BIO_LAZY_FREE
) {

196 ià(
job
->
¬g1
)

197 
	`Ïzyä“F»eObjeùFromBioTh»ad
(
job
->
¬g1
);

198 ià(
job
->
¬g2
 && job->
¬g3
)

199 
	`Ïzyä“F»eD©aba£FromBioTh»ad
(
job
->
¬g2
,job->
¬g3
);

200 ià(
job
->
¬g3
)

201 
	`Ïzyä“F»eSlÙsM­FromBioTh»ad
(
job
->
¬g3
);

203 
	`£rv”Pªic
("Wrong jobype in bioProcessBackgroundJobs().");

205 
	`zä“
(
job
);

208 
	`±h»ad_cÚd_brßdÿ¡
(&
bio_¡•_cÚd
[
ty³
]);

212 
	`±h»ad_mu‹x_lock
(&
bio_mu‹x
[
ty³
]);

213 
	`li¡D–Node
(
bio_jobs
[
ty³
],
Ê
);

214 
bio_³ndšg
[
ty³
]--;

216 
	}
}

219 
	$bioP’dšgJobsOfTy³
(
ty³
) {

220 
v®
;

221 
	`±h»ad_mu‹x_lock
(&
bio_mu‹x
[
ty³
]);

222 
v®
 = 
bio_³ndšg
[
ty³
];

223 
	`±h»ad_mu‹x_uÆock
(&
bio_mu‹x
[
ty³
]);

224  
v®
;

225 
	}
}

237 
	$bioWa™S‹pOfTy³
(
ty³
) {

238 
v®
;

239 
	`±h»ad_mu‹x_lock
(&
bio_mu‹x
[
ty³
]);

240 
v®
 = 
bio_³ndšg
[
ty³
];

241 ià(
v®
 != 0) {

242 
	`±h»ad_cÚd_wa™
(&
bio_¡•_cÚd
[
ty³
],&
bio_mu‹x
[type]);

243 
v®
 = 
bio_³ndšg
[
ty³
];

245 
	`±h»ad_mu‹x_uÆock
(&
bio_mu‹x
[
ty³
]);

246  
v®
;

247 
	}
}

253 
	$bioKlTh»ads
() {

254 
”r
, 
j
;

256 
j
 = 0; j < 
BIO_NUM_OPS
; j++) {

257 ià(
	`±h»ad_ÿnûl
(
bio_th»ads
[
j
]) == 0) {

258 ià((
”r
 = 
	`±h»ad_još
(
bio_th»ads
[
j
],
NULL
)) != 0) {

259 
	`£rv”Log
(
LL_WARNING
,

261 
j
, 
	`¡»¼Ü
(
”r
));

263 
	`£rv”Log
(
LL_WARNING
,

264 "BiØth»ad fÜ joby³ #%d”mš©ed",
j
);

268 
	}
}

	@bio.h

31 
bioIn™
();

32 
bioC»©eBackgroundJob
(
ty³
, *
¬g1
, *
¬g2
, *
¬g3
);

33 
bioP’dšgJobsOfTy³
(
ty³
);

34 
bioWa™S‹pOfTy³
(
ty³
);

35 
time_t
 
bioOld”JobOfTy³
(
ty³
);

36 
bioKlTh»ads
();

39 
	#BIO_CLOSE_FILE
 0

	)

40 
	#BIO_AOF_FSYNC
 1

	)

41 
	#BIO_LAZY_FREE
 2

	)

42 
	#BIO_NUM_OPS
 3

	)

	@bitops.c

31 
	~"£rv”.h
"

40 
size_t
 
	$»disPİcouÁ
(*
s
, 
couÁ
) {

41 
size_t
 
b™s
 = 0;

42 *
p
 = 
s
;

43 
ušt32_t
 *
p4
;

44 cÚ¡ 
b™sšby‹
[256] = {0,1,1,2,1,2,2,3,1,2,2,3,2,3,3,4,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,4,5,5,6,5,6,6,7,5,6,6,7,6,7,7,8};

47 ()
p
 & 3 && 
couÁ
) {

48 
b™s
 +ğ
b™sšby‹
[*
p
++];

49 
couÁ
--;

53 
p4
 = (
ušt32_t
*)
p
;

54 
couÁ
>=28) {

55 
ušt32_t
 
aux1
, 
aux2
, 
aux3
, 
aux4
, 
aux5
, 
aux6
, 
aux7
;

57 
aux1
 = *
p4
++;

58 
aux2
 = *
p4
++;

59 
aux3
 = *
p4
++;

60 
aux4
 = *
p4
++;

61 
aux5
 = *
p4
++;

62 
aux6
 = *
p4
++;

63 
aux7
 = *
p4
++;

64 
couÁ
 -= 28;

66 
aux1
 =‡ux1 - ((aux1 >> 1) & 0x55555555);

67 
aux1
 = (aux1 & 0x33333333) + ((aux1 >> 2) & 0x33333333);

68 
aux2
 =‡ux2 - ((aux2 >> 1) & 0x55555555);

69 
aux2
 = (aux2 & 0x33333333) + ((aux2 >> 2) & 0x33333333);

70 
aux3
 =‡ux3 - ((aux3 >> 1) & 0x55555555);

71 
aux3
 = (aux3 & 0x33333333) + ((aux3 >> 2) & 0x33333333);

72 
aux4
 =‡ux4 - ((aux4 >> 1) & 0x55555555);

73 
aux4
 = (aux4 & 0x33333333) + ((aux4 >> 2) & 0x33333333);

74 
aux5
 =‡ux5 - ((aux5 >> 1) & 0x55555555);

75 
aux5
 = (aux5 & 0x33333333) + ((aux5 >> 2) & 0x33333333);

76 
aux6
 =‡ux6 - ((aux6 >> 1) & 0x55555555);

77 
aux6
 = (aux6 & 0x33333333) + ((aux6 >> 2) & 0x33333333);

78 
aux7
 =‡ux7 - ((aux7 >> 1) & 0x55555555);

79 
aux7
 = (aux7 & 0x33333333) + ((aux7 >> 2) & 0x33333333);

80 
b™s
 +ğ((((
aux1
 + (aux1 >> 4)) & 0x0F0F0F0F) +

81 ((
aux2
 + (aux2 >> 4)) & 0x0F0F0F0F) +

82 ((
aux3
 + (aux3 >> 4)) & 0x0F0F0F0F) +

83 ((
aux4
 + (aux4 >> 4)) & 0x0F0F0F0F) +

84 ((
aux5
 + (aux5 >> 4)) & 0x0F0F0F0F) +

85 ((
aux6
 + (aux6 >> 4)) & 0x0F0F0F0F) +

86 ((
aux7
 + (aux7 >> 4)) & 0x0F0F0F0F))* 0x01010101) >> 24;

89 
p
 = (*)
p4
;

90 
couÁ
--è
b™s
 +ğ
b™sšby‹
[*
p
++];

91  
b™s
;

92 
	}
}

101 
	$»disB™pos
(*
s
, 
couÁ
, 
b™
) {

102 *
l
;

103 *
c
;

104 
skv®
, 
wÜd
 = 0, 
Úe
;

105 
pos
 = 0;

106 
j
;

107 
found
;

119 
skv®
 = 
b™
 ? 0 : 
UCHAR_MAX
;

120 
c
 = (*è
s
;

121 
found
 = 0;

122 ()
c
 & ((*
l
)-1è&& 
couÁ
) {

123 ià(*
c
 !ğ
skv®
) {

124 
found
 = 1;

127 
c
++;

128 
couÁ
--;

129 
pos
 += 8;

133 
l
 = (*è
c
;

134 ià(!
found
) {

135 
skv®
 = 
b™
 ? 0 : 
ULONG_MAX
;

136 
couÁ
 >ğ(*
l
)) {

137 ià(*
l
 !ğ
skv®
) ;

138 
l
++;

139 
couÁ
 -ğ(*
l
);

140 
pos
 +ğ(*
l
)*8;

151 
c
 = (*)
l
;

152 
j
 = 0; j < (*
l
); j++) {

153 
wÜd
 <<= 8;

154 ià(
couÁ
) {

155 
wÜd
 |ğ*
c
;

156 
c
++;

157 
couÁ
--;

166 ià(
b™
 =ğ1 && 
wÜd
 == 0)  -1;

172 
Úe
 = 
ULONG_MAX
;

173 
Úe
 >>= 1;

174 
Úe
 = ~one;

176 
Úe
) {

177 ià(((
Úe
 & 
wÜd
è!ğ0è=ğ
b™
è 
pos
;

178 
pos
++;

179 
Úe
 >>= 1;

184 
	`£rv”Pªic
("End of„edisBitpos()„eached.");

186 
	}
}

209 
	$£tUnsigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
, ušt64_ˆ
v®ue
) {

210 
ušt64_t
 
by‹
, 
b™
, 
by‹v®
, 
b™v®
, 
j
;

212 
j
 = 0; j < 
b™s
; j++) {

213 
b™v®
 = (
v®ue
 & ((
ušt64_t
)1<<(
b™s
-1-
j
))) != 0;

214 
by‹
 = 
off£t
 >> 3;

215 
b™
 = 7 - (
off£t
 & 0x7);

216 
by‹v®
 = 
p
[
by‹
];

217 
by‹v®
 &ğ~(1 << 
b™
);

218 
by‹v®
 |ğ
b™v®
 << 
b™
;

219 
p
[
by‹
] = 
by‹v®
 & 0xff;

220 
off£t
++;

222 
	}
}

224 
	$£tSigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
, 
št64_t
 
v®ue
) {

225 
ušt64_t
 
uv
 = 
v®ue
;

226 
	`£tUnsigÃdB™f›ld
(
p
,
off£t
,
b™s
,
uv
);

227 
	}
}

229 
ušt64_t
 
	$g‘UnsigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
) {

230 
ušt64_t
 
by‹
, 
b™
, 
by‹v®
, 
b™v®
, 
j
, 
v®ue
 = 0;

232 
j
 = 0; j < 
b™s
; j++) {

233 
by‹
 = 
off£t
 >> 3;

234 
b™
 = 7 - (
off£t
 & 0x7);

235 
by‹v®
 = 
p
[
by‹
];

236 
b™v®
 = (
by‹v®
 >> 
b™
) & 1;

237 
v®ue
 = (v®ue<<1è| 
b™v®
;

238 
off£t
++;

240  
v®ue
;

241 
	}
}

243 
št64_t
 
	$g‘SigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
) {

244 
št64_t
 
v®ue
;

245 uniÚ {
ušt64_t
 
u
; 
št64_t
 
i
;} 
cÚv
;

254 
cÚv
.
u
 = 
	`g‘UnsigÃdB™f›ld
(
p
,
off£t
,
b™s
);

255 
v®ue
 = 
cÚv
.
i
;

260 ià(
v®ue
 & ((
ušt64_t
)1 << (
b™s
-1)))

261 
v®ue
 |ğ((
ušt64_t
)-1è<< 
b™s
;

262  
v®ue
;

263 
	}
}

284 
	#BFOVERFLOW_WRAP
 0

	)

285 
	#BFOVERFLOW_SAT
 1

	)

286 
	#BFOVERFLOW_FAIL
 2

	)

288 
	$checkUnsigÃdB™f›ldOv”æow
(
ušt64_t
 
v®ue
, 
št64_t
 
šü
, ušt64_ˆ
b™s
, 
owty³
, ušt64_ˆ*
lim™
) {

289 
ušt64_t
 
max
 = (
b™s
 =ğ64è? 
UINT64_MAX
 : (((uint64_t)1<<bits)-1);

290 
št64_t
 
maxšü
 = 
max
-
v®ue
;

291 
št64_t
 
mššü
 = -
v®ue
;

293 ià(
v®ue
 > 
max
 || (
šü
 > 0 && inü > 
maxšü
)) {

294 ià(
lim™
) {

295 ià(
owty³
 =ğ
BFOVERFLOW_WRAP
) {

296 
hªdË_w¿p
;

297 } ià(
owty³
 =ğ
BFOVERFLOW_SAT
) {

298 *
lim™
 = 
max
;

302 } ià(
šü
 < 0 && inü < 
mššü
) {

303 ià(
lim™
) {

304 ià(
owty³
 =ğ
BFOVERFLOW_WRAP
) {

305 
hªdË_w¿p
;

306 } ià(
owty³
 =ğ
BFOVERFLOW_SAT
) {

307 *
lim™
 = 0;

314 
hªdË_w¿p
:

316 
ušt64_t
 
mask
 = ((ušt64_t)-1è<< 
b™s
;

317 
ušt64_t
 
»s
 = 
v®ue
+
šü
;

319 
»s
 &ğ~
mask
;

320 *
lim™
 = 
»s
;

323 
	}
}

325 
	$checkSigÃdB™f›ldOv”æow
(
št64_t
 
v®ue
, iÁ64_ˆ
šü
, 
ušt64_t
 
b™s
, 
owty³
, iÁ64_ˆ*
lim™
) {

326 
št64_t
 
max
 = (
b™s
 =ğ64è? 
INT64_MAX
 : (((int64_t)1<<(bits-1))-1);

327 
št64_t
 
mš
 = (-
max
)-1;

332 
št64_t
 
maxšü
 = 
max
-
v®ue
;

333 
št64_t
 
mššü
 = 
mš
-
v®ue
;

335 ià(
v®ue
 > 
max
 || (
b™s
 !ğ64 && 
šü
 > 
maxšü
) || (value >= 0 && incr > 0 && incr > maxincr))

337 ià(
lim™
) {

338 ià(
owty³
 =ğ
BFOVERFLOW_WRAP
) {

339 
hªdË_w¿p
;

340 } ià(
owty³
 =ğ
BFOVERFLOW_SAT
) {

341 *
lim™
 = 
max
;

345 } ià(
v®ue
 < 
mš
 || (
b™s
 !ğ64 && 
šü
 < 
mššü
) || (value < 0 && incr < 0 && incr < minincr)) {

346 ià(
lim™
) {

347 ià(
owty³
 =ğ
BFOVERFLOW_WRAP
) {

348 
hªdË_w¿p
;

349 } ià(
owty³
 =ğ
BFOVERFLOW_SAT
) {

350 *
lim™
 = 
mš
;

357 
hªdË_w¿p
:

359 
ušt64_t
 
mask
 = ((ušt64_t)-1è<< 
b™s
;

360 
ušt64_t
 
msb
 = (ušt64_t)1 << (
b™s
-1);

361 
ušt64_t
 
a
 = 
v®ue
, 
b
 = 
šü
, 
c
;

362 
c
 = 
a
+
b
;

367 ià(
c
 & 
msb
) {

368 
c
 |ğ
mask
;

370 
c
 &ğ~
mask
;

372 *
lim™
 = 
c
;

375 
	}
}

379 
	$´štB™s
(*
p
, 
couÁ
) {

380 
j
, 
i
, 
by‹
;

382 
j
 = 0; j < 
couÁ
; j++) {

383 
by‹
 = 
p
[
j
];

384 
i
 = 0x80; i > 0; i /= 2)

385 
	`´štf
("%c", (
by‹
 & 
i
) ? '1' : '0');

386 
	`´štf
("|");

388 
	`´štf
("\n");

389 
	}
}

395 
	#BITOP_AND
 0

	)

396 
	#BITOP_OR
 1

	)

397 
	#BITOP_XOR
 2

	)

398 
	#BITOP_NOT
 3

	)

400 
	#BITFIELDOP_GET
 0

	)

401 
	#BITFIELDOP_SET
 1

	)

402 
	#BITFIELDOP_INCRBY
 2

	)

411 
	$g‘B™Off£tFromArgum’t
(
ş›Á
 *
c
, 
robj
 *
o
, 
size_t
 *
off£t
, 
hash
, 
b™s
) {

412 
loff£t
;

413 *
”r
 = "bit offset is‚ot‡n integer or out of„ange";

414 *
p
 = 
o
->
±r
;

415 
size_t
 
¶’
 = 
	`sd¦’
(
p
);

416 
u£hash
 = 0;

419 ià(
p
[0] =ğ'#' && 
hash
 && 
b™s
 > 0è
u£hash
 = 1;

421 ià(
	`¡ršg2Î
(
p
+
u£hash
,
¶’
-u£hash,&
loff£t
) == 0) {

422 
	`addR•lyE¼Ü
(
c
,
”r
);

423  
C_ERR
;

427 ià(
u£hash
è
loff£t
 *ğ
b™s
;

430 ià((
loff£t
 < 0) || (()loffset >> 3) >= (512*1024*1024))

432 
	`addR•lyE¼Ü
(
c
,
”r
);

433  
C_ERR
;

436 *
off£t
 = (
size_t
)
loff£t
;

437  
C_OK
;

438 
	}
}

447 
	$g‘B™f›ldTy³FromArgum’t
(
ş›Á
 *
c
, 
robj
 *
o
, *
sign
, *
b™s
) {

448 *
p
 = 
o
->
±r
;

449 *
”r
 = "Invalid bitfieldype. Use something†ike i16 u8. Notehat u64 is‚ot supported but i64 is.";

450 
Îb™s
;

452 ià(
p
[0] == 'i') {

453 *
sign
 = 1;

454 } ià(
p
[0] == 'u') {

455 *
sign
 = 0;

457 
	`addR•lyE¼Ü
(
c
,
”r
);

458  
C_ERR
;

461 ià((
	`¡ršg2Î
(
p
+1,
	`¡¾’
Õ+1),&
Îb™s
)) == 0 ||

462 
Îb™s
 < 1 ||

463 (*
sign
 =ğ1 && 
Îb™s
 > 64) ||

464 (*
sign
 =ğ0 && 
Îb™s
 > 63))

466 
	`addR•lyE¼Ü
(
c
,
”r
);

467  
C_ERR
;

469 *
b™s
 = 
Îb™s
;

470  
C_OK
;

471 
	}
}

478 
robj
 *
	$lookupSŒšgFÜB™Commªd
(
ş›Á
 *
c
, 
size_t
 
maxb™
) {

479 
size_t
 
by‹
 = 
maxb™
 >> 3;

480 
robj
 *
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

482 ià(
o
 =ğ
NULL
) {

483 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ewËn
(
NULL
, 
by‹
+1));

484 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
o
);

486 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)è 
NULL
;

487 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

488 
o
->
±r
 = 
	`sdsgrowz”o
(o->±r,
by‹
+1);

490  
o
;

491 
	}
}

506 *
	$g‘ObjeùR—dOÆySŒšg
(
robj
 *
o
, *
Ën
, *
Îbuf
) {

507 
	`£rv”As£¹
(
o
->
ty³
 =ğ
OBJ_STRING
);

508 *
p
 = 
NULL
;

512 ià(
o
 && o->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

513 
p
 = (*è
Îbuf
;

514 ià(
Ën
è*ËÀğ
	`Î2¡ršg
(
Îbuf
,
LONG_STR_SIZE
,()
o
->
±r
);

515 } ià(
o
) {

516 
p
 = (*è
o
->
±r
;

517 ià(
Ën
è*ËÀğ
	`sd¦’
(
o
->
±r
);

519 ià(
Ën
) *len = 0;

521  
p
;

522 
	}
}

525 
	$£tb™Commªd
(
ş›Á
 *
c
) {

526 
robj
 *
o
;

527 *
”r
 = "bit is‚ot‡n integer or out of„ange";

528 
size_t
 
b™off£t
;

529 
ssize_t
 
by‹
, 
b™
;

530 
by‹v®
, 
b™v®
;

531 
Ú
;

533 ià(
	`g‘B™Off£tFromArgum’t
(
c
,c->
¬gv
[2],&
b™off£t
,0,0è!ğ
C_OK
)

536 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
Ú
,
”r
è!ğ
C_OK
)

540 ià(
Ú
 & ~1) {

541 
	`addR•lyE¼Ü
(
c
,
”r
);

545 ià((
o
 = 
	`lookupSŒšgFÜB™Commªd
(
c
,
b™off£t
)è=ğ
NULL
) ;

548 
by‹
 = 
b™off£t
 >> 3;

549 
by‹v®
 = ((
ušt8_t
*)
o
->
±r
)[
by‹
];

550 
b™
 = 7 - (
b™off£t
 & 0x7);

551 
b™v®
 = 
by‹v®
 & (1 << 
b™
);

554 
by‹v®
 &ğ~(1 << 
b™
);

555 
by‹v®
 |ğ((
Ú
 & 0x1è<< 
b™
);

556 ((
ušt8_t
*)
o
->
±r
)[
by‹
] = 
by‹v®
;

557 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

558 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£tb™",
c
->
¬gv
[1],c->
db
->
id
);

559 
£rv”
.
dœty
++;

560 
	`addR•ly
(
c
, 
b™v®
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

561 
	}
}

564 
	$g‘b™Commªd
(
ş›Á
 *
c
) {

565 
robj
 *
o
;

566 
Îbuf
[32];

567 
size_t
 
b™off£t
;

568 
size_t
 
by‹
, 
b™
;

569 
size_t
 
b™v®
 = 0;

571 ià(
	`g‘B™Off£tFromArgum’t
(
c
,c->
¬gv
[2],&
b™off£t
,0,0è!ğ
C_OK
)

574 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

575 
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) ;

577 
by‹
 = 
b™off£t
 >> 3;

578 
b™
 = 7 - (
b™off£t
 & 0x7);

579 ià(
	`sdsEncodedObjeù
(
o
)) {

580 ià(
by‹
 < 
	`sd¦’
(
o
->
±r
))

581 
b™v®
 = ((
ušt8_t
*)
o
->
±r
)[
by‹
] & (1 << 
b™
);

583 ià(
by‹
 < (
size_t
)
	`Î2¡ršg
(
Îbuf
,Ölbuf),()
o
->
±r
))

584 
b™v®
 = 
Îbuf
[
by‹
] & (1 << 
b™
);

587 
	`addR•ly
(
c
, 
b™v®
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

588 
	}
}

591 
	$b™İCommªd
(
ş›Á
 *
c
) {

592 *
İÇme
 = 
c
->
¬gv
[1]->
±r
;

593 
robj
 *
o
, *
rg‘key
 = 
c
->
¬gv
[2];

594 
İ
, 
j
, 
numkeys
;

595 
robj
 **
objeùs
;

596 **
¤c
;

597 *
Ën
, 
maxËn
 = 0;

599 
mšËn
 = 0;

600 *
»s
 = 
NULL
;

603 ià((
İÇme
[0] =ğ'a' || o²ame[0] =ğ'A'è&& !
	`¡rÿ£cmp
(opname,"and"))

604 
İ
 = 
BITOP_AND
;

605 if((
İÇme
[0] =ğ'o' || o²ame[0] =ğ'O'è&& !
	`¡rÿ£cmp
(opname,"or"))

606 
İ
 = 
BITOP_OR
;

607 if((
İÇme
[0] =ğ'x' || o²ame[0] =ğ'X'è&& !
	`¡rÿ£cmp
(opname,"xor"))

608 
İ
 = 
BITOP_XOR
;

609 if((
İÇme
[0] =ğ'n' || o²ame[0] =ğ'N'è&& !
	`¡rÿ£cmp
(opname,"not"))

610 
İ
 = 
BITOP_NOT
;

612 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

617 ià(
İ
 =ğ
BITOP_NOT
 && 
c
->
¬gc
 != 4) {

618 
	`addR•lyE¼Ü
(
c
,"BITOP NOT must be called with‡ single source key.");

623 
numkeys
 = 
c
->
¬gc
 - 3;

624 
¤c
 = 
	`zm®loc
((*è* 
numkeys
);

625 
Ën
 = 
	`zm®loc
((è* 
numkeys
);

626 
objeùs
 = 
	`zm®loc
((
robj
*è* 
numkeys
);

627 
j
 = 0; j < 
numkeys
; j++) {

628 
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
j
+3]);

630 ià(
o
 =ğ
NULL
) {

631 
objeùs
[
j
] = 
NULL
;

632 
¤c
[
j
] = 
NULL
;

633 
Ën
[
j
] = 0;

634 
mšËn
 = 0;

638 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) {

639 
i
;

640 
i
 = 0; i < 
j
; i++) {

641 ià(
objeùs
[
i
])

642 
	`deüRefCouÁ
(
objeùs
[
i
]);

644 
	`zä“
(
¤c
);

645 
	`zä“
(
Ën
);

646 
	`zä“
(
objeùs
);

649 
objeùs
[
j
] = 
	`g‘DecodedObjeù
(
o
);

650 
¤c
[
j
] = 
objeùs
[j]->
±r
;

651 
Ën
[
j
] = 
	`sd¦’
(
objeùs
[j]->
±r
);

652 ià(
Ën
[
j
] > 
maxËn
) maxlen =†en[j];

653 ià(
j
 =ğ0 || 
Ën
[j] < 
mšËn
) minlen =†en[j];

657 ià(
maxËn
) {

658 
»s
 = (*è
	`sd¢ewËn
(
NULL
,
maxËn
);

659 
ouut
, 
by‹
;

660 
i
;

667 
j
 = 0;

668 #iâdeà
USE_ALIGNED_ACCESS


669 ià(
mšËn
 >ğ()*4 && 
numkeys
 <= 16) {

670 *
Í
[16];

671 *
Ìes
 = (*è
»s
;

674 
	`memıy
(
Í
,
¤c
,(*)*
numkeys
);

675 
	`memıy
(
»s
,
¤c
[0],
mšËn
);

678 ià(
İ
 =ğ
BITOP_AND
) {

679 
mšËn
 >= ()*4) {

680 
i
 = 1; i < 
numkeys
; i++) {

681 
Ìes
[0] &ğ
Í
[
i
][0];

682 
Ìes
[1] &ğ
Í
[
i
][1];

683 
Ìes
[2] &ğ
Í
[
i
][2];

684 
Ìes
[3] &ğ
Í
[
i
][3];

685 
Í
[
i
]+=4;

687 
Ìes
+=4;

688 
j
 += ()*4;

689 
mšËn
 -= ()*4;

691 } ià(
İ
 =ğ
BITOP_OR
) {

692 
mšËn
 >= ()*4) {

693 
i
 = 1; i < 
numkeys
; i++) {

694 
Ìes
[0] |ğ
Í
[
i
][0];

695 
Ìes
[1] |ğ
Í
[
i
][1];

696 
Ìes
[2] |ğ
Í
[
i
][2];

697 
Ìes
[3] |ğ
Í
[
i
][3];

698 
Í
[
i
]+=4;

700 
Ìes
+=4;

701 
j
 += ()*4;

702 
mšËn
 -= ()*4;

704 } ià(
İ
 =ğ
BITOP_XOR
) {

705 
mšËn
 >= ()*4) {

706 
i
 = 1; i < 
numkeys
; i++) {

707 
Ìes
[0] ^ğ
Í
[
i
][0];

708 
Ìes
[1] ^ğ
Í
[
i
][1];

709 
Ìes
[2] ^ğ
Í
[
i
][2];

710 
Ìes
[3] ^ğ
Í
[
i
][3];

711 
Í
[
i
]+=4;

713 
Ìes
+=4;

714 
j
 += ()*4;

715 
mšËn
 -= ()*4;

717 } ià(
İ
 =ğ
BITOP_NOT
) {

718 
mšËn
 >= ()*4) {

719 
Ìes
[0] = ~lres[0];

720 
Ìes
[1] = ~lres[1];

721 
Ìes
[2] = ~lres[2];

722 
Ìes
[3] = ~lres[3];

723 
Ìes
+=4;

724 
j
 += ()*4;

725 
mšËn
 -= ()*4;

732 ; 
j
 < 
maxËn
; j++) {

733 
ouut
 = (
Ën
[0] <ğ
j
è? 0 : 
¤c
[0][j];

734 ià(
İ
 =ğ
BITOP_NOT
è
ouut
 = ~output;

735 
i
 = 1; i < 
numkeys
; i++) {

736 
by‹
 = (
Ën
[
i
] <ğ
j
è? 0 : 
¤c
[i][j];

737 
İ
) {

738 
BITOP_AND
: 
ouut
 &ğ
by‹
; ;

739 
BITOP_OR
: 
ouut
 |ğ
by‹
; ;

740 
BITOP_XOR
: 
ouut
 ^ğ
by‹
; ;

743 
»s
[
j
] = 
ouut
;

746 
j
 = 0; j < 
numkeys
; j++) {

747 ià(
objeùs
[
j
])

748 
	`deüRefCouÁ
(
objeùs
[
j
]);

750 
	`zä“
(
¤c
);

751 
	`zä“
(
Ën
);

752 
	`zä“
(
objeùs
);

755 ià(
maxËn
) {

756 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
»s
);

757 
	`£tKey
(
c
->
db
,
rg‘key
,
o
);

758 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£t",
rg‘key
,
c
->
db
->
id
);

759 
	`deüRefCouÁ
(
o
);

760 } ià(
	`dbD–‘e
(
c
->
db
,
rg‘key
)) {

761 
	`sigÇlModif›dKey
(
c
->
db
,
rg‘key
);

762 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
rg‘key
,
c
->
db
->
id
);

764 
£rv”
.
dœty
++;

765 
	`addR•lyLÚgLÚg
(
c
,
maxËn
);

766 
	}
}

769 
	$b™couÁCommªd
(
ş›Á
 *
c
) {

770 
robj
 *
o
;

771 
¡¬t
, 
’d
, 
¡¾’
;

772 *
p
;

773 
Îbuf
[
LONG_STR_SIZE
];

776 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

777 
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) ;

778 
p
 = 
	`g‘ObjeùR—dOÆySŒšg
(
o
,&
¡¾’
,
Îbuf
);

781 ià(
c
->
¬gc
 == 4) {

782 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
¡¬t
,
NULL
è!ğ
C_OK
)

784 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
’d
,
NULL
è!ğ
C_OK
)

787 ià(
¡¬t
 < 0 && 
’d
 < 0 && start >ƒnd) {

788 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

791 ià(
¡¬t
 < 0è¡¬ˆğ
¡¾’
+start;

792 ià(
’d
 < 0è’d = 
¡¾’
+end;

793 ià(
¡¬t
 < 0) start = 0;

794 ià(
’d
 < 0)ƒnd = 0;

795 ià(
’d
 >ğ
¡¾’
)ƒnd = strlen-1;

796 } ià(
c
->
¬gc
 == 2) {

798 
¡¬t
 = 0;

799 
’d
 = 
¡¾’
-1;

802 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

808 ià(
¡¬t
 > 
’d
) {

809 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

811 
by‹s
 = 
’d
-
¡¬t
+1;

813 
	`addR•lyLÚgLÚg
(
c
,
	`»disPİcouÁ
(
p
+
¡¬t
,
by‹s
));

815 
	}
}

818 
	$b™posCommªd
(
ş›Á
 *
c
) {

819 
robj
 *
o
;

820 
b™
, 
¡¬t
, 
’d
, 
¡¾’
;

821 *
p
;

822 
Îbuf
[
LONG_STR_SIZE
];

823 
’d_giv’
 = 0;

827 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
b™
,
NULL
è!ğ
C_OK
)

829 ià(
b™
 != 0 && bit != 1) {

830 
	`addR•lyE¼Ü
(
c
, "The bit‡rgument must be 1 or 0.");

837 ià((
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[1])è=ğ
NULL
) {

838 
	`addR•lyLÚgLÚg
(
c
, 
b™
 ? -1 : 0);

841 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) ;

842 
p
 = 
	`g‘ObjeùR—dOÆySŒšg
(
o
,&
¡¾’
,
Îbuf
);

845 ià(
c
->
¬gc
 == 4 || c->argc == 5) {

846 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
¡¬t
,
NULL
è!ğ
C_OK
)

848 ià(
c
->
¬gc
 == 5) {

849 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[4],&
’d
,
NULL
è!ğ
C_OK
)

851 
’d_giv’
 = 1;

853 
’d
 = 
¡¾’
-1;

856 ià(
¡¬t
 < 0è¡¬ˆğ
¡¾’
+start;

857 ià(
’d
 < 0è’d = 
¡¾’
+end;

858 ià(
¡¬t
 < 0) start = 0;

859 ià(
’d
 < 0)ƒnd = 0;

860 ià(
’d
 >ğ
¡¾’
)ƒnd = strlen-1;

861 } ià(
c
->
¬gc
 == 3) {

863 
¡¬t
 = 0;

864 
’d
 = 
¡¾’
-1;

867 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

873 ià(
¡¬t
 > 
’d
) {

874 
	`addR•lyLÚgLÚg
(
c
, -1);

876 
by‹s
 = 
’d
-
¡¬t
+1;

877 
pos
 = 
	`»disB™pos
(
p
+
¡¬t
,
by‹s
,
b™
);

886 ià(
’d_giv’
 && 
b™
 =ğ0 && 
pos
 =ğ
by‹s
*8) {

887 
	`addR•lyLÚgLÚg
(
c
,-1);

890 ià(
pos
 !ğ-1èpo +ğ
¡¬t
*8;

891 
	`addR•lyLÚgLÚg
(
c
,
pos
);

893 
	}
}

905 
	sb™f›ldOp
 {

906 
ušt64_t
 
	moff£t
;

907 
št64_t
 
	mi64
;

908 
	mİcode
;

909 
	mowty³
;

910 
	mb™s
;

911 
	msign
;

914 
	$b™f›ldCommªd
(
ş›Á
 *
c
) {

915 
robj
 *
o
;

916 
size_t
 
b™off£t
;

917 
j
, 
numİs
 = 0, 
chªges
 = 0;

918 
b™f›ldOp
 *
İs
 = 
NULL
;

919 
owty³
 = 
BFOVERFLOW_WRAP
;

920 
»adÚly
 = 1;

921 
size_t
 
hige¡_wr™e_off£t
 = 0;

923 
j
 = 2; j < 
c
->
¬gc
; j++) {

924 
»m¬gs
 = 
c
->
¬gc
-
j
-1;

925 *
subcmd
 = 
c
->
¬gv
[
j
]->
±r
;

926 
İcode
;

927 
i64
 = 0;

928 
sign
 = 0;

929 
b™s
 = 0;

931 ià(!
	`¡rÿ£cmp
(
subcmd
,"g‘"è&& 
»m¬gs
 >= 2)

932 
İcode
 = 
BITFIELDOP_GET
;

933 ià(!
	`¡rÿ£cmp
(
subcmd
,"£t"è&& 
»m¬gs
 >= 3)

934 
İcode
 = 
BITFIELDOP_SET
;

935 ià(!
	`¡rÿ£cmp
(
subcmd
,"šüby"è&& 
»m¬gs
 >= 3)

936 
İcode
 = 
BITFIELDOP_INCRBY
;

937 ià(!
	`¡rÿ£cmp
(
subcmd
,"ov”æow"è&& 
»m¬gs
 >= 1) {

938 *
owty³Çme
 = 
c
->
¬gv
[
j
+1]->
±r
;

939 
j
++;

940 ià(!
	`¡rÿ£cmp
(
owty³Çme
,"wrap"))

941 
owty³
 = 
BFOVERFLOW_WRAP
;

942 ià(!
	`¡rÿ£cmp
(
owty³Çme
,"sat"))

943 
owty³
 = 
BFOVERFLOW_SAT
;

944 ià(!
	`¡rÿ£cmp
(
owty³Çme
,"fail"))

945 
owty³
 = 
BFOVERFLOW_FAIL
;

947 
	`addR•lyE¼Ü
(
c
,"Invalid OVERFLOWype specified");

948 
	`zä“
(
İs
);

953 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

954 
	`zä“
(
İs
);

959 ià(
	`g‘B™f›ldTy³FromArgum’t
(
c
,c->
¬gv
[
j
+1],&
sign
,&
b™s
è!ğ
C_OK
) {

960 
	`zä“
(
İs
);

964 ià(
	`g‘B™Off£tFromArgum’t
(
c
,c->
¬gv
[
j
+2],&
b™off£t
,1,
b™s
è!ğ
C_OK
){

965 
	`zä“
(
İs
);

969 ià(
İcode
 !ğ
BITFIELDOP_GET
) {

970 
»adÚly
 = 0;

971 ià(
hige¡_wr™e_off£t
 < 
b™off£t
 + 
b™s
 - 1)

972 
hige¡_wr™e_off£t
 = 
b™off£t
 + 
b™s
 - 1;

974 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[
j
+3],&
i64
,
NULL
è!ğ
C_OK
){

975 
	`zä“
(
İs
);

981 
İs
 = 
	`z»®loc
(İs,(*İs)*(
numİs
+1));

982 
İs
[
numİs
].
off£t
 = 
b™off£t
;

983 
İs
[
numİs
].
i64
 = i64;

984 
İs
[
numİs
].
İcode
 = opcode;

985 
İs
[
numİs
].
owty³
 = owtype;

986 
İs
[
numİs
].
b™s
 = bits;

987 
İs
[
numİs
].
sign
 = sign;

988 
numİs
++;

990 
j
 +ğ3 - (
İcode
 =ğ
BITFIELDOP_GET
);

993 ià(
»adÚly
) {

996 
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[1]);

997 ià(
o
 !ğ
NULL
 && 
	`checkTy³
(
c
,o,
OBJ_STRING
)) ;

1001 ià((
o
 = 
	`lookupSŒšgFÜB™Commªd
(
c
,

1002 
hige¡_wr™e_off£t
)è=ğ
NULL
) ;

1005 
	`addR•lyMuÉiBulkL’
(
c
,
numİs
);

1008 
j
 = 0; j < 
numİs
; j++) {

1009 
b™f›ldOp
 *
thisİ
 = 
İs
+
j
;

1012 ià(
thisİ
->
İcode
 =ğ
BITFIELDOP_SET
 ||

1013 
thisİ
->
İcode
 =ğ
BITFIELDOP_INCRBY
)

1022 ià(
thisİ
->
sign
) {

1023 
št64_t
 
Şdv®
, 
Ãwv®
, 
w¿µed
, 
»tv®
;

1024 
ov”æow
;

1026 
Şdv®
 = 
	`g‘SigÃdB™f›ld
(
o
->
±r
,
thisİ
->
off£t
,

1027 
thisİ
->
b™s
);

1029 ià(
thisİ
->
İcode
 =ğ
BITFIELDOP_INCRBY
) {

1030 
Ãwv®
 = 
Şdv®
 + 
thisİ
->
i64
;

1031 
ov”æow
 = 
	`checkSigÃdB™f›ldOv”æow
(
Şdv®
,

1032 
thisİ
->
i64
,thisİ->
b™s
,thisİ->
owty³
,&
w¿µed
);

1033 ià(
ov”æow
è
Ãwv®
 = 
w¿µed
;

1034 
»tv®
 = 
Ãwv®
;

1036 
Ãwv®
 = 
thisİ
->
i64
;

1037 
ov”æow
 = 
	`checkSigÃdB™f›ldOv”æow
(
Ãwv®
,

1038 0,
thisİ
->
b™s
,thisİ->
owty³
,&
w¿µed
);

1039 ià(
ov”æow
è
Ãwv®
 = 
w¿µed
;

1040 
»tv®
 = 
Şdv®
;

1045 ià(!(
ov”æow
 && 
thisİ
->
owty³
 =ğ
BFOVERFLOW_FAIL
)) {

1046 
	`addR•lyLÚgLÚg
(
c
,
»tv®
);

1047 
	`£tSigÃdB™f›ld
(
o
->
±r
,
thisİ
->
off£t
,

1048 
thisİ
->
b™s
,
Ãwv®
);

1050 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

1053 
ušt64_t
 
Şdv®
, 
Ãwv®
, 
w¿µed
, 
»tv®
;

1054 
ov”æow
;

1056 
Şdv®
 = 
	`g‘UnsigÃdB™f›ld
(
o
->
±r
,
thisİ
->
off£t
,

1057 
thisİ
->
b™s
);

1059 ià(
thisİ
->
İcode
 =ğ
BITFIELDOP_INCRBY
) {

1060 
Ãwv®
 = 
Şdv®
 + 
thisİ
->
i64
;

1061 
ov”æow
 = 
	`checkUnsigÃdB™f›ldOv”æow
(
Şdv®
,

1062 
thisİ
->
i64
,thisİ->
b™s
,thisİ->
owty³
,&
w¿µed
);

1063 ià(
ov”æow
è
Ãwv®
 = 
w¿µed
;

1064 
»tv®
 = 
Ãwv®
;

1066 
Ãwv®
 = 
thisİ
->
i64
;

1067 
ov”æow
 = 
	`checkUnsigÃdB™f›ldOv”æow
(
Ãwv®
,

1068 0,
thisİ
->
b™s
,thisİ->
owty³
,&
w¿µed
);

1069 ià(
ov”æow
è
Ãwv®
 = 
w¿µed
;

1070 
»tv®
 = 
Şdv®
;

1074 ià(!(
ov”æow
 && 
thisİ
->
owty³
 =ğ
BFOVERFLOW_FAIL
)) {

1075 
	`addR•lyLÚgLÚg
(
c
,
»tv®
);

1076 
	`£tUnsigÃdB™f›ld
(
o
->
±r
,
thisİ
->
off£t
,

1077 
thisİ
->
b™s
,
Ãwv®
);

1079 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

1082 
chªges
++;

1085 
buf
[9];

1086 
¡¾’
 = 0;

1087 *
¤c
 = 
NULL
;

1088 
Îbuf
[
LONG_STR_SIZE
];

1090 ià(
o
 !ğ
NULL
)

1091 
¤c
 = 
	`g‘ObjeùR—dOÆySŒšg
(
o
,&
¡¾’
,
Îbuf
);

1097 
	`mem£t
(
buf
,0,9);

1098 
i
;

1099 
size_t
 
by‹
 = 
thisİ
->
off£t
 >> 3;

1100 
i
 = 0; i < 9; i++) {

1101 ià(
¤c
 =ğ
NULL
 || 
i
+
by‹
 >ğ(
size_t
)
¡¾’
) ;

1102 
buf
[
i
] = 
¤c
[i+
by‹
];

1107 ià(
thisİ
->
sign
) {

1108 
št64_t
 
v®
 = 
	`g‘SigÃdB™f›ld
(
buf
,
thisİ
->
off£t
-(
by‹
*8),

1109 
thisİ
->
b™s
);

1110 
	`addR•lyLÚgLÚg
(
c
,
v®
);

1112 
ušt64_t
 
v®
 = 
	`g‘UnsigÃdB™f›ld
(
buf
,
thisİ
->
off£t
-(
by‹
*8),

1113 
thisİ
->
b™s
);

1114 
	`addR•lyLÚgLÚg
(
c
,
v®
);

1119 ià(
chªges
) {

1120 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

1121 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£tb™",
c
->
¬gv
[1],c->
db
->
id
);

1122 
£rv”
.
dœty
 +ğ
chªges
;

1124 
	`zä“
(
İs
);

1125 
	}
}

	@blocked.c

66 
	~"£rv”.h
"

76 
	$g‘TimeoutFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
objeù
, 
m¡ime_t
 *
timeout
, 
un™
) {

77 
tv®
;

79 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,
objeù
,&
tv®
,

80 "timeouˆi nÙ‡Àš‹g” o¸ouˆoà¿nge"è!ğ
C_OK
)

81  
C_ERR
;

83 ià(
tv®
 < 0) {

84 
	`addR•lyE¼Ü
(
c
,"timeout is‚egative");

85  
C_ERR
;

88 ià(
tv®
 > 0) {

89 ià(
un™
 =ğ
UNIT_SECONDS
è
tv®
 *= 1000;

90 
tv®
 +ğ
	`m¡ime
();

92 *
timeout
 = 
tv®
;

94  
C_OK
;

95 
	}
}

100 
	$blockCl›Á
(
ş›Á
 *
c
, 
bty³
) {

101 
c
->
æags
 |ğ
CLIENT_BLOCKED
;

102 
c
->
bty³
 = btype;

103 
£rv”
.
bpİ_blocked_ş›Ás
++;

104 
	}
}

109 
	$´oûssUnblockedCl›Ás
() {

110 
li¡Node
 *
Ê
;

111 
ş›Á
 *
c
;

113 
	`li¡L’gth
(
£rv”
.
unblocked_ş›Ás
)) {

114 
Ê
 = 
	`li¡Fœ¡
(
£rv”
.
unblocked_ş›Ás
);

115 
	`£rv”As£¹
(
Ê
 !ğ
NULL
);

116 
c
 = 
Ê
->
v®ue
;

117 
	`li¡D–Node
(
£rv”
.
unblocked_ş›Ás
,
Ê
);

118 
c
->
æags
 &ğ~
CLIENT_UNBLOCKED
;

124 ià(!(
c
->
æags
 & 
CLIENT_BLOCKED
)) {

125 ià(
c
->
qu”ybuf
 && 
	`sd¦’
(c->querybuf) > 0) {

126 
	`´oûssIÅutBufãr
(
c
);

130 
	}
}

134 
	$unblockCl›Á
(
ş›Á
 *
c
) {

135 ià(
c
->
bty³
 =ğ
BLOCKED_LIST
) {

136 
	`unblockCl›ÁWa™šgD©a
(
c
);

137 } ià(
c
->
bty³
 =ğ
BLOCKED_WAIT
) {

138 
	`unblockCl›ÁWa™šgR•liÿs
(
c
);

139 } ià(
c
->
bty³
 =ğ
BLOCKED_MODULE
) {

140 
	`unblockCl›ÁFromModuË
(
c
);

142 
	`£rv”Pªic
("Unknown btype in unblockClient().");

146 
c
->
æags
 &ğ~
CLIENT_BLOCKED
;

147 
c
->
bty³
 = 
BLOCKED_NONE
;

148 
£rv”
.
bpİ_blocked_ş›Ás
--;

151 ià(!(
c
->
æags
 & 
CLIENT_UNBLOCKED
)) {

152 
c
->
æags
 |ğ
CLIENT_UNBLOCKED
;

153 
	`li¡AddNodeTa
(
£rv”
.
unblocked_ş›Ás
,
c
);

155 
	}
}

160 
	$»¶yToBlockedCl›ÁTimedOut
(
ş›Á
 *
c
) {

161 ià(
c
->
bty³
 =ğ
BLOCKED_LIST
) {

162 
	`addR•ly
(
c
,
sh¬ed
.
nuÎmuÉibulk
);

163 } ià(
c
->
bty³
 =ğ
BLOCKED_WAIT
) {

164 
	`addR•lyLÚgLÚg
(
c
,
	`»¶iÿtiÚCouÁAcksByOff£t
(c->
bpİ
.
»¶off£t
));

165 } ià(
c
->
bty³
 =ğ
BLOCKED_MODULE
) {

166 
	`moduËBlockedCl›ÁTimedOut
(
c
);

168 
	`£rv”Pªic
("Unknown btype in„eplyToBlockedClientTimedOut().");

170 
	}
}

179 
	$discÚÃùAÎBlockedCl›Ás
() {

180 
li¡Node
 *
Ê
;

181 
li¡I‹r
 
li
;

183 
	`li¡Rewšd
(
£rv”
.
ş›Ás
,&
li
);

184 (
Ê
 = 
	`li¡Next
(&
li
))) {

185 
ş›Á
 *
c
 = 
	`li¡NodeV®ue
(
Ê
);

187 ià(
c
->
æags
 & 
CLIENT_BLOCKED
) {

188 
	`addR•lySds
(
c
,
	`sd¢ew
(

191 
	`unblockCl›Á
(
c
);

192 
c
->
æags
 |ğ
CLIENT_CLOSE_AFTER_REPLY
;

195 
	}
}

	@childinfo.c

30 
	~"£rv”.h
"

31 
	~<uni¡d.h
>

36 
	$İ’ChdInfoPe
() {

37 ià(
	`pe
(
£rv”
.
chd_šfo_pe
) == -1) {

40 
	`şo£ChdInfoPe
();

41 } ià(
	`ª‘NÚBlock
(
NULL
,
£rv”
.
chd_šfo_pe
[0]è!ğ
ANET_OK
) {

42 
	`şo£ChdInfoPe
();

44 
	`mem£t
(&
£rv”
.
chd_šfo_d©a
,0,(server.child_info_data));

46 
	}
}

49 
	$şo£ChdInfoPe
() {

50 ià(
£rv”
.
chd_šfo_pe
[0] != -1 ||

51 
£rv”
.
chd_šfo_pe
[1] != -1)

53 
	`şo£
(
£rv”
.
chd_šfo_pe
[0]);

54 
	`şo£
(
£rv”
.
chd_šfo_pe
[1]);

55 
£rv”
.
chd_šfo_pe
[0] = -1;

56 
£rv”
.
chd_šfo_pe
[1] = -1;

58 
	}
}

62 
	$£ndChdInfo
(
±y³
) {

63 ià(
£rv”
.
chd_šfo_pe
[1] == -1) ;

64 
£rv”
.
chd_šfo_d©a
.
magic
 = 
CHILD_INFO_MAGIC
;

65 
£rv”
.
chd_šfo_d©a
.
´oûss_ty³
 = 
±y³
;

66 
ssize_t
 
wËn
 = (
£rv”
.
chd_šfo_d©a
);

67 ià(
	`wr™e
(
£rv”
.
chd_šfo_pe
[1],&£rv”.
chd_šfo_d©a
,
wËn
) != wlen) {

70 
	}
}

73 
	$»ûiveChdInfo
() {

74 ià(
£rv”
.
chd_šfo_pe
[0] == -1) ;

75 
ssize_t
 
wËn
 = (
£rv”
.
chd_šfo_d©a
);

76 ià(
	`»ad
(
£rv”
.
chd_šfo_pe
[0],&£rv”.
chd_šfo_d©a
,
wËn
) == wlen &&

77 
£rv”
.
chd_šfo_d©a
.
magic
 =ğ
CHILD_INFO_MAGIC
)

79 ià(
£rv”
.
chd_šfo_d©a
.
´oûss_ty³
 =ğ
CHILD_INFO_TYPE_RDB
) {

80 
£rv”
.
¡©_rdb_cow_by‹s
 = s”v”.
chd_šfo_d©a
.
cow_size
;

81 } ià(
£rv”
.
chd_šfo_d©a
.
´oûss_ty³
 =ğ
CHILD_INFO_TYPE_AOF
) {

82 
£rv”
.
¡©_aof_cow_by‹s
 = s”v”.
chd_šfo_d©a
.
cow_size
;

85 
	}
}

	@cluster.c

31 
	~"£rv”.h
"

32 
	~"şu¡”.h
"

33 
	~"’dŸncÚv.h
"

35 
	~<sys/ty³s.h
>

36 
	~<sys/sock‘.h
>

37 
	~<¬·/š‘.h
>

38 
	~<fú.h
>

39 
	~<uni¡d.h
>

40 
	~<sys/¡©.h
>

41 
	~<sys/fe.h
>

42 
	~<m©h.h
>

47 
şu¡”Node
 *
	gmy£lf
 = 
NULL
;

49 
şu¡”Node
 *
ü—‹Clu¡”Node
(*
nod’ame
, 
æags
);

50 
şu¡”AddNode
(
şu¡”Node
 *
node
);

51 
şu¡”Acû±HªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

52 
şu¡”R—dHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

53 
şu¡”S’dPšg
(
şu¡”Lšk
 *
lšk
, 
ty³
);

54 
şu¡”S’dFa
(*
nod’ame
);

55 
şu¡”S’dFaov”AuthIfN“ded
(
şu¡”Node
 *
node
, 
şu¡”Msg
 *
»que¡
);

56 
şu¡”Upd©eS‹
();

57 
şu¡”NodeG‘SlÙB™
(
şu¡”Node
 *
n
, 
¦Ù
);

58 
sds
 
şu¡”G’NodesDesütiÚ
(
f‹r
);

59 
şu¡”Node
 *
şu¡”LookupNode
(*
Çme
);

60 
şu¡”NodeAddSÏve
(
şu¡”Node
 *
ma¡”
, clu¡”Nod*
¦ave
);

61 
şu¡”AddSlÙ
(
şu¡”Node
 *
n
, 
¦Ù
);

62 
şu¡”D–SlÙ
(
¦Ù
);

63 
şu¡”D–NodeSlÙs
(
şu¡”Node
 *
node
);

64 
şu¡”NodeS‘SlÙB™
(
şu¡”Node
 *
n
, 
¦Ù
);

65 
şu¡”S‘Ma¡”
(
şu¡”Node
 *
n
);

66 
şu¡”HªdËSÏveFaov”
();

67 
şu¡”HªdËSÏveMig¿tiÚ
(
max_¦aves
);

68 
b™m­Te¡B™
(*
b™m­
, 
pos
);

69 
şu¡”DoBefÜeSË•
(
æags
);

70 
şu¡”S’dUpd©e
(
şu¡”Lšk
 *
lšk
, 
şu¡”Node
 *
node
);

71 
»£tMªu®Faov”
();

72 
şu¡”Clo£AÎSlÙs
();

73 
şu¡”S‘NodeAsMa¡”
(
şu¡”Node
 *
n
);

74 
şu¡”D–Node
(
şu¡”Node
 *
d–node
);

75 
sds
 
»´e£ÁClu¡”NodeFÏgs
(sd 
ci
, 
ušt16_t
 
æags
);

76 
ušt64_t
 
şu¡”G‘MaxEpoch
();

77 
şu¡”BumpCÚfigEpochW™houtCÚ£nsus
();

89 
	$şu¡”LßdCÚfig
(*
f’ame
) {

90 
FILE
 *
å
 = 
	`fİ’
(
f’ame
,"r");

91 
¡©
 
sb
;

92 *
lše
;

93 
maxlše
, 
j
;

95 ià(
å
 =ğ
NULL
) {

96 ià(
”ºo
 =ğ
ENOENT
) {

97  
C_ERR
;

99 
	`£rv”Log
(
LL_WARNING
,

101 
f’ame
, 
	`¡»¼Ü
(
”ºo
));

102 
	`ex™
(1);

108 ià(
	`f¡©
(
	`f’o
(
å
),&
sb
è!ğ-1 && sb.
¡_size
 == 0) {

109 
	`fşo£
(
å
);

110  
C_ERR
;

120 
maxlše
 = 1024+
CLUSTER_SLOTS
*128;

121 
lše
 = 
	`zm®loc
(
maxlše
);

122 
	`fg‘s
(
lše
,
maxlše
,
å
è!ğ
NULL
) {

123 
¬gc
;

124 
sds
 *
¬gv
;

125 
şu¡”Node
 *
n
, *
ma¡”
;

126 *
p
, *
s
;

131 ià(
lše
[0] == '\n' ||†ine[0] == '\0') ;

134 
¬gv
 = 
	`sds¥l™¬gs
(
lše
,&
¬gc
);

135 ià(
¬gv
 =ğ
NULL
è
fm‹¼
;

139 ià(
	`¡rÿ£cmp
(
¬gv
[0],"vars") == 0) {

140 
j
 = 1; j < 
¬gc
; j += 2) {

141 ià(
	`¡rÿ£cmp
(
¬gv
[
j
],"currentEpoch") == 0) {

142 
£rv”
.
şu¡”
->
cu¼’tEpoch
 =

143 
	`¡¹ouÎ
(
¬gv
[
j
+1],
NULL
,10);

144 } ià(
	`¡rÿ£cmp
(
¬gv
[
j
],"lastVoteEpoch") == 0) {

145 
£rv”
.
şu¡”
->
Ï¡VÙeEpoch
 =

146 
	`¡¹ouÎ
(
¬gv
[
j
+1],
NULL
,10);

148 
	`£rv”Log
(
LL_WARNING
,

150 
¬gv
[
j
]);

153 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

158 ià(
¬gc
 < 8è
fm‹¼
;

161 
n
 = 
	`şu¡”LookupNode
(
¬gv
[0]);

162 ià(!
n
) {

163 
n
 = 
	`ü—‹Clu¡”Node
(
¬gv
[0],0);

164 
	`şu¡”AddNode
(
n
);

167 ià((
p
 = 
	`¡¼chr
(
¬gv
[1],':')è=ğ
NULL
è
fm‹¼
;

168 *
p
 = '\0';

169 
	`memıy
(
n
->

,
¬gv
[1],
	`¡¾’
(argv[1])+1);

170 *
pÜt
 = 
p
+1;

171 *
bu¥
 = 
	`¡rchr
(
pÜt
,'@');

172 ià(
bu¥
) {

173 *
bu¥
 = '\0';

174 
bu¥
++;

176 
n
->
pÜt
 = 
	`©oi
(port);

180 
n
->
ıÜt
 = 
bu¥
 ? 
	`©oi
(bu¥è:‚->
pÜt
 + 
CLUSTER_PORT_INCR
;

183 
p
 = 
s
 = 
¬gv
[2];

184 
p
) {

185 
p
 = 
	`¡rchr
(
s
,',');

186 ià(
p
) *p = '\0';

187 ià(!
	`¡rÿ£cmp
(
s
,"myself")) {

188 
	`£rv”As£¹
(
£rv”
.
şu¡”
->
my£lf
 =ğ
NULL
);

189 
my£lf
 = 
£rv”
.
şu¡”
->my£làğ
n
;

190 
n
->
æags
 |ğ
CLUSTER_NODE_MYSELF
;

191 } ià(!
	`¡rÿ£cmp
(
s
,"master")) {

192 
n
->
æags
 |ğ
CLUSTER_NODE_MASTER
;

193 } ià(!
	`¡rÿ£cmp
(
s
,"slave")) {

194 
n
->
æags
 |ğ
CLUSTER_NODE_SLAVE
;

195 } ià(!
	`¡rÿ£cmp
(
s
,"fail?")) {

196 
n
->
æags
 |ğ
CLUSTER_NODE_PFAIL
;

197 } ià(!
	`¡rÿ£cmp
(
s
,"fail")) {

198 
n
->
æags
 |ğ
CLUSTER_NODE_FAIL
;

199 
n
->
ç_time
 = 
	`m¡ime
();

200 } ià(!
	`¡rÿ£cmp
(
s
,"handshake")) {

201 
n
->
æags
 |ğ
CLUSTER_NODE_HANDSHAKE
;

202 } ià(!
	`¡rÿ£cmp
(
s
,"noaddr")) {

203 
n
->
æags
 |ğ
CLUSTER_NODE_NOADDR
;

204 } ià(!
	`¡rÿ£cmp
(
s
,"noflags")) {

207 
	`£rv”Pªic
("Unknown flag in„edis cluster config file");

209 ià(
p
è
s
 =…+1;

214 ià(
¬gv
[3][0] != '-') {

215 
ma¡”
 = 
	`şu¡”LookupNode
(
¬gv
[3]);

216 ià(!
ma¡”
) {

217 
ma¡”
 = 
	`ü—‹Clu¡”Node
(
¬gv
[3],0);

218 
	`şu¡”AddNode
(
ma¡”
);

220 
n
->
¦aveof
 = 
ma¡”
;

221 
	`şu¡”NodeAddSÏve
(
ma¡”
,
n
);

225 ià(
	`©oi
(
¬gv
[4])è
n
->
pšg_£Á
 = 
	`m¡ime
();

226 ià(
	`©oi
(
¬gv
[5])è
n
->
pÚg_»ûived
 = 
	`m¡ime
();

229 
n
->
cÚfigEpoch
 = 
	`¡¹ouÎ
(
¬gv
[6],
NULL
,10);

232 
j
 = 8; j < 
¬gc
; j++) {

233 
¡¬t
, 
¡İ
;

235 ià(
¬gv
[
j
][0] == '[') {

237 
¦Ù
;

238 
dœeùiÚ
;

239 
şu¡”Node
 *
ú
;

241 
p
 = 
	`¡rchr
(
¬gv
[
j
],'-');

242 
	`£rv”As£¹
(
p
 !ğ
NULL
);

243 *
p
 = '\0';

244 
dœeùiÚ
 = 
p
[1];

245 
¦Ù
 = 
	`©oi
(
¬gv
[
j
]+1);

246 
p
 += 3;

247 
ú
 = 
	`şu¡”LookupNode
(
p
);

248 ià(!
ú
) {

249 
ú
 = 
	`ü—‹Clu¡”Node
(
p
,0);

250 
	`şu¡”AddNode
(
ú
);

252 ià(
dœeùiÚ
 == '>') {

253 
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
¦Ù
] = 
ú
;

255 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
¦Ù
] = 
ú
;

258 } ià((
p
 = 
	`¡rchr
(
¬gv
[
j
],'-')è!ğ
NULL
) {

259 *
p
 = '\0';

260 
¡¬t
 = 
	`©oi
(
¬gv
[
j
]);

261 
¡İ
 = 
	`©oi
(
p
+1);

263 
¡¬t
 = 
¡İ
 = 
	`©oi
(
¬gv
[
j
]);

265 
¡¬t
 <ğ
¡İ
è
	`şu¡”AddSlÙ
(
n
, start++);

268 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

271 ià(
£rv”
.
şu¡”
->
my£lf
 =ğ
NULL
è
fm‹¼
;

273 
	`zä“
(
lše
);

274 
	`fşo£
(
å
);

276 
	`£rv”Log
(
LL_NOTICE
,"NodcÚfigu¿tiÚ†ßded, I'm %.40s", 
my£lf
->
Çme
);

281 ià(
	`şu¡”G‘MaxEpoch
(è> 
£rv”
.
şu¡”
->
cu¼’tEpoch
) {

282 
£rv”
.
şu¡”
->
cu¼’tEpoch
 = 
	`şu¡”G‘MaxEpoch
();

284  
C_OK
;

286 
fm‹¼
:

287 
	`£rv”Log
(
LL_WARNING
,

289 
	`zä“
(
lše
);

290 ià(
å
è
	`fşo£
(fp);

291 
	`ex™
(1);

292 
	}
}

306 
	$şu¡”SaveCÚfig
(
do_fsync
) {

307 
sds
 
ci
;

308 
size_t
 
cÚ‹Á_size
;

309 
¡©
 
sb
;

310 
fd
;

312 
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 &ğ~
CLUSTER_TODO_SAVE_CONFIG
;

316 
ci
 = 
	`şu¡”G’NodesDesütiÚ
(
CLUSTER_NODE_HANDSHAKE
);

317 
ci
 = 
	`sdsÿrštf
(ci,"vars currentEpoch %llu†astVoteEpoch %llu\n",

318 (è
£rv”
.
şu¡”
->
cu¼’tEpoch
,

319 (è
£rv”
.
şu¡”
->
Ï¡VÙeEpoch
);

320 
cÚ‹Á_size
 = 
	`sd¦’
(
ci
);

322 ià((
fd
 = 
	`İ’
(
£rv”
.
şu¡”_cÚfigfe
,
O_WRONLY
|
O_CREAT
,0644))

323 =ğ-1è
”r
;

326 ià(
	`f¡©
(
fd
,&
sb
) != -1) {

327 ià(
sb
.
¡_size
 > (
off_t
)
cÚ‹Á_size
) {

328 
ci
 = 
	`sdsgrowz”o
(ci,
sb
.
¡_size
);

329 
	`mem£t
(
ci
+
cÚ‹Á_size
,'\n',
sb
.
¡_size
-content_size);

332 ià(
	`wr™e
(
fd
,
ci
,
	`sd¦’
(ci)è!ğ(
ssize_t
)sd¦’(ci)è
”r
;

333 ià(
do_fsync
) {

334 
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 &ğ~
CLUSTER_TODO_FSYNC_CONFIG
;

335 
	`fsync
(
fd
);

340 ià(
cÚ‹Á_size
 !ğ
	`sd¦’
(
ci
è&& 
	`árunÿ‹
(
fd
,content_size) == -1) {

343 
	`şo£
(
fd
);

344 
	`sdsä“
(
ci
);

347 
”r
:

348 ià(
fd
 !ğ-1è
	`şo£
(fd);

349 
	`sdsä“
(
ci
);

351 
	}
}

353 
	$şu¡”SaveCÚfigOrD›
(
do_fsync
) {

354 ià(
	`şu¡”SaveCÚfig
(
do_fsync
) == -1) {

355 
	`£rv”Log
(
LL_WARNING
,"Fatal: can't update cluster config file.");

356 
	`ex™
(1);

358 
	}
}

369 
	$şu¡”LockCÚfig
(*
f’ame
) {

374 #ià!
	`defšed
(
__sun
)

378 
fd
 = 
	`İ’
(
f’ame
,
O_WRONLY
|
O_CREAT
,0644);

379 ià(
fd
 == -1) {

380 
	`£rv”Log
(
LL_WARNING
,

382 
f’ame
, 
	`¡»¼Ü
(
”ºo
));

383  
C_ERR
;

386 ià(
	`æock
(
fd
,
LOCK_EX
|
LOCK_NB
) == -1) {

387 ià(
”ºo
 =ğ
EWOULDBLOCK
) {

388 
	`£rv”Log
(
LL_WARNING
,

392 "fes.", 
f’ame
);

394 
	`£rv”Log
(
LL_WARNING
,

395 "ImpossibËØlock %s: %s", 
f’ame
, 
	`¡»¼Ü
(
”ºo
));

397 
	`şo£
(
fd
);

398  
C_ERR
;

404  
C_OK
;

405 
	}
}

407 
	$şu¡”In™
() {

408 
§vecÚf
 = 0;

410 
£rv”
.
şu¡”
 = 
	`zm®loc
((
şu¡”S‹
));

411 
£rv”
.
şu¡”
->
my£lf
 = 
NULL
;

412 
£rv”
.
şu¡”
->
cu¼’tEpoch
 = 0;

413 
£rv”
.
şu¡”
->
¡©e
 = 
CLUSTER_FAIL
;

414 
£rv”
.
şu¡”
->
size
 = 1;

415 
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 = 0;

416 
£rv”
.
şu¡”
->
nodes
 = 
	`diùC»©e
(&
şu¡”NodesDiùTy³
,
NULL
);

417 
£rv”
.
şu¡”
->
nodes_bÏck_li¡
 =

418 
	`diùC»©e
(&
şu¡”NodesBÏckLi¡DiùTy³
,
NULL
);

419 
£rv”
.
şu¡”
->
çov”_auth_time
 = 0;

420 
£rv”
.
şu¡”
->
çov”_auth_couÁ
 = 0;

421 
£rv”
.
şu¡”
->
çov”_auth_¿nk
 = 0;

422 
£rv”
.
şu¡”
->
çov”_auth_•och
 = 0;

423 
£rv”
.
şu¡”
->
ÿÁ_çov”_»asÚ
 = 
CLUSTER_CANT_FAILOVER_NONE
;

424 
£rv”
.
şu¡”
->
Ï¡VÙeEpoch
 = 0;

425 
i
 = 0; i < 
CLUSTERMSG_TYPE_COUNT
; i++) {

426 
£rv”
.
şu¡”
->
¡©s_bus_mes§ges_£Á
[
i
] = 0;

427 
£rv”
.
şu¡”
->
¡©s_bus_mes§ges_»ûived
[
i
] = 0;

429 
£rv”
.
şu¡”
->
¡©s_pç_nodes
 = 0;

430 
	`mem£t
(
£rv”
.
şu¡”
->
¦Ùs
,0, (server.cluster->slots));

431 
	`şu¡”Clo£AÎSlÙs
();

435 ià(
	`şu¡”LockCÚfig
(
£rv”
.
şu¡”_cÚfigfe
è=ğ
C_ERR
)

436 
	`ex™
(1);

439 ià(
	`şu¡”LßdCÚfig
(
£rv”
.
şu¡”_cÚfigfe
è=ğ
C_ERR
) {

442 
my£lf
 = 
£rv”
.
şu¡”
->myself =

443 
	`ü—‹Clu¡”Node
(
NULL
,
CLUSTER_NODE_MYSELF
|
CLUSTER_NODE_MASTER
);

444 
	`£rv”Log
(
LL_NOTICE
,"No cluster configuration found, I'm %.40s",

445 
my£lf
->
Çme
);

446 
	`şu¡”AddNode
(
my£lf
);

447 
§vecÚf
 = 1;

449 ià(
§vecÚf
è
	`şu¡”SaveCÚfigOrD›
(1);

452 
£rv”
.
cfd_couÁ
 = 0;

457 ià(
£rv”
.
pÜt
 > (65535-
CLUSTER_PORT_INCR
)) {

458 
	`£rv”Log
(
LL_WARNING
, "Redis…ort‚umberoo high. "

463 
	`ex™
(1);

466 ià(
	`li¡’ToPÜt
(
£rv”
.
pÜt
+
CLUSTER_PORT_INCR
,

467 
£rv”
.
cfd
,&£rv”.
cfd_couÁ
è=ğ
C_ERR
)

469 
	`ex™
(1);

471 
j
;

473 
j
 = 0; j < 
£rv”
.
cfd_couÁ
; j++) {

474 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
, s”v”.
cfd
[
j
], 
AE_READABLE
,

475 
şu¡”Acû±HªdËr
, 
NULL
è=ğ
AE_ERR
)

476 
	`£rv”Pªic
("Unrecoverableƒrror creating Redis Cluster "

482 
£rv”
.
şu¡”
->
¦Ùs_to_keys
 = 
	`¿xNew
();

483 
	`mem£t
(
£rv”
.
şu¡”
->
¦Ùs_keys_couÁ
,0,

484 (
£rv”
.
şu¡”
->
¦Ùs_keys_couÁ
));

488 
my£lf
->
pÜt
 = 
£rv”
.port;

489 
my£lf
->
ıÜt
 = 
£rv”
.
pÜt
+
CLUSTER_PORT_INCR
;

490 ià(
£rv”
.
şu¡”_ªnounû_pÜt
)

491 
my£lf
->
pÜt
 = 
£rv”
.
şu¡”_ªnounû_pÜt
;

492 ià(
£rv”
.
şu¡”_ªnounû_bus_pÜt
)

493 
my£lf
->
ıÜt
 = 
£rv”
.
şu¡”_ªnounû_bus_pÜt
;

495 
£rv”
.
şu¡”
->
mf_’d
 = 0;

496 
	`»£tMªu®Faov”
();

497 
	}
}

508 
	$şu¡”Re£t
(
h¬d
) {

509 
diùI‹¿tÜ
 *
di
;

510 
diùEÁry
 *
de
;

511 
j
;

514 ià(
	`nodeIsSÏve
(
my£lf
)) {

515 
	`şu¡”S‘NodeAsMa¡”
(
my£lf
);

516 
	`»¶iÿtiÚUn£tMa¡”
();

517 
	`em±yDb
(-1,
EMPTYDB_NO_FLAGS
,
NULL
);

521 
	`şu¡”Clo£AÎSlÙs
();

522 
	`»£tMªu®Faov”
();

525 
j
 = 0; j < 
CLUSTER_SLOTS
; j++è
	`şu¡”D–SlÙ
(j);

528 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

529 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

530 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

532 ià(
node
 =ğ
my£lf
) ;

533 
	`şu¡”D–Node
(
node
);

535 
	`diùR–—£I‹¿tÜ
(
di
);

538 ià(
h¬d
) {

539 
sds
 
ŞdÇme
;

541 
£rv”
.
şu¡”
->
cu¼’tEpoch
 = 0;

542 
£rv”
.
şu¡”
->
Ï¡VÙeEpoch
 = 0;

543 
my£lf
->
cÚfigEpoch
 = 0;

544 
	`£rv”Log
(
LL_WARNING
, "configEpoch seto 0 via CLUSTER RESET HARD");

548 
ŞdÇme
 = 
	`sd¢ewËn
(
my£lf
->
Çme
, 
CLUSTER_NAMELEN
);

549 
	`diùD–‘e
(
£rv”
.
şu¡”
->
nodes
,
ŞdÇme
);

550 
	`sdsä“
(
ŞdÇme
);

551 
	`g‘RªdomHexCh¬s
(
my£lf
->
Çme
, 
CLUSTER_NAMELEN
);

552 
	`şu¡”AddNode
(
my£lf
);

553 
	`£rv”Log
(
LL_NOTICE
,"Nodh¬d„e£t,‚ow I'm %.40s", 
my£lf
->
Çme
);

557 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

558 
CLUSTER_TODO_UPDATE_STATE
|

559 
CLUSTER_TODO_FSYNC_CONFIG
);

560 
	}
}

566 
şu¡”Lšk
 *
	$ü—‹Clu¡”Lšk
(
şu¡”Node
 *
node
) {

567 
şu¡”Lšk
 *
lšk
 = 
	`zm®loc
((*link));

568 
lšk
->
ùime
 = 
	`m¡ime
();

569 
lšk
->
¢dbuf
 = 
	`sd£m±y
();

570 
lšk
->
rcvbuf
 = 
	`sd£m±y
();

571 
lšk
->
node
 =‚ode;

572 
lšk
->
fd
 = -1;

573  
lšk
;

574 
	}
}

579 
	$ä“Clu¡”Lšk
(
şu¡”Lšk
 *
lšk
) {

580 ià(
lšk
->
fd
 != -1) {

581 
	`«D–‘eFeEv’t
(
£rv”
.
–
, 
lšk
->
fd
, 
AE_WRITABLE
);

582 
	`«D–‘eFeEv’t
(
£rv”
.
–
, 
lšk
->
fd
, 
AE_READABLE
);

584 
	`sdsä“
(
lšk
->
¢dbuf
);

585 
	`sdsä“
(
lšk
->
rcvbuf
);

586 ià(
lšk
->
node
)

587 
lšk
->
node
->lšk = 
NULL
;

588 
	`şo£
(
lšk
->
fd
);

589 
	`zä“
(
lšk
);

590 
	}
}

592 
	#MAX_CLUSTER_ACCEPTS_PER_CALL
 1000

	)

593 
	$şu¡”Acû±HªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

594 
ıÜt
, 
cfd
;

595 
max
 = 
MAX_CLUSTER_ACCEPTS_PER_CALL
;

596 
c
[
NET_IP_STR_LEN
];

597 
şu¡”Lšk
 *
lšk
;

598 
	`UNUSED
(
–
);

599 
	`UNUSED
(
mask
);

600 
	`UNUSED
(
´ivd©a
);

604 ià(
£rv”
.
ma¡”ho¡
 =ğ
NULL
 && s”v”.
lßdšg
) ;

606 
max
--) {

607 
cfd
 = 
	`ª‘TıAcû±
(
£rv”
.
Ã‹¼
, 
fd
, 
c
, (c), &
ıÜt
);

608 ià(
cfd
 =ğ
ANET_ERR
) {

609 ià(
”ºo
 !ğ
EWOULDBLOCK
)

610 
	`£rv”Log
(
LL_VERBOSE
,

611 "E¼Ü‡cû±šg clu¡”‚ode: %s", 
£rv”
.
Ã‹¼
);

614 
	`ª‘NÚBlock
(
NULL
,
cfd
);

615 
	`ª‘EÇbËTıNoD–ay
(
NULL
,
cfd
);

618 
	`£rv”Log
(
LL_VERBOSE
,"Acû±ed clu¡”‚od%s:%d", 
c
, 
ıÜt
);

624 
lšk
 = 
	`ü—‹Clu¡”Lšk
(
NULL
);

625 
lšk
->
fd
 = 
cfd
;

626 
	`«C»©eFeEv’t
(
£rv”
.
–
,
cfd
,
AE_READABLE
,
şu¡”R—dHªdËr
,
lšk
);

628 
	}
}

640 
	$keyHashSlÙ
(*
key
, 
keyËn
) {

641 
s
, 
e
;

643 
s
 = 0; s < 
keyËn
; s++)

644 ià(
key
[
s
] == '{') ;

647 ià(
s
 =ğ
keyËn
è 
	`üc16
(
key
,keylen) & 0x3FFF;

650 
e
 = 
s
+1;ƒ < 
keyËn
;ƒ++)

651 ià(
key
[
e
] == '}') ;

654 ià(
e
 =ğ
keyËn
 ||ƒ =ğ
s
+1è 
	`üc16
(
key
,keylen) & 0x3FFF;

658  
	`üc16
(
key
+
s
+1,
e
-s-1) & 0x3FFF;

659 
	}
}

672 
şu¡”Node
 *
	$ü—‹Clu¡”Node
(*
nod’ame
, 
æags
) {

673 
şu¡”Node
 *
node
 = 
	`zm®loc
((*node));

675 ià(
nod’ame
)

676 
	`memıy
(
node
->
Çme
, 
nod’ame
, 
CLUSTER_NAMELEN
);

678 
	`g‘RªdomHexCh¬s
(
node
->
Çme
, 
CLUSTER_NAMELEN
);

679 
node
->
ùime
 = 
	`m¡ime
();

680 
node
->
cÚfigEpoch
 = 0;

681 
node
->
æags
 = flags;

682 
	`mem£t
(
node
->
¦Ùs
,0,(node->slots));

683 
node
->
num¦Ùs
 = 0;

684 
node
->
num¦aves
 = 0;

685 
node
->
¦aves
 = 
NULL
;

686 
node
->
¦aveof
 = 
NULL
;

687 
node
->
pšg_£Á
 =‚ode->
pÚg_»ûived
 = 0;

688 
node
->
ç_time
 = 0;

689 
node
->
lšk
 = 
NULL
;

690 
	`mem£t
(
node
->

,0,(node->ip));

691 
node
->
pÜt
 = 0;

692 
node
->
ıÜt
 = 0;

693 
node
->
ç_»pÜts
 = 
	`li¡C»©e
();

694 
node
->
vÙed_time
 = 0;

695 
node
->
Üphªed_time
 = 0;

696 
node
->
»¶_off£t_time
 = 0;

697 
node
->
»¶_off£t
 = 0;

698 
	`li¡S‘F»eM‘hod
(
node
->
ç_»pÜts
,
zä“
);

699  
node
;

700 
	}
}

712 
	$şu¡”NodeAddFau»R•Üt
(
şu¡”Node
 *
çšg
, clu¡”Nod*
£nd”
) {

713 
li¡
 *
l
 = 
çšg
->
ç_»pÜts
;

714 
li¡Node
 *
Ê
;

715 
li¡I‹r
 
li
;

716 
şu¡”NodeFaR•Üt
 *
ä
;

720 
	`li¡Rewšd
(
l
,&
li
);

721 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

722 
ä
 = 
Ê
->
v®ue
;

723 ià(
ä
->
node
 =ğ
£nd”
) {

724 
ä
->
time
 = 
	`m¡ime
();

730 
ä
 = 
	`zm®loc
((*fr));

731 
ä
->
node
 = 
£nd”
;

732 
ä
->
time
 = 
	`m¡ime
();

733 
	`li¡AddNodeTa
(
l
,
ä
);

735 
	}
}

742 
	$şu¡”NodeCËªupFau»R•Üts
(
şu¡”Node
 *
node
) {

743 
li¡
 *
l
 = 
node
->
ç_»pÜts
;

744 
li¡Node
 *
Ê
;

745 
li¡I‹r
 
li
;

746 
şu¡”NodeFaR•Üt
 *
ä
;

747 
m¡ime_t
 
maxtime
 = 
£rv”
.
şu¡”_node_timeout
 *

748 
CLUSTER_FAIL_REPORT_VALIDITY_MULT
;

749 
m¡ime_t
 
now
 = 
	`m¡ime
();

751 
	`li¡Rewšd
(
l
,&
li
);

752 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

753 
ä
 = 
Ê
->
v®ue
;

754 ià(
now
 - 
ä
->
time
 > 
maxtime
è
	`li¡D–Node
(
l
,
Ê
);

756 
	}
}

769 
	$şu¡”NodeD–Fau»R•Üt
(
şu¡”Node
 *
node
, clu¡”Nod*
£nd”
) {

770 
li¡
 *
l
 = 
node
->
ç_»pÜts
;

771 
li¡Node
 *
Ê
;

772 
li¡I‹r
 
li
;

773 
şu¡”NodeFaR•Üt
 *
ä
;

776 
	`li¡Rewšd
(
l
,&
li
);

777 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

778 
ä
 = 
Ê
->
v®ue
;

779 ià(
ä
->
node
 =ğ
£nd”
) ;

781 ià(!
Ê
)  0;

784 
	`li¡D–Node
(
l
,
Ê
);

785 
	`şu¡”NodeCËªupFau»R•Üts
(
node
);

787 
	}
}

792 
	$şu¡”NodeFau»R•ÜtsCouÁ
(
şu¡”Node
 *
node
) {

793 
	`şu¡”NodeCËªupFau»R•Üts
(
node
);

794  
	`li¡L’gth
(
node
->
ç_»pÜts
);

795 
	}
}

797 
	$şu¡”NodeRemoveSÏve
(
şu¡”Node
 *
ma¡”
, clu¡”Nod*
¦ave
) {

798 
j
;

800 
j
 = 0; j < 
ma¡”
->
num¦aves
; j++) {

801 ià(
ma¡”
->
¦aves
[
j
] =ğ
¦ave
) {

802 ià((
j
+1è< 
ma¡”
->
num¦aves
) {

803 
»maššg_¦aves
 = (
ma¡”
->
num¦aves
 - 
j
) - 1;

804 
	`memmove
(
ma¡”
->
¦aves
+
j
,master->slaves+(j+1),

805 ((*
ma¡”
->
¦aves
è* 
»maššg_¦aves
));

807 
ma¡”
->
num¦aves
--;

808 ià(
ma¡”
->
num¦aves
 == 0)

809 
ma¡”
->
æags
 &ğ~
CLUSTER_NODE_MIGRATE_TO
;

810  
C_OK
;

813  
C_ERR
;

814 
	}
}

816 
	$şu¡”NodeAddSÏve
(
şu¡”Node
 *
ma¡”
, clu¡”Nod*
¦ave
) {

817 
j
;

820 
j
 = 0; j < 
ma¡”
->
num¦aves
; j++)

821 ià(
ma¡”
->
¦aves
[
j
] =ğ
¦ave
è 
C_ERR
;

822 
ma¡”
->
¦aves
 = 
	`z»®loc
(master->slaves,

823 (
şu¡”Node
*)*(
ma¡”
->
num¦aves
+1));

824 
ma¡”
->
¦aves
[ma¡”->
num¦aves
] = 
¦ave
;

825 
ma¡”
->
num¦aves
++;

826 
ma¡”
->
æags
 |ğ
CLUSTER_NODE_MIGRATE_TO
;

827  
C_OK
;

828 
	}
}

830 
	$şu¡”CouÁNÚFašgSÏves
(
şu¡”Node
 *
n
) {

831 
j
, 
ok¦aves
 = 0;

833 
j
 = 0; j < 
n
->
num¦aves
; j++)

834 ià(!
	`nodeFaed
(
n
->
¦aves
[
j
])è
ok¦aves
++;

835  
ok¦aves
;

836 
	}
}

839 
	$ä“Clu¡”Node
(
şu¡”Node
 *
n
) {

840 
sds
 
nod’ame
;

841 
j
;

845 
j
 = 0; j < 
n
->
num¦aves
; j++)

846 
n
->
¦aves
[
j
]->
¦aveof
 = 
NULL
;

849 ià(
	`nodeIsSÏve
(
n
è&&‚->
¦aveof
è
	`şu¡”NodeRemoveSÏve
(n->slaveof,n);

852 
nod’ame
 = 
	`sd¢ewËn
(
n
->
Çme
, 
CLUSTER_NAMELEN
);

853 
	`£rv”As£¹
(
	`diùD–‘e
(
£rv”
.
şu¡”
->
nodes
,
nod’ame
è=ğ
DICT_OK
);

854 
	`sdsä“
(
nod’ame
);

857 ià(
n
->
lšk
è
	`ä“Clu¡”Lšk
(n->link);

858 
	`li¡R–—£
(
n
->
ç_»pÜts
);

859 
	`zä“
(
n
->
¦aves
);

860 
	`zä“
(
n
);

861 
	}
}

864 
	$şu¡”AddNode
(
şu¡”Node
 *
node
) {

865 
»tv®
;

867 
»tv®
 = 
	`diùAdd
(
£rv”
.
şu¡”
->
nodes
,

868 
	`sd¢ewËn
(
node
->
Çme
,
CLUSTER_NAMELEN
),‚ode);

869  (
»tv®
 =ğ
DICT_OK
è? 
C_OK
 : 
C_ERR
;

870 
	}
}

883 
	$şu¡”D–Node
(
şu¡”Node
 *
d–node
) {

884 
j
;

885 
diùI‹¿tÜ
 *
di
;

886 
diùEÁry
 *
de
;

889 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

890 ià(
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
] =ğ
d–node
)

891 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
] = 
NULL
;

892 ià(
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
j
] =ğ
d–node
)

893 
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
j
] = 
NULL
;

894 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
d–node
)

895 
	`şu¡”D–SlÙ
(
j
);

899 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

900 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

901 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

903 ià(
node
 =ğ
d–node
) ;

904 
	`şu¡”NodeD–Fau»R•Üt
(
node
,
d–node
);

906 
	`diùR–—£I‹¿tÜ
(
di
);

909 
	`ä“Clu¡”Node
(
d–node
);

910 
	}
}

913 
şu¡”Node
 *
	$şu¡”LookupNode
(*
Çme
) {

914 
sds
 
s
 = 
	`sd¢ewËn
(
Çme
, 
CLUSTER_NAMELEN
);

915 
diùEÁry
 *
de
;

917 
de
 = 
	`diùFšd
(
£rv”
.
şu¡”
->
nodes
,
s
);

918 
	`sdsä“
(
s
);

919 ià(
de
 =ğ
NULL
)  NULL;

920  
	`diùG‘V®
(
de
);

921 
	}
}

927 
	$şu¡”R’ameNode
(
şu¡”Node
 *
node
, *
ÃwÇme
) {

928 
»tv®
;

929 
sds
 
s
 = 
	`sd¢ewËn
(
node
->
Çme
, 
CLUSTER_NAMELEN
);

931 
	`£rv”Log
(
LL_DEBUG
,"Renaming‚ode %.40s into %.40s",

932 
node
->
Çme
, 
ÃwÇme
);

933 
»tv®
 = 
	`diùD–‘e
(
£rv”
.
şu¡”
->
nodes
, 
s
);

934 
	`sdsä“
(
s
);

935 
	`£rv”As£¹
(
»tv®
 =ğ
DICT_OK
);

936 
	`memıy
(
node
->
Çme
, 
ÃwÇme
, 
CLUSTER_NAMELEN
);

937 
	`şu¡”AddNode
(
node
);

938 
	}
}

946 
ušt64_t
 
	$şu¡”G‘MaxEpoch
() {

947 
ušt64_t
 
max
 = 0;

948 
diùI‹¿tÜ
 *
di
;

949 
diùEÁry
 *
de
;

951 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

952 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

953 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

954 ià(
node
->
cÚfigEpoch
 > 
max
) max =‚ode->configEpoch;

956 
	`diùR–—£I‹¿tÜ
(
di
);

957 ià(
max
 < 
£rv”
.
şu¡”
->
cu¼’tEpoch
) max = server.cluster->currentEpoch;

958  
max
;

959 
	}
}

990 
	$şu¡”BumpCÚfigEpochW™houtCÚ£nsus
() {

991 
ušt64_t
 
maxEpoch
 = 
	`şu¡”G‘MaxEpoch
();

993 ià(
my£lf
->
cÚfigEpoch
 == 0 ||

994 
my£lf
->
cÚfigEpoch
 !ğ
maxEpoch
)

996 
£rv”
.
şu¡”
->
cu¼’tEpoch
++;

997 
my£lf
->
cÚfigEpoch
 = 
£rv”
.
şu¡”
->
cu¼’tEpoch
;

998 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

999 
CLUSTER_TODO_FSYNC_CONFIG
);

1000 
	`£rv”Log
(
LL_WARNING
,

1002 (è
my£lf
->
cÚfigEpoch
);

1003  
C_OK
;

1005  
C_ERR
;

1007 
	}
}

1055 
	$şu¡”HªdËCÚfigEpochCŞlisiÚ
(
şu¡”Node
 *
£nd”
) {

1057 ià(
£nd”
->
cÚfigEpoch
 !ğ
my£lf
->configEpoch ||

1058 !
	`nodeIsMa¡”
(
£nd”
è|| !nodeIsMa¡”(
my£lf
)) ;

1060 ià(
	`memcmp
(
£nd”
->
Çme
,
my£lf
->Çme,
CLUSTER_NAMELEN
) <= 0) ;

1062 
£rv”
.
şu¡”
->
cu¼’tEpoch
++;

1063 
my£lf
->
cÚfigEpoch
 = 
£rv”
.
şu¡”
->
cu¼’tEpoch
;

1064 
	`şu¡”SaveCÚfigOrD›
(1);

1065 
	`£rv”Log
(
LL_VERBOSE
,

1068 
£nd”
->
Çme
,

1069 (è
my£lf
->
cÚfigEpoch
);

1070 
	}
}

1094 
	#CLUSTER_BLACKLIST_TTL
 60

	)

1103 
	$şu¡”BÏckli¡CËªup
() {

1104 
diùI‹¿tÜ
 *
di
;

1105 
diùEÁry
 *
de
;

1107 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes_bÏck_li¡
);

1108 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1109 
št64_t
 
expœe
 = 
	`diùG‘UnsigÃdIÁeg”V®
(
de
);

1111 ià(
expœe
 < 
£rv”
.
unixtime
)

1112 
	`diùD–‘e
(
£rv”
.
şu¡”
->
nodes_bÏck_li¡
,
	`diùG‘Key
(
de
));

1114 
	`diùR–—£I‹¿tÜ
(
di
);

1115 
	}
}

1118 
	$şu¡”BÏckli¡AddNode
(
şu¡”Node
 *
node
) {

1119 
diùEÁry
 *
de
;

1120 
sds
 
id
 = 
	`sd¢ewËn
(
node
->
Çme
,
CLUSTER_NAMELEN
);

1122 
	`şu¡”BÏckli¡CËªup
();

1123 ià(
	`diùAdd
(
£rv”
.
şu¡”
->
nodes_bÏck_li¡
,
id
,
NULL
è=ğ
DICT_OK
) {

1126 
id
 = 
	`sdsdup
(id);

1128 
de
 = 
	`diùFšd
(
£rv”
.
şu¡”
->
nodes_bÏck_li¡
,
id
);

1129 
	`diùS‘UnsigÃdIÁeg”V®
(
de
,
	`time
(
NULL
)+
CLUSTER_BLACKLIST_TTL
);

1130 
	`sdsä“
(
id
);

1131 
	}
}

1136 
	$şu¡”BÏckli¡Exi¡s
(*
nodeid
) {

1137 
sds
 
id
 = 
	`sd¢ewËn
(
nodeid
,
CLUSTER_NAMELEN
);

1138 
»tv®
;

1140 
	`şu¡”BÏckli¡CËªup
();

1141 
»tv®
 = 
	`diùFšd
(
£rv”
.
şu¡”
->
nodes_bÏck_li¡
,
id
è!ğ
NULL
;

1142 
	`sdsä“
(
id
);

1143  
»tv®
;

1144 
	}
}

1171 
	$m¬kNodeAsFašgIfN“ded
(
şu¡”Node
 *
node
) {

1172 
çu»s
;

1173 
Ãeded_quÜum
 = (
£rv”
.
şu¡”
->
size
 / 2) + 1;

1175 ià(!
	`nodeTimedOut
(
node
)) ;

1176 ià(
	`nodeFaed
(
node
)) ;

1178 
çu»s
 = 
	`şu¡”NodeFau»R•ÜtsCouÁ
(
node
);

1180 ià(
	`nodeIsMa¡”
(
my£lf
)è
çu»s
++;

1181 ià(
çu»s
 < 
Ãeded_quÜum
) ;

1183 
	`£rv”Log
(
LL_NOTICE
,

1184 "M¬kšg‚od%.40 a çšg (quÜum„—ched).", 
node
->
Çme
);

1187 
node
->
æags
 &ğ~
CLUSTER_NODE_PFAIL
;

1188 
node
->
æags
 |ğ
CLUSTER_NODE_FAIL
;

1189 
node
->
ç_time
 = 
	`m¡ime
();

1193 ià(
	`nodeIsMa¡”
(
my£lf
)è
	`şu¡”S’dFa
(
node
->
Çme
);

1194 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_UPDATE_STATE
|
CLUSTER_TODO_SAVE_CONFIG
);

1195 
	}
}

1200 
	$ş—rNodeFau»IfN“ded
(
şu¡”Node
 *
node
) {

1201 
m¡ime_t
 
now
 = 
	`m¡ime
();

1203 
	`£rv”As£¹
(
	`nodeFaed
(
node
));

1207 ià(
	`nodeIsSÏve
(
node
è||‚ode->
num¦Ùs
 == 0) {

1208 
	`£rv”Log
(
LL_NOTICE
,

1210 
node
->
Çme
,

1211 
	`nodeIsSÏve
(
node
) ? "slave" : "master without slots");

1212 
node
->
æags
 &ğ~
CLUSTER_NODE_FAIL
;

1213 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_UPDATE_STATE
|
CLUSTER_TODO_SAVE_CONFIG
);

1220 ià(
	`nodeIsMa¡”
(
node
è&&‚ode->
num¦Ùs
 > 0 &&

1221 (
now
 - 
node
->
ç_time
) >

1222 (
£rv”
.
şu¡”_node_timeout
 * 
CLUSTER_FAIL_UNDO_TIME_MULT
))

1224 
	`£rv”Log
(
LL_NOTICE
,

1226 
node
->
Çme
);

1227 
node
->
æags
 &ğ~
CLUSTER_NODE_FAIL
;

1228 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_UPDATE_STATE
|
CLUSTER_TODO_SAVE_CONFIG
);

1230 
	}
}

1235 
	$şu¡”HªdshakeInProg»ss
(*

, 
pÜt
, 
ıÜt
) {

1236 
diùI‹¿tÜ
 *
di
;

1237 
diùEÁry
 *
de
;

1239 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

1240 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1241 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

1243 ià(!
	`nodeInHªdshake
(
node
)) ;

1244 ià(!
	`¡rÿ£cmp
(
node
->

,ip) &&

1245 
node
->
pÜt
 ==…ort &&

1246 
node
->
ıÜt
 == cport) ;

1248 
	`diùR–—£I‹¿tÜ
(
di
);

1249  
de
 !ğ
NULL
;

1250 
	}
}

1259 
	$şu¡”S¹Hªdshake
(*

, 
pÜt
, 
ıÜt
) {

1260 
şu¡”Node
 *
n
;

1261 
nÜm_
[
NET_IP_STR_LEN
];

1262 
sockaddr_¡Üage
 
§
;

1265 ià(
	`š‘_±Ú
(
AF_INET
,

,

1266 &(((
sockaddr_š
 *)&
§
)->
sš_addr
)))

1268 
§
.
ss_çmy
 = 
AF_INET
;

1269 } ià(
	`š‘_±Ú
(
AF_INET6
,

,

1270 &(((
sockaddr_š6
 *)&
§
)->
sš6_addr
)))

1272 
§
.
ss_çmy
 = 
AF_INET6
;

1274 
”ºo
 = 
EINVAL
;

1279 ià(
pÜt
 <ğ0 ||…Üˆ> 65535 || 
ıÜt
 <= 0 || cport > 65535) {

1280 
”ºo
 = 
EINVAL
;

1286 
	`mem£t
(
nÜm_
,0,
NET_IP_STR_LEN
);

1287 ià(
§
.
ss_çmy
 =ğ
AF_INET
)

1288 
	`š‘_Áİ
(
AF_INET
,

1289 (*)&(((
sockaddr_š
 *)&
§
)->
sš_addr
),

1290 
nÜm_
,
NET_IP_STR_LEN
);

1292 
	`š‘_Áİ
(
AF_INET6
,

1293 (*)&(((
sockaddr_š6
 *)&
§
)->
sš6_addr
),

1294 
nÜm_
,
NET_IP_STR_LEN
);

1296 ià(
	`şu¡”HªdshakeInProg»ss
(
nÜm_
,
pÜt
,
ıÜt
)) {

1297 
”ºo
 = 
EAGAIN
;

1304 
n
 = 
	`ü—‹Clu¡”Node
(
NULL
,
CLUSTER_NODE_HANDSHAKE
|
CLUSTER_NODE_MEET
);

1305 
	`memıy
(
n
->

,
nÜm_
,(n->ip));

1306 
n
->
pÜt
 =…ort;

1307 
n
->
ıÜt
 = cport;

1308 
	`şu¡”AddNode
(
n
);

1310 
	}
}

1316 
	$şu¡”ProûssGossSeùiÚ
(
şu¡”Msg
 *
hdr
, 
şu¡”Lšk
 *
lšk
) {

1317 
ušt16_t
 
couÁ
 = 
	`Áohs
(
hdr
->count);

1318 
şu¡”MsgD©aGoss
 *
g
 = (şu¡”MsgD©aGoss*è
hdr
->
d©a
.
pšg
.
goss
;

1319 
şu¡”Node
 *
£nd”
 = 
lšk
->
node
 ?†šk->nod: 
	`şu¡”LookupNode
(
hdr
->sender);

1321 
couÁ
--) {

1322 
ušt16_t
 
æags
 = 
	`Áohs
(
g
->flags);

1323 
şu¡”Node
 *
node
;

1324 
sds
 
ci
;

1326 ià(
£rv”
.
v”bos™y
 =ğ
LL_DEBUG
) {

1327 
ci
 = 
	`»´e£ÁClu¡”NodeFÏgs
(
	`sd£m±y
(), 
æags
);

1328 
	`£rv”Log
(
LL_DEBUG
,"GOSSIP %.40s %s:%d@%d %s",

1329 
g
->
nod’ame
,

1330 
g
->

,

1331 
	`Áohs
(
g
->
pÜt
),

1332 
	`Áohs
(
g
->
ıÜt
),

1333 
ci
);

1334 
	`sdsä“
(
ci
);

1338 
node
 = 
	`şu¡”LookupNode
(
g
->
nod’ame
);

1339 ià(
node
) {

1342 ià(
£nd”
 && 
	`nodeIsMa¡”
(£nd”è&& 
node
 !ğ
my£lf
) {

1343 ià(
æags
 & (
CLUSTER_NODE_FAIL
|
CLUSTER_NODE_PFAIL
)) {

1344 ià(
	`şu¡”NodeAddFau»R•Üt
(
node
,
£nd”
)) {

1345 
	`£rv”Log
(
LL_VERBOSE
,

1347 
£nd”
->
Çme
, 
node
->name);

1349 
	`m¬kNodeAsFašgIfN“ded
(
node
);

1351 ià(
	`şu¡”NodeD–Fau»R•Üt
(
node
,
£nd”
)) {

1352 
	`£rv”Log
(
LL_VERBOSE
,

1354 
£nd”
->
Çme
, 
node
->name);

1363 ià(!(
æags
 & (
CLUSTER_NODE_FAIL
|
CLUSTER_NODE_PFAIL
)) &&

1364 
node
->
pšg_£Á
 == 0 &&

1365 
	`şu¡”NodeFau»R•ÜtsCouÁ
(
node
) == 0)

1367 
m¡ime_t
 
pÚgtime
 = 
	`Áohl
(
g
->
pÚg_»ûived
);

1368 
pÚgtime
 *= 1000;

1374 ià(
pÚgtime
 <ğ(
£rv”
.
m¡ime
+500) &&

1375 
pÚgtime
 > 
node
->
pÚg_»ûived
)

1377 
node
->
pÚg_»ûived
 = 
pÚgtime
;

1386 ià(
node
->
æags
 & (
CLUSTER_NODE_FAIL
|
CLUSTER_NODE_PFAIL
) &&

1387 !(
æags
 & 
CLUSTER_NODE_NOADDR
) &&

1388 !(
æags
 & (
CLUSTER_NODE_FAIL
|
CLUSTER_NODE_PFAIL
)) &&

1389 (
	`¡rÿ£cmp
(
node
->

,
g
->ip) ||

1390 
node
->
pÜt
 !ğ
	`Áohs
(
g
->port) ||

1391 
node
->
ıÜt
 !ğ
	`Áohs
(
g
->cport)))

1393 ià(
node
->
lšk
è
	`ä“Clu¡”Lšk
(node->link);

1394 
	`memıy
(
node
->

,
g
->,
NET_IP_STR_LEN
);

1395 
node
->
pÜt
 = 
	`Áohs
(
g
->port);

1396 
node
->
ıÜt
 = 
	`Áohs
(
g
->cport);

1397 
node
->
æags
 &ğ~
CLUSTER_NODE_NOADDR
;

1406 ià(
£nd”
 &&

1407 !(
æags
 & 
CLUSTER_NODE_NOADDR
) &&

1408 !
	`şu¡”BÏckli¡Exi¡s
(
g
->
nod’ame
))

1410 
	`şu¡”S¹Hªdshake
(
g
->

,
	`Áohs
(g->
pÜt
),Áohs(g->
ıÜt
));

1415 
g
++;

1417 
	}
}

1422 
	$nodeIp2SŒšg
(*
buf
, 
şu¡”Lšk
 *
lšk
, *
ªnounûd_
) {

1423 ià(
ªnounûd_
[0] != '\0') {

1424 
	`memıy
(
buf
,
ªnounûd_
,
NET_IP_STR_LEN
);

1425 
buf
[
NET_IP_STR_LEN
-1] = '\0';

1427 
	`ª‘P“rToSŒšg
(
lšk
->
fd
, 
buf
, 
NET_IP_STR_LEN
, 
NULL
);

1429 
	}
}

1443 
	$nodeUpd©eAdd»ssIfN“ded
(
şu¡”Node
 *
node
, 
şu¡”Lšk
 *
lšk
,

1444 
şu¡”Msg
 *
hdr
)

1446 

[
NET_IP_STR_LEN
] = {0};

1447 
pÜt
 = 
	`Áohs
(
hdr
->port);

1448 
ıÜt
 = 
	`Áohs
(
hdr
->cport);

1456 ià(
lšk
 =ğ
node
->link)  0;

1458 
	`nodeIp2SŒšg
(

,
lšk
,
hdr
->
my
);

1459 ià(
node
->
pÜt
 =ğpÜˆ&&‚ode->
ıÜt
 == cport &&

1460 
	`¡rcmp
(

,
node
->ip) == 0)  0;

1463 
	`memıy
(
node
->

,ip,(ip));

1464 
node
->
pÜt
 =…ort;

1465 
node
->
ıÜt
 = cport;

1466 ià(
node
->
lšk
è
	`ä“Clu¡”Lšk
(node->link);

1467 
node
->
æags
 &ğ~
CLUSTER_NODE_NOADDR
;

1468 
	`£rv”Log
(
LL_WARNING
,"Address updated for‚ode %.40s,‚ow %s:%d",

1469 
node
->
Çme
,‚ode->

,‚ode->
pÜt
);

1473 ià(
	`nodeIsSÏve
(
my£lf
è&& my£lf->
¦aveof
 =ğ
node
)

1474 
	`»¶iÿtiÚS‘Ma¡”
(
node
->

,‚ode->
pÜt
);

1476 
	}
}

1481 
	$şu¡”S‘NodeAsMa¡”
(
şu¡”Node
 *
n
) {

1482 ià(
	`nodeIsMa¡”
(
n
)) ;

1484 ià(
n
->
¦aveof
) {

1485 
	`şu¡”NodeRemoveSÏve
(
n
->
¦aveof
,n);

1486 ià(
n
 !ğ
my£lf
èn->
æags
 |ğ
CLUSTER_NODE_MIGRATE_TO
;

1488 
n
->
æags
 &ğ~
CLUSTER_NODE_SLAVE
;

1489 
n
->
æags
 |ğ
CLUSTER_NODE_MASTER
;

1490 
n
->
¦aveof
 = 
NULL
;

1493 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1494 
CLUSTER_TODO_UPDATE_STATE
);

1495 
	}
}

1508 
	$şu¡”Upd©eSlÙsCÚfigW™h
(
şu¡”Node
 *
£nd”
, 
ušt64_t
 
£nd”CÚfigEpoch
, *
¦Ùs
) {

1509 
j
;

1510 
şu¡”Node
 *
curma¡”
, *
Ãwma¡”
 = 
NULL
;

1518 
ušt16_t
 
dœty_¦Ùs
[
CLUSTER_SLOTS
];

1519 
dœty_¦Ùs_couÁ
 = 0;

1524 
curma¡”
 = 
	`nodeIsMa¡”
(
my£lf
è? my£là: my£lf->
¦aveof
;

1526 ià(
£nd”
 =ğ
my£lf
) {

1527 
	`£rv”Log
(
LL_WARNING
,"Discarding UPDATE message‡bout myself.");

1531 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

1532 ià(
	`b™m­Te¡B™
(
¦Ùs
,
j
)) {

1534 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
£nd”
) ;

1540 ià(
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
]) ;

1546 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
NULL
 ||

1547 
£rv”
.
şu¡”
->
¦Ùs
[
j
]->
cÚfigEpoch
 < 
£nd”CÚfigEpoch
)

1551 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
my£lf
 &&

1552 
	`couÁKeysInSlÙ
(
j
) &&

1553 
£nd”
 !ğ
my£lf
)

1555 
dœty_¦Ùs
[
dœty_¦Ùs_couÁ
] = 
j
;

1556 
dœty_¦Ùs_couÁ
++;

1559 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
curma¡”
)

1560 
Ãwma¡”
 = 
£nd”
;

1561 
	`şu¡”D–SlÙ
(
j
);

1562 
	`şu¡”AddSlÙ
(
£nd”
,
j
);

1563 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1564 
CLUSTER_TODO_UPDATE_STATE
|

1565 
CLUSTER_TODO_FSYNC_CONFIG
);

1577 ià(
Ãwma¡”
 && 
curma¡”
->
num¦Ùs
 == 0) {

1578 
	`£rv”Log
(
LL_WARNING
,

1580 "a ¨»¶iÿ oà%.40s", 
£nd”
->
Çme
);

1581 
	`şu¡”S‘Ma¡”
(
£nd”
);

1582 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1583 
CLUSTER_TODO_UPDATE_STATE
|

1584 
CLUSTER_TODO_FSYNC_CONFIG
);

1585 } ià(
dœty_¦Ùs_couÁ
) {

1593 
j
 = 0; j < 
dœty_¦Ùs_couÁ
; j++)

1594 
	`d–KeysInSlÙ
(
dœty_¦Ùs
[
j
]);

1596 
	}
}

1607 
	$şu¡”ProûssPack‘
(
şu¡”Lšk
 *
lšk
) {

1608 
şu¡”Msg
 *
hdr
 = (şu¡”Msg*è
lšk
->
rcvbuf
;

1609 
ušt32_t
 
tÙËn
 = 
	`Áohl
(
hdr
->totlen);

1610 
ušt16_t
 
ty³
 = 
	`Áohs
(
hdr
->type);

1612 ià(
ty³
 < 
CLUSTERMSG_TYPE_COUNT
)

1613 
£rv”
.
şu¡”
->
¡©s_bus_mes§ges_»ûived
[
ty³
]++;

1614 
	`£rv”Log
(
LL_DEBUG
,"--- Processing…acket ofype %d, %lu bytes",

1615 
ty³
, (è
tÙËn
);

1618 ià(
tÙËn
 < 16)  1;

1619 ià(
tÙËn
 > 
	`sd¦’
(
lšk
->
rcvbuf
))  1;

1621 ià(
	`Áohs
(
hdr
->
v”
è!ğ
CLUSTER_PROTO_VER
) {

1626 
ušt16_t
 
æags
 = 
	`Áohs
(
hdr
->flags);

1627 
ušt64_t
 
£nd”Cu¼’tEpoch
 = 0, 
£nd”CÚfigEpoch
 = 0;

1628 
şu¡”Node
 *
£nd”
;

1630 ià(
ty³
 =ğ
CLUSTERMSG_TYPE_PING
 ||y³ =ğ
CLUSTERMSG_TYPE_PONG
 ||

1631 
ty³
 =ğ
CLUSTERMSG_TYPE_MEET
)

1633 
ušt16_t
 
couÁ
 = 
	`Áohs
(
hdr
->count);

1634 
ušt32_t
 
ex¶’
;

1636 
ex¶’
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

1637 
ex¶’
 +ğ((
şu¡”MsgD©aGoss
)*
couÁ
);

1638 ià(
tÙËn
 !ğ
ex¶’
)  1;

1639 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_FAIL
) {

1640 
ušt32_t
 
ex¶’
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

1642 
ex¶’
 +ğ(
şu¡”MsgD©aFa
);

1643 ià(
tÙËn
 !ğ
ex¶’
)  1;

1644 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_PUBLISH
) {

1645 
ušt32_t
 
ex¶’
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

1647 
ex¶’
 +ğ(
şu¡”MsgD©aPublish
) -

1649 
	`Áohl
(
hdr
->
d©a
.
publish
.
msg
.
chªÃl_Ën
) +

1650 
	`Áohl
(
hdr
->
d©a
.
publish
.
msg
.
mes§ge_Ën
);

1651 ià(
tÙËn
 !ğ
ex¶’
)  1;

1652 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_FAILOVER_AUTH_REQUEST
 ||

1653 
ty³
 =ğ
CLUSTERMSG_TYPE_FAILOVER_AUTH_ACK
 ||

1654 
ty³
 =ğ
CLUSTERMSG_TYPE_MFSTART
)

1656 
ušt32_t
 
ex¶’
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

1658 ià(
tÙËn
 !ğ
ex¶’
)  1;

1659 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_UPDATE
) {

1660 
ušt32_t
 
ex¶’
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

1662 
ex¶’
 +ğ(
şu¡”MsgD©aUpd©e
);

1663 ià(
tÙËn
 !ğ
ex¶’
)  1;

1667 
£nd”
 = 
	`şu¡”LookupNode
(
hdr
->sender);

1668 ià(
£nd”
 && !
	`nodeInHªdshake
(sender)) {

1670 
£nd”Cu¼’tEpoch
 = 
	`Áohu64
(
hdr
->
cu¼’tEpoch
);

1671 
£nd”CÚfigEpoch
 = 
	`Áohu64
(
hdr
->
cÚfigEpoch
);

1672 ià(
£nd”Cu¼’tEpoch
 > 
£rv”
.
şu¡”
->
cu¼’tEpoch
)

1673 
£rv”
.
şu¡”
->
cu¼’tEpoch
 = 
£nd”Cu¼’tEpoch
;

1675 ià(
£nd”CÚfigEpoch
 > 
£nd”
->
cÚfigEpoch
) {

1676 
£nd”
->
cÚfigEpoch
 = 
£nd”CÚfigEpoch
;

1677 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1678 
CLUSTER_TODO_FSYNC_CONFIG
);

1681 
£nd”
->
»¶_off£t
 = 
	`Áohu64
(
hdr
->
off£t
);

1682 
£nd”
->
»¶_off£t_time
 = 
	`m¡ime
();

1685 ià(
£rv”
.
şu¡”
->
mf_’d
 &&

1686 
	`nodeIsSÏve
(
my£lf
) &&

1687 
my£lf
->
¦aveof
 =ğ
£nd”
 &&

1688 
hdr
->
mæags
[0] & 
CLUSTERMSG_FLAG0_PAUSED
 &&

1689 
£rv”
.
şu¡”
->
mf_ma¡”_off£t
 == 0)

1691 
£rv”
.
şu¡”
->
mf_ma¡”_off£t
 = 
£nd”
->
»¶_off£t
;

1692 
	`£rv”Log
(
LL_WARNING
,

1695 
£rv”
.
şu¡”
->
mf_ma¡”_off£t
);

1700 ià(
ty³
 =ğ
CLUSTERMSG_TYPE_PING
 ||y³ =ğ
CLUSTERMSG_TYPE_MEET
) {

1701 
	`£rv”Log
(
LL_DEBUG
,"Pšg…ack‘„eûived: %p", (*)
lšk
->
node
);

1714 ià((
ty³
 =ğ
CLUSTERMSG_TYPE_MEET
 || 
my£lf
->

[0] == '\0') &&

1715 
£rv”
.
şu¡”_ªnounû_
 =ğ
NULL
)

1717 

[
NET_IP_STR_LEN
];

1719 ià(
	`ª‘SockName
(
lšk
->
fd
,

,(),
NULL
) != -1 &&

1720 
	`¡rcmp
(

,
my£lf
->ip))

1722 
	`memıy
(
my£lf
->

,,
NET_IP_STR_LEN
);

1723 
	`£rv”Log
(
LL_WARNING
,"IP‡ddress forhis‚ode updatedo %s",

1724 
my£lf
->

);

1725 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
);

1733 ià(!
£nd”
 && 
ty³
 =ğ
CLUSTERMSG_TYPE_MEET
) {

1734 
şu¡”Node
 *
node
;

1736 
node
 = 
	`ü—‹Clu¡”Node
(
NULL
,
CLUSTER_NODE_HANDSHAKE
);

1737 
	`nodeIp2SŒšg
(
node
->

,
lšk
,
hdr
->
my
);

1738 
node
->
pÜt
 = 
	`Áohs
(
hdr
->port);

1739 
node
->
ıÜt
 = 
	`Áohs
(
hdr
->cport);

1740 
	`şu¡”AddNode
(
node
);

1741 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
);

1747 ià(!
£nd”
 && 
ty³
 =ğ
CLUSTERMSG_TYPE_MEET
)

1748 
	`şu¡”ProûssGossSeùiÚ
(
hdr
,
lšk
);

1751 
	`şu¡”S’dPšg
(
lšk
,
CLUSTERMSG_TYPE_PONG
);

1755 ià(
ty³
 =ğ
CLUSTERMSG_TYPE_PING
 ||y³ =ğ
CLUSTERMSG_TYPE_PONG
 ||

1756 
ty³
 =ğ
CLUSTERMSG_TYPE_MEET
)

1758 
	`£rv”Log
(
LL_DEBUG
,"%s…acket„eceived: %p",

1759 
ty³
 =ğ
CLUSTERMSG_TYPE_PING
 ? "ping" : "pong",

1760 (*)
lšk
->
node
);

1761 ià(
lšk
->
node
) {

1762 ià(
	`nodeInHªdshake
(
lšk
->
node
)) {

1765 ià(
£nd”
) {

1766 
	`£rv”Log
(
LL_VERBOSE
,

1768 "upd©šghadd»s iàÃeded.", 
£nd”
->
Çme
);

1769 ià(
	`nodeUpd©eAdd»ssIfN“ded
(
£nd”
,
lšk
,
hdr
))

1771 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1772 
CLUSTER_TODO_UPDATE_STATE
);

1776 
	`şu¡”D–Node
(
lšk
->
node
);

1782 
	`şu¡”R’ameNode
(
lšk
->
node
, 
hdr
->
£nd”
);

1783 
	`£rv”Log
(
LL_DEBUG
,"Handshake with‚ode %.40s completed.",

1784 
lšk
->
node
->
Çme
);

1785 
lšk
->
node
->
æags
 &ğ~
CLUSTER_NODE_HANDSHAKE
;

1786 
lšk
->
node
->
æags
 |ğæags&(
CLUSTER_NODE_MASTER
|
CLUSTER_NODE_SLAVE
);

1787 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
);

1788 } ià(
	`memcmp
(
lšk
->
node
->
Çme
,
hdr
->
£nd”
,

1789 
CLUSTER_NAMELEN
) != 0)

1794 
	`£rv”Log
(
LL_DEBUG
,"PONG contains mismatching sender ID. About‚ode %.40s‡dded %d ms‡go, having flags %d",

1795 
lšk
->
node
->
Çme
,

1796 ()(
	`m¡ime
()-(
lšk
->
node
->
ùime
)),

1797 
lšk
->
node
->
æags
);

1798 
lšk
->
node
->
æags
 |ğ
CLUSTER_NODE_NOADDR
;

1799 
lšk
->
node
->

[0] = '\0';

1800 
lšk
->
node
->
pÜt
 = 0;

1801 
lšk
->
node
->
ıÜt
 = 0;

1802 
	`ä“Clu¡”Lšk
(
lšk
);

1803 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
);

1809 ià(
£nd”
 && 
ty³
 =ğ
CLUSTERMSG_TYPE_PING
 &&

1810 !
	`nodeInHªdshake
(
£nd”
) &&

1811 
	`nodeUpd©eAdd»ssIfN“ded
(
£nd”
,
lšk
,
hdr
))

1813 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1814 
CLUSTER_TODO_UPDATE_STATE
);

1818 ià(
lšk
->
node
 && 
ty³
 =ğ
CLUSTERMSG_TYPE_PONG
) {

1819 
lšk
->
node
->
pÚg_»ûived
 = 
	`m¡ime
();

1820 
lšk
->
node
->
pšg_£Á
 = 0;

1828 ià(
	`nodeTimedOut
(
lšk
->
node
)) {

1829 
lšk
->
node
->
æags
 &ğ~
CLUSTER_NODE_PFAIL
;

1830 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1831 
CLUSTER_TODO_UPDATE_STATE
);

1832 } ià(
	`nodeFaed
(
lšk
->
node
)) {

1833 
	`ş—rNodeFau»IfN“ded
(
lšk
->
node
);

1838 ià(
£nd”
) {

1839 ià(!
	`memcmp
(
hdr
->
¦aveof
,
CLUSTER_NODE_NULL_NAME
,

1840 (
hdr
->
¦aveof
)))

1843 
	`şu¡”S‘NodeAsMa¡”
(
£nd”
);

1846 
şu¡”Node
 *
ma¡”
 = 
	`şu¡”LookupNode
(
hdr
->
¦aveof
);

1848 ià(
	`nodeIsMa¡”
(
£nd”
)) {

1850 
	`şu¡”D–NodeSlÙs
(
£nd”
);

1851 
£nd”
->
æags
 &ğ~(
CLUSTER_NODE_MASTER
|

1852 
CLUSTER_NODE_MIGRATE_TO
);

1853 
£nd”
->
æags
 |ğ
CLUSTER_NODE_SLAVE
;

1856 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1857 
CLUSTER_TODO_UPDATE_STATE
);

1861 ià(
ma¡”
 && 
£nd”
->
¦aveof
 != master) {

1862 ià(
£nd”
->
¦aveof
)

1863 
	`şu¡”NodeRemoveSÏve
(
£nd”
->
¦aveof
,sender);

1864 
	`şu¡”NodeAddSÏve
(
ma¡”
,
£nd”
);

1865 
£nd”
->
¦aveof
 = 
ma¡”
;

1868 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
);

1882 
şu¡”Node
 *
£nd”_ma¡”
 = 
NULL
;

1883 
dœty_¦Ùs
 = 0;

1885 ià(
£nd”
) {

1886 
£nd”_ma¡”
 = 
	`nodeIsMa¡”
(
£nd”
è? s’d” : s’d”->
¦aveof
;

1887 ià(
£nd”_ma¡”
) {

1888 
dœty_¦Ùs
 = 
	`memcmp
(
£nd”_ma¡”
->
¦Ùs
,

1889 
hdr
->
my¦Ùs
,(hdr->myslots)) != 0;

1896 ià(
£nd”
 && 
	`nodeIsMa¡”
(£nd”è&& 
dœty_¦Ùs
)

1897 
	`şu¡”Upd©eSlÙsCÚfigW™h
(
£nd”
,
£nd”CÚfigEpoch
,
hdr
->
my¦Ùs
);

1917 ià(
£nd”
 && 
dœty_¦Ùs
) {

1918 
j
;

1920 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

1921 ià(
	`b™m­Te¡B™
(
hdr
->
my¦Ùs
,
j
)) {

1922 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
£nd”
 ||

1923 
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
NULL
) ;

1924 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
]->
cÚfigEpoch
 >

1925 
£nd”CÚfigEpoch
)

1927 
	`£rv”Log
(
LL_VERBOSE
,

1930 
£nd”
->
Çme
, 
£rv”
.
şu¡”
->
¦Ùs
[
j
]->name);

1931 
	`şu¡”S’dUpd©e
(
£nd”
->
lšk
,

1932 
£rv”
.
şu¡”
->
¦Ùs
[
j
]);

1945 ià(
£nd”
 &&

1946 
	`nodeIsMa¡”
(
my£lf
è&&‚odeIsMa¡”(
£nd”
) &&

1947 
£nd”CÚfigEpoch
 =ğ
my£lf
->
cÚfigEpoch
)

1949 
	`şu¡”HªdËCÚfigEpochCŞlisiÚ
(
£nd”
);

1953 ià(
£nd”
è
	`şu¡”ProûssGossSeùiÚ
(
hdr
,
lšk
);

1954 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_FAIL
) {

1955 
şu¡”Node
 *
çšg
;

1957 ià(
£nd”
) {

1958 
çšg
 = 
	`şu¡”LookupNode
(
hdr
->
d©a
.
ç
.
about
.
nod’ame
);

1959 ià(
çšg
 &&

1960 !(
çšg
->
æags
 & (
CLUSTER_NODE_FAIL
|
CLUSTER_NODE_MYSELF
)))

1962 
	`£rv”Log
(
LL_NOTICE
,

1964 
hdr
->
£nd”
, hdr->
d©a
.
ç
.
about
.
nod’ame
);

1965 
çšg
->
æags
 |ğ
CLUSTER_NODE_FAIL
;

1966 
çšg
->
ç_time
 = 
	`m¡ime
();

1967 
çšg
->
æags
 &ğ~
CLUSTER_NODE_PFAIL
;

1968 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1969 
CLUSTER_TODO_UPDATE_STATE
);

1972 
	`£rv”Log
(
LL_NOTICE
,

1974 
hdr
->
£nd”
, hdr->
d©a
.
ç
.
about
.
nod’ame
);

1976 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_PUBLISH
) {

1977 
robj
 *
chªÃl
, *
mes§ge
;

1978 
ušt32_t
 
chªÃl_Ën
, 
mes§ge_Ën
;

1982 ià(
	`diùSize
(
£rv”
.
pubsub_chªÃls
) ||

1983 
	`li¡L’gth
(
£rv”
.
pubsub_·‰”ns
))

1985 
chªÃl_Ën
 = 
	`Áohl
(
hdr
->
d©a
.
publish
.
msg
.channel_len);

1986 
mes§ge_Ën
 = 
	`Áohl
(
hdr
->
d©a
.
publish
.
msg
.message_len);

1987 
chªÃl
 = 
	`ü—‹SŒšgObjeù
(

1988 (*)
hdr
->
d©a
.
publish
.
msg
.
bulk_d©a
,
chªÃl_Ën
);

1989 
mes§ge
 = 
	`ü—‹SŒšgObjeù
(

1990 (*)
hdr
->
d©a
.
publish
.
msg
.
bulk_d©a
+
chªÃl_Ën
,

1991 
mes§ge_Ën
);

1992 
	`pubsubPublishMes§ge
(
chªÃl
,
mes§ge
);

1993 
	`deüRefCouÁ
(
chªÃl
);

1994 
	`deüRefCouÁ
(
mes§ge
);

1996 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_FAILOVER_AUTH_REQUEST
) {

1997 ià(!
£nd”
)  1;

1998 
	`şu¡”S’dFaov”AuthIfN“ded
(
£nd”
,
hdr
);

1999 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_FAILOVER_AUTH_ACK
) {

2000 ià(!
£nd”
)  1;

2004 ià(
	`nodeIsMa¡”
(
£nd”
è&& s’d”->
num¦Ùs
 > 0 &&

2005 
£nd”Cu¼’tEpoch
 >ğ
£rv”
.
şu¡”
->
çov”_auth_•och
)

2007 
£rv”
.
şu¡”
->
çov”_auth_couÁ
++;

2010 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_HANDLE_FAILOVER
);

2012 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_MFSTART
) {

2015 ià(!
£nd”
 || s’d”->
¦aveof
 !ğ
my£lf
)  1;

2018 
	`»£tMªu®Faov”
();

2019 
£rv”
.
şu¡”
->
mf_’d
 = 
	`m¡ime
(è+ 
CLUSTER_MF_TIMEOUT
;

2020 
£rv”
.
şu¡”
->
mf_¦ave
 = 
£nd”
;

2021 
	`·u£Cl›Ás
(
	`m¡ime
()+(
CLUSTER_MF_TIMEOUT
*2));

2022 
	`£rv”Log
(
LL_WARNING
,"Manual failover„equested by slave %.40s.",

2023 
£nd”
->
Çme
);

2024 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_UPDATE
) {

2025 
şu¡”Node
 *
n
;

2026 
ušt64_t
 
»pÜ‹dCÚfigEpoch
 =

2027 
	`Áohu64
(
hdr
->
d©a
.
upd©e
.
nodecfg
.
cÚfigEpoch
);

2029 ià(!
£nd”
)  1;

2030 
n
 = 
	`şu¡”LookupNode
(
hdr
->
d©a
.
upd©e
.
nodecfg
.
nod’ame
);

2031 ià(!
n
)  1;

2032 ià(
n
->
cÚfigEpoch
 >ğ
»pÜ‹dCÚfigEpoch
)  1;

2035 ià(
	`nodeIsSÏve
(
n
)è
	`şu¡”S‘NodeAsMa¡”
(n);

2038 
n
->
cÚfigEpoch
 = 
»pÜ‹dCÚfigEpoch
;

2039 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

2040 
CLUSTER_TODO_FSYNC_CONFIG
);

2044 
	`şu¡”Upd©eSlÙsCÚfigW™h
(
n
,
»pÜ‹dCÚfigEpoch
,

2045 
hdr
->
d©a
.
upd©e
.
nodecfg
.
¦Ùs
);

2047 
	`£rv”Log
(
LL_WARNING
,"Reûived unknowÀ·ck‘y³: %d", 
ty³
);

2050 
	}
}

2058 
	$hªdËLškIOE¼Ü
(
şu¡”Lšk
 *
lšk
) {

2059 
	`ä“Clu¡”Lšk
(
lšk
);

2060 
	}
}

2065 
	$şu¡”Wr™eHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

2066 
şu¡”Lšk
 *
lšk
 = (şu¡”Lšk*è
´ivd©a
;

2067 
ssize_t
 
nwr™‹n
;

2068 
	`UNUSED
(
–
);

2069 
	`UNUSED
(
mask
);

2071 
nwr™‹n
 = 
	`wr™e
(
fd
, 
lšk
->
¢dbuf
, 
	`sd¦’
(link->sndbuf));

2072 ià(
nwr™‹n
 <= 0) {

2073 
	`£rv”Log
(
LL_DEBUG
,"I/Oƒrror writingo‚ode†ink: %s",

2074 
	`¡»¼Ü
(
”ºo
));

2075 
	`hªdËLškIOE¼Ü
(
lšk
);

2078 
	`sd¤ªge
(
lšk
->
¢dbuf
,
nwr™‹n
,-1);

2079 ià(
	`sd¦’
(
lšk
->
¢dbuf
) == 0)

2080 
	`«D–‘eFeEv’t
(
£rv”
.
–
, 
lšk
->
fd
, 
AE_WRITABLE
);

2081 
	}
}

2086 
	$şu¡”R—dHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

2087 
buf
[(
şu¡”Msg
)];

2088 
ssize_t
 
Ä—d
;

2089 
şu¡”Msg
 *
hdr
;

2090 
şu¡”Lšk
 *
lšk
 = (şu¡”Lšk*è
´ivd©a
;

2091 
»adËn
, 
rcvbuæ’
;

2092 
	`UNUSED
(
–
);

2093 
	`UNUSED
(
mask
);

2096 
rcvbuæ’
 = 
	`sd¦’
(
lšk
->
rcvbuf
);

2097 ià(
rcvbuæ’
 < 8) {

2100 
»adËn
 = 8 - 
rcvbuæ’
;

2103 
hdr
 = (
şu¡”Msg
*è
lšk
->
rcvbuf
;

2104 ià(
rcvbuæ’
 == 8) {

2107 ià(
	`memcmp
(
hdr
->
sig
,"RCmb",4) != 0 ||

2108 
	`Áohl
(
hdr
->
tÙËn
è< 
CLUSTERMSG_MIN_LEN
)

2110 
	`£rv”Log
(
LL_WARNING
,

2113 
	`hªdËLškIOE¼Ü
(
lšk
);

2117 
»adËn
 = 
	`Áohl
(
hdr
->
tÙËn
è- 
rcvbuæ’
;

2118 ià(
»adËn
 > (
buf
))„eadlen = (buf);

2121 
Ä—d
 = 
	`»ad
(
fd
,
buf
,
»adËn
);

2122 ià(
Ä—d
 =ğ-1 && 
”ºo
 =ğ
EAGAIN
) ;

2124 ià(
Ä—d
 <= 0) {

2126 
	`£rv”Log
(
LL_DEBUG
,"I/Oƒrror„eading from‚ode†ink: %s",

2127 (
Ä—d
 =ğ0è? "cÚÃùiÚ clo£d" : 
	`¡»¼Ü
(
”ºo
));

2128 
	`hªdËLškIOE¼Ü
(
lšk
);

2132 
lšk
->
rcvbuf
 = 
	`sdsÿ’
Öšk->rcvbuf,
buf
,
Ä—d
);

2133 
hdr
 = (
şu¡”Msg
*è
lšk
->
rcvbuf
;

2134 
rcvbuæ’
 +ğ
Ä—d
;

2138 ià(
rcvbuæ’
 >ğ8 &&„cvbuæ’ =ğ
	`Áohl
(
hdr
->
tÙËn
)) {

2139 ià(
	`şu¡”ProûssPack‘
(
lšk
)) {

2140 
	`sdsä“
(
lšk
->
rcvbuf
);

2141 
lšk
->
rcvbuf
 = 
	`sd£m±y
();

2147 
	}
}

2154 
	$şu¡”S’dMes§ge
(
şu¡”Lšk
 *
lšk
, *
msg
, 
size_t
 
msgËn
) {

2155 ià(
	`sd¦’
(
lšk
->
¢dbuf
è=ğ0 && 
msgËn
 != 0)

2156 
	`«C»©eFeEv’t
(
£rv”
.
–
,
lšk
->
fd
,
AE_WRITABLE
,

2157 
şu¡”Wr™eHªdËr
,
lšk
);

2159 
lšk
->
¢dbuf
 = 
	`sdsÿ’
Öšk->¢dbuf, 
msg
, 
msgËn
);

2162 
şu¡”Msg
 *
hdr
 = (şu¡”Msg*è
msg
;

2163 
ušt16_t
 
ty³
 = 
	`Áohs
(
hdr
->type);

2164 ià(
ty³
 < 
CLUSTERMSG_TYPE_COUNT
)

2165 
£rv”
.
şu¡”
->
¡©s_bus_mes§ges_£Á
[
ty³
]++;

2166 
	}
}

2174 
	$şu¡”Brßdÿ¡Mes§ge
(*
buf
, 
size_t
 
Ën
) {

2175 
diùI‹¿tÜ
 *
di
;

2176 
diùEÁry
 *
de
;

2178 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

2179 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2180 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

2182 ià(!
node
->
lšk
) ;

2183 ià(
node
->
æags
 & (
CLUSTER_NODE_MYSELF
|
CLUSTER_NODE_HANDSHAKE
))

2185 
	`şu¡”S’dMes§ge
(
node
->
lšk
,
buf
,
Ën
);

2187 
	`diùR–—£I‹¿tÜ
(
di
);

2188 
	}
}

2192 
	$şu¡”BudMes§geHdr
(
şu¡”Msg
 *
hdr
, 
ty³
) {

2193 
tÙËn
 = 0;

2194 
ušt64_t
 
off£t
;

2195 
şu¡”Node
 *
ma¡”
;

2201 
ma¡”
 = (
	`nodeIsSÏve
(
my£lf
è&& my£lf->
¦aveof
) ?

2202 
my£lf
->
¦aveof
 : myself;

2204 
	`mem£t
(
hdr
,0,(*hdr));

2205 
hdr
->
v”
 = 
	`htÚs
(
CLUSTER_PROTO_VER
);

2206 
hdr
->
sig
[0] = 'R';

2207 
hdr
->
sig
[1] = 'C';

2208 
hdr
->
sig
[2] = 'm';

2209 
hdr
->
sig
[3] = 'b';

2210 
hdr
->
ty³
 = 
	`htÚs
(type);

2211 
	`memıy
(
hdr
->
£nd”
,
my£lf
->
Çme
,
CLUSTER_NAMELEN
);

2216 
	`mem£t
(
hdr
->
my
,0,
NET_IP_STR_LEN
);

2217 ià(
£rv”
.
şu¡”_ªnounû_
) {

2218 
	`¡ºıy
(
hdr
->
my
,
£rv”
.
şu¡”_ªnounû_
,
NET_IP_STR_LEN
);

2219 
hdr
->
my
[
NET_IP_STR_LEN
-1] = '\0';

2223 
ªnounûd_pÜt
 = 
£rv”
.
şu¡”_ªnounû_pÜt
 ?

2224 
£rv”
.
şu¡”_ªnounû_pÜt
 : s”v”.
pÜt
;

2225 
ªnounûd_ıÜt
 = 
£rv”
.
şu¡”_ªnounû_bus_pÜt
 ?

2226 
£rv”
.
şu¡”_ªnounû_bus_pÜt
 :

2227 (
£rv”
.
pÜt
 + 
CLUSTER_PORT_INCR
);

2229 
	`memıy
(
hdr
->
my¦Ùs
,
ma¡”
->
¦Ùs
,(hdr->myslots));

2230 
	`mem£t
(
hdr
->
¦aveof
,0,
CLUSTER_NAMELEN
);

2231 ià(
my£lf
->
¦aveof
 !ğ
NULL
)

2232 
	`memıy
(
hdr
->
¦aveof
,
my£lf
->¦aveof->
Çme
, 
CLUSTER_NAMELEN
);

2233 
hdr
->
pÜt
 = 
	`htÚs
(
ªnounûd_pÜt
);

2234 
hdr
->
ıÜt
 = 
	`htÚs
(
ªnounûd_ıÜt
);

2235 
hdr
->
æags
 = 
	`htÚs
(
my£lf
->flags);

2236 
hdr
->
¡©e
 = 
£rv”
.
şu¡”
->state;

2239 
hdr
->
cu¼’tEpoch
 = 
	`htÚu64
(
£rv”
.
şu¡”
->currentEpoch);

2240 
hdr
->
cÚfigEpoch
 = 
	`htÚu64
(
ma¡”
->configEpoch);

2243 ià(
	`nodeIsSÏve
(
my£lf
))

2244 
off£t
 = 
	`»¶iÿtiÚG‘SÏveOff£t
();

2246 
off£t
 = 
£rv”
.
ma¡”_»¶_off£t
;

2247 
hdr
->
off£t
 = 
	`htÚu64
(offset);

2250 ià(
	`nodeIsMa¡”
(
my£lf
è&& 
£rv”
.
şu¡”
->
mf_’d
)

2251 
hdr
->
mæags
[0] |ğ
CLUSTERMSG_FLAG0_PAUSED
;

2255 ià(
ty³
 =ğ
CLUSTERMSG_TYPE_FAIL
) {

2256 
tÙËn
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

2257 
tÙËn
 +ğ(
şu¡”MsgD©aFa
);

2258 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_UPDATE
) {

2259 
tÙËn
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

2260 
tÙËn
 +ğ(
şu¡”MsgD©aUpd©e
);

2262 
hdr
->
tÙËn
 = 
	`htÚl
(totlen);

2264 
	}
}

2269 
	$şu¡”NodeIsInGossSeùiÚ
(
şu¡”Msg
 *
hdr
, 
couÁ
, 
şu¡”Node
 *
n
) {

2270 
j
;

2271 
j
 = 0; j < 
couÁ
; j++) {

2272 ià(
	`memcmp
(
hdr
->
d©a
.
pšg
.
goss
[
j
].
nod’ame
,
n
->
Çme
,

2273 
CLUSTER_NAMELEN
) == 0) ;

2275  
j
 !ğ
couÁ
;

2276 
	}
}

2280 
	$şu¡”S‘GossEÁry
(
şu¡”Msg
 *
hdr
, 
i
, 
şu¡”Node
 *
n
) {

2281 
şu¡”MsgD©aGoss
 *
goss
;

2282 
goss
 = &(
hdr
->
d©a
.
pšg
.goss[
i
]);

2283 
	`memıy
(
goss
->
nod’ame
,
n
->
Çme
,
CLUSTER_NAMELEN
);

2284 
goss
->
pšg_£Á
 = 
	`htÚl
(
n
->ping_sent/1000);

2285 
goss
->
pÚg_»ûived
 = 
	`htÚl
(
n
->pong_received/1000);

2286 
	`memıy
(
goss
->

,
n
->ip,(n->ip));

2287 
goss
->
pÜt
 = 
	`htÚs
(
n
->port);

2288 
goss
->
ıÜt
 = 
	`htÚs
(
n
->cport);

2289 
goss
->
æags
 = 
	`htÚs
(
n
->flags);

2290 
goss
->
nÙu£d1
 = 0;

2291 
	}
}

2295 
	$şu¡”S’dPšg
(
şu¡”Lšk
 *
lšk
, 
ty³
) {

2296 *
buf
;

2297 
şu¡”Msg
 *
hdr
;

2298 
gosscouÁ
 = 0;

2299 
wª‹d
;

2300 
tÙËn
;

2305 
äeshnodes
 = 
	`diùSize
(
£rv”
.
şu¡”
->
nodes
)-2;

2333 
wª‹d
 = 
	`æoÜ
(
	`diùSize
(
£rv”
.
şu¡”
->
nodes
)/10);

2334 ià(
wª‹d
 < 3) wanted = 3;

2335 ià(
wª‹d
 > 
äeshnodes
) wanted = freshnodes;

2339 
pç_wª‹d
 = 
£rv”
.
şu¡”
->
¡©s_pç_nodes
;

2344 
tÙËn
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

2345 
tÙËn
 +ğ((
şu¡”MsgD©aGoss
)*(
wª‹d
+
pç_wª‹d
));

2348 ià(
tÙËn
 < ()(
şu¡”Msg
))otlen = (clusterMsg);

2349 
buf
 = 
	`zÿÎoc
(
tÙËn
);

2350 
hdr
 = (
şu¡”Msg
*è
buf
;

2353 ià(
lšk
->
node
 && 
ty³
 =ğ
CLUSTERMSG_TYPE_PING
)

2354 
lšk
->
node
->
pšg_£Á
 = 
	`m¡ime
();

2355 
	`şu¡”BudMes§geHdr
(
hdr
,
ty³
);

2358 
max™”©iÚs
 = 
wª‹d
*3;

2359 
äeshnodes
 > 0 && 
gosscouÁ
 < 
wª‹d
 && 
max™”©iÚs
--) {

2360 
diùEÁry
 *
de
 = 
	`diùG‘RªdomKey
(
£rv”
.
şu¡”
->
nodes
);

2361 
şu¡”Node
 *
this
 = 
	`diùG‘V®
(
de
);

2365 ià(
this
 =ğ
my£lf
) ;

2368 ià(
this
->
æags
 & 
CLUSTER_NODE_PFAIL
) ;

2375 ià(
this
->
æags
 & (
CLUSTER_NODE_HANDSHAKE
|
CLUSTER_NODE_NOADDR
) ||

2376 (
this
->
lšk
 =ğ
NULL
 &&his->
num¦Ùs
 == 0))

2378 
äeshnodes
--;

2383 ià(
	`şu¡”NodeIsInGossSeùiÚ
(
hdr
,
gosscouÁ
,
this
)) ;

2386 
	`şu¡”S‘GossEÁry
(
hdr
,
gosscouÁ
,
this
);

2387 
äeshnodes
--;

2388 
gosscouÁ
++;

2392 ià(
pç_wª‹d
) {

2393 
diùI‹¿tÜ
 *
di
;

2394 
diùEÁry
 *
de
;

2396 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

2397 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
 && 
pç_wª‹d
 > 0) {

2398 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

2399 ià(
node
->
æags
 & 
CLUSTER_NODE_HANDSHAKE
) ;

2400 ià(
node
->
æags
 & 
CLUSTER_NODE_NOADDR
) ;

2401 ià(!(
node
->
æags
 & 
CLUSTER_NODE_PFAIL
)) ;

2402 
	`şu¡”S‘GossEÁry
(
hdr
,
gosscouÁ
,
node
);

2403 
äeshnodes
--;

2404 
gosscouÁ
++;

2408 
pç_wª‹d
--;

2410 
	`diùR–—£I‹¿tÜ
(
di
);

2415 
tÙËn
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

2416 
tÙËn
 +ğ((
şu¡”MsgD©aGoss
)*
gosscouÁ
);

2417 
hdr
->
couÁ
 = 
	`htÚs
(
gosscouÁ
);

2418 
hdr
->
tÙËn
 = 
	`htÚl
(totlen);

2419 
	`şu¡”S’dMes§ge
(
lšk
,
buf
,
tÙËn
);

2420 
	`zä“
(
buf
);

2421 
	}
}

2437 
	#CLUSTER_BROADCAST_ALL
 0

	)

2438 
	#CLUSTER_BROADCAST_LOCAL_SLAVES
 1

	)

2439 
	$şu¡”Brßdÿ¡PÚg
(
rg‘
) {

2440 
diùI‹¿tÜ
 *
di
;

2441 
diùEÁry
 *
de
;

2443 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

2444 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2445 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

2447 ià(!
node
->
lšk
) ;

2448 ià(
node
 =ğ
my£lf
 || 
	`nodeInHªdshake
(node)) ;

2449 ià(
rg‘
 =ğ
CLUSTER_BROADCAST_LOCAL_SLAVES
) {

2450 
loÿl_¦ave
 =

2451 
	`nodeIsSÏve
(
node
è&&‚ode->
¦aveof
 &&

2452 (
node
->
¦aveof
 =ğ
my£lf
 ||‚ode->slaveof == myself->slaveof);

2453 ià(!
loÿl_¦ave
) ;

2455 
	`şu¡”S’dPšg
(
node
->
lšk
,
CLUSTERMSG_TYPE_PONG
);

2457 
	`diùR–—£I‹¿tÜ
(
di
);

2458 
	}
}

2463 
	$şu¡”S’dPublish
(
şu¡”Lšk
 *
lšk
, 
robj
 *
chªÃl
,„obj *
mes§ge
) {

2464 
buf
[(
şu¡”Msg
)], *
·ylßd
;

2465 
şu¡”Msg
 *
hdr
 = (şu¡”Msg*è
buf
;

2466 
ušt32_t
 
tÙËn
;

2467 
ušt32_t
 
chªÃl_Ën
, 
mes§ge_Ën
;

2469 
chªÃl
 = 
	`g‘DecodedObjeù
(channel);

2470 
mes§ge
 = 
	`g‘DecodedObjeù
(message);

2471 
chªÃl_Ën
 = 
	`sd¦’
(
chªÃl
->
±r
);

2472 
mes§ge_Ën
 = 
	`sd¦’
(
mes§ge
->
±r
);

2474 
	`şu¡”BudMes§geHdr
(
hdr
,
CLUSTERMSG_TYPE_PUBLISH
);

2475 
tÙËn
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

2476 
tÙËn
 +ğ(
şu¡”MsgD©aPublish
è- 8 + 
chªÃl_Ën
 + 
mes§ge_Ën
;

2478 
hdr
->
d©a
.
publish
.
msg
.
chªÃl_Ën
 = 
	`htÚl
(channel_len);

2479 
hdr
->
d©a
.
publish
.
msg
.
mes§ge_Ën
 = 
	`htÚl
(message_len);

2480 
hdr
->
tÙËn
 = 
	`htÚl
(totlen);

2483 ià(
tÙËn
 < (
buf
)) {

2484 
·ylßd
 = 
buf
;

2486 
·ylßd
 = 
	`zm®loc
(
tÙËn
);

2487 
	`memıy
(
·ylßd
,
hdr
,(*hdr));

2488 
hdr
 = (
şu¡”Msg
*è
·ylßd
;

2490 
	`memıy
(
hdr
->
d©a
.
publish
.
msg
.
bulk_d©a
,
chªÃl
->
±r
,
	`sd¦’
(channel->ptr));

2491 
	`memıy
(
hdr
->
d©a
.
publish
.
msg
.
bulk_d©a
+
	`sd¦’
(
chªÃl
->
±r
),

2492 
mes§ge
->
±r
,
	`sd¦’
(message->ptr));

2494 ià(
lšk
)

2495 
	`şu¡”S’dMes§ge
(
lšk
,
·ylßd
,
tÙËn
);

2497 
	`şu¡”Brßdÿ¡Mes§ge
(
·ylßd
,
tÙËn
);

2499 
	`deüRefCouÁ
(
chªÃl
);

2500 
	`deüRefCouÁ
(
mes§ge
);

2501 ià(
·ylßd
 !ğ
buf
è
	`zä“
(payload);

2502 
	}
}

2509 
	$şu¡”S’dFa
(*
nod’ame
) {

2510 
buf
[(
şu¡”Msg
)];

2511 
şu¡”Msg
 *
hdr
 = (şu¡”Msg*è
buf
;

2513 
	`şu¡”BudMes§geHdr
(
hdr
,
CLUSTERMSG_TYPE_FAIL
);

2514 
	`memıy
(
hdr
->
d©a
.
ç
.
about
.
nod’ame
,nod’ame,
CLUSTER_NAMELEN
);

2515 
	`şu¡”Brßdÿ¡Mes§ge
(
buf
,
	`Áohl
(
hdr
->
tÙËn
));

2516 
	}
}

2521 
	$şu¡”S’dUpd©e
(
şu¡”Lšk
 *
lšk
, 
şu¡”Node
 *
node
) {

2522 
buf
[(
şu¡”Msg
)];

2523 
şu¡”Msg
 *
hdr
 = (şu¡”Msg*è
buf
;

2525 ià(
lšk
 =ğ
NULL
) ;

2526 
	`şu¡”BudMes§geHdr
(
hdr
,
CLUSTERMSG_TYPE_UPDATE
);

2527 
	`memıy
(
hdr
->
d©a
.
upd©e
.
nodecfg
.
nod’ame
,
node
->
Çme
,
CLUSTER_NAMELEN
);

2528 
hdr
->
d©a
.
upd©e
.
nodecfg
.
cÚfigEpoch
 = 
	`htÚu64
(
node
->configEpoch);

2529 
	`memıy
(
hdr
->
d©a
.
upd©e
.
nodecfg
.
¦Ùs
,
node
->slots,(node->slots));

2530 
	`şu¡”S’dMes§ge
(
lšk
,
buf
,
	`Áohl
(
hdr
->
tÙËn
));

2531 
	}
}

2540 
	$şu¡”Prİag©ePublish
(
robj
 *
chªÃl
,„obj *
mes§ge
) {

2541 
	`şu¡”S’dPublish
(
NULL
, 
chªÃl
, 
mes§ge
);

2542 
	}
}

2554 
	$şu¡”Reque¡Faov”Auth
() {

2555 
buf
[(
şu¡”Msg
)];

2556 
şu¡”Msg
 *
hdr
 = (şu¡”Msg*è
buf
;

2557 
ušt32_t
 
tÙËn
;

2559 
	`şu¡”BudMes§geHdr
(
hdr
,
CLUSTERMSG_TYPE_FAILOVER_AUTH_REQUEST
);

2563 ià(
£rv”
.
şu¡”
->
mf_’d
è
hdr
->
mæags
[0] |ğ
CLUSTERMSG_FLAG0_FORCEACK
;

2564 
tÙËn
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

2565 
hdr
->
tÙËn
 = 
	`htÚl
(totlen);

2566 
	`şu¡”Brßdÿ¡Mes§ge
(
buf
,
tÙËn
);

2567 
	}
}

2570 
	$şu¡”S’dFaov”Auth
(
şu¡”Node
 *
node
) {

2571 
buf
[(
şu¡”Msg
)];

2572 
şu¡”Msg
 *
hdr
 = (şu¡”Msg*è
buf
;

2573 
ušt32_t
 
tÙËn
;

2575 ià(!
node
->
lšk
) ;

2576 
	`şu¡”BudMes§geHdr
(
hdr
,
CLUSTERMSG_TYPE_FAILOVER_AUTH_ACK
);

2577 
tÙËn
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

2578 
hdr
->
tÙËn
 = 
	`htÚl
(totlen);

2579 
	`şu¡”S’dMes§ge
(
node
->
lšk
,
buf
,
tÙËn
);

2580 
	}
}

2583 
	$şu¡”S’dMFS¹
(
şu¡”Node
 *
node
) {

2584 
buf
[(
şu¡”Msg
)];

2585 
şu¡”Msg
 *
hdr
 = (şu¡”Msg*è
buf
;

2586 
ušt32_t
 
tÙËn
;

2588 ià(!
node
->
lšk
) ;

2589 
	`şu¡”BudMes§geHdr
(
hdr
,
CLUSTERMSG_TYPE_MFSTART
);

2590 
tÙËn
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

2591 
hdr
->
tÙËn
 = 
	`htÚl
(totlen);

2592 
	`şu¡”S’dMes§ge
(
node
->
lšk
,
buf
,
tÙËn
);

2593 
	}
}

2596 
	$şu¡”S’dFaov”AuthIfN“ded
(
şu¡”Node
 *
node
, 
şu¡”Msg
 *
»que¡
) {

2597 
şu¡”Node
 *
ma¡”
 = 
node
->
¦aveof
;

2598 
ušt64_t
 
»que¡Cu¼’tEpoch
 = 
	`Áohu64
(
»que¡
->
cu¼’tEpoch
);

2599 
ušt64_t
 
»que¡CÚfigEpoch
 = 
	`Áohu64
(
»que¡
->
cÚfigEpoch
);

2600 *
şaimed_¦Ùs
 = 
»que¡
->
my¦Ùs
;

2601 
fÜû_ack
 = 
»que¡
->
mæags
[0] & 
CLUSTERMSG_FLAG0_FORCEACK
;

2602 
j
;

2608 ià(
	`nodeIsSÏve
(
my£lf
è|| my£lf->
num¦Ùs
 == 0) ;

2614 ià(
»que¡Cu¼’tEpoch
 < 
£rv”
.
şu¡”
->
cu¼’tEpoch
) {

2615 
	`£rv”Log
(
LL_WARNING
,

2617 
node
->
Çme
,

2618 (è
»que¡Cu¼’tEpoch
,

2619 (è
£rv”
.
şu¡”
->
cu¼’tEpoch
);

2624 ià(
£rv”
.
şu¡”
->
Ï¡VÙeEpoch
 =ğ£rv”.şu¡”->
cu¼’tEpoch
) {

2625 
	`£rv”Log
(
LL_WARNING
,

2627 
node
->
Çme
,

2628 (è
£rv”
.
şu¡”
->
cu¼’tEpoch
);

2635 ià(
	`nodeIsMa¡”
(
node
è|| 
ma¡”
 =ğ
NULL
 ||

2636 (!
	`nodeFaed
(
ma¡”
è&& !
fÜû_ack
))

2638 ià(
	`nodeIsMa¡”
(
node
)) {

2639 
	`£rv”Log
(
LL_WARNING
,

2641 
node
->
Çme
);

2642 } ià(
ma¡”
 =ğ
NULL
) {

2643 
	`£rv”Log
(
LL_WARNING
,

2645 
node
->
Çme
);

2646 } ià(!
	`nodeFaed
(
ma¡”
)) {

2647 
	`£rv”Log
(
LL_WARNING
,

2649 
node
->
Çme
);

2657 ià(
	`m¡ime
(è- 
node
->
¦aveof
->
vÙed_time
 < 
£rv”
.
şu¡”_node_timeout
 * 2)

2659 
	`£rv”Log
(
LL_WARNING
,

2662 
node
->
Çme
,

2663 (è((
£rv”
.
şu¡”_node_timeout
*2)-

2664 (
	`m¡ime
(è- 
node
->
¦aveof
->
vÙed_time
)));

2671 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

2672 ià(
	`b™m­Te¡B™
(
şaimed_¦Ùs
, 
j
) == 0) ;

2673 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
NULL
 ||

2674 
£rv”
.
şu¡”
->
¦Ùs
[
j
]->
cÚfigEpoch
 <ğ
»que¡CÚfigEpoch
)

2681 
	`£rv”Log
(
LL_WARNING
,

2684 
node
->
Çme
, 
j
,

2685 (è
£rv”
.
şu¡”
->
¦Ùs
[
j
]->
cÚfigEpoch
,

2686 (è
»que¡CÚfigEpoch
);

2691 
	`şu¡”S’dFaov”Auth
(
node
);

2692 
£rv”
.
şu¡”
->
Ï¡VÙeEpoch
 = s”v”.şu¡”->
cu¼’tEpoch
;

2693 
node
->
¦aveof
->
vÙed_time
 = 
	`m¡ime
();

2694 
	`£rv”Log
(
LL_WARNING
, "Failover‡uth grantedo %.40s forƒpoch %llu",

2695 
node
->
Çme
, (è
£rv”
.
şu¡”
->
cu¼’tEpoch
);

2696 
	}
}

2710 
	$şu¡”G‘SÏveRªk
() {

2711 
myoff£t
;

2712 
j
, 
¿nk
 = 0;

2713 
şu¡”Node
 *
ma¡”
;

2715 
	`£rv”As£¹
(
	`nodeIsSÏve
(
my£lf
));

2716 
ma¡”
 = 
my£lf
->
¦aveof
;

2717 ià(
ma¡”
 =ğ
NULL
)  0;

2719 
myoff£t
 = 
	`»¶iÿtiÚG‘SÏveOff£t
();

2720 
j
 = 0; j < 
ma¡”
->
num¦aves
; j++)

2721 ià(
ma¡”
->
¦aves
[
j
] !ğ
my£lf
 &&

2722 
ma¡”
->
¦aves
[
j
]->
»¶_off£t
 > 
myoff£t
è
¿nk
++;

2723  
¿nk
;

2724 
	}
}

2748 
	$şu¡”LogCªtFaov”
(
»asÚ
) {

2749 *
msg
;

2750 
time_t
 
Ï¡log_time
 = 0;

2751 
m¡ime_t
 
nŞog_ç_time
 = 
£rv”
.
şu¡”_node_timeout
 + 5000;

2754 ià(
»asÚ
 =ğ
£rv”
.
şu¡”
->
ÿÁ_çov”_»asÚ
 &&

2755 
	`time
(
NULL
)-
Ï¡log_time
 < 
CLUSTER_CANT_FAILOVER_RELOG_PERIOD
)

2758 
£rv”
.
şu¡”
->
ÿÁ_çov”_»asÚ
 = 
»asÚ
;

2763 ià(
my£lf
->
¦aveof
 &&

2764 
	`nodeFaed
(
my£lf
->
¦aveof
) &&

2765 (
	`m¡ime
(è- 
my£lf
->
¦aveof
->
ç_time
è< 
nŞog_ç_time
) ;

2767 
»asÚ
) {

2768 
CLUSTER_CANT_FAILOVER_DATA_AGE
:

2769 
msg
 = "Disconnected from master for†ongerhan‡llowed. "

2773 
CLUSTER_CANT_FAILOVER_WAITING_DELAY
:

2774 
msg
 = "Waitinghe delay before I can start‡‚ew failover.";

2776 
CLUSTER_CANT_FAILOVER_EXPIRED
:

2777 
msg
 = "Failover‡ttemptƒxpired.";

2779 
CLUSTER_CANT_FAILOVER_WAITING_VOTES
:

2780 
msg
 = "Waiting for votes, but majority still‚ot„eached.";

2783 
msg
 = "Unknown„eason code.";

2786 
Ï¡log_time
 = 
	`time
(
NULL
);

2787 
	`£rv”Log
(
LL_WARNING
,"Cu¼’y uÇbËØçov”: %s", 
msg
);

2788 
	}
}

2796 
	$şu¡”Faov”R•ÏûYourMa¡”
() {

2797 
j
;

2798 
şu¡”Node
 *
Şdma¡”
 = 
my£lf
->
¦aveof
;

2800 ià(
	`nodeIsMa¡”
(
my£lf
è|| 
Şdma¡”
 =ğ
NULL
) ;

2803 
	`şu¡”S‘NodeAsMa¡”
(
my£lf
);

2804 
	`»¶iÿtiÚUn£tMa¡”
();

2807 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

2808 ià(
	`şu¡”NodeG‘SlÙB™
(
Şdma¡”
,
j
)) {

2809 
	`şu¡”D–SlÙ
(
j
);

2810 
	`şu¡”AddSlÙ
(
my£lf
,
j
);

2815 
	`şu¡”Upd©eS‹
();

2816 
	`şu¡”SaveCÚfigOrD›
(1);

2820 
	`şu¡”Brßdÿ¡PÚg
(
CLUSTER_BROADCAST_ALL
);

2823 
	`»£tMªu®Faov”
();

2824 
	}
}

2834 
	$şu¡”HªdËSÏveFaov”
() {

2835 
m¡ime_t
 
d©a_age
;

2836 
m¡ime_t
 
auth_age
 = 
	`m¡ime
(è- 
£rv”
.
şu¡”
->
çov”_auth_time
;

2837 
Ãeded_quÜum
 = (
£rv”
.
şu¡”
->
size
 / 2) + 1;

2838 
mªu®_çov”
 = 
£rv”
.
şu¡”
->
mf_’d
 != 0 &&

2839 
£rv”
.
şu¡”
->
mf_ÿn_¡¬t
;

2840 
m¡ime_t
 
auth_timeout
, 
auth_»Œy_time
;

2842 
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 &ğ~
CLUSTER_TODO_HANDLE_FAILOVER
;

2851 
auth_timeout
 = 
£rv”
.
şu¡”_node_timeout
*2;

2852 ià(
auth_timeout
 < 2000)‡uth_timeout = 2000;

2853 
auth_»Œy_time
 = 
auth_timeout
*2;

2860 ià(
	`nodeIsMa¡”
(
my£lf
) ||

2861 
my£lf
->
¦aveof
 =ğ
NULL
 ||

2862 (!
	`nodeFaed
(
my£lf
->
¦aveof
è&& !
mªu®_çov”
) ||

2863 
my£lf
->
¦aveof
->
num¦Ùs
 == 0)

2867 
£rv”
.
şu¡”
->
ÿÁ_çov”_»asÚ
 = 
CLUSTER_CANT_FAILOVER_NONE
;

2873 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_CONNECTED
) {

2874 
d©a_age
 = (
m¡ime_t
)(
£rv”
.
unixtime
 - s”v”.
ma¡”
->
Ï¡š‹¿ùiÚ
)

2877 
d©a_age
 = (
m¡ime_t
)(
£rv”
.
unixtime
 - s”v”.
»¶_down_sšû
) * 1000;

2883 ià(
d©a_age
 > 
£rv”
.
şu¡”_node_timeout
)

2884 
d©a_age
 -ğ
£rv”
.
şu¡”_node_timeout
;

2890 ià(
£rv”
.
şu¡”_¦ave_v®id™y_çùÜ
 &&

2891 
d©a_age
 >

2892 (((
m¡ime_t
)
£rv”
.
»¶_pšg_¦ave_³riod
 * 1000) +

2893 (
£rv”
.
şu¡”_node_timeout
 * s”v”.
şu¡”_¦ave_v®id™y_çùÜ
)))

2895 ià(!
mªu®_çov”
) {

2896 
	`şu¡”LogCªtFaov”
(
CLUSTER_CANT_FAILOVER_DATA_AGE
);

2903 ià(
auth_age
 > 
auth_»Œy_time
) {

2904 
£rv”
.
şu¡”
->
çov”_auth_time
 = 
	`m¡ime
() +

2906 
	`¿ndom
() % 500;

2907 
£rv”
.
şu¡”
->
çov”_auth_couÁ
 = 0;

2908 
£rv”
.
şu¡”
->
çov”_auth_£Á
 = 0;

2909 
£rv”
.
şu¡”
->
çov”_auth_¿nk
 = 
	`şu¡”G‘SÏveRªk
();

2913 
£rv”
.
şu¡”
->
çov”_auth_time
 +=

2914 
£rv”
.
şu¡”
->
çov”_auth_¿nk
 * 1000;

2916 ià(
£rv”
.
şu¡”
->
mf_’d
) {

2917 
£rv”
.
şu¡”
->
çov”_auth_time
 = 
	`m¡ime
();

2918 
£rv”
.
şu¡”
->
çov”_auth_¿nk
 = 0;

2920 
	`£rv”Log
(
LL_WARNING
,

2923 
£rv”
.
şu¡”
->
çov”_auth_time
 - 
	`m¡ime
(),

2924 
£rv”
.
şu¡”
->
çov”_auth_¿nk
,

2925 
	`»¶iÿtiÚG‘SÏveOff£t
());

2929 
	`şu¡”Brßdÿ¡PÚg
(
CLUSTER_BROADCAST_LOCAL_SLAVES
);

2938 ià(
£rv”
.
şu¡”
->
çov”_auth_£Á
 == 0 &&

2939 
£rv”
.
şu¡”
->
mf_’d
 == 0)

2941 
Ãw¿nk
 = 
	`şu¡”G‘SÏveRªk
();

2942 ià(
Ãw¿nk
 > 
£rv”
.
şu¡”
->
çov”_auth_¿nk
) {

2943 
added_d–ay
 =

2944 (
Ãw¿nk
 - 
£rv”
.
şu¡”
->
çov”_auth_¿nk
) * 1000;

2945 
£rv”
.
şu¡”
->
çov”_auth_time
 +ğ
added_d–ay
;

2946 
£rv”
.
şu¡”
->
çov”_auth_¿nk
 = 
Ãw¿nk
;

2947 
	`£rv”Log
(
LL_WARNING
,

2949 
Ãw¿nk
, 
added_d–ay
);

2954 ià(
	`m¡ime
(è< 
£rv”
.
şu¡”
->
çov”_auth_time
) {

2955 
	`şu¡”LogCªtFaov”
(
CLUSTER_CANT_FAILOVER_WAITING_DELAY
);

2960 ià(
auth_age
 > 
auth_timeout
) {

2961 
	`şu¡”LogCªtFaov”
(
CLUSTER_CANT_FAILOVER_EXPIRED
);

2966 ià(
£rv”
.
şu¡”
->
çov”_auth_£Á
 == 0) {

2967 
£rv”
.
şu¡”
->
cu¼’tEpoch
++;

2968 
£rv”
.
şu¡”
->
çov”_auth_•och
 = s”v”.şu¡”->
cu¼’tEpoch
;

2969 
	`£rv”Log
(
LL_WARNING
,"Starting‡ failoverƒlection forƒpoch %llu.",

2970 (è
£rv”
.
şu¡”
->
cu¼’tEpoch
);

2971 
	`şu¡”Reque¡Faov”Auth
();

2972 
£rv”
.
şu¡”
->
çov”_auth_£Á
 = 1;

2973 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

2974 
CLUSTER_TODO_UPDATE_STATE
|

2975 
CLUSTER_TODO_FSYNC_CONFIG
);

2980 ià(
£rv”
.
şu¡”
->
çov”_auth_couÁ
 >ğ
Ãeded_quÜum
) {

2983 
	`£rv”Log
(
LL_WARNING
,

2987 ià(
my£lf
->
cÚfigEpoch
 < 
£rv”
.
şu¡”
->
çov”_auth_•och
) {

2988 
my£lf
->
cÚfigEpoch
 = 
£rv”
.
şu¡”
->
çov”_auth_•och
;

2989 
	`£rv”Log
(
LL_WARNING
,

2991 (è
my£lf
->
cÚfigEpoch
);

2995 
	`şu¡”Faov”R•ÏûYourMa¡”
();

2997 
	`şu¡”LogCªtFaov”
(
CLUSTER_CANT_FAILOVER_WAITING_VOTES
);

2999 
	}
}

3028 
	$şu¡”HªdËSÏveMig¿tiÚ
(
max_¦aves
) {

3029 
j
, 
ok¦aves
 = 0;

3030 
şu¡”Node
 *
myma¡”
 = 
my£lf
->
¦aveof
, *
rg‘
 = 
NULL
, *
ÿndid©e
 = NULL;

3031 
diùI‹¿tÜ
 *
di
;

3032 
diùEÁry
 *
de
;

3035 ià(
£rv”
.
şu¡”
->
¡©e
 !ğ
CLUSTER_OK
) ;

3039 ià(
myma¡”
 =ğ
NULL
) ;

3040 
j
 = 0; j < 
myma¡”
->
num¦aves
; j++)

3041 ià(!
	`nodeFaed
(
myma¡”
->
¦aves
[
j
]) &&

3042 !
	`nodeTimedOut
(
myma¡”
->
¦aves
[
j
])è
ok¦aves
++;

3043 ià(
ok¦aves
 <ğ
£rv”
.
şu¡”_mig¿tiÚ_b¬r›r
) ;

3055 
ÿndid©e
 = 
my£lf
;

3056 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

3057 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3058 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

3059 
ok¦aves
 = 0, 
is_Üphªed
 = 1;

3065 ià(
	`nodeIsSÏve
(
node
è|| 
	`nodeFaed
Òode)è
is_Üphªed
 = 0;

3066 ià(!(
node
->
æags
 & 
CLUSTER_NODE_MIGRATE_TO
)è
is_Üphªed
 = 0;

3069 ià(
	`nodeIsMa¡”
(
node
)è
ok¦aves
 = 
	`şu¡”CouÁNÚFašgSÏves
(node);

3070 ià(
ok¦aves
 > 0è
is_Üphªed
 = 0;

3072 ià(
is_Üphªed
) {

3073 ià(!
rg‘
 && 
node
->
num¦Ùs
 > 0)arget =‚ode;

3077 ià(!
node
->
Üphªed_time
ènode->Üphªed_timğ
	`m¡ime
();

3079 
node
->
Üphªed_time
 = 0;

3085 ià(
ok¦aves
 =ğ
max_¦aves
) {

3086 
j
 = 0; j < 
node
->
num¦aves
; j++) {

3087 ià(
	`memcmp
(
node
->
¦aves
[
j
]->
Çme
,

3088 
ÿndid©e
->
Çme
,

3089 
CLUSTER_NAMELEN
) < 0)

3091 
ÿndid©e
 = 
node
->
¦aves
[
j
];

3096 
	`diùR–—£I‹¿tÜ
(
di
);

3103 ià(
rg‘
 && 
ÿndid©e
 =ğ
my£lf
 &&

3104 (
	`m¡ime
()-
rg‘
->
Üphªed_time
è> 
CLUSTER_SLAVE_MIGRATION_DELAY
)

3106 
	`£rv”Log
(
LL_WARNING
,"Migratingo orphaned master %.40s",

3107 
rg‘
->
Çme
);

3108 
	`şu¡”S‘Ma¡”
(
rg‘
);

3110 
	}
}

3146 
	$»£tMªu®Faov”
() {

3147 ià(
£rv”
.
şu¡”
->
mf_’d
 && 
	`ş›ÁsA»Pau£d
()) {

3148 
£rv”
.
ş›Ás_·u£_’d_time
 = 0;

3149 
	`ş›ÁsA»Pau£d
();

3151 
£rv”
.
şu¡”
->
mf_’d
 = 0;

3152 
£rv”
.
şu¡”
->
mf_ÿn_¡¬t
 = 0;

3153 
£rv”
.
şu¡”
->
mf_¦ave
 = 
NULL
;

3154 
£rv”
.
şu¡”
->
mf_ma¡”_off£t
 = 0;

3155 
	}
}

3158 
	$mªu®Faov”CheckTimeout
() {

3159 ià(
£rv”
.
şu¡”
->
mf_’d
 && s”v”.şu¡”->mf_’d < 
	`m¡ime
()) {

3160 
	`£rv”Log
(
LL_WARNING
,"Manual failoverimed out.");

3161 
	`»£tMªu®Faov”
();

3163 
	}
}

3167 
	$şu¡”HªdËMªu®Faov”
() {

3169 ià(
£rv”
.
şu¡”
->
mf_’d
 == 0) ;

3173 ià(
£rv”
.
şu¡”
->
mf_ÿn_¡¬t
) ;

3175 ià(
£rv”
.
şu¡”
->
mf_ma¡”_off£t
 == 0) ;

3177 ià(
£rv”
.
şu¡”
->
mf_ma¡”_off£t
 =ğ
	`»¶iÿtiÚG‘SÏveOff£t
()) {

3180 
£rv”
.
şu¡”
->
mf_ÿn_¡¬t
 = 1;

3181 
	`£rv”Log
(
LL_WARNING
,

3185 
	}
}

3192 
	$şu¡”CrÚ
() {

3193 
diùI‹¿tÜ
 *
di
;

3194 
diùEÁry
 *
de
;

3195 
upd©e_¡©e
 = 0;

3196 
Üphªed_ma¡”s
;

3197 
max_¦aves
;

3198 
this_¦aves
;

3199 
m¡ime_t
 
mš_pÚg
 = 0, 
now
 = 
	`m¡ime
();

3200 
şu¡”Node
 *
mš_pÚg_node
 = 
NULL
;

3201 
™”©iÚ
 = 0;

3202 
m¡ime_t
 
hªdshake_timeout
;

3204 
™”©iÚ
++;

3210 *
´ev_
 = 
NULL
;

3211 *
cu¼_
 = 
£rv”
.
şu¡”_ªnounû_
;

3212 
chªged
 = 0;

3214 ià(
´ev_
 =ğ
NULL
 && 
cu¼_
 !ğNULLè
chªged
 = 1;

3215 ià(
´ev_
 !ğ
NULL
 && 
cu¼_
 =ğNULLè
chªged
 = 1;

3216 ià(
´ev_
 && 
cu¼_
 && 
	`¡rcmp
Õ»v_,cu¼_)è
chªged
 = 1;

3218 ià(
chªged
) {

3219 
´ev_
 = 
cu¼_
;

3220 ià(
´ev_
è´ev_ = 
	`z¡rdup
(prev_ip);

3222 ià(
cu¼_
) {

3223 
	`¡ºıy
(
my£lf
->

,
£rv”
.
şu¡”_ªnounû_
,
NET_IP_STR_LEN
);

3224 
my£lf
->

[
NET_IP_STR_LEN
-1] = '\0';

3226 
my£lf
->

[0] = '\0';

3235 
hªdshake_timeout
 = 
£rv”
.
şu¡”_node_timeout
;

3236 ià(
hªdshake_timeout
 < 1000) handshake_timeout = 1000;

3241 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

3242 
£rv”
.
şu¡”
->
¡©s_pç_nodes
 = 0;

3243 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3244 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

3248 ià(
node
->
æags
 & (
CLUSTER_NODE_MYSELF
|
CLUSTER_NODE_NOADDR
)) ;

3250 ià(
node
->
æags
 & 
CLUSTER_NODE_PFAIL
)

3251 
£rv”
.
şu¡”
->
¡©s_pç_nodes
++;

3255 ià(
	`nodeInHªdshake
(
node
è&& 
now
 -‚ode->
ùime
 > 
hªdshake_timeout
) {

3256 
	`şu¡”D–Node
(
node
);

3260 ià(
node
->
lšk
 =ğ
NULL
) {

3261 
fd
;

3262 
m¡ime_t
 
Şd_pšg_£Á
;

3263 
şu¡”Lšk
 *
lšk
;

3265 
fd
 = 
	`ª‘TıNÚBlockBšdCÚÃù
(
£rv”
.
Ã‹¼
, 
node
->

,

3266 
node
->
ıÜt
, 
NET_FIRST_BIND_ADDR
);

3267 ià(
fd
 == -1) {

3273 ià(
node
->
pšg_£Á
 =ğ0ènode->pšg_£Á = 
	`m¡ime
();

3274 
	`£rv”Log
(
LL_DEBUG
, "Unableo connecto "

3275 "Clu¡” Nod[%s]:%d -> %s", 
node
->

,

3276 
node
->
ıÜt
, 
£rv”
.
Ã‹¼
);

3279 
lšk
 = 
	`ü—‹Clu¡”Lšk
(
node
);

3280 
lšk
->
fd
 = fd;

3281 
node
->
lšk
 =†ink;

3282 
	`«C»©eFeEv’t
(
£rv”
.
–
,
lšk
->
fd
,
AE_READABLE
,

3283 
şu¡”R—dHªdËr
,
lšk
);

3290 
Şd_pšg_£Á
 = 
node
->
pšg_£Á
;

3291 
	`şu¡”S’dPšg
(
lšk
, 
node
->
æags
 & 
CLUSTER_NODE_MEET
 ?

3292 
CLUSTERMSG_TYPE_MEET
 : 
CLUSTERMSG_TYPE_PING
);

3293 ià(
Şd_pšg_£Á
) {

3297 
node
->
pšg_£Á
 = 
Şd_pšg_£Á
;

3304 
node
->
æags
 &ğ~
CLUSTER_NODE_MEET
;

3306 
	`£rv”Log
(
LL_DEBUG
,"Connecting with Node %.40s‡t %s:%d",

3307 
node
->
Çme
,‚ode->

,‚ode->
ıÜt
);

3310 
	`diùR–—£I‹¿tÜ
(
di
);

3314 ià(!(
™”©iÚ
 % 10)) {

3315 
j
;

3319 
j
 = 0; j < 5; j++) {

3320 
de
 = 
	`diùG‘RªdomKey
(
£rv”
.
şu¡”
->
nodes
);

3321 
şu¡”Node
 *
this
 = 
	`diùG‘V®
(
de
);

3324 ià(
this
->
lšk
 =ğ
NULL
 ||his->
pšg_£Á
 != 0) ;

3325 ià(
this
->
æags
 & (
CLUSTER_NODE_MYSELF
|
CLUSTER_NODE_HANDSHAKE
))

3327 ià(
mš_pÚg_node
 =ğ
NULL
 || 
mš_pÚg
 > 
this
->
pÚg_»ûived
) {

3328 
mš_pÚg_node
 = 
this
;

3329 
mš_pÚg
 = 
this
->
pÚg_»ûived
;

3332 ià(
mš_pÚg_node
) {

3333 
	`£rv”Log
(
LL_DEBUG
,"Pšgšg‚od%.40s", 
mš_pÚg_node
->
Çme
);

3334 
	`şu¡”S’dPšg
(
mš_pÚg_node
->
lšk
, 
CLUSTERMSG_TYPE_PING
);

3344 
Üphªed_ma¡”s
 = 0;

3345 
max_¦aves
 = 0;

3346 
this_¦aves
 = 0;

3347 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

3348 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3349 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

3350 
now
 = 
	`m¡ime
();

3351 
m¡ime_t
 
d–ay
;

3353 ià(
node
->
æags
 &

3354 (
CLUSTER_NODE_MYSELF
|
CLUSTER_NODE_NOADDR
|
CLUSTER_NODE_HANDSHAKE
))

3359 ià(
	`nodeIsSÏve
(
my£lf
è&& 
	`nodeIsMa¡”
(
node
è&& !
	`nodeFaed
(node)) {

3360 
ok¦aves
 = 
	`şu¡”CouÁNÚFašgSÏves
(
node
);

3365 ià(
ok¦aves
 =ğ0 && 
node
->
num¦Ùs
 > 0 &&

3366 
node
->
æags
 & 
CLUSTER_NODE_MIGRATE_TO
)

3368 
Üphªed_ma¡”s
++;

3370 ià(
ok¦aves
 > 
max_¦aves
) max_slaves = okslaves;

3371 ià(
	`nodeIsSÏve
(
my£lf
è&& my£lf->
¦aveof
 =ğ
node
)

3372 
this_¦aves
 = 
ok¦aves
;

3378 ià(
node
->
lšk
 &&

3379 
now
 - 
node
->
lšk
->
ùime
 >

3380 
£rv”
.
şu¡”_node_timeout
 &&

3381 
node
->
pšg_£Á
 &&

3382 
node
->
pÚg_»ûived
 <‚ode->
pšg_£Á
 &&

3384 
now
 - 
node
->
pšg_£Á
 > 
£rv”
.
şu¡”_node_timeout
/2)

3387 
	`ä“Clu¡”Lšk
(
node
->
lšk
);

3394 ià(
node
->
lšk
 &&

3395 
node
->
pšg_£Á
 == 0 &&

3396 (
now
 - 
node
->
pÚg_»ûived
è> 
£rv”
.
şu¡”_node_timeout
/2)

3398 
	`şu¡”S’dPšg
(
node
->
lšk
, 
CLUSTERMSG_TYPE_PING
);

3404 ià(
£rv”
.
şu¡”
->
mf_’d
 &&

3405 
	`nodeIsMa¡”
(
my£lf
) &&

3406 
£rv”
.
şu¡”
->
mf_¦ave
 =ğ
node
 &&

3407 
node
->
lšk
)

3409 
	`şu¡”S’dPšg
(
node
->
lšk
, 
CLUSTERMSG_TYPE_PING
);

3414 ià(
node
->
pšg_£Á
 == 0) ;

3419 
d–ay
 = 
now
 - 
node
->
pšg_£Á
;

3421 ià(
d–ay
 > 
£rv”
.
şu¡”_node_timeout
) {

3424 ià(!(
node
->
æags
 & (
CLUSTER_NODE_PFAIL
|
CLUSTER_NODE_FAIL
))) {

3425 
	`£rv”Log
(
LL_DEBUG
,"*** NODE %.40s…ossibly failing",

3426 
node
->
Çme
);

3427 
node
->
æags
 |ğ
CLUSTER_NODE_PFAIL
;

3428 
upd©e_¡©e
 = 1;

3432 
	`diùR–—£I‹¿tÜ
(
di
);

3437 ià(
	`nodeIsSÏve
(
my£lf
) &&

3438 
£rv”
.
ma¡”ho¡
 =ğ
NULL
 &&

3439 
my£lf
->
¦aveof
 &&

3440 
	`nodeHasAddr
(
my£lf
->
¦aveof
))

3442 
	`»¶iÿtiÚS‘Ma¡”
(
my£lf
->
¦aveof
->

, my£lf->¦aveof->
pÜt
);

3446 
	`mªu®Faov”CheckTimeout
();

3448 ià(
	`nodeIsSÏve
(
my£lf
)) {

3449 
	`şu¡”HªdËMªu®Faov”
();

3450 
	`şu¡”HªdËSÏveFaov”
();

3456 ià(
Üphªed_ma¡”s
 && 
max_¦aves
 >ğ2 && 
this_¦aves
 == max_slaves)

3457 
	`şu¡”HªdËSÏveMig¿tiÚ
(
max_¦aves
);

3460 ià(
upd©e_¡©e
 || 
£rv”
.
şu¡”
->
¡©e
 =ğ
CLUSTER_FAIL
)

3461 
	`şu¡”Upd©eS‹
();

3462 
	}
}

3469 
	$şu¡”BefÜeSË•
() {

3472 ià(
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 & 
CLUSTER_TODO_HANDLE_FAILOVER
)

3473 
	`şu¡”HªdËSÏveFaov”
();

3476 ià(
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 & 
CLUSTER_TODO_UPDATE_STATE
)

3477 
	`şu¡”Upd©eS‹
();

3480 ià(
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 & 
CLUSTER_TODO_SAVE_CONFIG
) {

3481 
fsync
 = 
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 &

3482 
CLUSTER_TODO_FSYNC_CONFIG
;

3483 
	`şu¡”SaveCÚfigOrD›
(
fsync
);

3488 
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 = 0;

3489 
	}
}

3491 
	$şu¡”DoBefÜeSË•
(
æags
) {

3492 
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 |ğ
æags
;

3493 
	}
}

3501 
	$b™m­Te¡B™
(*
b™m­
, 
pos
) {

3502 
off_t
 
by‹
 = 
pos
/8;

3503 
b™
 = 
pos
&7;

3504  (
b™m­
[
by‹
] & (1<<
b™
)) != 0;

3505 
	}
}

3508 
	$b™m­S‘B™
(*
b™m­
, 
pos
) {

3509 
off_t
 
by‹
 = 
pos
/8;

3510 
b™
 = 
pos
&7;

3511 
b™m­
[
by‹
] |ğ1<<
b™
;

3512 
	}
}

3515 
	$b™m­CË¬B™
(*
b™m­
, 
pos
) {

3516 
off_t
 
by‹
 = 
pos
/8;

3517 
b™
 = 
pos
&7;

3518 
b™m­
[
by‹
] &ğ~(1<<
b™
);

3519 
	}
}

3524 
	$şu¡”Ma¡”sHaveSÏves
() {

3525 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

3526 
diùEÁry
 *
de
;

3527 
¦aves
 = 0;

3528 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3529 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

3531 ià(
	`nodeIsSÏve
(
node
)) ;

3532 
¦aves
 +ğ
node
->
num¦aves
;

3534 
	`diùR–—£I‹¿tÜ
(
di
);

3535  
¦aves
 != 0;

3536 
	}
}

3539 
	$şu¡”NodeS‘SlÙB™
(
şu¡”Node
 *
n
, 
¦Ù
) {

3540 
Şd
 = 
	`b™m­Te¡B™
(
n
->
¦Ùs
,
¦Ù
);

3541 
	`b™m­S‘B™
(
n
->
¦Ùs
,
¦Ù
);

3542 ià(!
Şd
) {

3543 
n
->
num¦Ùs
++;

3557 ià(
n
->
num¦Ùs
 =ğ1 && 
	`şu¡”Ma¡”sHaveSÏves
())

3558 
n
->
æags
 |ğ
CLUSTER_NODE_MIGRATE_TO
;

3560  
Şd
;

3561 
	}
}

3564 
	$şu¡”NodeCË¬SlÙB™
(
şu¡”Node
 *
n
, 
¦Ù
) {

3565 
Şd
 = 
	`b™m­Te¡B™
(
n
->
¦Ùs
,
¦Ù
);

3566 
	`b™m­CË¬B™
(
n
->
¦Ùs
,
¦Ù
);

3567 ià(
Şd
è
n
->
num¦Ùs
--;

3568  
Şd
;

3569 
	}
}

3572 
	$şu¡”NodeG‘SlÙB™
(
şu¡”Node
 *
n
, 
¦Ù
) {

3573  
	`b™m­Te¡B™
(
n
->
¦Ùs
,
¦Ù
);

3574 
	}
}

3580 
	$şu¡”AddSlÙ
(
şu¡”Node
 *
n
, 
¦Ù
) {

3581 ià(
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
]è 
C_ERR
;

3582 
	`şu¡”NodeS‘SlÙB™
(
n
,
¦Ù
);

3583 
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
] = 
n
;

3584  
C_OK
;

3585 
	}
}

3590 
	$şu¡”D–SlÙ
(
¦Ù
) {

3591 
şu¡”Node
 *
n
 = 
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
];

3593 ià(!
n
è 
C_ERR
;

3594 
	`£rv”As£¹
(
	`şu¡”NodeCË¬SlÙB™
(
n
,
¦Ù
) == 1);

3595 
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
] = 
NULL
;

3596  
C_OK
;

3597 
	}
}

3601 
	$şu¡”D–NodeSlÙs
(
şu¡”Node
 *
node
) {

3602 
d–‘ed
 = 0, 
j
;

3604 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

3605 ià(
	`şu¡”NodeG‘SlÙB™
(
node
,
j
)) {

3606 
	`şu¡”D–SlÙ
(
j
);

3607 
d–‘ed
++;

3610  
d–‘ed
;

3611 
	}
}

3615 
	$şu¡”Clo£AÎSlÙs
() {

3616 
	`mem£t
(
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
,0,

3617 (
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
));

3618 
	`mem£t
(
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
,0,

3619 (
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
));

3620 
	}
}

3630 
	#CLUSTER_MAX_REJOIN_DELAY
 5000

	)

3631 
	#CLUSTER_MIN_REJOIN_DELAY
 500

	)

3632 
	#CLUSTER_WRITABLE_DELAY
 2000

	)

3634 
	$şu¡”Upd©eS‹
() {

3635 
j
, 
Ãw_¡©e
;

3636 
»achabË_ma¡”s
 = 0;

3637 
m¡ime_t
 
amÚg_mšÜ™y_time
;

3638 
m¡ime_t
 
fœ¡_ÿÎ_time
 = 0;

3640 
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 &ğ~
CLUSTER_TODO_UPDATE_STATE
;

3648 ià(
fœ¡_ÿÎ_time
 =ğ0èfœ¡_ÿÎ_timğ
	`m¡ime
();

3649 ià(
	`nodeIsMa¡”
(
my£lf
) &&

3650 
£rv”
.
şu¡”
->
¡©e
 =ğ
CLUSTER_FAIL
 &&

3651 
	`m¡ime
(è- 
fœ¡_ÿÎ_time
 < 
CLUSTER_WRITABLE_DELAY
) ;

3655 
Ãw_¡©e
 = 
CLUSTER_OK
;

3658 ià(
£rv”
.
şu¡”_»quœe_fuÎ_cov”age
) {

3659 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

3660 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
NULL
 ||

3661 
£rv”
.
şu¡”
->
¦Ùs
[
j
]->
æags
 & (
CLUSTER_NODE_FAIL
))

3663 
Ãw_¡©e
 = 
CLUSTER_FAIL
;

3675 
diùI‹¿tÜ
 *
di
;

3676 
diùEÁry
 *
de
;

3678 
£rv”
.
şu¡”
->
size
 = 0;

3679 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

3680 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3681 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

3683 ià(
	`nodeIsMa¡”
(
node
è&&‚ode->
num¦Ùs
) {

3684 
£rv”
.
şu¡”
->
size
++;

3685 ià((
node
->
æags
 & (
CLUSTER_NODE_FAIL
|
CLUSTER_NODE_PFAIL
)) == 0)

3686 
»achabË_ma¡”s
++;

3689 
	`diùR–—£I‹¿tÜ
(
di
);

3695 
Ãeded_quÜum
 = (
£rv”
.
şu¡”
->
size
 / 2) + 1;

3697 ià(
»achabË_ma¡”s
 < 
Ãeded_quÜum
) {

3698 
Ãw_¡©e
 = 
CLUSTER_FAIL
;

3699 
amÚg_mšÜ™y_time
 = 
	`m¡ime
();

3704 ià(
Ãw_¡©e
 !ğ
£rv”
.
şu¡”
->
¡©e
) {

3705 
m¡ime_t
 
»još_d–ay
 = 
£rv”
.
şu¡”_node_timeout
;

3711 ià(
»još_d–ay
 > 
CLUSTER_MAX_REJOIN_DELAY
)

3712 
»još_d–ay
 = 
CLUSTER_MAX_REJOIN_DELAY
;

3713 ià(
»još_d–ay
 < 
CLUSTER_MIN_REJOIN_DELAY
)

3714 
»još_d–ay
 = 
CLUSTER_MIN_REJOIN_DELAY
;

3716 ià(
Ãw_¡©e
 =ğ
CLUSTER_OK
 &&

3717 
	`nodeIsMa¡”
(
my£lf
) &&

3718 
	`m¡ime
(è- 
amÚg_mšÜ™y_time
 < 
»još_d–ay
)

3724 
	`£rv”Log
(
LL_WARNING
,"Cluster state changed: %s",

3725 
Ãw_¡©e
 =ğ
CLUSTER_OK
 ? "ok" : "fail");

3726 
£rv”
.
şu¡”
->
¡©e
 = 
Ãw_¡©e
;

3728 
	}
}

3752 
	$v”ifyClu¡”CÚfigW™hD©a
() {

3753 
j
;

3754 
upd©e_cÚfig
 = 0;

3758 ià(
	`nodeIsSÏve
(
my£lf
)è 
C_OK
;

3761 
j
 = 1; j < 
£rv”
.
dbnum
; j++) {

3762 ià(
	`diùSize
(
£rv”
.
db
[
j
].
diù
)è 
C_ERR
;

3767 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

3768 ià(!
	`couÁKeysInSlÙ
(
j
)) ;

3772 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
my£lf
 ||

3773 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
] !ğ
NULL
) ;

3779 
upd©e_cÚfig
++;

3781 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
NULL
) {

3782 
	`£rv”Log
(
LL_WARNING
, "I have keys for unassigned slot %d. "

3783 "Takšg„e¥Úsib™y fÜ it.",
j
);

3784 
	`şu¡”AddSlÙ
(
my£lf
,
j
);

3786 
	`£rv”Log
(
LL_WARNING
, "I have keys for slot %d, buthe slot is "

3788 "S‘tšg iˆtØimpÜtšg s‹.",
j
);

3789 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
] = s”v”.şu¡”->
¦Ùs
[j];

3792 ià(
upd©e_cÚfig
è
	`şu¡”SaveCÚfigOrD›
(1);

3793  
C_OK
;

3794 
	}
}

3802 
	$şu¡”S‘Ma¡”
(
şu¡”Node
 *
n
) {

3803 
	`£rv”As£¹
(
n
 !ğ
my£lf
);

3804 
	`£rv”As£¹
(
my£lf
->
num¦Ùs
 == 0);

3806 ià(
	`nodeIsMa¡”
(
my£lf
)) {

3807 
my£lf
->
æags
 &ğ~(
CLUSTER_NODE_MASTER
|
CLUSTER_NODE_MIGRATE_TO
);

3808 
my£lf
->
æags
 |ğ
CLUSTER_NODE_SLAVE
;

3809 
	`şu¡”Clo£AÎSlÙs
();

3811 ià(
my£lf
->
¦aveof
)

3812 
	`şu¡”NodeRemoveSÏve
(
my£lf
->
¦aveof
,myself);

3814 
my£lf
->
¦aveof
 = 
n
;

3815 
	`şu¡”NodeAddSÏve
(
n
,
my£lf
);

3816 
	`»¶iÿtiÚS‘Ma¡”
(
n
->

,‚->
pÜt
);

3817 
	`»£tMªu®Faov”
();

3818 
	}
}

3824 
	s»disNodeFÏgs
 {

3825 
ušt16_t
 
	mæag
;

3826 *
	mÇme
;

3829 
»disNodeFÏgs
 
	g»disNodeFÏgsTabË
[] = {

3830 {
CLUSTER_NODE_MYSELF
, "myself,"},

3831 {
CLUSTER_NODE_MASTER
, "master,"},

3832 {
CLUSTER_NODE_SLAVE
, "slave,"},

3833 {
CLUSTER_NODE_PFAIL
, "fail?,"},

3834 {
CLUSTER_NODE_FAIL
, "fail,"},

3835 {
CLUSTER_NODE_HANDSHAKE
, "handshake,"},

3836 {
CLUSTER_NODE_NOADDR
, "noaddr,"}

3841 
sds
 
	$»´e£ÁClu¡”NodeFÏgs
(
sds
 
ci
, 
ušt16_t
 
æags
) {

3842 
size_t
 
Üig_Ën
 = 
	`sd¦’
(
ci
);

3843 
i
, 
size
 = (
»disNodeFÏgsTabË
)/(
»disNodeFÏgs
);

3844 
i
 = 0; i < 
size
; i++) {

3845 
»disNodeFÏgs
 *
nodeæag
 = 
»disNodeFÏgsTabË
 + 
i
;

3846 ià(
æags
 & 
nodeæag
->
æag
è
ci
 = 
	`sdsÿt
(ci,‚odeæag->
Çme
);

3849 ià(
	`sd¦’
(
ci
è=ğ
Üig_Ën
èc˜ğ
	`sdsÿt
(ci,"noflags,");

3850 
	`sdsInüL’
(
ci
,-1);

3851  
ci
;

3852 
	}
}

3858 
sds
 
	$şu¡”G’NodeDesütiÚ
(
şu¡”Node
 *
node
) {

3859 
j
, 
¡¬t
;

3860 
sds
 
ci
;

3863 
ci
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"%.40s %s:%d@%d ",

3864 
node
->
Çme
,

3865 
node
->

,

3866 
node
->
pÜt
,

3867 
node
->
ıÜt
);

3870 
ci
 = 
	`»´e£ÁClu¡”NodeFÏgs
(ci, 
node
->
æags
);

3873 ià(
node
->
¦aveof
)

3874 
ci
 = 
	`sdsÿrštf
(ci," %.40 ",
node
->
¦aveof
->
Çme
);

3876 
ci
 = 
	`sdsÿ’
(ci," - ",3);

3879 
ci
 = 
	`sdsÿrštf
(ci,"%lld %lld %llu %s",

3880 (è
node
->
pšg_£Á
,

3881 (è
node
->
pÚg_»ûived
,

3882 (è
node
->
cÚfigEpoch
,

3883 (
node
->
lšk
 ||‚ode->
æags
 & 
CLUSTER_NODE_MYSELF
) ?

3887 
¡¬t
 = -1;

3888 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

3889 
b™
;

3891 ià((
b™
 = 
	`şu¡”NodeG‘SlÙB™
(
node
,
j
)) != 0) {

3892 ià(
¡¬t
 =ğ-1è¡¬ˆğ
j
;

3894 ià(
¡¬t
 !ğ-1 && (!
b™
 || 
j
 =ğ
CLUSTER_SLOTS
-1)) {

3895 ià(
b™
 && 
j
 =ğ
CLUSTER_SLOTS
-1) j++;

3897 ià(
¡¬t
 =ğ
j
-1) {

3898 
ci
 = 
	`sdsÿrštf
(ci," %d",
¡¬t
);

3900 
ci
 = 
	`sdsÿrštf
(ci," %d-%d",
¡¬t
,
j
-1);

3902 
¡¬t
 = -1;

3909 ià(
node
->
æags
 & 
CLUSTER_NODE_MYSELF
) {

3910 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

3911 ià(
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
j
]) {

3912 
ci
 = 
	`sdsÿrštf
(ci," [%d->-%.40s]",
j
,

3913 
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
j
]->
Çme
);

3914 } ià(
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
]) {

3915 
ci
 = 
	`sdsÿrštf
(ci," [%d-<-%.40s]",
j
,

3916 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
]->
Çme
);

3920  
ci
;

3921 
	}
}

3935 
sds
 
	$şu¡”G’NodesDesütiÚ
(
f‹r
) {

3936 
sds
 
ci
 = 
	`sd£m±y
(), 
ni
;

3937 
diùI‹¿tÜ
 *
di
;

3938 
diùEÁry
 *
de
;

3940 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

3941 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3942 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

3944 ià(
node
->
æags
 & 
f‹r
) ;

3945 
ni
 = 
	`şu¡”G’NodeDesütiÚ
(
node
);

3946 
ci
 = 
	`sdsÿtsds
(ci,
ni
);

3947 
	`sdsä“
(
ni
);

3948 
ci
 = 
	`sdsÿ’
(ci,"\n",1);

3950 
	`diùR–—£I‹¿tÜ
(
di
);

3951  
ci
;

3952 
	}
}

3958 cÚ¡ *
	$şu¡”G‘Mes§geTy³SŒšg
(
ty³
) {

3959 
ty³
) {

3960 
CLUSTERMSG_TYPE_PING
:  "ping";

3961 
CLUSTERMSG_TYPE_PONG
:  "pong";

3962 
CLUSTERMSG_TYPE_MEET
:  "meet";

3963 
CLUSTERMSG_TYPE_FAIL
:  "fail";

3964 
CLUSTERMSG_TYPE_PUBLISH
:  "publish";

3965 
CLUSTERMSG_TYPE_FAILOVER_AUTH_REQUEST
:  "auth-req";

3966 
CLUSTERMSG_TYPE_FAILOVER_AUTH_ACK
:  "auth-ack";

3967 
CLUSTERMSG_TYPE_UPDATE
:  "update";

3968 
CLUSTERMSG_TYPE_MFSTART
:  "mfstart";

3971 
	}
}

3973 
	$g‘SlÙOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
) {

3974 
¦Ù
;

3976 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
¦Ù
è!ğ
C_OK
 ||

3977 
¦Ù
 < 0 || slÙ >ğ
CLUSTER_SLOTS
)

3979 
	`addR•lyE¼Ü
(
c
,"Invalid or out of„ange slot");

3982  (è
¦Ù
;

3983 
	}
}

3985 
	$şu¡”R•lyMuÉiBulkSlÙs
(
ş›Á
 *
c
) {

3997 
num_ma¡”s
 = 0;

3998 *
¦Ù_»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

4000 
diùEÁry
 *
de
;

4001 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

4002 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

4003 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

4004 
j
 = 0, 
¡¬t
 = -1;

4008 ià(!
	`nodeIsMa¡”
(
node
è||‚ode->
num¦Ùs
 == 0) ;

4010 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

4011 
b™
, 
i
;

4013 ià((
b™
 = 
	`şu¡”NodeG‘SlÙB™
(
node
,
j
)) != 0) {

4014 ià(
¡¬t
 =ğ-1è¡¬ˆğ
j
;

4016 ià(
¡¬t
 !ğ-1 && (!
b™
 || 
j
 =ğ
CLUSTER_SLOTS
-1)) {

4017 
Ã¡ed_–em’ts
 = 3;

4018 *
Ã¡ed_»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

4020 ià(
b™
 && 
j
 =ğ
CLUSTER_SLOTS
-1) j++;

4024 ià(
¡¬t
 =ğ
j
-1) {

4025 
	`addR•lyLÚgLÚg
(
c
, 
¡¬t
);

4026 
	`addR•lyLÚgLÚg
(
c
, 
¡¬t
);

4028 
	`addR•lyLÚgLÚg
(
c
, 
¡¬t
);

4029 
	`addR•lyLÚgLÚg
(
c
, 
j
-1);

4031 
¡¬t
 = -1;

4034 
	`addR•lyMuÉiBulkL’
(
c
, 3);

4035 
	`addR•lyBulkCSŒšg
(
c
, 
node
->

);

4036 
	`addR•lyLÚgLÚg
(
c
, 
node
->
pÜt
);

4037 
	`addR•lyBulkCBufãr
(
c
, 
node
->
Çme
, 
CLUSTER_NAMELEN
);

4040 
i
 = 0; i < 
node
->
num¦aves
; i++) {

4043 ià(
	`nodeFaed
(
node
->
¦aves
[
i
])) ;

4044 
	`addR•lyMuÉiBulkL’
(
c
, 3);

4045 
	`addR•lyBulkCSŒšg
(
c
, 
node
->
¦aves
[
i
]->

);

4046 
	`addR•lyLÚgLÚg
(
c
, 
node
->
¦aves
[
i
]->
pÜt
);

4047 
	`addR•lyBulkCBufãr
(
c
, 
node
->
¦aves
[
i
]->
Çme
, 
CLUSTER_NAMELEN
);

4048 
Ã¡ed_–em’ts
++;

4050 
	`£tDeã¼edMuÉiBulkL’gth
(
c
, 
Ã¡ed_»¶yËn
, 
Ã¡ed_–em’ts
);

4051 
num_ma¡”s
++;

4055 
	`diùR–—£I‹¿tÜ
(
di
);

4056 
	`£tDeã¼edMuÉiBulkL’gth
(
c
, 
¦Ù_»¶yËn
, 
num_ma¡”s
);

4057 
	}
}

4059 
	$şu¡”Commªd
(
ş›Á
 *
c
) {

4060 ià(
£rv”
.
şu¡”_’abËd
 == 0) {

4061 
	`addR•lyE¼Ü
(
c
,"This instance has cluster support disabled");

4065 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"m“t"è&& (c->
¬gc
 == 4 || c->argc == 5)) {

4067 
pÜt
, 
ıÜt
;

4069 ià(
	`g‘LÚgLÚgFromObjeù
(
c
->
¬gv
[3], &
pÜt
è!ğ
C_OK
) {

4070 
	`addR•lyE¼ÜFÜm©
(
c
,"Invalid TCP base…ort specified: %s",

4071 (*)
c
->
¬gv
[3]->
±r
);

4075 ià(
c
->
¬gc
 == 5) {

4076 ià(
	`g‘LÚgLÚgFromObjeù
(
c
->
¬gv
[4], &
ıÜt
è!ğ
C_OK
) {

4077 
	`addR•lyE¼ÜFÜm©
(
c
,"Invalid TCP bus…ort specified: %s",

4078 (*)
c
->
¬gv
[4]->
±r
);

4082 
ıÜt
 = 
pÜt
 + 
CLUSTER_PORT_INCR
;

4085 ià(
	`şu¡”S¹Hªdshake
(
c
->
¬gv
[2]->
±r
,
pÜt
,
ıÜt
) == 0 &&

4086 
”ºo
 =ğ
EINVAL
)

4088 
	`addR•lyE¼ÜFÜm©
(
c
,"Invalid‚ode‡ddress specified: %s:%s",

4089 (*)
c
->
¬gv
[2]->
±r
, (*)c->argv[3]->ptr);

4091 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4093 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"nodes"è&& c->
¬gc
 == 2) {

4095 
robj
 *
o
;

4096 
sds
 
ci
 = 
	`şu¡”G’NodesDesütiÚ
(0);

4098 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
ci
);

4099 
	`addR•lyBulk
(
c
,
o
);

4100 
	`deüRefCouÁ
(
o
);

4101 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"myid"è&& c->
¬gc
 == 2) {

4103 
	`addR•lyBulkCBufãr
(
c
,
my£lf
->
Çme
, 
CLUSTER_NAMELEN
);

4104 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"¦Ùs"è&& c->
¬gc
 == 2) {

4106 
	`şu¡”R•lyMuÉiBulkSlÙs
(
c
);

4107 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"æush¦Ùs"è&& c->
¬gc
 == 2) {

4109 ià(
	`diùSize
(
£rv”
.
db
[0].
diù
) != 0) {

4110 
	`addR•lyE¼Ü
(
c
,"DB must beƒmptyo…erform CLUSTER FLUSHSLOTS.");

4113 
	`şu¡”D–NodeSlÙs
(
my£lf
);

4114 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_UPDATE_STATE
|
CLUSTER_TODO_SAVE_CONFIG
);

4115 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4116 } ià((!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"addslots") ||

4117 !
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"d–¦Ùs")è&& c->
¬gc
 >= 3)

4121 
j
, 
¦Ù
;

4122 *
¦Ùs
 = 
	`zm®loc
(
CLUSTER_SLOTS
);

4123 
d–
 = !
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"delslots");

4125 
	`mem£t
(
¦Ùs
,0,
CLUSTER_SLOTS
);

4128 
j
 = 2; j < 
c
->
¬gc
; j++) {

4129 ià((
¦Ù
 = 
	`g‘SlÙOrR•ly
(
c
,c->
¬gv
[
j
])) == -1) {

4130 
	`zä“
(
¦Ùs
);

4133 ià(
d–
 && 
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
] =ğ
NULL
) {

4134 
	`addR•lyE¼ÜFÜm©
(
c
,"SlÙ %d i ®»ady uÇssigÃd", 
¦Ù
);

4135 
	`zä“
(
¦Ùs
);

4137 } ià(!
d–
 && 
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
]) {

4138 
	`addR•lyE¼ÜFÜm©
(
c
,"SlÙ %d i ®»ady busy", 
¦Ù
);

4139 
	`zä“
(
¦Ùs
);

4142 ià(
¦Ùs
[
¦Ù
]++ == 1) {

4143 
	`addR•lyE¼ÜFÜm©
(
c
,"Slot %d specified multipleimes",

4144 ()
¦Ù
);

4145 
	`zä“
(
¦Ùs
);

4149 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

4150 ià(
¦Ùs
[
j
]) {

4151 
»tv®
;

4155 ià(
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
])

4156 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
] = 
NULL
;

4158 
»tv®
 = 
d–
 ? 
	`şu¡”D–SlÙ
(
j
) :

4159 
	`şu¡”AddSlÙ
(
my£lf
,
j
);

4160 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
»tv®
 =ğ
C_OK
);

4163 
	`zä“
(
¦Ùs
);

4164 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_UPDATE_STATE
|
CLUSTER_TODO_SAVE_CONFIG
);

4165 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4166 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"£t¦Ù"è&& c->
¬gc
 >= 4) {

4171 
¦Ù
;

4172 
şu¡”Node
 *
n
;

4174 ià(
	`nodeIsSÏve
(
my£lf
)) {

4175 
	`addR•lyE¼Ü
(
c
,"Please use SETSLOT only with masters.");

4179 ià((
¦Ù
 = 
	`g‘SlÙOrR•ly
(
c
,c->
¬gv
[2])) == -1) ;

4181 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[3]->
±r
,"mig¿tšg"è&& c->
¬gc
 == 5) {

4182 ià(
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
] !ğ
my£lf
) {

4183 
	`addR•lyE¼ÜFÜm©
(
c
,"I'm‚ÙhowÃ¸oàhash slÙ %u",
¦Ù
);

4186 ià((
n
 = 
	`şu¡”LookupNode
(
c
->
¬gv
[4]->
±r
)è=ğ
NULL
) {

4187 
	`addR•lyE¼ÜFÜm©
(
c
,"I don't know‡bout‚ode %s",

4188 (*)
c
->
¬gv
[4]->
±r
);

4191 
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
¦Ù
] = 
n
;

4192 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[3]->
±r
,"impÜtšg"è&& c->
¬gc
 == 5) {

4193 ià(
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
] =ğ
my£lf
) {

4194 
	`addR•lyE¼ÜFÜm©
(
c
,

4195 "I'm‡Ì—dyhowÃ¸oàhash slÙ %u",
¦Ù
);

4198 ià((
n
 = 
	`şu¡”LookupNode
(
c
->
¬gv
[4]->
±r
)è=ğ
NULL
) {

4199 
	`addR•lyE¼ÜFÜm©
(
c
,"I don't know‡bout‚ode %s",

4200 (*)
c
->
¬gv
[4]->
±r
);

4203 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
¦Ù
] = 
n
;

4204 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[3]->
±r
,"¡abË"è&& c->
¬gc
 == 4) {

4206 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
¦Ù
] = 
NULL
;

4207 
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
¦Ù
] = 
NULL
;

4208 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[3]->
±r
,"node"è&& c->
¬gc
 == 5) {

4210 
şu¡”Node
 *
n
 = 
	`şu¡”LookupNode
(
c
->
¬gv
[4]->
±r
);

4212 ià(!
n
) {

4213 
	`addR•lyE¼ÜFÜm©
(
c
,"Unknown‚ode %s",

4214 (*)
c
->
¬gv
[4]->
±r
);

4219 ià(
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
] =ğ
my£lf
 && 
n
 != myself) {

4220 ià(
	`couÁKeysInSlÙ
(
¦Ù
) != 0) {

4221 
	`addR•lyE¼ÜFÜm©
(
c
,

4223 "whI stÈhŞd key fÜhi hash slÙ.", 
¦Ù
);

4230 ià(
	`couÁKeysInSlÙ
(
¦Ù
) == 0 &&

4231 
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
¦Ù
])

4232 
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
¦Ù
] = 
NULL
;

4236 ià(
n
 =ğ
my£lf
 &&

4237 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
¦Ù
])

4248 ià(
	`şu¡”BumpCÚfigEpochW™houtCÚ£nsus
(è=ğ
C_OK
) {

4249 
	`£rv”Log
(
LL_WARNING
,

4250 "cÚfigEpoch upd©ed‡á” impÜtšg slÙ %d", 
¦Ù
);

4252 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
¦Ù
] = 
NULL
;

4254 
	`şu¡”D–SlÙ
(
¦Ù
);

4255 
	`şu¡”AddSlÙ
(
n
,
¦Ù
);

4257 
	`addR•lyE¼Ü
(
c
,

4261 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|
CLUSTER_TODO_UPDATE_STATE
);

4262 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4263 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"bum³poch"è&& c->
¬gc
 == 2) {

4265 
»tv®
 = 
	`şu¡”BumpCÚfigEpochW™houtCÚ£nsus
();

4266 
sds
 
»¶y
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"+%s %llu\r\n",

4267 (
»tv®
 =ğ
C_OK
) ? "BUMPED" : "STILL",

4268 (è
my£lf
->
cÚfigEpoch
);

4269 
	`addR•lySds
(
c
,
»¶y
);

4270 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"šfo"è&& c->
¬gc
 == 2) {

4272 *
¡©e¡r
[] = {"ok","fail","needhelp"};

4273 
¦Ùs_assigÃd
 = 0, 
¦Ùs_ok
 = 0, 
¦Ùs_pç
 = 0, 
¦Ùs_ç
 = 0;

4274 
ušt64_t
 
my•och
;

4275 
j
;

4277 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

4278 
şu¡”Node
 *
n
 = 
£rv”
.
şu¡”
->
¦Ùs
[
j
];

4280 ià(
n
 =ğ
NULL
) ;

4281 
¦Ùs_assigÃd
++;

4282 ià(
	`nodeFaed
(
n
)) {

4283 
¦Ùs_ç
++;

4284 } ià(
	`nodeTimedOut
(
n
)) {

4285 
¦Ùs_pç
++;

4287 
¦Ùs_ok
++;

4291 
my•och
 = (
	`nodeIsSÏve
(
my£lf
è&& my£lf->
¦aveof
) ?

4292 
my£lf
->
¦aveof
->
cÚfigEpoch
 : myself->configEpoch;

4294 
sds
 
šfo
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

4304 , 
¡©e¡r
[
£rv”
.
şu¡”
->
¡©e
],

4305 
¦Ùs_assigÃd
,

4306 
¦Ùs_ok
,

4307 
¦Ùs_pç
,

4308 
¦Ùs_ç
,

4309 
	`diùSize
(
£rv”
.
şu¡”
->
nodes
),

4310 
£rv”
.
şu¡”
->
size
,

4311 (è
£rv”
.
şu¡”
->
cu¼’tEpoch
,

4312 (è
my•och


4316 
tÙ_msg_£Á
 = 0;

4317 
tÙ_msg_»ûived
 = 0;

4319 
i
 = 0; i < 
CLUSTERMSG_TYPE_COUNT
; i++) {

4320 ià(
£rv”
.
şu¡”
->
¡©s_bus_mes§ges_£Á
[
i
] == 0) ;

4321 
tÙ_msg_£Á
 +ğ
£rv”
.
şu¡”
->
¡©s_bus_mes§ges_£Á
[
i
];

4322 
šfo
 = 
	`sdsÿrštf
(info,

4324 
	`şu¡”G‘Mes§geTy³SŒšg
(
i
),

4325 
£rv”
.
şu¡”
->
¡©s_bus_mes§ges_£Á
[
i
]);

4327 
šfo
 = 
	`sdsÿrštf
(info,

4328 "şu¡”_¡©s_mes§ges_£Á:%Îd\r\n", 
tÙ_msg_£Á
);

4330 
i
 = 0; i < 
CLUSTERMSG_TYPE_COUNT
; i++) {

4331 ià(
£rv”
.
şu¡”
->
¡©s_bus_mes§ges_»ûived
[
i
] == 0) ;

4332 
tÙ_msg_»ûived
 +ğ
£rv”
.
şu¡”
->
¡©s_bus_mes§ges_»ûived
[
i
];

4333 
šfo
 = 
	`sdsÿrštf
(info,

4335 
	`şu¡”G‘Mes§geTy³SŒšg
(
i
),

4336 
£rv”
.
şu¡”
->
¡©s_bus_mes§ges_»ûived
[
i
]);

4338 
šfo
 = 
	`sdsÿrštf
(info,

4339 "şu¡”_¡©s_mes§ges_»ûived:%Îd\r\n", 
tÙ_msg_»ûived
);

4342 
	`addR•lySds
(
c
,
	`sdsÿrštf
(
	`sd£m±y
(),"$%lu\r\n",

4343 ()
	`sd¦’
(
šfo
)));

4344 
	`addR•lySds
(
c
,
šfo
);

4345 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

4346 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"§vecÚfig"è&& c->
¬gc
 == 2) {

4347 
»tv®
 = 
	`şu¡”SaveCÚfig
(1);

4349 ià(
»tv®
 == 0)

4350 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4352 
	`addR•lyE¼ÜFÜm©
(
c
,"error savinghe cluster‚ode config: %s",

4353 
	`¡»¼Ü
(
”ºo
));

4354 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"key¦Ù"è&& c->
¬gc
 == 3) {

4356 
sds
 
key
 = 
c
->
¬gv
[2]->
±r
;

4358 
	`addR•lyLÚgLÚg
(
c
,
	`keyHashSlÙ
(
key
,
	`sd¦’
(key)));

4359 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"couÁkeysš¦Ù"è&& c->
¬gc
 == 3) {

4361 
¦Ù
;

4363 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
¦Ù
,
NULL
è!ğ
C_OK
)

4365 ià(
¦Ù
 < 0 || slÙ >ğ
CLUSTER_SLOTS
) {

4366 
	`addR•lyE¼Ü
(
c
,"Invalid slot");

4369 
	`addR•lyLÚgLÚg
(
c
,
	`couÁKeysInSlÙ
(
¦Ù
));

4370 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"g‘keysš¦Ù"è&& c->
¬gc
 == 4) {

4372 
maxkeys
, 
¦Ù
;

4373 
numkeys
, 
j
;

4374 
robj
 **
keys
;

4376 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
¦Ù
,
NULL
è!ğ
C_OK
)

4378 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
maxkeys
,
NULL
)

4379 !ğ
C_OK
)

4381 ià(
¦Ù
 < 0 || slÙ >ğ
CLUSTER_SLOTS
 || 
maxkeys
 < 0) {

4382 
	`addR•lyE¼Ü
(
c
,"Invalid slot or‚umber of keys");

4388 
keys_š_¦Ù
 = 
	`couÁKeysInSlÙ
(
¦Ù
);

4389 ià(
maxkeys
 > 
keys_š_¦Ù
) maxkeys = keys_in_slot;

4391 
keys
 = 
	`zm®loc
((
robj
*)*
maxkeys
);

4392 
numkeys
 = 
	`g‘KeysInSlÙ
(
¦Ù
, 
keys
, 
maxkeys
);

4393 
	`addR•lyMuÉiBulkL’
(
c
,
numkeys
);

4394 
j
 = 0; j < 
numkeys
; j++) {

4395 
	`addR•lyBulk
(
c
,
keys
[
j
]);

4396 
	`deüRefCouÁ
(
keys
[
j
]);

4398 
	`zä“
(
keys
);

4399 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"fÜg‘"è&& c->
¬gc
 == 3) {

4401 
şu¡”Node
 *
n
 = 
	`şu¡”LookupNode
(
c
->
¬gv
[2]->
±r
);

4403 ià(!
n
) {

4404 
	`addR•lyE¼ÜFÜm©
(
c
,"UnknowÀnod%s", (*)c->
¬gv
[2]->
±r
);

4406 } ià(
n
 =ğ
my£lf
) {

4407 
	`addR•lyE¼Ü
(
c
,"Iried hard but I can't forget myself...");

4409 } ià(
	`nodeIsSÏve
(
my£lf
è&& my£lf->
¦aveof
 =ğ
n
) {

4410 
	`addR•lyE¼Ü
(
c
,"Can't forget my master!");

4413 
	`şu¡”BÏckli¡AddNode
(
n
);

4414 
	`şu¡”D–Node
(
n
);

4415 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_UPDATE_STATE
|

4416 
CLUSTER_TODO_SAVE_CONFIG
);

4417 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4418 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"»¶iÿ‹"è&& c->
¬gc
 == 3) {

4420 
şu¡”Node
 *
n
 = 
	`şu¡”LookupNode
(
c
->
¬gv
[2]->
±r
);

4423 ià(!
n
) {

4424 
	`addR•lyE¼ÜFÜm©
(
c
,"UnknowÀnod%s", (*)c->
¬gv
[2]->
±r
);

4429 ià(
n
 =ğ
my£lf
) {

4430 
	`addR•lyE¼Ü
(
c
,"Can't„eplicate myself");

4435 ià(
	`nodeIsSÏve
(
n
)) {

4436 
	`addR•lyE¼Ü
(
c
,"I can only„eplicate‡ master,‚ot‡ slave.");

4443 ià(
	`nodeIsMa¡”
(
my£lf
) &&

4444 (
my£lf
->
num¦Ùs
 !ğ0 || 
	`diùSize
(
£rv”
.
db
[0].
diù
) != 0)) {

4445 
	`addR•lyE¼Ü
(
c
,

4452 
	`şu¡”S‘Ma¡”
(
n
);

4453 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_UPDATE_STATE
|
CLUSTER_TODO_SAVE_CONFIG
);

4454 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4455 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"¦aves"è&& c->
¬gc
 == 3) {

4457 
şu¡”Node
 *
n
 = 
	`şu¡”LookupNode
(
c
->
¬gv
[2]->
±r
);

4458 
j
;

4461 ià(!
n
) {

4462 
	`addR•lyE¼ÜFÜm©
(
c
,"UnknowÀnod%s", (*)c->
¬gv
[2]->
±r
);

4466 ià(
	`nodeIsSÏve
(
n
)) {

4467 
	`addR•lyE¼Ü
(
c
,"The specified‚ode is‚ot‡ master");

4471 
	`addR•lyMuÉiBulkL’
(
c
,
n
->
num¦aves
);

4472 
j
 = 0; j < 
n
->
num¦aves
; j++) {

4473 
sds
 
ni
 = 
	`şu¡”G’NodeDesütiÚ
(
n
->
¦aves
[
j
]);

4474 
	`addR•lyBulkCSŒšg
(
c
,
ni
);

4475 
	`sdsä“
(
ni
);

4477 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"count-failure-reports") &&

4478 
c
->
¬gc
 == 3)

4481 
şu¡”Node
 *
n
 = 
	`şu¡”LookupNode
(
c
->
¬gv
[2]->
±r
);

4483 ià(!
n
) {

4484 
	`addR•lyE¼ÜFÜm©
(
c
,"UnknowÀnod%s", (*)c->
¬gv
[2]->
±r
);

4487 
	`addR•lyLÚgLÚg
(
c
,
	`şu¡”NodeFau»R•ÜtsCouÁ
(
n
));

4489 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"failover") &&

4490 (
c
->
¬gc
 == 2 || c->argc == 3))

4493 
fÜû
 = 0, 
keov”
 = 0;

4495 ià(
c
->
¬gc
 == 3) {

4496 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"force")) {

4497 
fÜû
 = 1;

4498 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"takeover")) {

4499 
keov”
 = 1;

4500 
fÜû
 = 1;

4502 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

4508 ià(
	`nodeIsMa¡”
(
my£lf
)) {

4509 
	`addR•lyE¼Ü
(
c
,"You should send CLUSTER FAILOVERo‡ slave");

4511 } ià(
my£lf
->
¦aveof
 =ğ
NULL
) {

4512 
	`addR•lyE¼Ü
(
c
,"I'm‡ slave but my master is unknowno me");

4514 } ià(!
fÜû
 &&

4515 (
	`nodeFaed
(
my£lf
->
¦aveof
) ||

4516 
my£lf
->
¦aveof
->
lšk
 =ğ
NULL
))

4518 
	`addR•lyE¼Ü
(
c
,"Master is down or failed, "

4522 
	`»£tMªu®Faov”
();

4523 
£rv”
.
şu¡”
->
mf_’d
 = 
	`m¡ime
(è+ 
CLUSTER_MF_TIMEOUT
;

4525 ià(
keov”
) {

4530 
	`£rv”Log
(
LL_WARNING
,"Taking overhe master (user„equest).");

4531 
	`şu¡”BumpCÚfigEpochW™houtCÚ£nsus
();

4532 
	`şu¡”Faov”R•ÏûYourMa¡”
();

4533 } ià(
fÜû
) {

4537 
	`£rv”Log
(
LL_WARNING
,"Forced failover user„equest‡ccepted.");

4538 
£rv”
.
şu¡”
->
mf_ÿn_¡¬t
 = 1;

4540 
	`£rv”Log
(
LL_WARNING
,"Manual failover user„equest‡ccepted.");

4541 
	`şu¡”S’dMFS¹
(
my£lf
->
¦aveof
);

4543 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4544 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"£t-cÚfig-•och"è&& c->
¬gc
 == 3)

4553 
•och
;

4555 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
•och
,
NULL
è!ğ
C_OK
)

4558 ià(
•och
 < 0) {

4559 
	`addR•lyE¼ÜFÜm©
(
c
,"Inv®id cÚfigƒpoch s³cif›d: %Îd",
•och
);

4560 } ià(
	`diùSize
(
£rv”
.
şu¡”
->
nodes
) > 1) {

4561 
	`addR•lyE¼Ü
(
c
,"The user can‡ssign‡ configƒpoch only whenhe "

4563 } ià(
my£lf
->
cÚfigEpoch
 != 0) {

4564 
	`addR•lyE¼Ü
(
c
,"Node configƒpoch is‡lready‚on-zero");

4566 
my£lf
->
cÚfigEpoch
 = 
•och
;

4567 
	`£rv”Log
(
LL_WARNING
,

4569 (è
my£lf
->
cÚfigEpoch
);

4571 ià(
£rv”
.
şu¡”
->
cu¼’tEpoch
 < (
ušt64_t
)
•och
)

4572 
£rv”
.
şu¡”
->
cu¼’tEpoch
 = 
•och
;

4576 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_UPDATE_STATE
|

4577 
CLUSTER_TODO_SAVE_CONFIG
);

4578 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4580 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"reset") &&

4581 (
c
->
¬gc
 == 2 || c->argc == 3))

4584 
h¬d
 = 0;

4587 ià(
c
->
¬gc
 == 3) {

4588 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"hard")) {

4589 
h¬d
 = 1;

4590 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"soft")) {

4591 
h¬d
 = 0;

4593 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

4600 ià(
	`nodeIsMa¡”
(
my£lf
è&& 
	`diùSize
(
c
->
db
->
diù
) != 0) {

4601 
	`addR•lyE¼Ü
(
c
,"CLUSTER RESET can't be called with "

4605 
	`şu¡”Re£t
(
h¬d
);

4606 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4608 
	`addR•lyE¼Ü
(
c
,"Wrong CLUSTER subcommand or‚umber of‡rguments");

4610 
	}
}

4618 
	$ü—‹DumpPaylßd
(
rio
 *
·ylßd
, 
robj
 *
o
) {

4619 
buf
[2];

4620 
ušt64_t
 
üc
;

4624 
	`rioIn™W™hBufãr
(
·ylßd
,
	`sd£m±y
());

4625 
	`£rv”As£¹
(
	`rdbSaveObjeùTy³
(
·ylßd
,
o
));

4626 
	`£rv”As£¹
(
	`rdbSaveObjeù
(
·ylßd
,
o
));

4636 
buf
[0] = 
RDB_VERSION
 & 0xff;

4637 
buf
[1] = (
RDB_VERSION
 >> 8) & 0xff;

4638 
·ylßd
->
io
.
bufãr
.
±r
 = 
	`sdsÿ’
Õaylßd->io.bufãr.±r,
buf
,2);

4641 
üc
 = 
	`üc64
(0,(*)
·ylßd
->
io
.
bufãr
.
±r
,

4642 
	`sd¦’
(
·ylßd
->
io
.
bufãr
.
±r
));

4643 
	`mem»v64ifbe
(&
üc
);

4644 
·ylßd
->
io
.
bufãr
.
±r
 = 
	`sdsÿ’
Õaylßd->io.bufãr.±r,&
üc
,8);

4645 
	}
}

4651 
	$v”ifyDumpPaylßd
(*
p
, 
size_t
 
Ën
) {

4652 *
foÙ”
;

4653 
ušt16_t
 
rdbv”
;

4654 
ušt64_t
 
üc
;

4657 ià(
Ën
 < 10è 
C_ERR
;

4658 
foÙ”
 = 
p
+(
Ën
-10);

4661 
rdbv”
 = (
foÙ”
[1] << 8) | footer[0];

4662 ià(
rdbv”
 > 
RDB_VERSION
è 
C_ERR
;

4665 
üc
 = 
	`üc64
(0,
p
,
Ën
-8);

4666 
	`mem»v64ifbe
(&
üc
);

4667  (
	`memcmp
(&
üc
,
foÙ”
+2,8è=ğ0è? 
C_OK
 : 
C_ERR
;

4668 
	}
}

4673 
	$dumpCommªd
(
ş›Á
 *
c
) {

4674 
robj
 *
o
, *
dumpobj
;

4675 
rio
 
·ylßd
;

4678 ià((
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[1])è=ğ
NULL
) {

4679 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

4684 
	`ü—‹DumpPaylßd
(&
·ylßd
,
o
);

4687 
dumpobj
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
·ylßd
.
io
.
bufãr
.
±r
);

4688 
	`addR•lyBulk
(
c
,
dumpobj
);

4689 
	`deüRefCouÁ
(
dumpobj
);

4691 
	}
}

4694 
	$»¡ÜeCommªd
(
ş›Á
 *
c
) {

4695 
‰l
;

4696 
rio
 
·ylßd
;

4697 
j
, 
ty³
, 
»¶aû
 = 0;

4698 
robj
 *
obj
;

4701 
j
 = 4; j < 
c
->
¬gc
; j++) {

4702 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"replace")) {

4703 
»¶aû
 = 1;

4705 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

4711 ià(!
»¶aû
 && 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]è!ğ
NULL
) {

4712 
	`addR•ly
(
c
,
sh¬ed
.
busykey”r
);

4717 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
‰l
,
NULL
è!ğ
C_OK
) {

4719 } ià(
‰l
 < 0) {

4720 
	`addR•lyE¼Ü
(
c
,"Invalid TTL value, must be >= 0");

4725 ià(
	`v”ifyDumpPaylßd
(
c
->
¬gv
[3]->
±r
,
	`sd¦’
(c->¬gv[3]->±r)è=ğ
C_ERR
)

4727 
	`addR•lyE¼Ü
(
c
,"DUMP…ayload version or checksum‡re wrong");

4731 
	`rioIn™W™hBufãr
(&
·ylßd
,
c
->
¬gv
[3]->
±r
);

4732 ià(((
ty³
 = 
	`rdbLßdObjeùTy³
(&
·ylßd
)) == -1) ||

4733 ((
obj
 = 
	`rdbLßdObjeù
(
ty³
,&
·ylßd
)è=ğ
NULL
))

4735 
	`addR•lyE¼Ü
(
c
,"Bad data format");

4740 ià(
»¶aû
è
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

4743 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
obj
);

4744 ià(
‰l
è
	`£tExpœe
(
c
,c->
db
,c->
¬gv
[1],
	`m¡ime
()+ttl);

4745 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

4746 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4747 
£rv”
.
dœty
++;

4748 
	}
}

4756 
	#MIGRATE_SOCKET_CACHE_ITEMS
 64

	)

4757 
	#MIGRATE_SOCKET_CACHE_TTL
 10

	)

4759 
	smig¿‹CachedSock‘
 {

4760 
	mfd
;

4761 
	mÏ¡_dbid
;

4762 
time_t
 
	mÏ¡_u£_time
;

4763 } 
	tmig¿‹CachedSock‘
;

4776 
mig¿‹CachedSock‘
* 
	$mig¿‹G‘Sock‘
(
ş›Á
 *
c
, 
robj
 *
ho¡
,„obj *
pÜt
, 
timeout
) {

4777 
fd
;

4778 
sds
 
Çme
 = 
	`sd£m±y
();

4779 
mig¿‹CachedSock‘
 *
cs
;

4782 
Çme
 = 
	`sdsÿ’
Òame,
ho¡
->
±r
,
	`sd¦’
(host->ptr));

4783 
Çme
 = 
	`sdsÿ’
(name,":",1);

4784 
Çme
 = 
	`sdsÿ’
Òame,
pÜt
->
±r
,
	`sd¦’
(port->ptr));

4785 
cs
 = 
	`diùF‘chV®ue
(
£rv”
.
mig¿‹_ÿched_sock‘s
,
Çme
);

4786 ià(
cs
) {

4787 
	`sdsä“
(
Çme
);

4788 
cs
->
Ï¡_u£_time
 = 
£rv”
.
unixtime
;

4789  
cs
;

4793 ià(
	`diùSize
(
£rv”
.
mig¿‹_ÿched_sock‘s
è=ğ
MIGRATE_SOCKET_CACHE_ITEMS
) {

4795 
diùEÁry
 *
de
 = 
	`diùG‘RªdomKey
(
£rv”
.
mig¿‹_ÿched_sock‘s
);

4796 
cs
 = 
	`diùG‘V®
(
de
);

4797 
	`şo£
(
cs
->
fd
);

4798 
	`zä“
(
cs
);

4799 
	`diùD–‘e
(
£rv”
.
mig¿‹_ÿched_sock‘s
,
	`diùG‘Key
(
de
));

4803 
fd
 = 
	`ª‘TıNÚBlockCÚÃù
(
£rv”
.
Ã‹¼
,
c
->
¬gv
[1]->
±r
,

4804 
	`©oi
(
c
->
¬gv
[2]->
±r
));

4805 ià(
fd
 == -1) {

4806 
	`sdsä“
(
Çme
);

4807 
	`addR•lyE¼ÜFÜm©
(
c
,"Can't connectoarget‚ode: %s",

4808 
£rv”
.
Ã‹¼
);

4809  
NULL
;

4811 
	`ª‘EÇbËTıNoD–ay
(
£rv”
.
Ã‹¼
,
fd
);

4814 ià((
	`«Wa™
(
fd
,
AE_WRITABLE
,
timeout
) & AE_WRITABLE) == 0) {

4815 
	`sdsä“
(
Çme
);

4816 
	`addR•lySds
(
c
,

4817 
	`sd¢ew
("-IOERRƒrror orimeout connectingohe client\r\n"));

4818 
	`şo£
(
fd
);

4819  
NULL
;

4823 
cs
 = 
	`zm®loc
((*cs));

4824 
cs
->
fd
 = fd;

4825 
cs
->
Ï¡_dbid
 = -1;

4826 
cs
->
Ï¡_u£_time
 = 
£rv”
.
unixtime
;

4827 
	`diùAdd
(
£rv”
.
mig¿‹_ÿched_sock‘s
,
Çme
,
cs
);

4828  
cs
;

4829 
	}
}

4832 
	$mig¿‹Clo£Sock‘
(
robj
 *
ho¡
,„obj *
pÜt
) {

4833 
sds
 
Çme
 = 
	`sd£m±y
();

4834 
mig¿‹CachedSock‘
 *
cs
;

4836 
Çme
 = 
	`sdsÿ’
Òame,
ho¡
->
±r
,
	`sd¦’
(host->ptr));

4837 
Çme
 = 
	`sdsÿ’
(name,":",1);

4838 
Çme
 = 
	`sdsÿ’
Òame,
pÜt
->
±r
,
	`sd¦’
(port->ptr));

4839 
cs
 = 
	`diùF‘chV®ue
(
£rv”
.
mig¿‹_ÿched_sock‘s
,
Çme
);

4840 ià(!
cs
) {

4841 
	`sdsä“
(
Çme
);

4845 
	`şo£
(
cs
->
fd
);

4846 
	`zä“
(
cs
);

4847 
	`diùD–‘e
(
£rv”
.
mig¿‹_ÿched_sock‘s
,
Çme
);

4848 
	`sdsä“
(
Çme
);

4849 
	}
}

4851 
	$mig¿‹Clo£TimedoutSock‘s
() {

4852 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
mig¿‹_ÿched_sock‘s
);

4853 
diùEÁry
 *
de
;

4855 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

4856 
mig¿‹CachedSock‘
 *
cs
 = 
	`diùG‘V®
(
de
);

4858 ià((
£rv”
.
unixtime
 - 
cs
->
Ï¡_u£_time
è> 
MIGRATE_SOCKET_CACHE_TTL
) {

4859 
	`şo£
(
cs
->
fd
);

4860 
	`zä“
(
cs
);

4861 
	`diùD–‘e
(
£rv”
.
mig¿‹_ÿched_sock‘s
,
	`diùG‘Key
(
de
));

4864 
	`diùR–—£I‹¿tÜ
(
di
);

4865 
	}
}

4872 
	$mig¿‹Commªd
(
ş›Á
 *
c
) {

4873 
mig¿‹CachedSock‘
 *
cs
;

4874 
cİy
, 
»¶aû
, 
j
;

4875 
timeout
;

4876 
dbid
;

4877 
robj
 **
ov
 = 
NULL
;

4878 
robj
 **
kv
 = 
NULL
;

4879 
robj
 **
Ãw¬gv
 = 
NULL
;

4880 
rio
 
cmd
, 
·ylßd
;

4881 
may_»Œy
 = 1;

4882 
wr™e_”rÜ
 = 0;

4883 
¬gv_»wr™‹n
 = 0;

4886 
fœ¡_key
 = 3;

4887 
num_keys
 = 1;

4890 
cİy
 = 0;

4891 
»¶aû
 = 0;

4894 
j
 = 6; j < 
c
->
¬gc
; j++) {

4895 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"copy")) {

4896 
cİy
 = 1;

4897 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"replace")) {

4898 
»¶aû
 = 1;

4899 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"keys")) {

4900 ià(
	`sd¦’
(
c
->
¬gv
[3]->
±r
) != 0) {

4901 
	`addR•lyE¼Ü
(
c
,

4906 
fœ¡_key
 = 
j
+1;

4907 
num_keys
 = 
c
->
¬gc
 - 
j
 - 1;

4910 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

4916 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[5],&
timeout
,
NULL
è!ğ
C_OK
 ||

4917 
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[4],&
dbid
,
NULL
è!ğ
C_OK
)

4921 ià(
timeout
 <= 0)imeout = 1000;

4928 
ov
 = 
	`z»®loc
(ov,(
robj
*)*
num_keys
);

4929 
kv
 = 
	`z»®loc
(kv,(
robj
*)*
num_keys
);

4930 
oi
 = 0;

4932 
j
 = 0; j < 
num_keys
; j++) {

4933 ià((
ov
[
oi
] = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
fœ¡_key
+
j
])è!ğ
NULL
) {

4934 
kv
[
oi
] = 
c
->
¬gv
[
fœ¡_key
+
j
];

4935 
oi
++;

4938 
num_keys
 = 
oi
;

4939 ià(
num_keys
 == 0) {

4940 
	`zä“
(
ov
); zä“(
kv
);

4941 
	`addR•lySds
(
c
,
	`sd¢ew
("+NOKEY\r\n"));

4945 
Œy_agaš
:

4946 
wr™e_”rÜ
 = 0;

4949 
cs
 = 
	`mig¿‹G‘Sock‘
(
c
,c->
¬gv
[1],c->¬gv[2],
timeout
);

4950 ià(
cs
 =ğ
NULL
) {

4951 
	`zä“
(
ov
); zä“(
kv
);

4955 
	`rioIn™W™hBufãr
(&
cmd
,
	`sd£m±y
());

4958 
£Ëù
 = 
cs
->
Ï¡_dbid
 !ğ
dbid
;

4959 ià(
£Ëù
) {

4960 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkCouÁ
(&
cmd
,'*',2));

4961 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkSŒšg
(&
cmd
,"SELECT",6));

4962 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkLÚgLÚg
(&
cmd
,
dbid
));

4966 
j
 = 0; j < 
num_keys
; j++) {

4967 
‰l
 = 0;

4968 
expœ—t
 = 
	`g‘Expœe
(
c
->
db
,
kv
[
j
]);

4970 ià(
expœ—t
 != -1) {

4971 
‰l
 = 
expœ—t
-
	`m¡ime
();

4972 ià(
‰l
 < 1)tl = 1;

4974 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkCouÁ
(&
cmd
,'*',
»¶aû
 ? 5 : 4));

4975 ià(
£rv”
.
şu¡”_’abËd
)

4976 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,

4977 
	`rioWr™eBulkSŒšg
(&
cmd
,"RESTORE-ASKING",14));

4979 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkSŒšg
(&
cmd
,"RESTORE",7));

4980 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`sdsEncodedObjeù
(
kv
[
j
]));

4981 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkSŒšg
(&
cmd
,
kv
[
j
]->
±r
,

4982 
	`sd¦’
(
kv
[
j
]->
±r
)));

4983 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkLÚgLÚg
(&
cmd
,
‰l
));

4987 
	`ü—‹DumpPaylßd
(&
·ylßd
,
ov
[
j
]);

4988 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,

4989 
	`rioWr™eBulkSŒšg
(&
cmd
,
·ylßd
.
io
.
bufãr
.
±r
,

4990 
	`sd¦’
(
·ylßd
.
io
.
bufãr
.
±r
)));

4991 
	`sdsä“
(
·ylßd
.
io
.
bufãr
.
±r
);

4995 ià(
»¶aû
)

4996 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkSŒšg
(&
cmd
,"REPLACE",7));

5000 
”ºo
 = 0;

5002 
sds
 
buf
 = 
cmd
.
io
.
bufãr
.
±r
;

5003 
size_t
 
pos
 = 0, 
towr™e
;

5004 
nwr™‹n
 = 0;

5006 (
towr™e
 = 
	`sd¦’
(
buf
)-
pos
) > 0) {

5007 
towr™e
 = (towrite > (64*1024) ? (64*1024) :owrite);

5008 
nwr™‹n
 = 
	`syncWr™e
(
cs
->
fd
,
buf
+
pos
,
towr™e
,
timeout
);

5009 ià(
nwr™‹n
 !ğ(sigÃd)
towr™e
) {

5010 
wr™e_”rÜ
 = 1;

5011 
sock‘_”r
;

5013 
pos
 +ğ
nwr™‹n
;

5017 
buf1
[1024];

5018 
buf2
[1024];

5021 ià(
£Ëù
 && 
	`syncR—dLše
(
cs
->
fd
, 
buf1
, (buf1), 
timeout
) <= 0)

5022 
sock‘_”r
;

5025 
”rÜ_äom_rg‘
 = 0;

5026 
sock‘_”rÜ
 = 0;

5027 
d–_idx
 = 1;

5029 ià(!
cİy
è
Ãw¬gv
 = 
	`zm®loc
((
robj
*)*(
num_keys
+1));

5031 
j
 = 0; j < 
num_keys
; j++) {

5032 ià(
	`syncR—dLše
(
cs
->
fd
, 
buf2
, (buf2), 
timeout
) <= 0) {

5033 
sock‘_”rÜ
 = 1;

5036 ià((
£Ëù
 && 
buf1
[0] =ğ'-'è|| 
buf2
[0] == '-') {

5038 ià(!
”rÜ_äom_rg‘
) {

5039 
cs
->
Ï¡_dbid
 = -1;

5040 
	`addR•lyE¼ÜFÜm©
(
c
,"Target instance„eplied withƒrror: %s",

5041 (
£Ëù
 && 
buf1
[0] =ğ'-'è? buf1+1 : 
buf2
+1);

5042 
”rÜ_äom_rg‘
 = 1;

5045 ià(!
cİy
) {

5047 
	`dbD–‘e
(
c
->
db
,
kv
[
j
]);

5048 
	`sigÇlModif›dKey
(
c
->
db
,
kv
[
j
]);

5049 
£rv”
.
dœty
++;

5052 
Ãw¬gv
[
d–_idx
++] = 
kv
[
j
];

5053 
	`šüRefCouÁ
(
kv
[
j
]);

5061 ià(!
”rÜ_äom_rg‘
 && 
sock‘_”rÜ
 && 
j
 =ğ0 && 
may_»Œy
 &&

5062 
”ºo
 !ğ
ETIMEDOUT
)

5064 
sock‘_”r
;

5070 ià(
sock‘_”rÜ
è
	`mig¿‹Clo£Sock‘
(
c
->
¬gv
[1],c->argv[2]);

5072 ià(!
cİy
) {

5076 ià(
d–_idx
 > 1) {

5077 
Ãw¬gv
[0] = 
	`ü—‹SŒšgObjeù
("DEL",3);

5079 
	`»¶aûCl›ÁCommªdVeùÜ
(
c
,
d–_idx
,
Ãw¬gv
);

5080 
¬gv_»wr™‹n
 = 1;

5083 
	`zä“
(
Ãw¬gv
);

5085 
Ãw¬gv
 = 
NULL
;

5091 ià(!
”rÜ_äom_rg‘
 && 
sock‘_”rÜ
) {

5092 
may_»Œy
 = 0;

5093 
sock‘_”r
;

5096 ià(!
”rÜ_äom_rg‘
) {

5103 
cs
->
Ï¡_dbid
 = 
dbid
;

5104 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

5110 
	`sdsä“
(
cmd
.
io
.
bufãr
.
±r
);

5111 
	`zä“
(
ov
); zä“(
kv
); zä“(
Ãw¬gv
);

5117 
sock‘_”r
:

5120 
	`sdsä“
(
cmd
.
io
.
bufãr
.
±r
);

5126 ià(!
¬gv_»wr™‹n
è
	`mig¿‹Clo£Sock‘
(
c
->
¬gv
[1],c->argv[2]);

5127 
	`zä“
(
Ãw¬gv
);

5128 
Ãw¬gv
 = 
NULL
;

5132 ià(
”ºo
 !ğ
ETIMEDOUT
 && 
may_»Œy
) {

5133 
may_»Œy
 = 0;

5134 
Œy_agaš
;

5138 
	`zä“
(
ov
); zä“(
kv
);

5139 
	`addR•lySds
(
c
,

5140 
	`sdsÿrštf
(
	`sd£m±y
(),

5142 
wr™e_”rÜ
 ? "writing" : "reading"));

5144 
	}
}

5154 
	$askšgCommªd
(
ş›Á
 *
c
) {

5155 ià(
£rv”
.
şu¡”_’abËd
 == 0) {

5156 
	`addR•lyE¼Ü
(
c
,"This instance has cluster support disabled");

5159 
c
->
æags
 |ğ
CLIENT_ASKING
;

5160 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

5161 
	}
}

5166 
	$»adÚlyCommªd
(
ş›Á
 *
c
) {

5167 ià(
£rv”
.
şu¡”_’abËd
 == 0) {

5168 
	`addR•lyE¼Ü
(
c
,"This instance has cluster support disabled");

5171 
c
->
æags
 |ğ
CLIENT_READONLY
;

5172 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

5173 
	}
}

5176 
	$»adwr™eCommªd
(
ş›Á
 *
c
) {

5177 
c
->
æags
 &ğ~
CLIENT_READONLY
;

5178 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

5179 
	}
}

5213 
şu¡”Node
 *
	$g‘NodeByQu”y
(
ş›Á
 *
c
, 
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
hash¦Ù
, *
”rÜ_code
) {

5214 
şu¡”Node
 *
n
 = 
NULL
;

5215 
robj
 *
fœ¡key
 = 
NULL
;

5216 
muÉË_keys
 = 0;

5217 
muÉiS‹
 *
ms
, 
_ms
;

5218 
muÉiCmd
 
mc
;

5219 
i
, 
¦Ù
 = 0, 
mig¿tšg_¦Ù
 = 0, 
impÜtšg_¦Ù
 = 0, 
missšg_keys
 = 0;

5222 ià(
”rÜ_code
è*”rÜ_codğ
CLUSTER_REDIR_NONE
;

5226 ià(
cmd
->
´oc
 =ğ
execCommªd
) {

5229 ià(!(
c
->
æags
 & 
CLIENT_MULTI
)è 
my£lf
;

5230 
ms
 = &
c
->
m¡©e
;

5235 
ms
 = &
_ms
;

5236 
_ms
.
commªds
 = &
mc
;

5237 
_ms
.
couÁ
 = 1;

5238 
mc
.
¬gv
 =‡rgv;

5239 
mc
.
¬gc
 =‡rgc;

5240 
mc
.
cmd
 = cmd;

5245 
i
 = 0; i < 
ms
->
couÁ
; i++) {

5246 
»disCommªd
 *
mcmd
;

5247 
robj
 **
m¬gv
;

5248 
m¬gc
, *
keyšdex
, 
numkeys
, 
j
;

5250 
mcmd
 = 
ms
->
commªds
[
i
].
cmd
;

5251 
m¬gc
 = 
ms
->
commªds
[
i
].
¬gc
;

5252 
m¬gv
 = 
ms
->
commªds
[
i
].
¬gv
;

5254 
keyšdex
 = 
	`g‘KeysFromCommªd
(
mcmd
,
m¬gv
,
m¬gc
,&
numkeys
);

5255 
j
 = 0; j < 
numkeys
; j++) {

5256 
robj
 *
thiskey
 = 
m¬gv
[
keyšdex
[
j
]];

5257 
this¦Ù
 = 
	`keyHashSlÙ
((*)
thiskey
->
±r
,

5258 
	`sd¦’
(
thiskey
->
±r
));

5260 ià(
fœ¡key
 =ğ
NULL
) {

5263 
fœ¡key
 = 
thiskey
;

5264 
¦Ù
 = 
this¦Ù
;

5265 
n
 = 
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
];

5271 ià(
n
 =ğ
NULL
) {

5272 
	`g‘KeysF»eResuÉ
(
keyšdex
);

5273 ià(
”rÜ_code
)

5274 *
”rÜ_code
 = 
CLUSTER_REDIR_DOWN_UNBOUND
;

5275  
NULL
;

5283 ià(
n
 =ğ
my£lf
 &&

5284 
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
¦Ù
] !ğ
NULL
)

5286 
mig¿tšg_¦Ù
 = 1;

5287 } ià(
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
¦Ù
] !ğ
NULL
) {

5288 
impÜtšg_¦Ù
 = 1;

5293 ià(!
	`equ®SŒšgObjeùs
(
fœ¡key
,
thiskey
)) {

5294 ià(
¦Ù
 !ğ
this¦Ù
) {

5296 
	`g‘KeysF»eResuÉ
(
keyšdex
);

5297 ià(
”rÜ_code
)

5298 *
”rÜ_code
 = 
CLUSTER_REDIR_CROSS_SLOT
;

5299  
NULL
;

5303 
muÉË_keys
 = 1;

5309 ià((
mig¿tšg_¦Ù
 || 
impÜtšg_¦Ù
) &&

5310 
	`lookupKeyR—d
(&
£rv”
.
db
[0],
thiskey
è=ğ
NULL
)

5312 
missšg_keys
++;

5315 
	`g‘KeysF»eResuÉ
(
keyšdex
);

5320 ià(
n
 =ğ
NULL
è 
my£lf
;

5323 ià(
£rv”
.
şu¡”
->
¡©e
 !ğ
CLUSTER_OK
) {

5324 ià(
”rÜ_code
è*”rÜ_codğ
CLUSTER_REDIR_DOWN_STATE
;

5325  
NULL
;

5329 ià(
hash¦Ù
è*hash¦Ù = 
¦Ù
;

5334 ià((
mig¿tšg_¦Ù
 || 
impÜtšg_¦Ù
è&& 
cmd
->
´oc
 =ğ
mig¿‹Commªd
)

5335  
my£lf
;

5339 ià(
mig¿tšg_¦Ù
 && 
missšg_keys
) {

5340 ià(
”rÜ_code
è*”rÜ_codğ
CLUSTER_REDIR_ASK
;

5341  
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
¦Ù
];

5348 ià(
impÜtšg_¦Ù
 &&

5349 (
c
->
æags
 & 
CLIENT_ASKING
 || 
cmd
->æag & 
CMD_ASKING
))

5351 ià(
muÉË_keys
 && 
missšg_keys
) {

5352 ià(
”rÜ_code
è*”rÜ_codğ
CLUSTER_REDIR_UNSTABLE
;

5353  
NULL
;

5355  
my£lf
;

5362 ià(
c
->
æags
 & 
CLIENT_READONLY
 &&

5363 
cmd
->
æags
 & 
CMD_READONLY
 &&

5364 
	`nodeIsSÏve
(
my£lf
) &&

5365 
my£lf
->
¦aveof
 =ğ
n
)

5367  
my£lf
;

5372 ià(
n
 !ğ
my£lf
 && 
”rÜ_code
è*”rÜ_codğ
CLUSTER_REDIR_MOVED
;

5373  
n
;

5374 
	}
}

5383 
	$şu¡”RedœeùCl›Á
(
ş›Á
 *
c
, 
şu¡”Node
 *
n
, 
hash¦Ù
, 
”rÜ_code
) {

5384 ià(
”rÜ_code
 =ğ
CLUSTER_REDIR_CROSS_SLOT
) {

5385 
	`addR•lySds
(
c
,
	`sd¢ew
("-CROSSSLOT Keys in„equest don't hashohe same slot\r\n"));

5386 } ià(
”rÜ_code
 =ğ
CLUSTER_REDIR_UNSTABLE
) {

5390 
	`addR•lySds
(
c
,
	`sd¢ew
("-TRYAGAIN Multiple keys„equest during„ehashing of slot\r\n"));

5391 } ià(
”rÜ_code
 =ğ
CLUSTER_REDIR_DOWN_STATE
) {

5392 
	`addR•lySds
(
c
,
	`sd¢ew
("-CLUSTERDOWN The cluster is down\r\n"));

5393 } ià(
”rÜ_code
 =ğ
CLUSTER_REDIR_DOWN_UNBOUND
) {

5394 
	`addR•lySds
(
c
,
	`sd¢ew
("-CLUSTERDOWN Hash slot‚ot served\r\n"));

5395 } ià(
”rÜ_code
 =ğ
CLUSTER_REDIR_MOVED
 ||

5396 
”rÜ_code
 =ğ
CLUSTER_REDIR_ASK
)

5398 
	`addR•lySds
(
c
,
	`sdsÿrštf
(
	`sd£m±y
(),

5400 (
”rÜ_code
 =ğ
CLUSTER_REDIR_ASK
) ? "ASK" : "MOVED",

5401 
hash¦Ù
,
n
->

,n->
pÜt
));

5403 
	`£rv”Pªic
("getNodeByQuery() unknownƒrror.");

5405 
	}
}

5418 
	$şu¡”RedœeùBlockedCl›ÁIfN“ded
(
ş›Á
 *
c
) {

5419 ià(
c
->
æags
 & 
CLIENT_BLOCKED
 && c->
bty³
 =ğ
BLOCKED_LIST
) {

5420 
diùEÁry
 *
de
;

5421 
diùI‹¿tÜ
 *
di
;

5424 ià(
£rv”
.
şu¡”
->
¡©e
 =ğ
CLUSTER_FAIL
) {

5425 
	`şu¡”RedœeùCl›Á
(
c
,
NULL
,0,
CLUSTER_REDIR_DOWN_STATE
);

5430 
di
 = 
	`diùG‘I‹¿tÜ
(
c
->
bpİ
.
keys
);

5431 ià((
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

5432 
robj
 *
key
 = 
	`diùG‘Key
(
de
);

5433 
¦Ù
 = 
	`keyHashSlÙ
((*)
key
->
±r
, 
	`sd¦’
(key->ptr));

5434 
şu¡”Node
 *
node
 = 
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
];

5439 ià(
node
 !ğ
my£lf
 &&

5440 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
¦Ù
] =ğ
NULL
)

5442 ià(
node
 =ğ
NULL
) {

5443 
	`şu¡”RedœeùCl›Á
(
c
,
NULL
,0,

5444 
CLUSTER_REDIR_DOWN_UNBOUND
);

5446 
	`şu¡”RedœeùCl›Á
(
c
,
node
,
¦Ù
,

5447 
CLUSTER_REDIR_MOVED
);

5449 
	`diùR–—£I‹¿tÜ
(
di
);

5453 
	`diùR–—£I‹¿tÜ
(
di
);

5456 
	}
}

	@cluster.h

1 #iâdeà
__CLUSTER_H


2 
	#__CLUSTER_H


	)

8 
	#CLUSTER_SLOTS
 16384

	)

9 
	#CLUSTER_OK
 0

	)

10 
	#CLUSTER_FAIL
 1

	)

11 
	#CLUSTER_NAMELEN
 40

	)

12 
	#CLUSTER_PORT_INCR
 10000

	)

16 
	#CLUSTER_DEFAULT_NODE_TIMEOUT
 15000

	)

17 
	#CLUSTER_DEFAULT_SLAVE_VALIDITY
 10

	)

18 
	#CLUSTER_DEFAULT_REQUIRE_FULL_COVERAGE
 1

	)

19 
	#CLUSTER_FAIL_REPORT_VALIDITY_MULT
 2

	)

20 
	#CLUSTER_FAIL_UNDO_TIME_MULT
 2

	)

21 
	#CLUSTER_FAIL_UNDO_TIME_ADD
 10

	)

22 
	#CLUSTER_FAILOVER_DELAY
 5

	)

23 
	#CLUSTER_DEFAULT_MIGRATION_BARRIER
 1

	)

24 
	#CLUSTER_MF_TIMEOUT
 5000

	)

25 
	#CLUSTER_MF_PAUSE_MULT
 2

	)

26 
	#CLUSTER_SLAVE_MIGRATION_DELAY
 5000

	)

29 
	#CLUSTER_REDIR_NONE
 0

	)

30 
	#CLUSTER_REDIR_CROSS_SLOT
 1

	)

31 
	#CLUSTER_REDIR_UNSTABLE
 2

	)

32 
	#CLUSTER_REDIR_ASK
 3

	)

33 
	#CLUSTER_REDIR_MOVED
 4

	)

34 
	#CLUSTER_REDIR_DOWN_STATE
 5

	)

35 
	#CLUSTER_REDIR_DOWN_UNBOUND
 6

	)

37 
	gşu¡”Node
;

40 
	sşu¡”Lšk
 {

41 
m¡ime_t
 
	mùime
;

42 
	mfd
;

43 
sds
 
	m¢dbuf
;

44 
sds
 
	mrcvbuf
;

45 
şu¡”Node
 *
	mnode
;

46 } 
	tşu¡”Lšk
;

49 
	#CLUSTER_NODE_MASTER
 1

	)

50 
	#CLUSTER_NODE_SLAVE
 2

	)

51 
	#CLUSTER_NODE_PFAIL
 4

	)

52 
	#CLUSTER_NODE_FAIL
 8

	)

53 
	#CLUSTER_NODE_MYSELF
 16

	)

54 
	#CLUSTER_NODE_HANDSHAKE
 32

	)

55 
	#CLUSTER_NODE_NOADDR
 64

	)

56 
	#CLUSTER_NODE_MEET
 128

	)

57 
	#CLUSTER_NODE_MIGRATE_TO
 256

	)

58 
	#CLUSTER_NODE_NULL_NAME
 "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"

	)

60 
	#nodeIsMa¡”
(
n
è(Ò)->
æags
 & 
CLUSTER_NODE_MASTER
)

	)

61 
	#nodeIsSÏve
(
n
è(Ò)->
æags
 & 
CLUSTER_NODE_SLAVE
)

	)

62 
	#nodeInHªdshake
(
n
è(Ò)->
æags
 & 
CLUSTER_NODE_HANDSHAKE
)

	)

63 
	#nodeHasAddr
(
n
è(!(Ò)->
æags
 & 
CLUSTER_NODE_NOADDR
))

	)

64 
	#nodeW™houtAddr
(
n
è(Ò)->
æags
 & 
CLUSTER_NODE_NOADDR
)

	)

65 
	#nodeTimedOut
(
n
è(Ò)->
æags
 & 
CLUSTER_NODE_PFAIL
)

	)

66 
	#nodeFaed
(
n
è(Ò)->
æags
 & 
CLUSTER_NODE_FAIL
)

	)

69 
	#CLUSTER_CANT_FAILOVER_NONE
 0

	)

70 
	#CLUSTER_CANT_FAILOVER_DATA_AGE
 1

	)

71 
	#CLUSTER_CANT_FAILOVER_WAITING_DELAY
 2

	)

72 
	#CLUSTER_CANT_FAILOVER_EXPIRED
 3

	)

73 
	#CLUSTER_CANT_FAILOVER_WAITING_VOTES
 4

	)

74 
	#CLUSTER_CANT_FAILOVER_RELOG_PERIOD
 (60*5è

	)

77 
	#CLUSTER_TODO_HANDLE_FAILOVER
 (1<<0)

	)

78 
	#CLUSTER_TODO_UPDATE_STATE
 (1<<1)

	)

79 
	#CLUSTER_TODO_SAVE_CONFIG
 (1<<2)

	)

80 
	#CLUSTER_TODO_FSYNC_CONFIG
 (1<<3)

	)

88 
	#CLUSTERMSG_TYPE_PING
 0

	)

89 
	#CLUSTERMSG_TYPE_PONG
 1

	)

90 
	#CLUSTERMSG_TYPE_MEET
 2

	)

91 
	#CLUSTERMSG_TYPE_FAIL
 3

	)

92 
	#CLUSTERMSG_TYPE_PUBLISH
 4

	)

93 
	#CLUSTERMSG_TYPE_FAILOVER_AUTH_REQUEST
 5

	)

94 
	#CLUSTERMSG_TYPE_FAILOVER_AUTH_ACK
 6

	)

95 
	#CLUSTERMSG_TYPE_UPDATE
 7

	)

96 
	#CLUSTERMSG_TYPE_MFSTART
 8

	)

97 
	#CLUSTERMSG_TYPE_COUNT
 9

	)

100 
	sşu¡”NodeFaR•Üt
 {

101 
şu¡”Node
 *
	mnode
;

102 
m¡ime_t
 
	mtime
;

103 } 
	tşu¡”NodeFaR•Üt
;

105 
	sşu¡”Node
 {

106 
m¡ime_t
 
	mùime
;

107 
	mÇme
[
CLUSTER_NAMELEN
];

108 
	mæags
;

109 
ušt64_t
 
	mcÚfigEpoch
;

110 
	m¦Ùs
[
CLUSTER_SLOTS
/8];

111 
	mnum¦Ùs
;

112 
	mnum¦aves
;

113 
şu¡”Node
 **
	m¦aves
;

114 
şu¡”Node
 *
	m¦aveof
;

118 
m¡ime_t
 
	mpšg_£Á
;

119 
m¡ime_t
 
	mpÚg_»ûived
;

120 
m¡ime_t
 
	mç_time
;

121 
m¡ime_t
 
	mvÙed_time
;

122 
m¡ime_t
 
	m»¶_off£t_time
;

123 
m¡ime_t
 
	mÜphªed_time
;

124 
	m»¶_off£t
;

125 
	m
[
NET_IP_STR_LEN
];

126 
	mpÜt
;

127 
	mıÜt
;

128 
şu¡”Lšk
 *
	mlšk
;

129 
li¡
 *
	mç_»pÜts
;

130 } 
	tşu¡”Node
;

132 
	sşu¡”S‹
 {

133 
şu¡”Node
 *
	mmy£lf
;

134 
ušt64_t
 
	mcu¼’tEpoch
;

135 
	m¡©e
;

136 
	msize
;

137 
diù
 *
	mnodes
;

138 
diù
 *
	mnodes_bÏck_li¡
;

139 
şu¡”Node
 *
	mmig¿tšg_¦Ùs_to
[
CLUSTER_SLOTS
];

140 
şu¡”Node
 *
	mimpÜtšg_¦Ùs_äom
[
CLUSTER_SLOTS
];

141 
şu¡”Node
 *
	m¦Ùs
[
CLUSTER_SLOTS
];

142 
ušt64_t
 
	m¦Ùs_keys_couÁ
[
CLUSTER_SLOTS
];

143 
¿x
 *
	m¦Ùs_to_keys
;

145 
m¡ime_t
 
	mçov”_auth_time
;

146 
	mçov”_auth_couÁ
;

147 
	mçov”_auth_£Á
;

148 
	mçov”_auth_¿nk
;

149 
ušt64_t
 
	mçov”_auth_•och
;

150 
	mÿÁ_çov”_»asÚ
;

153 
m¡ime_t
 
	mmf_’d
;

156 
şu¡”Node
 *
	mmf_¦ave
;

158 
	mmf_ma¡”_off£t
;

160 
	mmf_ÿn_¡¬t
;

163 
ušt64_t
 
	mÏ¡VÙeEpoch
;

164 
	mtodo_befÜe_¦“p
;

166 
	m¡©s_bus_mes§ges_£Á
[
CLUSTERMSG_TYPE_COUNT
];

167 
	m¡©s_bus_mes§ges_»ûived
[
CLUSTERMSG_TYPE_COUNT
];

168 
	m¡©s_pç_nodes
;

170 } 
	tşu¡”S‹
;

178 
	mnod’ame
[
CLUSTER_NAMELEN
];

179 
ušt32_t
 
	mpšg_£Á
;

180 
ušt32_t
 
	mpÚg_»ûived
;

181 
	m
[
NET_IP_STR_LEN
];

182 
ušt16_t
 
	mpÜt
;

183 
ušt16_t
 
	mıÜt
;

184 
ušt16_t
 
	mæags
;

185 
ušt32_t
 
	mnÙu£d1
;

186 } 
	tşu¡”MsgD©aGoss
;

189 
	mnod’ame
[
CLUSTER_NAMELEN
];

190 } 
	tşu¡”MsgD©aFa
;

193 
ušt32_t
 
	mchªÃl_Ën
;

194 
ušt32_t
 
	mmes§ge_Ën
;

198 
	mbulk_d©a
[8];

199 } 
	tşu¡”MsgD©aPublish
;

202 
ušt64_t
 
	mcÚfigEpoch
;

203 
	mnod’ame
[
CLUSTER_NAMELEN
];

204 
	m¦Ùs
[
CLUSTER_SLOTS
/8];

205 } 
	tşu¡”MsgD©aUpd©e
;

207 
	uşu¡”MsgD©a
 {

211 
şu¡”MsgD©aGoss
 
	mgoss
[1];

212 } 
	mpšg
;

216 
şu¡”MsgD©aFa
 
	mabout
;

217 } 
	mç
;

221 
şu¡”MsgD©aPublish
 
	mmsg
;

222 } 
	mpublish
;

226 
şu¡”MsgD©aUpd©e
 
	mnodecfg
;

227 } 
	mupd©e
;

230 
	#CLUSTER_PROTO_VER
 1

	)

233 
	msig
[4];

234 
ušt32_t
 
	mtÙËn
;

235 
ušt16_t
 
	mv”
;

236 
ušt16_t
 
	mpÜt
;

237 
ušt16_t
 
	mty³
;

238 
ušt16_t
 
	mcouÁ
;

239 
ušt64_t
 
	mcu¼’tEpoch
;

240 
ušt64_t
 
	mcÚfigEpoch
;

243 
ušt64_t
 
	moff£t
;

245 
	m£nd”
[
CLUSTER_NAMELEN
];

246 
	mmy¦Ùs
[
CLUSTER_SLOTS
/8];

247 
	m¦aveof
[
CLUSTER_NAMELEN
];

248 
	mmy
[
NET_IP_STR_LEN
];

249 
	mnÙu£d1
[34];

250 
ušt16_t
 
	mıÜt
;

251 
ušt16_t
 
	mæags
;

252 
	m¡©e
;

253 
	mmæags
[3];

254 
şu¡”MsgD©a
 
	md©a
;

255 } 
	tşu¡”Msg
;

257 
	#CLUSTERMSG_MIN_LEN
 ((
şu¡”Msg
)-(
şu¡”MsgD©a
))

	)

261 
	#CLUSTERMSG_FLAG0_PAUSED
 (1<<0è

	)

262 
	#CLUSTERMSG_FLAG0_FORCEACK
 (1<<1è

	)

266 
şu¡”Node
 *
g‘NodeByQu”y
(
ş›Á
 *
c
, 
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
hash¦Ù
, *
ask
);

267 
şu¡”RedœeùBlockedCl›ÁIfN“ded
(
ş›Á
 *
c
);

268 
şu¡”RedœeùCl›Á
(
ş›Á
 *
c
, 
şu¡”Node
 *
n
, 
hash¦Ù
, 
”rÜ_code
);

	@config.c

31 
	~"£rv”.h
"

32 
	~"şu¡”.h
"

34 
	~<fú.h
>

35 
	~<sys/¡©.h
>

41 
	scÚfigEnum
 {

42 cÚ¡ *
	mÇme
;

43 cÚ¡ 
	mv®
;

44 } 
	tcÚfigEnum
;

46 
cÚfigEnum
 
	gmaxmemÜy_pŞicy_’um
[] = {

47 {"vŞ©e-Ìu", 
MAXMEMORY_VOLATILE_LRU
},

48 {"vŞ©e-lfu", 
MAXMEMORY_VOLATILE_LFU
},

49 {"vŞ©e-¿ndom",
MAXMEMORY_VOLATILE_RANDOM
},

50 {"vŞ©e-‰l",
MAXMEMORY_VOLATILE_TTL
},

51 {"®lkeys-Ìu",
MAXMEMORY_ALLKEYS_LRU
},

52 {"®lkeys-lfu",
MAXMEMORY_ALLKEYS_LFU
},

53 {"®lkeys-¿ndom",
MAXMEMORY_ALLKEYS_RANDOM
},

54 {"nÛviùiÚ",
MAXMEMORY_NO_EVICTION
},

55 {
NULL
, 0}

58 
cÚfigEnum
 
	gsy¦og_çc™y_’um
[] = {

59 {"u£r", 
LOG_USER
},

60 {"loÿl0", 
LOG_LOCAL0
},

61 {"loÿl1", 
LOG_LOCAL1
},

62 {"loÿl2", 
LOG_LOCAL2
},

63 {"loÿl3", 
LOG_LOCAL3
},

64 {"loÿl4", 
LOG_LOCAL4
},

65 {"loÿl5", 
LOG_LOCAL5
},

66 {"loÿl6", 
LOG_LOCAL6
},

67 {"loÿl7", 
LOG_LOCAL7
},

68 {
NULL
, 0}

71 
cÚfigEnum
 
	glogËv–_’um
[] = {

72 {"debug", 
LL_DEBUG
},

73 {"v”bo£", 
LL_VERBOSE
},

74 {"nÙiû", 
LL_NOTICE
},

75 {"w¬nšg", 
LL_WARNING
},

76 {
NULL
,0}

79 
cÚfigEnum
 
	gsu³rvi£d_mode_’um
[] = {

80 {"up¡¬t", 
SUPERVISED_UPSTART
},

81 {"sy¡emd", 
SUPERVISED_SYSTEMD
},

82 {"auto", 
SUPERVISED_AUTODETECT
},

83 {"no", 
SUPERVISED_NONE
},

84 {
NULL
, 0}

87 
cÚfigEnum
 
	gaof_fsync_’um
[] = {

88 {"ev”y£c", 
AOF_FSYNC_EVERYSEC
},

89 {"®ways", 
AOF_FSYNC_ALWAYS
},

90 {"no", 
AOF_FSYNC_NO
},

91 {
NULL
, 0}

95 
ş›ÁBufãrLim™sCÚfig
 
	gş›ÁBufãrLim™sDeçuÉs
[
CLIENT_TYPE_OBUF_COUNT
] = {

106 
	$cÚfigEnumG‘V®ue
(
cÚfigEnum
 *
û
, *
Çme
) {

107 
û
->
Çme
 !ğ
NULL
) {

108 ià(!
	`¡rÿ£cmp
(
û
->
Çme
,Çme)è ce->
v®
;

109 
û
++;

111  
INT_MIN
;

112 
	}
}

115 cÚ¡ *
	$cÚfigEnumG‘Name
(
cÚfigEnum
 *
û
, 
v®
) {

116 
û
->
Çme
 !ğ
NULL
) {

117 ià(
û
->
v®
 =ğv®è ce->
Çme
;

118 
û
++;

120  
NULL
;

121 
	}
}

125 cÚ¡ *
	$cÚfigEnumG‘NameOrUnknown
(
cÚfigEnum
 *
û
, 
v®
) {

126 cÚ¡ *
Çme
 = 
	`cÚfigEnumG‘Name
(
û
,
v®
);

127  
Çme
 ?‚ame : "unknown";

128 
	}
}

131 cÚ¡ *
	$eviùPŞicyToSŒšg
() {

132  
	`cÚfigEnumG‘NameOrUnknown
(
maxmemÜy_pŞicy_’um
,
£rv”
.
maxmemÜy_pŞicy
);

133 
	}
}

139 
	$ye¢Ùoi
(*
s
) {

140 ià(!
	`¡rÿ£cmp
(
s
,"yes"))  1;

141 ià(!
	`¡rÿ£cmp
(
s
,"no"))  0;

143 
	}
}

145 
	$­³ndS”v”SaveP¬ams
(
time_t
 
£cÚds
, 
chªges
) {

146 
£rv”
.
§v•¬ams
 = 
	`z»®loc
(£rv”.§v•¬ams,(
§v•¬am
)*(£rv”.
§v•¬am¦’
+1));

147 
£rv”
.
§v•¬ams
[£rv”.
§v•¬am¦’
].
£cÚds
 = seconds;

148 
£rv”
.
§v•¬ams
[£rv”.
§v•¬am¦’
].
chªges
 = changes;

149 
£rv”
.
§v•¬am¦’
++;

150 
	}
}

152 
	$»£tS”v”SaveP¬ams
() {

153 
	`zä“
(
£rv”
.
§v•¬ams
);

154 
£rv”
.
§v•¬ams
 = 
NULL
;

155 
£rv”
.
§v•¬am¦’
 = 0;

156 
	}
}

158 
	$queueLßdModuË
(
sds
 
·th
, sd *
¬gv
, 
¬gc
) {

159 
i
;

160 
moduËLßdQueueEÁry
 *
lßdmod
;

162 
lßdmod
 = 
	`zm®loc
((
moduËLßdQueueEÁry
));

163 
lßdmod
->
¬gv
 = 
	`zm®loc
((
robj
*)*
¬gc
);

164 
lßdmod
->
·th
 = 
	`sd¢ew
(path);

165 
lßdmod
->
¬gc
 =‡rgc;

166 
i
 = 0; i < 
¬gc
; i++) {

167 
lßdmod
->
¬gv
[
i
] = 
	`ü—‹RawSŒšgObjeù
×rgv[i],
	`sd¦’
(argv[i]));

169 
	`li¡AddNodeTa
(
£rv”
.
lßdmoduË_queue
,
lßdmod
);

170 
	}
}

172 
	$lßdS”v”CÚfigFromSŒšg
(*
cÚfig
) {

173 *
”r
 = 
NULL
;

174 
lš’um
 = 0, 
tÙlšes
, 
i
;

175 
¦aveof_lš’um
 = 0;

176 
sds
 *
lšes
;

178 
lšes
 = 
	`sds¥l™Ën
(
cÚfig
,
	`¡¾’
(cÚfig),"\n",1,&
tÙlšes
);

180 
i
 = 0; i < 
tÙlšes
; i++) {

181 
sds
 *
¬gv
;

182 
¬gc
;

184 
lš’um
 = 
i
+1;

185 
lšes
[
i
] = 
	`sd¡rim
(lines[i]," \t\r\n");

188 ià(
lšes
[
i
][0] == '#' ||†ines[i][0] == '\0') ;

191 
¬gv
 = 
	`sds¥l™¬gs
(
lšes
[
i
],&
¬gc
);

192 ià(
¬gv
 =ğ
NULL
) {

193 
”r
 = "Unbalanced quotes in configuration†ine";

194 
lßd”r
;

198 ià(
¬gc
 == 0) {

199 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

202 
	`sd¡Şow”
(
¬gv
[0]);

205 ià(!
	`¡rÿ£cmp
(
¬gv
[0],"timeout"è&& 
¬gc
 == 2) {

206 
£rv”
.
maxidËtime
 = 
	`©oi
(
¬gv
[1]);

207 ià(
£rv”
.
maxidËtime
 < 0) {

208 
”r
 = "Inv®idimeouˆv®ue"; 
lßd”r
;

210 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"tı-k“·live"è&& 
¬gc
 == 2) {

211 
£rv”
.
tık“·live
 = 
	`©oi
(
¬gv
[1]);

212 ià(
£rv”
.
tık“·live
 < 0) {

213 
”r
 = "Inv®idı-k“·livv®ue"; 
lßd”r
;

215 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"´Ùeùed-mode"è&& 
¬gc
 == 2) {

216 ià((
£rv”
.
´Ùeùed_mode
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

217 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

219 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"pÜt"è&& 
¬gc
 == 2) {

220 
£rv”
.
pÜt
 = 
	`©oi
(
¬gv
[1]);

221 ià(
£rv”
.
pÜt
 < 0 || server.port > 65535) {

222 
”r
 = "Inv®id…Üt"; 
lßd”r
;

224 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"tı-backlog"è&& 
¬gc
 == 2) {

225 
£rv”
.
tı_backlog
 = 
	`©oi
(
¬gv
[1]);

226 ià(
£rv”
.
tı_backlog
 < 0) {

227 
”r
 = "Inv®id backlog v®ue"; 
lßd”r
;

229 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"bšd"è&& 
¬gc
 >= 2) {

230 
j
, 
add»s£s
 = 
¬gc
-1;

232 ià(
add»s£s
 > 
CONFIG_BINDADDR_MAX
) {

233 
”r
 = "ToØmªy bšd‡dd»s£ ¥ecif›d"; 
lßd”r
;

235 
j
 = 0; j < 
add»s£s
; j++)

236 
£rv”
.
bšdaddr
[
j
] = 
	`z¡rdup
(
¬gv
[j+1]);

237 
£rv”
.
bšdaddr_couÁ
 = 
add»s£s
;

238 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"unixsock‘"è&& 
¬gc
 == 2) {

239 
£rv”
.
unixsock‘
 = 
	`z¡rdup
(
¬gv
[1]);

240 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"unixsock‘³rm"è&& 
¬gc
 == 2) {

241 
”ºo
 = 0;

242 
£rv”
.
unixsock‘³rm
 = (
mode_t
)
	`¡¹Ş
(
¬gv
[1], 
NULL
, 8);

243 ià(
”ºo
 || 
£rv”
.
unixsock‘³rm
 > 0777) {

244 
”r
 = "Inv®id sock‘ f³rmissiÚs"; 
lßd”r
;

246 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"save")) {

247 ià(
¬gc
 == 3) {

248 
£cÚds
 = 
	`©oi
(
¬gv
[1]);

249 
chªges
 = 
	`©oi
(
¬gv
[2]);

250 ià(
£cÚds
 < 1 || 
chªges
 < 0) {

251 
”r
 = "Inv®id sav·¿m‘”s"; 
lßd”r
;

253 
	`­³ndS”v”SaveP¬ams
(
£cÚds
,
chªges
);

254 } ià(
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(
¬gv
[1],"")) {

255 
	`»£tS”v”SaveP¬ams
();

257 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"dœ"è&& 
¬gc
 == 2) {

258 ià(
	`chdœ
(
¬gv
[1]) == -1) {

259 
	`£rv”Log
(
LL_WARNING
,"Can't chdiro '%s': %s",

260 
¬gv
[1], 
	`¡»¼Ü
(
”ºo
));

261 
	`ex™
(1);

263 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"logËv–"è&& 
¬gc
 == 2) {

264 
£rv”
.
v”bos™y
 = 
	`cÚfigEnumG‘V®ue
(
logËv–_’um
,
¬gv
[1]);

265 ià(
£rv”
.
v”bos™y
 =ğ
INT_MIN
) {

266 
”r
 = "Invalid†og†evel. "

268 
lßd”r
;

270 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"logfe"è&& 
¬gc
 == 2) {

271 
FILE
 *
logå
;

273 
	`zä“
(
£rv”
.
logfe
);

274 
£rv”
.
logfe
 = 
	`z¡rdup
(
¬gv
[1]);

275 ià(
£rv”
.
logfe
[0] != '\0') {

278 
logå
 = 
	`fİ’
(
£rv”
.
logfe
,"a");

279 ià(
logå
 =ğ
NULL
) {

280 
”r
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

281 "Cª'ˆİ’hlog fe: %s", 
	`¡»¼Ü
(
”ºo
));

282 
lßd”r
;

284 
	`fşo£
(
logå
);

286 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"®ways-show-logo"è&& 
¬gc
 == 2) {

287 ià((
£rv”
.
®ways_show_logo
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

288 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

290 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"sy¦og-’abËd"è&& 
¬gc
 == 2) {

291 ià((
£rv”
.
sy¦og_’abËd
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

292 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

294 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"sy¦og-id’t"è&& 
¬gc
 == 2) {

295 ià(
£rv”
.
sy¦og_id’t
è
	`zä“
(server.syslog_ident);

296 
£rv”
.
sy¦og_id’t
 = 
	`z¡rdup
(
¬gv
[1]);

297 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"sy¦og-çc™y"è&& 
¬gc
 == 2) {

298 
£rv”
.
sy¦og_çc™y
 =

299 
	`cÚfigEnumG‘V®ue
(
sy¦og_çc™y_’um
,
¬gv
[1]);

300 ià(
£rv”
.
sy¦og_çc™y
 =ğ
INT_MIN
) {

301 
”r
 = "Invalid†og facility. Must be one of USER or between LOCAL0-LOCAL7";

302 
lßd”r
;

304 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"d©aba£s"è&& 
¬gc
 == 2) {

305 
£rv”
.
dbnum
 = 
	`©oi
(
¬gv
[1]);

306 ià(
£rv”
.
dbnum
 < 1) {

307 
”r
 = "Inv®id‚umb” oàd©aba£s"; 
lßd”r
;

309 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"šşude"è&& 
¬gc
 == 2) {

310 
	`lßdS”v”CÚfig
(
¬gv
[1],
NULL
);

311 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"maxş›Ás"è&& 
¬gc
 == 2) {

312 
£rv”
.
maxş›Ás
 = 
	`©oi
(
¬gv
[1]);

313 ià(
£rv”
.
maxş›Ás
 < 1) {

314 
”r
 = "Inv®id max cl›Á lim™"; 
lßd”r
;

316 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"maxmemÜy"è&& 
¬gc
 == 2) {

317 
£rv”
.
maxmemÜy
 = 
	`memtŞl
(
¬gv
[1],
NULL
);

318 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"maxmemÜy-pŞicy"è&& 
¬gc
 == 2) {

319 
£rv”
.
maxmemÜy_pŞicy
 =

320 
	`cÚfigEnumG‘V®ue
(
maxmemÜy_pŞicy_’um
,
¬gv
[1]);

321 ià(
£rv”
.
maxmemÜy_pŞicy
 =ğ
INT_MIN
) {

322 
”r
 = "Invalid maxmemory…olicy";

323 
lßd”r
;

325 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"maxmemÜy-§m¶es"è&& 
¬gc
 == 2) {

326 
£rv”
.
maxmemÜy_§m¶es
 = 
	`©oi
(
¬gv
[1]);

327 ià(
£rv”
.
maxmemÜy_§m¶es
 <= 0) {

328 
”r
 = "maxmemory-samples must be 1 or greater";

329 
lßd”r
;

331 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"lfu-log-çùÜ"è&& 
¬gc
 == 2) {

332 
£rv”
.
lfu_log_çùÜ
 = 
	`©oi
(
¬gv
[1]);

333 ià(
£rv”
.
maxmemÜy_§m¶es
 < 0) {

334 
”r
 = "lfu-log-factor must be 0 or greater";

335 
lßd”r
;

337 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"lfu-deÿy-time"è&& 
¬gc
 == 2) {

338 
£rv”
.
lfu_deÿy_time
 = 
	`©oi
(
¬gv
[1]);

339 ià(
£rv”
.
maxmemÜy_§m¶es
 < 1) {

340 
”r
 = "lfu-decay-time must be 0 or greater";

341 
lßd”r
;

343 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"¦aveof"è&& 
¬gc
 == 3) {

344 
¦aveof_lš’um
 = 
lš’um
;

345 
£rv”
.
ma¡”ho¡
 = 
	`sd¢ew
(
¬gv
[1]);

346 
£rv”
.
ma¡”pÜt
 = 
	`©oi
(
¬gv
[2]);

347 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_CONNECT
;

348 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»¶-pšg-¦ave-³riod"è&& 
¬gc
 == 2) {

349 
£rv”
.
»¶_pšg_¦ave_³riod
 = 
	`©oi
(
¬gv
[1]);

350 ià(
£rv”
.
»¶_pšg_¦ave_³riod
 <= 0) {

351 
”r
 = "repl-ping-slave-period must be 1 or greater";

352 
lßd”r
;

354 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»¶-timeout"è&& 
¬gc
 == 2) {

355 
£rv”
.
»¶_timeout
 = 
	`©oi
(
¬gv
[1]);

356 ià(
£rv”
.
»¶_timeout
 <= 0) {

357 
”r
 = "repl-timeout must be 1 or greater";

358 
lßd”r
;

360 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»¶-di§bË-tı-nod–ay"è&& 
¬gc
==2) {

361 ià((
£rv”
.
»¶_di§bË_tı_nod–ay
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

362 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

364 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»¶-diskËss-sync"è&& 
¬gc
==2) {

365 ià((
£rv”
.
»¶_diskËss_sync
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

366 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

368 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»¶-diskËss-sync-d–ay"è&& 
¬gc
==2) {

369 
£rv”
.
»¶_diskËss_sync_d–ay
 = 
	`©oi
(
¬gv
[1]);

370 ià(
£rv”
.
»¶_diskËss_sync_d–ay
 < 0) {

371 
”r
 = "repl-diskless-sync-delay can't be‚egative";

372 
lßd”r
;

374 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»¶-backlog-size"è&& 
¬gc
 == 2) {

375 
size
 = 
	`memtŞl
(
¬gv
[1],
NULL
);

376 ià(
size
 <= 0) {

377 
”r
 = "repl-backlog-size must be 1 or greater.";

378 
lßd”r
;

380 
	`»sizeR•liÿtiÚBacklog
(
size
);

381 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»¶-backlog-‰l"è&& 
¬gc
 == 2) {

382 
£rv”
.
»¶_backlog_time_lim™
 = 
	`©oi
(
¬gv
[1]);

383 ià(
£rv”
.
»¶_backlog_time_lim™
 < 0) {

384 
”r
 = "repl-backlog-ttl can't be‚egative ";

385 
lßd”r
;

387 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"ma¡”auth"è&& 
¬gc
 == 2) {

388 
	`zä“
(
£rv”
.
ma¡”auth
);

389 
£rv”
.
ma¡”auth
 = 
	`z¡rdup
(
¬gv
[1]);

390 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"¦ave-£rve-¡®e-d©a"è&& 
¬gc
 == 2) {

391 ià((
£rv”
.
»¶_£rve_¡®e_d©a
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

392 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

394 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"¦ave-»ad-Úly"è&& 
¬gc
 == 2) {

395 ià((
£rv”
.
»¶_¦ave_ro
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

396 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

398 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"rdbcom´essiÚ"è&& 
¬gc
 == 2) {

399 ià((
£rv”
.
rdb_com´essiÚ
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

400 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

402 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"rdbchecksum"è&& 
¬gc
 == 2) {

403 ià((
£rv”
.
rdb_checksum
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

404 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

406 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"aùiv”ehashšg"è&& 
¬gc
 == 2) {

407 ià((
£rv”
.
aùiv”ehashšg
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

408 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

410 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"Ïzyä“-Ïzy-eviùiÚ"è&& 
¬gc
 == 2) {

411 ià((
£rv”
.
Ïzyä“_Ïzy_eviùiÚ
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

412 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

414 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"Ïzyä“-Ïzy-expœe"è&& 
¬gc
 == 2) {

415 ià((
£rv”
.
Ïzyä“_Ïzy_expœe
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

416 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

418 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"Ïzyä“-Ïzy-£rv”-d–"è&& 
¬gc
 == 2){

419 ià((
£rv”
.
Ïzyä“_Ïzy_£rv”_d–
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

420 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

422 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"¦ave-Ïzy-æush"è&& 
¬gc
 == 2) {

423 ià((
£rv”
.
»¶_¦ave_Ïzy_æush
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

424 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

426 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"aùivedeäag"è&& 
¬gc
 == 2) {

427 ià((
£rv”
.
aùive_deäag_’abËd
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

428 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

430 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"d«mÚize"è&& 
¬gc
 == 2) {

431 ià((
£rv”
.
d«mÚize
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

432 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

434 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"hz"è&& 
¬gc
 == 2) {

435 
£rv”
.
hz
 = 
	`©oi
(
¬gv
[1]);

436 ià(
£rv”
.
hz
 < 
CONFIG_MIN_HZ
) server.hz = CONFIG_MIN_HZ;

437 ià(
£rv”
.
hz
 > 
CONFIG_MAX_HZ
) server.hz = CONFIG_MAX_HZ;

438 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"­³ndÚly"è&& 
¬gc
 == 2) {

439 
yes
;

441 ià((
yes
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

442 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

444 
£rv”
.
aof_¡©e
 = 
yes
 ? 
AOF_ON
 : 
AOF_OFF
;

445 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"­³ndf’ame"è&& 
¬gc
 == 2) {

446 ià(!
	`·thIsBa£Name
(
¬gv
[1])) {

447 
”r
 = "appendfilename can't be‡…ath, just‡ filename";

448 
lßd”r
;

450 
	`zä“
(
£rv”
.
aof_f’ame
);

451 
£rv”
.
aof_f’ame
 = 
	`z¡rdup
(
¬gv
[1]);

452 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"no-appendfsync-on-rewrite")

453 && 
¬gc
 == 2) {

454 ià((
£rv”
.
aof_no_fsync_Ú_»wr™e
ğ
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

455 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

457 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"­³ndfsync"è&& 
¬gc
 == 2) {

458 
£rv”
.
aof_fsync
 = 
	`cÚfigEnumG‘V®ue
(
aof_fsync_’um
,
¬gv
[1]);

459 ià(
£rv”
.
aof_fsync
 =ğ
INT_MIN
) {

460 
”r
 = "argument must be 'no', 'always' or 'everysec'";

461 
lßd”r
;

463 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"auto-aof-rewrite-percentage") &&

464 
¬gc
 == 2)

466 
£rv”
.
aof_»wr™e_³rc
 = 
	`©oi
(
¬gv
[1]);

467 ià(
£rv”
.
aof_»wr™e_³rc
 < 0) {

468 
”r
 = "Invalid‚egative…ercentage for AOF‡uto„ewrite";

469 
lßd”r
;

471 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"auto-aof-rewrite-min-size") &&

472 
¬gc
 == 2)

474 
£rv”
.
aof_»wr™e_mš_size
 = 
	`memtŞl
(
¬gv
[1],
NULL
);

475 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"aof-rewrite-incremental-fsync") &&

476 
¬gc
 == 2)

478 ià((
£rv”
.
aof_»wr™e_šüem’l_fsync
 =

479 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

480 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

482 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"aof-lßd-Œunÿ‹d"è&& 
¬gc
 == 2) {

483 ià((
£rv”
.
aof_lßd_Œunÿ‹d
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

484 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

486 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"aof-u£-rdb-´—mbË"è&& 
¬gc
 == 2) {

487 ià((
£rv”
.
aof_u£_rdb_´—mbË
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

488 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

490 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»quœ•ass"è&& 
¬gc
 == 2) {

491 ià(
	`¡¾’
(
¬gv
[1]è> 
CONFIG_AUTHPASS_MAX_LEN
) {

492 
”r
 = "Password is†ongerhan CONFIG_AUTHPASS_MAX_LEN";

493 
lßd”r
;

495 
£rv”
.
»quœ•ass
 = 
	`z¡rdup
(
¬gv
[1]);

496 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"pidfe"è&& 
¬gc
 == 2) {

497 
	`zä“
(
£rv”
.
pidfe
);

498 
£rv”
.
pidfe
 = 
	`z¡rdup
(
¬gv
[1]);

499 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"dbf’ame"è&& 
¬gc
 == 2) {

500 ià(!
	`·thIsBa£Name
(
¬gv
[1])) {

501 
”r
 = "dbfilename can't be‡…ath, just‡ filename";

502 
lßd”r
;

504 
	`zä“
(
£rv”
.
rdb_f’ame
);

505 
£rv”
.
rdb_f’ame
 = 
	`z¡rdup
(
¬gv
[1]);

506 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"aùive-deäag-th»shŞd-low”"è&& 
¬gc
 == 2) {

507 
£rv”
.
aùive_deäag_th»shŞd_low”
 = 
	`©oi
(
¬gv
[1]);

508 ià(
£rv”
.
aùive_deäag_th»shŞd_low”
 < 0) {

509 
”r
 = "active-defrag-threshold-lower must be 0 or greater";

510 
lßd”r
;

512 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"aùive-deäag-th»shŞd-uµ”"è&& 
¬gc
 == 2) {

513 
£rv”
.
aùive_deäag_th»shŞd_uµ”
 = 
	`©oi
(
¬gv
[1]);

514 ià(
£rv”
.
aùive_deäag_th»shŞd_uµ”
 < 0) {

515 
”r
 = "active-defrag-threshold-upper must be 0 or greater";

516 
lßd”r
;

518 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"aùive-deäag-ignÜe-by‹s"è&& 
¬gc
 == 2) {

519 
£rv”
.
aùive_deäag_ignÜe_by‹s
 = 
	`memtŞl
(
¬gv
[1], 
NULL
);

520 ià(
£rv”
.
aùive_deäag_ignÜe_by‹s
 <= 0) {

521 
”r
 = "active-defrag-ignore-bytes must‡bove 0";

522 
lßd”r
;

524 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"aùive-deäag-cyşe-mš"è&& 
¬gc
 == 2) {

525 
£rv”
.
aùive_deäag_cyşe_mš
 = 
	`©oi
(
¬gv
[1]);

526 ià(
£rv”
.
aùive_deäag_cyşe_mš
 < 1 || server.active_defrag_cycle_min > 99) {

527 
”r
 = "active-defrag-cycle-min must be between 1‡nd 99";

528 
lßd”r
;

530 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"aùive-deäag-cyşe-max"è&& 
¬gc
 == 2) {

531 
£rv”
.
aùive_deäag_cyşe_max
 = 
	`©oi
(
¬gv
[1]);

532 ià(
£rv”
.
aùive_deäag_cyşe_max
 < 1 || server.active_defrag_cycle_max > 99) {

533 
”r
 = "active-defrag-cycle-max must be between 1‡nd 99";

534 
lßd”r
;

536 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"hash-max-zli¡-’Œ›s"è&& 
¬gc
 == 2) {

537 
£rv”
.
hash_max_zli¡_’Œ›s
 = 
	`memtŞl
(
¬gv
[1], 
NULL
);

538 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"hash-max-zli¡-v®ue"è&& 
¬gc
 == 2) {

539 
£rv”
.
hash_max_zli¡_v®ue
 = 
	`memtŞl
(
¬gv
[1], 
NULL
);

540 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"li¡-max-zli¡-’Œ›s"è&& 
¬gc
 == 2){

542 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"li¡-max-zli¡-v®ue"è&& 
¬gc
 == 2) {

544 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"li¡-max-zli¡-size"è&& 
¬gc
 == 2) {

545 
£rv”
.
li¡_max_zli¡_size
 = 
	`©oi
(
¬gv
[1]);

546 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"li¡-com´ess-d•th"è&& 
¬gc
 == 2) {

547 
£rv”
.
li¡_com´ess_d•th
 = 
	`©oi
(
¬gv
[1]);

548 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"£t-max-št£t-’Œ›s"è&& 
¬gc
 == 2) {

549 
£rv”
.
£t_max_št£t_’Œ›s
 = 
	`memtŞl
(
¬gv
[1], 
NULL
);

550 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"z£t-max-zli¡-’Œ›s"è&& 
¬gc
 == 2) {

551 
£rv”
.
z£t_max_zli¡_’Œ›s
 = 
	`memtŞl
(
¬gv
[1], 
NULL
);

552 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"z£t-max-zli¡-v®ue"è&& 
¬gc
 == 2) {

553 
£rv”
.
z£t_max_zli¡_v®ue
 = 
	`memtŞl
(
¬gv
[1], 
NULL
);

554 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"hÎ-¥¬£-max-by‹s"è&& 
¬gc
 == 2) {

555 
£rv”
.
hÎ_¥¬£_max_by‹s
 = 
	`memtŞl
(
¬gv
[1], 
NULL
);

556 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»Çme-commªd"è&& 
¬gc
 == 3) {

557 
»disCommªd
 *
cmd
 = 
	`lookupCommªd
(
¬gv
[1]);

558 
»tv®
;

560 ià(!
cmd
) {

561 
”r
 = "No such command in„ename-command";

562 
lßd”r
;

567 
»tv®
 = 
	`diùD–‘e
(
£rv”
.
commªds
, 
¬gv
[1]);

568 
	`£rv”As£¹
(
»tv®
 =ğ
DICT_OK
);

571 ià(
	`sd¦’
(
¬gv
[2]) != 0) {

572 
sds
 
cİy
 = 
	`sdsdup
(
¬gv
[2]);

574 
»tv®
 = 
	`diùAdd
(
£rv”
.
commªds
, 
cİy
, 
cmd
);

575 ià(
»tv®
 !ğ
DICT_OK
) {

576 
	`sdsä“
(
cİy
);

577 
”r
 = "T¬g‘ commªd‚am®»adyƒxi¡s"; 
lßd”r
;

580 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"şu¡”-’abËd"è&& 
¬gc
 == 2) {

581 ià((
£rv”
.
şu¡”_’abËd
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

582 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

584 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"şu¡”-cÚfig-fe"è&& 
¬gc
 == 2) {

585 
	`zä“
(
£rv”
.
şu¡”_cÚfigfe
);

586 
£rv”
.
şu¡”_cÚfigfe
 = 
	`z¡rdup
(
¬gv
[1]);

587 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"şu¡”-ªnounû-"è&& 
¬gc
 == 2) {

588 
	`zä“
(
£rv”
.
şu¡”_ªnounû_
);

589 
£rv”
.
şu¡”_ªnounû_
 = 
	`z¡rdup
(
¬gv
[1]);

590 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"şu¡”-ªnounû-pÜt"è&& 
¬gc
 == 2) {

591 
£rv”
.
şu¡”_ªnounû_pÜt
 = 
	`©oi
(
¬gv
[1]);

592 ià(
£rv”
.
şu¡”_ªnounû_pÜt
 < 0 ||

593 
£rv”
.
şu¡”_ªnounû_pÜt
 > 65535)

595 
”r
 = "Inv®id…Üt"; 
lßd”r
;

597 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"cluster-announce-bus-port") &&

598 
¬gc
 == 2)

600 
£rv”
.
şu¡”_ªnounû_bus_pÜt
 = 
	`©oi
(
¬gv
[1]);

601 ià(
£rv”
.
şu¡”_ªnounû_bus_pÜt
 < 0 ||

602 
£rv”
.
şu¡”_ªnounû_bus_pÜt
 > 65535)

604 
”r
 = "Inv®id…Üt"; 
lßd”r
;

606 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"cluster-require-full-coverage") &&

607 
¬gc
 == 2)

609 ià((
£rv”
.
şu¡”_»quœe_fuÎ_cov”age
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1)

611 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

613 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"şu¡”-node-timeout"è&& 
¬gc
 == 2) {

614 
£rv”
.
şu¡”_node_timeout
 = 
	`¡¹Şl
(
¬gv
[1],
NULL
,10);

615 ià(
£rv”
.
şu¡”_node_timeout
 <= 0) {

616 
”r
 = "şu¡”‚odtimeouˆmu¡ b1 o¸g»©”"; 
lßd”r
;

618 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"cluster-migration-barrier")

619 && 
¬gc
 == 2)

621 
£rv”
.
şu¡”_mig¿tiÚ_b¬r›r
 = 
	`©oi
(
¬gv
[1]);

622 ià(
£rv”
.
şu¡”_mig¿tiÚ_b¬r›r
 < 0) {

623 
”r
 = "cluster migration barrier must zero or…ositive";

624 
lßd”r
;

626 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"cluster-slave-validity-factor")

627 && 
¬gc
 == 2)

629 
£rv”
.
şu¡”_¦ave_v®id™y_çùÜ
 = 
	`©oi
(
¬gv
[1]);

630 ià(
£rv”
.
şu¡”_¦ave_v®id™y_çùÜ
 < 0) {

631 
”r
 = "cluster slave validity factor must be zero or…ositive";

632 
lßd”r
;

634 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"lua-time-lim™"è&& 
¬gc
 == 2) {

635 
£rv”
.
lua_time_lim™
 = 
	`¡¹Şl
(
¬gv
[1],
NULL
,10);

636 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"slowlog-log-slower-than") &&

637 
¬gc
 == 2)

639 
£rv”
.
¦owlog_log_¦ow”_thª
 = 
	`¡¹Şl
(
¬gv
[1],
NULL
,10);

640 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"latency-monitor-threshold") &&

641 
¬gc
 == 2)

643 
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
 = 
	`¡¹Şl
(
¬gv
[1],
NULL
,10);

644 ià(
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
 < 0) {

645 
”r
 = "The†atencyhreshold can't be‚egative";

646 
lßd”r
;

648 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"¦owlog-max-Ën"è&& 
¬gc
 == 2) {

649 
£rv”
.
¦owlog_max_Ën
 = 
	`¡¹Şl
(
¬gv
[1],
NULL
,10);

650 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"client-output-buffer-limit") &&

651 
¬gc
 == 5)

653 
şass
 = 
	`g‘Cl›ÁTy³ByName
(
¬gv
[1]);

654 
h¬d
, 
soá
;

655 
soá_£cÚds
;

657 ià(
şass
 =ğ-1 || cÏs =ğ
CLIENT_TYPE_MASTER
) {

658 
”r
 = "Unrecognized client†imit class:he user specified "

660 
lßd”r
;

662 
h¬d
 = 
	`memtŞl
(
¬gv
[2],
NULL
);

663 
soá
 = 
	`memtŞl
(
¬gv
[3],
NULL
);

664 
soá_£cÚds
 = 
	`©oi
(
¬gv
[4]);

665 ià(
soá_£cÚds
 < 0) {

666 
”r
 = "Negative‚umber of seconds in soft†imit is invalid";

667 
lßd”r
;

669 
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
h¬d_lim™_by‹s
 = 
h¬d
;

670 
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_by‹s
 = 
soá
;

671 
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_£cÚds
 = 
soá_£cÚds
;

672 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"stop-writes-on-bgsave-error") &&

673 
¬gc
 == 2) {

674 ià((
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

675 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

677 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"¦ave-´iÜ™y"è&& 
¬gc
 == 2) {

678 
£rv”
.
¦ave_´iÜ™y
 = 
	`©oi
(
¬gv
[1]);

679 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"¦ave-ªnounû-"è&& 
¬gc
 == 2) {

680 
	`zä“
(
£rv”
.
¦ave_ªnounû_
);

681 
£rv”
.
¦ave_ªnounû_
 = 
	`z¡rdup
(
¬gv
[1]);

682 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"¦ave-ªnounû-pÜt"è&& 
¬gc
 == 2) {

683 
£rv”
.
¦ave_ªnounû_pÜt
 = 
	`©oi
(
¬gv
[1]);

684 ià(
£rv”
.
¦ave_ªnounû_pÜt
 < 0 ||

685 
£rv”
.
¦ave_ªnounû_pÜt
 > 65535)

687 
”r
 = "Inv®id…Üt"; 
lßd”r
;

689 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"mš-¦aves-to-wr™e"è&& 
¬gc
 == 2) {

690 
£rv”
.
»¶_mš_¦aves_to_wr™e
 = 
	`©oi
(
¬gv
[1]);

691 ià(
£rv”
.
»¶_mš_¦aves_to_wr™e
 < 0) {

692 
”r
 = "Inv®id v®ufÜ mš-¦aves-to-wr™e."; 
lßd”r
;

694 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"mš-¦aves-max-Ïg"è&& 
¬gc
 == 2) {

695 
£rv”
.
»¶_mš_¦aves_max_Ïg
 = 
	`©oi
(
¬gv
[1]);

696 ià(
£rv”
.
»¶_mš_¦aves_max_Ïg
 < 0) {

697 
”r
 = "Inv®id v®ufÜ mš-¦aves-max-Ïg."; 
lßd”r
;

699 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"nÙify-key¥aû-ev’ts"è&& 
¬gc
 == 2) {

700 
æags
 = 
	`key¥aûEv’tsSŒšgToFÏgs
(
¬gv
[1]);

702 ià(
æags
 == -1) {

703 
”r
 = "Invalidƒvent class character. Use 'g$lshzxeA'.";

704 
lßd”r
;

706 
£rv”
.
nÙify_key¥aû_ev’ts
 = 
æags
;

707 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"su³rvi£d"è&& 
¬gc
 == 2) {

708 
£rv”
.
su³rvi£d_mode
 =

709 
	`cÚfigEnumG‘V®ue
(
su³rvi£d_mode_’um
,
¬gv
[1]);

711 ià(
£rv”
.
su³rvi£d_mode
 =ğ
INT_MIN
) {

712 
”r
 = "Invalid option for 'supervised'. "

714 
lßd”r
;

716 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"lßdmoduË"è&& 
¬gc
 >= 2) {

717 
	`queueLßdModuË
(
¬gv
[1],&¬gv[2],
¬gc
-2);

718 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"sentinel")) {

721 ià(
¬gc
 != 1) {

722 ià(!
£rv”
.
£Áš–_mode
) {

723 
”r
 = "sentinel directive while‚ot in sentinel mode";

724 
lßd”r
;

726 
”r
 = 
	`£Áš–HªdËCÚfigu¿tiÚ
(
¬gv
+1,
¬gc
-1);

727 ià(
”r
è
lßd”r
;

730 
”r
 = "Bad dœeùivÜ wrÚg‚umb” oà¬gum’ts"; 
lßd”r
;

732 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

736 ià(
£rv”
.
şu¡”_’abËd
 && s”v”.
ma¡”ho¡
) {

737 
lš’um
 = 
¦aveof_lš’um
;

738 
i
 = 
lš’um
-1;

739 
”r
 = "slaveof directive‚ot‡llowed in cluster mode";

740 
lßd”r
;

743 
	`sdsä“¥l™»s
(
lšes
,
tÙlšes
);

746 
lßd”r
:

747 
	`årštf
(
¡d”r
, "\n*** FATAL CONFIG FILE ERROR ***\n");

748 
	`årštf
(
¡d”r
, "R—dšghcÚfigu¿tiÚ fe,‡ˆlš%d\n", 
lš’um
);

749 
	`årštf
(
¡d”r
, ">>> '%s'\n", 
lšes
[
i
]);

750 
	`årštf
(
¡d”r
, "%s\n", 
”r
);

751 
	`ex™
(1);

752 
	}
}

761 
	$lßdS”v”CÚfig
(*
f’ame
, *
İtiÚs
) {

762 
sds
 
cÚfig
 = 
	`sd£m±y
();

763 
buf
[
CONFIG_MAX_LINE
+1];

766 ià(
f’ame
) {

767 
FILE
 *
å
;

769 ià(
f’ame
[0] == '-' && filename[1] == '\0') {

770 
å
 = 
¡dš
;

772 ià((
å
 = 
	`fİ’
(
f’ame
,"r")è=ğ
NULL
) {

773 
	`£rv”Log
(
LL_WARNING
,

774 "F©®ƒ¼Ü, cª'ˆİ’ cÚfig f'%s'", 
f’ame
);

775 
	`ex™
(1);

778 
	`fg‘s
(
buf
,
CONFIG_MAX_LINE
+1,
å
è!ğ
NULL
)

779 
cÚfig
 = 
	`sdsÿt
(cÚfig,
buf
);

780 ià(
å
 !ğ
¡dš
è
	`fşo£
(fp);

783 ià(
İtiÚs
) {

784 
cÚfig
 = 
	`sdsÿt
(config,"\n");

785 
cÚfig
 = 
	`sdsÿt
(cÚfig,
İtiÚs
);

787 
	`lßdS”v”CÚfigFromSŒšg
(
cÚfig
);

788 
	`sdsä“
(
cÚfig
);

789 
	}
}

795 
	#cÚfig_£t_boŞ_f›ld
(
_Çme
,
_v¬
) \

796 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,
_Çme
)) { \

797 
yn
 = 
	`ye¢Ùoi
(
o
->
±r
); \

798 ià(
yn
 =ğ-1è
badfmt
; \

799 
_v¬
 = 
yn
;

	)

801 
	#cÚfig_£t_num”iÿl_f›ld
(
_Çme
,
_v¬
,
mš
,
max
) \

802 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,
_Çme
)) { \

803 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
C_ERR
è
badfmt
; \

804 ià(
mš
 !ğ
LLONG_MIN
 && 
Î
 < mšè
badfmt
; \

805 ià(
max
 !ğ
LLONG_MAX
 && 
Î
 > maxè
badfmt
; \

806 
_v¬
 = 
Î
;

	)

808 
	#cÚfig_£t_memÜy_f›ld
(
_Çme
,
_v¬
) \

809 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,
_Çme
)) { \

810 
Î
 = 
	`memtŞl
(
o
->
±r
,&
”r
); \

811 ià(
”r
 || 
Î
 < 0è
badfmt
; \

812 
_v¬
 = 
Î
;

	)

814 
	#cÚfig_£t_’um_f›ld
(
_Çme
,
_v¬
,
_’umv¬
) \

815 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,
_Çme
)) { \

816 
’umv®
 = 
	`cÚfigEnumG‘V®ue
(
_’umv¬
,
o
->
±r
); \

817 ià(
’umv®
 =ğ
INT_MIN
è
badfmt
; \

818 
_v¬
 = 
’umv®
;

	)

820 
	#cÚfig_£t_¥ecŸl_f›ld
(
_Çme
) \

821 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,
_Çme
)è{

	)

823 
	#cÚfig_£t_–£
 } 

	)

825 
	$cÚfigS‘Commªd
(
ş›Á
 *
c
) {

826 
robj
 *
o
;

827 
Î
;

828 
”r
;

829 
	`£rv”As£¹W™hInfo
(
c
,c->
¬gv
[2],
	`sdsEncodedObjeù
(c->argv[2]));

830 
	`£rv”As£¹W™hInfo
(
c
,c->
¬gv
[3],
	`sdsEncodedObjeù
(c->argv[3]));

831 
o
 = 
c
->
¬gv
[3];

836 
	`cÚfig_£t_¥ecŸl_f›ld
("dbfilename") {

837 ià(!
	`·thIsBa£Name
(
o
->
±r
)) {

838 
	`addR•lyE¼Ü
(
c
, "dbfilename can't be‡…ath, just‡ filename");

841 
	`zä“
(
£rv”
.
rdb_f’ame
);

842 
£rv”
.
rdb_f’ame
 = 
	`z¡rdup
(
o
->
±r
);

843 } 
	`cÚfig_£t_¥ecŸl_f›ld
("requirepass") {

844 ià(
	`sd¦’
(
o
->
±r
è> 
CONFIG_AUTHPASS_MAX_LEN
è
badfmt
;

845 
	`zä“
(
£rv”
.
»quœ•ass
);

846 
£rv”
.
»quœ•ass
 = ((*)
o
->
±r
)[0] ? 
	`z¡rdup
(o->±rè: 
NULL
;

847 } 
	`cÚfig_£t_¥ecŸl_f›ld
("masterauth") {

848 
	`zä“
(
£rv”
.
ma¡”auth
);

849 
£rv”
.
ma¡”auth
 = ((*)
o
->
±r
)[0] ? 
	`z¡rdup
(o->±rè: 
NULL
;

850 } 
	`cÚfig_£t_¥ecŸl_f›ld
("cluster-announce-ip") {

851 
	`zä“
(
£rv”
.
şu¡”_ªnounû_
);

852 
£rv”
.
şu¡”_ªnounû_
 = ((*)
o
->
±r
)[0] ? 
	`z¡rdup
(o->±rè: 
NULL
;

853 } 
	`cÚfig_£t_¥ecŸl_f›ld
("maxclients") {

854 
Üig_v®ue
 = 
£rv”
.
maxş›Ás
;

856 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
C_ERR
 ||†È< 1è
badfmt
;

859 
£rv”
.
maxş›Ás
 = 
Î
;

860 ià(
Î
 > 
Üig_v®ue
) {

861 
	`adju¡O³nFesLim™
();

862 ià(
£rv”
.
maxş›Ás
 !ğ
Î
) {

863 
	`addR•lyE¼ÜFÜm©
(
c
,"Thİ”©šg sy¡em i nÙ‡bËØhªdËh¥ecif›d‚umb” oàş›Ás,ry w™h %d", 
£rv”
.
maxş›Ás
);

864 
£rv”
.
maxş›Ás
 = 
Üig_v®ue
;

867 ià((è
	`«G‘S‘Size
(
£rv”
.
–
) <

868 
£rv”
.
maxş›Ás
 + 
CONFIG_FDSET_INCR
)

870 ià(
	`«ResizeS‘Size
(
£rv”
.
–
,

871 
£rv”
.
maxş›Ás
 + 
CONFIG_FDSET_INCR
è=ğ
AE_ERR
)

873 
	`addR•lyE¼Ü
(
c
,"Theƒvent†oop API used by Redis is‚ot‡bleo handlehe specified‚umber of clients");

874 
£rv”
.
maxş›Ás
 = 
Üig_v®ue
;

879 } 
	`cÚfig_£t_¥ecŸl_f›ld
("appendonly") {

880 
’abË
 = 
	`ye¢Ùoi
(
o
->
±r
);

882 ià(
’abË
 =ğ-1è
badfmt
;

883 ià(
’abË
 =ğ0 && 
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
) {

884 
	`¡İAµ’dOÆy
();

885 } ià(
’abË
 && 
£rv”
.
aof_¡©e
 =ğ
AOF_OFF
) {

886 ià(
	`¡¬tAµ’dOÆy
(è=ğ
C_ERR
) {

887 
	`addR•lyE¼Ü
(
c
,

892 } 
	`cÚfig_£t_¥ecŸl_f›ld
("save") {

893 
vËn
, 
j
;

894 
sds
 *
v
 = 
	`sds¥l™Ën
(
o
->
±r
,
	`sd¦’
(o->±r)," ",1,&
vËn
);

899 ià(
vËn
 & 1) {

900 
	`sdsä“¥l™»s
(
v
,
vËn
);

901 
badfmt
;

903 
j
 = 0; j < 
vËn
; j++) {

904 *
•Œ
;

905 
v®
;

907 
v®
 = 
	`¡¹Şl
(
v
[
j
], &
•Œ
, 10);

908 ià(
•Œ
[0] != '\0' ||

909 ((
j
 & 1è=ğ0 && 
v®
 < 1) ||

910 ((
j
 & 1è=ğ1 && 
v®
 < 0)) {

911 
	`sdsä“¥l™»s
(
v
,
vËn
);

912 
badfmt
;

916 
	`»£tS”v”SaveP¬ams
();

917 
j
 = 0; j < 
vËn
; j += 2) {

918 
time_t
 
£cÚds
;

919 
chªges
;

921 
£cÚds
 = 
	`¡¹Şl
(
v
[
j
],
NULL
,10);

922 
chªges
 = 
	`¡¹Şl
(
v
[
j
+1],
NULL
,10);

923 
	`­³ndS”v”SaveP¬ams
(
£cÚds
, 
chªges
);

925 
	`sdsä“¥l™»s
(
v
,
vËn
);

926 } 
	`cÚfig_£t_¥ecŸl_f›ld
("dir") {

927 ià(
	`chdœ
((*)
o
->
±r
) == -1) {

928 
	`addR•lyE¼ÜFÜm©
(
c
,"Chªgšg dœeùÜy: %s", 
	`¡»¼Ü
(
”ºo
));

931 } 
	`cÚfig_£t_¥ecŸl_f›ld
("client-output-buffer-limit") {

932 
vËn
, 
j
;

933 
sds
 *
v
 = 
	`sds¥l™Ën
(
o
->
±r
,
	`sd¦’
(o->±r)," ",1,&
vËn
);

936 ià(
vËn
 % 4) {

937 
	`sdsä“¥l™»s
(
v
,
vËn
);

938 
badfmt
;

944 
j
 = 0; j < 
vËn
; j++) {

945 
v®
;

947 ià((
j
 % 4) == 0) {

948 
şass
 = 
	`g‘Cl›ÁTy³ByName
(
v
[
j
]);

949 ià(
şass
 =ğ-1 || cÏs =ğ
CLIENT_TYPE_MASTER
) {

950 
	`sdsä“¥l™»s
(
v
,
vËn
);

951 
badfmt
;

954 
v®
 = 
	`memtŞl
(
v
[
j
], &
”r
);

955 ià(
”r
 || 
v®
 < 0) {

956 
	`sdsä“¥l™»s
(
v
,
vËn
);

957 
badfmt
;

962 
j
 = 0; j < 
vËn
; j += 4) {

963 
şass
;

964 
h¬d
, 
soá
;

965 
soá_£cÚds
;

967 
şass
 = 
	`g‘Cl›ÁTy³ByName
(
v
[
j
]);

968 
h¬d
 = 
	`¡¹Şl
(
v
[
j
+1],
NULL
,10);

969 
soá
 = 
	`¡¹Şl
(
v
[
j
+2],
NULL
,10);

970 
soá_£cÚds
 = 
	`¡¹Şl
(
v
[
j
+3],
NULL
,10);

972 
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
h¬d_lim™_by‹s
 = 
h¬d
;

973 
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_by‹s
 = 
soá
;

974 
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_£cÚds
 = 
soá_£cÚds
;

976 
	`sdsä“¥l™»s
(
v
,
vËn
);

977 } 
	`cÚfig_£t_¥ecŸl_f›ld
("notify-keyspace-events") {

978 
æags
 = 
	`key¥aûEv’tsSŒšgToFÏgs
(
o
->
±r
);

980 ià(
æags
 =ğ-1è
badfmt
;

981 
£rv”
.
nÙify_key¥aû_ev’ts
 = 
æags
;

982 } 
	`cÚfig_£t_¥ecŸl_f›ld
("slave-announce-ip") {

983 
	`zä“
(
£rv”
.
¦ave_ªnounû_
);

984 
£rv”
.
¦ave_ªnounû_
 = ((*)
o
->
±r
)[0] ? 
	`z¡rdup
(o->±rè: 
NULL
;

988 } 
	`cÚfig_£t_boŞ_f›ld
(

989 "rdbcom´essiÚ", 
£rv”
.
rdb_com´essiÚ
) {

990 } 
	`cÚfig_£t_boŞ_f›ld
(

991 "»¶-di§bË-tı-nod–ay",
£rv”
.
»¶_di§bË_tı_nod–ay
) {

992 } 
	`cÚfig_£t_boŞ_f›ld
(

993 "»¶-diskËss-sync",
£rv”
.
»¶_diskËss_sync
) {

994 } 
	`cÚfig_£t_boŞ_f›ld
(

995 "şu¡”-»quœe-fuÎ-cov”age",
£rv”
.
şu¡”_»quœe_fuÎ_cov”age
) {

996 } 
	`cÚfig_£t_boŞ_f›ld
(

997 "aof-»wr™e-šüem’l-fsync",
£rv”
.
aof_»wr™e_šüem’l_fsync
) {

998 } 
	`cÚfig_£t_boŞ_f›ld
(

999 "aof-lßd-Œunÿ‹d",
£rv”
.
aof_lßd_Œunÿ‹d
) {

1000 } 
	`cÚfig_£t_boŞ_f›ld
(

1001 "aof-u£-rdb-´—mbË",
£rv”
.
aof_u£_rdb_´—mbË
) {

1002 } 
	`cÚfig_£t_boŞ_f›ld
(

1003 "¦ave-£rve-¡®e-d©a",
£rv”
.
»¶_£rve_¡®e_d©a
) {

1004 } 
	`cÚfig_£t_boŞ_f›ld
(

1005 "¦ave-»ad-Úly",
£rv”
.
»¶_¦ave_ro
) {

1006 } 
	`cÚfig_£t_boŞ_f›ld
(

1007 "aùiv”ehashšg",
£rv”
.
aùiv”ehashšg
) {

1008 } 
	`cÚfig_£t_boŞ_f›ld
(

1009 "aùivedeäag",
£rv”
.
aùive_deäag_’abËd
) {

1010 #iâdeà
HAVE_DEFRAG


1011 ià(
£rv”
.
aùive_deäag_’abËd
) {

1012 
£rv”
.
aùive_deäag_’abËd
 = 0;

1013 
	`addR•lyE¼Ü
(
c
,

1020 } 
	`cÚfig_£t_boŞ_f›ld
(

1021 "´Ùeùed-mode",
£rv”
.
´Ùeùed_mode
) {

1022 } 
	`cÚfig_£t_boŞ_f›ld
(

1023 "¡İ-wr™es-Ú-bg§ve-”rÜ",
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
) {

1024 } 
	`cÚfig_£t_boŞ_f›ld
(

1025 "Ïzyä“-Ïzy-eviùiÚ",
£rv”
.
Ïzyä“_Ïzy_eviùiÚ
) {

1026 } 
	`cÚfig_£t_boŞ_f›ld
(

1027 "Ïzyä“-Ïzy-expœe",
£rv”
.
Ïzyä“_Ïzy_expœe
) {

1028 } 
	`cÚfig_£t_boŞ_f›ld
(

1029 "Ïzyä“-Ïzy-£rv”-d–",
£rv”
.
Ïzyä“_Ïzy_£rv”_d–
) {

1030 } 
	`cÚfig_£t_boŞ_f›ld
(

1031 "¦ave-Ïzy-æush",
£rv”
.
»¶_¦ave_Ïzy_æush
) {

1032 } 
	`cÚfig_£t_boŞ_f›ld
(

1033 "no-­³ndfsync-Ú-»wr™e",
£rv”
.
aof_no_fsync_Ú_»wr™e
) {

1037 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1038 "tı-k“·live",
£rv”
.
tık“·live
,0,
LLONG_MAX
) {

1039 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1040 "maxmemÜy-§m¶es",
£rv”
.
maxmemÜy_§m¶es
,1,
LLONG_MAX
) {

1041 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1042 "lfu-log-çùÜ",
£rv”
.
lfu_log_çùÜ
,0,
LLONG_MAX
) {

1043 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1044 "lfu-deÿy-time",
£rv”
.
lfu_deÿy_time
,0,
LLONG_MAX
) {

1045 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1046 "timeout",
£rv”
.
maxidËtime
,0,
LONG_MAX
) {

1047 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1048 "aùive-deäag-th»shŞd-low”",
£rv”
.
aùive_deäag_th»shŞd_low”
,0,1000) {

1049 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1050 "aùive-deäag-th»shŞd-uµ”",
£rv”
.
aùive_deäag_th»shŞd_uµ”
,0,1000) {

1051 } 
	`cÚfig_£t_memÜy_f›ld
(

1052 "aùive-deäag-ignÜe-by‹s",
£rv”
.
aùive_deäag_ignÜe_by‹s
) {

1053 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1054 "aùive-deäag-cyşe-mš",
£rv”
.
aùive_deäag_cyşe_mš
,1,99) {

1055 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1056 "aùive-deäag-cyşe-max",
£rv”
.
aùive_deäag_cyşe_max
,1,99) {

1057 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1058 "auto-aof-»wr™e-³rûÁage",
£rv”
.
aof_»wr™e_³rc
,0,
LLONG_MAX
){

1059 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1060 "hash-max-zli¡-’Œ›s",
£rv”
.
hash_max_zli¡_’Œ›s
,0,
LLONG_MAX
) {

1061 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1062 "hash-max-zli¡-v®ue",
£rv”
.
hash_max_zli¡_v®ue
,0,
LLONG_MAX
) {

1063 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1064 "li¡-max-zli¡-size",
£rv”
.
li¡_max_zli¡_size
,
INT_MIN
,
INT_MAX
) {

1065 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1066 "li¡-com´ess-d•th",
£rv”
.
li¡_com´ess_d•th
,0,
INT_MAX
) {

1067 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1068 "£t-max-št£t-’Œ›s",
£rv”
.
£t_max_št£t_’Œ›s
,0,
LLONG_MAX
) {

1069 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1070 "z£t-max-zli¡-’Œ›s",
£rv”
.
z£t_max_zli¡_’Œ›s
,0,
LLONG_MAX
) {

1071 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1072 "z£t-max-zli¡-v®ue",
£rv”
.
z£t_max_zli¡_v®ue
,0,
LLONG_MAX
) {

1073 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1074 "hÎ-¥¬£-max-by‹s",
£rv”
.
hÎ_¥¬£_max_by‹s
,0,
LLONG_MAX
) {

1075 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1076 "lua-time-lim™",
£rv”
.
lua_time_lim™
,0,
LLONG_MAX
) {

1077 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1078 "¦owlog-log-¦ow”-thª",
£rv”
.
¦owlog_log_¦ow”_thª
,0,
LLONG_MAX
) {

1079 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1080 "¦owlog-max-Ën",
Î
,0,
LLONG_MAX
) {

1082 
£rv”
.
¦owlog_max_Ën
 = ()
Î
;

1083 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1084 "Ï‹ncy-mÚ™Ü-th»shŞd",
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
,0,
LLONG_MAX
){

1085 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1086 "»¶-pšg-¦ave-³riod",
£rv”
.
»¶_pšg_¦ave_³riod
,1,
LLONG_MAX
) {

1087 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1088 "»¶-timeout",
£rv”
.
»¶_timeout
,1,
LLONG_MAX
) {

1089 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1090 "»¶-backlog-‰l",
£rv”
.
»¶_backlog_time_lim™
,0,
LLONG_MAX
) {

1091 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1092 "»¶-diskËss-sync-d–ay",
£rv”
.
»¶_diskËss_sync_d–ay
,0,
LLONG_MAX
) {

1093 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1094 "¦ave-´iÜ™y",
£rv”
.
¦ave_´iÜ™y
,0,
LLONG_MAX
) {

1095 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1096 "¦ave-ªnounû-pÜt",
£rv”
.
¦ave_ªnounû_pÜt
,0,65535) {

1097 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1098 "mš-¦aves-to-wr™e",
£rv”
.
»¶_mš_¦aves_to_wr™e
,0,
LLONG_MAX
) {

1099 
	`»äeshGoodSÏvesCouÁ
();

1100 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1101 "mš-¦aves-max-Ïg",
£rv”
.
»¶_mš_¦aves_max_Ïg
,0,
LLONG_MAX
) {

1102 
	`»äeshGoodSÏvesCouÁ
();

1103 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1104 "şu¡”-node-timeout",
£rv”
.
şu¡”_node_timeout
,0,
LLONG_MAX
) {

1105 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1106 "şu¡”-ªnounû-pÜt",
£rv”
.
şu¡”_ªnounû_pÜt
,0,65535) {

1107 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1108 "şu¡”-ªnounû-bus-pÜt",
£rv”
.
şu¡”_ªnounû_bus_pÜt
,0,65535) {

1109 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1110 "şu¡”-mig¿tiÚ-b¬r›r",
£rv”
.
şu¡”_mig¿tiÚ_b¬r›r
,0,
LLONG_MAX
){

1111 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1112 "şu¡”-¦ave-v®id™y-çùÜ",
£rv”
.
şu¡”_¦ave_v®id™y_çùÜ
,0,
LLONG_MAX
) {

1113 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1114 "hz",
£rv”
.
hz
,0,
LLONG_MAX
) {

1117 ià(
£rv”
.
hz
 < 
CONFIG_MIN_HZ
) server.hz = CONFIG_MIN_HZ;

1118 ià(
£rv”
.
hz
 > 
CONFIG_MAX_HZ
) server.hz = CONFIG_MAX_HZ;

1119 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1120 "w©chdog-³riod",
Î
,0,
LLONG_MAX
) {

1121 ià(
Î
)

1122 
	`’abËW©chdog
(
Î
);

1124 
	`di§bËW©chdog
();

1128 } 
	`cÚfig_£t_memÜy_f›ld
("maxmemÜy",
£rv”
.
maxmemÜy
) {

1129 ià(
£rv”
.
maxmemÜy
) {

1130 ià(
£rv”
.
maxmemÜy
 < 
	`zm®loc_u£d_memÜy
()) {

1131 
	`£rv”Log
(
LL_WARNING
,"WARNING:he‚ew maxmemory value set via CONFIG SET is smallerhanhe current memory usage. This will„esult in keysƒviction‡nd/or inabilityo‡ccept‚ew write commands depending onhe maxmemory-policy.");

1133 
	`ä“MemÜyIfN“ded
();

1135 } 
	`cÚfig_£t_memÜy_f›ld
("»¶-backlog-size",
Î
) {

1136 
	`»sizeR•liÿtiÚBacklog
(
Î
);

1137 } 
	`cÚfig_£t_memÜy_f›ld
("auto-aof-»wr™e-mš-size",
Î
) {

1138 
£rv”
.
aof_»wr™e_mš_size
 = 
Î
;

1142 } 
	`cÚfig_£t_’um_f›ld
(

1143 "logËv–",
£rv”
.
v”bos™y
,
logËv–_’um
) {

1144 } 
	`cÚfig_£t_’um_f›ld
(

1145 "maxmemÜy-pŞicy",
£rv”
.
maxmemÜy_pŞicy
,
maxmemÜy_pŞicy_’um
) {

1146 } 
	`cÚfig_£t_’um_f›ld
(

1147 "­³ndfsync",
£rv”
.
aof_fsync
,
aof_fsync_’um
) {

1150 } 
cÚfig_£t_–£
 {

1151 
	`addR•lyE¼ÜFÜm©
(
c
,"Unsupported CONFIG…arameter: %s",

1152 (*)
c
->
¬gv
[2]->
±r
);

1157 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1160 
badfmt
:

1161 
	`addR•lyE¼ÜFÜm©
(
c
,"Invalid‡rgument '%s' for CONFIG SET '%s'",

1162 (*)
o
->
±r
,

1163 (*)
c
->
¬gv
[2]->
±r
);

1170 
	#cÚfig_g‘_¡ršg_f›ld
(
_Çme
,
_v¬
) do { \

1171 ià(
	`¡ršgm©ch
(
·‰”n
,
_Çme
,1)) { \

1172 
	`addR•lyBulkCSŒšg
(
c
,
_Çme
); \

1173 
	`addR•lyBulkCSŒšg
(
c
,
_v¬
 ? _var : ""); \

1174 
m©ches
++; \

1176 } 0);

	)

1178 
	#cÚfig_g‘_boŞ_f›ld
(
_Çme
,
_v¬
) do { \

1179 ià(
	`¡ršgm©ch
(
·‰”n
,
_Çme
,1)) { \

1180 
	`addR•lyBulkCSŒšg
(
c
,
_Çme
); \

1181 
	`addR•lyBulkCSŒšg
(
c
,
_v¬
 ? "yes" : "no"); \

1182 
m©ches
++; \

1184 } 0);

	)

1186 
	#cÚfig_g‘_num”iÿl_f›ld
(
_Çme
,
_v¬
) do { \

1187 ià(
	`¡ršgm©ch
(
·‰”n
,
_Çme
,1)) { \

1188 
	`Î2¡ršg
(
buf
,(buf),
_v¬
); \

1189 
	`addR•lyBulkCSŒšg
(
c
,
_Çme
); \

1190 
	`addR•lyBulkCSŒšg
(
c
,
buf
); \

1191 
m©ches
++; \

1193 } 0);

	)

1195 
	#cÚfig_g‘_’um_f›ld
(
_Çme
,
_v¬
,
_’umv¬
) do { \

1196 ià(
	`¡ršgm©ch
(
·‰”n
,
_Çme
,1)) { \

1197 
	`addR•lyBulkCSŒšg
(
c
,
_Çme
); \

1198 
	`addR•lyBulkCSŒšg
(
c
,
	`cÚfigEnumG‘NameOrUnknown
(
_’umv¬
,
_v¬
)); \

1199 
m©ches
++; \

1201 } 0);

	)

1203 
	`cÚfigG‘Commªd
(
ş›Á
 *
c
) {

1204 
robj
 *
o
 = 
c
->
¬gv
[2];

1205 *
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

1206 *
·‰”n
 = 
o
->
±r
;

1207 
buf
[128];

1208 
m©ches
 = 0;

1209 
	`£rv”As£¹W™hInfo
(
c
,
o
,
	`sdsEncodedObjeù
(o));

1212 
	`cÚfig_g‘_¡ršg_f›ld
("dbf’ame",
£rv”
.
rdb_f’ame
);

1213 
	`cÚfig_g‘_¡ršg_f›ld
("»quœ•ass",
£rv”
.
»quœ•ass
);

1214 
	`cÚfig_g‘_¡ršg_f›ld
("ma¡”auth",
£rv”
.
ma¡”auth
);

1215 
	`cÚfig_g‘_¡ršg_f›ld
("şu¡”-ªnounû-",
£rv”
.
şu¡”_ªnounû_
);

1216 
	`cÚfig_g‘_¡ršg_f›ld
("unixsock‘",
£rv”
.
unixsock‘
);

1217 
	`cÚfig_g‘_¡ršg_f›ld
("logfe",
£rv”
.
logfe
);

1218 
	`cÚfig_g‘_¡ršg_f›ld
("pidfe",
£rv”
.
pidfe
);

1219 
	`cÚfig_g‘_¡ršg_f›ld
("¦ave-ªnounû-",
£rv”
.
¦ave_ªnounû_
);

1222 
	`cÚfig_g‘_num”iÿl_f›ld
("maxmemÜy",
£rv”
.
maxmemÜy
);

1223 
	`cÚfig_g‘_num”iÿl_f›ld
("maxmemÜy-§m¶es",
£rv”
.
maxmemÜy_§m¶es
);

1224 
	`cÚfig_g‘_num”iÿl_f›ld
("timeout",
£rv”
.
maxidËtime
);

1225 
	`cÚfig_g‘_num”iÿl_f›ld
("aùive-deäag-th»shŞd-low”",
£rv”
.
aùive_deäag_th»shŞd_low”
);

1226 
	`cÚfig_g‘_num”iÿl_f›ld
("aùive-deäag-th»shŞd-uµ”",
£rv”
.
aùive_deäag_th»shŞd_uµ”
);

1227 
	`cÚfig_g‘_num”iÿl_f›ld
("aùive-deäag-ignÜe-by‹s",
£rv”
.
aùive_deäag_ignÜe_by‹s
);

1228 
	`cÚfig_g‘_num”iÿl_f›ld
("aùive-deäag-cyşe-mš",
£rv”
.
aùive_deäag_cyşe_mš
);

1229 
	`cÚfig_g‘_num”iÿl_f›ld
("aùive-deäag-cyşe-max",
£rv”
.
aùive_deäag_cyşe_max
);

1230 
	`cÚfig_g‘_num”iÿl_f›ld
("auto-aof-rewrite-percentage",

1231 
£rv”
.
aof_»wr™e_³rc
);

1232 
	`cÚfig_g‘_num”iÿl_f›ld
("auto-aof-rewrite-min-size",

1233 
£rv”
.
aof_»wr™e_mš_size
);

1234 
	`cÚfig_g‘_num”iÿl_f›ld
("hash-max-ziplist-entries",

1235 
£rv”
.
hash_max_zli¡_’Œ›s
);

1236 
	`cÚfig_g‘_num”iÿl_f›ld
("hash-max-ziplist-value",

1237 
£rv”
.
hash_max_zli¡_v®ue
);

1238 
	`cÚfig_g‘_num”iÿl_f›ld
("list-max-ziplist-size",

1239 
£rv”
.
li¡_max_zli¡_size
);

1240 
	`cÚfig_g‘_num”iÿl_f›ld
("list-compress-depth",

1241 
£rv”
.
li¡_com´ess_d•th
);

1242 
	`cÚfig_g‘_num”iÿl_f›ld
("set-max-intset-entries",

1243 
£rv”
.
£t_max_št£t_’Œ›s
);

1244 
	`cÚfig_g‘_num”iÿl_f›ld
("zset-max-ziplist-entries",

1245 
£rv”
.
z£t_max_zli¡_’Œ›s
);

1246 
	`cÚfig_g‘_num”iÿl_f›ld
("zset-max-ziplist-value",

1247 
£rv”
.
z£t_max_zli¡_v®ue
);

1248 
	`cÚfig_g‘_num”iÿl_f›ld
("hll-sparse-max-bytes",

1249 
£rv”
.
hÎ_¥¬£_max_by‹s
);

1250 
	`cÚfig_g‘_num”iÿl_f›ld
("lua-time-lim™",
£rv”
.
lua_time_lim™
);

1251 
	`cÚfig_g‘_num”iÿl_f›ld
("slowlog-log-slower-than",

1252 
£rv”
.
¦owlog_log_¦ow”_thª
);

1253 
	`cÚfig_g‘_num”iÿl_f›ld
("latency-monitor-threshold",

1254 
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
);

1255 
	`cÚfig_g‘_num”iÿl_f›ld
("slowlog-max-len",

1256 
£rv”
.
¦owlog_max_Ën
);

1257 
	`cÚfig_g‘_num”iÿl_f›ld
("pÜt",
£rv”
.
pÜt
);

1258 
	`cÚfig_g‘_num”iÿl_f›ld
("şu¡”-ªnounû-pÜt",
£rv”
.
şu¡”_ªnounû_pÜt
);

1259 
	`cÚfig_g‘_num”iÿl_f›ld
("şu¡”-ªnounû-bus-pÜt",
£rv”
.
şu¡”_ªnounû_bus_pÜt
);

1260 
	`cÚfig_g‘_num”iÿl_f›ld
("tı-backlog",
£rv”
.
tı_backlog
);

1261 
	`cÚfig_g‘_num”iÿl_f›ld
("d©aba£s",
£rv”
.
dbnum
);

1262 
	`cÚfig_g‘_num”iÿl_f›ld
("»¶-pšg-¦ave-³riod",
£rv”
.
»¶_pšg_¦ave_³riod
);

1263 
	`cÚfig_g‘_num”iÿl_f›ld
("»¶-timeout",
£rv”
.
»¶_timeout
);

1264 
	`cÚfig_g‘_num”iÿl_f›ld
("»¶-backlog-size",
£rv”
.
»¶_backlog_size
);

1265 
	`cÚfig_g‘_num”iÿl_f›ld
("»¶-backlog-‰l",
£rv”
.
»¶_backlog_time_lim™
);

1266 
	`cÚfig_g‘_num”iÿl_f›ld
("maxş›Ás",
£rv”
.
maxş›Ás
);

1267 
	`cÚfig_g‘_num”iÿl_f›ld
("w©chdog-³riod",
£rv”
.
w©chdog_³riod
);

1268 
	`cÚfig_g‘_num”iÿl_f›ld
("¦ave-´iÜ™y",
£rv”
.
¦ave_´iÜ™y
);

1269 
	`cÚfig_g‘_num”iÿl_f›ld
("¦ave-ªnounû-pÜt",
£rv”
.
¦ave_ªnounû_pÜt
);

1270 
	`cÚfig_g‘_num”iÿl_f›ld
("mš-¦aves-to-wr™e",
£rv”
.
»¶_mš_¦aves_to_wr™e
);

1271 
	`cÚfig_g‘_num”iÿl_f›ld
("mš-¦aves-max-Ïg",
£rv”
.
»¶_mš_¦aves_max_Ïg
);

1272 
	`cÚfig_g‘_num”iÿl_f›ld
("hz",
£rv”
.
hz
);

1273 
	`cÚfig_g‘_num”iÿl_f›ld
("şu¡”-node-timeout",
£rv”
.
şu¡”_node_timeout
);

1274 
	`cÚfig_g‘_num”iÿl_f›ld
("şu¡”-mig¿tiÚ-b¬r›r",
£rv”
.
şu¡”_mig¿tiÚ_b¬r›r
);

1275 
	`cÚfig_g‘_num”iÿl_f›ld
("şu¡”-¦ave-v®id™y-çùÜ",
£rv”
.
şu¡”_¦ave_v®id™y_çùÜ
);

1276 
	`cÚfig_g‘_num”iÿl_f›ld
("»¶-diskËss-sync-d–ay",
£rv”
.
»¶_diskËss_sync_d–ay
);

1277 
	`cÚfig_g‘_num”iÿl_f›ld
("tı-k“·live",
£rv”
.
tık“·live
);

1280 
	`cÚfig_g‘_boŞ_f›ld
("cluster-require-full-coverage",

1281 
£rv”
.
şu¡”_»quœe_fuÎ_cov”age
);

1282 
	`cÚfig_g‘_boŞ_f›ld
("no-appendfsync-on-rewrite",

1283 
£rv”
.
aof_no_fsync_Ú_»wr™e
);

1284 
	`cÚfig_g‘_boŞ_f›ld
("slave-serve-stale-data",

1285 
£rv”
.
»¶_£rve_¡®e_d©a
);

1286 
	`cÚfig_g‘_boŞ_f›ld
("slave-read-only",

1287 
£rv”
.
»¶_¦ave_ro
);

1288 
	`cÚfig_g‘_boŞ_f›ld
("stop-writes-on-bgsave-error",

1289 
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
);

1290 
	`cÚfig_g‘_boŞ_f›ld
("d«mÚize", 
£rv”
.
d«mÚize
);

1291 
	`cÚfig_g‘_boŞ_f›ld
("rdbcom´essiÚ", 
£rv”
.
rdb_com´essiÚ
);

1292 
	`cÚfig_g‘_boŞ_f›ld
("rdbchecksum", 
£rv”
.
rdb_checksum
);

1293 
	`cÚfig_g‘_boŞ_f›ld
("aùiv”ehashšg", 
£rv”
.
aùiv”ehashšg
);

1294 
	`cÚfig_g‘_boŞ_f›ld
("aùivedeäag", 
£rv”
.
aùive_deäag_’abËd
);

1295 
	`cÚfig_g‘_boŞ_f›ld
("´Ùeùed-mode", 
£rv”
.
´Ùeùed_mode
);

1296 
	`cÚfig_g‘_boŞ_f›ld
("repl-disable-tcp-nodelay",

1297 
£rv”
.
»¶_di§bË_tı_nod–ay
);

1298 
	`cÚfig_g‘_boŞ_f›ld
("repl-diskless-sync",

1299 
£rv”
.
»¶_diskËss_sync
);

1300 
	`cÚfig_g‘_boŞ_f›ld
("aof-rewrite-incremental-fsync",

1301 
£rv”
.
aof_»wr™e_šüem’l_fsync
);

1302 
	`cÚfig_g‘_boŞ_f›ld
("aof-load-truncated",

1303 
£rv”
.
aof_lßd_Œunÿ‹d
);

1304 
	`cÚfig_g‘_boŞ_f›ld
("aof-use-rdb-preamble",

1305 
£rv”
.
aof_u£_rdb_´—mbË
);

1306 
	`cÚfig_g‘_boŞ_f›ld
("lazyfree-lazy-eviction",

1307 
£rv”
.
Ïzyä“_Ïzy_eviùiÚ
);

1308 
	`cÚfig_g‘_boŞ_f›ld
("lazyfree-lazy-expire",

1309 
£rv”
.
Ïzyä“_Ïzy_expœe
);

1310 
	`cÚfig_g‘_boŞ_f›ld
("lazyfree-lazy-server-del",

1311 
£rv”
.
Ïzyä“_Ïzy_£rv”_d–
);

1312 
	`cÚfig_g‘_boŞ_f›ld
("slave-lazy-flush",

1313 
£rv”
.
»¶_¦ave_Ïzy_æush
);

1316 
	`cÚfig_g‘_’um_f›ld
("maxmemory-policy",

1317 
£rv”
.
maxmemÜy_pŞicy
,
maxmemÜy_pŞicy_’um
);

1318 
	`cÚfig_g‘_’um_f›ld
("loglevel",

1319 
£rv”
.
v”bos™y
,
logËv–_’um
);

1320 
	`cÚfig_g‘_’um_f›ld
("supervised",

1321 
£rv”
.
su³rvi£d_mode
,
su³rvi£d_mode_’um
);

1322 
	`cÚfig_g‘_’um_f›ld
("appendfsync",

1323 
£rv”
.
aof_fsync
,
aof_fsync_’um
);

1324 
	`cÚfig_g‘_’um_f›ld
("syslog-facility",

1325 
£rv”
.
sy¦og_çc™y
,
sy¦og_çc™y_’um
);

1329 ià(
	`¡ršgm©ch
(
·‰”n
,"appendonly",1)) {

1330 
	`addR•lyBulkCSŒšg
(
c
,"appendonly");

1331 
	`addR•lyBulkCSŒšg
(
c
,
£rv”
.
aof_¡©e
 =ğ
AOF_OFF
 ? "no" : "yes");

1332 
m©ches
++;

1334 ià(
	`¡ršgm©ch
(
·‰”n
,"dir",1)) {

1335 
buf
[1024];

1337 ià(
	`g‘cwd
(
buf
,(buf)è=ğ
NULL
)

1338 
buf
[0] = '\0';

1340 
	`addR•lyBulkCSŒšg
(
c
,"dir");

1341 
	`addR•lyBulkCSŒšg
(
c
,
buf
);

1342 
m©ches
++;

1344 ià(
	`¡ršgm©ch
(
·‰”n
,"save",1)) {

1345 
sds
 
buf
 = 
	`sd£m±y
();

1346 
j
;

1348 
j
 = 0; j < 
£rv”
.
§v•¬am¦’
; j++) {

1349 
buf
 = 
	`sdsÿrštf
(buf,"%jd %d",

1350 (
štmax_t
)
£rv”
.
§v•¬ams
[
j
].
£cÚds
,

1351 
£rv”
.
§v•¬ams
[
j
].
chªges
);

1352 ià(
j
 !ğ
£rv”
.
§v•¬am¦’
-1)

1353 
buf
 = 
	`sdsÿ’
(buf," ",1);

1355 
	`addR•lyBulkCSŒšg
(
c
,"save");

1356 
	`addR•lyBulkCSŒšg
(
c
,
buf
);

1357 
	`sdsä“
(
buf
);

1358 
m©ches
++;

1360 ià(
	`¡ršgm©ch
(
·‰”n
,"client-output-buffer-limit",1)) {

1361 
sds
 
buf
 = 
	`sd£m±y
();

1362 
j
;

1364 
j
 = 0; j < 
CLIENT_TYPE_OBUF_COUNT
; j++) {

1365 
buf
 = 
	`sdsÿrštf
(buf,"%s %llu %llu %ld",

1366 
	`g‘Cl›ÁTy³Name
(
j
),

1367 
£rv”
.
ş›Á_obuf_lim™s
[
j
].
h¬d_lim™_by‹s
,

1368 
£rv”
.
ş›Á_obuf_lim™s
[
j
].
soá_lim™_by‹s
,

1369 (è
£rv”
.
ş›Á_obuf_lim™s
[
j
].
soá_lim™_£cÚds
);

1370 ià(
j
 !ğ
CLIENT_TYPE_OBUF_COUNT
-1)

1371 
buf
 = 
	`sdsÿ’
(buf," ",1);

1373 
	`addR•lyBulkCSŒšg
(
c
,"client-output-buffer-limit");

1374 
	`addR•lyBulkCSŒšg
(
c
,
buf
);

1375 
	`sdsä“
(
buf
);

1376 
m©ches
++;

1378 ià(
	`¡ršgm©ch
(
·‰”n
,"unixsocketperm",1)) {

1379 
buf
[32];

1380 
	`¢´štf
(
buf
,(buf),"%o",
£rv”
.
unixsock‘³rm
);

1381 
	`addR•lyBulkCSŒšg
(
c
,"unixsocketperm");

1382 
	`addR•lyBulkCSŒšg
(
c
,
buf
);

1383 
m©ches
++;

1385 ià(
	`¡ršgm©ch
(
·‰”n
,"slaveof",1)) {

1386 
buf
[256];

1388 
	`addR•lyBulkCSŒšg
(
c
,"slaveof");

1389 ià(
£rv”
.
ma¡”ho¡
)

1390 
	`¢´štf
(
buf
,(buf),"%s %d",

1391 
£rv”
.
ma¡”ho¡
, s”v”.
ma¡”pÜt
);

1393 
buf
[0] = '\0';

1394 
	`addR•lyBulkCSŒšg
(
c
,
buf
);

1395 
m©ches
++;

1397 ià(
	`¡ršgm©ch
(
·‰”n
,"notify-keyspace-events",1)) {

1398 
robj
 *
æagsobj
 = 
	`ü—‹Objeù
(
OBJ_STRING
,

1399 
	`key¥aûEv’tsFÏgsToSŒšg
(
£rv”
.
nÙify_key¥aû_ev’ts
));

1401 
	`addR•lyBulkCSŒšg
(
c
,"notify-keyspace-events");

1402 
	`addR•lyBulk
(
c
,
æagsobj
);

1403 
	`deüRefCouÁ
(
æagsobj
);

1404 
m©ches
++;

1406 ià(
	`¡ršgm©ch
(
·‰”n
,"bind",1)) {

1407 
sds
 
aux
 = 
	`sdsjoš
(
£rv”
.
bšdaddr
,£rv”.
bšdaddr_couÁ
," ");

1409 
	`addR•lyBulkCSŒšg
(
c
,"bind");

1410 
	`addR•lyBulkCSŒšg
(
c
,
aux
);

1411 
	`sdsä“
(
aux
);

1412 
m©ches
++;

1414 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn
,
m©ches
*2);

1421 
	#REDIS_CONFIG_REWRITE_SIGNATURE
 "# G’”©ed by CONFIG REWRITE"

	)

1426 
ušt64_t
 
	`diùSdsCa£Hash
(cÚ¡ *
key
);

1427 
	`diùSdsKeyCa£Com·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
);

1428 
	`diùSdsDe¡ruùÜ
(*
´ivd©a
, *
v®
);

1429 
	`diùLi¡De¡ruùÜ
(*
´ivd©a
, *
v®
);

1433 
	`»wr™eCÚfigS’tš–O±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
);

1435 
diùTy³
 
İtiÚToLšeDiùTy³
 = {

1436 
diùSdsCa£Hash
,

1437 
NULL
,

1438 
NULL
,

1439 
diùSdsKeyCa£Com·»
,

1440 
diùSdsDe¡ruùÜ
,

1441 
diùLi¡De¡ruùÜ


1444 
diùTy³
 
İtiÚS‘DiùTy³
 = {

1445 
diùSdsCa£Hash
,

1446 
NULL
,

1447 
NULL
,

1448 
diùSdsKeyCa£Com·»
,

1449 
diùSdsDe¡ruùÜ
,

1450 
NULL


1454 
	s»wr™eCÚfigS‹
 {

1455 
diù
 *
İtiÚ_to_lše
;

1456 
diù
 *
»wr™‹n
;

1457 
numlšes
;

1458 
sds
 *
lšes
;

1459 
has_
;

1464 
	`»wr™eCÚfigAµ’dLše
(
»wr™eCÚfigS‹
 *
¡©e
, 
sds
 
lše
) {

1465 
¡©e
->
lšes
 = 
	`z»®loc
(¡©e->lšes, (*è* (¡©e->
numlšes
+1));

1466 
¡©e
->
lšes
[¡©e->
numlšes
++] = 
lše
;

1470 
	`»wr™eCÚfigAddLšeNumb”ToO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, 
sds
 
İtiÚ
, 
lš’um
) {

1471 
li¡
 *
l
 = 
	`diùF‘chV®ue
(
¡©e
->
İtiÚ_to_lše
,
İtiÚ
);

1473 ià(
l
 =ğ
NULL
) {

1474 
l
 = 
	`li¡C»©e
();

1475 
	`diùAdd
(
¡©e
->
İtiÚ_to_lše
,
	`sdsdup
(
İtiÚ
),
l
);

1477 
	`li¡AddNodeTa
(
l
,(*)()
lš’um
);

1484 
	`»wr™eCÚfigM¬kAsProûs£d
(
»wr™eCÚfigS‹
 *
¡©e
, cÚ¡ *
İtiÚ
) {

1485 
sds
 
İt
 = 
	`sd¢ew
(
İtiÚ
);

1487 ià(
	`diùAdd
(
¡©e
->
»wr™‹n
,
İt
,
NULL
è!ğ
DICT_OK
è
	`sdsä“
(opt);

1495 
»wr™eCÚfigS‹
 *
	`»wr™eCÚfigR—dOldFe
(*
·th
) {

1496 
FILE
 *
å
 = 
	`fİ’
(
·th
,"r");

1497 
»wr™eCÚfigS‹
 *
¡©e
 = 
	`zm®loc
((*state));

1498 
buf
[
CONFIG_MAX_LINE
+1];

1499 
lš’um
 = -1;

1501 ià(
å
 =ğ
NULL
 && 
”ºo
 !ğ
ENOENT
)  NULL;

1503 
¡©e
->
İtiÚ_to_lše
 = 
	`diùC»©e
(&
İtiÚToLšeDiùTy³
,
NULL
);

1504 
¡©e
->
»wr™‹n
 = 
	`diùC»©e
(&
İtiÚS‘DiùTy³
,
NULL
);

1505 
¡©e
->
numlšes
 = 0;

1506 
¡©e
->
lšes
 = 
NULL
;

1507 
¡©e
->
has_
 = 0;

1508 ià(
å
 =ğ
NULL
è 
¡©e
;

1511 
	`fg‘s
(
buf
,
CONFIG_MAX_LINE
+1,
å
è!ğ
NULL
) {

1512 
¬gc
;

1513 
sds
 *
¬gv
;

1514 
sds
 
lše
 = 
	`sd¡rim
(
	`sd¢ew
(
buf
),"\r\n\t ");

1516 
lš’um
++;

1519 ià(
lše
[0] == '#' ||†ine[0] == '\0') {

1520 ià(!
¡©e
->
has_
 && !
	`¡rcmp
(
lše
,
REDIS_CONFIG_REWRITE_SIGNATURE
))

1521 
¡©e
->
has_
 = 1;

1522 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,
lše
);

1527 
¬gv
 = 
	`sds¥l™¬gs
(
lše
,&
¬gc
);

1528 ià(
¬gv
 =ğ
NULL
) {

1532 
sds
 
aux
 = 
	`sd¢ew
("# ??? ");

1533 
aux
 = 
	`sdsÿtsds
×ux,
lše
);

1534 
	`sdsä“
(
lše
);

1535 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,
aux
);

1539 
	`sd¡Şow”
(
¬gv
[0]);

1543 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,
lše
);

1544 
	`»wr™eCÚfigAddLšeNumb”ToO±iÚ
(
¡©e
,
¬gv
[0],
lš’um
);

1546 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

1548 
	`fşo£
(
å
);

1549  
¡©e
;

1568 
	`»wr™eCÚfigRewr™eLše
(
»wr™eCÚfigS‹
 *
¡©e
, cÚ¡ *
İtiÚ
, 
sds
 
lše
, 
fÜû
) {

1569 
sds
 
o
 = 
	`sd¢ew
(
İtiÚ
);

1570 
li¡
 *
l
 = 
	`diùF‘chV®ue
(
¡©e
->
İtiÚ_to_lše
,
o
);

1572 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,
İtiÚ
);

1574 ià(!
l
 && !
fÜû
) {

1576 
	`sdsä“
(
lše
);

1577 
	`sdsä“
(
o
);

1581 ià(
l
) {

1582 
li¡Node
 *
Ê
 = 
	`li¡Fœ¡
(
l
);

1583 
lš’um
 = (è
Ê
->
v®ue
;

1587 
	`li¡D–Node
(
l
,
Ê
);

1588 ià(
	`li¡L’gth
(
l
è=ğ0è
	`diùD–‘e
(
¡©e
->
İtiÚ_to_lše
,
o
);

1589 
	`sdsä“
(
¡©e
->
lšes
[
lš’um
]);

1590 
¡©e
->
lšes
[
lš’um
] = 
lše
;

1593 ià(!
¡©e
->
has_
) {

1594 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,

1595 
	`sd¢ew
(
REDIS_CONFIG_REWRITE_SIGNATURE
));

1596 
¡©e
->
has_
 = 1;

1598 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,
lše
);

1600 
	`sdsä“
(
o
);

1605 
	`»wr™eCÚfigFÜm©MemÜy
(*
buf
, 
size_t
 
Ën
, 
by‹s
) {

1606 
gb
 = 1024*1024*1024;

1607 
mb
 = 1024*1024;

1608 
kb
 = 1024;

1610 ià(
by‹s
 && (by‹ % 
gb
) == 0) {

1611  
	`¢´štf
(
buf
,
Ën
,"%Îdgb",
by‹s
/
gb
);

1612 } ià(
by‹s
 && (by‹ % 
mb
) == 0) {

1613  
	`¢´štf
(
buf
,
Ën
,"%Îdmb",
by‹s
/
mb
);

1614 } ià(
by‹s
 && (by‹ % 
kb
) == 0) {

1615  
	`¢´štf
(
buf
,
Ën
,"%Îdkb",
by‹s
/
kb
);

1617  
	`¢´štf
(
buf
,
Ën
,"%Îd",
by‹s
);

1622 
	`»wr™eCÚfigBy‹sO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
v®ue
, 
defv®ue
) {

1623 
buf
[64];

1624 
fÜû
 = 
v®ue
 !ğ
defv®ue
;

1625 
sds
 
lše
;

1627 
	`»wr™eCÚfigFÜm©MemÜy
(
buf
,(buf),
v®ue
);

1628 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %s",
İtiÚ
,
buf
);

1629 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1633 
	`»wr™eCÚfigYesNoO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
v®ue
, 
defv®ue
) {

1634 
fÜû
 = 
v®ue
 !ğ
defv®ue
;

1635 
sds
 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %s",
İtiÚ
,

1636 
v®ue
 ? "yes" : "no");

1638 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1642 
	`»wr™eCÚfigSŒšgO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, *
v®ue
, *
defv®ue
) {

1643 
fÜû
 = 1;

1644 
sds
 
lše
;

1648 ià(
v®ue
 =ğ
NULL
) {

1649 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,
İtiÚ
);

1654 ià(
defv®ue
 && 
	`¡rcmp
(
v®ue
,defv®ueè=ğ0è
fÜû
 = 0;

1656 
lše
 = 
	`sd¢ew
(
İtiÚ
);

1657 
lše
 = 
	`sdsÿ’
(line, " ", 1);

1658 
lše
 = 
	`sdsÿŒ•r
Öše, 
v®ue
, 
	`¡¾’
(value));

1660 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1664 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
v®ue
, 
defv®ue
) {

1665 
fÜû
 = 
v®ue
 !ğ
defv®ue
;

1666 
sds
 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %Îd",
İtiÚ
,
v®ue
);

1668 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1672 
	`»wr™eCÚfigOù®O±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
v®ue
, 
defv®ue
) {

1673 
fÜû
 = 
v®ue
 !ğ
defv®ue
;

1674 
sds
 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %o",
İtiÚ
,
v®ue
);

1676 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1682 
	`»wr™eCÚfigEnumO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
v®ue
, 
cÚfigEnum
 *
û
, 
defv®
) {

1683 
sds
 
lše
;

1684 cÚ¡ *
Çme
 = 
	`cÚfigEnumG‘NameOrUnknown
(
û
,
v®ue
);

1685 
fÜû
 = 
v®ue
 !ğ
defv®
;

1687 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %s",
İtiÚ
,
Çme
);

1688 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1692 
	`»wr™eCÚfigSy¦ogçc™yO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1693 
v®ue
 = 
£rv”
.
sy¦og_çc™y
;

1694 
fÜû
 = 
v®ue
 !ğ
LOG_LOCAL0
;

1695 cÚ¡ *
Çme
 = 
NULL
, *
İtiÚ
 = "syslog-facility";

1696 
sds
 
lše
;

1698 
Çme
 = 
	`cÚfigEnumG‘NameOrUnknown
(
sy¦og_çc™y_’um
,
v®ue
);

1699 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %s",
İtiÚ
,
Çme
);

1700 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1704 
	`»wr™eCÚfigSaveO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1705 
j
;

1706 
sds
 
lše
;

1711 
j
 = 0; j < 
£rv”
.
§v•¬am¦’
; j++) {

1712 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"save %ld %d",

1713 (è
£rv”
.
§v•¬ams
[
j
].
£cÚds
, s”v”.§v•¬ams[j].
chªges
);

1714 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"§ve",
lše
,1);

1717 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,"save");

1721 
	`»wr™eCÚfigDœO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1722 
cwd
[1024];

1724 ià(
	`g‘cwd
(
cwd
,(cwd)è=ğ
NULL
) {

1725 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,"dir");

1728 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"dœ",
cwd
,
NULL
);

1732 
	`»wr™eCÚfigSÏveofO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1733 *
İtiÚ
 = "slaveof";

1734 
sds
 
lše
;

1739 ià(
£rv”
.
şu¡”_’abËd
 || s”v”.
ma¡”ho¡
 =ğ
NULL
) {

1740 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,"slaveof");

1743 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% % %d", 
İtiÚ
,

1744 
£rv”
.
ma¡”ho¡
, s”v”.
ma¡”pÜt
);

1745 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,1);

1749 
	`»wr™eCÚfigNÙifykey¥aûev’tsO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1750 
fÜû
 = 
£rv”
.
nÙify_key¥aû_ev’ts
 != 0;

1751 *
İtiÚ
 = "notify-keyspace-events";

1752 
sds
 
lše
, 
æags
;

1754 
æags
 = 
	`key¥aûEv’tsFÏgsToSŒšg
(
£rv”
.
nÙify_key¥aû_ev’ts
);

1755 
lše
 = 
	`sd¢ew
(
İtiÚ
);

1756 
lše
 = 
	`sdsÿ’
(line, " ", 1);

1757 
lše
 = 
	`sdsÿŒ•r
Öše, 
æags
, 
	`sd¦’
(flags));

1758 
	`sdsä“
(
æags
);

1759 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1763 
	`»wr™eCÚfigCl›Áouutbufã¾im™O±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1764 
j
;

1765 *
İtiÚ
 = "client-output-buffer-limit";

1767 
j
 = 0; j < 
CLIENT_TYPE_OBUF_COUNT
; j++) {

1768 
fÜû
 = (
£rv”
.
ş›Á_obuf_lim™s
[
j
].
h¬d_lim™_by‹s
 !=

1769 
ş›ÁBufãrLim™sDeçuÉs
[
j
].
h¬d_lim™_by‹s
) ||

1770 (
£rv”
.
ş›Á_obuf_lim™s
[
j
].
soá_lim™_by‹s
 !=

1771 
ş›ÁBufãrLim™sDeçuÉs
[
j
].
soá_lim™_by‹s
) ||

1772 (
£rv”
.
ş›Á_obuf_lim™s
[
j
].
soá_lim™_£cÚds
 !=

1773 
ş›ÁBufãrLim™sDeçuÉs
[
j
].
soá_lim™_£cÚds
);

1774 
sds
 
lše
;

1775 
h¬d
[64], 
soá
[64];

1777 
	`»wr™eCÚfigFÜm©MemÜy
(
h¬d
,(hard),

1778 
£rv”
.
ş›Á_obuf_lim™s
[
j
].
h¬d_lim™_by‹s
);

1779 
	`»wr™eCÚfigFÜm©MemÜy
(
soá
,(soft),

1780 
£rv”
.
ş›Á_obuf_lim™s
[
j
].
soá_lim™_by‹s
);

1782 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"%s %s %s %s %ld",

1783 
İtiÚ
, 
	`g‘Cl›ÁTy³Name
(
j
), 
h¬d
, 
soá
,

1784 (è
£rv”
.
ş›Á_obuf_lim™s
[
j
].
soá_lim™_£cÚds
);

1785 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1790 
	`»wr™eCÚfigBšdO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1791 
fÜû
 = 1;

1792 
sds
 
lše
, 
add»s£s
;

1793 *
İtiÚ
 = "bind";

1796 ià(
£rv”
.
bšdaddr_couÁ
 == 0) {

1797 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,
İtiÚ
);

1802 
add»s£s
 = 
	`sdsjoš
(
£rv”
.
bšdaddr
,£rv”.
bšdaddr_couÁ
," ");

1803 
lše
 = 
	`sd¢ew
(
İtiÚ
);

1804 
lše
 = 
	`sdsÿ’
(line, " ", 1);

1805 
lše
 = 
	`sdsÿtsds
Öše, 
add»s£s
);

1806 
	`sdsä“
(
add»s£s
);

1808 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1813 
sds
 
	`»wr™eCÚfigG‘CÚ‹ÁFromS‹
(
»wr™eCÚfigS‹
 *
¡©e
) {

1814 
sds
 
cÚ‹Á
 = 
	`sd£m±y
();

1815 
j
, 
was_em±y
 = 0;

1817 
j
 = 0; j < 
¡©e
->
numlšes
; j++) {

1819 ià(
	`sd¦’
(
¡©e
->
lšes
[
j
]) == 0) {

1820 ià(
was_em±y
) ;

1821 
was_em±y
 = 1;

1823 
was_em±y
 = 0;

1825 
cÚ‹Á
 = 
	`sdsÿtsds
(cÚ‹Á,
¡©e
->
lšes
[
j
]);

1826 
cÚ‹Á
 = 
	`sdsÿ’
(content,"\n",1);

1828  
cÚ‹Á
;

1832 
	`»wr™eCÚfigR–—£S‹
(
»wr™eCÚfigS‹
 *
¡©e
) {

1833 
	`sdsä“¥l™»s
(
¡©e
->
lšes
,¡©e->
numlšes
);

1834 
	`diùR–—£
(
¡©e
->
İtiÚ_to_lše
);

1835 
	`diùR–—£
(
¡©e
->
»wr™‹n
);

1836 
	`zä“
(
¡©e
);

1847 
	`»wr™eCÚfigRemoveO½hªed
(
»wr™eCÚfigS‹
 *
¡©e
) {

1848 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
¡©e
->
İtiÚ_to_lše
);

1849 
diùEÁry
 *
de
;

1851 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1852 
li¡
 *
l
 = 
	`diùG‘V®
(
de
);

1853 
sds
 
İtiÚ
 = 
	`diùG‘Key
(
de
);

1857 ià(
	`diùFšd
(
¡©e
->
»wr™‹n
,
İtiÚ
è=ğ
NULL
) {

1858 
	`£rv”Log
(
LL_DEBUG
,"NÙ„ewr™‹ÀİtiÚ: %s", 
İtiÚ
);

1862 
	`li¡L’gth
(
l
)) {

1863 
li¡Node
 *
Ê
 = 
	`li¡Fœ¡
(
l
);

1864 
lš’um
 = (è
Ê
->
v®ue
;

1866 
	`sdsä“
(
¡©e
->
lšes
[
lš’um
]);

1867 
¡©e
->
lšes
[
lš’um
] = 
	`sd£m±y
();

1868 
	`li¡D–Node
(
l
,
Ê
);

1871 
	`diùR–—£I‹¿tÜ
(
di
);

1886 
	`»wr™eCÚfigOv”wr™eFe
(*
cÚfigfe
, 
sds
 
cÚ‹Á
) {

1887 
»tv®
 = 0;

1888 
fd
 = 
	`İ’
(
cÚfigfe
,
O_RDWR
|
O_CREAT
,0644);

1889 
cÚ‹Á_size
 = 
	`sd¦’
(
cÚ‹Á
), 
·ddšg
 = 0;

1890 
¡©
 
sb
;

1891 
sds
 
cÚ‹Á_·dded
;

1895 ià(
fd
 == -1)  -1;

1896 ià(
	`f¡©
(
fd
,&
sb
) == -1) {

1897 
	`şo£
(
fd
);

1902 
cÚ‹Á_·dded
 = 
	`sdsdup
(
cÚ‹Á
);

1903 ià(
cÚ‹Á_size
 < 
sb
.
¡_size
) {

1906 
·ddšg
 = 
sb
.
¡_size
 - 
cÚ‹Á_size
;

1907 
cÚ‹Á_·dded
 = 
	`sdsgrowz”o
(cÚ‹Á_·dded,
sb
.
¡_size
);

1908 
cÚ‹Á_·dded
[
cÚ‹Á_size
] = '\n';

1909 
	`mem£t
(
cÚ‹Á_·dded
+
cÚ‹Á_size
+1,'#',
·ddšg
-1);

1913 ià(
	`wr™e
(
fd
,
cÚ‹Á_·dded
,
	`¡¾’
(content_padded)) == -1) {

1914 
»tv®
 = -1;

1915 
ş—nup
;

1919 ià(
·ddšg
) {

1920 ià(
	`árunÿ‹
(
fd
,
cÚ‹Á_size
) == -1) {

1925 
ş—nup
:

1926 
	`sdsä“
(
cÚ‹Á_·dded
);

1927 
	`şo£
(
fd
);

1928  
»tv®
;

1939 
	`»wr™eCÚfig
(*
·th
) {

1940 
»wr™eCÚfigS‹
 *
¡©e
;

1941 
sds
 
ÃwcÚ‹Á
;

1942 
»tv®
;

1945 ià((
¡©e
 = 
	`»wr™eCÚfigR—dOldFe
(
·th
)è=ğ
NULL
)  -1;

1950 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"d«mÚize",
£rv”
.
d«mÚize
,0);

1951 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"pidfe",
£rv”
.
pidfe
,
CONFIG_DEFAULT_PID_FILE
);

1952 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"pÜt",
£rv”
.
pÜt
,
CONFIG_DEFAULT_SERVER_PORT
);

1953 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"şu¡”-ªnounû-pÜt",
£rv”
.
şu¡”_ªnounû_pÜt
,
CONFIG_DEFAULT_CLUSTER_ANNOUNCE_PORT
);

1954 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"şu¡”-ªnounû-bus-pÜt",
£rv”
.
şu¡”_ªnounû_bus_pÜt
,
CONFIG_DEFAULT_CLUSTER_ANNOUNCE_BUS_PORT
);

1955 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"tı-backlog",
£rv”
.
tı_backlog
,
CONFIG_DEFAULT_TCP_BACKLOG
);

1956 
	`»wr™eCÚfigBšdO±iÚ
(
¡©e
);

1957 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"unixsock‘",
£rv”
.
unixsock‘
,
NULL
);

1958 
	`»wr™eCÚfigOù®O±iÚ
(
¡©e
,"unixsock‘³rm",
£rv”
.
unixsock‘³rm
,
CONFIG_DEFAULT_UNIX_SOCKET_PERM
);

1959 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"timeout",
£rv”
.
maxidËtime
,
CONFIG_DEFAULT_CLIENT_TIMEOUT
);

1960 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"tı-k“·live",
£rv”
.
tık“·live
,
CONFIG_DEFAULT_TCP_KEEPALIVE
);

1961 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"¦ave-ªnounû-pÜt",
£rv”
.
¦ave_ªnounû_pÜt
,
CONFIG_DEFAULT_SLAVE_ANNOUNCE_PORT
);

1962 
	`»wr™eCÚfigEnumO±iÚ
(
¡©e
,"logËv–",
£rv”
.
v”bos™y
,
logËv–_’um
,
CONFIG_DEFAULT_VERBOSITY
);

1963 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"logfe",
£rv”
.
logfe
,
CONFIG_DEFAULT_LOGFILE
);

1964 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"sy¦og-’abËd",
£rv”
.
sy¦og_’abËd
,
CONFIG_DEFAULT_SYSLOG_ENABLED
);

1965 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"sy¦og-id’t",
£rv”
.
sy¦og_id’t
,
CONFIG_DEFAULT_SYSLOG_IDENT
);

1966 
	`»wr™eCÚfigSy¦ogçc™yO±iÚ
(
¡©e
);

1967 
	`»wr™eCÚfigSaveO±iÚ
(
¡©e
);

1968 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"d©aba£s",
£rv”
.
dbnum
,
CONFIG_DEFAULT_DBNUM
);

1969 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"¡İ-wr™es-Ú-bg§ve-”rÜ",
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
,
CONFIG_DEFAULT_STOP_WRITES_ON_BGSAVE_ERROR
);

1970 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"rdbcom´essiÚ",
£rv”
.
rdb_com´essiÚ
,
CONFIG_DEFAULT_RDB_COMPRESSION
);

1971 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"rdbchecksum",
£rv”
.
rdb_checksum
,
CONFIG_DEFAULT_RDB_CHECKSUM
);

1972 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"dbf’ame",
£rv”
.
rdb_f’ame
,
CONFIG_DEFAULT_RDB_FILENAME
);

1973 
	`»wr™eCÚfigDœO±iÚ
(
¡©e
);

1974 
	`»wr™eCÚfigSÏveofO±iÚ
(
¡©e
);

1975 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"¦ave-ªnounû-",
£rv”
.
¦ave_ªnounû_
,
CONFIG_DEFAULT_SLAVE_ANNOUNCE_IP
);

1976 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"ma¡”auth",
£rv”
.
ma¡”auth
,
NULL
);

1977 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"şu¡”-ªnounû-",
£rv”
.
şu¡”_ªnounû_
,
NULL
);

1978 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"¦ave-£rve-¡®e-d©a",
£rv”
.
»¶_£rve_¡®e_d©a
,
CONFIG_DEFAULT_SLAVE_SERVE_STALE_DATA
);

1979 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"¦ave-»ad-Úly",
£rv”
.
»¶_¦ave_ro
,
CONFIG_DEFAULT_SLAVE_READ_ONLY
);

1980 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"»¶-pšg-¦ave-³riod",
£rv”
.
»¶_pšg_¦ave_³riod
,
CONFIG_DEFAULT_REPL_PING_SLAVE_PERIOD
);

1981 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"»¶-timeout",
£rv”
.
»¶_timeout
,
CONFIG_DEFAULT_REPL_TIMEOUT
);

1982 
	`»wr™eCÚfigBy‹sO±iÚ
(
¡©e
,"»¶-backlog-size",
£rv”
.
»¶_backlog_size
,
CONFIG_DEFAULT_REPL_BACKLOG_SIZE
);

1983 
	`»wr™eCÚfigBy‹sO±iÚ
(
¡©e
,"»¶-backlog-‰l",
£rv”
.
»¶_backlog_time_lim™
,
CONFIG_DEFAULT_REPL_BACKLOG_TIME_LIMIT
);

1984 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"»¶-di§bË-tı-nod–ay",
£rv”
.
»¶_di§bË_tı_nod–ay
,
CONFIG_DEFAULT_REPL_DISABLE_TCP_NODELAY
);

1985 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"»¶-diskËss-sync",
£rv”
.
»¶_diskËss_sync
,
CONFIG_DEFAULT_REPL_DISKLESS_SYNC
);

1986 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"»¶-diskËss-sync-d–ay",
£rv”
.
»¶_diskËss_sync_d–ay
,
CONFIG_DEFAULT_REPL_DISKLESS_SYNC_DELAY
);

1987 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"¦ave-´iÜ™y",
£rv”
.
¦ave_´iÜ™y
,
CONFIG_DEFAULT_SLAVE_PRIORITY
);

1988 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"mš-¦aves-to-wr™e",
£rv”
.
»¶_mš_¦aves_to_wr™e
,
CONFIG_DEFAULT_MIN_SLAVES_TO_WRITE
);

1989 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"mš-¦aves-max-Ïg",
£rv”
.
»¶_mš_¦aves_max_Ïg
,
CONFIG_DEFAULT_MIN_SLAVES_MAX_LAG
);

1990 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"»quœ•ass",
£rv”
.
»quœ•ass
,
NULL
);

1991 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"maxş›Ás",
£rv”
.
maxş›Ás
,
CONFIG_DEFAULT_MAX_CLIENTS
);

1992 
	`»wr™eCÚfigBy‹sO±iÚ
(
¡©e
,"maxmemÜy",
£rv”
.
maxmemÜy
,
CONFIG_DEFAULT_MAXMEMORY
);

1993 
	`»wr™eCÚfigEnumO±iÚ
(
¡©e
,"maxmemÜy-pŞicy",
£rv”
.
maxmemÜy_pŞicy
,
maxmemÜy_pŞicy_’um
,
CONFIG_DEFAULT_MAXMEMORY_POLICY
);

1994 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"maxmemÜy-§m¶es",
£rv”
.
maxmemÜy_§m¶es
,
CONFIG_DEFAULT_MAXMEMORY_SAMPLES
);

1995 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"aùive-deäag-th»shŞd-low”",
£rv”
.
aùive_deäag_th»shŞd_low”
,
CONFIG_DEFAULT_DEFRAG_THRESHOLD_LOWER
);

1996 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"aùive-deäag-th»shŞd-uµ”",
£rv”
.
aùive_deäag_th»shŞd_uµ”
,
CONFIG_DEFAULT_DEFRAG_THRESHOLD_UPPER
);

1997 
	`»wr™eCÚfigBy‹sO±iÚ
(
¡©e
,"aùive-deäag-ignÜe-by‹s",
£rv”
.
aùive_deäag_ignÜe_by‹s
,
CONFIG_DEFAULT_DEFRAG_IGNORE_BYTES
);

1998 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"aùive-deäag-cyşe-mš",
£rv”
.
aùive_deäag_cyşe_mš
,
CONFIG_DEFAULT_DEFRAG_CYCLE_MIN
);

1999 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"aùive-deäag-cyşe-max",
£rv”
.
aùive_deäag_cyşe_max
,
CONFIG_DEFAULT_DEFRAG_CYCLE_MAX
);

2000 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"­³ndÚly",
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
,0);

2001 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"­³ndf’ame",
£rv”
.
aof_f’ame
,
CONFIG_DEFAULT_AOF_FILENAME
);

2002 
	`»wr™eCÚfigEnumO±iÚ
(
¡©e
,"­³ndfsync",
£rv”
.
aof_fsync
,
aof_fsync_’um
,
CONFIG_DEFAULT_AOF_FSYNC
);

2003 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"no-­³ndfsync-Ú-»wr™e",
£rv”
.
aof_no_fsync_Ú_»wr™e
,
CONFIG_DEFAULT_AOF_NO_FSYNC_ON_REWRITE
);

2004 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"auto-aof-»wr™e-³rûÁage",
£rv”
.
aof_»wr™e_³rc
,
AOF_REWRITE_PERC
);

2005 
	`»wr™eCÚfigBy‹sO±iÚ
(
¡©e
,"auto-aof-»wr™e-mš-size",
£rv”
.
aof_»wr™e_mš_size
,
AOF_REWRITE_MIN_SIZE
);

2006 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"lua-time-lim™",
£rv”
.
lua_time_lim™
,
LUA_SCRIPT_TIME_LIMIT
);

2007 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"şu¡”-’abËd",
£rv”
.
şu¡”_’abËd
,0);

2008 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"şu¡”-cÚfig-fe",
£rv”
.
şu¡”_cÚfigfe
,
CONFIG_DEFAULT_CLUSTER_CONFIG_FILE
);

2009 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"şu¡”-»quœe-fuÎ-cov”age",
£rv”
.
şu¡”_»quœe_fuÎ_cov”age
,
CLUSTER_DEFAULT_REQUIRE_FULL_COVERAGE
);

2010 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"şu¡”-node-timeout",
£rv”
.
şu¡”_node_timeout
,
CLUSTER_DEFAULT_NODE_TIMEOUT
);

2011 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"şu¡”-mig¿tiÚ-b¬r›r",
£rv”
.
şu¡”_mig¿tiÚ_b¬r›r
,
CLUSTER_DEFAULT_MIGRATION_BARRIER
);

2012 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"şu¡”-¦ave-v®id™y-çùÜ",
£rv”
.
şu¡”_¦ave_v®id™y_çùÜ
,
CLUSTER_DEFAULT_SLAVE_VALIDITY
);

2013 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"¦owlog-log-¦ow”-thª",
£rv”
.
¦owlog_log_¦ow”_thª
,
CONFIG_DEFAULT_SLOWLOG_LOG_SLOWER_THAN
);

2014 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"Ï‹ncy-mÚ™Ü-th»shŞd",
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
,
CONFIG_DEFAULT_LATENCY_MONITOR_THRESHOLD
);

2015 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"¦owlog-max-Ën",
£rv”
.
¦owlog_max_Ën
,
CONFIG_DEFAULT_SLOWLOG_MAX_LEN
);

2016 
	`»wr™eCÚfigNÙifykey¥aûev’tsO±iÚ
(
¡©e
);

2017 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"hash-max-zli¡-’Œ›s",
£rv”
.
hash_max_zli¡_’Œ›s
,
OBJ_HASH_MAX_ZIPLIST_ENTRIES
);

2018 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"hash-max-zli¡-v®ue",
£rv”
.
hash_max_zli¡_v®ue
,
OBJ_HASH_MAX_ZIPLIST_VALUE
);

2019 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"li¡-max-zli¡-size",
£rv”
.
li¡_max_zli¡_size
,
OBJ_LIST_MAX_ZIPLIST_SIZE
);

2020 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"li¡-com´ess-d•th",
£rv”
.
li¡_com´ess_d•th
,
OBJ_LIST_COMPRESS_DEPTH
);

2021 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"£t-max-št£t-’Œ›s",
£rv”
.
£t_max_št£t_’Œ›s
,
OBJ_SET_MAX_INTSET_ENTRIES
);

2022 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"z£t-max-zli¡-’Œ›s",
£rv”
.
z£t_max_zli¡_’Œ›s
,
OBJ_ZSET_MAX_ZIPLIST_ENTRIES
);

2023 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"z£t-max-zli¡-v®ue",
£rv”
.
z£t_max_zli¡_v®ue
,
OBJ_ZSET_MAX_ZIPLIST_VALUE
);

2024 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"hÎ-¥¬£-max-by‹s",
£rv”
.
hÎ_¥¬£_max_by‹s
,
CONFIG_DEFAULT_HLL_SPARSE_MAX_BYTES
);

2025 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"aùiv”ehashšg",
£rv”
.
aùiv”ehashšg
,
CONFIG_DEFAULT_ACTIVE_REHASHING
);

2026 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"aùivedeäag",
£rv”
.
aùive_deäag_’abËd
,
CONFIG_DEFAULT_ACTIVE_DEFRAG
);

2027 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"´Ùeùed-mode",
£rv”
.
´Ùeùed_mode
,
CONFIG_DEFAULT_PROTECTED_MODE
);

2028 
	`»wr™eCÚfigCl›Áouutbufã¾im™O±iÚ
(
¡©e
);

2029 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"hz",
£rv”
.
hz
,
CONFIG_DEFAULT_HZ
);

2030 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"aof-»wr™e-šüem’l-fsync",
£rv”
.
aof_»wr™e_šüem’l_fsync
,
CONFIG_DEFAULT_AOF_REWRITE_INCREMENTAL_FSYNC
);

2031 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"aof-lßd-Œunÿ‹d",
£rv”
.
aof_lßd_Œunÿ‹d
,
CONFIG_DEFAULT_AOF_LOAD_TRUNCATED
);

2032 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"aof-u£-rdb-´—mbË",
£rv”
.
aof_u£_rdb_´—mbË
,
CONFIG_DEFAULT_AOF_USE_RDB_PREAMBLE
);

2033 
	`»wr™eCÚfigEnumO±iÚ
(
¡©e
,"su³rvi£d",
£rv”
.
su³rvi£d_mode
,
su³rvi£d_mode_’um
,
SUPERVISED_NONE
);

2034 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"Ïzyä“-Ïzy-eviùiÚ",
£rv”
.
Ïzyä“_Ïzy_eviùiÚ
,
CONFIG_DEFAULT_LAZYFREE_LAZY_EVICTION
);

2035 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"Ïzyä“-Ïzy-expœe",
£rv”
.
Ïzyä“_Ïzy_expœe
,
CONFIG_DEFAULT_LAZYFREE_LAZY_EXPIRE
);

2036 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"Ïzyä“-Ïzy-£rv”-d–",
£rv”
.
Ïzyä“_Ïzy_£rv”_d–
,
CONFIG_DEFAULT_LAZYFREE_LAZY_SERVER_DEL
);

2037 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"¦ave-Ïzy-æush",
£rv”
.
»¶_¦ave_Ïzy_æush
,
CONFIG_DEFAULT_SLAVE_LAZY_FLUSH
);

2040 ià(
£rv”
.
£Áš–_mode
è
	`»wr™eCÚfigS’tš–O±iÚ
(
¡©e
);

2045 
	`»wr™eCÚfigRemoveO½hªed
(
¡©e
);

2049 
ÃwcÚ‹Á
 = 
	`»wr™eCÚfigG‘CÚ‹ÁFromS‹
(
¡©e
);

2050 
»tv®
 = 
	`»wr™eCÚfigOv”wr™eFe
(
£rv”
.
cÚfigfe
,
ÃwcÚ‹Á
);

2052 
	`sdsä“
(
ÃwcÚ‹Á
);

2053 
	`»wr™eCÚfigR–—£S‹
(
¡©e
);

2054  
»tv®
;

2061 
	`cÚfigCommªd
(
ş›Á
 *
c
) {

2063 ià(
£rv”
.
lßdšg
 && 
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"get")) {

2064 
	`addR•lyE¼Ü
(
c
,"Only CONFIG GET is‡llowed during†oading");

2068 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"set")) {

2069 ià(
c
->
¬gc
 !ğ4è
bad¬™y
;

2070 
	`cÚfigS‘Commªd
(
c
);

2071 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"get")) {

2072 ià(
c
->
¬gc
 !ğ3è
bad¬™y
;

2073 
	`cÚfigG‘Commªd
(
c
);

2074 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"resetstat")) {

2075 ià(
c
->
¬gc
 !ğ2è
bad¬™y
;

2076 
	`»£tS”v”Sts
();

2077 
	`»£tCommªdTabËSts
();

2078 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

2079 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"rewrite")) {

2080 ià(
c
->
¬gc
 !ğ2è
bad¬™y
;

2081 ià(
£rv”
.
cÚfigfe
 =ğ
NULL
) {

2082 
	`addR•lyE¼Ü
(
c
,"The server is„unning without‡ config file");

2085 ià(
	`»wr™eCÚfig
(
£rv”
.
cÚfigfe
) == -1) {

2086 
	`£rv”Log
(
LL_WARNING
,"CONFIG REWRITE faed: %s", 
	`¡»¼Ü
(
”ºo
));

2087 
	`addR•lyE¼ÜFÜm©
(
c
,"Rewr™šg cÚfig fe: %s", 
	`¡»¼Ü
(
”ºo
));

2089 
	`£rv”Log
(
LL_WARNING
,"CONFIG REWRITEƒxecuted with success.");

2090 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

2093 
	`addR•lyE¼Ü
(
c
,

2098 
bad¬™y
:

2099 
	`addR•lyE¼ÜFÜm©
(
c
,"Wrong‚umber of‡rguments for CONFIG %s",

2100 (*è
c
->
¬gv
[1]->
±r
);

	@config.h

30 #iâdeà
__CONFIG_H


31 
	#__CONFIG_H


	)

33 #ifdeà
__APPLE__


34 
	~<Avaab™yMaüos.h
>

37 #ifdeà
__lšux__


38 
	~<lšux/v”siÚ.h
>

39 
	~<ã©u»s.h
>

43 #ià
defšed
(
__APPLE__
è&& !defšed(
MAC_OS_X_VERSION_10_6
)

44 
	#»dis_f¡©
 
f¡©64


	)

45 
	#»dis_¡©
 
¡©64


	)

47 
	#»dis_f¡©
 
f¡©


	)

48 
	#»dis_¡©
 
¡©


	)

52 #ifdeà
__lšux__


53 
	#HAVE_PROC_STAT
 1

	)

54 
	#HAVE_PROC_MAPS
 1

	)

55 
	#HAVE_PROC_SMAPS
 1

	)

56 
	#HAVE_PROC_SOMAXCONN
 1

	)

60 #ià
defšed
(
__APPLE__
)

61 
	#HAVE_TASKINFO
 1

	)

65 #ià
defšed
(
__APPLE__
è|| (defšed(
__lšux__
è&& defšed(
__GLIBC__
))

66 
	#HAVE_BACKTRACE
 1

	)

70 #ifdeà
__lšux__


71 
	#HAVE_MSG_NOSIGNAL
 1

	)

75 #ifdeà
__lšux__


76 
	#HAVE_EPOLL
 1

	)

79 #ià(
defšed
(
__APPLE__
è&& defšed(
MAC_OS_X_VERSION_10_6
)è|| defšed(
__F»eBSD__
è|| defšed(
__O³nBSD__
è|| defšed (
__N‘BSD__
)

80 
	#HAVE_KQUEUE
 1

	)

83 #ifdeà
__sun


84 
	~<sys/ã©u»_‹¡s.h
>

85 #ifdeà
_DTRACE_VERSION


86 
	#HAVE_EVPORT
 1

	)

91 #ifdeà
__lšux__


92 
	#aof_fsync
 
fd©async


	)

94 
	#aof_fsync
 
fsync


	)

99 #ifdeà
__lšux__


100 #ià
defšed
(
__GLIBC__
è&& defšed(
__GLIBC_PREREQ
)

101 #ià(
LINUX_VERSION_CODE
 >ğ0x020611 && 
__GLIBC_PREREQ
(2, 6))

102 
	#HAVE_SYNC_FILE_RANGE
 1

	)

105 #ià(
LINUX_VERSION_CODE
 >= 0x020611)

106 
	#HAVE_SYNC_FILE_RANGE
 1

	)

111 #ifdeà
HAVE_SYNC_FILE_RANGE


112 
	#rdb_fsync_¿nge
(
fd
,
off
,
size
è
	`sync_fe_¿nge
(fd,off,size,
SYNC_FILE_RANGE_WAIT_BEFORE
|
SYNC_FILE_RANGE_WRITE
)

	)

114 
	#rdb_fsync_¿nge
(
fd
,
off
,
size
è
	`fsync
(fd)

	)

120 #ià(
defšed
 
__N‘BSD__
 || defšed 
__F»eBSD__
 || defšed 
__O³nBSD__
)

121 
	#USE_SETPROCTITLE


	)

124 #ià((
defšed
 
__lšux
 && defšed(
__GLIBC__
)è|| defšed 
__APPLE__
)

125 
	#USE_SETPROCTITLE


	)

126 
	#INIT_SETPROCTITLE_REPLACEMENT


	)

127 
¥t_š™
(
¬gc
, *
¬gv
[]);

128 
£roù™Ë
(cÚ¡ *
fmt
, ...);

132 
	~<sys/ty³s.h
>

134 #iâdeà
BYTE_ORDER


135 #ià(
BSD
 >= 199103)

136 
	~<machše/’dŸn.h
>

138 #ià
defšed
(
lšux
è|| defšed(
__lšux__
)

139 
	~<’dŸn.h
>

141 
	#LITTLE_ENDIAN
 1234

	)

142 
	#BIG_ENDIAN
 4321

	)

143 
	#PDP_ENDIAN
 3412

	)

145 #ià
defšed
(
__i386__
è|| defšed(
__x86_64__
è|| defšed(
__amd64__
) || \

146 
defšed
(
vax
è|| defšed(
ns32000
è|| defšed(
sun386
) || \

147 
defšed
(
MIPSEL
è|| defšed(
_MIPSEL
è|| defšed(
BIT_ZERO_ON_RIGHT
) || \

148 
defšed
(
__®pha__
è|| 
	$defšed
(
__®pha
)

149 
	#BYTE_ORDER
 
LITTLE_ENDIAN


	)

152 #ià
	`defšed
(
£l
è|| defšed(
pyr
è|| defšed(
mc68000
è|| defšed(
¥¬c
) || \

153 
	`defšed
(
is68k
è|| defšed(
hÛ
è|| defšed(
ibm032
è|| defšed(
ibm370
) || \

154 
	`defšed
(
MIPSEB
è|| defšed(
_MIPSEB
è|| defšed(
_IBMR2
è|| defšed(
DGUX
) ||\

155 
	`defšed
(
­Şlo
è|| defšed(
__cÚvex__
è|| defšed(
_CRAY
) || \

156 
	`defšed
(
__hµa
è|| defšed(
__hp9000
) || \

157 
	`defšed
(
__hp9000s300
è|| defšed(
__hp9000s700
) || \

158 
	`defšed
 (
BIT_ZERO_ON_LEFT
è|| defšed(
m68k
è|| 
	$defšed
(
__¥¬c
)

159 
	#BYTE_ORDER
 
BIG_ENDIAN


	)

169 #iâdeà
BYTE_ORDER


170 #ifdeà
__BYTE_ORDER


171 #ià
	`defšed
(
__LITTLE_ENDIAN
è&& defšed(
__BIG_ENDIAN
)

172 #iâdeà
LITTLE_ENDIAN


173 
	#LITTLE_ENDIAN
 
__LITTLE_ENDIAN


	)

175 #iâdeà
BIG_ENDIAN


176 
	#BIG_ENDIAN
 
__BIG_ENDIAN


	)

178 #ià(
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN
)

179 
	#BYTE_ORDER
 
LITTLE_ENDIAN


	)

181 
	#BYTE_ORDER
 
BIG_ENDIAN


	)

187 #ià!
	`defšed
(
BYTE_ORDER
) || \

188 (
BYTE_ORDER
 !ğ
BIG_ENDIAN
 && BYTE_ORDER !ğ
LITTLE_ENDIAN
)

197 #ià(
__i386
 || 
__amd64
 || 
__pow”pc__
è&& 
__GNUC__


198 
	#GNUC_VERSION
 (
__GNUC__
 * 10000 + 
__GNUC_MINOR__
 * 100 + 
__GNUC_PATCHLEVEL__
)

	)

199 #ià
	`defšed
(
__şªg__
)

200 
	#HAVE_ATOMIC


	)

202 #ià(
	`defšed
(
__GLIBC__
è&& defšed(
__GLIBC_PREREQ
))

203 #ià(
GNUC_VERSION
 >ğ40100 && 
	`__GLIBC_PREREQ
(2, 6))

204 
	#HAVE_ATOMIC


	)

211 #ià
	`defšed
(
__¬m
è&& !defšed(
__¬m__
)

212 
	#__¬m__


	)

214 #ià
	`defšed
 (
__¯rch64__
è&& !defšed(
__¬m64__
)

215 
	#__¬m64__


	)

219 #ià
	`defšed
(
__¥¬c
è&& !defšed(
__¥¬c__
)

220 
	#__¥¬c__


	)

223 #ià
	`defšed
(
__¥¬c__
è|| defšed(
__¬m__
)

224 
	#USE_ALIGNED_ACCESS


	)

	@crc16.c

1 
	~"£rv”.h
"

47 cÚ¡ 
ušt16_t
 
	güc16b
[256]= {

82 
ušt16_t
 
	$üc16
(cÚ¡ *
buf
, 
Ën
) {

83 
couÁ”
;

84 
ušt16_t
 
üc
 = 0;

85 
couÁ”
 = 0; couÁ” < 
Ën
; counter++)

86 
üc
 = (üc<<8è^ 
üc16b
[((üc>>8è^ *
buf
++)&0x00FF];

87  
üc
;

88 
	}
}

	@crc64.c

40 
	~<¡dšt.h
>

42 cÚ¡ 
ušt64_t
 
	güc64_b
[256] = {

43 
UINT64_C
(0x0000000000000000), UINT64_C(0x7ad870c830358979),

44 
UINT64_C
(0xf5b0e190606b12f2), UINT64_C(0x8f689158505e9b8b),

45 
UINT64_C
(0xc038e5739841b68f), UINT64_C(0xbae095bba8743ff6),

46 
UINT64_C
(0x358804e3f82aa47d), UINT64_C(0x4f50742bc81f2d04),

47 
UINT64_C
(0xab28ecb46814fe75), UINT64_C(0xd1f09c7c5821770c),

48 
UINT64_C
(0x5e980d24087fec87), UINT64_C(0x24407dec384a65fe),

49 
UINT64_C
(0x6b1009c7f05548fa), UINT64_C(0x11c8790fc060c183),

50 
UINT64_C
(0x9ea0e857903e5a08), UINT64_C(0xe478989fa00bd371),

51 
UINT64_C
(0x7d08ff3b88be6f81), UINT64_C(0x07d08ff3b88be6f8),

52 
UINT64_C
(0x88b81eabe8d57d73), UINT64_C(0xf2606e63d8e0f40a),

53 
UINT64_C
(0xbd301a4810ffd90e), UINT64_C(0xc7e86a8020ca5077),

54 
UINT64_C
(0x4880fbd87094cbfc), UINT64_C(0x32588b1040a14285),

55 
UINT64_C
(0xd620138fe0aa91f4), UINT64_C(0xacf86347d09f188d),

56 
UINT64_C
(0x2390f21f80c18306), UINT64_C(0x594882d7b0f40a7f),

57 
UINT64_C
(0x1618f6fc78eb277b), UINT64_C(0x6cc0863448deae02),

58 
UINT64_C
(0xe3a8176c18803589), UINT64_C(0x997067a428b5bcf0),

59 
UINT64_C
(0xfa11fe77117cdf02), UINT64_C(0x80c98ebf2149567b),

60 
UINT64_C
(0x0fa11fe77117cdf0), UINT64_C(0x75796f2f41224489),

61 
UINT64_C
(0x3a291b04893d698d), UINT64_C(0x40f16bccb908e0f4),

62 
UINT64_C
(0xcf99fa94e9567b7f), UINT64_C(0xb5418a5cd963f206),

63 
UINT64_C
(0x513912c379682177), UINT64_C(0x2be1620b495da80e),

64 
UINT64_C
(0xa489f35319033385), UINT64_C(0xde51839b2936bafc),

65 
UINT64_C
(0x9101f7b0e12997f8), UINT64_C(0xebd98778d11c1e81),

66 
UINT64_C
(0x64b116208142850a), UINT64_C(0x1e6966e8b1770c73),

67 
UINT64_C
(0x8719014c99c2b083), UINT64_C(0xfdc17184a9f739fa),

68 
UINT64_C
(0x72a9e0dcf9a9a271), UINT64_C(0x08719014c99c2b08),

69 
UINT64_C
(0x4721e43f0183060c), UINT64_C(0x3df994f731b68f75),

70 
UINT64_C
(0xb29105af61e814fe), UINT64_C(0xc849756751dd9d87),

71 
UINT64_C
(0x2c31edf8f1d64ef6), UINT64_C(0x56e99d30c1e3c78f),

72 
UINT64_C
(0xd9810c6891bd5c04), UINT64_C(0xa3597ca0a188d57d),

73 
UINT64_C
(0xec09088b6997f879), UINT64_C(0x96d1784359a27100),

74 
UINT64_C
(0x19b9e91b09fcea8b), UINT64_C(0x636199d339c963f2),

75 
UINT64_C
(0xdf7adabd7a6e2d6f), UINT64_C(0xa5a2aa754a5ba416),

76 
UINT64_C
(0x2aca3b2d1a053f9d), UINT64_C(0x50124be52a30b6e4),

77 
UINT64_C
(0x1f423fcee22f9be0), UINT64_C(0x659a4f06d21a1299),

78 
UINT64_C
(0xeaf2de5e82448912), UINT64_C(0x902aae96b271006b),

79 
UINT64_C
(0x74523609127ad31a), UINT64_C(0x0e8a46c1224f5a63),

80 
UINT64_C
(0x81e2d7997211c1e8), UINT64_C(0xfb3aa75142244891),

81 
UINT64_C
(0xb46ad37a8a3b6595), UINT64_C(0xceb2a3b2ba0eecec),

82 
UINT64_C
(0x41da32eaea507767), UINT64_C(0x3b024222da65fe1e),

83 
UINT64_C
(0xa2722586f2d042ee), UINT64_C(0xd8aa554ec2e5cb97),

84 
UINT64_C
(0x57c2c41692bb501c), UINT64_C(0x2d1ab4dea28ed965),

85 
UINT64_C
(0x624ac0f56a91f461), UINT64_C(0x1892b03d5aa47d18),

86 
UINT64_C
(0x97fa21650afae693), UINT64_C(0xed2251ad3acf6fea),

87 
UINT64_C
(0x095ac9329ac4bc9b), UINT64_C(0x7382b9faaaf135e2),

88 
UINT64_C
(0xfcea28a2faafae69), UINT64_C(0x8632586aca9a2710),

89 
UINT64_C
(0xc9622c4102850a14), UINT64_C(0xb3ba5c8932b0836d),

90 
UINT64_C
(0x3cd2cdd162ee18e6), UINT64_C(0x460abd1952db919f),

91 
UINT64_C
(0x256b24ca6b12f26d), UINT64_C(0x5fb354025b277b14),

92 
UINT64_C
(0xd0dbc55a0b79e09f), UINT64_C(0xaa03b5923b4c69e6),

93 
UINT64_C
(0xe553c1b9f35344e2), UINT64_C(0x9f8bb171c366cd9b),

94 
UINT64_C
(0x10e3202993385610), UINT64_C(0x6a3b50e1a30ddf69),

95 
UINT64_C
(0x8e43c87e03060c18), UINT64_C(0xf49bb8b633338561),

96 
UINT64_C
(0x7bf329ee636d1eea), UINT64_C(0x012b592653589793),

97 
UINT64_C
(0x4e7b2d0d9b47ba97), UINT64_C(0x34a35dc5ab7233ee),

98 
UINT64_C
(0xbbcbcc9dfb2ca865), UINT64_C(0xc113bc55cb19211c),

99 
UINT64_C
(0x5863dbf1e3ac9dec), UINT64_C(0x22bbab39d3991495),

100 
UINT64_C
(0xadd33a6183c78f1e), UINT64_C(0xd70b4aa9b3f20667),

101 
UINT64_C
(0x985b3e827bed2b63), UINT64_C(0xe2834e4a4bd8a21a),

102 
UINT64_C
(0x6debdf121b863991), UINT64_C(0x1733afda2bb3b0e8),

103 
UINT64_C
(0xf34b37458bb86399), UINT64_C(0x8993478dbb8deae0),

104 
UINT64_C
(0x06fbd6d5ebd3716b), UINT64_C(0x7c23a61ddbe6f812),

105 
UINT64_C
(0x3373d23613f9d516), UINT64_C(0x49aba2fe23cc5c6f),

106 
UINT64_C
(0xc6c333a67392c7e4), UINT64_C(0xbc1b436e43a74e9d),

107 
UINT64_C
(0x95ac9329ac4bc9b5), UINT64_C(0xef74e3e19c7e40cc),

108 
UINT64_C
(0x601c72b9cc20db47), UINT64_C(0x1ac40271fc15523e),

109 
UINT64_C
(0x5594765a340a7f3a), UINT64_C(0x2f4c0692043ff643),

110 
UINT64_C
(0xa02497ca54616dc8), UINT64_C(0xdafce7026454e4b1),

111 
UINT64_C
(0x3e847f9dc45f37c0), UINT64_C(0x445c0f55f46abeb9),

112 
UINT64_C
(0xcb349e0da4342532), UINT64_C(0xb1eceec59401ac4b),

113 
UINT64_C
(0xfebc9aee5c1e814f), UINT64_C(0x8464ea266c2b0836),

114 
UINT64_C
(0x0b0c7b7e3c7593bd), UINT64_C(0x71d40bb60c401ac4),

115 
UINT64_C
(0xe8a46c1224f5a634), UINT64_C(0x927c1cda14c02f4d),

116 
UINT64_C
(0x1d148d82449eb4c6), UINT64_C(0x67ccfd4a74ab3dbf),

117 
UINT64_C
(0x289c8961bcb410bb), UINT64_C(0x5244f9a98c8199c2),

118 
UINT64_C
(0xdd2c68f1dcdf0249), UINT64_C(0xa7f41839ecea8b30),

119 
UINT64_C
(0x438c80a64ce15841), UINT64_C(0x3954f06e7cd4d138),

120 
UINT64_C
(0xb63c61362c8a4ab3), UINT64_C(0xcce411fe1cbfc3ca),

121 
UINT64_C
(0x83b465d5d4a0eece), UINT64_C(0xf96c151de49567b7),

122 
UINT64_C
(0x76048445b4cbfc3c), UINT64_C(0x0cdcf48d84fe7545),

123 
UINT64_C
(0x6fbd6d5ebd3716b7), UINT64_C(0x15651d968d029fce),

124 
UINT64_C
(0x9a0d8ccedd5c0445), UINT64_C(0xe0d5fc06ed698d3c),

125 
UINT64_C
(0xaf85882d2576a038), UINT64_C(0xd55df8e515432941),

126 
UINT64_C
(0x5a3569bd451db2ca), UINT64_C(0x20ed197575283bb3),

127 
UINT64_C
(0xc49581ead523e8c2), UINT64_C(0xbe4df122e51661bb),

128 
UINT64_C
(0x3125607ab548fa30), UINT64_C(0x4bfd10b2857d7349),

129 
UINT64_C
(0x04ad64994d625e4d), UINT64_C(0x7e7514517d57d734),

130 
UINT64_C
(0xf11d85092d094cbf), UINT64_C(0x8bc5f5c11d3cc5c6),

131 
UINT64_C
(0x12b5926535897936), UINT64_C(0x686de2ad05bcf04f),

132 
UINT64_C
(0xe70573f555e26bc4), UINT64_C(0x9ddd033d65d7e2bd),

133 
UINT64_C
(0xd28d7716adc8cfb9), UINT64_C(0xa85507de9dfd46c0),

134 
UINT64_C
(0x273d9686cda3dd4b), UINT64_C(0x5de5e64efd965432),

135 
UINT64_C
(0xb99d7ed15d9d8743), UINT64_C(0xc3450e196da80e3a),

136 
UINT64_C
(0x4c2d9f413df695b1), UINT64_C(0x36f5ef890dc31cc8),

137 
UINT64_C
(0x79a59ba2c5dc31cc), UINT64_C(0x037deb6af5e9b8b5),

138 
UINT64_C
(0x8c157a32a5b7233e), UINT64_C(0xf6cd0afa9582aa47),

139 
UINT64_C
(0x4ad64994d625e4da), UINT64_C(0x300e395ce6106da3),

140 
UINT64_C
(0xbf66a804b64ef628), UINT64_C(0xc5bed8cc867b7f51),

141 
UINT64_C
(0x8aeeace74e645255), UINT64_C(0xf036dc2f7e51db2c),

142 
UINT64_C
(0x7f5e4d772e0f40a7), UINT64_C(0x05863dbf1e3ac9de),

143 
UINT64_C
(0xe1fea520be311aaf), UINT64_C(0x9b26d5e88e0493d6),

144 
UINT64_C
(0x144e44b0de5a085d), UINT64_C(0x6e963478ee6f8124),

145 
UINT64_C
(0x21c640532670ac20), UINT64_C(0x5b1e309b16452559),

146 
UINT64_C
(0xd476a1c3461bbed2), UINT64_C(0xaeaed10b762e37ab),

147 
UINT64_C
(0x37deb6af5e9b8b5b), UINT64_C(0x4d06c6676eae0222),

148 
UINT64_C
(0xc26e573f3ef099a9), UINT64_C(0xb8b627f70ec510d0),

149 
UINT64_C
(0xf7e653dcc6da3dd4), UINT64_C(0x8d3e2314f6efb4ad),

150 
UINT64_C
(0x0256b24ca6b12f26), UINT64_C(0x788ec2849684a65f),

151 
UINT64_C
(0x9cf65a1b368f752e), UINT64_C(0xe62e2ad306bafc57),

152 
UINT64_C
(0x6946bb8b56e467dc), UINT64_C(0x139ecb4366d1eea5),

153 
UINT64_C
(0x5ccebf68aecec3a1), UINT64_C(0x2616cfa09efb4ad8),

154 
UINT64_C
(0xa97e5ef8cea5d153), UINT64_C(0xd3a62e30fe90582a),

155 
UINT64_C
(0xb0c7b7e3c7593bd8), UINT64_C(0xca1fc72bf76cb2a1),

156 
UINT64_C
(0x45775673a732292a), UINT64_C(0x3faf26bb9707a053),

157 
UINT64_C
(0x70ff52905f188d57), UINT64_C(0x0a2722586f2d042e),

158 
UINT64_C
(0x854fb3003f739fa5), UINT64_C(0xff97c3c80f4616dc),

159 
UINT64_C
(0x1bef5b57af4dc5ad), UINT64_C(0x61372b9f9f784cd4),

160 
UINT64_C
(0xee5fbac7cf26d75f), UINT64_C(0x9487ca0fff135e26),

161 
UINT64_C
(0xdbd7be24370c7322), UINT64_C(0xa10fceec0739fa5b),

162 
UINT64_C
(0x2e675fb4576761d0), UINT64_C(0x54bf2f7c6752e8a9),

163 
UINT64_C
(0xcdcf48d84fe75459), UINT64_C(0xb71738107fd2dd20),

164 
UINT64_C
(0x387fa9482f8c46ab), UINT64_C(0x42a7d9801fb9cfd2),

165 
UINT64_C
(0x0df7adabd7a6e2d6), UINT64_C(0x772fdd63e7936baf),

166 
UINT64_C
(0xf8474c3bb7cdf024), UINT64_C(0x829f3cf387f8795d),

167 
UINT64_C
(0x66e7a46c27f3aa2c), UINT64_C(0x1c3fd4a417c62355),

168 
UINT64_C
(0x935745fc4798b8de), UINT64_C(0xe98f353477ad31a7),

169 
UINT64_C
(0xa6df411fbfb21ca3), UINT64_C(0xdc0731d78f8795da),

170 
UINT64_C
(0x536fa08fdfd90e51), UINT64_C(0x29b7d047efec8728),

173 
ušt64_t
 
	$üc64
(
ušt64_t
 
üc
, cÚ¡ *
s
, ušt64_ˆ
l
) {

174 
ušt64_t
 
j
;

176 
j
 = 0; j < 
l
; j++) {

177 
ušt8_t
 
by‹
 = 
s
[
j
];

178 
üc
 = 
üc64_b
[(
ušt8_t
)üø^ 
by‹
] ^ (crc >> 8);

180  
üc
;

181 
	}
}

184 #ifdeà
REDIS_TEST


185 
	~<¡dio.h
>

187 
	#UNUSED
(
x
è()(x)

	)

188 
	$üc64Te¡
(
¬gc
, *
¬gv
[]) {

189 
	`UNUSED
(
¬gc
);

190 
	`UNUSED
(
¬gv
);

191 
	`´štf
("e9c6d914c4b8d9ca == %016llx\n",

192 (è
	`üc64
(0,(*)"123456789",9));

194 
	}
}

	@crc64.h

1 #iâdeà
CRC64_H


2 
	#CRC64_H


	)

4 
	~<¡dšt.h
>

6 
ušt64_t
 
üc64
(ušt64_ˆ
üc
, cÚ¡ *
s
, ušt64_ˆ
l
);

8 #ifdeà
REDIS_TEST


9 
üc64Te¡
(
¬gc
, *
¬gv
[]);

	@db.c

30 
	~"£rv”.h
"

31 
	~"şu¡”.h
"

32 
	~"©omicv¬.h
"

34 
	~<sigÇl.h
>

35 
	~<ùy³.h
>

44 
robj
 *
	$lookupKey
(
»disDb
 *
db
, 
robj
 *
key
, 
æags
) {

45 
diùEÁry
 *
de
 = 
	`diùFšd
(
db
->
diù
,
key
->
±r
);

46 ià(
de
) {

47 
robj
 *
v®
 = 
	`diùG‘V®
(
de
);

52 ià(
£rv”
.
rdb_chd_pid
 == -1 &&

53 
£rv”
.
aof_chd_pid
 == -1 &&

54 !(
æags
 & 
LOOKUP_NOTOUCH
))

56 ià(
£rv”
.
maxmemÜy_pŞicy
 & 
MAXMEMORY_FLAG_LFU
) {

57 
ldt
 = 
v®
->
Ìu
 >> 8;

58 
couÁ”
 = 
	`LFULogInü
(
v®
->
Ìu
 & 255);

59 
v®
->
Ìu
 = (
ldt
 << 8è| 
couÁ”
;

61 
v®
->
Ìu
 = 
	`LRU_CLOCK
();

64  
v®
;

66  
NULL
;

68 
	}
}

91 
robj
 *
	$lookupKeyR—dW™hFÏgs
(
»disDb
 *
db
, 
robj
 *
key
, 
æags
) {

92 
robj
 *
v®
;

94 ià(
	`expœeIfN“ded
(
db
,
key
) == 1) {

98 ià(
£rv”
.
ma¡”ho¡
 =ğ
NULL
)  NULL;

112 ià(
£rv”
.
cu¼’t_ş›Á
 &&

113 
£rv”
.
cu¼’t_ş›Á
 !ğ£rv”.
ma¡”
 &&

114 
£rv”
.
cu¼’t_ş›Á
->
cmd
 &&

115 
£rv”
.
cu¼’t_ş›Á
->
cmd
->
æags
 & 
CMD_READONLY
)

117  
NULL
;

120 
v®
 = 
	`lookupKey
(
db
,
key
,
æags
);

121 ià(
v®
 =ğ
NULL
)

122 
£rv”
.
¡©_key¥aû_mis£s
++;

124 
£rv”
.
¡©_key¥aû_h™s
++;

125  
v®
;

126 
	}
}

130 
robj
 *
	$lookupKeyR—d
(
»disDb
 *
db
, 
robj
 *
key
) {

131  
	`lookupKeyR—dW™hFÏgs
(
db
,
key
,
LOOKUP_NONE
);

132 
	}
}

139 
robj
 *
	$lookupKeyWr™e
(
»disDb
 *
db
, 
robj
 *
key
) {

140 
	`expœeIfN“ded
(
db
,
key
);

141  
	`lookupKey
(
db
,
key
,
LOOKUP_NONE
);

142 
	}
}

144 
robj
 *
	$lookupKeyR—dOrR•ly
(
ş›Á
 *
c
, 
robj
 *
key
,„obj *
»¶y
) {

145 
robj
 *
o
 = 
	`lookupKeyR—d
(
c
->
db
, 
key
);

146 ià(!
o
è
	`addR•ly
(
c
,
»¶y
);

147  
o
;

148 
	}
}

150 
robj
 *
	$lookupKeyWr™eOrR•ly
(
ş›Á
 *
c
, 
robj
 *
key
,„obj *
»¶y
) {

151 
robj
 *
o
 = 
	`lookupKeyWr™e
(
c
->
db
, 
key
);

152 ià(!
o
è
	`addR•ly
(
c
,
»¶y
);

153  
o
;

154 
	}
}

160 
	$dbAdd
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
) {

161 
sds
 
cİy
 = 
	`sdsdup
(
key
->
±r
);

162 
»tv®
 = 
	`diùAdd
(
db
->
diù
, 
cİy
, 
v®
);

164 
	`£rv”As£¹W™hInfo
(
NULL
,
key
,
»tv®
 =ğ
DICT_OK
);

165 ià(
v®
->
ty³
 =ğ
OBJ_LIST
è
	`sigÇlLi¡AsR—dy
(
db
, 
key
);

166 ià(
£rv”
.
şu¡”_’abËd
è
	`¦ÙToKeyAdd
(
key
);

167 
	}
}

174 
	$dbOv”wr™e
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
) {

175 
diùEÁry
 *
de
 = 
	`diùFšd
(
db
->
diù
,
key
->
±r
);

177 
	`£rv”As£¹W™hInfo
(
NULL
,
key
,
de
 != NULL);

178 ià(
£rv”
.
maxmemÜy_pŞicy
 & 
MAXMEMORY_FLAG_LFU
) {

179 
robj
 *
Şd
 = 
	`diùG‘V®
(
de
);

180 
§ved_Ìu
 = 
Şd
->
Ìu
;

181 
	`diùR•Ïû
(
db
->
diù
, 
key
->
±r
, 
v®
);

182 
v®
->
Ìu
 = 
§ved_Ìu
;

184 
	`diùR•Ïû
(
db
->
diù
, 
key
->
±r
, 
v®
);

186 
	}
}

196 
	$£tKey
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
) {

197 ià(
	`lookupKeyWr™e
(
db
,
key
è=ğ
NULL
) {

198 
	`dbAdd
(
db
,
key
,
v®
);

200 
	`dbOv”wr™e
(
db
,
key
,
v®
);

202 
	`šüRefCouÁ
(
v®
);

203 
	`»moveExpœe
(
db
,
key
);

204 
	`sigÇlModif›dKey
(
db
,
key
);

205 
	}
}

207 
	$dbExi¡s
(
»disDb
 *
db
, 
robj
 *
key
) {

208  
	`diùFšd
(
db
->
diù
,
key
->
±r
è!ğ
NULL
;

209 
	}
}

215 
robj
 *
	$dbRªdomKey
(
»disDb
 *
db
) {

216 
diùEÁry
 *
de
;

219 
sds
 
key
;

220 
robj
 *
keyobj
;

222 
de
 = 
	`diùG‘RªdomKey
(
db
->
diù
);

223 ià(
de
 =ğ
NULL
)  NULL;

225 
key
 = 
	`diùG‘Key
(
de
);

226 
keyobj
 = 
	`ü—‹SŒšgObjeù
(
key
,
	`sd¦’
(key));

227 ià(
	`diùFšd
(
db
->
expœes
,
key
)) {

228 ià(
	`expœeIfN“ded
(
db
,
keyobj
)) {

229 
	`deüRefCouÁ
(
keyobj
);

233  
keyobj
;

235 
	}
}

238 
	$dbSyncD–‘e
(
»disDb
 *
db
, 
robj
 *
key
) {

241 ià(
	`diùSize
(
db
->
expœes
è> 0è
	`diùD–‘e
(db->expœes,
key
->
±r
);

242 ià(
	`diùD–‘e
(
db
->
diù
,
key
->
±r
è=ğ
DICT_OK
) {

243 ià(
£rv”
.
şu¡”_’abËd
è
	`¦ÙToKeyD–
(
key
);

248 
	}
}

252 
	$dbD–‘e
(
»disDb
 *
db
, 
robj
 *
key
) {

253  
£rv”
.
Ïzyä“_Ïzy_£rv”_d–
 ? 
	`dbAsyncD–‘e
(
db
,
key
) :

254 
	`dbSyncD–‘e
(
db
,
key
);

255 
	}
}

284 
robj
 *
	$dbUnsh¬eSŒšgV®ue
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
o
) {

285 
	`£rv”As£¹
(
o
->
ty³
 =ğ
OBJ_STRING
);

286 ià(
o
->
»fcouÁ
 !ğ1 || o->
’codšg
 !ğ
OBJ_ENCODING_RAW
) {

287 
robj
 *
decoded
 = 
	`g‘DecodedObjeù
(
o
);

288 
o
 = 
	`ü—‹RawSŒšgObjeù
(
decoded
->
±r
, 
	`sd¦’
(decoded->ptr));

289 
	`deüRefCouÁ
(
decoded
);

290 
	`dbOv”wr™e
(
db
,
key
,
o
);

292  
o
;

293 
	}
}

309 
em±yDb
(
dbnum
, 
æags
, (
ÿÎback
)(*)) {

310 
j
, 
async
 = (
æags
 & 
EMPTYDB_ASYNC
);

311 
»moved
 = 0;

313 ià(
dbnum
 < -1 || dbnum >ğ
£rv”
.dbnum) {

314 
”ºo
 = 
EINVAL
;

318 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

319 ià(
dbnum
 !ğ-1 && dbnum !ğ
j
) ;

320 
»moved
 +ğ
	`diùSize
(
£rv”
.
db
[
j
].
diù
);

321 ià(
async
) {

322 
	`em±yDbAsync
(&
£rv”
.
db
[
j
]);

324 
	`diùEm±y
(
£rv”
.
db
[
j
].
diù
,
ÿÎback
);

325 
	`diùEm±y
(
£rv”
.
db
[
j
].
expœes
,
ÿÎback
);

328 ià(
£rv”
.
şu¡”_’abËd
) {

329 ià(
async
) {

330 
	`¦ÙToKeyFlushAsync
();

332 
	`¦ÙToKeyFlush
();

335 ià(
dbnum
 =ğ-1è
	`æushSÏveKeysW™hExpœeLi¡
();

336  
»moved
;

337 
	}
}

339 
	$£ËùDb
(
ş›Á
 *
c
, 
id
) {

340 ià(
id
 < 0 || id >ğ
£rv”
.
dbnum
)

341  
C_ERR
;

342 
c
->
db
 = &
£rv”
.db[
id
];

343  
C_OK
;

344 
	}
}

355 
	$sigÇlModif›dKey
(
»disDb
 *
db
, 
robj
 *
key
) {

356 
	`touchW©chedKey
(
db
,
key
);

357 
	}
}

359 
	$sigÇlFlushedDb
(
dbid
) {

360 
	`touchW©chedKeysOnFlush
(
dbid
);

361 
	}
}

375 
	$g‘FlushCommªdFÏgs
(
ş›Á
 *
c
, *
æags
) {

377 ià(
c
->
¬gc
 > 1) {

378 ià(
c
->
¬gc
 > 2 || 
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"async")) {

379 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

380  
C_ERR
;

382 *
æags
 = 
EMPTYDB_ASYNC
;

384 *
æags
 = 
EMPTYDB_NO_FLAGS
;

386  
C_OK
;

387 
	}
}

392 
	$æushdbCommªd
(
ş›Á
 *
c
) {

393 
æags
;

395 ià(
	`g‘FlushCommªdFÏgs
(
c
,&
æags
è=ğ
C_ERR
) ;

396 
	`sigÇlFlushedDb
(
c
->
db
->
id
);

397 
£rv”
.
dœty
 +ğ
	`em±yDb
(
c
->
db
->
id
,
æags
,
NULL
);

398 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

399 
	}
}

404 
	$æush®lCommªd
(
ş›Á
 *
c
) {

405 
æags
;

407 ià(
	`g‘FlushCommªdFÏgs
(
c
,&
æags
è=ğ
C_ERR
) ;

408 
	`sigÇlFlushedDb
(-1);

409 
£rv”
.
dœty
 +ğ
	`em±yDb
(-1,
æags
,
NULL
);

410 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

411 ià(
£rv”
.
rdb_chd_pid
 != -1) {

412 
	`kl
(
£rv”
.
rdb_chd_pid
,
SIGUSR1
);

413 
	`rdbRemoveTempFe
(
£rv”
.
rdb_chd_pid
);

415 ià(
£rv”
.
§v•¬am¦’
 > 0) {

418 
§ved_dœty
 = 
£rv”
.
dœty
;

419 
	`rdbSave
(
£rv”
.
rdb_f’ame
,
NULL
);

420 
£rv”
.
dœty
 = 
§ved_dœty
;

422 
£rv”
.
dœty
++;

423 
	}
}

426 
	$d–G’”icCommªd
(
ş›Á
 *
c
, 
Ïzy
) {

427 
numd–
 = 0, 
j
;

429 
j
 = 1; j < 
c
->
¬gc
; j++) {

430 
	`expœeIfN“ded
(
c
->
db
,c->
¬gv
[
j
]);

431 
d–‘ed
 = 
Ïzy
 ? 
	`dbAsyncD–‘e
(
c
->
db
,c->
¬gv
[
j
]) :

432 
	`dbSyncD–‘e
(
c
->
db
,c->
¬gv
[
j
]);

433 ià(
d–‘ed
) {

434 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[
j
]);

435 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,

436 "d–",
c
->
¬gv
[
j
],c->
db
->
id
);

437 
£rv”
.
dœty
++;

438 
numd–
++;

441 
	`addR•lyLÚgLÚg
(
c
,
numd–
);

442 
	}
}

444 
	$d–Commªd
(
ş›Á
 *
c
) {

445 
	`d–G’”icCommªd
(
c
,0);

446 
	}
}

448 
	$uÆškCommªd
(
ş›Á
 *
c
) {

449 
	`d–G’”icCommªd
(
c
,1);

450 
	}
}

454 
	$exi¡sCommªd
(
ş›Á
 *
c
) {

455 
couÁ
 = 0;

456 
j
;

458 
j
 = 1; j < 
c
->
¬gc
; j++) {

459 
	`expœeIfN“ded
(
c
->
db
,c->
¬gv
[
j
]);

460 ià(
	`dbExi¡s
(
c
->
db
,c->
¬gv
[
j
])è
couÁ
++;

462 
	`addR•lyLÚgLÚg
(
c
,
couÁ
);

463 
	}
}

465 
	$£ËùCommªd
(
ş›Á
 *
c
) {

466 
id
;

468 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[1], &
id
,

469 "šv®id DB index"è!ğ
C_OK
)

472 ià(
£rv”
.
şu¡”_’abËd
 && 
id
 != 0) {

473 
	`addR•lyE¼Ü
(
c
,"SELECT is‚ot‡llowed in cluster mode");

476 ià(
	`£ËùDb
(
c
,
id
è=ğ
C_ERR
) {

477 
	`addR•lyE¼Ü
(
c
,"DB index is out of„ange");

479 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

481 
	}
}

483 
	$¿ndomkeyCommªd
(
ş›Á
 *
c
) {

484 
robj
 *
key
;

486 ià((
key
 = 
	`dbRªdomKey
(
c
->
db
)è=ğ
NULL
) {

487 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

491 
	`addR•lyBulk
(
c
,
key
);

492 
	`deüRefCouÁ
(
key
);

493 
	}
}

495 
	$keysCommªd
(
ş›Á
 *
c
) {

496 
diùI‹¿tÜ
 *
di
;

497 
diùEÁry
 *
de
;

498 
sds
 
·‰”n
 = 
c
->
¬gv
[1]->
±r
;

499 
¶’
 = 
	`sd¦’
(
·‰”n
), 
®lkeys
;

500 
numkeys
 = 0;

501 *
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

503 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
c
->
db
->
diù
);

504 
®lkeys
 = (
·‰”n
[0] == '*' &&…attern[1] == '\0');

505 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

506 
sds
 
key
 = 
	`diùG‘Key
(
de
);

507 
robj
 *
keyobj
;

509 ià(
®lkeys
 || 
	`¡ršgm©chËn
(
·‰”n
,
¶’
,
key
,
	`sd¦’
(key),0)) {

510 
keyobj
 = 
	`ü—‹SŒšgObjeù
(
key
,
	`sd¦’
(key));

511 ià(
	`expœeIfN“ded
(
c
->
db
,
keyobj
) == 0) {

512 
	`addR•lyBulk
(
c
,
keyobj
);

513 
numkeys
++;

515 
	`deüRefCouÁ
(
keyobj
);

518 
	`diùR–—£I‹¿tÜ
(
di
);

519 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn
,
numkeys
);

520 
	}
}

524 
	$sÿnC®lback
(*
´ivd©a
, cÚ¡ 
diùEÁry
 *
de
) {

525 **
pd
 = (**è
´ivd©a
;

526 
li¡
 *
keys
 = 
pd
[0];

527 
robj
 *
o
 = 
pd
[1];

528 
robj
 *
key
, *
v®
 = 
NULL
;

530 ià(
o
 =ğ
NULL
) {

531 
sds
 
sdskey
 = 
	`diùG‘Key
(
de
);

532 
key
 = 
	`ü—‹SŒšgObjeù
(
sdskey
, 
	`sd¦’
(sdskey));

533 } ià(
o
->
ty³
 =ğ
OBJ_SET
) {

534 
sds
 
keysds
 = 
	`diùG‘Key
(
de
);

535 
key
 = 
	`ü—‹SŒšgObjeù
(
keysds
,
	`sd¦’
(keysds));

536 } ià(
o
->
ty³
 =ğ
OBJ_HASH
) {

537 
sds
 
sdskey
 = 
	`diùG‘Key
(
de
);

538 
sds
 
sdsv®
 = 
	`diùG‘V®
(
de
);

539 
key
 = 
	`ü—‹SŒšgObjeù
(
sdskey
,
	`sd¦’
(sdskey));

540 
v®
 = 
	`ü—‹SŒšgObjeù
(
sdsv®
,
	`sd¦’
(sdsval));

541 } ià(
o
->
ty³
 =ğ
OBJ_ZSET
) {

542 
sds
 
sdskey
 = 
	`diùG‘Key
(
de
);

543 
key
 = 
	`ü—‹SŒšgObjeù
(
sdskey
,
	`sd¦’
(sdskey));

544 
v®
 = 
	`ü—‹SŒšgObjeùFromLÚgDoubË
(*(*)
	`diùG‘V®
(
de
),0);

546 
	`£rv”Pªic
("Type‚ot handled in SCAN callback.");

549 
	`li¡AddNodeTa
(
keys
, 
key
);

550 ià(
v®
è
	`li¡AddNodeTa
(
keys
, val);

551 
	}
}

557 
	$·r£SÿnCursÜOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
cursÜ
) {

558 *
•Œ
;

562 
”ºo
 = 0;

563 *
cursÜ
 = 
	`¡¹oul
(
o
->
±r
, &
•Œ
, 10);

564 ià(
	`is¥aû
(((*)
o
->
±r
)[0]è|| 
•Œ
[0] !ğ'\0' || 
”ºo
 =ğ
ERANGE
)

566 
	`addR•lyE¼Ü
(
c
, "invalid cursor");

567  
C_ERR
;

569  
C_OK
;

570 
	}
}

583 
	$sÿnG’”icCommªd
(
ş›Á
 *
c
, 
robj
 *
o
, 
cursÜ
) {

584 
i
, 
j
;

585 
li¡
 *
keys
 = 
	`li¡C»©e
();

586 
li¡Node
 *
node
, *
ÃxŠode
;

587 
couÁ
 = 10;

588 
sds
 
·t
 = 
NULL
;

589 
·’
 = 0, 
u£_·‰”n
 = 0;

590 
diù
 *
ht
;

594 
	`£rv”As£¹
(
o
 =ğ
NULL
 || o->
ty³
 =ğ
OBJ_SET
 || o->ty³ =ğ
OBJ_HASH
 ||

595 
o
->
ty³
 =ğ
OBJ_ZSET
);

598 
i
 = (
o
 =ğ
NULL
) ? 2 : 3;

601 
i
 < 
c
->
¬gc
) {

602 
j
 = 
c
->
¬gc
 - 
i
;

603 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
, "couÁ"è&& 
j
 >= 2) {

604 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
i
+1], &
couÁ
, 
NULL
)

605 !ğ
C_OK
)

607 
ş—nup
;

610 ià(
couÁ
 < 1) {

611 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

612 
ş—nup
;

615 
i
 += 2;

616 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
, "m©ch"è&& 
j
 >= 2) {

617 
·t
 = 
c
->
¬gv
[
i
+1]->
±r
;

618 
·’
 = 
	`sd¦’
(
·t
);

622 
u£_·‰”n
 = !(
·t
[0] =ğ'*' && 
·’
 == 1);

624 
i
 += 2;

626 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

627 
ş—nup
;

640 
ht
 = 
NULL
;

641 ià(
o
 =ğ
NULL
) {

642 
ht
 = 
c
->
db
->
diù
;

643 } ià(
o
->
ty³
 =ğ
OBJ_SET
 && o->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

644 
ht
 = 
o
->
±r
;

645 } ià(
o
->
ty³
 =ğ
OBJ_HASH
 && o->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

646 
ht
 = 
o
->
±r
;

647 
couÁ
 *= 2;

648 } ià(
o
->
ty³
 =ğ
OBJ_ZSET
 && o->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

649 
z£t
 *
zs
 = 
o
->
±r
;

650 
ht
 = 
zs
->
diù
;

651 
couÁ
 *= 2;

654 ià(
ht
) {

655 *
´ivd©a
[2];

660 
max™”©iÚs
 = 
couÁ
*10;

665 
´ivd©a
[0] = 
keys
;

666 
´ivd©a
[1] = 
o
;

668 
cursÜ
 = 
	`diùSÿn
(
ht
, cursÜ, 
sÿnC®lback
, 
NULL
, 
´ivd©a
);

669 } 
cursÜ
 &&

670 
max™”©iÚs
-- &&

671 
	`li¡L’gth
(
keys
è< ()
couÁ
);

672 } ià(
o
->
ty³
 =ğ
OBJ_SET
) {

673 
pos
 = 0;

674 
št64_t
 
Î
;

676 
	`št£tG‘
(
o
->
±r
,
pos
++,&
Î
))

677 
	`li¡AddNodeTa
(
keys
,
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î
));

678 
cursÜ
 = 0;

679 } ià(
o
->
ty³
 =ğ
OBJ_HASH
 || o->ty³ =ğ
OBJ_ZSET
) {

680 *
p
 = 
	`zli¡Index
(
o
->
±r
,0);

681 *
v¡r
;

682 
vËn
;

683 
vÎ
;

685 
p
) {

686 
	`zli¡G‘
(
p
,&
v¡r
,&
vËn
,&
vÎ
);

687 
	`li¡AddNodeTa
(
keys
,

688 (
v¡r
 !ğ
NULL
è? 
	`ü—‹SŒšgObjeù
((*)v¡r,
vËn
) :

689 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vÎ
));

690 
p
 = 
	`zli¡Next
(
o
->
±r
,p);

692 
cursÜ
 = 0;

694 
	`£rv”Pªic
("Not handledƒncoding in SCAN.");

698 
node
 = 
	`li¡Fœ¡
(
keys
);

699 
node
) {

700 
robj
 *
kobj
 = 
	`li¡NodeV®ue
(
node
);

701 
ÃxŠode
 = 
	`li¡NextNode
(
node
);

702 
f‹r
 = 0;

705 ià(!
f‹r
 && 
u£_·‰”n
) {

706 ià(
	`sdsEncodedObjeù
(
kobj
)) {

707 ià(!
	`¡ršgm©chËn
(
·t
, 
·’
, 
kobj
->
±r
, 
	`sd¦’
(kobj->ptr), 0))

708 
f‹r
 = 1;

710 
buf
[
LONG_STR_SIZE
];

711 
Ën
;

713 
	`£rv”As£¹
(
kobj
->
’codšg
 =ğ
OBJ_ENCODING_INT
);

714 
Ën
 = 
	`Î2¡ršg
(
buf
,(buf),()
kobj
->
±r
);

715 ià(!
	`¡ršgm©chËn
(
·t
, 
·’
, 
buf
, 
Ën
, 0)è
f‹r
 = 1;

720 ià(!
f‹r
 && 
o
 =ğ
NULL
 && 
	`expœeIfN“ded
(
c
->
db
, 
kobj
)) filter = 1;

723 ià(
f‹r
) {

724 
	`deüRefCouÁ
(
kobj
);

725 
	`li¡D–Node
(
keys
, 
node
);

731 ià(
o
 && (o->
ty³
 =ğ
OBJ_ZSET
 || o->ty³ =ğ
OBJ_HASH
)) {

732 
node
 = 
ÃxŠode
;

733 
ÃxŠode
 = 
	`li¡NextNode
(
node
);

734 ià(
f‹r
) {

735 
kobj
 = 
	`li¡NodeV®ue
(
node
);

736 
	`deüRefCouÁ
(
kobj
);

737 
	`li¡D–Node
(
keys
, 
node
);

740 
node
 = 
ÃxŠode
;

744 
	`addR•lyMuÉiBulkL’
(
c
, 2);

745 
	`addR•lyBulkLÚgLÚg
(
c
,
cursÜ
);

747 
	`addR•lyMuÉiBulkL’
(
c
, 
	`li¡L’gth
(
keys
));

748 (
node
 = 
	`li¡Fœ¡
(
keys
)è!ğ
NULL
) {

749 
robj
 *
kobj
 = 
	`li¡NodeV®ue
(
node
);

750 
	`addR•lyBulk
(
c
, 
kobj
);

751 
	`deüRefCouÁ
(
kobj
);

752 
	`li¡D–Node
(
keys
, 
node
);

755 
ş—nup
:

756 
	`li¡S‘F»eM‘hod
(
keys
,
deüRefCouÁVoid
);

757 
	`li¡R–—£
(
keys
);

758 
	}
}

761 
	$sÿnCommªd
(
ş›Á
 *
c
) {

762 
cursÜ
;

763 ià(
	`·r£SÿnCursÜOrR•ly
(
c
,c->
¬gv
[1],&
cursÜ
è=ğ
C_ERR
) ;

764 
	`sÿnG’”icCommªd
(
c
,
NULL
,
cursÜ
);

765 
	}
}

767 
	$dbsizeCommªd
(
ş›Á
 *
c
) {

768 
	`addR•lyLÚgLÚg
(
c
,
	`diùSize
(c->
db
->
diù
));

769 
	}
}

771 
	$Ï¡§veCommªd
(
ş›Á
 *
c
) {

772 
	`addR•lyLÚgLÚg
(
c
,
£rv”
.
Ï¡§ve
);

773 
	}
}

775 
	$ty³Commªd
(
ş›Á
 *
c
) {

776 
robj
 *
o
;

777 *
ty³
;

779 
o
 = 
	`lookupKeyR—dW™hFÏgs
(
c
->
db
,c->
¬gv
[1],
LOOKUP_NOTOUCH
);

780 ià(
o
 =ğ
NULL
) {

781 
ty³
 = "none";

783 
o
->
ty³
) {

784 
OBJ_STRING
: 
ty³
 = "string"; ;

785 
OBJ_LIST
: 
ty³
 = "list"; ;

786 
OBJ_SET
: 
ty³
 = "set"; ;

787 
OBJ_ZSET
: 
ty³
 = "zset"; ;

788 
OBJ_HASH
: 
ty³
 = "hash"; ;

789 
OBJ_MODULE
: {

790 
moduËV®ue
 *
mv
 = 
o
->
±r
;

791 
ty³
 = 
mv
->ty³->
Çme
;

793 : 
ty³
 = "unknown"; ;

796 
	`addR•lyStus
(
c
,
ty³
);

797 
	}
}

799 
	$shutdownCommªd
(
ş›Á
 *
c
) {

800 
æags
 = 0;

802 ià(
c
->
¬gc
 > 2) {

803 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

805 } ià(
c
->
¬gc
 == 2) {

806 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"nosave")) {

807 
æags
 |ğ
SHUTDOWN_NOSAVE
;

808 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"save")) {

809 
æags
 |ğ
SHUTDOWN_SAVE
;

811 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

821 ià(
£rv”
.
lßdšg
 || s”v”.
£Áš–_mode
)

822 
æags
 = (æag & ~
SHUTDOWN_SAVE
è| 
SHUTDOWN_NOSAVE
;

823 ià(
	`´•¬eFÜShutdown
(
æags
è=ğ
C_OK
è
	`ex™
(0);

824 
	`addR•lyE¼Ü
(
c
,"Errorsryingo SHUTDOWN. Check†ogs.");

825 
	}
}

827 
	$»ÇmeG’”icCommªd
(
ş›Á
 *
c
, 
nx
) {

828 
robj
 *
o
;

829 
expœe
;

830 
§mekey
 = 0;

834 ià(
	`sdscmp
(
c
->
¬gv
[1]->
±r
,c->¬gv[2]->±rè=ğ0è
§mekey
 = 1;

836 ià((
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nokey”r
)è=ğ
NULL
)

839 ià(
§mekey
) {

840 
	`addR•ly
(
c
,
nx
 ? 
sh¬ed
.
cz”o
 : sh¬ed.
ok
);

844 
	`šüRefCouÁ
(
o
);

845 
expœe
 = 
	`g‘Expœe
(
c
->
db
,c->
¬gv
[1]);

846 ià(
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[2]è!ğ
NULL
) {

847 ià(
nx
) {

848 
	`deüRefCouÁ
(
o
);

849 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

854 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[2]);

856 
	`dbAdd
(
c
->
db
,c->
¬gv
[2],
o
);

857 ià(
expœe
 !ğ-1è
	`£tExpœe
(
c
,c->
db
,c->
¬gv
[2],expire);

858 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

859 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

860 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[2]);

861 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"rename_from",

862 
c
->
¬gv
[1],c->
db
->
id
);

863 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"rename_to",

864 
c
->
¬gv
[2],c->
db
->
id
);

865 
£rv”
.
dœty
++;

866 
	`addR•ly
(
c
,
nx
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
ok
);

867 
	}
}

869 
	$»ÇmeCommªd
(
ş›Á
 *
c
) {

870 
	`»ÇmeG’”icCommªd
(
c
,0);

871 
	}
}

873 
	$»Çm’xCommªd
(
ş›Á
 *
c
) {

874 
	`»ÇmeG’”icCommªd
(
c
,1);

875 
	}
}

877 
	$moveCommªd
(
ş›Á
 *
c
) {

878 
robj
 *
o
;

879 
»disDb
 *
¤c
, *
d¡
;

880 
¤cid
;

881 
dbid
, 
expœe
;

883 ià(
£rv”
.
şu¡”_’abËd
) {

884 
	`addR•lyE¼Ü
(
c
,"MOVE is‚ot‡llowed in cluster mode");

889 
¤c
 = 
c
->
db
;

890 
¤cid
 = 
c
->
db
->
id
;

892 ià(
	`g‘LÚgLÚgFromObjeù
(
c
->
¬gv
[2],&
dbid
è=ğ
C_ERR
 ||

893 
dbid
 < 
INT_MIN
 || dbid > 
INT_MAX
 ||

894 
	`£ËùDb
(
c
,
dbid
è=ğ
C_ERR
)

896 
	`addR•ly
(
c
,
sh¬ed
.
outoäªg“¼
);

899 
d¡
 = 
c
->
db
;

900 
	`£ËùDb
(
c
,
¤cid
);

904 ià(
¤c
 =ğ
d¡
) {

905 
	`addR•ly
(
c
,
sh¬ed
.
§meobjeù”r
);

910 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

911 ià(!
o
) {

912 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

915 
expœe
 = 
	`g‘Expœe
(
c
->
db
,c->
¬gv
[1]);

918 ià(
	`lookupKeyWr™e
(
d¡
,
c
->
¬gv
[1]è!ğ
NULL
) {

919 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

922 
	`dbAdd
(
d¡
,
c
->
¬gv
[1],
o
);

923 ià(
expœe
 !ğ-1è
	`£tExpœe
(
c
,
d¡
,c->
¬gv
[1],expire);

924 
	`šüRefCouÁ
(
o
);

927 
	`dbD–‘e
(
¤c
,
c
->
¬gv
[1]);

928 
£rv”
.
dœty
++;

929 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

930 
	}
}

936 
	$sÿnD©aba£FÜR—dyLi¡s
(
»disDb
 *
db
) {

937 
diùEÁry
 *
de
;

938 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘SaãI‹¿tÜ
(
db
->
blockšg_keys
);

939 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

940 
robj
 *
key
 = 
	`diùG‘Key
(
de
);

941 
robj
 *
v®ue
 = 
	`lookupKey
(
db
,
key
,
LOOKUP_NOTOUCH
);

942 ià(
v®ue
 && v®ue->
ty³
 =ğ
OBJ_LIST
)

943 
	`sigÇlLi¡AsR—dy
(
db
, 
key
);

945 
	`diùR–—£I‹¿tÜ
(
di
);

946 
	}
}

956 
	$dbSw­D©aba£s
(
id1
, 
id2
) {

957 ià(
id1
 < 0 || id1 >ğ
£rv”
.
dbnum
 ||

958 
id2
 < 0 || id2 >ğ
£rv”
.
dbnum
è 
C_ERR
;

959 ià(
id1
 =ğ
id2
è 
C_OK
;

960 
»disDb
 
aux
 = 
£rv”
.
db
[
id1
];

961 
»disDb
 *
db1
 = &
£rv”
.
db
[
id1
], *
db2
 = &£rv”.db[
id2
];

966 
db1
->
diù
 = 
db2
->dict;

967 
db1
->
expœes
 = 
db2
->expires;

968 
db1
->
avg_‰l
 = 
db2
->avg_ttl;

970 
db2
->
diù
 = 
aux
.dict;

971 
db2
->
expœes
 = 
aux
.expires;

972 
db2
->
avg_‰l
 = 
aux
.avg_ttl;

983 
	`sÿnD©aba£FÜR—dyLi¡s
(
db1
);

984 
	`sÿnD©aba£FÜR—dyLi¡s
(
db2
);

985  
C_OK
;

986 
	}
}

989 
	$sw­dbCommªd
(
ş›Á
 *
c
) {

990 
id1
, 
id2
;

993 ià(
£rv”
.
şu¡”_’abËd
) {

994 
	`addR•lyE¼Ü
(
c
,"SWAPDB is‚ot‡llowed in cluster mode");

999 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[1], &
id1
,

1000 "šv®id fœ¡ DB index"è!ğ
C_OK
)

1003 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
id2
,

1004 "šv®id secÚd DB index"è!ğ
C_OK
)

1008 ià(
	`dbSw­D©aba£s
(
id1
,
id2
è=ğ
C_ERR
) {

1009 
	`addR•lyE¼Ü
(
c
,"DB index is out of„ange");

1012 
£rv”
.
dœty
++;

1013 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1015 
	}
}

1021 
	$»moveExpœe
(
»disDb
 *
db
, 
robj
 *
key
) {

1024 
	`£rv”As£¹W™hInfo
(
NULL
,
key
,
	`diùFšd
(
db
->
diù
,key->
±r
) != NULL);

1025  
	`diùD–‘e
(
db
->
expœes
,
key
->
±r
è=ğ
DICT_OK
;

1026 
	}
}

1032 
	$£tExpœe
(
ş›Á
 *
c
, 
»disDb
 *
db
, 
robj
 *
key
, 
wh’
) {

1033 
diùEÁry
 *
kde
, *
de
;

1036 
kde
 = 
	`diùFšd
(
db
->
diù
,
key
->
±r
);

1037 
	`£rv”As£¹W™hInfo
(
NULL
,
key
,
kde
 != NULL);

1038 
de
 = 
	`diùAddOrFšd
(
db
->
expœes
,
	`diùG‘Key
(
kde
));

1039 
	`diùS‘SigÃdIÁeg”V®
(
de
,
wh’
);

1041 
wr™abË_¦ave
 = 
£rv”
.
ma¡”ho¡
 && s”v”.
»¶_¦ave_ro
 == 0;

1042 ià(
c
 && 
wr™abË_¦ave
 && !(c->
æags
 & 
CLIENT_MASTER
))

1043 
	`»memb”SÏveKeyW™hExpœe
(
db
,
key
);

1044 
	}
}

1048 
	$g‘Expœe
(
»disDb
 *
db
, 
robj
 *
key
) {

1049 
diùEÁry
 *
de
;

1052 ià(
	`diùSize
(
db
->
expœes
) == 0 ||

1053 (
de
 = 
	`diùFšd
(
db
->
expœes
,
key
->
±r
)è=ğ
NULL
)  -1;

1057 
	`£rv”As£¹W™hInfo
(
NULL
,
key
,
	`diùFšd
(
db
->
diù
,key->
±r
) != NULL);

1058  
	`diùG‘SigÃdIÁeg”V®
(
de
);

1059 
	}
}

1069 
	$´İag©eExpœe
(
»disDb
 *
db
, 
robj
 *
key
, 
Ïzy
) {

1070 
robj
 *
¬gv
[2];

1072 
¬gv
[0] = 
Ïzy
 ? 
sh¬ed
.
uÆšk
 : sh¬ed.
d–
;

1073 
¬gv
[1] = 
key
;

1074 
	`šüRefCouÁ
(
¬gv
[0]);

1075 
	`šüRefCouÁ
(
¬gv
[1]);

1077 ià(
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
)

1078 
	`ãedAµ’dOÆyFe
(
£rv”
.
d–Commªd
,
db
->
id
,
¬gv
,2);

1079 
	`»¶iÿtiÚF“dSÏves
(
£rv”
.
¦aves
,
db
->
id
,
¬gv
,2);

1081 
	`deüRefCouÁ
(
¬gv
[0]);

1082 
	`deüRefCouÁ
(
¬gv
[1]);

1083 
	}
}

1085 
	$expœeIfN“ded
(
»disDb
 *
db
, 
robj
 *
key
) {

1086 
m¡ime_t
 
wh’
 = 
	`g‘Expœe
(
db
,
key
);

1087 
m¡ime_t
 
now
;

1089 ià(
wh’
 < 0)  0;

1092 ià(
£rv”
.
lßdšg
)  0;

1099 
now
 = 
£rv”
.
lua_ÿÎ”
 ? s”v”.
lua_time_¡¬t
 : 
	`m¡ime
();

1108 ià(
£rv”
.
ma¡”ho¡
 !ğ
NULL
è 
now
 > 
wh’
;

1111 ià(
now
 <ğ
wh’
)  0;

1114 
£rv”
.
¡©_expœedkeys
++;

1115 
	`´İag©eExpœe
(
db
,
key
,
£rv”
.
Ïzyä“_Ïzy_expœe
);

1116 
	`nÙifyKey¥aûEv’t
(
NOTIFY_EXPIRED
,

1117 "expœed",
key
,
db
->
id
);

1118  
£rv”
.
Ïzyä“_Ïzy_expœe
 ? 
	`dbAsyncD–‘e
(
db
,
key
) :

1119 
	`dbSyncD–‘e
(
db
,
key
);

1120 
	}
}

1128 *
	$g‘KeysUsšgCommªdTabË
(
»disCommªd
 *
cmd
,
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1129 
j
, 
i
 = 0, 
Ï¡
, *
keys
;

1130 
	`UNUSED
(
¬gv
);

1132 ià(
cmd
->
fœ¡key
 == 0) {

1133 *
numkeys
 = 0;

1134  
NULL
;

1137 
Ï¡
 = 
cmd
->
Ï¡key
;

1138 ià(
Ï¡
 < 0èÏ¡ = 
¬gc
+last;

1139 
keys
 = 
	`zm®loc
(()*((
Ï¡
 - 
cmd
->
fœ¡key
)+1));

1140 
j
 = 
cmd
->
fœ¡key
; j <ğ
Ï¡
; j +ğcmd->
key¡•
) {

1141 ià(
j
 >ğ
¬gc
) {

1146 ià(
cmd
->
æags
 & 
CMD_MODULE
) {

1147 
	`zä“
(
keys
);

1148 *
numkeys
 = 0;

1149  
NULL
;

1151 
	`£rv”Pªic
("Redis built-in command declared keys…ositions‚ot matchinghe‡rity„equirements.");

1154 
keys
[
i
++] = 
j
;

1156 *
numkeys
 = 
i
;

1157  
keys
;

1158 
	}
}

1171 *
	$g‘KeysFromCommªd
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1172 ià(
cmd
->
æags
 & 
CMD_MODULE_GETKEYS
) {

1173  
	`moduËG‘CommªdKeysVŸAPI
(
cmd
,
¬gv
,
¬gc
,
numkeys
);

1174 } ià(!(
cmd
->
æags
 & 
CMD_MODULE
è&& cmd->
g‘keys_´oc
) {

1175  
cmd
->
	`g‘keys_´oc
(cmd,
¬gv
,
¬gc
,
numkeys
);

1177  
	`g‘KeysUsšgCommªdTabË
(
cmd
,
¬gv
,
¬gc
,
numkeys
);

1179 
	}
}

1182 
	$g‘KeysF»eResuÉ
(*
»suÉ
) {

1183 
	`zä“
(
»suÉ
);

1184 
	}
}

1189 *
	$zuniÚIÁ”G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1190 
i
, 
num
, *
keys
;

1191 
	`UNUSED
(
cmd
);

1193 
num
 = 
	`©oi
(
¬gv
[2]->
±r
);

1196 ià(
num
 > (
¬gc
-3)) {

1197 *
numkeys
 = 0;

1198  
NULL
;

1204 
keys
 = 
	`zm®loc
(()*(
num
+1));

1207 
i
 = 0; i < 
num
; i++è
keys
[i] = 3+i;

1210 
keys
[
num
] = 1;

1211 *
numkeys
 = 
num
+1;

1212  
keys
;

1213 
	}
}

1218 *
	$ev®G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1219 
i
, 
num
, *
keys
;

1220 
	`UNUSED
(
cmd
);

1222 
num
 = 
	`©oi
(
¬gv
[2]->
±r
);

1225 ià(
num
 > (
¬gc
-3)) {

1226 *
numkeys
 = 0;

1227  
NULL
;

1230 
keys
 = 
	`zm®loc
(()*
num
);

1231 *
numkeys
 = 
num
;

1234 
i
 = 0; i < 
num
; i++è
keys
[i] = 3+i;

1236  
keys
;

1237 
	}
}

1246 *
	$sÜtG‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1247 
i
, 
j
, 
num
, *
keys
, 
found_¡Üe
 = 0;

1248 
	`UNUSED
(
cmd
);

1250 
num
 = 0;

1251 
keys
 = 
	`zm®loc
(()*2);

1253 
keys
[
num
++] = 1;

1260 *
Çme
;

1261 
sk
;

1262 } 
skli¡
[] = {

1266 {
NULL
, 0}

1269 
i
 = 2; i < 
¬gc
; i++) {

1270 
j
 = 0; 
skli¡
[j].
Çme
 !ğ
NULL
; j++) {

1271 ià(!
	`¡rÿ£cmp
(
¬gv
[
i
]->
±r
,
skli¡
[
j
].
Çme
)) {

1272 
i
 +ğ
skli¡
[
j
].
sk
;

1274 } ià(!
	`¡rÿ£cmp
(
¬gv
[
i
]->
±r
,"¡Üe"è&& i+1 < 
¬gc
) {

1278 
found_¡Üe
 = 1;

1279 
keys
[
num
] = 
i
+1;

1284 *
numkeys
 = 
num
 + 
found_¡Üe
;

1285  
keys
;

1286 
	}
}

1288 *
	$mig¿‹G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1289 
i
, 
num
, 
fœ¡
, *
keys
;

1290 
	`UNUSED
(
cmd
);

1293 
fœ¡
 = 3;

1294 
num
 = 1;

1297 ià(
¬gc
 > 6) {

1298 
i
 = 6; i < 
¬gc
; i++) {

1299 ià(!
	`¡rÿ£cmp
(
¬gv
[
i
]->
±r
,"keys") &&

1300 
	`sd¦’
(
¬gv
[3]->
±r
) == 0)

1302 
fœ¡
 = 
i
+1;

1303 
num
 = 
¬gc
-
fœ¡
;

1309 
keys
 = 
	`zm®loc
(()*
num
);

1310 
i
 = 0; i < 
num
; i++è
keys
[i] = 
fœ¡
+i;

1311 *
numkeys
 = 
num
;

1312  
keys
;

1313 
	}
}

1319 *
	$geÜadiusG‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1320 
i
, 
num
, *
keys
;

1321 
	`UNUSED
(
cmd
);

1324 
¡Üed_key
 = -1;

1325 
i
 = 5; i < 
¬gc
; i++) {

1326 *
¬g
 = 
¬gv
[
i
]->
±r
;

1331 ià((!
	`¡rÿ£cmp
(
¬g
, "¡Üe"è|| !¡rÿ£cmp×rg, "¡Üedi¡")è&& ((
i
+1è< 
¬gc
)) {

1332 
¡Üed_key
 = 
i
+1;

1333 
i
++;

1336 
num
 = 1 + (
¡Üed_key
 == -1 ? 0 : 1);

1342 
keys
 = 
	`zm®loc
((è* 
num
);

1345 
keys
[0] = 1;

1346 if(
num
 > 1) {

1347 
keys
[1] = 
¡Üed_key
;

1349 *
numkeys
 = 
num
;

1350  
keys
;

1351 
	}
}

1357 
	$¦ÙToKeyUpd©eKey
(
robj
 *
key
, 
add
) {

1358 
hash¦Ù
 = 
	`keyHashSlÙ
(
key
->
±r
,
	`sd¦’
(key->ptr));

1359 
buf
[64];

1360 *
šdexed
 = 
buf
;

1361 
size_t
 
keyËn
 = 
	`sd¦’
(
key
->
±r
);

1363 
£rv”
.
şu¡”
->
¦Ùs_keys_couÁ
[
hash¦Ù
] +ğ
add
 ? 1 : -1;

1364 ià(
keyËn
+2 > 64è
šdexed
 = 
	`zm®loc
(keylen+2);

1365 
šdexed
[0] = (
hash¦Ù
 >> 8) & 0xff;

1366 
šdexed
[1] = 
hash¦Ù
 & 0xff;

1367 
	`memıy
(
šdexed
+2,
key
->
±r
,
keyËn
);

1368 ià(
add
) {

1369 
	`¿xIn£¹
(
£rv”
.
şu¡”
->
¦Ùs_to_keys
,
šdexed
,
keyËn
+2,
NULL
,NULL);

1371 
	`¿xRemove
(
£rv”
.
şu¡”
->
¦Ùs_to_keys
,
šdexed
,
keyËn
+2,
NULL
);

1373 ià(
šdexed
 !ğ
buf
è
	`zä“
(indexed);

1374 
	}
}

1376 
	$¦ÙToKeyAdd
(
robj
 *
key
) {

1377 
	`¦ÙToKeyUpd©eKey
(
key
,1);

1378 
	}
}

1380 
	$¦ÙToKeyD–
(
robj
 *
key
) {

1381 
	`¦ÙToKeyUpd©eKey
(
key
,0);

1382 
	}
}

1384 
	$¦ÙToKeyFlush
() {

1385 
	`¿xF»e
(
£rv”
.
şu¡”
->
¦Ùs_to_keys
);

1386 
£rv”
.
şu¡”
->
¦Ùs_to_keys
 = 
	`¿xNew
();

1387 
	`mem£t
(
£rv”
.
şu¡”
->
¦Ùs_keys_couÁ
,0,

1388 (
£rv”
.
şu¡”
->
¦Ùs_keys_couÁ
));

1389 
	}
}

1394 
	$g‘KeysInSlÙ
(
hash¦Ù
, 
robj
 **
keys
, 
couÁ
) {

1395 
¿xI‹¿tÜ
 
™”
;

1396 
j
 = 0;

1397 
šdexed
[2];

1399 
šdexed
[0] = (
hash¦Ù
 >> 8) & 0xff;

1400 
šdexed
[1] = 
hash¦Ù
 & 0xff;

1401 
	`¿xS¹
(&
™”
,
£rv”
.
şu¡”
->
¦Ùs_to_keys
);

1402 
	`¿xS“k
(&
™”
,">=",
šdexed
,2);

1403 
couÁ
-- && 
	`¿xNext
(&
™”
)) {

1404 ià(
™”
.
key
[0] !ğ
šdexed
[0] || iter.key[1] != indexed[1]) ;

1405 
keys
[
j
++] = 
	`ü—‹SŒšgObjeù
((*)
™”
.
key
+2,™”.
key_Ën
-2);

1407 
	`¿xStİ
(&
™”
);

1408  
j
;

1409 
	}
}

1413 
	$d–KeysInSlÙ
(
hash¦Ù
) {

1414 
¿xI‹¿tÜ
 
™”
;

1415 
j
 = 0;

1416 
šdexed
[2];

1418 
šdexed
[0] = (
hash¦Ù
 >> 8) & 0xff;

1419 
šdexed
[1] = 
hash¦Ù
 & 0xff;

1420 
	`¿xS¹
(&
™”
,
£rv”
.
şu¡”
->
¦Ùs_to_keys
);

1421 
£rv”
.
şu¡”
->
¦Ùs_keys_couÁ
[
hash¦Ù
]) {

1422 
	`¿xS“k
(&
™”
,">=",
šdexed
,2);

1423 
	`¿xNext
(&
™”
);

1425 
robj
 *
key
 = 
	`ü—‹SŒšgObjeù
((*)
™”
.key+2,™”.
key_Ën
-2);

1426 
	`dbD–‘e
(&
£rv”
.
db
[0],
key
);

1427 
	`deüRefCouÁ
(
key
);

1428 
j
++;

1430 
	`¿xStİ
(&
™”
);

1431  
j
;

1432 
	}
}

1434 
	$couÁKeysInSlÙ
(
hash¦Ù
) {

1435  
£rv”
.
şu¡”
->
¦Ùs_keys_couÁ
[
hash¦Ù
];

1436 
	}
}

	@debug.c

30 
	~"£rv”.h
"

31 
	~"sha1.h
"

32 
	~"üc64.h
"

34 
	~<¬·/š‘.h
>

35 
	~<sigÇl.h
>

36 
	~<dlfú.h
>

38 #ifdeà
HAVE_BACKTRACE


39 
	~<execšfo.h
>

40 
	~<ucÚ‹xt.h
>

41 
	~<fú.h
>

42 
	~"bio.h
"

43 
	~<uni¡d.h
>

46 #ifdeà
__CYGWIN__


47 #iâdeà
SA_ONSTACK


48 
	#SA_ONSTACK
 0x08000000

	)

60 
	$xÜDige¡
(*
dige¡
, *
±r
, 
size_t
 
Ën
) {

61 
SHA1_CTX
 
ùx
;

62 
hash
[20], *
s
 = 
±r
;

63 
j
;

65 
	`SHA1In™
(&
ùx
);

66 
	`SHA1Upd©e
(&
ùx
,
s
,
Ën
);

67 
	`SHA1Fš®
(
hash
,&
ùx
);

69 
j
 = 0; j < 20; j++)

70 
dige¡
[
j
] ^ğ
hash
[j];

71 
	}
}

73 
	$xÜObjeùDige¡
(*
dige¡
, 
robj
 *
o
) {

74 
o
 = 
	`g‘DecodedObjeù
(o);

75 
	`xÜDige¡
(
dige¡
,
o
->
±r
,
	`sd¦’
(o->ptr));

76 
	`deüRefCouÁ
(
o
);

77 
	}
}

93 
	$mixDige¡
(*
dige¡
, *
±r
, 
size_t
 
Ën
) {

94 
SHA1_CTX
 
ùx
;

95 *
s
 = 
±r
;

97 
	`xÜDige¡
(
dige¡
,
s
,
Ën
);

98 
	`SHA1In™
(&
ùx
);

99 
	`SHA1Upd©e
(&
ùx
,
dige¡
,20);

100 
	`SHA1Fš®
(
dige¡
,&
ùx
);

101 
	}
}

103 
	$mixObjeùDige¡
(*
dige¡
, 
robj
 *
o
) {

104 
o
 = 
	`g‘DecodedObjeù
(o);

105 
	`mixDige¡
(
dige¡
,
o
->
±r
,
	`sd¦’
(o->ptr));

106 
	`deüRefCouÁ
(
o
);

107 
	}
}

115 
	$compu‹D©a£tDige¡
(*
fš®
) {

116 
dige¡
[20];

117 
buf
[128];

118 
diùI‹¿tÜ
 *
di
 = 
NULL
;

119 
diùEÁry
 *
de
;

120 
j
;

121 
ušt32_t
 
aux
;

123 
	`mem£t
(
fš®
,0,20);

125 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

126 
»disDb
 *
db
 = 
£rv”
.db+
j
;

128 ià(
	`diùSize
(
db
->
diù
) == 0) ;

129 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
db
->
diù
);

133 
aux
 = 
	`htÚl
(
j
);

134 
	`mixDige¡
(
fš®
,&
aux
,(aux));

137 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

138 
sds
 
key
;

139 
robj
 *
keyobj
, *
o
;

140 
expœ‘ime
;

142 
	`mem£t
(
dige¡
,0,20);

143 
key
 = 
	`diùG‘Key
(
de
);

144 
keyobj
 = 
	`ü—‹SŒšgObjeù
(
key
,
	`sd¦’
(key));

146 
	`mixDige¡
(
dige¡
,
key
,
	`sd¦’
(key));

148 
o
 = 
	`diùG‘V®
(
de
);

150 
aux
 = 
	`htÚl
(
o
->
ty³
);

151 
	`mixDige¡
(
dige¡
,&
aux
,(aux));

152 
expœ‘ime
 = 
	`g‘Expœe
(
db
,
keyobj
);

155 ià(
o
->
ty³
 =ğ
OBJ_STRING
) {

156 
	`mixObjeùDige¡
(
dige¡
,
o
);

157 } ià(
o
->
ty³
 =ğ
OBJ_LIST
) {

158 
li¡Ty³I‹¿tÜ
 *
li
 = 
	`li¡Ty³In™I‹¿tÜ
(
o
,0,
LIST_TAIL
);

159 
li¡Ty³EÁry
 
’Œy
;

160 
	`li¡Ty³Next
(
li
,&
’Œy
)) {

161 
robj
 *
–eobj
 = 
	`li¡Ty³G‘
(&
’Œy
);

162 
	`mixObjeùDige¡
(
dige¡
,
–eobj
);

163 
	`deüRefCouÁ
(
–eobj
);

165 
	`li¡Ty³R–—£I‹¿tÜ
(
li
);

166 } ià(
o
->
ty³
 =ğ
OBJ_SET
) {

167 
£tTy³I‹¿tÜ
 *
si
 = 
	`£tTy³In™I‹¿tÜ
(
o
);

168 
sds
 
sd£Ë
;

169 (
sd£Ë
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

170 
	`xÜDige¡
(
dige¡
,
sd£Ë
,
	`sd¦’
(sdsele));

171 
	`sdsä“
(
sd£Ë
);

173 
	`£tTy³R–—£I‹¿tÜ
(
si
);

174 } ià(
o
->
ty³
 =ğ
OBJ_ZSET
) {

175 
–edige¡
[20];

177 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

178 *
zl
 = 
o
->
±r
;

179 *
•Œ
, *
¥Œ
;

180 *
v¡r
;

181 
vËn
;

182 
vÎ
;

183 
scÜe
;

185 
•Œ
 = 
	`zli¡Index
(
zl
,0);

186 
	`£rv”As£¹
(
•Œ
 !ğ
NULL
);

187 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

188 
	`£rv”As£¹
(
¥Œ
 !ğ
NULL
);

190 
•Œ
 !ğ
NULL
) {

191 
	`£rv”As£¹
(
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vÎ
));

192 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

194 
	`mem£t
(
–edige¡
,0,20);

195 ià(
v¡r
 !ğ
NULL
) {

196 
	`mixDige¡
(
–edige¡
,
v¡r
,
vËn
);

198 
	`Î2¡ršg
(
buf
,(buf),
vÎ
);

199 
	`mixDige¡
(
–edige¡
,
buf
,
	`¡¾’
(buf));

202 
	`¢´štf
(
buf
,(buf),"%.17g",
scÜe
);

203 
	`mixDige¡
(
–edige¡
,
buf
,
	`¡¾’
(buf));

204 
	`xÜDige¡
(
dige¡
,
–edige¡
,20);

205 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

207 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

208 
z£t
 *
zs
 = 
o
->
±r
;

209 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
zs
->
diù
);

210 
diùEÁry
 *
de
;

212 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

213 
sds
 
sd£Ë
 = 
	`diùG‘Key
(
de
);

214 *
scÜe
 = 
	`diùG‘V®
(
de
);

216 
	`¢´štf
(
buf
,(buf),"%.17g",*
scÜe
);

217 
	`mem£t
(
–edige¡
,0,20);

218 
	`mixDige¡
(
–edige¡
,
sd£Ë
,
	`sd¦’
(sdsele));

219 
	`mixDige¡
(
–edige¡
,
buf
,
	`¡¾’
(buf));

220 
	`xÜDige¡
(
dige¡
,
–edige¡
,20);

222 
	`diùR–—£I‹¿tÜ
(
di
);

224 
	`£rv”Pªic
("Unknown sorted setƒncoding");

226 } ià(
o
->
ty³
 =ğ
OBJ_HASH
) {

227 
hashTy³I‹¿tÜ
 *
hi
 = 
	`hashTy³In™I‹¿tÜ
(
o
);

228 
	`hashTy³Next
(
hi
è!ğ
C_ERR
) {

229 
–edige¡
[20];

230 
sds
 
sd£Ë
;

232 
	`mem£t
(
–edige¡
,0,20);

233 
sd£Ë
 = 
	`hashTy³Cu¼’tObjeùNewSds
(
hi
,
OBJ_HASH_KEY
);

234 
	`mixDige¡
(
–edige¡
,
sd£Ë
,
	`sd¦’
(sdsele));

235 
	`sdsä“
(
sd£Ë
);

236 
sd£Ë
 = 
	`hashTy³Cu¼’tObjeùNewSds
(
hi
,
OBJ_HASH_VALUE
);

237 
	`mixDige¡
(
–edige¡
,
sd£Ë
,
	`sd¦’
(sdsele));

238 
	`sdsä“
(
sd£Ë
);

239 
	`xÜDige¡
(
dige¡
,
–edige¡
,20);

241 
	`hashTy³R–—£I‹¿tÜ
(
hi
);

242 } ià(
o
->
ty³
 =ğ
OBJ_MODULE
) {

243 
RedisModuËDige¡
 
md
;

244 
moduËV®ue
 *
mv
 = 
o
->
±r
;

245 
moduËTy³
 *
mt
 = 
mv
->
ty³
;

246 
	`moduËIn™Dige¡CÚ‹xt
(
md
);

247 ià(
mt
->
dige¡
) {

248 
mt
->
	`dige¡
(&
md
,
mv
->
v®ue
);

249 
	`xÜDige¡
(
dige¡
,
md
.
x
,(md.x));

252 
	`£rv”Pªic
("Unknown objectype");

255 ià(
expœ‘ime
 !ğ-1è
	`xÜDige¡
(
dige¡
,"!!expire!!",10);

257 
	`xÜDige¡
(
fš®
,
dige¡
,20);

258 
	`deüRefCouÁ
(
keyobj
);

260 
	`diùR–—£I‹¿tÜ
(
di
);

262 
	}
}

264 
	$debugCommªd
(
ş›Á
 *
c
) {

265 ià(
c
->
¬gc
 == 1) {

266 
	`addR•lyE¼Ü
(
c
,"You must specify‡ subcommand for DEBUG. Try DEBUG HELP for info.");

270 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"help")) {

271 *
bËÅ
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

272 
bËn
 = 0;

273 
bËn
++; 
	`addR•lyStus
(
c
,

275 
bËn
++; 
	`addR•lyStus
(
c
,

277 
bËn
++; 
	`addR•lyStus
(
c
,

279 
bËn
++; 
	`addR•lyStus
(
c
,

281 
bËn
++; 
	`addR•lyStus
(
c
,

283 
bËn
++; 
	`addR•lyStus
(
c
,

285 
bËn
++; 
	`addR•lyStus
(
c
,

287 
bËn
++; 
	`addR•lyStus
(
c
,

289 
bËn
++; 
	`addR•lyStus
(
c
,

291 
bËn
++; 
	`addR•lyStus
(
c
,

293 
bËn
++; 
	`addR•lyStus
(
c
,

295 
bËn
++; 
	`addR•lyStus
(
c
,

297 
bËn
++; 
	`addR•lyStus
(
c
,

299 
bËn
++; 
	`addR•lyStus
(
c
,

301 
bËn
++; 
	`addR•lyStus
(
c
,

303 
bËn
++; 
	`addR•lyStus
(
c
,

305 
bËn
++; 
	`addR•lyStus
(
c
,

307 
bËn
++; 
	`addR•lyStus
(
c
,

309 
bËn
++; 
	`addR•lyStus
(
c
,

311 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
bËÅ
,
bËn
);

312 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"segfault")) {

314 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"panic")) {

315 
	`£rv”Pªic
("DEBUG PANIC c®Ëd‡ˆUnixim%ld", 
	`time
(
NULL
));

316 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"restart") ||

317 !
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"crash-and-recover"))

319 
d–ay
 = 0;

320 ià(
c
->
¬gc
 >= 3) {

321 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
d–ay
, 
NULL
)

322 !ğ
C_OK
) ;

323 ià(
d–ay
 < 0) delay = 0;

325 
æags
 = !
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"restart") ?

326 (
RESTART_SERVER_GRACEFULLY
|
RESTART_SERVER_CONFIG_REWRITE
) :

327 
RESTART_SERVER_NONE
;

328 
	`»¡¬tS”v”
(
æags
,
d–ay
);

329 
	`addR•lyE¼Ü
(
c
,"failedo„estarthe server. Check server†ogs.");

330 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"oom")) {

331 *
±r
 = 
	`zm®loc
(
ULONG_MAX
);

332 
	`zä“
(
±r
);

333 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

334 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"assert")) {

335 ià(
c
->
¬gc
 >ğ3èc->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

336 
	`£rv”As£¹W™hInfo
(
c
,c->
¬gv
[0],1 == 2);

337 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"reload")) {

338 ià(
	`rdbSave
(
£rv”
.
rdb_f’ame
,
NULL
è!ğ
C_OK
) {

339 
	`addR•ly
(
c
,
sh¬ed
.
”r
);

342 
	`em±yDb
(-1,
EMPTYDB_NO_FLAGS
,
NULL
);

343 ià(
	`rdbLßd
(
£rv”
.
rdb_f’ame
,
NULL
è!ğ
C_OK
) {

344 
	`addR•lyE¼Ü
(
c
,"Errorryingo†oadhe RDB dump");

347 
	`£rv”Log
(
LL_WARNING
,"DB„eloaded by DEBUG RELOAD");

348 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

349 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"loadaof")) {

350 ià(
£rv”
.
aof_¡©e
 =ğ
AOF_ON
è
	`æushAµ’dOÆyFe
(1);

351 
	`em±yDb
(-1,
EMPTYDB_NO_FLAGS
,
NULL
);

352 ià(
	`lßdAµ’dOÆyFe
(
£rv”
.
aof_f’ame
è!ğ
C_OK
) {

353 
	`addR•ly
(
c
,
sh¬ed
.
”r
);

356 
£rv”
.
dœty
 = 0;

357 
	`£rv”Log
(
LL_WARNING
,"Append Only File†oaded by DEBUG LOADAOF");

358 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

359 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"objeù"è&& c->
¬gc
 == 3) {

360 
diùEÁry
 *
de
;

361 
robj
 *
v®
;

362 *
¡»nc
;

364 ià((
de
 = 
	`diùFšd
(
c
->
db
->
diù
,c->
¬gv
[2]->
±r
)è=ğ
NULL
) {

365 
	`addR•ly
(
c
,
sh¬ed
.
nokey”r
);

368 
v®
 = 
	`diùG‘V®
(
de
);

369 
¡»nc
 = 
	`¡rEncodšg
(
v®
->
’codšg
);

371 
exŒa
[128] = {0};

372 ià(
v®
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

373 *
ÃxŒa
 = 
exŒa
;

374 
»maššg
 = (
exŒa
);

375 
quickli¡
 *
ql
 = 
v®
->
±r
;

377 
u£d
 = 
	`¢´štf
(
ÃxŒa
, 
»maššg
, " ql_nodes:%u", 
ql
->
Ën
);

378 
ÃxŒa
 +ğ
u£d
;

379 
»maššg
 -ğ
u£d
;

381 
avg
 = ()
ql
->
couÁ
/ql->
Ën
;

382 
u£d
 = 
	`¢´štf
(
ÃxŒa
, 
»maššg
, " ql_avg_node:%.2f", 
avg
);

383 
ÃxŒa
 +ğ
u£d
;

384 
»maššg
 -ğ
u£d
;

386 
u£d
 = 
	`¢´štf
(
ÃxŒa
, 
»maššg
, " ql_zli¡_max:%d", 
ql
->
fl
);

387 
ÃxŒa
 +ğ
u£d
;

388 
»maššg
 -ğ
u£d
;

390 
com´es£d
 = 
ql
->
com´ess
 != 0;

391 
u£d
 = 
	`¢´štf
(
ÃxŒa
, 
»maššg
, " ql_com´es£d:%d", 
com´es£d
);

392 
ÃxŒa
 +ğ
u£d
;

393 
»maššg
 -ğ
u£d
;

395 
sz
 = 0;

396 
quickli¡Node
 *
node
 = 
ql
->
h—d
;‚ode;‚odğnode->
Ãxt
) {

397 
sz
 +ğ
node
->sz;

399 
u£d
 = 
	`¢´štf
(
ÃxŒa
, 
»maššg
, " ql_uncom´es£d_size:%lu", 
sz
);

400 
ÃxŒa
 +ğ
u£d
;

401 
»maššg
 -ğ
u£d
;

404 
	`addR•lyStusFÜm©
(
c
,

408 (*)
v®
, v®->
»fcouÁ
,

409 
¡»nc
, 
	`rdbSavedObjeùL’
(
v®
),

410 
v®
->
Ìu
, 
	`e¡im©eObjeùIdËTime
(v®)/1000, 
exŒa
);

411 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"sd¦’"è&& c->
¬gc
 == 3) {

412 
diùEÁry
 *
de
;

413 
robj
 *
v®
;

414 
sds
 
key
;

416 ià((
de
 = 
	`diùFšd
(
c
->
db
->
diù
,c->
¬gv
[2]->
±r
)è=ğ
NULL
) {

417 
	`addR•ly
(
c
,
sh¬ed
.
nokey”r
);

420 
v®
 = 
	`diùG‘V®
(
de
);

421 
key
 = 
	`diùG‘Key
(
de
);

423 ià(
v®
->
ty³
 !ğ
OBJ_STRING
 || !
	`sdsEncodedObjeù
(val)) {

424 
	`addR•lyE¼Ü
(
c
,"Not‡n sdsƒncoded string.");

426 
	`addR•lyStusFÜm©
(
c
,

429 (è
	`sd¦’
(
key
),

430 (è
	`sd§va
(
key
),

431 (è
	`sdsZm®locSize
(
key
),

432 (è
	`sd¦’
(
v®
->
±r
),

433 (è
	`sd§va
(
v®
->
±r
),

434 (è
	`g‘SŒšgObjeùSdsU£dMemÜy
(
v®
));

436 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"zli¡"è&& c->
¬gc
 == 3) {

437 
robj
 *
o
;

439 ià((
o
 = 
	`objeùCommªdLookupOrR•ly
(
c
,c->
¬gv
[2],
sh¬ed
.
nokey”r
))

440 =ğ
NULL
) ;

442 ià(
o
->
’codšg
 !ğ
OBJ_ENCODING_ZIPLIST
) {

443 
	`addR•lyE¼Ü
(
c
,"Not‡n sdsƒncoded string.");

445 
	`zli¡R•r
(
o
->
±r
);

446 
	`addR•lyStus
(
c
,"Ziplist structure…rinted on stdout");

448 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"populate") &&

449 
c
->
¬gc
 >= 3 && c->argc <= 5) {

450 
keys
, 
j
;

451 
robj
 *
key
, *
v®
;

452 
buf
[128];

454 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
keys
, 
NULL
è!ğ
C_OK
)

456 
	`diùEx·nd
(
c
->
db
->
diù
,
keys
);

457 
j
 = 0; j < 
keys
; j++) {

458 
v®size
 = 0;

459 
	`¢´štf
(
buf
,(buf),"%s:%lu",

460 (
c
->
¬gc
 =ğ3è? "key" : (*)c->
¬gv
[3]->
±r
, 
j
);

461 
key
 = 
	`ü—‹SŒšgObjeù
(
buf
,
	`¡¾’
(buf));

462 ià(
c
->
¬gc
 == 5)

463 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[4], &
v®size
, 
NULL
è!ğ
C_OK
)

465 ià(
	`lookupKeyWr™e
(
c
->
db
,
key
è!ğ
NULL
) {

466 
	`deüRefCouÁ
(
key
);

469 
	`¢´štf
(
buf
,(buf),"v®ue:%lu",
j
);

470 ià(
v®size
==0)

471 
v®
 = 
	`ü—‹SŒšgObjeù
(
buf
,
	`¡¾’
(buf));

473 
buæ’
 = 
	`¡¾’
(
buf
);

474 
v®
 = 
	`ü—‹SŒšgObjeù
(
NULL
,
v®size
);

475 
	`memıy
(
v®
->
±r
, 
buf
, 
v®size
<=
buæ’
? valsize: buflen);

477 
	`dbAdd
(
c
->
db
,
key
,
v®
);

478 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

479 
	`deüRefCouÁ
(
key
);

481 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

482 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"dige¡"è&& c->
¬gc
 == 2) {

483 
dige¡
[20];

484 
sds
 
d
 = 
	`sd£m±y
();

485 
j
;

487 
	`compu‹D©a£tDige¡
(
dige¡
);

488 
j
 = 0; j < 20; j++)

489 
d
 = 
	`sdsÿrštf
(d, "%02x",
dige¡
[
j
]);

490 
	`addR•lyStus
(
c
,
d
);

491 
	`sdsä“
(
d
);

492 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"¦“p"è&& c->
¬gc
 == 3) {

493 
dtime
 = 
	`¡¹od
(
c
->
¬gv
[2]->
±r
,
NULL
);

494 
utime
 = 
dtime
*1000000;

495 
time¥ec
 
tv
;

497 
tv
.
tv_£c
 = 
utime
 / 1000000;

498 
tv
.
tv_n£c
 = (
utime
 % 1000000) * 1000;

499 
	`Çno¦“p
(&
tv
, 
NULL
);

500 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

501 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"set-active-expire") &&

502 
c
->
¬gc
 == 3)

504 
£rv”
.
aùive_expœe_’abËd
 = 
	`©oi
(
c
->
¬gv
[2]->
±r
);

505 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

506 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"lua-always-replicate-commands") &&

507 
c
->
¬gc
 == 3)

509 
£rv”
.
lua_®ways_»¶iÿ‹_commªds
 = 
	`©oi
(
c
->
¬gv
[2]->
±r
);

510 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

511 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"”rÜ"è&& c->
¬gc
 == 3) {

512 
sds
 
”r¡r
 = 
	`sd¢ewËn
("-",1);

514 
”r¡r
 = 
	`sdsÿtsds
Ó¼¡r,
c
->
¬gv
[2]->
±r
);

515 
”r¡r
 = 
	`sdsm­ch¬s
(errstr,"\n\r"," ",2);

516 
”r¡r
 = 
	`sdsÿ’
(errstr,"\r\n",2);

517 
	`addR•lySds
(
c
,
”r¡r
);

518 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"¡ruùsize"è&& c->
¬gc
 == 2) {

519 
sds
 
sizes
 = 
	`sd£m±y
();

520 
sizes
 = 
	`sdsÿrštf
(sizes,"bits:%d ",((*) == 8)?64:32);

521 
sizes
 = 
	`sdsÿrštf
(sizes,"robj:%d ",()(
robj
));

522 
sizes
 = 
	`sdsÿrštf
(sizes,"diù’Œy:%d ",()(
diùEÁry
));

523 
sizes
 = 
	`sdsÿrštf
(sizes,"sdshdr5:%d ",()(
sdshdr5
));

524 
sizes
 = 
	`sdsÿrštf
(sizes,"sdshdr8:%d ",()(
sdshdr8
));

525 
sizes
 = 
	`sdsÿrštf
(sizes,"sdshdr16:%d ",()(
sdshdr16
));

526 
sizes
 = 
	`sdsÿrštf
(sizes,"sdshdr32:%d ",()(
sdshdr32
));

527 
sizes
 = 
	`sdsÿrštf
(sizes,"sdshdr64:%d ",()(
sdshdr64
));

528 
	`addR•lyBulkSds
(
c
,
sizes
);

529 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"ht¡©s"è&& c->
¬gc
 == 3) {

530 
dbid
;

531 
sds
 
¡©s
 = 
	`sd£m±y
();

532 
buf
[4096];

534 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
dbid
, 
NULL
è!ğ
C_OK
)

536 ià(
dbid
 < 0 || dbid >ğ
£rv”
.
dbnum
) {

537 
	`addR•lyE¼Ü
(
c
,"Out of„ange database");

541 
¡©s
 = 
	`sdsÿrštf
(stats,"[Dictionary HT]\n");

542 
	`diùG‘Sts
(
buf
,(buf),
£rv”
.
db
[
dbid
].
diù
);

543 
¡©s
 = 
	`sdsÿt
(¡©s,
buf
);

545 
¡©s
 = 
	`sdsÿrštf
(stats,"[Expires HT]\n");

546 
	`diùG‘Sts
(
buf
,(buf),
£rv”
.
db
[
dbid
].
expœes
);

547 
¡©s
 = 
	`sdsÿt
(¡©s,
buf
);

549 
	`addR•lyBulkSds
(
c
,
¡©s
);

551 
	`addR•lyE¼ÜFÜm©
(
c
, "Unknown DEBUG subcommand or wrong‚umber of‡rguments for '%s'",

552 (*)
c
->
¬gv
[1]->
±r
);

554 
	}
}

558 
	$_£rv”As£¹
(cÚ¡ *
e¡r
, cÚ¡ *
fe
, 
lše
) {

559 
	`bugR•ÜtS¹
();

560 
	`£rv”Log
(
LL_WARNING
,"=== ASSERTION FAILED ===");

561 
	`£rv”Log
(
LL_WARNING
,"==> %s:%d '%s' i nÙrue",
fe
,
lše
,
e¡r
);

562 #ifdeà
HAVE_BACKTRACE


563 
£rv”
.
as£¹_çed
 = 
e¡r
;

564 
£rv”
.
as£¹_fe
 = 
fe
;

565 
£rv”
.
as£¹_lše
 = 
lše
;

566 
	`£rv”Log
(
LL_WARNING
,"(forcing SIGSEGVo…rinthe bug„eport.)");

569 
	}
}

571 
	$_£rv”As£¹PrštCl›ÁInfo
(cÚ¡ 
ş›Á
 *
c
) {

572 
j
;

574 
	`bugR•ÜtS¹
();

575 
	`£rv”Log
(
LL_WARNING
,"=== ASSERTION FAILED CLIENT CONTEXT ===");

576 
	`£rv”Log
(
LL_WARNING
,"ş›Á->æag ğ%d", 
c
->
æags
);

577 
	`£rv”Log
(
LL_WARNING
,"ş›Á->fd = %d", 
c
->
fd
);

578 
	`£rv”Log
(
LL_WARNING
,"ş›Á->¬gøğ%d", 
c
->
¬gc
);

579 
j
=0; j < 
c
->
¬gc
; j++) {

580 
buf
[128];

581 *
¬g
;

583 ià(
c
->
¬gv
[
j
]->
ty³
 =ğ
OBJ_STRING
 && 
	`sdsEncodedObjeù
(c->argv[j])) {

584 
¬g
 = (*è
c
->
¬gv
[
j
]->
±r
;

586 
	`¢´štf
(
buf
,(buf),"Objectype: %u,ƒncoding: %u",

587 
c
->
¬gv
[
j
]->
ty³
, c->¬gv[j]->
’codšg
);

588 
¬g
 = 
buf
;

590 
	`£rv”Log
(
LL_WARNING
,"client->argv[%d] = \"%s\" (refcount: %d)",

591 
j
, 
¬g
, 
c
->
¬gv
[j]->
»fcouÁ
);

593 
	}
}

595 
	$£rv”LogObjeùDebugInfo
(cÚ¡ 
robj
 *
o
) {

596 
	`£rv”Log
(
LL_WARNING
,"Objeùy³: %d", 
o
->
ty³
);

597 
	`£rv”Log
(
LL_WARNING
,"Objeùƒncodšg: %d", 
o
->
’codšg
);

598 
	`£rv”Log
(
LL_WARNING
,"Objeù„efcouÁ: %d", 
o
->
»fcouÁ
);

599 ià(
o
->
ty³
 =ğ
OBJ_STRING
 && 
	`sdsEncodedObjeù
(o)) {

600 
	`£rv”Log
(
LL_WARNING
,"Objeù„aw sŒšg†’: %zu", 
	`sd¦’
(
o
->
±r
));

601 ià(
	`sd¦’
(
o
->
±r
) < 4096) {

602 
sds
 
»´
 = 
	`sdsÿŒ•r
(
	`sd£m±y
(),
o
->
±r
,
	`sd¦’
(o->ptr));

603 
	`£rv”Log
(
LL_WARNING
,"Objeù„aw sŒšg cÚ‹Á: %s", 
»´
);

604 
	`sdsä“
(
»´
);

606 } ià(
o
->
ty³
 =ğ
OBJ_LIST
) {

607 
	`£rv”Log
(
LL_WARNING
,"Li¡†’gth: %d", (è
	`li¡Ty³L’gth
(
o
));

608 } ià(
o
->
ty³
 =ğ
OBJ_SET
) {

609 
	`£rv”Log
(
LL_WARNING
,"S‘ size: %d", (è
	`£tTy³Size
(
o
));

610 } ià(
o
->
ty³
 =ğ
OBJ_HASH
) {

611 
	`£rv”Log
(
LL_WARNING
,"Hash size: %d", (è
	`hashTy³L’gth
(
o
));

612 } ià(
o
->
ty³
 =ğ
OBJ_ZSET
) {

613 
	`£rv”Log
(
LL_WARNING
,"SÜ‹d s‘ size: %d", (è
	`z£tL’gth
(
o
));

614 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
)

615 
	`£rv”Log
(
LL_WARNING
,"Skli¡†ev–: %d", (è((cÚ¡ 
z£t
*)
o
->
±r
)->
z¦
->
Ëv–
);

617 
	}
}

619 
	$_£rv”As£¹PrštObjeù
(cÚ¡ 
robj
 *
o
) {

620 
	`bugR•ÜtS¹
();

621 
	`£rv”Log
(
LL_WARNING
,"=== ASSERTION FAILED OBJECT CONTEXT ===");

622 
	`£rv”LogObjeùDebugInfo
(
o
);

623 
	}
}

625 
	$_£rv”As£¹W™hInfo
(cÚ¡ 
ş›Á
 *
c
, cÚ¡ 
robj
 *
o
, cÚ¡ *
e¡r
, cÚ¡ *
fe
, 
lše
) {

626 ià(
c
è
	`_£rv”As£¹PrštCl›ÁInfo
(c);

627 ià(
o
è
	`_£rv”As£¹PrštObjeù
(o);

628 
	`_£rv”As£¹
(
e¡r
,
fe
,
lše
);

629 
	}
}

631 
	$_£rv”Pªic
(cÚ¡ *
fe
, 
lše
, cÚ¡ *
msg
, ...) {

632 
va_li¡
 
­
;

633 
	`va_¡¬t
(
­
,
msg
);

634 
fmtmsg
[256];

635 
	`v¢´štf
(
fmtmsg
,(fmtmsg),
msg
,
­
);

636 
	`va_’d
(
­
);

638 
	`bugR•ÜtS¹
();

639 
	`£rv”Log
(
LL_WARNING
,"------------------------------------------------");

640 
	`£rv”Log
(
LL_WARNING
,"!!! Software Failure. Press†eft mouse buttono continue");

641 
	`£rv”Log
(
LL_WARNING
,"Guru Med™©iÚ: % #%s:%d",
fmtmsg
,
fe
,
lše
);

642 #ifdeà
HAVE_BACKTRACE


643 
	`£rv”Log
(
LL_WARNING
,"(forcing SIGSEGV in ordero…rinthe stackrace)");

645 
	`£rv”Log
(
LL_WARNING
,"------------------------------------------------");

647 
	}
}

649 
	$bugR•ÜtS¹
() {

650 ià(
£rv”
.
bug_»pÜt_¡¬t
 == 0) {

651 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
,

653 
£rv”
.
bug_»pÜt_¡¬t
 = 1;

655 
	}
}

657 #ifdeà
HAVE_BACKTRACE


658 *
	$g‘McÚ‹xtE
(
ucÚ‹xt_t
 *
uc
) {

659 #ià
	`defšed
(
__APPLE__
è&& !defšed(
MAC_OS_X_VERSION_10_6
)

661 #ià
	`defšed
(
__x86_64__
)

662  (*è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r
;

663 #–ià
	`defšed
(
__i386__
)

664  (*è
uc
->
uc_mcÚ‹xt
->
__ss
.
__e
;

666  (*è
uc
->
uc_mcÚ‹xt
->
__ss
.
__¤r0
;

668 #–ià
	`defšed
(
__APPLE__
è&& defšed(
MAC_OS_X_VERSION_10_6
)

670 #ià
	`defšed
(
_STRUCT_X86_THREAD_STATE64
è&& !defšed(
__i386__
)

671  (*è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r
;

673  (*è
uc
->
uc_mcÚ‹xt
->
__ss
.
__e
;

675 #–ià
	`defšed
(
__lšux__
)

677 #ià
	`defšed
(
__i386__
)

678  (*è
uc
->
uc_mcÚ‹xt
.
g»gs
[14];

679 #–ià
	`defšed
(
__X86_64__
è|| defšed(
__x86_64__
)

680  (*è
uc
->
uc_mcÚ‹xt
.
g»gs
[16];

681 #–ià
	`defšed
(
__Ÿ64__
)

682  (*è
uc
->
uc_mcÚ‹xt
.
sc_
;

683 #–ià
	`defšed
(
__¬m__
)

684  (*è
uc
->
uc_mcÚ‹xt
.
¬m_pc
;

687  
NULL
;

689 
	}
}

691 
	$logSckCÚ‹Á
(**
¥
) {

692 
i
;

693 
i
 = 15; i >= 0; i--) {

694 
addr
 = (è
¥
+
i
;

695 
v®
 = (è
¥
[
i
];

698 
	`£rv”Log
(
LL_WARNING
, "(%08lxè-> %08lx", 
addr
, 
v®
);

700 
	`£rv”Log
(
LL_WARNING
, "(%016lxè-> %016lx", 
addr
, 
v®
);

702 
	}
}

704 
	$logRegi¡”s
(
ucÚ‹xt_t
 *
uc
) {

705 
	`£rv”Log
(
LL_WARNING
|
LL_RAW
, "\n------ REGISTERS ------\n");

708 #ià
	`defšed
(
__APPLE__
è&& defšed(
MAC_OS_X_VERSION_10_6
)

710 #ià
	`defšed
(
_STRUCT_X86_THREAD_STATE64
è&& !defšed(
__i386__
)

711 
	`£rv”Log
(
LL_WARNING
,

718 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__¿x
,

719 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__rbx
,

720 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__rcx
,

721 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__rdx
,

722 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__rdi
,

723 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__rsi
,

724 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__rbp
,

725 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r¥
,

726 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r8
,

727 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r9
,

728 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r10
,

729 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r11
,

730 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r12
,

731 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r13
,

732 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r14
,

733 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r15
,

734 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r
,

735 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__ræags
,

736 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__cs
,

737 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__fs
,

738 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__gs


740 
	`logSckCÚ‹Á
((**)
uc
->
uc_mcÚ‹xt
->
__ss
.
__r¥
);

743 
	`£rv”Log
(
LL_WARNING
,

749 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__—x
,

750 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__ebx
,

751 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__ecx
,

752 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__edx
,

753 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__edi
,

754 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__esi
,

755 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__ebp
,

756 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__e¥
,

757 (è
uc
->
uc_mcÚ‹xt
->
__ss
.__ss,

758 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__eæags
,

759 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__e
,

760 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__cs
,

761 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__ds
,

762 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__es
,

763 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__fs
,

764 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__gs


766 
	`logSckCÚ‹Á
((**)
uc
->
uc_mcÚ‹xt
->
__ss
.
__e¥
);

769 #–ià
	`defšed
(
__lšux__
)

771 #ià
	`defšed
(
__i386__
)

772 
	`£rv”Log
(
LL_WARNING
,

778 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[11],

779 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[8],

780 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[10],

781 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[9],

782 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[4],

783 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[5],

784 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[6],

785 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[7],

786 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[18],

787 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[17],

788 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[14],

789 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[15],

790 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[3],

791 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[2],

792 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[1],

793 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[0]

795 
	`logSckCÚ‹Á
((**)
uc
->
uc_mcÚ‹xt
.
g»gs
[7]);

796 #–ià
	`defšed
(
__X86_64__
è|| defšed(
__x86_64__
)

798 
	`£rv”Log
(
LL_WARNING
,

805 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[13],

806 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[11],

807 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[14],

808 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[12],

809 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[8],

810 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[9],

811 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[10],

812 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[15],

813 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[0],

814 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[1],

815 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[2],

816 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[3],

817 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[4],

818 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[5],

819 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[6],

820 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[7],

821 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[16],

822 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[17],

823 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[18]

825 
	`logSckCÚ‹Á
((**)
uc
->
uc_mcÚ‹xt
.
g»gs
[15]);

828 
	`£rv”Log
(
LL_WARNING
,

831 
	}
}

839 
	$İ’DœeùLogFedes
() {

840 
log_to_¡dout
 = 
£rv”
.
logfe
[0] == '\0';

841 
fd
 = 
log_to_¡dout
 ?

842 
STDOUT_FILENO
 :

843 
	`İ’
(
£rv”
.
logfe
, 
O_APPEND
|
O_CREAT
|
O_WRONLY
, 0644);

844  
fd
;

845 
	}
}

848 
	$şo£DœeùLogFedes
(
fd
) {

849 
log_to_¡dout
 = 
£rv”
.
logfe
[0] == '\0';

850 ià(!
log_to_¡dout
è
	`şo£
(
fd
);

851 
	}
}

855 
	$logSckT¿û
(
ucÚ‹xt_t
 *
uc
) {

856 *
Œaû
[101];

857 
Œaû_size
 = 0, 
fd
 = 
	`İ’DœeùLogFedes
();

859 ià(
fd
 == -1) ;

862 
Œaû_size
 = 
	`backŒaû
(
Œaû
+1, 100);

864 ià(
	`g‘McÚ‹xtE
(
uc
è!ğ
NULL
) {

865 *
msg1
 = "EIP:\n";

866 *
msg2
 = "\nBacktrace:\n";

867 ià(
	`wr™e
(
fd
,
msg1
,
	`¡¾’
(msg1)) == -1) { };

868 
Œaû
[0] = 
	`g‘McÚ‹xtE
(
uc
);

869 
	`backŒaû_symbŞs_fd
(
Œaû
, 1, 
fd
);

870 ià(
	`wr™e
(
fd
,
msg2
,
	`¡¾’
(msg2)) == -1) { };

874 
	`backŒaû_symbŞs_fd
(
Œaû
+1, 
Œaû_size
, 
fd
);

877 
	`şo£DœeùLogFedes
(
fd
);

878 
	}
}

883 
	$logCu¼’tCl›Á
() {

884 ià(
£rv”
.
cu¼’t_ş›Á
 =ğ
NULL
) ;

886 
ş›Á
 *
cc
 = 
£rv”
.
cu¼’t_ş›Á
;

887 
sds
 
ş›Á
;

888 
j
;

890 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
, "\n------ CURRENT CLIENT INFO ------\n");

891 
ş›Á
 = 
	`ÿtCl›ÁInfoSŒšg
(
	`sd£m±y
(),
cc
);

892 
	`£rv”Log
(
LL_WARNING
|
LL_RAW
,"%s\n", 
ş›Á
);

893 
	`sdsä“
(
ş›Á
);

894 
j
 = 0; j < 
cc
->
¬gc
; j++) {

895 
robj
 *
decoded
;

897 
decoded
 = 
	`g‘DecodedObjeù
(
cc
->
¬gv
[
j
]);

898 
	`£rv”Log
(
LL_WARNING
|
LL_RAW
,"¬gv[%d]: '%s'\n", 
j
,

899 (*)
decoded
->
±r
);

900 
	`deüRefCouÁ
(
decoded
);

904 ià(
cc
->
¬gc
 >= 1) {

905 
robj
 *
v®
, *
key
;

906 
diùEÁry
 *
de
;

908 
key
 = 
	`g‘DecodedObjeù
(
cc
->
¬gv
[1]);

909 
de
 = 
	`diùFšd
(
cc
->
db
->
diù
, 
key
->
±r
);

910 ià(
de
) {

911 
v®
 = 
	`diùG‘V®
(
de
);

912 
	`£rv”Log
(
LL_WARNING
,"key '%s' found iÀDB cÚššghfŞlowšg objeù:", (*)
key
->
±r
);

913 
	`£rv”LogObjeùDebugInfo
(
v®
);

915 
	`deüRefCouÁ
(
key
);

917 
	}
}

919 #ià
defšed
(
HAVE_PROC_MAPS
)

921 
	#MEMTEST_MAX_REGIONS
 128

	)

924 
	$mem‹¡_‹¡_lšux_ªÚymous_m­s
() {

925 
FILE
 *
å
;

926 
lše
[1024];

927 
logbuf
[1024];

928 
size_t
 
¡¬t_addr
, 
’d_addr
, 
size
;

929 
size_t
 
¡¬t_veù
[
MEMTEST_MAX_REGIONS
];

930 
size_t
 
size_veù
[
MEMTEST_MAX_REGIONS
];

931 
»giÚs
 = 0, 
j
;

933 
fd
 = 
	`İ’DœeùLogFedes
();

934 ià(!
fd
)  0;

936 
å
 = 
	`fİ’
("/proc/self/maps","r");

937 ià(!
å
)  0;

938 
	`fg‘s
(
lše
,Öše),
å
è!ğ
NULL
) {

939 *
¡¬t
, *
’d
, *
p
 = 
lše
;

941 
¡¬t
 = 
p
;

942 
p
 = 
	`¡rchr
(p,'-');

943 ià(!
p
) ;

944 *
p
++ = '\0';

945 
’d
 = 
p
;

946 
p
 = 
	`¡rchr
(p,' ');

947 ià(!
p
) ;

948 *
p
++ = '\0';

949 ià(
	`¡r¡r
(
p
,"stack") ||

950 
	`¡r¡r
(
p
,"vdso") ||

951 
	`¡r¡r
(
p
,"vsyscall")) ;

952 ià(!
	`¡r¡r
(
p
,"00:00")) ;

953 ià(!
	`¡r¡r
(
p
,"rw")) ;

955 
¡¬t_addr
 = 
	`¡¹oul
(
¡¬t
,
NULL
,16);

956 
’d_addr
 = 
	`¡¹oul
(
’d
,
NULL
,16);

957 
size
 = 
’d_addr
-
¡¬t_addr
;

959 
¡¬t_veù
[
»giÚs
] = 
¡¬t_addr
;

960 
size_veù
[
»giÚs
] = 
size
;

961 
	`¢´štf
(
logbuf
,(logbuf),

963 (è
¡¬t_veù
[
»giÚs
],

964 (è
size_veù
[
»giÚs
]);

965 ià(
	`wr™e
(
fd
,
logbuf
,
	`¡¾’
(logbuf)) == -1) { }

966 
»giÚs
++;

969 
”rÜs
 = 0;

970 
j
 = 0; j < 
»giÚs
; j++) {

971 ià(
	`wr™e
(
fd
,".",1) == -1) { }

972 
”rÜs
 +ğ
	`mem‹¡_´e£rvšg_‹¡
((*)
¡¬t_veù
[
j
],
size_veù
[j],1);

973 ià(
	`wr™e
(
fd
, 
”rÜs
 ? "E" : "O",1) == -1) { }

975 ià(
	`wr™e
(
fd
,"\n",1) == -1) { }

980 
	`fşo£
(
å
);

981 
	`şo£DœeùLogFedes
(
fd
);

982  
”rÜs
;

983 
	}
}

989 
	$dumpX86C®ls
(*
addr
, 
size_t
 
Ën
) {

990 
size_t
 
j
;

991 *
p
 = 
addr
;

992 
Dl_šfo
 
šfo
;

995 
ht
[256] = {0};

997 ià(
Ën
 < 5) ;

998 
j
 = 0; j < 
Ën
-4; j++) {

999 ià(
p
[
j
] != 0xE8) ;

1000 
rg‘
 = ()
addr
+
j
+5;

1001 
rg‘
 +ğ*((
št32_t
*)(
p
+
j
+1));

1002 ià(
	`dÏddr
((*)
rg‘
, &
šfo
è!ğ0 && info.
dli_¢ame
 !ğ
NULL
) {

1003 ià(
ht
[
rg‘
&0xff] !=arget) {

1004 
	`´štf
("FunùiÚ‡ˆ0x%lx i %s\n",
rg‘
,
šfo
.
dli_¢ame
);

1005 
ht
[
rg‘
&0xff] =arget;

1007 
j
 += 4;

1010 
	}
}

1012 
	$sig£gvHªdËr
(
sig
, 
sigšfo_t
 *
šfo
, *
£ü‘
) {

1013 
ucÚ‹xt_t
 *
uc
 = (ucÚ‹xt_t*è
£ü‘
;

1014 *
e
 = 
	`g‘McÚ‹xtE
(
uc
);

1015 
sds
 
šfo¡ršg
, 
ş›Ás
;

1016 
sigaùiÚ
 
aù
;

1017 
	`UNUSED
(
šfo
);

1019 
	`bugR•ÜtS¹
();

1020 
	`£rv”Log
(
LL_WARNING
,

1021 "Redi % üashed by sigÇl: %d", 
REDIS_VERSION
, 
sig
);

1022 ià(
e
 !ğ
NULL
) {

1023 
	`£rv”Log
(
LL_WARNING
,

1024 "C¿shed„uÂšghš¡uùiÚ‡t: %p", 
e
);

1026 ià(
sig
 =ğ
SIGSEGV
 || sig =ğ
SIGBUS
) {

1027 
	`£rv”Log
(
LL_WARNING
,

1028 "Acûssšg‡dd»ss: %p", (*)
šfo
->
si_addr
);

1030 
	`£rv”Log
(
LL_WARNING
,

1031 "Faed‡s£¹iÚ: % (%s:%d)", 
£rv”
.
as£¹_çed
,

1032 
£rv”
.
as£¹_fe
, s”v”.
as£¹_lše
);

1035 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
, "\n------ STACK TRACE ------\n");

1036 
	`logSckT¿û
(
uc
);

1039 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
, "\n------ INFO OUTPUT ------\n");

1040 
šfo¡ršg
 = 
	`g’RedisInfoSŒšg
("all");

1041 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
, 
šfo¡ršg
);

1042 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
, "\n------ CLIENT LIST OUTPUT ------\n");

1043 
ş›Ás
 = 
	`g‘AÎCl›ÁsInfoSŒšg
();

1044 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
, 
ş›Ás
);

1045 
	`sdsä“
(
šfo¡ršg
);

1046 
	`sdsä“
(
ş›Ás
);

1049 
	`logCu¼’tCl›Á
();

1052 
	`logRegi¡”s
(
uc
);

1054 #ià
	`defšed
(
HAVE_PROC_MAPS
)

1056 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
, "\n------ FAST MEMORY TEST ------\n");

1057 
	`bioKlTh»ads
();

1058 ià(
	`mem‹¡_‹¡_lšux_ªÚymous_m­s
()) {

1059 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
,

1062 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
,

1067 ià(
e
 !ğ
NULL
) {

1068 
Dl_šfo
 
šfo
;

1069 ià(
	`dÏddr
(
e
, &
šfo
) != 0) {

1070 
	`£rv”Log
(
LL_WARNING
|
LL_RAW
,

1077 
šfo
.
dli_¢ame
, info.
dli_§ddr
, info.
dli_âame
, info.
dli_fba£
,

1078 
šfo
.
dli_§ddr
);

1079 
size_t
 
Ën
 = ()
e
 - ()
šfo
.
dli_§ddr
;

1080 
sz
 = 
	`syscÚf
(
_SC_PAGESIZE
);

1081 ià(
Ën
 < 1<<13) {

1085 
Ãxt
 = (()
e
 + 
sz
) & ~(sz-1);

1086 
’d
 = ()
e
 + 128;

1087 ià(
’d
 > 
Ãxt
)ƒnd =‚ext;

1088 
Ën
 = 
’d
 - ()
šfo
.
dli_§ddr
;

1089 
	`£rv”LogHexDump
(
LL_WARNING
, "dump of function",

1090 
šfo
.
dli_§ddr
 ,
Ën
);

1091 
	`dumpX86C®ls
(
šfo
.
dli_§ddr
,
Ën
);

1096 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
,

1104 ià(
£rv”
.
d«mÚize
 && s”v”.
su³rvi£d
 =ğ0è
	`uÆšk
(£rv”.
pidfe
);

1108 
	`sigem±y£t
 (&
aù
.
§_mask
);

1109 
aù
.
§_æags
 = 
SA_NODEFER
 | 
SA_ONSTACK
 | 
SA_RESETHAND
;

1110 
aù
.
§_hªdËr
 = 
SIG_DFL
;

1111 
	`sigaùiÚ
 (
sig
, &
aù
, 
NULL
);

1112 
	`kl
(
	`g‘pid
(),
sig
);

1113 
	}
}

1118 
	$£rv”LogHexDump
(
Ëv–
, *
desü
, *
v®ue
, 
size_t
 
Ën
) {

1119 
buf
[65], *
b
;

1120 *
v
 = 
v®ue
;

1121 
ch¬£t
[] = "0123456789abcdef";

1123 
	`£rv”Log
(
Ëv–
,"% (hexdum°oà%zu by‹s):", 
desü
, 
Ën
);

1124 
b
 = 
buf
;

1125 
Ën
) {

1126 
b
[0] = 
ch¬£t
[(*
v
)>>4];

1127 
b
[1] = 
ch¬£t
[(*
v
)&0xf];

1128 
b
[2] = '\0';

1129 
b
 += 2;

1130 
Ën
--;

1131 
v
++;

1132 ià(
b
-
buf
 =ğ64 || 
Ën
 == 0) {

1133 
	`£rv”LogRaw
(
Ëv–
|
LL_RAW
,
buf
);

1134 
b
 = 
buf
;

1137 
	`£rv”LogRaw
(
Ëv–
|
LL_RAW
,"\n");

1138 
	}
}

1141 
	~<sys/time.h
>

1143 
	$w©chdogSigÇlHªdËr
(
sig
, 
sigšfo_t
 *
šfo
, *
£ü‘
) {

1144 #ifdeà
HAVE_BACKTRACE


1145 
ucÚ‹xt_t
 *
uc
 = (ucÚ‹xt_t*è
£ü‘
;

1147 
	`UNUSED
(
šfo
);

1148 
	`UNUSED
(
sig
);

1150 
	`£rv”LogFromHªdËr
(
LL_WARNING
,"\n--- WATCHDOG TIMER EXPIRED ---");

1151 #ifdeà
HAVE_BACKTRACE


1152 
	`logSckT¿û
(
uc
);

1154 
	`£rv”LogFromHªdËr
(
LL_WARNING
,"Sorry:‚o support for backtrace().");

1156 
	`£rv”LogFromHªdËr
(
LL_WARNING
,"--------\n");

1157 
	}
}

1162 
	$w©chdogScheduËSigÇl
(
³riod
) {

1163 
™im”v®
 
™
;

1166 
™
.
™_v®ue
.
tv_£c
 = 
³riod
/1000;

1167 
™
.
™_v®ue
.
tv_u£c
 = (
³riod
%1000)*1000;

1169 
™
.
™_š‹rv®
.
tv_£c
 = 0;

1170 
™
.
™_š‹rv®
.
tv_u£c
 = 0;

1171 
	`£t™im”
(
ITIMER_REAL
, &
™
, 
NULL
);

1172 
	}
}

1175 
	$’abËW©chdog
(
³riod
) {

1176 
mš_³riod
;

1178 ià(
£rv”
.
w©chdog_³riod
 == 0) {

1179 
sigaùiÚ
 
aù
;

1183 
	`sigem±y£t
(&
aù
.
§_mask
);

1184 
aù
.
§_æags
 = 
SA_ONSTACK
 | 
SA_SIGINFO
;

1185 
aù
.
§_sigaùiÚ
 = 
w©chdogSigÇlHªdËr
;

1186 
	`sigaùiÚ
(
SIGALRM
, &
aù
, 
NULL
);

1191 
mš_³riod
 = (1000/
£rv”
.
hz
)*2;

1192 ià(
³riod
 < 
mš_³riod
)…eriod = min_period;

1193 
	`w©chdogScheduËSigÇl
(
³riod
);

1194 
£rv”
.
w©chdog_³riod
 = 
³riod
;

1195 
	}
}

1198 
	$di§bËW©chdog
() {

1199 
sigaùiÚ
 
aù
;

1200 ià(
£rv”
.
w©chdog_³riod
 == 0) ;

1201 
	`w©chdogScheduËSigÇl
(0);

1205 
	`sigem±y£t
(&
aù
.
§_mask
);

1206 
aù
.
§_æags
 = 0;

1207 
aù
.
§_hªdËr
 = 
SIG_IGN
;

1208 
	`sigaùiÚ
(
SIGALRM
, &
aù
, 
NULL
);

1209 
£rv”
.
w©chdog_³riod
 = 0;

1210 
	}
}

	@debugmacro.h

33 
	~<¡dio.h
>

34 
	#D
(...) \

36 
FILE
 *
å
 = 
	`fİ’
("/tmp/log.txt","a"); \

37 
	`årštf
(
å
,"%s:%s:%d:\t", 
__FILE__
, 
__func__
, 
__LINE__
); \

38 
	`årštf
(
å
,
__VA_ARGS__
); \

39 
	`årštf
(
å
,"\n"); \

40 
	`fşo£
(
å
); \

41 } 0);

	)

	@defrag.c

37 
	~"£rv”.h
"

38 
	~<time.h
>

39 
	~<as£¹.h
>

40 
	~<¡ddef.h
>

42 #ifdeà
HAVE_DEFRAG


46 
je_g‘_deäag_hšt
(* 
±r
, *
bš_ut
, *
run_ut
);

53 * 
	$aùiveDeäagAÎoc
(*
±r
) {

54 
bš_ut
, 
run_ut
;

55 
size_t
 
size
;

56 *
Ãw±r
;

57 if(!
	`je_g‘_deäag_hšt
(
±r
, &
bš_ut
, &
run_ut
)) {

58 
£rv”
.
¡©_aùive_deäag_mis£s
++;

59  
NULL
;

64 ià(
run_ut
 > 
bš_ut
 ||„un_util == 1<<16) {

65 
£rv”
.
¡©_aùive_deäag_mis£s
++;

66  
NULL
;

71 
size
 = 
	`zm®loc_size
(
±r
);

72 
Ãw±r
 = 
	`zm®loc_no_tÿche
(
size
);

73 
	`memıy
(
Ãw±r
, 
±r
, 
size
);

74 
	`zä“_no_tÿche
(
±r
);

75  
Ãw±r
;

76 
	}
}

83 
sds
 
	$aùiveDeäagSds
(
sds
 
sd¥Œ
) {

84 * 
±r
 = 
	`sdsAÎocPŒ
(
sd¥Œ
);

85 * 
Ãw±r
 = 
	`aùiveDeäagAÎoc
(
±r
);

86 ià(
Ãw±r
) {

87 
size_t
 
off£t
 = 
sd¥Œ
 - (*)
±r
;

88 
sd¥Œ
 = (*)
Ãw±r
 + 
off£t
;

89  
sd¥Œ
;

91  
NULL
;

92 
	}
}

99 
robj
 *
	$aùiveDeäagSŒšgOb
(
robj
* 
ob
, *
deäagged
) {

100 
robj
 *
»t
 = 
NULL
;

101 ià(
ob
->
»fcouÁ
!=1)

102  
NULL
;

105 ià(
ob
->
ty³
!=
OBJ_STRING
 || ob->
’codšg
!=
OBJ_ENCODING_EMBSTR
) {

106 ià((
»t
 = 
	`aùiveDeäagAÎoc
(
ob
))) {

107 
ob
 = 
»t
;

108 (*
deäagged
)++;

113 ià(
ob
->
ty³
 =ğ
OBJ_STRING
) {

114 if(
ob
->
’codšg
==
OBJ_ENCODING_RAW
) {

115 
sds
 
Ãwsds
 = 
	`aùiveDeäagSds
((sds)
ob
->
±r
);

116 ià(
Ãwsds
) {

117 
ob
->
±r
 = 
Ãwsds
;

118 (*
deäagged
)++;

120 } ià(
ob
->
’codšg
==
OBJ_ENCODING_EMBSTR
) {

123 
ofs
 = (
šŒ_t
)
ob
->
±r
 - (intptr_t)ob;

124 ià((
»t
 = 
	`aùiveDeäagAÎoc
(
ob
))) {

125 
»t
->
±r
 = (*)((
šŒ_t
ì‘ + 
ofs
);

126 (*
deäagged
)++;

128 } ià(
ob
->
’codšg
!=
OBJ_ENCODING_INT
) {

129 
	`£rv”Pªic
("Unknown stringƒncoding");

132  
»t
;

133 
	}
}

137 
	$diùI‹rDeäagEÁry
(
diùI‹¿tÜ
 *
™”
) {

141 
deäagged
 = 0;

142 
diùht
 *
ht
;

145 ià(
™”
->
ÃxtEÁry
) {

146 
diùEÁry
 *
Ãwde
 = 
	`aùiveDeäagAÎoc
(
™”
->
ÃxtEÁry
);

147 ià(
Ãwde
) {

148 
deäagged
++;

149 
™”
->
ÃxtEÁry
 = 
Ãwde
;

150 
™”
->
’Œy
->
Ãxt
 = 
Ãwde
;

154 
ht
 = &
™”
->
d
->ht[™”->
bË
];

155 ià(
ht
->
bË
[
™”
->
šdex
] =ğ™”->
’Œy
) {

156 
diùEÁry
 *
Ãwde
 = 
	`aùiveDeäagAÎoc
(
™”
->
’Œy
);

157 ià(
Ãwde
) {

158 
™”
->
’Œy
 = 
Ãwde
;

159 
ht
->
bË
[
™”
->
šdex
] = 
Ãwde
;

160 
deäagged
++;

163  
deäagged
;

164 
	}
}

169 
	$diùDeäagTabËs
(
diù
** 
diùRef
) {

170 
diù
 *
d
 = *
diùRef
;

171 
diùEÁry
 **
ÃwbË
;

172 
deäagged
 = 0;

174 
diù
 *
Ãwd
 = 
	`aùiveDeäagAÎoc
(
d
);

175 ià(
Ãwd
)

176 
deäagged
++, *
diùRef
 = 
d
 = 
Ãwd
;

178 
ÃwbË
 = 
	`aùiveDeäagAÎoc
(
d
->
ht
[0].
bË
);

179 ià(
ÃwbË
)

180 
deäagged
++, 
d
->
ht
[0].
bË
 = 
ÃwbË
;

182 ià(
d
->
ht
[1].
bË
) {

183 
ÃwbË
 = 
	`aùiveDeäagAÎoc
(
d
->
ht
[1].
bË
);

184 ià(
ÃwbË
)

185 
deäagged
++, 
d
->
ht
[1].
bË
 = 
ÃwbË
;

187  
deäagged
;

188 
	}
}

191 
	$z¦Upd©eNode
(
zskli¡
 *
z¦
, 
zskli¡Node
 *
Şdnode
, zskli¡Nod*
Ãwnode
, zskli¡Nod**
upd©e
) {

192 
i
;

193 
i
 = 0; i < 
z¦
->
Ëv–
; i++) {

194 ià(
upd©e
[
i
]->
Ëv–
[i].
fÜw¬d
 =ğ
Şdnode
)

195 
upd©e
[
i
]->
Ëv–
[i].
fÜw¬d
 = 
Ãwnode
;

197 
	`£rv”As£¹
(
z¦
->
h—d”
!=
Şdnode
);

198 ià(
Ãwnode
->
Ëv–
[0].
fÜw¬d
) {

199 
	`£rv”As£¹
(
Ãwnode
->
Ëv–
[0].
fÜw¬d
->
backw¬d
==
Şdnode
);

200 
Ãwnode
->
Ëv–
[0].
fÜw¬d
->
backw¬d
 =‚ewnode;

202 
	`£rv”As£¹
(
z¦
->

==
Şdnode
);

203 
z¦
->

 = 
Ãwnode
;

205 
	}
}

214 *
	$z¦Deäag
(
zskli¡
 *
z¦
, 
scÜe
, 
sds
 
Şd–e
, sd 
Ãw–e
) {

215 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
, *
Ãwx
;

216 
i
;

217 
sds
 
–e
 = 
Ãw–e
?‚ew–e: 
Şd–e
;

221 
x
 = 
z¦
->
h—d”
;

222 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

223 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

224 
x
->
Ëv–
[
i
].
fÜw¬d
->
–e
 !ğ
Şd–e
 &&

227 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 < score ||

228 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 == score &&

229 
	`sdscmp
(
x
->
Ëv–
[
i
].
fÜw¬d
->
–e
,ele) < 0)))

230 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

231 
upd©e
[
i
] = 
x
;

235 
x
 = x->
Ëv–
[0].
fÜw¬d
;

236 
	`£rv”As£¹
(
x
 && 
scÜe
 =ğx->scÜ&& x->
–e
==
Şd–e
);

237 ià(
Ãw–e
)

238 
x
->
–e
 = 
Ãw–e
;

241 
Ãwx
 = 
	`aùiveDeäagAÎoc
(
x
);

242 ià(
Ãwx
) {

243 
	`z¦Upd©eNode
(
z¦
, 
x
, 
Ãwx
, 
upd©e
);

244  &
Ãwx
->
scÜe
;

246  
NULL
;

247 
	}
}

256 
diùEÁry
* 
	$»¶aûS©–™eDiùKeyPŒAndOrDeäagDiùEÁry
(
diù
 *
d
, 
sds
 
Şdkey
, sd 
Ãwkey
, 
hash
, *
deäagged
) {

257 
diùEÁry
 **
d”ef
 = 
	`diùFšdEÁryRefByPŒAndHash
(
d
, 
Şdkey
, 
hash
);

258 ià(
d”ef
) {

259 
diùEÁry
 *
de
 = *
d”ef
;

260 
diùEÁry
 *
Ãwde
 = 
	`aùiveDeäagAÎoc
(
de
);

261 ià(
Ãwde
) {

262 
de
 = *
d”ef
 = 
Ãwde
;

263 (*
deäagged
)++;

265 ià(
Ãwkey
)

266 
de
->
key
 = 
Ãwkey
;

267  
de
;

269  
NULL
;

270 
	}
}

275 
	$deäagKey
(
»disDb
 *
db
, 
diùEÁry
 *
de
) {

276 
sds
 
keysds
 = 
	`diùG‘Key
(
de
);

277 
robj
 *
Ãwob
, *
ob
;

278 *
Ãwzl
;

279 
diù
 *
d
;

280 
diùI‹¿tÜ
 *
di
;

281 
deäagged
 = 0;

282 
sds
 
Ãwsds
;

285 
Ãwsds
 = 
	`aùiveDeäagSds
(
keysds
);

286 ià(
Ãwsds
)

287 
deäagged
++, 
de
->
key
 = 
Ãwsds
;

288 ià(
	`diùSize
(
db
->
expœes
)) {

292 
hash
 = 
	`diùG‘Hash
(
db
->
diù
, 
de
->
key
);

293 
	`»¶aûS©–™eDiùKeyPŒAndOrDeäagDiùEÁry
(
db
->
expœes
, 
keysds
, 
Ãwsds
, 
hash
, &
deäagged
);

297 
ob
 = 
	`diùG‘V®
(
de
);

298 ià((
Ãwob
 = 
	`aùiveDeäagSŒšgOb
(
ob
, &
deäagged
))) {

299 
de
->
v
.
v®
 = 
Ãwob
;

300 
ob
 = 
Ãwob
;

303 ià(
ob
->
ty³
 =ğ
OBJ_STRING
) {

305 } ià(
ob
->
ty³
 =ğ
OBJ_LIST
) {

306 ià(
ob
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

307 
quickli¡
 *
ql
 = 
ob
->
±r
, *
Ãwql
;

308 
quickli¡Node
 *
node
 = 
ql
->
h—d
, *
Ãwnode
;

309 ià((
Ãwql
 = 
	`aùiveDeäagAÎoc
(
ql
)))

310 
deäagged
++, 
ob
->
±r
 = 
ql
 = 
Ãwql
;

311 
node
) {

312 ià((
Ãwnode
 = 
	`aùiveDeäagAÎoc
(
node
))) {

313 ià(
Ãwnode
->
´ev
)

314 
Ãwnode
->
´ev
->
Ãxt
 =‚ewnode;

316 
ql
->
h—d
 = 
Ãwnode
;

317 ià(
Ãwnode
->
Ãxt
)

318 
Ãwnode
->
Ãxt
->
´ev
 =‚ewnode;

320 
ql
->

 = 
Ãwnode
;

321 
node
 = 
Ãwnode
;

322 
deäagged
++;

324 ià((
Ãwzl
 = 
	`aùiveDeäagAÎoc
(
node
->
zl
)))

325 
deäagged
++, 
node
->
zl
 = 
Ãwzl
;

326 
node
 =‚ode->
Ãxt
;

328 } ià(
ob
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

329 ià((
Ãwzl
 = 
	`aùiveDeäagAÎoc
(
ob
->
±r
)))

330 
deäagged
++, 
ob
->
±r
 = 
Ãwzl
;

332 
	`£rv”Pªic
("Unknown†istƒncoding");

334 } ià(
ob
->
ty³
 =ğ
OBJ_SET
) {

335 ià(
ob
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

336 
d
 = 
ob
->
±r
;

337 
di
 = 
	`diùG‘I‹¿tÜ
(
d
);

338 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

339 
sds
 
sd£Ë
 = 
	`diùG‘Key
(
de
);

340 ià((
Ãwsds
 = 
	`aùiveDeäagSds
(
sd£Ë
)))

341 
deäagged
++, 
de
->
key
 = 
Ãwsds
;

342 
deäagged
 +ğ
	`diùI‹rDeäagEÁry
(
di
);

344 
	`diùR–—£I‹¿tÜ
(
di
);

345 
	`diùDeäagTabËs
((
diù
**)&
ob
->
±r
);

346 } ià(
ob
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

347 
št£t
 *
is
 = 
ob
->
±r
;

348 
št£t
 *
Ãwis
 = 
	`aùiveDeäagAÎoc
(
is
);

349 ià(
Ãwis
)

350 
deäagged
++, 
ob
->
±r
 = 
Ãwis
;

352 
	`£rv”Pªic
("Unknown setƒncoding");

354 } ià(
ob
->
ty³
 =ğ
OBJ_ZSET
) {

355 ià(
ob
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

356 ià((
Ãwzl
 = 
	`aùiveDeäagAÎoc
(
ob
->
±r
)))

357 
deäagged
++, 
ob
->
±r
 = 
Ãwzl
;

358 } ià(
ob
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

359 
z£t
 *
zs
 = (z£t*)
ob
->
±r
;

360 
z£t
 *
Ãwzs
;

361 
zskli¡
 *
Ãwz¦
;

362 
zskli¡Node
 *
Ãwh—d”
;

363 ià((
Ãwzs
 = 
	`aùiveDeäagAÎoc
(
zs
)))

364 
deäagged
++, 
ob
->
±r
 = 
zs
 = 
Ãwzs
;

365 ià((
Ãwz¦
 = 
	`aùiveDeäagAÎoc
(
zs
->
z¦
)))

366 
deäagged
++, 
zs
->
z¦
 = 
Ãwz¦
;

367 ià((
Ãwh—d”
 = 
	`aùiveDeäagAÎoc
(
zs
->
z¦
->
h—d”
)))

368 
deäagged
++, 
zs
->
z¦
->
h—d”
 = 
Ãwh—d”
;

369 
d
 = 
zs
->
diù
;

370 
di
 = 
	`diùG‘I‹¿tÜ
(
d
);

371 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

372 * 
ÃwscÜe
;

373 
sds
 
sd£Ë
 = 
	`diùG‘Key
(
de
);

374 ià((
Ãwsds
 = 
	`aùiveDeäagSds
(
sd£Ë
)))

375 
deäagged
++, 
de
->
key
 = 
Ãwsds
;

376 
ÃwscÜe
 = 
	`z¦Deäag
(
zs
->
z¦
, *(*)
	`diùG‘V®
(
de
), 
sd£Ë
, 
Ãwsds
);

377 ià(
ÃwscÜe
) {

378 
	`diùS‘V®
(
d
, 
de
, 
ÃwscÜe
);

379 
deäagged
++;

381 
deäagged
 +ğ
	`diùI‹rDeäagEÁry
(
di
);

383 
	`diùR–—£I‹¿tÜ
(
di
);

384 
	`diùDeäagTabËs
(&
zs
->
diù
);

386 
	`£rv”Pªic
("Unknown sorted setƒncoding");

388 } ià(
ob
->
ty³
 =ğ
OBJ_HASH
) {

389 ià(
ob
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

390 ià((
Ãwzl
 = 
	`aùiveDeäagAÎoc
(
ob
->
±r
)))

391 
deäagged
++, 
ob
->
±r
 = 
Ãwzl
;

392 } ià(
ob
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

393 
d
 = 
ob
->
±r
;

394 
di
 = 
	`diùG‘I‹¿tÜ
(
d
);

395 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

396 
sds
 
sd£Ë
 = 
	`diùG‘Key
(
de
);

397 ià((
Ãwsds
 = 
	`aùiveDeäagSds
(
sd£Ë
)))

398 
deäagged
++, 
de
->
key
 = 
Ãwsds
;

399 
sd£Ë
 = 
	`diùG‘V®
(
de
);

400 ià((
Ãwsds
 = 
	`aùiveDeäagSds
(
sd£Ë
)))

401 
deäagged
++, 
de
->
v
.
v®
 = 
Ãwsds
;

402 
deäagged
 +ğ
	`diùI‹rDeäagEÁry
(
di
);

404 
	`diùR–—£I‹¿tÜ
(
di
);

405 
	`diùDeäagTabËs
((
diù
**)&
ob
->
±r
);

407 
	`£rv”Pªic
("Unknown hashƒncoding");

409 } ià(
ob
->
ty³
 =ğ
OBJ_MODULE
) {

413 
	`£rv”Pªic
("Unknown objectype");

415  
deäagged
;

416 
	}
}

419 
	$deäagSÿnC®lback
(*
´ivd©a
, cÚ¡ 
diùEÁry
 *
de
) {

420 
deäagged
 = 
	`deäagKey
((
»disDb
*)
´ivd©a
, (
diùEÁry
*)
de
);

421 
£rv”
.
¡©_aùive_deäag_h™s
 +ğ
deäagged
;

422 if(
deäagged
)

423 
£rv”
.
¡©_aùive_deäag_key_h™s
++;

425 
£rv”
.
¡©_aùive_deäag_key_mis£s
++;

426 
	}
}

430 
	$deäagDiùBuck‘C®lback
(*
´ivd©a
, 
diùEÁry
 **
buck‘»f
) {

431 
	`UNUSED
(
´ivd©a
);

432 *
buck‘»f
) {

433 
diùEÁry
 *
de
 = *
buck‘»f
, *
Ãwde
;

434 ià((
Ãwde
 = 
	`aùiveDeäagAÎoc
(
de
))) {

435 *
buck‘»f
 = 
Ãwde
;

437 
buck‘»f
 = &(*buck‘»f)->
Ãxt
;

439 
	}
}

447 
	$g‘AÎoÿtÜF¿gm’tiÚ
(
size_t
 *
out_äag_by‹s
) {

448 
size_t
 
•och
 = 1, 
®loÿ‹d
 = 0, 
»sid’t
 = 0, 
aùive
 = 0, 
sz
 = (size_t);

450 
	`je_m®lùl
("•och", &
•och
, &
sz
, &epoch, sz);

453 
	`je_m®lùl
("¡©s.»sid’t", &
»sid’t
, &
sz
, 
NULL
, 0);

456 
	`je_m®lùl
("¡©s.aùive", &
aùive
, &
sz
, 
NULL
, 0);

459 
	`je_m®lùl
("¡©s.®loÿ‹d", &
®loÿ‹d
, &
sz
, 
NULL
, 0);

460 
äag_pù
 = (()
aùive
 / 
®loÿ‹d
)*100 - 100;

461 
size_t
 
äag_by‹s
 = 
aùive
 - 
®loÿ‹d
;

462 
rss_pù
 = (()
»sid’t
 / 
®loÿ‹d
)*100 - 100;

463 
size_t
 
rss_by‹s
 = 
»sid’t
 - 
®loÿ‹d
;

464 if(
out_äag_by‹s
)

465 *
out_äag_by‹s
 = 
äag_by‹s
;

466 
	`£rv”Log
(
LL_DEBUG
,

468 
®loÿ‹d
, 
aùive
, 
»sid’t
, 
äag_pù
, 
rss_pù
, 
äag_by‹s
, 
rss_by‹s
);

469  
äag_pù
;

470 
	}
}

472 
	#INTERPOLATE
(
x
, 
x1
, 
x2
, 
y1
, 
y2
èĞ(y1è+ ((x)-(x1)è* ((y2)-(y1)è/ ((x2)-(x1)è)

	)

473 
	#LIMIT
(
y
, 
mš
, 
max
è((y)<(mš)? mš: ((y)>(max)? max: (y)))

	)

478 
	$aùiveDeäagCyşe
() {

479 
cu¼’t_db
 = -1;

480 
cursÜ
 = 0;

481 
»disDb
 *
db
 = 
NULL
;

482 
¡¬t_sÿn
, 
¡¬t_¡©
;

483 
™”©iÚs
 = 0;

484 
deäagged
 = 
£rv”
.
¡©_aùive_deäag_h™s
;

485 
¡¬t
, 
tim–im™
;

487 ià(
£rv”
.
aof_chd_pid
!=-1 || s”v”.
rdb_chd_pid
!=-1)

492 
	`run_w™h_³riod
(1000) {

493 
size_t
 
äag_by‹s
;

494 
äag_pù
 = 
	`g‘AÎoÿtÜF¿gm’tiÚ
(&
äag_by‹s
);

496 ià(!
£rv”
.
aùive_deäag_ruÂšg
) {

497 if(
äag_pù
 < 
£rv”
.
aùive_deäag_th»shŞd_low”
 || 
äag_by‹s
 < s”v”.
aùive_deäag_ignÜe_by‹s
)

502 
ıu_pù
 = 
	`INTERPOLATE
(
äag_pù
,

503 
£rv”
.
aùive_deäag_th»shŞd_low”
,

504 
£rv”
.
aùive_deäag_th»shŞd_uµ”
,

505 
£rv”
.
aùive_deäag_cyşe_mš
,

506 
£rv”
.
aùive_deäag_cyşe_max
);

507 
ıu_pù
 = 
	`LIMIT
(cpu_pct,

508 
£rv”
.
aùive_deäag_cyşe_mš
,

509 
£rv”
.
aùive_deäag_cyşe_max
);

512 ià(!
£rv”
.
aùive_deäag_ruÂšg
 ||

513 
ıu_pù
 > 
£rv”
.
aùive_deäag_ruÂšg
)

515 
£rv”
.
aùive_deäag_ruÂšg
 = 
ıu_pù
;

516 
	`£rv”Log
(
LL_VERBOSE
,

518 
äag_pù
, 
äag_by‹s
, 
ıu_pù
);

521 ià(!
£rv”
.
aùive_deäag_ruÂšg
)

525 
¡¬t
 = 
	`u¡ime
();

526 
tim–im™
 = 1000000*
£rv”
.
aùive_deäag_ruÂšg
/£rv”.
hz
/100;

527 ià(
tim–im™
 <= 0)imelimit = 1;

530 ià(!
cursÜ
) {

532 ià(++
cu¼’t_db
 >ğ
£rv”
.
dbnum
) {

533 
now
 = 
	`u¡ime
();

534 
size_t
 
äag_by‹s
;

535 
äag_pù
 = 
	`g‘AÎoÿtÜF¿gm’tiÚ
(&
äag_by‹s
);

536 
	`£rv”Log
(
LL_VERBOSE
,

538 ()((
now
 - 
¡¬t_sÿn
)/1000), ()(
£rv”
.
¡©_aùive_deäag_h™s
 - 
¡¬t_¡©
), 
äag_pù
, 
äag_by‹s
);

540 
¡¬t_sÿn
 = 
now
;

541 
cu¼’t_db
 = -1;

542 
cursÜ
 = 0;

543 
db
 = 
NULL
;

544 
£rv”
.
aùive_deäag_ruÂšg
 = 0;

547 ià(
cu¼’t_db
==0) {

549 
¡¬t_sÿn
 = 
	`u¡ime
();

550 
¡¬t_¡©
 = 
£rv”
.
¡©_aùive_deäag_h™s
;

553 
db
 = &
£rv”
.db[
cu¼’t_db
];

554 
cursÜ
 = 0;

558 
cursÜ
 = 
	`diùSÿn
(
db
->
diù
, cursÜ, 
deäagSÿnC®lback
, 
deäagDiùBuck‘C®lback
, db);

562 ià(
cursÜ
 && (++
™”©iÚs
 > 16 || 
£rv”
.
¡©_aùive_deäag_h™s
 - 
deäagged
 > 1000)) {

563 ià((
	`u¡ime
(è- 
¡¬t
è> 
tim–im™
) {

566 
™”©iÚs
 = 0;

567 
deäagged
 = 
£rv”
.
¡©_aùive_deäag_h™s
;

569 } 
cursÜ
);

571 
	}
}

575 
	$aùiveDeäagCyşe
() {

577 
	}
}

	@dict.c

36 
	~"fmaüos.h
"

38 
	~<¡dio.h
>

39 
	~<¡dlib.h
>

40 
	~<¡dšt.h
>

41 
	~<¡ršg.h
>

42 
	~<¡d¬g.h
>

43 
	~<lim™s.h
>

44 
	~<sys/time.h
>

46 
	~"diù.h
"

47 
	~"zm®loc.h
"

48 #iâdeà
DICT_BENCHMARK_MAIN


49 
	~"»di§s£¹.h
"

51 
	~<as£¹.h
>

62 
	gdiù_ÿn_»size
 = 1;

63 
	gdiù_fÜû_»size_¿tio
 = 5;

67 
_diùEx·ndIfN“ded
(
diù
 *
ht
);

68 
_diùNextPow”
(
size
);

69 
_diùKeyIndex
(
diù
 *
ht
, cÚ¡ *
key
, 
hash
, 
diùEÁry
 **
exi¡šg
);

70 
_diùIn™
(
diù
 *
ht
, 
diùTy³
 *
ty³
, *
´ivD©aPŒ
);

74 
ušt8_t
 
	gdiù_hash_funùiÚ_£ed
[16];

76 
	$diùS‘HashFunùiÚS“d
(
ušt8_t
 *
£ed
) {

77 
	`memıy
(
diù_hash_funùiÚ_£ed
,
£ed
,(dict_hash_function_seed));

78 
	}
}

80 
ušt8_t
 *
	$diùG‘HashFunùiÚS“d
() {

81  
diù_hash_funùiÚ_£ed
;

82 
	}
}

87 
ušt64_t
 
shash
(cÚ¡ 
ušt8_t
 *
š
, cÚ¡ 
size_t
 
šËn
, cÚ¡ ušt8_ˆ*
k
);

88 
ušt64_t
 
shash_noÿ£
(cÚ¡ 
ušt8_t
 *
š
, cÚ¡ 
size_t
 
šËn
, cÚ¡ ušt8_ˆ*
k
);

90 
ušt64_t
 
	$diùG’HashFunùiÚ
(cÚ¡ *
key
, 
Ën
) {

91  
	`shash
(
key
,
Ën
,
diù_hash_funùiÚ_£ed
);

92 
	}
}

94 
ušt64_t
 
	$diùG’Ca£HashFunùiÚ
(cÚ¡ *
buf
, 
Ën
) {

95  
	`shash_noÿ£
(
buf
,
Ën
,
diù_hash_funùiÚ_£ed
);

96 
	}
}

102 
	$_diùRe£t
(
diùht
 *
ht
)

104 
ht
->
bË
 = 
NULL
;

105 
ht
->
size
 = 0;

106 
ht
->
sizemask
 = 0;

107 
ht
->
u£d
 = 0;

108 
	}
}

111 
diù
 *
	$diùC»©e
(
diùTy³
 *
ty³
,

112 *
´ivD©aPŒ
)

114 
diù
 *
d
 = 
	`zm®loc
((*d));

116 
	`_diùIn™
(
d
,
ty³
,
´ivD©aPŒ
);

117  
d
;

118 
	}
}

121 
	$_diùIn™
(
diù
 *
d
, 
diùTy³
 *
ty³
,

122 *
´ivD©aPŒ
)

124 
	`_diùRe£t
(&
d
->
ht
[0]);

125 
	`_diùRe£t
(&
d
->
ht
[1]);

126 
d
->
ty³
 =ype;

127 
d
->
´ivd©a
 = 
´ivD©aPŒ
;

128 
d
->
»hashidx
 = -1;

129 
d
->
™”©Üs
 = 0;

130  
DICT_OK
;

131 
	}
}

135 
	$diùResize
(
diù
 *
d
)

137 
mšim®
;

139 ià(!
diù_ÿn_»size
 || 
	`diùIsRehashšg
(
d
)è 
DICT_ERR
;

140 
mšim®
 = 
d
->
ht
[0].
u£d
;

141 ià(
mšim®
 < 
DICT_HT_INITIAL_SIZE
)

142 
mšim®
 = 
DICT_HT_INITIAL_SIZE
;

143  
	`diùEx·nd
(
d
, 
mšim®
);

144 
	}
}

147 
	$diùEx·nd
(
diù
 *
d
, 
size
)

149 
diùht
 
n
;

150 
»®size
 = 
	`_diùNextPow”
(
size
);

154 ià(
	`diùIsRehashšg
(
d
è|| d->
ht
[0].
u£d
 > 
size
)

155  
DICT_ERR
;

158 ià(
»®size
 =ğ
d
->
ht
[0].
size
è 
DICT_ERR
;

161 
n
.
size
 = 
»®size
;

162 
n
.
sizemask
 = 
»®size
-1;

163 
n
.
bË
 = 
	`zÿÎoc
(
»®size
*(
diùEÁry
*));

164 
n
.
u£d
 = 0;

168 ià(
d
->
ht
[0].
bË
 =ğ
NULL
) {

169 
d
->
ht
[0] = 
n
;

170  
DICT_OK
;

174 
d
->
ht
[1] = 
n
;

175 
d
->
»hashidx
 = 0;

176  
DICT_OK
;

177 
	}
}

188 
	$diùRehash
(
diù
 *
d
, 
n
) {

189 
em±y_vis™s
 = 
n
*10;

190 ià(!
	`diùIsRehashšg
(
d
))  0;

192 
n
-- && 
d
->
ht
[0].
u£d
 != 0) {

193 
diùEÁry
 *
de
, *
Ãxtde
;

197 
	`as£¹
(
d
->
ht
[0].
size
 > ()d->
»hashidx
);

198 
d
->
ht
[0].
bË
[d->
»hashidx
] =ğ
NULL
) {

199 
d
->
»hashidx
++;

200 ià(--
em±y_vis™s
 == 0)  1;

202 
de
 = 
d
->
ht
[0].
bË
[d->
»hashidx
];

204 
de
) {

205 
h
;

207 
Ãxtde
 = 
de
->
Ãxt
;

209 
h
 = 
	`diùHashKey
(
d
, 
de
->
key
è& d->
ht
[1].
sizemask
;

210 
de
->
Ãxt
 = 
d
->
ht
[1].
bË
[
h
];

211 
d
->
ht
[1].
bË
[
h
] = 
de
;

212 
d
->
ht
[0].
u£d
--;

213 
d
->
ht
[1].
u£d
++;

214 
de
 = 
Ãxtde
;

216 
d
->
ht
[0].
bË
[d->
»hashidx
] = 
NULL
;

217 
d
->
»hashidx
++;

221 ià(
d
->
ht
[0].
u£d
 == 0) {

222 
	`zä“
(
d
->
ht
[0].
bË
);

223 
d
->
ht
[0] = d->ht[1];

224 
	`_diùRe£t
(&
d
->
ht
[1]);

225 
d
->
»hashidx
 = -1;

231 
	}
}

233 
	$timeInMli£cÚds
() {

234 
timev®
 
tv
;

236 
	`g‘timeofday
(&
tv
,
NULL
);

237  ((()
tv
.
tv_£c
)*1000)+Ñv.
tv_u£c
/1000);

238 
	}
}

241 
	$diùRehashMli£cÚds
(
diù
 *
d
, 
ms
) {

242 
¡¬t
 = 
	`timeInMli£cÚds
();

243 
»hashes
 = 0;

245 
	`diùRehash
(
d
,100)) {

246 
»hashes
 += 100;

247 ià(
	`timeInMli£cÚds
()-
¡¬t
 > 
ms
) ;

249  
»hashes
;

250 
	}
}

260 
	$_diùRehashS‹p
(
diù
 *
d
) {

261 ià(
d
->
™”©Üs
 =ğ0è
	`diùRehash
(d,1);

262 
	}
}

265 
	$diùAdd
(
diù
 *
d
, *
key
, *
v®
)

267 
diùEÁry
 *
’Œy
 = 
	`diùAddRaw
(
d
,
key
,
NULL
);

269 ià(!
’Œy
è 
DICT_ERR
;

270 
	`diùS‘V®
(
d
, 
’Œy
, 
v®
);

271  
DICT_OK
;

272 
	}
}

292 
diùEÁry
 *
	$diùAddRaw
(
diù
 *
d
, *
key
, 
diùEÁry
 **
exi¡šg
)

294 
šdex
;

295 
diùEÁry
 *
’Œy
;

296 
diùht
 *
ht
;

298 ià(
	`diùIsRehashšg
(
d
)è
	`_diùRehashS‹p
(d);

302 ià((
šdex
 = 
	`_diùKeyIndex
(
d
, 
key
, 
	`diùHashKey
(d,key), 
exi¡šg
)) == -1)

303  
NULL
;

309 
ht
 = 
	`diùIsRehashšg
(
d
) ? &d->ht[1] : &d->ht[0];

310 
’Œy
 = 
	`zm®loc
((*entry));

311 
’Œy
->
Ãxt
 = 
ht
->
bË
[
šdex
];

312 
ht
->
bË
[
šdex
] = 
’Œy
;

313 
ht
->
u£d
++;

316 
	`diùS‘Key
(
d
, 
’Œy
, 
key
);

317  
’Œy
;

318 
	}
}

325 
	$diùR•Ïû
(
diù
 *
d
, *
key
, *
v®
)

327 
diùEÁry
 *
’Œy
, *
exi¡šg
, 
aux’Œy
;

331 
’Œy
 = 
	`diùAddRaw
(
d
,
key
,&
exi¡šg
);

332 ià(
’Œy
) {

333 
	`diùS‘V®
(
d
, 
’Œy
, 
v®
);

342 
aux’Œy
 = *
exi¡šg
;

343 
	`diùS‘V®
(
d
, 
exi¡šg
, 
v®
);

344 
	`diùF»eV®
(
d
, &
aux’Œy
);

346 
	}
}

355 
diùEÁry
 *
	$diùAddOrFšd
(
diù
 *
d
, *
key
) {

356 
diùEÁry
 *
’Œy
, *
exi¡šg
;

357 
’Œy
 = 
	`diùAddRaw
(
d
,
key
,&
exi¡šg
);

358  
’Œy
 ?ƒÁry : 
exi¡šg
;

359 
	}
}

364 
diùEÁry
 *
	$diùG’”icD–‘e
(
diù
 *
d
, cÚ¡ *
key
, 
noä“
) {

365 
h
, 
idx
;

366 
diùEÁry
 *
he
, *
´evHe
;

367 
bË
;

369 ià(
d
->
ht
[0].
u£d
 =ğ0 && d->ht[1].u£d =ğ0è 
NULL
;

371 ià(
	`diùIsRehashšg
(
d
)è
	`_diùRehashS‹p
(d);

372 
h
 = 
	`diùHashKey
(
d
, 
key
);

374 
bË
 = 0;able <= 1;able++) {

375 
idx
 = 
h
 & 
d
->
ht
[
bË
].
sizemask
;

376 
he
 = 
d
->
ht
[
bË
].bË[
idx
];

377 
´evHe
 = 
NULL
;

378 
he
) {

379 ià(
key
==
he
->key || 
	`diùCom·»Keys
(
d
, key, he->key)) {

381 ià(
´evHe
)

382 
´evHe
->
Ãxt
 = 
he
->next;

384 
d
->
ht
[
bË
].bË[
idx
] = 
he
->
Ãxt
;

385 ià(!
noä“
) {

386 
	`diùF»eKey
(
d
, 
he
);

387 
	`diùF»eV®
(
d
, 
he
);

388 
	`zä“
(
he
);

390 
d
->
ht
[
bË
].
u£d
--;

391  
he
;

393 
´evHe
 = 
he
;

394 
he
 = he->
Ãxt
;

396 ià(!
	`diùIsRehashšg
(
d
)) ;

398  
NULL
;

399 
	}
}

403 
	$diùD–‘e
(
diù
 *
ht
, cÚ¡ *
key
) {

404  
	`diùG’”icD–‘e
(
ht
,
key
,0è? 
DICT_OK
 : 
DICT_ERR
;

405 
	}
}

428 
diùEÁry
 *
	$diùUÆšk
(
diù
 *
ht
, cÚ¡ *
key
) {

429  
	`diùG’”icD–‘e
(
ht
,
key
,1);

430 
	}
}

434 
	$diùF»eUÆškedEÁry
(
diù
 *
d
, 
diùEÁry
 *
he
) {

435 ià(
he
 =ğ
NULL
) ;

436 
	`diùF»eKey
(
d
, 
he
);

437 
	`diùF»eV®
(
d
, 
he
);

438 
	`zä“
(
he
);

439 
	}
}

442 
_diùCË¬
(
diù
 *
d
, 
diùht
 *
ht
, (
ÿÎback
)(*)) {

443 
i
;

446 
i
 = 0; i < 
ht
->
size
 && ht->
u£d
 > 0; i++) {

447 
diùEÁry
 *
he
, *
ÃxtHe
;

449 ià(
ÿÎback
 && (
i
 & 65535è=ğ0è
	`ÿÎback
(
d
->
´ivd©a
);

451 ià((
he
 = 
ht
->
bË
[
i
]è=ğ
NULL
) ;

452 
he
) {

453 
ÃxtHe
 = 
he
->
Ãxt
;

454 
	`diùF»eKey
(
d
, 
he
);

455 
	`diùF»eV®
(
d
, 
he
);

456 
	`zä“
(
he
);

457 
ht
->
u£d
--;

458 
he
 = 
ÃxtHe
;

462 
	`zä“
(
ht
->
bË
);

464 
	`_diùRe£t
(
ht
);

465  
DICT_OK
;

466 
	}
}

469 
	$diùR–—£
(
diù
 *
d
)

471 
	`_diùCË¬
(
d
,&d->
ht
[0],
NULL
);

472 
	`_diùCË¬
(
d
,&d->
ht
[1],
NULL
);

473 
	`zä“
(
d
);

474 
	}
}

476 
diùEÁry
 *
	$diùFšd
(
diù
 *
d
, cÚ¡ *
key
)

478 
diùEÁry
 *
he
;

479 
h
, 
idx
, 
bË
;

481 ià(
d
->
ht
[0].
u£d
 + d->ht[1].u£d =ğ0è 
NULL
;

482 ià(
	`diùIsRehashšg
(
d
)è
	`_diùRehashS‹p
(d);

483 
h
 = 
	`diùHashKey
(
d
, 
key
);

484 
bË
 = 0;able <= 1;able++) {

485 
idx
 = 
h
 & 
d
->
ht
[
bË
].
sizemask
;

486 
he
 = 
d
->
ht
[
bË
].bË[
idx
];

487 
he
) {

488 ià(
key
==
he
->key || 
	`diùCom·»Keys
(
d
, key, he->key))

489  
he
;

490 
he
 = he->
Ãxt
;

492 ià(!
	`diùIsRehashšg
(
d
)è 
NULL
;

494  
NULL
;

495 
	}
}

497 *
	$diùF‘chV®ue
(
diù
 *
d
, cÚ¡ *
key
) {

498 
diùEÁry
 *
he
;

500 
he
 = 
	`diùFšd
(
d
,
key
);

501  
he
 ? 
	`diùG‘V®
(heè: 
NULL
;

502 
	}
}

510 
	$diùFšg”´št
(
diù
 *
d
) {

511 
š‹g”s
[6], 
hash
 = 0;

512 
j
;

514 
š‹g”s
[0] = (è
d
->
ht
[0].
bË
;

515 
š‹g”s
[1] = 
d
->
ht
[0].
size
;

516 
š‹g”s
[2] = 
d
->
ht
[0].
u£d
;

517 
š‹g”s
[3] = (è
d
->
ht
[1].
bË
;

518 
š‹g”s
[4] = 
d
->
ht
[1].
size
;

519 
š‹g”s
[5] = 
d
->
ht
[1].
u£d
;

528 
j
 = 0; j < 6; j++) {

529 
hash
 +ğ
š‹g”s
[
j
];

531 
hash
 = (~hash) + (hash << 21);

532 
hash
 = hash ^ (hash >> 24);

533 
hash
 = (hash + (hash << 3)) + (hash << 8);

534 
hash
 = hash ^ (hash >> 14);

535 
hash
 = (hash + (hash << 2)) + (hash << 4);

536 
hash
 = hash ^ (hash >> 28);

537 
hash
 = hash + (hash << 31);

539  
hash
;

540 
	}
}

542 
diùI‹¿tÜ
 *
	$diùG‘I‹¿tÜ
(
diù
 *
d
)

544 
diùI‹¿tÜ
 *
™”
 = 
	`zm®loc
((*iter));

546 
™”
->
d
 = d;

547 
™”
->
bË
 = 0;

548 
™”
->
šdex
 = -1;

549 
™”
->
§ã
 = 0;

550 
™”
->
’Œy
 = 
NULL
;

551 
™”
->
ÃxtEÁry
 = 
NULL
;

552  
™”
;

553 
	}
}

555 
diùI‹¿tÜ
 *
	$diùG‘SaãI‹¿tÜ
(
diù
 *
d
) {

556 
diùI‹¿tÜ
 *
i
 = 
	`diùG‘I‹¿tÜ
(
d
);

558 
i
->
§ã
 = 1;

559  
i
;

560 
	}
}

562 
diùEÁry
 *
	$diùNext
(
diùI‹¿tÜ
 *
™”
)

565 ià(
™”
->
’Œy
 =ğ
NULL
) {

566 
diùht
 *
ht
 = &
™”
->
d
->ht[™”->
bË
];

567 ià(
™”
->
šdex
 =ğ-1 && i‹r->
bË
 == 0) {

568 ià(
™”
->
§ã
)

569 
™”
->
d
->
™”©Üs
++;

571 
™”
->
fšg”´št
 = 
	`diùFšg”´št
(™”->
d
);

573 
™”
->
šdex
++;

574 ià(
™”
->
šdex
 >ğ(è
ht
->
size
) {

575 ià(
	`diùIsRehashšg
(
™”
->
d
è&& i‹r->
bË
 == 0) {

576 
™”
->
bË
++;

577 
™”
->
šdex
 = 0;

578 
ht
 = &
™”
->
d
->ht[1];

583 
™”
->
’Œy
 = 
ht
->
bË
[™”->
šdex
];

585 
™”
->
’Œy
 = i‹r->
ÃxtEÁry
;

587 ià(
™”
->
’Œy
) {

590 
™”
->
ÃxtEÁry
 = i‹r->
’Œy
->
Ãxt
;

591  
™”
->
’Œy
;

594  
NULL
;

595 
	}
}

597 
	$diùR–—£I‹¿tÜ
(
diùI‹¿tÜ
 *
™”
)

599 ià(!(
™”
->
šdex
 =ğ-1 && i‹r->
bË
 == 0)) {

600 ià(
™”
->
§ã
)

601 
™”
->
d
->
™”©Üs
--;

603 
	`as£¹
(
™”
->
fšg”´št
 =ğ
	`diùFšg”´št
(™”->
d
));

605 
	`zä“
(
™”
);

606 
	}
}

610 
diùEÁry
 *
	$diùG‘RªdomKey
(
diù
 *
d
)

612 
diùEÁry
 *
he
, *
Üighe
;

613 
h
;

614 
li¡Ën
, 
li¡–e
;

616 ià(
	`diùSize
(
d
è=ğ0è 
NULL
;

617 ià(
	`diùIsRehashšg
(
d
)è
	`_diùRehashS‹p
(d);

618 ià(
	`diùIsRehashšg
(
d
)) {

622 
h
 = 
d
->
»hashidx
 + (
	`¿ndom
(è% (d->
ht
[0].
size
 +

623 
d
->
ht
[1].
size
 -

624 
d
->
»hashidx
));

625 
he
 = (
h
 >ğ
d
->
ht
[0].
size
è? d->ht[1].
bË
[h - d->ht[0].size] :

626 
d
->
ht
[0].
bË
[
h
];

627 } 
he
 =ğ
NULL
);

630 
h
 = 
	`¿ndom
(è& 
d
->
ht
[0].
sizemask
;

631 
he
 = 
d
->
ht
[0].
bË
[
h
];

632 } 
he
 =ğ
NULL
);

639 
li¡Ën
 = 0;

640 
Üighe
 = 
he
;

641 
he
) {

642 
he
 = he->
Ãxt
;

643 
li¡Ën
++;

645 
li¡–e
 = 
	`¿ndom
(è% 
li¡Ën
;

646 
he
 = 
Üighe
;

647 
li¡–e
--è
he
 = he->
Ãxt
;

648  
he
;

649 
	}
}

673 
	$diùG‘SomeKeys
(
diù
 *
d
, 
diùEÁry
 **
des
, 
couÁ
) {

674 
j
;

675 
bËs
;

676 
¡Üed
 = 0, 
maxsizemask
;

677 
max¡•s
;

679 ià(
	`diùSize
(
d
è< 
couÁ
) count = dictSize(d);

680 
max¡•s
 = 
couÁ
*10;

683 
j
 = 0; j < 
couÁ
; j++) {

684 ià(
	`diùIsRehashšg
(
d
))

685 
	`_diùRehashS‹p
(
d
);

690 
bËs
 = 
	`diùIsRehashšg
(
d
) ? 2 : 1;

691 
maxsizemask
 = 
d
->
ht
[0].
sizemask
;

692 ià(
bËs
 > 1 && 
maxsizemask
 < 
d
->
ht
[1].
sizemask
)

693 
maxsizemask
 = 
d
->
ht
[1].
sizemask
;

696 
i
 = 
	`¿ndom
(è& 
maxsizemask
;

697 
em±yËn
 = 0;

698 
¡Üed
 < 
couÁ
 && 
max¡•s
--) {

699 
j
 = 0; j < 
bËs
; j++) {

703 ià(
bËs
 =ğ2 && 
j
 =ğ0 && 
i
 < (è
d
->
»hashidx
) {

708 ià(
i
 >ğ
d
->
ht
[1].
size
è˜ğd->
»hashidx
;

711 ià(
i
 >ğ
d
->
ht
[
j
].
size
) ;

712 
diùEÁry
 *
he
 = 
d
->
ht
[
j
].
bË
[
i
];

716 ià(
he
 =ğ
NULL
) {

717 
em±yËn
++;

718 ià(
em±yËn
 >ğ5 &&ƒm±yËÀ> 
couÁ
) {

719 
i
 = 
	`¿ndom
(è& 
maxsizemask
;

720 
em±yËn
 = 0;

723 
em±yËn
 = 0;

724 
he
) {

727 *
des
 = 
he
;

728 
des
++;

729 
he
 = he->
Ãxt
;

730 
¡Üed
++;

731 ià(
¡Üed
 =ğ
couÁ
)  stored;

735 
i
 = (i+1è& 
maxsizemask
;

737  
¡Üed
;

738 
	}
}

742 
	$»v
(
v
) {

743 
s
 = 8 * (
v
);

744 
mask
 = ~0;

745 (
s
 >>= 1) > 0) {

746 
mask
 ^ğ(mask << 
s
);

747 
v
 = ((v >> 
s
è& 
mask
) | ((v << s) & ~mask);

749  
v
;

750 
	}
}

836 
	$diùSÿn
(
diù
 *
d
,

837 
v
,

838 
diùSÿnFunùiÚ
 *
â
,

839 
diùSÿnBuck‘FunùiÚ
* 
buck‘â
,

840 *
´ivd©a
)

842 
diùht
 *
t0
, *
t1
;

843 cÚ¡ 
diùEÁry
 *
de
, *
Ãxt
;

844 
m0
, 
m1
;

846 ià(
	`diùSize
(
d
) == 0)  0;

848 ià(!
	`diùIsRehashšg
(
d
)) {

849 
t0
 = &(
d
->
ht
[0]);

850 
m0
 = 
t0
->
sizemask
;

853 ià(
buck‘â
è
	`buck‘â
(
´ivd©a
, &
t0
->
bË
[
v
 & 
m0
]);

854 
de
 = 
t0
->
bË
[
v
 & 
m0
];

855 
de
) {

856 
Ãxt
 = 
de
->next;

857 
	`â
(
´ivd©a
, 
de
);

858 
de
 = 
Ãxt
;

862 
t0
 = &
d
->
ht
[0];

863 
t1
 = &
d
->
ht
[1];

866 ià(
t0
->
size
 > 
t1
->size) {

867 
t0
 = &
d
->
ht
[1];

868 
t1
 = &
d
->
ht
[0];

871 
m0
 = 
t0
->
sizemask
;

872 
m1
 = 
t1
->
sizemask
;

875 ià(
buck‘â
è
	`buck‘â
(
´ivd©a
, &
t0
->
bË
[
v
 & 
m0
]);

876 
de
 = 
t0
->
bË
[
v
 & 
m0
];

877 
de
) {

878 
Ãxt
 = 
de
->next;

879 
	`â
(
´ivd©a
, 
de
);

880 
de
 = 
Ãxt
;

887 ià(
buck‘â
è
	`buck‘â
(
´ivd©a
, &
t1
->
bË
[
v
 & 
m1
]);

888 
de
 = 
t1
->
bË
[
v
 & 
m1
];

889 
de
) {

890 
Ãxt
 = 
de
->next;

891 
	`â
(
´ivd©a
, 
de
);

892 
de
 = 
Ãxt
;

896 
v
 = (((v | 
m0
) + 1) & ~m0) | (v & m0);

899 } 
v
 & (
m0
 ^ 
m1
));

904 
v
 |ğ~
m0
;

907 
v
 = 
	`»v
(v);

908 
v
++;

909 
v
 = 
	`»v
(v);

911  
v
;

912 
	}
}

917 
	$_diùEx·ndIfN“ded
(
diù
 *
d
)

920 ià(
	`diùIsRehashšg
(
d
)è 
DICT_OK
;

923 ià(
d
->
ht
[0].
size
 =ğ0è 
	`diùEx·nd
(d, 
DICT_HT_INITIAL_SIZE
);

929 ià(
d
->
ht
[0].
u£d
 >ğd->ht[0].
size
 &&

930 (
diù_ÿn_»size
 ||

931 
d
->
ht
[0].
u£d
/d->ht[0].
size
 > 
diù_fÜû_»size_¿tio
))

933  
	`diùEx·nd
(
d
, d->
ht
[0].
u£d
*2);

935  
DICT_OK
;

936 
	}
}

939 
	$_diùNextPow”
(
size
)

941 
i
 = 
DICT_HT_INITIAL_SIZE
;

943 ià(
size
 >ğ
LONG_MAX
)  LONG_MAX;

945 ià(
i
 >ğ
size
)

946  
i
;

947 
i
 *= 2;

949 
	}
}

958 
	$_diùKeyIndex
(
diù
 *
d
, cÚ¡ *
key
, 
hash
, 
diùEÁry
 **
exi¡šg
)

960 
idx
, 
bË
;

961 
diùEÁry
 *
he
;

962 ià(
exi¡šg
è*exi¡šg = 
NULL
;

965 ià(
	`_diùEx·ndIfN“ded
(
d
è=ğ
DICT_ERR
)

967 
bË
 = 0;able <= 1;able++) {

968 
idx
 = 
hash
 & 
d
->
ht
[
bË
].
sizemask
;

970 
he
 = 
d
->
ht
[
bË
].bË[
idx
];

971 
he
) {

972 ià(
key
==
he
->key || 
	`diùCom·»Keys
(
d
, key, he->key)) {

973 ià(
exi¡šg
è*exi¡šg = 
he
;

976 
he
 = he->
Ãxt
;

978 ià(!
	`diùIsRehashšg
(
d
)) ;

980  
idx
;

981 
	}
}

983 
diùEm±y
(
diù
 *
d
, (
ÿÎback
)(*)) {

984 
	`_diùCË¬
(
d
,&d->
ht
[0],
ÿÎback
);

985 
	`_diùCË¬
(
d
,&d->
ht
[1],
ÿÎback
);

986 
d
->
»hashidx
 = -1;

987 
d
->
™”©Üs
 = 0;

988 
	}
}

990 
	$diùEÇbËResize
() {

991 
diù_ÿn_»size
 = 1;

992 
	}
}

994 
	$diùDi§bËResize
() {

995 
diù_ÿn_»size
 = 0;

996 
	}
}

998 
	$diùG‘Hash
(
diù
 *
d
, cÚ¡ *
key
) {

999  
	`diùHashKey
(
d
, 
key
);

1000 
	}
}

1007 
diùEÁry
 **
	$diùFšdEÁryRefByPŒAndHash
(
diù
 *
d
, cÚ¡ *
Şd±r
, 
hash
) {

1008 
diùEÁry
 *
he
, **
h”ef
;

1009 
idx
, 
bË
;

1011 ià(
d
->
ht
[0].
u£d
 + d->ht[1].u£d =ğ0è 
NULL
;

1012 
bË
 = 0;able <= 1;able++) {

1013 
idx
 = 
hash
 & 
d
->
ht
[
bË
].
sizemask
;

1014 
h”ef
 = &
d
->
ht
[
bË
].bË[
idx
];

1015 
he
 = *
h”ef
;

1016 
he
) {

1017 ià(
Şd±r
==
he
->
key
)

1018  
h”ef
;

1019 
h”ef
 = &
he
->
Ãxt
;

1020 
he
 = *
h”ef
;

1022 ià(!
	`diùIsRehashšg
(
d
)è 
NULL
;

1024  
NULL
;

1025 
	}
}

1029 
	#DICT_STATS_VECTLEN
 50

	)

1030 
size_t
 
	$_diùG‘StsHt
(*
buf
, 
size_t
 
bufsize
, 
diùht
 *
ht
, 
bËid
) {

1031 
i
, 
¦Ùs
 = 0, 
chašËn
, 
maxchašËn
 = 0;

1032 
tÙchašËn
 = 0;

1033 
şveùÜ
[
DICT_STATS_VECTLEN
];

1034 
size_t
 
l
 = 0;

1036 ià(
ht
->
u£d
 == 0) {

1037  
	`¢´štf
(
buf
,
bufsize
,

1042 
i
 = 0; i < 
DICT_STATS_VECTLEN
; i++è
şveùÜ
[i] = 0;

1043 
i
 = 0; i < 
ht
->
size
; i++) {

1044 
diùEÁry
 *
he
;

1046 ià(
ht
->
bË
[
i
] =ğ
NULL
) {

1047 
şveùÜ
[0]++;

1050 
¦Ùs
++;

1052 
chašËn
 = 0;

1053 
he
 = 
ht
->
bË
[
i
];

1054 
he
) {

1055 
chašËn
++;

1056 
he
 = he->
Ãxt
;

1058 
şveùÜ
[(
chašËn
 < 
DICT_STATS_VECTLEN
) ? chainlen : (DICT_STATS_VECTLEN-1)]++;

1059 ià(
chašËn
 > 
maxchašËn
) maxchainlen = chainlen;

1060 
tÙchašËn
 +ğ
chašËn
;

1064 
l
 +ğ
	`¢´štf
(
buf
+l,
bufsize
-l,

1073 
bËid
, (tableid == 0) ? "main hashable" : "rehashingarget",

1074 
ht
->
size
, ht->
u£d
, 
¦Ùs
, 
maxchašËn
,

1075 ()
tÙchašËn
/
¦Ùs
, ()
ht
->
u£d
/slots);

1077 
i
 = 0; i < 
DICT_STATS_VECTLEN
-1; i++) {

1078 ià(
şveùÜ
[
i
] == 0) ;

1079 ià(
l
 >ğ
bufsize
) ;

1080 
l
 +ğ
	`¢´štf
(
buf
+l,
bufsize
-l,

1082 (
i
 =ğ
DICT_STATS_VECTLEN
-1)?">= ":"",

1083 
i
, 
şveùÜ
[i], (()şveùÜ[i]/
ht
->
size
)*100);

1087 ià(
bufsize
è
buf
[bufsize-1] = '\0';

1088  
	`¡¾’
(
buf
);

1089 
	}
}

1091 
	$diùG‘Sts
(*
buf
, 
size_t
 
bufsize
, 
diù
 *
d
) {

1092 
size_t
 
l
;

1093 *
Üig_buf
 = 
buf
;

1094 
size_t
 
Üig_bufsize
 = 
bufsize
;

1096 
l
 = 
	`_diùG‘StsHt
(
buf
,
bufsize
,&
d
->
ht
[0],0);

1097 
buf
 +ğ
l
;

1098 
bufsize
 -ğ
l
;

1099 ià(
	`diùIsRehashšg
(
d
è&& 
bufsize
 > 0) {

1100 
	`_diùG‘StsHt
(
buf
,
bufsize
,&
d
->
ht
[1],1);

1103 ià(
Üig_bufsize
è
Üig_buf
[orig_bufsize-1] = '\0';

1104 
	}
}

1108 #ifdeà
DICT_BENCHMARK_MAIN


1110 
	~"sds.h
"

1112 
ušt64_t
 
	$hashC®lback
(cÚ¡ *
key
) {

1113  
	`diùG’HashFunùiÚ
((*)
key
, 
	`sd¦’
((*)key));

1114 
	}
}

1116 
	$com·»C®lback
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
) {

1117 
l1
,
l2
;

1118 
	`DICT_NOTUSED
(
´ivd©a
);

1120 
l1
 = 
	`sd¦’
((
sds
)
key1
);

1121 
l2
 = 
	`sd¦’
((
sds
)
key2
);

1122 ià(
l1
 !ğ
l2
)  0;

1123  
	`memcmp
(
key1
, 
key2
, 
l1
) == 0;

1124 
	}
}

1126 
	$ä“C®lback
(*
´ivd©a
, *
v®
) {

1127 
	`DICT_NOTUSED
(
´ivd©a
);

1129 
	`sdsä“
(
v®
);

1130 
	}
}

1132 
diùTy³
 
	gB’chm¬kDiùTy³
 = {

1133 
hashC®lback
,

1134 
NULL
,

1135 
NULL
,

1136 
com·»C®lback
,

1137 
ä“C®lback
,

1138 
NULL


1141 
	#¡¬t_b’chm¬k
(è
¡¬t
 = 
	`timeInMli£cÚds
()

	)

1142 
	#’d_b’chm¬k
(
msg
) do { \

1143 
–­£d
 = 
	`timeInMli£cÚds
()-
¡¬t
; \

1144 
	`´štf
(
msg
 ": %ld i‹m š %Îd ms\n", 
couÁ
, 
–­£d
); \

1145 } 0);

	)

1148 
	$maš
(
¬gc
, **
¬gv
) {

1149 
j
;

1150 
¡¬t
, 
–­£d
;

1151 
diù
 *diù = 
	`diùC»©e
(&
B’chm¬kDiùTy³
,
NULL
);

1152 
couÁ
 = 0;

1154 ià(
¬gc
 == 2) {

1155 
couÁ
 = 
	`¡¹Ş
(
¬gv
[1],
NULL
,10);

1157 
couÁ
 = 5000000;

1160 
	`¡¬t_b’chm¬k
();

1161 
j
 = 0; j < 
couÁ
; j++) {

1162 
»tv®
 = 
	`diùAdd
(
diù
,
	`sdsäomlÚglÚg
(
j
),(*)j);

1163 
	`as£¹
(
»tv®
 =ğ
DICT_OK
);

1165 
	`’d_b’chm¬k
("Inserting");

1166 
	`as£¹
(()
	`diùSize
(
diù
è=ğ
couÁ
);

1169 
	`diùIsRehashšg
(
diù
)) {

1170 
	`diùRehashMli£cÚds
(
diù
,100);

1173 
	`¡¬t_b’chm¬k
();

1174 
j
 = 0; j < 
couÁ
; j++) {

1175 
sds
 
key
 = 
	`sdsäomlÚglÚg
(
j
);

1176 
diùEÁry
 *
de
 = 
	`diùFšd
(
diù
,
key
);

1177 
	`as£¹
(
de
 !ğ
NULL
);

1178 
	`sdsä“
(
key
);

1180 
	`’d_b’chm¬k
("Linear‡ccess ofƒxistingƒlements");

1182 
	`¡¬t_b’chm¬k
();

1183 
j
 = 0; j < 
couÁ
; j++) {

1184 
sds
 
key
 = 
	`sdsäomlÚglÚg
(
j
);

1185 
diùEÁry
 *
de
 = 
	`diùFšd
(
diù
,
key
);

1186 
	`as£¹
(
de
 !ğ
NULL
);

1187 
	`sdsä“
(
key
);

1189 
	`’d_b’chm¬k
("Linear‡ccess ofƒxistingƒlements (2nd„ound)");

1191 
	`¡¬t_b’chm¬k
();

1192 
j
 = 0; j < 
couÁ
; j++) {

1193 
sds
 
key
 = 
	`sdsäomlÚglÚg
(
	`¿nd
(è% 
couÁ
);

1194 
diùEÁry
 *
de
 = 
	`diùFšd
(
diù
,
key
);

1195 
	`as£¹
(
de
 !ğ
NULL
);

1196 
	`sdsä“
(
key
);

1198 
	`’d_b’chm¬k
("Random‡ccess ofƒxistingƒlements");

1200 
	`¡¬t_b’chm¬k
();

1201 
j
 = 0; j < 
couÁ
; j++) {

1202 
sds
 
key
 = 
	`sdsäomlÚglÚg
(
	`¿nd
(è% 
couÁ
);

1203 
key
[0] = 'X';

1204 
diùEÁry
 *
de
 = 
	`diùFšd
(
diù
,
key
);

1205 
	`as£¹
(
de
 =ğ
NULL
);

1206 
	`sdsä“
(
key
);

1208 
	`’d_b’chm¬k
("Accessing missing");

1210 
	`¡¬t_b’chm¬k
();

1211 
j
 = 0; j < 
couÁ
; j++) {

1212 
sds
 
key
 = 
	`sdsäomlÚglÚg
(
j
);

1213 
»tv®
 = 
	`diùD–‘e
(
diù
,
key
);

1214 
	`as£¹
(
»tv®
 =ğ
DICT_OK
);

1215 
key
[0] += 17;

1216 
»tv®
 = 
	`diùAdd
(
diù
,
key
,(*)
j
);

1217 
	`as£¹
(
»tv®
 =ğ
DICT_OK
);

1219 
	`’d_b’chm¬k
("Removing‡nd‡dding");

1220 
	}
}

	@dict.h

36 
	~<¡dšt.h
>

38 #iâdeà
__DICT_H


39 
	#__DICT_H


	)

41 
	#DICT_OK
 0

	)

42 
	#DICT_ERR
 1

	)

45 
	#DICT_NOTUSED
(
V
è((èV)

	)

47 
	sdiùEÁry
 {

48 *
	mkey
;

50 *
	mv®
;

51 
ušt64_t
 
	mu64
;

52 
št64_t
 
	ms64
;

53 
	md
;

54 } 
	mv
;

55 
diùEÁry
 *
	mÃxt
;

56 } 
	tdiùEÁry
;

58 
	sdiùTy³
 {

59 
ušt64_t
 (*
hashFunùiÚ
)(cÚ¡ *
	mkey
);

60 *(*
	mkeyDup
)(*
	m´ivd©a
, cÚ¡ *
	mkey
);

61 *(*
	mv®Dup
)(*
	m´ivd©a
, cÚ¡ *
	mobj
);

62 (*
	mkeyCom·»
)(*
	m´ivd©a
, cÚ¡ *
	mkey1
, cÚ¡ *
	mkey2
);

63 (*
	mkeyDe¡ruùÜ
)(*
	m´ivd©a
, *
	mkey
);

64 (*
	mv®De¡ruùÜ
)(*
	m´ivd©a
, *
	mobj
);

65 } 
	tdiùTy³
;

69 
	sdiùht
 {

70 
diùEÁry
 **
	mbË
;

71 
	msize
;

72 
	msizemask
;

73 
	mu£d
;

74 } 
	tdiùht
;

76 
	sdiù
 {

77 
diùTy³
 *
	mty³
;

78 *
	m´ivd©a
;

79 
diùht
 
	mht
[2];

80 
	m»hashidx
;

81 
	m™”©Üs
;

82 } 
	tdiù
;

88 
	sdiùI‹¿tÜ
 {

89 
diù
 *
	md
;

90 
	mšdex
;

91 
	mbË
, 
	m§ã
;

92 
diùEÁry
 *
	m’Œy
, *
	mÃxtEÁry
;

94 
	mfšg”´št
;

95 } 
	tdiùI‹¿tÜ
;

97 (
	tdiùSÿnFunùiÚ
)(*
	t´ivd©a
, cÚ¡ 
	tdiùEÁry
 *
	tde
);

98 (
	tdiùSÿnBuck‘FunùiÚ
)(*
	t´ivd©a
, 
	tdiùEÁry
 **
	tbuck‘»f
);

101 
	#DICT_HT_INITIAL_SIZE
 4

	)

104 
	#diùF»eV®
(
d
, 
’Œy
) \

105 ià((
d
)->
ty³
->
v®De¡ruùÜ
) \

106 (
d
)->
ty³
->
	`v®De¡ruùÜ
((d)->
´ivd©a
, (
’Œy
)->
v
.
v®
)

	)

108 
	#diùS‘V®
(
d
, 
’Œy
, 
_v®_
) do { \

109 ià((
d
)->
ty³
->
v®Dup
) \

110 (
’Œy
)->
v
.
v®
 = (
d
)->
ty³
->
	`v®Dup
((d)->
´ivd©a
, 
_v®_
); \

112 (
’Œy
)->
v
.
v®
 = (
_v®_
); \

113 
	}
} 0)

	)

115 
	#diùS‘SigÃdIÁeg”V®
(
’Œy
, 
_v®_
) \

116 dØ{ (
’Œy
)->
v
.
s64
 = 
_v®_
; } 0)

	)

118 
	#diùS‘UnsigÃdIÁeg”V®
(
’Œy
, 
_v®_
) \

119 dØ{ (
’Œy
)->
v
.
u64
 = 
_v®_
; } 0)

	)

121 
	#diùS‘DoubËV®
(
’Œy
, 
_v®_
) \

122 dØ{ (
’Œy
)->
v
.
d
 = 
_v®_
; } 0)

	)

124 
	#diùF»eKey
(
d
, 
’Œy
) \

125 ià((
d
)->
ty³
->
keyDe¡ruùÜ
) \

126 (
d
)->
ty³
->
	`keyDe¡ruùÜ
((d)->
´ivd©a
, (
’Œy
)->
key
)

	)

128 
	#diùS‘Key
(
d
, 
’Œy
, 
_key_
) do { \

129 ià((
d
)->
ty³
->
keyDup
) \

130 (
’Œy
)->
key
 = (
d
)->
ty³
->
	`keyDup
((d)->
´ivd©a
, 
_key_
); \

132 (
’Œy
)->
key
 = (
_key_
); \

133 } 0)

	)

135 
	#diùCom·»Keys
(
d
, 
key1
, 
key2
) \

136 (((
d
)->
ty³
->
keyCom·»
) ? \

137 (
d
)->
ty³
->
	`keyCom·»
((d)->
´ivd©a
, 
key1
, 
key2
) : \

138 (
key1
è=ğ(
key2
))

	)

140 
	#diùHashKey
(
d
, 
key
è(d)->
ty³
->
	`hashFunùiÚ
(key)

	)

141 
	#diùG‘Key
(
he
è((he)->
key
)

	)

142 
	#diùG‘V®
(
he
è((he)->
v
.
v®
)

	)

143 
	#diùG‘SigÃdIÁeg”V®
(
he
è((he)->
v
.
s64
)

	)

144 
	#diùG‘UnsigÃdIÁeg”V®
(
he
è((he)->
v
.
u64
)

	)

145 
	#diùG‘DoubËV®
(
he
è((he)->
v
.
d
)

	)

146 
	#diùSlÙs
(
d
è((d)->
ht
[0].
size
+(d)->ht[1].size)

	)

147 
	#diùSize
(
d
è((d)->
ht
[0].
u£d
+(d)->ht[1].u£d)

	)

148 
	#diùIsRehashšg
(
d
è((d)->
»hashidx
 !ğ-1)

	)

151 
diù
 *
diùC»©e
(
diùTy³
 *
ty³
, *
´ivD©aPŒ
);

152 
diùEx·nd
(
diù
 *
d
, 
size
);

153 
diùAdd
(
diù
 *
d
, *
key
, *
v®
);

154 
diùEÁry
 *
diùAddRaw
(
diù
 *
d
, *
key
, diùEÁry **
exi¡šg
);

155 
diùEÁry
 *
diùAddOrFšd
(
diù
 *
d
, *
key
);

156 
diùR•Ïû
(
diù
 *
d
, *
key
, *
v®
);

157 
diùD–‘e
(
diù
 *
d
, cÚ¡ *
key
);

158 
diùEÁry
 *
diùUÆšk
(
diù
 *
ht
, cÚ¡ *
key
);

159 
diùF»eUÆškedEÁry
(
diù
 *
d
, 
diùEÁry
 *
he
);

160 
diùR–—£
(
diù
 *
d
);

161 
diùEÁry
 * 
diùFšd
(
diù
 *
d
, cÚ¡ *
key
);

162 *
diùF‘chV®ue
(
diù
 *
d
, cÚ¡ *
key
);

163 
diùResize
(
diù
 *
d
);

164 
diùI‹¿tÜ
 *
diùG‘I‹¿tÜ
(
diù
 *
d
);

165 
diùI‹¿tÜ
 *
diùG‘SaãI‹¿tÜ
(
diù
 *
d
);

166 
diùEÁry
 *
diùNext
(
diùI‹¿tÜ
 *
™”
);

167 
diùR–—£I‹¿tÜ
(
diùI‹¿tÜ
 *
™”
);

168 
diùEÁry
 *
diùG‘RªdomKey
(
diù
 *
d
);

169 
diùG‘SomeKeys
(
diù
 *
d
, 
diùEÁry
 **
des
, 
couÁ
);

170 
diùG‘Sts
(*
buf
, 
size_t
 
bufsize
, 
diù
 *
d
);

171 
ušt64_t
 
diùG’HashFunùiÚ
(cÚ¡ *
key
, 
Ën
);

172 
ušt64_t
 
diùG’Ca£HashFunùiÚ
(cÚ¡ *
buf
, 
Ën
);

173 
diùEm±y
(
diù
 *
d
, (
ÿÎback
)(*));

174 
	`diùEÇbËResize
();

175 
	`diùDi§bËResize
();

176 
	`diùRehash
(
diù
 *
d
, 
n
);

177 
	`diùRehashMli£cÚds
(
diù
 *
d
, 
ms
);

178 
	`diùS‘HashFunùiÚS“d
(
ušt8_t
 *
£ed
);

179 
ušt8_t
 *
	`diùG‘HashFunùiÚS“d
();

180 
	`diùSÿn
(
diù
 *
d
, 
v
, 
diùSÿnFunùiÚ
 *
â
, 
diùSÿnBuck‘FunùiÚ
 *
buck‘â
, *
´ivd©a
);

181 
	`diùG‘Hash
(
diù
 *
d
, cÚ¡ *
key
);

182 
diùEÁry
 **
	`diùFšdEÁryRefByPŒAndHash
(
diù
 *
d
, cÚ¡ *
Şd±r
, 
hash
);

185 
diùTy³
 
diùTy³H—pSŒšgCİyKey
;

186 
diùTy³
 
diùTy³H—pSŒšgs
;

187 
diùTy³
 
diùTy³H—pSŒšgCİyKeyV®ue
;

	@endianconv.c

45 
	~<¡dšt.h
>

49 
	$mem»v16
(*
p
) {

50 *
x
 = 
p
, 
t
;

52 
t
 = 
x
[0];

53 
x
[0] = x[1];

54 
x
[1] = 
t
;

55 
	}
}

59 
	$mem»v32
(*
p
) {

60 *
x
 = 
p
, 
t
;

62 
t
 = 
x
[0];

63 
x
[0] = x[3];

64 
x
[3] = 
t
;

65 
t
 = 
x
[1];

66 
x
[1] = x[2];

67 
x
[2] = 
t
;

68 
	}
}

72 
	$mem»v64
(*
p
) {

73 *
x
 = 
p
, 
t
;

75 
t
 = 
x
[0];

76 
x
[0] = x[7];

77 
x
[7] = 
t
;

78 
t
 = 
x
[1];

79 
x
[1] = x[6];

80 
x
[6] = 
t
;

81 
t
 = 
x
[2];

82 
x
[2] = x[5];

83 
x
[5] = 
t
;

84 
t
 = 
x
[3];

85 
x
[3] = x[4];

86 
x
[4] = 
t
;

87 
	}
}

89 
ušt16_t
 
	$šŒev16
(
ušt16_t
 
v
) {

90 
	`mem»v16
(&
v
);

91  
v
;

92 
	}
}

94 
ušt32_t
 
	$šŒev32
(
ušt32_t
 
v
) {

95 
	`mem»v32
(&
v
);

96  
v
;

97 
	}
}

99 
ušt64_t
 
	$šŒev64
(
ušt64_t
 
v
) {

100 
	`mem»v64
(&
v
);

101  
v
;

102 
	}
}

104 #ifdeà
REDIS_TEST


105 
	~<¡dio.h
>

107 
	#UNUSED
(
x
è()(x)

	)

108 
	$’dŸncÚvTe¡
(
¬gc
, *
¬gv
[]) {

109 
buf
[32];

111 
	`UNUSED
(
¬gc
);

112 
	`UNUSED
(
¬gv
);

114 
	`¥rštf
(
buf
,"ciaoroma");

115 
	`mem»v16
(
buf
);

116 
	`´štf
("%s\n", 
buf
);

118 
	`¥rštf
(
buf
,"ciaoroma");

119 
	`mem»v32
(
buf
);

120 
	`´štf
("%s\n", 
buf
);

122 
	`¥rštf
(
buf
,"ciaoroma");

123 
	`mem»v64
(
buf
);

124 
	`´štf
("%s\n", 
buf
);

127 
	}
}

	@endianconv.h

33 #iâdeà
__ENDIANCONV_H


34 
	#__ENDIANCONV_H


	)

36 
	~"cÚfig.h
"

37 
	~<¡dšt.h
>

39 
mem»v16
(*
p
);

40 
mem»v32
(*
p
);

41 
mem»v64
(*
p
);

42 
ušt16_t
 
šŒev16
(ušt16_ˆ
v
);

43 
ušt32_t
 
šŒev32
(ušt32_ˆ
v
);

44 
ušt64_t
 
šŒev64
(ušt64_ˆ
v
);

48 #ià(
BYTE_ORDER
 =ğ
LITTLE_ENDIAN
)

49 
	#mem»v16ifbe
(
p
)

	)

50 
	#mem»v32ifbe
(
p
)

	)

51 
	#mem»v64ifbe
(
p
)

	)

52 
	#šŒev16ifbe
(
v
è(v)

	)

53 
	#šŒev32ifbe
(
v
è(v)

	)

54 
	#šŒev64ifbe
(
v
è(v)

	)

56 
	#mem»v16ifbe
(
p
è
	`mem»v16
Õ)

	)

57 
	#mem»v32ifbe
(
p
è
	`mem»v32
Õ)

	)

58 
	#mem»v64ifbe
(
p
è
	`mem»v64
Õ)

	)

59 
	#šŒev16ifbe
(
v
è
	`šŒev16
(v)

	)

60 
	#šŒev32ifbe
(
v
è
	`šŒev32
(v)

	)

61 
	#šŒev64ifbe
(
v
è
	`šŒev64
(v)

	)

66 #ià(
BYTE_ORDER
 =ğ
BIG_ENDIAN
)

67 
	#htÚu64
(
v
è(v)

	)

68 
	#Áohu64
(
v
è(v)

	)

70 
	#htÚu64
(
v
è
	`šŒev64
(v)

	)

71 
	#Áohu64
(
v
è
	`šŒev64
(v)

	)

74 #ifdeà
REDIS_TEST


75 
’dŸncÚvTe¡
(
¬gc
, *
¬gv
[]);

	@evict.c

33 
	~"£rv”.h
"

34 
	~"bio.h
"

35 
	~"©omicv¬.h
"

52 
	#EVPOOL_SIZE
 16

	)

53 
	#EVPOOL_CACHED_SDS_SIZE
 255

	)

54 
	seviùiÚPoŞEÁry
 {

55 
	midË
;

56 
sds
 
	mkey
;

57 
sds
 
	mÿched
;

58 
	mdbid
;

61 
eviùiÚPoŞEÁry
 *
	gEviùiÚPoŞLRU
;

63 
LFUDeüAndR‘uº
(
robj
 *
o
);

72 
	$g‘LRUClock
() {

73  (
	`m¡ime
()/
LRU_CLOCK_RESOLUTION
è& 
LRU_CLOCK_MAX
;

74 
	}
}

80 
	$LRU_CLOCK
() {

81 
Ìuşock
;

82 ià(1000/
£rv”
.
hz
 <ğ
LRU_CLOCK_RESOLUTION
) {

83 
	`©omicG‘
(
£rv”
.
Ìuşock
,lruclock);

85 
Ìuşock
 = 
	`g‘LRUClock
();

87  
Ìuşock
;

88 
	}
}

92 
	$e¡im©eObjeùIdËTime
(
robj
 *
o
) {

93 
Ìuşock
 = 
	`LRU_CLOCK
();

94 ià(
Ìuşock
 >ğ
o
->
Ìu
) {

95  (
Ìuşock
 - 
o
->
Ìu
è* 
LRU_CLOCK_RESOLUTION
;

97  (
Ìuşock
 + (
LRU_CLOCK_MAX
 - 
o
->
Ìu
)) *

98 
LRU_CLOCK_RESOLUTION
;

100 
	}
}

141 
	$eviùiÚPoŞAÎoc
() {

142 
eviùiÚPoŞEÁry
 *
•
;

143 
j
;

145 
•
 = 
	`zm®loc
((*•)*
EVPOOL_SIZE
);

146 
j
 = 0; j < 
EVPOOL_SIZE
; j++) {

147 
•
[
j
].
idË
 = 0;

148 
•
[
j
].
key
 = 
NULL
;

149 
•
[
j
].
ÿched
 = 
	`sd¢ewËn
(
NULL
,
EVPOOL_CACHED_SDS_SIZE
);

150 
•
[
j
].
dbid
 = 0;

152 
EviùiÚPoŞLRU
 = 
•
;

153 
	}
}

164 
	$eviùiÚPoŞPİuÏ‹
(
dbid
, 
diù
 *
§m¶ediù
, diù *
keydiù
, 
eviùiÚPoŞEÁry
 *
poŞ
) {

165 
j
, 
k
, 
couÁ
;

166 
diùEÁry
 *
§m¶es
[
£rv”
.
maxmemÜy_§m¶es
];

168 
couÁ
 = 
	`diùG‘SomeKeys
(
§m¶ediù
,
§m¶es
,
£rv”
.
maxmemÜy_§m¶es
);

169 
j
 = 0; j < 
couÁ
; j++) {

170 
idË
;

171 
sds
 
key
;

172 
robj
 *
o
;

173 
diùEÁry
 *
de
;

175 
de
 = 
§m¶es
[
j
];

176 
key
 = 
	`diùG‘Key
(
de
);

181 ià(
£rv”
.
maxmemÜy_pŞicy
 !ğ
MAXMEMORY_VOLATILE_TTL
) {

182 ià(
§m¶ediù
 !ğ
keydiù
è
de
 = 
	`diùFšd
(keydiù, 
key
);

183 
o
 = 
	`diùG‘V®
(
de
);

189 ià(
£rv”
.
maxmemÜy_pŞicy
 & 
MAXMEMORY_FLAG_LRU
) {

190 
idË
 = 
	`e¡im©eObjeùIdËTime
(
o
);

191 } ià(
£rv”
.
maxmemÜy_pŞicy
 & 
MAXMEMORY_FLAG_LFU
) {

199 
idË
 = 255-
	`LFUDeüAndR‘uº
(
o
);

200 } ià(
£rv”
.
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_VOLATILE_TTL
) {

202 
idË
 = 
ULLONG_MAX
 - ()
	`diùG‘V®
(
de
);

204 
	`£rv”Pªic
("Unknownƒviction…olicy inƒvictionPoolPopulate()");

210 
k
 = 0;

211 
k
 < 
EVPOOL_SIZE
 &&

212 
poŞ
[
k
].
key
 &&

213 
poŞ
[
k
].
idË
 < idle) k++;

214 ià(
k
 =ğ0 && 
poŞ
[
EVPOOL_SIZE
-1].
key
 !ğ
NULL
) {

218 } ià(
k
 < 
EVPOOL_SIZE
 && 
poŞ
[k].
key
 =ğ
NULL
) {

223 ià(
poŞ
[
EVPOOL_SIZE
-1].
key
 =ğ
NULL
) {

228 
sds
 
ÿched
 = 
poŞ
[
EVPOOL_SIZE
-1].cached;

229 
	`memmove
(
poŞ
+
k
+1,pool+k,

230 (
poŞ
[0])*(
EVPOOL_SIZE
-
k
-1));

231 
poŞ
[
k
].
ÿched
 = cached;

234 
k
--;

237 
sds
 
ÿched
 = 
poŞ
[0].cached;

238 ià(
poŞ
[0].
key
 !ğpoŞ[0].
ÿched
è
	`sdsä“
(pool[0].key);

239 
	`memmove
(
poŞ
,poŞ+1,ÕoŞ[0])*
k
);

240 
poŞ
[
k
].
ÿched
 = cached;

248 
kËn
 = 
	`sd¦’
(
key
);

249 ià(
kËn
 > 
EVPOOL_CACHED_SDS_SIZE
) {

250 
poŞ
[
k
].
key
 = 
	`sdsdup
(key);

252 
	`memıy
(
poŞ
[
k
].
ÿched
,
key
,
kËn
+1);

253 
	`sds£’
(
poŞ
[
k
].
ÿched
,
kËn
);

254 
poŞ
[
k
].
key
 =…oŞ[k].
ÿched
;

256 
poŞ
[
k
].
idË
 = idle;

257 
poŞ
[
k
].
dbid
 = dbid;

259 
	}
}

301 
	$LFUG‘TimeInMšu‹s
() {

302  (
£rv”
.
unixtime
/60) & 65535;

303 
	}
}

309 
	$LFUTimeEÏp£d
(
ldt
) {

310 
now
 = 
	`LFUG‘TimeInMšu‹s
();

311 ià(
now
 >ğ
ldt
) ‚ow-ldt;

312  65535-
ldt
+
now
;

313 
	}
}

317 
ušt8_t
 
	$LFULogInü
(
ušt8_t
 
couÁ”
) {

318 ià(
couÁ”
 == 255)  255;

319 
r
 = ()
	`¿nd
()/
RAND_MAX
;

320 
ba£v®
 = 
couÁ”
 - 
LFU_INIT_VAL
;

321 ià(
ba£v®
 < 0) baseval = 0;

322 
p
 = 1.0/(
ba£v®
*
£rv”
.
lfu_log_çùÜ
+1);

323 ià(
r
 < 
p
è
couÁ”
++;

324  
couÁ”
;

325 
	}
}

333 
	#LFU_DECR_INTERVAL
 1

	)

334 
	$LFUDeüAndR‘uº
(
robj
 *
o
) {

335 
ldt
 = 
o
->
Ìu
 >> 8;

336 
couÁ”
 = 
o
->
Ìu
 & 255;

337 ià(
	`LFUTimeEÏp£d
(
ldt
è>ğ
£rv”
.
lfu_deÿy_time
 && 
couÁ”
) {

338 ià(
couÁ”
 > 
LFU_INIT_VAL
*2) {

339 
couÁ”
 /= 2;

340 ià(
couÁ”
 < 
LFU_INIT_VAL
*2) counter = LFU_INIT_VAL*2;

342 
couÁ”
--;

344 
o
->
Ìu
 = (
	`LFUG‘TimeInMšu‹s
()<<8è| 
couÁ”
;

346  
couÁ”
;

347 
	}
}

357 
size_t
 
	$ä“MemÜyG‘NÙCouÁedMemÜy
() {

358 
size_t
 
ov”h—d
 = 0;

359 
¦aves
 = 
	`li¡L’gth
(
£rv”
.slaves);

361 ià(
¦aves
) {

362 
li¡I‹r
 
li
;

363 
li¡Node
 *
Ê
;

365 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

366 (
Ê
 = 
	`li¡Next
(&
li
))) {

367 
ş›Á
 *
¦ave
 = 
	`li¡NodeV®ue
(
Ê
);

368 
ov”h—d
 +ğ
	`g‘Cl›ÁOuutBufãrMemÜyU§ge
(
¦ave
);

371 ià(
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
) {

372 
ov”h—d
 +ğ
	`sd¦’
(
£rv”
.
aof_buf
)+
	`aofRewr™eBufãrSize
();

374  
ov”h—d
;

375 
	}
}

377 
	$ä“MemÜyIfN“ded
() {

378 
size_t
 
mem_»pÜ‹d
, 
mem_u£d
, 
mem_toä“
, 
mem_ä“d
;

379 
m¡ime_t
 
Ï‹ncy
, 
eviùiÚ_Ï‹ncy
;

380 
d–
;

381 
¦aves
 = 
	`li¡L’gth
(
£rv”
.slaves);

386 ià(
	`ş›ÁsA»Pau£d
()è 
C_OK
;

390 
mem_»pÜ‹d
 = 
	`zm®loc_u£d_memÜy
();

391 ià(
mem_»pÜ‹d
 <ğ
£rv”
.
maxmemÜy
è 
C_OK
;

395 
mem_u£d
 = 
mem_»pÜ‹d
;

396 
size_t
 
ov”h—d
 = 
	`ä“MemÜyG‘NÙCouÁedMemÜy
();

397 
mem_u£d
 = (mem_u£d > 
ov”h—d
) ? mem_used-overhead : 0;

400 ià(
mem_u£d
 <ğ
£rv”
.
maxmemÜy
è 
C_OK
;

403 
mem_toä“
 = 
mem_u£d
 - 
£rv”
.
maxmemÜy
;

404 
mem_ä“d
 = 0;

406 ià(
£rv”
.
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_NO_EVICTION
)

407 
ÿÁ_ä“
;

409 
	`Ï‹ncyS¹MÚ™Ü
(
Ï‹ncy
);

410 
mem_ä“d
 < 
mem_toä“
) {

411 
j
, 
k
, 
i
, 
keys_ä“d
 = 0;

412 
Ãxt_db
 = 0;

413 
sds
 
be¡key
 = 
NULL
;

414 
be¡dbid
;

415 
»disDb
 *
db
;

416 
diù
 *dict;

417 
diùEÁry
 *
de
;

419 ià(
£rv”
.
maxmemÜy_pŞicy
 & (
MAXMEMORY_FLAG_LRU
|
MAXMEMORY_FLAG_LFU
) ||

420 
£rv”
.
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_VOLATILE_TTL
)

422 
eviùiÚPoŞEÁry
 *
poŞ
 = 
EviùiÚPoŞLRU
;

424 
be¡key
 =ğ
NULL
) {

425 
tÙ®_keys
 = 0, 
keys
;

430 
i
 = 0; i < 
£rv”
.
dbnum
; i++) {

431 
db
 = 
£rv”
.db+
i
;

432 
diù
 = (
£rv”
.
maxmemÜy_pŞicy
 & 
MAXMEMORY_FLAG_ALLKEYS
) ?

433 
db
->
diù
 : db->
expœes
;

434 ià((
keys
 = 
	`diùSize
(
diù
)) != 0) {

435 
	`eviùiÚPoŞPİuÏ‹
(
i
, 
diù
, 
db
->diù, 
poŞ
);

436 
tÙ®_keys
 +ğ
keys
;

439 ià(!
tÙ®_keys
) ;

442 
k
 = 
EVPOOL_SIZE
-1; k >= 0; k--) {

443 ià(
poŞ
[
k
].
key
 =ğ
NULL
) ;

444 
be¡dbid
 = 
poŞ
[
k
].
dbid
;

446 ià(
£rv”
.
maxmemÜy_pŞicy
 & 
MAXMEMORY_FLAG_ALLKEYS
) {

447 
de
 = 
	`diùFšd
(
£rv”
.
db
[
poŞ
[
k
].
dbid
].
diù
,

448 
poŞ
[
k
].
key
);

450 
de
 = 
	`diùFšd
(
£rv”
.
db
[
poŞ
[
k
].
dbid
].
expœes
,

451 
poŞ
[
k
].
key
);

455 ià(
poŞ
[
k
].
key
 !ğpoŞ[k].
ÿched
)

456 
	`sdsä“
(
poŞ
[
k
].
key
);

457 
poŞ
[
k
].
key
 = 
NULL
;

458 
poŞ
[
k
].
idË
 = 0;

462 ià(
de
) {

463 
be¡key
 = 
	`diùG‘Key
(
de
);

473 ià(
£rv”
.
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_ALLKEYS_RANDOM
 ||

474 
£rv”
.
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_VOLATILE_RANDOM
)

479 
i
 = 0; i < 
£rv”
.
dbnum
; i++) {

480 
j
 = (++
Ãxt_db
è% 
£rv”
.
dbnum
;

481 
db
 = 
£rv”
.db+
j
;

482 
diù
 = (
£rv”
.
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_ALLKEYS_RANDOM
) ?

483 
db
->
diù
 : db->
expœes
;

484 ià(
	`diùSize
(
diù
) != 0) {

485 
de
 = 
	`diùG‘RªdomKey
(
diù
);

486 
be¡key
 = 
	`diùG‘Key
(
de
);

487 
be¡dbid
 = 
j
;

494 ià(
be¡key
) {

495 
db
 = 
£rv”
.db+
be¡dbid
;

496 
robj
 *
keyobj
 = 
	`ü—‹SŒšgObjeù
(
be¡key
,
	`sd¦’
(bestkey));

497 
	`´İag©eExpœe
(
db
,
keyobj
,
£rv”
.
Ïzyä“_Ïzy_eviùiÚ
);

506 
d–
 = (è
	`zm®loc_u£d_memÜy
();

507 
	`Ï‹ncyS¹MÚ™Ü
(
eviùiÚ_Ï‹ncy
);

508 ià(
£rv”
.
Ïzyä“_Ïzy_eviùiÚ
)

509 
	`dbAsyncD–‘e
(
db
,
keyobj
);

511 
	`dbSyncD–‘e
(
db
,
keyobj
);

512 
	`Ï‹ncyEndMÚ™Ü
(
eviùiÚ_Ï‹ncy
);

513 
	`Ï‹ncyAddSam¶eIfN“ded
("eviùiÚ-d–",
eviùiÚ_Ï‹ncy
);

514 
	`Ï‹ncyRemoveNe¡edEv’t
(
Ï‹ncy
,
eviùiÚ_Ï‹ncy
);

515 
d–
 -ğ(è
	`zm®loc_u£d_memÜy
();

516 
mem_ä“d
 +ğ
d–
;

517 
£rv”
.
¡©_eviùedkeys
++;

518 
	`nÙifyKey¥aûEv’t
(
NOTIFY_EVICTED
, "evicted",

519 
keyobj
, 
db
->
id
);

520 
	`deüRefCouÁ
(
keyobj
);

521 
keys_ä“d
++;

527 ià(
¦aves
è
	`æushSÏvesOuutBufãrs
();

536 ià(
£rv”
.
Ïzyä“_Ïzy_eviùiÚ
 && !(
keys_ä“d
 % 16)) {

537 
ov”h—d
 = 
	`ä“MemÜyG‘NÙCouÁedMemÜy
();

538 
mem_u£d
 = 
	`zm®loc_u£d_memÜy
();

539 
mem_u£d
 = (mem_u£d > 
ov”h—d
) ? mem_used-overhead : 0;

540 ià(
mem_u£d
 <ğ
£rv”
.
maxmemÜy
) {

541 
mem_ä“d
 = 
mem_toä“
;

546 ià(!
keys_ä“d
) {

547 
	`Ï‹ncyEndMÚ™Ü
(
Ï‹ncy
);

548 
	`Ï‹ncyAddSam¶eIfN“ded
("eviùiÚ-cyşe",
Ï‹ncy
);

549 
ÿÁ_ä“
;

552 
	`Ï‹ncyEndMÚ™Ü
(
Ï‹ncy
);

553 
	`Ï‹ncyAddSam¶eIfN“ded
("eviùiÚ-cyşe",
Ï‹ncy
);

554  
C_OK
;

556 
ÿÁ_ä“
:

560 
	`bioP’dšgJobsOfTy³
(
BIO_LAZY_FREE
)) {

561 ià(((
mem_»pÜ‹d
 - 
	`zm®loc_u£d_memÜy
()è+ 
mem_ä“d
è>ğ
mem_toä“
)

563 
	`u¦“p
(1000);

565  
C_ERR
;

566 
	}
}

	@expire.c

33 
	~"£rv”.h
"

54 
	$aùiveExpœeCyşeTryExpœe
(
»disDb
 *
db
, 
diùEÁry
 *
de
, 
now
) {

55 
t
 = 
	`diùG‘SigÃdIÁeg”V®
(
de
);

56 ià(
now
 > 
t
) {

57 
sds
 
key
 = 
	`diùG‘Key
(
de
);

58 
robj
 *
keyobj
 = 
	`ü—‹SŒšgObjeù
(
key
,
	`sd¦’
(key));

60 
	`´İag©eExpœe
(
db
,
keyobj
,
£rv”
.
Ïzyä“_Ïzy_expœe
);

61 ià(
£rv”
.
Ïzyä“_Ïzy_expœe
)

62 
	`dbAsyncD–‘e
(
db
,
keyobj
);

64 
	`dbSyncD–‘e
(
db
,
keyobj
);

65 
	`nÙifyKey¥aûEv’t
(
NOTIFY_EXPIRED
,

66 "expœed",
keyobj
,
db
->
id
);

67 
	`deüRefCouÁ
(
keyobj
);

68 
£rv”
.
¡©_expœedkeys
++;

73 
	}
}

97 
	$aùiveExpœeCyşe
(
ty³
) {

100 
cu¼’t_db
 = 0;

101 
tim–im™_ex™
 = 0;

102 
Ï¡_ç¡_cyşe
 = 0;

104 
j
, 
™”©iÚ
 = 0;

105 
dbs_³r_ÿÎ
 = 
CRON_DBS_PER_CALL
;

106 
¡¬t
 = 
	`u¡ime
(), 
tim–im™
;

111 ià(
	`ş›ÁsA»Pau£d
()) ;

113 ià(
ty³
 =ğ
ACTIVE_EXPIRE_CYCLE_FAST
) {

117 ià(!
tim–im™_ex™
) ;

118 ià(
¡¬t
 < 
Ï¡_ç¡_cyşe
 + 
ACTIVE_EXPIRE_CYCLE_FAST_DURATION
*2) ;

119 
Ï¡_ç¡_cyşe
 = 
¡¬t
;

129 ià(
dbs_³r_ÿÎ
 > 
£rv”
.
dbnum
 || 
tim–im™_ex™
)

130 
dbs_³r_ÿÎ
 = 
£rv”
.
dbnum
;

136 
tim–im™
 = 1000000*
ACTIVE_EXPIRE_CYCLE_SLOW_TIME_PERC
/
£rv”
.
hz
/100;

137 
tim–im™_ex™
 = 0;

138 ià(
tim–im™
 <= 0)imelimit = 1;

140 ià(
ty³
 =ğ
ACTIVE_EXPIRE_CYCLE_FAST
)

141 
tim–im™
 = 
ACTIVE_EXPIRE_CYCLE_FAST_DURATION
;

143 
j
 = 0; j < 
dbs_³r_ÿÎ
; j++) {

144 
expœed
;

145 
»disDb
 *
db
 = 
£rv”
.db+(
cu¼’t_db
 % s”v”.
dbnum
);

150 
cu¼’t_db
++;

155 
num
, 
¦Ùs
;

156 
now
, 
‰l_sum
;

157 
‰l_§m¶es
;

160 ià((
num
 = 
	`diùSize
(
db
->
expœes
)) == 0) {

161 
db
->
avg_‰l
 = 0;

164 
¦Ùs
 = 
	`diùSlÙs
(
db
->
expœes
);

165 
now
 = 
	`m¡ime
();

170 ià(
num
 && 
¦Ùs
 > 
DICT_HT_INITIAL_SIZE
 &&

171 (
num
*100/
¦Ùs
 < 1)) ;

175 
expœed
 = 0;

176 
‰l_sum
 = 0;

177 
‰l_§m¶es
 = 0;

179 ià(
num
 > 
ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP
)

180 
num
 = 
ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP
;

182 
num
--) {

183 
diùEÁry
 *
de
;

184 
‰l
;

186 ià((
de
 = 
	`diùG‘RªdomKey
(
db
->
expœes
)è=ğ
NULL
) ;

187 
‰l
 = 
	`diùG‘SigÃdIÁeg”V®
(
de
)-
now
;

188 ià(
	`aùiveExpœeCyşeTryExpœe
(
db
,
de
,
now
)è
expœed
++;

189 ià(
‰l
 > 0) {

191 
‰l_sum
 +ğ
‰l
;

192 
‰l_§m¶es
++;

197 ià(
‰l_§m¶es
) {

198 
avg_‰l
 = 
‰l_sum
/
‰l_§m¶es
;

203 ià(
db
->
avg_‰l
 == 0) db->avg_ttl =‡vg_ttl;

204 
db
->
avg_‰l
 = (db->avg_ttl/50)*49 + (avg_ttl/50);

210 
™”©iÚ
++;

211 ià((
™”©iÚ
 & 0xf) == 0) {

212 
–­£d
 = 
	`u¡ime
()-
¡¬t
;

214 
	`Ï‹ncyAddSam¶eIfN“ded
("expœe-cyşe",
–­£d
/1000);

215 ià(
–­£d
 > 
tim–im™
è
tim–im™_ex™
 = 1;

217 ià(
tim–im™_ex™
) ;

220 } 
expœed
 > 
ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP
/4);

222 
	}
}

259 
diù
 *
	g¦aveKeysW™hExpœe
 = 
NULL
;

263 
	$expœeSÏveKeys
() {

264 ià(
¦aveKeysW™hExpœe
 =ğ
NULL
 ||

265 
	`diùSize
(
¦aveKeysW™hExpœe
) == 0) ;

267 
cyşes
 = 0, 
nÛxpœe
 = 0;

268 
m¡ime_t
 
¡¬t
 = 
	`m¡ime
();

270 
diùEÁry
 *
de
 = 
	`diùG‘RªdomKey
(
¦aveKeysW™hExpœe
);

271 
sds
 
keyÇme
 = 
	`diùG‘Key
(
de
);

272 
ušt64_t
 
dbids
 = 
	`diùG‘UnsigÃdIÁeg”V®
(
de
);

273 
ušt64_t
 
Ãw_dbids
 = 0;

277 
dbid
 = 0;

278 
dbids
 && 
dbid
 < 
£rv”
.
dbnum
) {

279 ià((
dbids
 & 1) != 0) {

280 
»disDb
 *
db
 = 
£rv”
.db+
dbid
;

281 
diùEÁry
 *
expœe
 = 
	`diùFšd
(
db
->
expœes
,
keyÇme
);

282 
expœed
 = 0;

284 ià(
expœe
 &&

285 
	`aùiveExpœeCyşeTryExpœe
(
£rv”
.
db
+
dbid
,
expœe
,
¡¬t
))

287 
expœed
 = 1;

294 ià(
expœe
 && !
expœed
) {

295 
nÛxpœe
++;

296 
Ãw_dbids
 |ğ(
ušt64_t
)1 << 
dbid
;

299 
dbid
++;

300 
dbids
 >>= 1;

306 ià(
Ãw_dbids
)

307 
	`diùS‘UnsigÃdIÁeg”V®
(
de
,
Ãw_dbids
);

309 
	`diùD–‘e
(
¦aveKeysW™hExpœe
,
keyÇme
);

313 
cyşes
++;

314 ià(
nÛxpœe
 > 3) ;

315 ià((
cyşes
 % 64è=ğ0 && 
	`m¡ime
()-
¡¬t
 > 1) ;

316 ià(
	`diùSize
(
¦aveKeysW™hExpœe
) == 0) ;

318 
	}
}

322 
	$»memb”SÏveKeyW™hExpœe
(
»disDb
 *
db
, 
robj
 *
key
) {

323 ià(
¦aveKeysW™hExpœe
 =ğ
NULL
) {

324 
diùTy³
 
dt
 = {

325 
diùSdsHash
,

326 
NULL
,

327 
NULL
,

328 
diùSdsKeyCom·»
,

329 
diùSdsDe¡ruùÜ
,

330 
NULL


332 
¦aveKeysW™hExpœe
 = 
	`diùC»©e
(&
dt
,
NULL
);

334 ià(
db
->
id
 > 63) ;

336 
diùEÁry
 *
de
 = 
	`diùAddOrFšd
(
¦aveKeysW™hExpœe
,
key
->
±r
);

341 ià(
de
->
key
 =ğkey->
±r
) {

342 
de
->
key
 = 
	`sdsdup
(key->
±r
);

343 
	`diùS‘UnsigÃdIÁeg”V®
(
de
,0);

346 
ušt64_t
 
dbids
 = 
	`diùG‘UnsigÃdIÁeg”V®
(
de
);

347 
dbids
 |ğ(
ušt64_t
)1 << 
db
->
id
;

348 
	`diùS‘UnsigÃdIÁeg”V®
(
de
,
dbids
);

349 
	}
}

352 
size_t
 
	$g‘SÏveKeyW™hExpœeCouÁ
() {

353 ià(
¦aveKeysW™hExpœe
 =ğ
NULL
)  0;

354  
	`diùSize
(
¦aveKeysW™hExpœe
);

355 
	}
}

365 
	$æushSÏveKeysW™hExpœeLi¡
() {

366 ià(
¦aveKeysW™hExpœe
) {

367 
	`diùR–—£
(
¦aveKeysW™hExpœe
);

368 
¦aveKeysW™hExpœe
 = 
NULL
;

370 
	}
}

383 
	$expœeG’”icCommªd
(
ş›Á
 *
c
, 
ba£time
, 
un™
) {

384 
robj
 *
key
 = 
c
->
¬gv
[1], *
·¿m
 = c->argv[2];

385 
wh’
;

387 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, 
·¿m
, &
wh’
, 
NULL
è!ğ
C_OK
)

390 ià(
un™
 =ğ
UNIT_SECONDS
è
wh’
 *= 1000;

391 
wh’
 +ğ
ba£time
;

394 ià(
	`lookupKeyWr™e
(
c
->
db
,
key
è=ğ
NULL
) {

395 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

405 ià(
wh’
 <ğ
	`m¡ime
(è&& !
£rv”
.
lßdšg
 && !£rv”.
ma¡”ho¡
) {

406 
robj
 *
aux
;

408 
d–‘ed
 = 
£rv”
.
Ïzyä“_Ïzy_expœe
 ? 
	`dbAsyncD–‘e
(
c
->
db
,
key
) :

409 
	`dbSyncD–‘e
(
c
->
db
,
key
);

410 
	`£rv”As£¹W™hInfo
(
c
,
key
,
d–‘ed
);

411 
£rv”
.
dœty
++;

414 
aux
 = 
£rv”
.
Ïzyä“_Ïzy_expœe
 ? 
sh¬ed
.
uÆšk
 : sh¬ed.
d–
;

415 
	`»wr™eCl›ÁCommªdVeùÜ
(
c
,2,
aux
,
key
);

416 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

417 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
key
,
c
->
db
->
id
);

418 
	`addR•ly
(
c
, 
sh¬ed
.
cÚe
);

421 
	`£tExpœe
(
c
,c->
db
,
key
,
wh’
);

422 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

423 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

424 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"expœe",
key
,
c
->
db
->
id
);

425 
£rv”
.
dœty
++;

428 
	}
}

431 
	$expœeCommªd
(
ş›Á
 *
c
) {

432 
	`expœeG’”icCommªd
(
c
,
	`m¡ime
(),
UNIT_SECONDS
);

433 
	}
}

436 
	$expœ—tCommªd
(
ş›Á
 *
c
) {

437 
	`expœeG’”icCommªd
(
c
,0,
UNIT_SECONDS
);

438 
	}
}

441 
	$³xpœeCommªd
(
ş›Á
 *
c
) {

442 
	`expœeG’”icCommªd
(
c
,
	`m¡ime
(),
UNIT_MILLISECONDS
);

443 
	}
}

446 
	$³xpœ—tCommªd
(
ş›Á
 *
c
) {

447 
	`expœeG’”icCommªd
(
c
,0,
UNIT_MILLISECONDS
);

448 
	}
}

451 
	$‰lG’”icCommªd
(
ş›Á
 *
c
, 
ouut_ms
) {

452 
expœe
, 
‰l
 = -1;

455 ià(
	`lookupKeyR—dW™hFÏgs
(
c
->
db
,c->
¬gv
[1],
LOOKUP_NOTOUCH
è=ğ
NULL
) {

456 
	`addR•lyLÚgLÚg
(
c
,-2);

461 
expœe
 = 
	`g‘Expœe
(
c
->
db
,c->
¬gv
[1]);

462 ià(
expœe
 != -1) {

463 
‰l
 = 
expœe
-
	`m¡ime
();

464 ià(
‰l
 < 0)tl = 0;

466 ià(
‰l
 == -1) {

467 
	`addR•lyLÚgLÚg
(
c
,-1);

469 
	`addR•lyLÚgLÚg
(
c
,
ouut_ms
 ? 
‰l
 : ((ttl+500)/1000));

471 
	}
}

474 
	$‰lCommªd
(
ş›Á
 *
c
) {

475 
	`‰lG’”icCommªd
(
c
, 0);

476 
	}
}

479 
	$±Commªd
(
ş›Á
 *
c
) {

480 
	`‰lG’”icCommªd
(
c
, 1);

481 
	}
}

484 
	$³rsi¡Commªd
(
ş›Á
 *
c
) {

485 ià(
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1])) {

486 ià(
	`»moveExpœe
(
c
->
db
,c->
¬gv
[1])) {

487 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

488 
£rv”
.
dœty
++;

490 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

493 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

495 
	}
}

498 
	$touchCommªd
(
ş›Á
 *
c
) {

499 
touched
 = 0;

500 
j
 = 1; j < 
c
->
¬gc
; j++)

501 ià(
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
j
]è!ğ
NULL
è
touched
++;

502 
	`addR•lyLÚgLÚg
(
c
,
touched
);

503 
	}
}

	@fmacros.h

30 #iâdeà
_REDIS_FMACRO_H


31 
	#_REDIS_FMACRO_H


	)

33 
	#_BSD_SOURCE


	)

35 #ià
defšed
(
__lšux__
)

36 
	#_GNU_SOURCE


	)

37 
	#_DEFAULT_SOURCE


	)

40 #ià
defšed
(
_AIX
)

41 
	#_ALL_SOURCE


	)

44 #ià
defšed
(
__lšux__
è|| defšed(
__O³nBSD__
)

45 
	#_XOPEN_SOURCE
 700

	)

50 #–ià!
defšed
(
__N‘BSD__
)

51 
	#_XOPEN_SOURCE


	)

54 #ià
defšed
(
__sun
)

55 
	#_POSIX_C_SOURCE
 199506L

	)

58 
	#_LARGEFILE_SOURCE


	)

59 
	#_FILE_OFFSET_BITS
 64

	)

	@geo.c

31 
	~"geo.h
"

32 
	~"geohash_h–³r.h
"

33 
	~"debugmaüo.h
"

37 *
zzlFœ¡InRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
);

38 
z¦V®ueL‹Max
(
v®ue
, 
z¿nge¥ec
 *
¥ec
);

53 
geoA¼ay
 *
	$geoA¼ayC»©e
() {

54 
geoA¼ay
 *
ga
 = 
	`zm®loc
((*ga));

56 
ga
->
¬¿y
 = 
NULL
;

57 
ga
->
buck‘s
 = 0;

58 
ga
->
u£d
 = 0;

59  
ga
;

60 
	}
}

64 
geoPošt
 *
	$geoA¼ayAµ’d
(
geoA¼ay
 *
ga
) {

65 ià(
ga
->
u£d
 =ğga->
buck‘s
) {

66 
ga
->
buck‘s
 = (ga->buckets == 0) ? 8 : ga->buckets*2;

67 
ga
->
¬¿y
 = 
	`z»®loc
(ga->¬¿y,(
geoPošt
)*ga->
buck‘s
);

69 
geoPošt
 *
gp
 = 
ga
->
¬¿y
+ga->
u£d
;

70 
ga
->
u£d
++;

71  
gp
;

72 
	}
}

75 
	$geoA¼ayF»e
(
geoA¼ay
 *
ga
) {

76 
size_t
 
i
;

77 
i
 = 0; i < 
ga
->
u£d
; i++è
	`sdsä“
(ga->
¬¿y
[i].
memb”
);

78 
	`zä“
(
ga
->
¬¿y
);

79 
	`zä“
(
ga
);

80 
	}
}

85 
	$decodeGeohash
(
b™s
, *
xy
) {

86 
GeoHashB™s
 
hash
 = { .
b™s
 = (
ušt64_t
)b™s, .
¡•
 = 
GEO_STEP_MAX
 };

87  
	`geohashDecodeToLÚgL©WGS84
(
hash
, 
xy
);

88 
	}
}

93 
	$exŒaùLÚgL©OrR•ly
(
ş›Á
 *
c
, 
robj
 **
¬gv
, *
xy
) {

94 
i
;

95 
i
 = 0; i < 2; i++) {

96 ià(
	`g‘DoubËFromObjeùOrR•ly
(
c
, 
¬gv
[
i
], 
xy
 + i, 
NULL
) !=

97 
C_OK
) {

98  
C_ERR
;

101 ià(
xy
[0] < 
GEO_LONG_MIN
 || xy[0] > 
GEO_LONG_MAX
 ||

102 
xy
[1] < 
GEO_LAT_MIN
 || xy[1] > 
GEO_LAT_MAX
) {

103 
	`addR•lySds
(
c
, 
	`sdsÿrštf
(
	`sd£m±y
(),

104 "-ERR inv®id†Úg™ude,Ït™ud·œ %f,%f\r\n",
xy
[0],xy[1]));

105  
C_ERR
;

107  
C_OK
;

108 
	}
}

113 
	$lÚgL©FromMemb”
(
robj
 *
zobj
,„obj *
memb”
, *
xy
) {

114 
scÜe
 = 0;

116 ià(
	`z£tScÜe
(
zobj
, 
memb”
->
±r
, &
scÜe
è=ğ
C_ERR
)  C_ERR;

117 ià(!
	`decodeGeohash
(
scÜe
, 
xy
)è 
C_ERR
;

118  
C_OK
;

119 
	}
}

127 
	$exŒaùUn™OrR•ly
(
ş›Á
 *
c
, 
robj
 *
un™
) {

128 *
u
 = 
un™
->
±r
;

130 ià(!
	`¡rcmp
(
u
, "m")) {

132 } ià(!
	`¡rcmp
(
u
, "km")) {

134 } ià(!
	`¡rcmp
(
u
, "ft")) {

136 } ià(!
	`¡rcmp
(
u
, "mi")) {

139 
	`addR•lyE¼Ü
(
c
,

143 
	}
}

152 
	$exŒaùDi¡ªûOrR•ly
(
ş›Á
 *
c
, 
robj
 **
¬gv
,

153 *
cÚv”siÚ
) {

154 
di¡ªû
;

155 ià(
	`g‘DoubËFromObjeùOrR•ly
(
c
, 
¬gv
[0], &
di¡ªû
,

156 "Ãed‚um”iø¿dius"è!ğ
C_OK
) {

160 ià(
di¡ªû
 < 0) {

161 
	`addR•lyE¼Ü
(
c
,"radius cannot be‚egative");

165 
to_m‘”s
 = 
	`exŒaùUn™OrR•ly
(
c
,
¬gv
[1]);

166 ià(
to_m‘”s
 < 0) {

170 ià(
cÚv”siÚ
è*cÚv”siÚ = 
to_m‘”s
;

171  
di¡ªû
 * 
to_m‘”s
;

172 
	}
}

179 
	$addR•lyDoubËDi¡ªû
(
ş›Á
 *
c
, 
d
) {

180 
dbuf
[128];

181 
dËn
 = 
	`¢´štf
(
dbuf
, (dbuf), "%.4f", 
d
);

182 
	`addR•lyBulkCBufãr
(
c
, 
dbuf
, 
dËn
);

183 
	}
}

191 
	$geoAµ’dIfW™hšRadius
(
geoA¼ay
 *
ga
, 
lÚ
, 
Ït
, 
¿dius
, 
scÜe
, 
sds
 
memb”
) {

192 
di¡ªû
, 
xy
[2];

194 ià(!
	`decodeGeohash
(
scÜe
,
xy
)è 
C_ERR
;

197 ià(!
	`geohashG‘Di¡ªûIfInRadiusWGS84
(
lÚ
,
Ït
, 
xy
[0], xy[1],

198 
¿dius
, &
di¡ªû
))

200  
C_ERR
;

204 
geoPošt
 *
gp
 = 
	`geoA¼ayAµ’d
(
ga
);

205 
gp
->
lÚg™ude
 = 
xy
[0];

206 
gp
->
Ït™ude
 = 
xy
[1];

207 
gp
->
di¡
 = 
di¡ªû
;

208 
gp
->
memb”
 = member;

209 
gp
->
scÜe
 = score;

210  
C_OK
;

211 
	}
}

225 
	$geoG‘PoštsInRªge
(
robj
 *
zobj
, 
mš
, 
max
, 
lÚ
, 
Ït
, 
¿dius
, 
geoA¼ay
 *
ga
) {

228 
z¿nge¥ec
 
¿nge
 = { .
mš
 = mš, .
max
 = max, .
mšex
 = 0, .
maxex
 = 1 };

229 
size_t
 
ÜigšcouÁ
 = 
ga
->
u£d
;

230 
sds
 
memb”
;

232 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

233 *
zl
 = 
zobj
->
±r
;

234 *
•Œ
, *
¥Œ
;

235 *
v¡r
 = 
NULL
;

236 
vËn
 = 0;

237 
vlÚg
 = 0;

238 
scÜe
 = 0;

240 ià((
•Œ
 = 
	`zzlFœ¡InRªge
(
zl
, &
¿nge
)è=ğ
NULL
) {

245 
¥Œ
 = 
	`zli¡Next
(
zl
, 
•Œ
);

246 
•Œ
) {

247 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

250 ià(!
	`z¦V®ueL‹Max
(
scÜe
, &
¿nge
))

254 
	`zli¡G‘
(
•Œ
, &
v¡r
, &
vËn
, &
vlÚg
);

255 
memb”
 = (
v¡r
 =ğ
NULL
è? 
	`sdsäomlÚglÚg
(
vlÚg
) :

256 
	`sd¢ewËn
(
v¡r
,
vËn
);

257 ià(
	`geoAµ’dIfW™hšRadius
(
ga
,
lÚ
,
Ït
,
¿dius
,
scÜe
,
memb”
)

258 =ğ
C_ERR
è
	`sdsä“
(
memb”
);

259 
	`zzlNext
(
zl
, &
•Œ
, &
¥Œ
);

261 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

262 
z£t
 *
zs
 = 
zobj
->
±r
;

263 
zskli¡
 *
z¦
 = 
zs
->zsl;

264 
zskli¡Node
 *
Ê
;

266 ià((
Ê
 = 
	`z¦Fœ¡InRªge
(
z¦
, &
¿nge
)è=ğ
NULL
) {

271 
Ê
) {

272 
sds
 
–e
 = 
Ê
->ele;

274 ià(!
	`z¦V®ueL‹Max
(
Ê
->
scÜe
, &
¿nge
))

277 
–e
 = 
	`sdsdup
(ele);

278 ià(
	`geoAµ’dIfW™hšRadius
(
ga
,
lÚ
,
Ït
,
¿dius
,
Ê
->
scÜe
,
–e
)

279 =ğ
C_ERR
è
	`sdsä“
(
–e
);

280 
Ê
 =†n->
Ëv–
[0].
fÜw¬d
;

283  
ga
->
u£d
 - 
ÜigšcouÁ
;

284 
	}
}

289 
	$scÜesOfGeoHashBox
(
GeoHashB™s
 
hash
, 
GeoHashFix52B™s
 *
mš
, GeoHashFix52B™ *
max
) {

310 *
mš
 = 
	`geohashAlign52B™s
(
hash
);

311 
hash
.
b™s
++;

312 *
max
 = 
	`geohashAlign52B™s
(
hash
);

313 
	}
}

318 
	$memb”sOfGeoHashBox
(
robj
 *
zobj
, 
GeoHashB™s
 
hash
, 
geoA¼ay
 *
ga
, 
lÚ
, 
Ït
, 
¿dius
) {

319 
GeoHashFix52B™s
 
mš
, 
max
;

321 
	`scÜesOfGeoHashBox
(
hash
,&
mš
,&
max
);

322  
	`geoG‘PoštsInRªge
(
zobj
, 
mš
, 
max
, 
lÚ
, 
Ït
, 
¿dius
, 
ga
);

323 
	}
}

326 
	$memb”sOfAÎNeighbÜs
(
robj
 *
zobj
, 
GeoHashRadius
 
n
, 
lÚ
, 
Ït
, 
¿dius
, 
geoA¼ay
 *
ga
) {

327 
GeoHashB™s
 
ÃighbÜs
[9];

328 
i
, 
couÁ
 = 0, 
Ï¡_´oûs£d
 = 0;

329 
debugmsg
 = 0;

331 
ÃighbÜs
[0] = 
n
.
hash
;

332 
ÃighbÜs
[1] = 
n
.ÃighbÜs.
nÜth
;

333 
ÃighbÜs
[2] = 
n
.ÃighbÜs.
south
;

334 
ÃighbÜs
[3] = 
n
.ÃighbÜs.
—¡
;

335 
ÃighbÜs
[4] = 
n
.ÃighbÜs.
we¡
;

336 
ÃighbÜs
[5] = 
n
.ÃighbÜs.
nÜth_—¡
;

337 
ÃighbÜs
[6] = 
n
.ÃighbÜs.
nÜth_we¡
;

338 
ÃighbÜs
[7] = 
n
.ÃighbÜs.
south_—¡
;

339 
ÃighbÜs
[8] = 
n
.ÃighbÜs.
south_we¡
;

343 
i
 = 0; i < (
ÃighbÜs
) / (*neighbors); i++) {

344 ià(
	`HASHISZERO
(
ÃighbÜs
[
i
])) {

345 ià(
debugmsg
è
	`D
("ÃighbÜs[%d] i z”o",
i
);

350 ià(
debugmsg
) {

351 
GeoHashRªge
 
lÚg_¿nge
, 
Ït_¿nge
;

352 
	`geohashG‘CoÜdRªge
(&
lÚg_¿nge
,&
Ït_¿nge
);

353 
GeoHashA»a
 
my¬—
 = {{0}};

354 
	`geohashDecode
(
lÚg_¿nge
, 
Ït_¿nge
, 
ÃighbÜs
[
i
], &
my¬—
);

357 
	`D
("ÃighbÜs[%d]:\n",
i
);

358 
	`D
("¬—.lÚg™ude.mš: %f\n", 
my¬—
.
lÚg™ude
.
mš
);

359 
	`D
("¬—.lÚg™ude.max: %f\n", 
my¬—
.
lÚg™ude
.
max
);

360 
	`D
("¬—.Ït™ude.mš: %f\n", 
my¬—
.
Ït™ude
.
mš
);

361 
	`D
("¬—.Ït™ude.max: %f\n", 
my¬—
.
Ït™ude
.
max
);

362 
	`D
("\n");

369 ià(
Ï¡_´oûs£d
 &&

370 
ÃighbÜs
[
i
].
b™s
 =ğÃighbÜs[
Ï¡_´oûs£d
].bits &&

371 
ÃighbÜs
[
i
].
¡•
 =ğÃighbÜs[
Ï¡_´oûs£d
].step)

373 ià(
debugmsg
)

374 
	`D
("Skpšg…roûssšg oà%d, sama ´evious\n",
i
);

377 
couÁ
 +ğ
	`memb”sOfGeoHashBox
(
zobj
, 
ÃighbÜs
[
i
], 
ga
, 
lÚ
, 
Ït
, 
¿dius
);

378 
Ï¡_´oûs£d
 = 
i
;

380  
couÁ
;

381 
	}
}

384 
	$sÜt_gp_asc
(cÚ¡ *
a
, cÚ¡ *
b
) {

385 cÚ¡ 
geoPošt
 *
g·
 = 
a
, *
gpb
 = 
b
;

388 ià(
g·
->
di¡
 > 
gpb
->dist)

390 ià(
g·
->
di¡
 =ğ
gpb
->dist)

394 
	}
}

396 
	$sÜt_gp_desc
(cÚ¡ *
a
, cÚ¡ *
b
) {

397  -
	`sÜt_gp_asc
(
a
, 
b
);

398 
	}
}

405 
	$geßddCommªd
(
ş›Á
 *
c
) {

407 ià((
c
->
¬gc
 - 2) % 3 != 0) {

409 
	`addR•lyE¼Ü
(
c
, "syntaxƒrror. Try GEOADD key [x1] [y1] [name1] "

414 
–em’ts
 = (
c
->
¬gc
 - 2) / 3;

415 
¬gc
 = 2+
–em’ts
*2;

416 
robj
 **
¬gv
 = 
	`zÿÎoc
(
¬gc
*(robj*));

417 
¬gv
[0] = 
	`ü—‹RawSŒšgObjeù
("zadd",4);

418 
¬gv
[1] = 
c
->argv[1];

419 
	`šüRefCouÁ
(
¬gv
[1]);

424 
i
;

425 
i
 = 0; i < 
–em’ts
; i++) {

426 
xy
[2];

428 ià(
	`exŒaùLÚgL©OrR•ly
(
c
, (c->
¬gv
+2)+(
i
*3),
xy
è=ğ
C_ERR
) {

429 
i
 = 0; i < 
¬gc
; i++)

430 ià(
¬gv
[
i
]è
	`deüRefCouÁ
(argv[i]);

431 
	`zä“
(
¬gv
);

436 
GeoHashB™s
 
hash
;

437 
	`geohashEncodeWGS84
(
xy
[0], xy[1], 
GEO_STEP_MAX
, &
hash
);

438 
GeoHashFix52B™s
 
b™s
 = 
	`geohashAlign52B™s
(
hash
);

439 
robj
 *
scÜe
 = 
	`ü—‹Objeù
(
OBJ_STRING
, 
	`sdsäomlÚglÚg
(
b™s
));

440 
robj
 *
v®
 = 
c
->
¬gv
[2 + 
i
 * 3 + 2];

441 
¬gv
[2+
i
*2] = 
scÜe
;

442 
¬gv
[3+
i
*2] = 
v®
;

443 
	`šüRefCouÁ
(
v®
);

447 
	`»¶aûCl›ÁCommªdVeùÜ
(
c
,
¬gc
,
¬gv
);

448 
	`zaddCommªd
(
c
);

449 
	}
}

451 
	#SORT_NONE
 0

	)

452 
	#SORT_ASC
 1

	)

453 
	#SORT_DESC
 2

	)

455 
	#RADIUS_COORDS
 (1<<0è

	)

456 
	#RADIUS_MEMBER
 (1<<1è

	)

457 
	#RADIUS_NOSTORE
 (1<<2è

	)

462 
	$geÜadiusG’”ic
(
ş›Á
 *
c
, 
æags
) {

463 
robj
 *
key
 = 
c
->
¬gv
[1];

464 
robj
 *
¡Üekey
 = 
NULL
;

465 
¡Üedi¡
 = 0;

468 
robj
 *
zobj
 = 
NULL
;

469 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
, 
key
, 
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL
 ||

470 
	`checkTy³
(
c
, 
zobj
, 
OBJ_ZSET
)) {

475 
ba£_¬gs
;

476 
xy
[2] = { 0 };

477 ià(
æags
 & 
RADIUS_COORDS
) {

478 
ba£_¬gs
 = 6;

479 ià(
	`exŒaùLÚgL©OrR•ly
(
c
, c->
¬gv
 + 2, 
xy
è=ğ
C_ERR
)

481 } ià(
æags
 & 
RADIUS_MEMBER
) {

482 
ba£_¬gs
 = 5;

483 
robj
 *
memb”
 = 
c
->
¬gv
[2];

484 ià(
	`lÚgL©FromMemb”
(
zobj
, 
memb”
, 
xy
è=ğ
C_ERR
) {

485 
	`addR•lyE¼Ü
(
c
, "could‚ot decode„equested zset member");

489 
	`addR•lyE¼Ü
(
c
, "Unknown georadius searchype");

494 
¿dius_m‘”s
 = 0, 
cÚv”siÚ
 = 1;

495 ià((
¿dius_m‘”s
 = 
	`exŒaùDi¡ªûOrR•ly
(
c
, c->
¬gv
 + 
ba£_¬gs
 - 2,

496 &
cÚv”siÚ
)) < 0) {

501 
w™hdi¡
 = 0, 
w™hhash
 = 0, 
w™hcoÜds
 = 0;

502 
sÜt
 = 
SORT_NONE
;

503 
couÁ
 = 0;

504 ià(
c
->
¬gc
 > 
ba£_¬gs
) {

505 
»maššg
 = 
c
->
¬gc
 - 
ba£_¬gs
;

506 
i
 = 0; i < 
»maššg
; i++) {

507 *
¬g
 = 
c
->
¬gv
[
ba£_¬gs
 + 
i
]->
±r
;

508 ià(!
	`¡rÿ£cmp
(
¬g
, "withdist")) {

509 
w™hdi¡
 = 1;

510 } ià(!
	`¡rÿ£cmp
(
¬g
, "withhash")) {

511 
w™hhash
 = 1;

512 } ià(!
	`¡rÿ£cmp
(
¬g
, "withcoord")) {

513 
w™hcoÜds
 = 1;

514 } ià(!
	`¡rÿ£cmp
(
¬g
, "asc")) {

515 
sÜt
 = 
SORT_ASC
;

516 } ià(!
	`¡rÿ£cmp
(
¬g
, "desc")) {

517 
sÜt
 = 
SORT_DESC
;

518 } ià(!
	`¡rÿ£cmp
(
¬g
, "couÁ"è&& (
i
+1è< 
»maššg
) {

519 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
ba£_¬gs
+
i
+1],

520 &
couÁ
, 
NULL
è!ğ
C_OK
) ;

521 ià(
couÁ
 <= 0) {

522 
	`addR•lyE¼Ü
(
c
,"COUNT must be > 0");

525 
i
++;

526 } ià(!
	`¡rÿ£cmp
(
¬g
, "store") &&

527 (
i
+1è< 
»maššg
 &&

528 !(
æags
 & 
RADIUS_NOSTORE
))

530 
¡Üekey
 = 
c
->
¬gv
[
ba£_¬gs
+
i
+1];

531 
¡Üedi¡
 = 0;

532 
i
++;

533 } ià(!
	`¡rÿ£cmp
(
¬g
, "storedist") &&

534 (
i
+1è< 
»maššg
 &&

535 !(
æags
 & 
RADIUS_NOSTORE
))

537 
¡Üekey
 = 
c
->
¬gv
[
ba£_¬gs
+
i
+1];

538 
¡Üedi¡
 = 1;

539 
i
++;

541 
	`addR•ly
(
c
, 
sh¬ed
.
syÁax”r
);

548 ià(
¡Üekey
 && (
w™hdi¡
 || 
w™hhash
 || 
w™hcoÜds
)) {

549 
	`addR•lyE¼Ü
(
c
,

557 ià(
couÁ
 !ğ0 && 
sÜt
 =ğ
SORT_NONE
èsÜˆğ
SORT_ASC
;

560 
GeoHashRadius
 
geÜadius
 =

561 
	`geohashG‘A»asByRadiusWGS84
(
xy
[0], xy[1], 
¿dius_m‘”s
);

564 
geoA¼ay
 *
ga
 = 
	`geoA¼ayC»©e
();

565 
	`memb”sOfAÎNeighbÜs
(
zobj
, 
geÜadius
, 
xy
[0], xy[1], 
¿dius_m‘”s
, 
ga
);

568 ià(
ga
->
u£d
 =ğ0 && 
¡Üekey
 =ğ
NULL
) {

569 
	`addR•ly
(
c
, 
sh¬ed
.
em±ymuÉibulk
);

570 
	`geoA¼ayF»e
(
ga
);

574 
»suÉ_Ëngth
 = 
ga
->
u£d
;

575 
»tuºed_™ems
 = (
couÁ
 =ğ0 || 
»suÉ_Ëngth
 < count) ?

576 
»suÉ_Ëngth
 : 
couÁ
;

577 
İtiÚ_Ëngth
 = 0;

580 ià(
sÜt
 =ğ
SORT_ASC
) {

581 
	`qsÜt
(
ga
->
¬¿y
, 
»suÉ_Ëngth
, (
geoPošt
), 
sÜt_gp_asc
);

582 } ià(
sÜt
 =ğ
SORT_DESC
) {

583 
	`qsÜt
(
ga
->
¬¿y
, 
»suÉ_Ëngth
, (
geoPošt
), 
sÜt_gp_desc
);

586 ià(
¡Üekey
 =ğ
NULL
) {

591 ià(
w™hdi¡
)

592 
İtiÚ_Ëngth
++;

594 ià(
w™hcoÜds
)

595 
İtiÚ_Ëngth
++;

597 ià(
w™hhash
)

598 
İtiÚ_Ëngth
++;

604 
	`addR•lyMuÉiBulkL’
(
c
, 
»tuºed_™ems
);

607 
i
;

608 
i
 = 0; i < 
»tuºed_™ems
; i++) {

609 
geoPošt
 *
gp
 = 
ga
->
¬¿y
+
i
;

610 
gp
->
di¡
 /ğ
cÚv”siÚ
;

615 ià(
İtiÚ_Ëngth
)

616 
	`addR•lyMuÉiBulkL’
(
c
, 
İtiÚ_Ëngth
 + 1);

618 
	`addR•lyBulkSds
(
c
,
gp
->
memb”
);

619 
gp
->
memb”
 = 
NULL
;

621 ià(
w™hdi¡
)

622 
	`addR•lyDoubËDi¡ªû
(
c
, 
gp
->
di¡
);

624 ià(
w™hhash
)

625 
	`addR•lyLÚgLÚg
(
c
, 
gp
->
scÜe
);

627 ià(
w™hcoÜds
) {

628 
	`addR•lyMuÉiBulkL’
(
c
, 2);

629 
	`addR•lyHumªLÚgDoubË
(
c
, 
gp
->
lÚg™ude
);

630 
	`addR•lyHumªLÚgDoubË
(
c
, 
gp
->
Ït™ude
);

635 
robj
 *
zobj
;

636 
z£t
 *
zs
;

637 
i
;

638 
size_t
 
max––’
 = 0;

640 ià(
»tuºed_™ems
) {

641 
zobj
 = 
	`ü—‹Z£tObjeù
();

642 
zs
 = 
zobj
->
±r
;

645 
i
 = 0; i < 
»tuºed_™ems
; i++) {

646 
zskli¡Node
 *
znode
;

647 
geoPošt
 *
gp
 = 
ga
->
¬¿y
+
i
;

648 
gp
->
di¡
 /ğ
cÚv”siÚ
;

649 
scÜe
 = 
¡Üedi¡
 ? 
gp
->
di¡
 : gp->score;

650 
size_t
 
––’
 = 
	`sd¦’
(
gp
->
memb”
);

652 ià(
max––’
 < 
––’
) maxelelen =ƒlelen;

653 
znode
 = 
	`z¦In£¹
(
zs
->
z¦
,
scÜe
,
gp
->
memb”
);

654 
	`£rv”As£¹
(
	`diùAdd
(
zs
->
diù
,
gp
->
memb”
,&
znode
->
scÜe
è=ğ
DICT_OK
);

655 
gp
->
memb”
 = 
NULL
;

658 ià(
»tuºed_™ems
) {

659 
	`z£tCÚv”tToZli¡IfN“ded
(
zobj
,
max––’
);

660 
	`£tKey
(
c
->
db
,
¡Üekey
,
zobj
);

661 
	`deüRefCouÁ
(
zobj
);

662 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"geÜadius¡Üe",
¡Üekey
,

663 
c
->
db
->
id
);

664 
£rv”
.
dœty
 +ğ
»tuºed_™ems
;

665 } ià(
	`dbD–‘e
(
c
->
db
,
¡Üekey
)) {

666 
	`sigÇlModif›dKey
(
c
->
db
,
¡Üekey
);

667 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
¡Üekey
,
c
->
db
->
id
);

668 
£rv”
.
dœty
++;

670 
	`addR•lyLÚgLÚg
(
c
, 
»tuºed_™ems
);

672 
	`geoA¼ayF»e
(
ga
);

673 
	}
}

676 
	$geÜadiusCommªd
(
ş›Á
 *
c
) {

677 
	`geÜadiusG’”ic
(
c
, 
RADIUS_COORDS
);

678 
	}
}

681 
	$geÜadiusbymemb”Commªd
(
ş›Á
 *
c
) {

682 
	`geÜadiusG’”ic
(
c
, 
RADIUS_MEMBER
);

683 
	}
}

686 
	$geÜadiu¤oCommªd
(
ş›Á
 *
c
) {

687 
	`geÜadiusG’”ic
(
c
, 
RADIUS_COORDS
|
RADIUS_NOSTORE
);

688 
	}
}

691 
	$geÜadiusbymemb”roCommªd
(
ş›Á
 *
c
) {

692 
	`geÜadiusG’”ic
(
c
, 
RADIUS_MEMBER
|
RADIUS_NOSTORE
);

693 
	}
}

699 
	$geohashCommªd
(
ş›Á
 *
c
) {

700 *
geßÍhab‘
= "0123456789bcdefghjkmnpqrstuvwxyz";

701 
j
;

704 
robj
 *
zobj
 = 
	`lookupKeyR—d
(
c
->
db
, c->
¬gv
[1]);

705 ià(
zobj
 && 
	`checkTy³
(
c
, zobj, 
OBJ_ZSET
)) ;

709 
	`addR•lyMuÉiBulkL’
(
c
,c->
¬gc
-2);

710 
j
 = 2; j < 
c
->
¬gc
; j++) {

711 
scÜe
;

712 ià(!
zobj
 || 
	`z£tScÜe
(zobj, 
c
->
¬gv
[
j
]->
±r
, &
scÜe
è=ğ
C_ERR
) {

713 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

722 
xy
[2];

723 ià(!
	`decodeGeohash
(
scÜe
,
xy
)) {

724 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

729 
GeoHashRªge
 
r
[2];

730 
GeoHashB™s
 
hash
;

731 
r
[0].
mš
 = -180;

732 
r
[0].
max
 = 180;

733 
r
[1].
mš
 = -90;

734 
r
[1].
max
 = 90;

735 
	`geohashEncode
(&
r
[0],&r[1],
xy
[0],xy[1],26,&
hash
);

737 
buf
[12];

738 
i
;

739 
i
 = 0; i < 11; i++) {

740 
idx
 = (
hash
.
b™s
 >> (52-((
i
+1)*5))) & 0x1f;

741 
buf
[
i
] = 
geßÍhab‘
[
idx
];

743 
buf
[11] = '\0';

744 
	`addR•lyBulkCBufãr
(
c
,
buf
,11);

747 
	}
}

753 
	$geİosCommªd
(
ş›Á
 *
c
) {

754 
j
;

757 
robj
 *
zobj
 = 
	`lookupKeyR—d
(
c
->
db
, c->
¬gv
[1]);

758 ià(
zobj
 && 
	`checkTy³
(
c
, zobj, 
OBJ_ZSET
)) ;

762 
	`addR•lyMuÉiBulkL’
(
c
,c->
¬gc
-2);

763 
j
 = 2; j < 
c
->
¬gc
; j++) {

764 
scÜe
;

765 ià(!
zobj
 || 
	`z£tScÜe
(zobj, 
c
->
¬gv
[
j
]->
±r
, &
scÜe
è=ğ
C_ERR
) {

766 
	`addR•ly
(
c
,
sh¬ed
.
nuÎmuÉibulk
);

769 
xy
[2];

770 ià(!
	`decodeGeohash
(
scÜe
,
xy
)) {

771 
	`addR•ly
(
c
,
sh¬ed
.
nuÎmuÉibulk
);

774 
	`addR•lyMuÉiBulkL’
(
c
,2);

775 
	`addR•lyHumªLÚgDoubË
(
c
,
xy
[0]);

776 
	`addR•lyHumªLÚgDoubË
(
c
,
xy
[1]);

779 
	}
}

786 
	$geodi¡Commªd
(
ş›Á
 *
c
) {

787 
to_m‘”
 = 1;

790 ià(
c
->
¬gc
 == 5) {

791 
to_m‘”
 = 
	`exŒaùUn™OrR•ly
(
c
,c->
¬gv
[4]);

792 ià(
to_m‘”
 < 0) ;

793 } ià(
c
->
¬gc
 > 5) {

794 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

799 
robj
 *
zobj
 = 
NULL
;

800 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
, c->
¬gv
[1], 
sh¬ed
.
nuÎbulk
))

801 =ğ
NULL
 || 
	`checkTy³
(
c
, 
zobj
, 
OBJ_ZSET
)) ;

804 
scÜe1
, 
scÜe2
, 
xyxy
[4];

805 ià(
	`z£tScÜe
(
zobj
, 
c
->
¬gv
[2]->
±r
, &
scÜe1
è=ğ
C_ERR
 ||

806 
	`z£tScÜe
(
zobj
, 
c
->
¬gv
[3]->
±r
, &
scÜe2
è=ğ
C_ERR
)

808 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

813 ià(!
	`decodeGeohash
(
scÜe1
,
xyxy
è|| !decodeGeohash(
scÜe2
,xyxy+2))

814 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

816 
	`addR•lyDoubËDi¡ªû
(
c
,

817 
	`geohashG‘Di¡ªû
(
xyxy
[0],xyxy[1],xyxy[2],xyxy[3]è/ 
to_m‘”
);

818 
	}
}

	@geo.h

1 #iâdeà
__GEO_H__


2 
	#__GEO_H__


	)

4 
	~"£rv”.h
"

8 
	sgeoPošt
 {

9 
	mlÚg™ude
;

10 
	mÏt™ude
;

11 
	mdi¡
;

12 
	mscÜe
;

13 *
	mmemb”
;

14 } 
	tgeoPošt
;

16 
	sgeoA¼ay
 {

17 
geoPošt
 *
	m¬¿y
;

18 
size_t
 
	mbuck‘s
;

19 
size_t
 
	mu£d
;

20 } 
	tgeoA¼ay
;

	@geohash.c

31 
	~"geohash.h
"

52 
šlše
 
ušt64_t
 
	$š‹¾—ve64
(
ušt32_t
 
xlo
, ušt32_ˆ
ylo
) {

53 cÚ¡ 
ušt64_t
 
B
[] = {0x5555555555555555ULL, 0x3333333333333333ULL,

56 cÚ¡ 
S
[] = {1, 2, 4, 8, 16};

58 
ušt64_t
 
x
 = 
xlo
;

59 
ušt64_t
 
y
 = 
ylo
;

61 
x
 = (x | (x << 
S
[4])è& 
B
[4];

62 
y
 = (y | (y << 
S
[4])è& 
B
[4];

64 
x
 = (x | (x << 
S
[3])è& 
B
[3];

65 
y
 = (y | (y << 
S
[3])è& 
B
[3];

67 
x
 = (x | (x << 
S
[2])è& 
B
[2];

68 
y
 = (y | (y << 
S
[2])è& 
B
[2];

70 
x
 = (x | (x << 
S
[1])è& 
B
[1];

71 
y
 = (y | (y << 
S
[1])è& 
B
[1];

73 
x
 = (x | (x << 
S
[0])è& 
B
[0];

74 
y
 = (y | (y << 
S
[0])è& 
B
[0];

76  
x
 | (
y
 << 1);

77 
	}
}

82 
šlše
 
ušt64_t
 
	$deš‹¾—ve64
(
ušt64_t
 
š‹¾—ved
) {

83 cÚ¡ 
ušt64_t
 
B
[] = {0x5555555555555555ULL, 0x3333333333333333ULL,

86 cÚ¡ 
S
[] = {0, 1, 2, 4, 8, 16};

88 
ušt64_t
 
x
 = 
š‹¾—ved
;

89 
ušt64_t
 
y
 = 
š‹¾—ved
 >> 1;

91 
x
 = (x | (x >> 
S
[0])è& 
B
[0];

92 
y
 = (y | (y >> 
S
[0])è& 
B
[0];

94 
x
 = (x | (x >> 
S
[1])è& 
B
[1];

95 
y
 = (y | (y >> 
S
[1])è& 
B
[1];

97 
x
 = (x | (x >> 
S
[2])è& 
B
[2];

98 
y
 = (y | (y >> 
S
[2])è& 
B
[2];

100 
x
 = (x | (x >> 
S
[3])è& 
B
[3];

101 
y
 = (y | (y >> 
S
[3])è& 
B
[3];

103 
x
 = (x | (x >> 
S
[4])è& 
B
[4];

104 
y
 = (y | (y >> 
S
[4])è& 
B
[4];

106 
x
 = (x | (x >> 
S
[5])è& 
B
[5];

107 
y
 = (y | (y >> 
S
[5])è& 
B
[5];

109  
x
 | (
y
 << 32);

110 
	}
}

112 
	$geohashG‘CoÜdRªge
(
GeoHashRªge
 *
lÚg_¿nge
, GeoHashRªg*
Ït_¿nge
) {

115 
lÚg_¿nge
->
max
 = 
GEO_LONG_MAX
;

116 
lÚg_¿nge
->
mš
 = 
GEO_LONG_MIN
;

117 
Ït_¿nge
->
max
 = 
GEO_LAT_MAX
;

118 
Ït_¿nge
->
mš
 = 
GEO_LAT_MIN
;

119 
	}
}

121 
	$geohashEncode
(cÚ¡ 
GeoHashRªge
 *
lÚg_¿nge
, cÚ¡ GeoHashRªg*
Ït_¿nge
,

122 
lÚg™ude
, 
Ït™ude
, 
ušt8_t
 
¡•
,

123 
GeoHashB™s
 *
hash
) {

125 ià(
hash
 =ğ
NULL
 || 
¡•
 > 32 || step == 0 ||

126 
	`RANGEPISZERO
(
Ït_¿nge
è|| RANGEPISZERO(
lÚg_¿nge
))  0;

130 ià(
lÚg™ude
 > 180 ||†ongitude < -180 ||

131 
Ït™ude
 > 85.05112878 ||†atitude < -85.05112878)  0;

133 
hash
->
b™s
 = 0;

134 
hash
->
¡•
 = step;

136 ià(
Ït™ude
 < 
Ït_¿nge
->
mš
 ||†©™ud>†©_¿nge->
max
 ||

137 
lÚg™ude
 < 
lÚg_¿nge
->
mš
 ||†Úg™ud>†Úg_¿nge->
max
) {

141 
Ït_off£t
 =

142 (
Ït™ude
 - 
Ït_¿nge
->
mš
è/ (Ït_¿nge->
max
 -†at_range->min);

143 
lÚg_off£t
 =

144 (
lÚg™ude
 - 
lÚg_¿nge
->
mš
è/ (lÚg_¿nge->
max
 -†ong_range->min);

147 
Ït_off£t
 *ğ(1 << 
¡•
);

148 
lÚg_off£t
 *ğ(1 << 
¡•
);

149 
hash
->
b™s
 = 
	`š‹¾—ve64
(
Ït_off£t
, 
lÚg_off£t
);

151 
	}
}

153 
	$geohashEncodeTy³
(
lÚg™ude
, 
Ït™ude
, 
ušt8_t
 
¡•
, 
GeoHashB™s
 *
hash
) {

154 
GeoHashRªge
 
r
[2] = {{0}};

155 
	`geohashG‘CoÜdRªge
(&
r
[0], &r[1]);

156  
	`geohashEncode
(&
r
[0], &r[1], 
lÚg™ude
, 
Ït™ude
, 
¡•
, 
hash
);

157 
	}
}

159 
	$geohashEncodeWGS84
(
lÚg™ude
, 
Ït™ude
, 
ušt8_t
 
¡•
,

160 
GeoHashB™s
 *
hash
) {

161  
	`geohashEncodeTy³
(
lÚg™ude
, 
Ït™ude
, 
¡•
, 
hash
);

162 
	}
}

164 
	$geohashDecode
(cÚ¡ 
GeoHashRªge
 
lÚg_¿nge
, cÚ¡ GeoHashRªg
Ït_¿nge
,

165 cÚ¡ 
GeoHashB™s
 
hash
, 
GeoHashA»a
 *
¬—
) {

166 ià(
	`HASHISZERO
(
hash
è|| 
NULL
 =ğ
¬—
 || 
	`RANGEISZERO
(
Ït_¿nge
) ||

167 
	`RANGEISZERO
(
lÚg_¿nge
)) {

171 
¬—
->
hash
 = hash;

172 
ušt8_t
 
¡•
 = 
hash
.step;

173 
ušt64_t
 
hash_£p
 = 
	`deš‹¾—ve64
(
hash
.
b™s
);

175 
Ït_sÿË
 = 
Ït_¿nge
.
max
 -†©_¿nge.
mš
;

176 
lÚg_sÿË
 = 
lÚg_¿nge
.
max
 -†Úg_¿nge.
mš
;

178 
ušt32_t
 
©o
 = 
hash_£p
;

179 
ušt32_t
 
Úo
 = 
hash_£p
 >> 32;

184 
¬—
->
Ït™ude
.
mš
 =

185 
Ït_¿nge
.
mš
 + (
©o
 * 1.0 / (1uÎ << 
¡•
)è* 
Ït_sÿË
;

186 
¬—
->
Ït™ude
.
max
 =

187 
Ït_¿nge
.
mš
 + ((
©o
 + 1è* 1.0 / (1uÎ << 
¡•
)è* 
Ït_sÿË
;

188 
¬—
->
lÚg™ude
.
mš
 =

189 
lÚg_¿nge
.
mš
 + (
Úo
 * 1.0 / (1uÎ << 
¡•
)è* 
lÚg_sÿË
;

190 
¬—
->
lÚg™ude
.
max
 =

191 
lÚg_¿nge
.
mš
 + ((
Úo
 + 1è* 1.0 / (1uÎ << 
¡•
)è* 
lÚg_sÿË
;

194 
	}
}

196 
	$geohashDecodeTy³
(cÚ¡ 
GeoHashB™s
 
hash
, 
GeoHashA»a
 *
¬—
) {

197 
GeoHashRªge
 
r
[2] = {{0}};

198 
	`geohashG‘CoÜdRªge
(&
r
[0], &r[1]);

199  
	`geohashDecode
(
r
[0],„[1], 
hash
, 
¬—
);

200 
	}
}

202 
	$geohashDecodeWGS84
(cÚ¡ 
GeoHashB™s
 
hash
, 
GeoHashA»a
 *
¬—
) {

203  
	`geohashDecodeTy³
(
hash
, 
¬—
);

204 
	}
}

206 
	$geohashDecodeA»aToLÚgL©
(cÚ¡ 
GeoHashA»a
 *
¬—
, *
xy
) {

207 ià(!
xy
)  0;

208 
xy
[0] = (
¬—
->
lÚg™ude
.
mš
 +‡»a->lÚg™ude.
max
) / 2;

209 
xy
[1] = (
¬—
->
Ït™ude
.
mš
 +‡»a->Ït™ude.
max
) / 2;

211 
	}
}

213 
	$geohashDecodeToLÚgL©Ty³
(cÚ¡ 
GeoHashB™s
 
hash
, *
xy
) {

214 
GeoHashA»a
 
¬—
 = {{0}};

215 ià(!
xy
 || !
	`geohashDecodeTy³
(
hash
, &
¬—
))

217  
	`geohashDecodeA»aToLÚgL©
(&
¬—
, 
xy
);

218 
	}
}

220 
	$geohashDecodeToLÚgL©WGS84
(cÚ¡ 
GeoHashB™s
 
hash
, *
xy
) {

221  
	`geohashDecodeToLÚgL©Ty³
(
hash
, 
xy
);

222 
	}
}

224 
	$geohash_move_x
(
GeoHashB™s
 *
hash
, 
št8_t
 
d
) {

225 ià(
d
 == 0)

228 
ušt64_t
 
x
 = 
hash
->
b™s
 & 0xaaaaaaaaaaaaaaaaULL;

229 
ušt64_t
 
y
 = 
hash
->
b™s
 & 0x5555555555555555ULL;

231 
ušt64_t
 
zz
 = 0x5555555555555555ULL >> (64 - 
hash
->
¡•
 * 2);

233 ià(
d
 > 0) {

234 
x
 = x + (
zz
 + 1);

236 
x
 = x | 
zz
;

237 
x
 = x - (
zz
 + 1);

240 
x
 &ğ(0x¯¯¯¯¯¯¯¯ULL >> (64 - 
hash
->
¡•
 * 2));

241 
hash
->
b™s
 = (
x
 | 
y
);

242 
	}
}

244 
	$geohash_move_y
(
GeoHashB™s
 *
hash
, 
št8_t
 
d
) {

245 ià(
d
 == 0)

248 
ušt64_t
 
x
 = 
hash
->
b™s
 & 0xaaaaaaaaaaaaaaaaULL;

249 
ušt64_t
 
y
 = 
hash
->
b™s
 & 0x5555555555555555ULL;

251 
ušt64_t
 
zz
 = 0x¯¯¯¯¯¯¯¯ULL >> (64 - 
hash
->
¡•
 * 2);

252 ià(
d
 > 0) {

253 
y
 = y + (
zz
 + 1);

255 
y
 = y | 
zz
;

256 
y
 = y - (
zz
 + 1);

258 
y
 &ğ(0x5555555555555555ULL >> (64 - 
hash
->
¡•
 * 2));

259 
hash
->
b™s
 = (
x
 | 
y
);

260 
	}
}

262 
	$geohashNeighbÜs
(cÚ¡ 
GeoHashB™s
 *
hash
, 
GeoHashNeighbÜs
 *
ÃighbÜs
) {

263 
ÃighbÜs
->
—¡
 = *
hash
;

264 
ÃighbÜs
->
we¡
 = *
hash
;

265 
ÃighbÜs
->
nÜth
 = *
hash
;

266 
ÃighbÜs
->
south
 = *
hash
;

267 
ÃighbÜs
->
south_—¡
 = *
hash
;

268 
ÃighbÜs
->
south_we¡
 = *
hash
;

269 
ÃighbÜs
->
nÜth_—¡
 = *
hash
;

270 
ÃighbÜs
->
nÜth_we¡
 = *
hash
;

272 
	`geohash_move_x
(&
ÃighbÜs
->
—¡
, 1);

273 
	`geohash_move_y
(&
ÃighbÜs
->
—¡
, 0);

275 
	`geohash_move_x
(&
ÃighbÜs
->
we¡
, -1);

276 
	`geohash_move_y
(&
ÃighbÜs
->
we¡
, 0);

278 
	`geohash_move_x
(&
ÃighbÜs
->
south
, 0);

279 
	`geohash_move_y
(&
ÃighbÜs
->
south
, -1);

281 
	`geohash_move_x
(&
ÃighbÜs
->
nÜth
, 0);

282 
	`geohash_move_y
(&
ÃighbÜs
->
nÜth
, 1);

284 
	`geohash_move_x
(&
ÃighbÜs
->
nÜth_we¡
, -1);

285 
	`geohash_move_y
(&
ÃighbÜs
->
nÜth_we¡
, 1);

287 
	`geohash_move_x
(&
ÃighbÜs
->
nÜth_—¡
, 1);

288 
	`geohash_move_y
(&
ÃighbÜs
->
nÜth_—¡
, 1);

290 
	`geohash_move_x
(&
ÃighbÜs
->
south_—¡
, 1);

291 
	`geohash_move_y
(&
ÃighbÜs
->
south_—¡
, -1);

293 
	`geohash_move_x
(&
ÃighbÜs
->
south_we¡
, -1);

294 
	`geohash_move_y
(&
ÃighbÜs
->
south_we¡
, -1);

295 
	}
}

	@geohash.h

32 #iâdeà
GEOHASH_H_


33 
	#GEOHASH_H_


	)

35 
	~<¡ddef.h
>

36 
	~<¡dšt.h
>

37 
	~<¡dšt.h
>

39 #ià
defšed
(
__ılu¥lus
)

43 
	#HASHISZERO
(
r
è(!Ô).
b™s
 && !Ô).
¡•
)

	)

44 
	#RANGEISZERO
(
r
è(!Ô).
max
 && !Ô).
mš
)

	)

45 
	#RANGEPISZERO
(
r
èÔ =ğ
NULL
 || 
	`RANGEISZERO
(*r))

	)

47 
	#GEO_STEP_MAX
 26

	)

50 
	#GEO_LAT_MIN
 -85.05112878

	)

51 
	#GEO_LAT_MAX
 85.05112878

	)

52 
	#GEO_LONG_MIN
 -180

	)

53 
	#GEO_LONG_MAX
 180

	)

56 
GEOHASH_NORTH
 = 0,

57 
GEOHASH_EAST
,

58 
GEOHASH_WEST
,

59 
GEOHASH_SOUTH
,

60 
GEOHASH_SOUTH_WEST
,

61 
GEOHASH_SOUTH_EAST
,

62 
GEOHASH_NORT_WEST
,

63 
GEOHASH_NORT_EAST


64 } 
	tGeoDœeùiÚ
;

67 
ušt64_t
 
b™s
;

68 
ušt8_t
 
¡•
;

69 } 
	tGeoHashB™s
;

72 
mš
;

73 
max
;

74 } 
	tGeoHashRªge
;

77 
GeoHashB™s
 
hash
;

78 
GeoHashRªge
 
lÚg™ude
;

79 
GeoHashRªge
 
Ït™ude
;

80 } 
	tGeoHashA»a
;

83 
GeoHashB™s
 
nÜth
;

84 
GeoHashB™s
 
—¡
;

85 
GeoHashB™s
 
we¡
;

86 
GeoHashB™s
 
south
;

87 
GeoHashB™s
 
nÜth_—¡
;

88 
GeoHashB™s
 
south_—¡
;

89 
GeoHashB™s
 
nÜth_we¡
;

90 
GeoHashB™s
 
south_we¡
;

91 } 
	tGeoHashNeighbÜs
;

97 
geohashG‘CoÜdRªge
(
GeoHashRªge
 *
lÚg_¿nge
, GeoHashRªg*
Ït_¿nge
);

98 
geohashEncode
(cÚ¡ 
GeoHashRªge
 *
lÚg_¿nge
, cÚ¡ GeoHashRªg*
Ït_¿nge
,

99 
lÚg™ude
, 
Ït™ude
, 
ušt8_t
 
¡•
,

100 
GeoHashB™s
 *
hash
);

101 
geohashEncodeTy³
(
lÚg™ude
, 
Ït™ude
,

102 
ušt8_t
 
¡•
, 
GeoHashB™s
 *
hash
);

103 
geohashEncodeWGS84
(
lÚg™ude
, 
Ït™ude
, 
ušt8_t
 
¡•
,

104 
GeoHashB™s
 *
hash
);

105 
geohashDecode
(cÚ¡ 
GeoHashRªge
 
lÚg_¿nge
, cÚ¡ GeoHashRªg
Ït_¿nge
,

106 cÚ¡ 
GeoHashB™s
 
hash
, 
GeoHashA»a
 *
¬—
);

107 
geohashDecodeTy³
(cÚ¡ 
GeoHashB™s
 
hash
, 
GeoHashA»a
 *
¬—
);

108 
geohashDecodeWGS84
(cÚ¡ 
GeoHashB™s
 
hash
, 
GeoHashA»a
 *
¬—
);

109 
geohashDecodeA»aToLÚgL©
(cÚ¡ 
GeoHashA»a
 *
¬—
, *
xy
);

110 
geohashDecodeToLÚgL©Ty³
(cÚ¡ 
GeoHashB™s
 
hash
, *
xy
);

111 
geohashDecodeToLÚgL©WGS84
(cÚ¡ 
GeoHashB™s
 
hash
, *
xy
);

112 
geohashDecodeToLÚgL©M”ÿtÜ
(cÚ¡ 
GeoHashB™s
 
hash
, *
xy
);

113 
geohashNeighbÜs
(cÚ¡ 
GeoHashB™s
 *
hash
, 
GeoHashNeighbÜs
 *
ÃighbÜs
);

115 #ià
defšed
(
__ılu¥lus
)

	@geohash_helper.c

37 
	~"fmaüos.h
"

38 
	~"geohash_h–³r.h
"

39 
	~"debugmaüo.h
"

40 
	~<m©h.h
>

42 
	#D_R
 (
M_PI
 / 180.0)

	)

43 
	#R_MAJOR
 6378137.0

	)

44 
	#R_MINOR
 6356752.3142

	)

45 
	#RATIO
 (
R_MINOR
 / 
R_MAJOR
)

	)

46 
	#ECCENT
 (
	`sq¹
(1.0 - (
RATIO
 *RATIO)))

	)

47 
	#COM
 (0.5 * 
ECCENT
)

	)

50 cÚ¡ 
	gDEG_TO_RAD
 = 0.017453292519943295769236907684886;

52 cÚ¡ 
	gEARTH_RADIUS_IN_METERS
 = 6372797.560856;

54 cÚ¡ 
	gMERCATOR_MAX
 = 20037726.37;

55 cÚ¡ 
	gMERCATOR_MIN
 = -20037726.37;

57 
šlše
 
	$deg_¿d
(
ªg
è{ ‡ng * 
D_R
; 
	}
}

58 
šlše
 
	$¿d_deg
(
ªg
è{ ‡ng / 
D_R
; 
	}
}

62 
ušt8_t
 
	$geohashE¡im©eS‹psByRadius
(
¿nge_m‘”s
, 
Ït
) {

63 ià(
¿nge_m‘”s
 == 0)  26;

64 
¡•
 = 1;

65 
¿nge_m‘”s
 < 
MERCATOR_MAX
) {

66 
¿nge_m‘”s
 *= 2;

67 
¡•
++;

69 
¡•
 -= 2;

74 ià(
Ït
 > 66 ||†at < -66) {

75 
¡•
--;

76 ià(
Ït
 > 80 ||†© < -80è
¡•
--;

80 ià(
¡•
 < 1) step = 1;

81 ià(
¡•
 > 26) step = 26;

82  
¡•
;

83 
	}
}

103 
	$geohashBoundšgBox
(
lÚg™ude
, 
Ït™ude
, 
¿dius_m‘”s
,

104 *
bounds
) {

105 ià(!
bounds
)  0;

107 
bounds
[0] = 
lÚg™ude
 - 
	`¿d_deg
(
¿dius_m‘”s
/
EARTH_RADIUS_IN_METERS
/
	`cos
(
	`deg_¿d
(
Ït™ude
)));

108 
bounds
[2] = 
lÚg™ude
 + 
	`¿d_deg
(
¿dius_m‘”s
/
EARTH_RADIUS_IN_METERS
/
	`cos
(
	`deg_¿d
(
Ït™ude
)));

109 
bounds
[1] = 
Ït™ude
 - 
	`¿d_deg
(
¿dius_m‘”s
/
EARTH_RADIUS_IN_METERS
);

110 
bounds
[3] = 
Ït™ude
 + 
	`¿d_deg
(
¿dius_m‘”s
/
EARTH_RADIUS_IN_METERS
);

112 
	}
}

116 
GeoHashRadius
 
	$geohashG‘A»asByRadius
(
lÚg™ude
, 
Ït™ude
, 
¿dius_m‘”s
) {

117 
GeoHashRªge
 
lÚg_¿nge
, 
Ït_¿nge
;

118 
GeoHashRadius
 
¿dius
;

119 
GeoHashB™s
 
hash
;

120 
GeoHashNeighbÜs
 
ÃighbÜs
;

121 
GeoHashA»a
 
¬—
;

122 
mš_lÚ
, 
max_lÚ
, 
mš_Ït
, 
max_Ït
;

123 
bounds
[4];

124 
¡•s
;

126 
	`geohashBoundšgBox
(
lÚg™ude
, 
Ït™ude
, 
¿dius_m‘”s
, 
bounds
);

127 
mš_lÚ
 = 
bounds
[0];

128 
mš_Ït
 = 
bounds
[1];

129 
max_lÚ
 = 
bounds
[2];

130 
max_Ït
 = 
bounds
[3];

132 
¡•s
 = 
	`geohashE¡im©eS‹psByRadius
(
¿dius_m‘”s
,
Ït™ude
);

134 
	`geohashG‘CoÜdRªge
(&
lÚg_¿nge
,&
Ït_¿nge
);

135 
	`geohashEncode
(&
lÚg_¿nge
,&
Ït_¿nge
,
lÚg™ude
,
Ït™ude
,
¡•s
,&
hash
);

136 
	`geohashNeighbÜs
(&
hash
,&
ÃighbÜs
);

137 
	`geohashDecode
(
lÚg_¿nge
,
Ït_¿nge
,
hash
,&
¬—
);

144 
deü—£_¡•
 = 0;

146 
GeoHashA»a
 
nÜth
, 
south
, 
—¡
, 
we¡
;

148 
	`geohashDecode
(
lÚg_¿nge
, 
Ït_¿nge
, 
ÃighbÜs
.
nÜth
, &north);

149 
	`geohashDecode
(
lÚg_¿nge
, 
Ït_¿nge
, 
ÃighbÜs
.
south
, &south);

150 
	`geohashDecode
(
lÚg_¿nge
, 
Ït_¿nge
, 
ÃighbÜs
.
—¡
, &east);

151 
	`geohashDecode
(
lÚg_¿nge
, 
Ït_¿nge
, 
ÃighbÜs
.
we¡
, &west);

153 ià(
	`geohashG‘Di¡ªû
(
lÚg™ude
,
Ït™ude
,lÚg™ude,
nÜth
.Ït™ude.
max
)

154 < 
¿dius_m‘”s
è
deü—£_¡•
 = 1;

155 ià(
	`geohashG‘Di¡ªû
(
lÚg™ude
,
Ït™ude
,lÚg™ude,
south
.Ït™ude.
mš
)

156 < 
¿dius_m‘”s
è
deü—£_¡•
 = 1;

157 ià(
	`geohashG‘Di¡ªû
(
lÚg™ude
,
Ït™ude
,
—¡
.lÚg™ude.
max
,latitude)

158 < 
¿dius_m‘”s
è
deü—£_¡•
 = 1;

159 ià(
	`geohashG‘Di¡ªû
(
lÚg™ude
,
Ït™ude
,
we¡
.lÚg™ude.
mš
,latitude)

160 < 
¿dius_m‘”s
è
deü—£_¡•
 = 1;

163 ià(
¡•s
 > 1 && 
deü—£_¡•
) {

164 
¡•s
--;

165 
	`geohashEncode
(&
lÚg_¿nge
,&
Ït_¿nge
,
lÚg™ude
,
Ït™ude
,
¡•s
,&
hash
);

166 
	`geohashNeighbÜs
(&
hash
,&
ÃighbÜs
);

167 
	`geohashDecode
(
lÚg_¿nge
,
Ït_¿nge
,
hash
,&
¬—
);

171 ià(
¡•s
 >= 2) {

172 ià(
¬—
.
Ït™ude
.
mš
 < 
mš_Ït
) {

173 
	`GZERO
(
ÃighbÜs
.
south
);

174 
	`GZERO
(
ÃighbÜs
.
south_we¡
);

175 
	`GZERO
(
ÃighbÜs
.
south_—¡
);

177 ià(
¬—
.
Ït™ude
.
max
 > 
max_Ït
) {

178 
	`GZERO
(
ÃighbÜs
.
nÜth
);

179 
	`GZERO
(
ÃighbÜs
.
nÜth_—¡
);

180 
	`GZERO
(
ÃighbÜs
.
nÜth_we¡
);

182 ià(
¬—
.
lÚg™ude
.
mš
 < 
mš_lÚ
) {

183 
	`GZERO
(
ÃighbÜs
.
we¡
);

184 
	`GZERO
(
ÃighbÜs
.
south_we¡
);

185 
	`GZERO
(
ÃighbÜs
.
nÜth_we¡
);

187 ià(
¬—
.
lÚg™ude
.
max
 > 
max_lÚ
) {

188 
	`GZERO
(
ÃighbÜs
.
—¡
);

189 
	`GZERO
(
ÃighbÜs
.
south_—¡
);

190 
	`GZERO
(
ÃighbÜs
.
nÜth_—¡
);

193 
¿dius
.
hash
 = hash;

194 
¿dius
.
ÃighbÜs
 =‚eighbors;

195 
¿dius
.
¬—
 =‡rea;

196  
¿dius
;

197 
	}
}

199 
GeoHashRadius
 
	$geohashG‘A»asByRadiusWGS84
(
lÚg™ude
, 
Ït™ude
,

200 
¿dius_m‘”s
) {

201  
	`geohashG‘A»asByRadius
(
lÚg™ude
, 
Ït™ude
, 
¿dius_m‘”s
);

202 
	}
}

204 
GeoHashFix52B™s
 
	$geohashAlign52B™s
(cÚ¡ 
GeoHashB™s
 
hash
) {

205 
ušt64_t
 
b™s
 = 
hash
.bits;

206 
b™s
 <<ğ(52 - 
hash
.
¡•
 * 2);

207  
b™s
;

208 
	}
}

211 
	$geohashG‘Di¡ªû
(
lÚ1d
, 
Ït1d
, 
lÚ2d
, 
Ït2d
) {

212 
Ït1r
, 
lÚ1r
, 
Ït2r
, 
lÚ2r
, 
u
, 
v
;

213 
Ït1r
 = 
	`deg_¿d
(
Ït1d
);

214 
lÚ1r
 = 
	`deg_¿d
(
lÚ1d
);

215 
Ït2r
 = 
	`deg_¿d
(
Ït2d
);

216 
lÚ2r
 = 
	`deg_¿d
(
lÚ2d
);

217 
u
 = 
	`sš
((
Ït2r
 - 
Ït1r
) / 2);

218 
v
 = 
	`sš
((
lÚ2r
 - 
lÚ1r
) / 2);

219  2.0 * 
EARTH_RADIUS_IN_METERS
 *

220 
	`asš
(
	`sq¹
(
u
 * u + 
	`cos
(
Ït1r
è* cos(
Ït2r
è* 
v
 * v));

221 
	}
}

223 
	$geohashG‘Di¡ªûIfInRadius
(
x1
, 
y1
,

224 
x2
, 
y2
, 
¿dius
,

225 *
di¡ªû
) {

226 *
di¡ªû
 = 
	`geohashG‘Di¡ªû
(
x1
, 
y1
, 
x2
, 
y2
);

227 ià(*
di¡ªû
 > 
¿dius
)  0;

229 
	}
}

231 
	$geohashG‘Di¡ªûIfInRadiusWGS84
(
x1
, 
y1
, 
x2
,

232 
y2
, 
¿dius
,

233 *
di¡ªû
) {

234  
	`geohashG‘Di¡ªûIfInRadius
(
x1
, 
y1
, 
x2
, 
y2
, 
¿dius
, 
di¡ªû
);

235 
	}
}

	@geohash_helper.h

32 #iâdeà
GEOHASH_HELPER_HPP_


33 
	#GEOHASH_HELPER_HPP_


	)

35 
	~"geohash.h
"

37 
	#GZERO
(
s
ès.
b™s
 = s.
¡•
 = 0;

	)

38 
	#GISZERO
(
s
è(!s.
b™s
 && !s.
¡•
)

	)

39 
	#GISNOTZERO
(
s
è(s.
b™s
 || s.
¡•
)

	)

41 
ušt64_t
 
	tGeoHashFix52B™s
;

42 
ušt64_t
 
	tGeoHashV¬B™s
;

45 
GeoHashB™s
 
	mhash
;

46 
GeoHashA»a
 
	m¬—
;

47 
GeoHashNeighbÜs
 
	mÃighbÜs
;

48 } 
	tGeoHashRadius
;

50 
GeoHashB™sCom·¿tÜ
(cÚ¡ 
GeoHashB™s
 *
a
, cÚ¡ GeoHashB™ *
b
);

51 
ušt8_t
 
geohashE¡im©eS‹psByRadius
(
¿nge_m‘”s
, 
Ït
);

52 
geohashBoundšgBox
(
lÚg™ude
, 
Ït™ude
, 
¿dius_m‘”s
,

53 *
bounds
);

54 
GeoHashRadius
 
geohashG‘A»asByRadius
(
lÚg™ude
,

55 
Ït™ude
, 
¿dius_m‘”s
);

56 
GeoHashRadius
 
geohashG‘A»asByRadiusWGS84
(
lÚg™ude
, 
Ït™ude
,

57 
¿dius_m‘”s
);

58 
GeoHashRadius
 
geohashG‘A»asByRadiusM”ÿtÜ
(
lÚg™ude
, 
Ït™ude
,

59 
¿dius_m‘”s
);

60 
GeoHashFix52B™s
 
geohashAlign52B™s
(cÚ¡ 
GeoHashB™s
 
hash
);

61 
geohashG‘Di¡ªû
(
lÚ1d
, 
Ït1d
,

62 
lÚ2d
, 
Ït2d
);

63 
geohashG‘Di¡ªûIfInRadius
(
x1
, 
y1
,

64 
x2
, 
y2
, 
¿dius
,

65 *
di¡ªû
);

66 
geohashG‘Di¡ªûIfInRadiusWGS84
(
x1
, 
y1
, 
x2
,

67 
y2
, 
¿dius
,

68 *
di¡ªû
);

	@help.h

3 #iâdeà
__REDIS_HELP_H


4 
	#__REDIS_HELP_H


	)

6 *
	gcommªdGroups
[] = {

23 
	scommªdH–p
 {

24 *
	mÇme
;

25 *
	m·¿ms
;

26 *
	msumm¬y
;

27 
	mgroup
;

28 *
	msšû
;

29 } 
	gcommªdH–p
[] = {

	@hyperloglog.c

32 
	~"£rv”.h
"

34 
	~<¡dšt.h
>

35 
	~<m©h.h
>

182 
	shÎhdr
 {

183 
	mmagic
[4];

184 
ušt8_t
 
	m’codšg
;

185 
ušt8_t
 
	mnÙu£d
[3];

186 
ušt8_t
 
	mÿrd
[8];

187 
ušt8_t
 
	m»gi¡”s
[];

191 
	#HLL_INVALIDATE_CACHE
(
hdr
è(hdr)->
ÿrd
[7] |ğ(1<<7)

	)

192 
	#HLL_VALID_CACHE
(
hdr
è(((hdr)->
ÿrd
[7] & (1<<7)è=ğ0)

	)

194 
	#HLL_P
 14

	)

195 
	#HLL_REGISTERS
 (1<<
HLL_P
è

	)

196 
	#HLL_P_MASK
 (
HLL_REGISTERS
-1è

	)

197 
	#HLL_BITS
 6

	)

198 
	#HLL_REGISTER_MAX
 ((1<<
HLL_BITS
)-1)

	)

199 
	#HLL_HDR_SIZE
 (
hÎhdr
)

	)

200 
	#HLL_DENSE_SIZE
 (
HLL_HDR_SIZE
+((
HLL_REGISTERS
*
HLL_BITS
+7)/8))

	)

201 
	#HLL_DENSE
 0

	)

202 
	#HLL_SPARSE
 1

	)

203 
	#HLL_RAW
 255

	)

204 
	#HLL_MAX_ENCODING
 1

	)

206 *
	gšv®id_hÎ_”r
 = "-INVALIDOBJ Corrupted HLL object detected\r\n";

337 
	#HLL_DENSE_GET_REGISTER
(
rg‘
,
p
,
»gnum
) do { \

338 
ušt8_t
 *
_p
 = (ušt8_t*è
p
; \

339 
_by‹
 = 
»gnum
*
HLL_BITS
/8; \

340 
_fb
 = 
»gnum
*
HLL_BITS
&7; \

341 
_fb8
 = 8 - 
_fb
; \

342 
b0
 = 
_p
[
_by‹
]; \

343 
b1
 = 
_p
[
_by‹
+1]; \

344 
rg‘
 = ((
b0
 >> 
_fb
è| (
b1
 << 
_fb8
)è& 
HLL_REGISTER_MAX
; \

345 } 0)

	)

349 
	#HLL_DENSE_SET_REGISTER
(
p
,
»gnum
,
v®
) do { \

350 
ušt8_t
 *
_p
 = (ušt8_t*è
p
; \

351 
_by‹
 = 
»gnum
*
HLL_BITS
/8; \

352 
_fb
 = 
»gnum
*
HLL_BITS
&7; \

353 
_fb8
 = 8 - 
_fb
; \

354 
_v
 = 
v®
; \

355 
_p
[
_by‹
] &ğ~(
HLL_REGISTER_MAX
 << 
_fb
); \

356 
_p
[
_by‹
] |ğ
_v
 << 
_fb
; \

357 
_p
[
_by‹
+1] &ğ~(
HLL_REGISTER_MAX
 >> 
_fb8
); \

358 
_p
[
_by‹
+1] |ğ
_v
 >> 
_fb8
; \

359 } 0)

	)

363 
	#HLL_SPARSE_XZERO_BIT
 0x40

	)

364 
	#HLL_SPARSE_VAL_BIT
 0x80

	)

365 
	#HLL_SPARSE_IS_ZERO
(
p
è(((*Õ)è& 0xc0è=ğ0è

	)

366 
	#HLL_SPARSE_IS_XZERO
(
p
è(((*Õ)è& 0xc0è=ğ
HLL_SPARSE_XZERO_BIT
)

	)

367 
	#HLL_SPARSE_IS_VAL
(
p
è((*Õ)è& 
HLL_SPARSE_VAL_BIT
)

	)

368 
	#HLL_SPARSE_ZERO_LEN
(
p
è(((*Õ)è& 0x3f)+1)

	)

369 
	#HLL_SPARSE_XZERO_LEN
(
p
è(((((*Õ)è& 0x3fè<< 8è| (*(Õ)+1)))+1)

	)

370 
	#HLL_SPARSE_VAL_VALUE
(
p
è((((*Õ)è>> 2è& 0x1f)+1)

	)

371 
	#HLL_SPARSE_VAL_LEN
(
p
è(((*Õ)è& 0x3)+1)

	)

372 
	#HLL_SPARSE_VAL_MAX_VALUE
 32

	)

373 
	#HLL_SPARSE_VAL_MAX_LEN
 4

	)

374 
	#HLL_SPARSE_ZERO_MAX_LEN
 64

	)

375 
	#HLL_SPARSE_XZERO_MAX_LEN
 16384

	)

376 
	#HLL_SPARSE_VAL_SET
(
p
,
v®
,
Ën
) do { \

377 *(
p
èğ(((
v®
)-1)<<2|((
Ën
)-1))|
HLL_SPARSE_VAL_BIT
; \

378 } 0)

	)

379 
	#HLL_SPARSE_ZERO_SET
(
p
,
Ën
) do { \

380 *(
p
èğ(
Ën
)-1; \

381 } 0)

	)

382 
	#HLL_SPARSE_XZERO_SET
(
p
,
Ën
) do { \

383 
_l
 = (
Ën
)-1; \

384 *(
p
èğ(
_l
>>8è| 
HLL_SPARSE_XZERO_BIT
; \

385 *((
p
)+1èğ(
_l
&0xff); \

386 } 0)

	)

393 
ušt64_t
 
	$MurmurHash64A
 (cÚ¡ * 
key
, 
Ën
, 
£ed
) {

394 cÚ¡ 
ušt64_t
 
m
 = 0xc6a4a7935bd1e995;

395 cÚ¡ 
r
 = 47;

396 
ušt64_t
 
h
 = 
£ed
 ^ (
Ën
 * 
m
);

397 cÚ¡ 
ušt8_t
 *
d©a
 = (cÚ¡ ušt8_ˆ*)
key
;

398 cÚ¡ 
ušt8_t
 *
’d
 = 
d©a
 + (
Ën
-(len&7));

400 
d©a
 !ğ
’d
) {

401 
ušt64_t
 
k
;

403 #ià(
BYTE_ORDER
 =ğ
LITTLE_ENDIAN
)

404 #ifdeà
USE_ALIGNED_ACCESS


405 
	`memıy
(&
k
,
d©a
,(
ušt64_t
));

407 
k
 = *((
ušt64_t
*)
d©a
);

410 
k
 = (
ušt64_t
è
d©a
[0];

411 
k
 |ğ(
ušt64_t
è
d©a
[1] << 8;

412 
k
 |ğ(
ušt64_t
è
d©a
[2] << 16;

413 
k
 |ğ(
ušt64_t
è
d©a
[3] << 24;

414 
k
 |ğ(
ušt64_t
è
d©a
[4] << 32;

415 
k
 |ğ(
ušt64_t
è
d©a
[5] << 40;

416 
k
 |ğ(
ušt64_t
è
d©a
[6] << 48;

417 
k
 |ğ(
ušt64_t
è
d©a
[7] << 56;

420 
k
 *ğ
m
;

421 
k
 ^ğk >> 
r
;

422 
k
 *ğ
m
;

423 
h
 ^ğ
k
;

424 
h
 *ğ
m
;

425 
d©a
 += 8;

428 
Ën
 & 7) {

429 7: 
h
 ^ğ(
ušt64_t
)
d©a
[6] << 48;

430 6: 
h
 ^ğ(
ušt64_t
)
d©a
[5] << 40;

431 5: 
h
 ^ğ(
ušt64_t
)
d©a
[4] << 32;

432 4: 
h
 ^ğ(
ušt64_t
)
d©a
[3] << 24;

433 3: 
h
 ^ğ(
ušt64_t
)
d©a
[2] << 16;

434 2: 
h
 ^ğ(
ušt64_t
)
d©a
[1] << 8;

435 1: 
h
 ^ğ(
ušt64_t
)
d©a
[0];

436 
h
 *ğ
m
;

439 
h
 ^ğh >> 
r
;

440 
h
 *ğ
m
;

441 
h
 ^ğh >> 
r
;

442  
h
;

443 
	}
}

448 
	$hÎP©L’
(*
–e
, 
size_t
 
–esize
, *
»gp
) {

449 
ušt64_t
 
hash
, 
b™
, 
šdex
;

450 
couÁ
;

463 
hash
 = 
	`MurmurHash64A
(
–e
,
–esize
,0xadc83b19ULL);

464 
šdex
 = 
hash
 & 
HLL_P_MASK
;

465 
hash
 |ğ((
ušt64_t
)1<<63);

466 
b™
 = 
HLL_REGISTERS
;

467 
couÁ
 = 1;

468 (
hash
 & 
b™
) == 0) {

469 
couÁ
++;

470 
b™
 <<= 1;

472 *
»gp
 = (è
šdex
;

473  
couÁ
;

474 
	}
}

489 
	$hÎD’£Add
(
ušt8_t
 *
»gi¡”s
, *
–e
, 
size_t
 
–esize
) {

490 
ušt8_t
 
ŞdcouÁ
, 
couÁ
;

491 
šdex
;

494 
couÁ
 = 
	`hÎP©L’
(
–e
,
–esize
,&
šdex
);

495 
	`HLL_DENSE_GET_REGISTER
(
ŞdcouÁ
,
»gi¡”s
,
šdex
);

496 ià(
couÁ
 > 
ŞdcouÁ
) {

497 
	`HLL_DENSE_SET_REGISTER
(
»gi¡”s
,
šdex
,
couÁ
);

502 
	}
}

508 
	$hÎD’£Sum
(
ušt8_t
 *
»gi¡”s
, *
PE
, *
ezp
) {

509 
E
 = 0;

510 
j
, 
ez
 = 0;

515 ià(
HLL_REGISTERS
 =ğ16384 && 
HLL_BITS
 == 6) {

516 
ušt8_t
 *
r
 = 
»gi¡”s
;

517 
r0
, 
r1
, 
r2
, 
r3
, 
r4
, 
r5
, 
r6
, 
r7
, 
r8
, 
r9
,

518 
r10
, 
r11
, 
r12
, 
r13
, 
r14
, 
r15
;

519 
j
 = 0; j < 1024; j++) {

521 
r0
 = 
r
[0] & 63; iàÔ0 =ğ0è
ez
++;

522 
r1
 = (
r
[0] >> 6 |„[1] << 2è& 63; iàÔ1 =ğ0è
ez
++;

523 
r2
 = (
r
[1] >> 4 |„[2] << 4è& 63; iàÔ2 =ğ0è
ez
++;

524 
r3
 = (
r
[2] >> 2è& 63; iàÔ3 =ğ0è
ez
++;

525 
r4
 = 
r
[3] & 63; iàÔ4 =ğ0è
ez
++;

526 
r5
 = (
r
[3] >> 6 |„[4] << 2è& 63; iàÔ5 =ğ0è
ez
++;

527 
r6
 = (
r
[4] >> 4 |„[5] << 4è& 63; iàÔ6 =ğ0è
ez
++;

528 
r7
 = (
r
[5] >> 2è& 63; iàÔ7 =ğ0è
ez
++;

529 
r8
 = 
r
[6] & 63; iàÔ8 =ğ0è
ez
++;

530 
r9
 = (
r
[6] >> 6 |„[7] << 2è& 63; iàÔ9 =ğ0è
ez
++;

531 
r10
 = (
r
[7] >> 4 |„[8] << 4è& 63; iàÔ10 =ğ0è
ez
++;

532 
r11
 = (
r
[8] >> 2è& 63; iàÔ11 =ğ0è
ez
++;

533 
r12
 = 
r
[9] & 63; iàÔ12 =ğ0è
ez
++;

534 
r13
 = (
r
[9] >> 6 |„[10] << 2è& 63; iàÔ13 =ğ0è
ez
++;

535 
r14
 = (
r
[10] >> 4 |„[11] << 4è& 63; iàÔ14 =ğ0è
ez
++;

536 
r15
 = (
r
[11] >> 2è& 63; iàÔ15 =ğ0è
ez
++;

541 
E
 +ğ(
PE
[
r0
] + PE[
r1
]è+ (PE[
r2
] + PE[
r3
]è+ (PE[
r4
] + PE[
r5
]) +

542 (
PE
[
r6
] + PE[
r7
]è+ (PE[
r8
] + PE[
r9
]è+ (PE[
r10
] + PE[
r11
]) +

543 (
PE
[
r12
] + PE[
r13
]è+ (PE[
r14
] + PE[
r15
]);

544 
r
 += 12;

547 
j
 = 0; j < 
HLL_REGISTERS
; j++) {

548 
»g
;

550 
	`HLL_DENSE_GET_REGISTER
(
»g
,
»gi¡”s
,
j
);

551 ià(
»g
 == 0) {

552 
ez
++;

555 
E
 +ğ
PE
[
»g
];

558 
E
 +ğ
ez
;

560 *
ezp
 = 
ez
;

561  
E
;

562 
	}
}

572 
	$hÎS·r£ToD’£
(
robj
 *
o
) {

573 
sds
 
¥¬£
 = 
o
->
±r
, 
d’£
;

574 
hÎhdr
 *
hdr
, *
Şdhdr
 = (hÎhdr*)
¥¬£
;

575 
idx
 = 0, 
ruÆ’
, 
»gv®
;

576 
ušt8_t
 *
p
 = (ušt8_t*)
¥¬£
, *
’d
 =…+
	`sd¦’
(sparse);

579 
hdr
 = (
hÎhdr
*è
¥¬£
;

580 ià(
hdr
->
’codšg
 =ğ
HLL_DENSE
è 
C_OK
;

585 
d’£
 = 
	`sd¢ewËn
(
NULL
,
HLL_DENSE_SIZE
);

586 
hdr
 = (
hÎhdr
*è
d’£
;

587 *
hdr
 = *
Şdhdr
;

588 
hdr
->
’codšg
 = 
HLL_DENSE
;

592 
p
 +ğ
HLL_HDR_SIZE
;

593 
p
 < 
’d
) {

594 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

595 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

596 
idx
 +ğ
ruÆ’
;

597 
p
++;

598 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

599 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

600 
idx
 +ğ
ruÆ’
;

601 
p
 += 2;

603 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

604 
»gv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

605 
ruÆ’
--) {

606 
	`HLL_DENSE_SET_REGISTER
(
hdr
->
»gi¡”s
,
idx
,
»gv®
);

607 
idx
++;

609 
p
++;

615 ià(
idx
 !ğ
HLL_REGISTERS
) {

616 
	`sdsä“
(
d’£
);

617  
C_ERR
;

621 
	`sdsä“
(
o
->
±r
);

622 
o
->
±r
 = 
d’£
;

623  
C_OK
;

624 
	}
}

642 
	$hÎS·r£Add
(
robj
 *
o
, *
–e
, 
size_t
 
–esize
) {

643 
hÎhdr
 *
hdr
;

644 
ušt8_t
 
ŞdcouÁ
, 
couÁ
, *
¥¬£
, *
’d
, *
p
, *
´ev
, *
Ãxt
;

645 
šdex
, 
fœ¡
, 
¥ª
;

646 
is_z”o
 = 0, 
is_xz”o
 = 0, 
is_v®
 = 0, 
ruÆ’
 = 0;

649 
couÁ
 = 
	`hÎP©L’
(
–e
,
–esize
,&
šdex
);

653 ià(
couÁ
 > 
HLL_SPARSE_VAL_MAX_VALUE
è
´omÙe
;

660 
o
->
±r
 = 
	`sdsMakeRoomFÜ
(o->ptr,3);

664 
¥¬£
 = 
p
 = ((
ušt8_t
*)
o
->
±r
è+ 
HLL_HDR_SIZE
;

665 
’d
 = 
p
 + 
	`sd¦’
(
o
->
±r
è- 
HLL_HDR_SIZE
;

667 
fœ¡
 = 0;

668 
´ev
 = 
NULL
;

669 
Ãxt
 = 
NULL
;

670 
¥ª
 = 0;

671 
p
 < 
’d
) {

672 
İËn
;

679 
İËn
 = 1;

680 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

681 
¥ª
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

682 } ià(
	`HLL_SPARSE_IS_VAL
(
p
)) {

683 
¥ª
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

685 
¥ª
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

686 
İËn
 = 2;

689 ià(
šdex
 <ğ
fœ¡
+
¥ª
-1) ;

690 
´ev
 = 
p
;

691 
p
 +ğ
İËn
;

692 
fœ¡
 +ğ
¥ª
;

694 ià(
¥ª
 == 0)  -1;

696 
Ãxt
 = 
	`HLL_SPARSE_IS_XZERO
(
p
) ?…+2 :…+1;

697 ià(
Ãxt
 >ğ
’d
èÃxˆğ
NULL
;

702 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

703 
is_z”o
 = 1;

704 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

705 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

706 
is_xz”o
 = 1;

707 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

709 
is_v®
 = 1;

710 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

734 ià(
is_v®
) {

735 
ŞdcouÁ
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

737 ià(
ŞdcouÁ
 >ğ
couÁ
)  0;

740 ià(
ruÆ’
 == 1) {

741 
	`HLL_SPARSE_VAL_SET
(
p
,
couÁ
,1);

742 
upd©ed
;

748 ià(
is_z”o
 && 
ruÆ’
 == 1) {

749 
	`HLL_SPARSE_VAL_SET
(
p
,
couÁ
,1);

750 
upd©ed
;

768 
ušt8_t
 
£q
[5], *
n
 = seq;

769 
Ï¡
 = 
fœ¡
+
¥ª
-1;

770 
Ën
;

772 ià(
is_z”o
 || 
is_xz”o
) {

774 ià(
šdex
 !ğ
fœ¡
) {

775 
Ën
 = 
šdex
-
fœ¡
;

776 ià(
Ën
 > 
HLL_SPARSE_ZERO_MAX_LEN
) {

777 
	`HLL_SPARSE_XZERO_SET
(
n
,
Ën
);

778 
n
 += 2;

780 
	`HLL_SPARSE_ZERO_SET
(
n
,
Ën
);

781 
n
++;

784 
	`HLL_SPARSE_VAL_SET
(
n
,
couÁ
,1);

785 
n
++;

786 ià(
šdex
 !ğ
Ï¡
) {

787 
Ën
 = 
Ï¡
-
šdex
;

788 ià(
Ën
 > 
HLL_SPARSE_ZERO_MAX_LEN
) {

789 
	`HLL_SPARSE_XZERO_SET
(
n
,
Ën
);

790 
n
 += 2;

792 
	`HLL_SPARSE_ZERO_SET
(
n
,
Ën
);

793 
n
++;

798 
curv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

800 ià(
šdex
 !ğ
fœ¡
) {

801 
Ën
 = 
šdex
-
fœ¡
;

802 
	`HLL_SPARSE_VAL_SET
(
n
,
curv®
,
Ën
);

803 
n
++;

805 
	`HLL_SPARSE_VAL_SET
(
n
,
couÁ
,1);

806 
n
++;

807 ià(
šdex
 !ğ
Ï¡
) {

808 
Ën
 = 
Ï¡
-
šdex
;

809 
	`HLL_SPARSE_VAL_SET
(
n
,
curv®
,
Ën
);

810 
n
++;

818 
£qËn
 = 
n
-
£q
;

819 
ŞdËn
 = 
is_xz”o
 ? 2 : 1;

820 
d–Ën
 = 
£qËn
-
ŞdËn
;

822 ià(
d–Ën
 > 0 &&

823 
	`sd¦’
(
o
->
±r
)+
d–Ën
 > 
£rv”
.
hÎ_¥¬£_max_by‹s
è
´omÙe
;

824 ià(
d–Ën
 && 
Ãxt
è
	`memmove
Òext+d–Ën,Ãxt,
’d
-next);

825 
	`sdsInüL’
(
o
->
±r
,
d–Ën
);

826 
	`memıy
(
p
,
£q
,
£qËn
);

827 
’d
 +ğ
d–Ën
;

829 
upd©ed
:

835 
p
 = 
´ev
 ?…»v : 
¥¬£
;

836 
sÿÆ’
 = 5;

837 
p
 < 
’d
 && 
sÿÆ’
--) {

838 ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

839 
p
 += 2;

841 } ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

842 
p
++;

847 ià(
p
+1 < 
’d
 && 
	`HLL_SPARSE_IS_VAL
(p+1)) {

848 
v1
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

849 
v2
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
+1);

850 ià(
v1
 =ğ
v2
) {

851 
Ën
 = 
	`HLL_SPARSE_VAL_LEN
(
p
)+HLL_SPARSE_VAL_LEN(p+1);

852 ià(
Ën
 <ğ
HLL_SPARSE_VAL_MAX_LEN
) {

853 
	`HLL_SPARSE_VAL_SET
(
p
+1,
v1
,
Ën
);

854 
	`memmove
(
p
,p+1,
’d
-p);

855 
	`sdsInüL’
(
o
->
±r
,-1);

856 
’d
--;

864 
p
++;

868 
hdr
 = 
o
->
±r
;

869 
	`HLL_INVALIDATE_CACHE
(
hdr
);

872 
´omÙe
:

873 ià(
	`hÎS·r£ToD’£
(
o
è=ğ
C_ERR
)  -1;

874 
hdr
 = 
o
->
±r
;

883 
d’£_»tv®
 = 
	`hÎD’£Add
(
hdr
->
»gi¡”s
, 
–e
, 
–esize
);

884 
	`£rv”As£¹
(
d’£_»tv®
 == 1);

885  
d’£_»tv®
;

886 
	}
}

892 
	$hÎS·r£Sum
(
ušt8_t
 *
¥¬£
, 
¥¬£Ën
, *
PE
, *
ezp
, *
šv®id
) {

893 
E
 = 0;

894 
ez
 = 0, 
idx
 = 0, 
ruÆ’
, 
»gv®
;

895 
ušt8_t
 *
’d
 = 
¥¬£
+
¥¬£Ën
, *
p
 = sparse;

897 
p
 < 
’d
) {

898 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

899 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

900 
idx
 +ğ
ruÆ’
;

901 
ez
 +ğ
ruÆ’
;

903 
p
++;

904 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

905 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

906 
idx
 +ğ
ruÆ’
;

907 
ez
 +ğ
ruÆ’
;

909 
p
 += 2;

911 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

912 
»gv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

913 
idx
 +ğ
ruÆ’
;

914 
E
 +ğ
PE
[
»gv®
]*
ruÆ’
;

915 
p
++;

918 ià(
idx
 !ğ
HLL_REGISTERS
 && 
šv®id
) *invalid = 1;

919 
E
 +ğ
ez
;

920 *
ezp
 = 
ez
;

921  
E
;

922 
	}
}

932 
	$hÎRawSum
(
ušt8_t
 *
»gi¡”s
, *
PE
, *
ezp
) {

933 
E
 = 0;

934 
j
, 
ez
 = 0;

935 
ušt64_t
 *
wÜd
 = (ušt64_t*è
»gi¡”s
;

936 
ušt8_t
 *
by‹s
;

938 
j
 = 0; j < 
HLL_REGISTERS
/8; j++) {

939 ià(*
wÜd
 == 0) {

940 
ez
 += 8;

942 
by‹s
 = (
ušt8_t
*è
wÜd
;

943 ià(
by‹s
[0]è
E
 +ğ
PE
[by‹s[0]]; 
ez
++;

944 ià(
by‹s
[1]è
E
 +ğ
PE
[by‹s[1]]; 
ez
++;

945 ià(
by‹s
[2]è
E
 +ğ
PE
[by‹s[2]]; 
ez
++;

946 ià(
by‹s
[3]è
E
 +ğ
PE
[by‹s[3]]; 
ez
++;

947 ià(
by‹s
[4]è
E
 +ğ
PE
[by‹s[4]]; 
ez
++;

948 ià(
by‹s
[5]è
E
 +ğ
PE
[by‹s[5]]; 
ez
++;

949 ià(
by‹s
[6]è
E
 +ğ
PE
[by‹s[6]]; 
ez
++;

950 ià(
by‹s
[7]è
E
 +ğ
PE
[by‹s[7]]; 
ez
++;

952 
wÜd
++;

954 
E
 +ğ
ez
;

956 *
ezp
 = 
ez
;

957  
E
;

958 
	}
}

971 
ušt64_t
 
	$hÎCouÁ
(
hÎhdr
 *
hdr
, *
šv®id
) {

972 
m
 = 
HLL_REGISTERS
;

973 
E
, 
®pha
 = 0.7213/(1+1.079/
m
);

974 
j
, 
ez
;

978 
š™Ÿlized
 = 0;

979 
PE
[64];

980 ià(!
š™Ÿlized
) {

981 
PE
[0] = 1;

982 
j
 = 1; j < 64; j++) {

984 
PE
[
j
] = 1.0/(1ULL << j);

986 
š™Ÿlized
 = 1;

990 ià(
hdr
->
’codšg
 =ğ
HLL_DENSE
) {

991 
E
 = 
	`hÎD’£Sum
(
hdr
->
»gi¡”s
,
PE
,&
ez
);

992 } ià(
hdr
->
’codšg
 =ğ
HLL_SPARSE
) {

993 
E
 = 
	`hÎS·r£Sum
(
hdr
->
»gi¡”s
,

994 
	`sd¦’
((
sds
)
hdr
)-
HLL_HDR_SIZE
,
PE
,&
ez
,
šv®id
);

995 } ià(
hdr
->
’codšg
 =ğ
HLL_RAW
) {

996 
E
 = 
	`hÎRawSum
(
hdr
->
»gi¡”s
,
PE
,&
ez
);

998 
	`£rv”Pªic
("Unknown HyperLogLogƒncoding in hllCount()");

1005 
zl
 = 
	`log
(
ez
 + 1);

1006 
b‘a
 = -0.370393911*
ez
 +

1007 0.070471823*
zl
 +

1008 0.17393686*
	`pow
(
zl
,2) +

1009 0.16339839*
	`pow
(
zl
,3) +

1010 -0.09237745*
	`pow
(
zl
,4) +

1011 0.03738027*
	`pow
(
zl
,5) +

1012 -0.005384159*
	`pow
(
zl
,6) +

1013 0.00042419*
	`pow
(
zl
,7);

1015 
E
 = 
	`Îroundl
(
®pha
*
m
*(m-
ez
)*(1/(E+
b‘a
)));

1016  (
ušt64_t
è
E
;

1017 
	}
}

1020 
	$hÎAdd
(
robj
 *
o
, *
–e
, 
size_t
 
–esize
) {

1021 
hÎhdr
 *
hdr
 = 
o
->
±r
;

1022 
hdr
->
’codšg
) {

1023 
HLL_DENSE
:  
	`hÎD’£Add
(
hdr
->
»gi¡”s
,
–e
,
–esize
);

1024 
HLL_SPARSE
:  
	`hÎS·r£Add
(
o
,
–e
,
–esize
);

1027 
	}
}

1037 
	$hÎM”ge
(
ušt8_t
 *
max
, 
robj
 *
hÎ
) {

1038 
hÎhdr
 *
hdr
 = 
hÎ
->
±r
;

1039 
i
;

1041 ià(
hdr
->
’codšg
 =ğ
HLL_DENSE
) {

1042 
ušt8_t
 
v®
;

1044 
i
 = 0; i < 
HLL_REGISTERS
; i++) {

1045 
	`HLL_DENSE_GET_REGISTER
(
v®
,
hdr
->
»gi¡”s
,
i
);

1046 ià(
v®
 > 
max
[
i
]) max[i] = val;

1049 
ušt8_t
 *
p
 = 
hÎ
->
±r
, *
’d
 =… + 
	`sd¦’
(hll->ptr);

1050 
ruÆ’
, 
»gv®
;

1052 
p
 +ğ
HLL_HDR_SIZE
;

1053 
i
 = 0;

1054 
p
 < 
’d
) {

1055 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

1056 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

1057 
i
 +ğ
ruÆ’
;

1058 
p
++;

1059 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

1060 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

1061 
i
 +ğ
ruÆ’
;

1062 
p
 += 2;

1064 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

1065 
»gv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

1066 
ruÆ’
--) {

1067 ià(
»gv®
 > 
max
[
i
]) max[i] =„egval;

1068 
i
++;

1070 
p
++;

1073 ià(
i
 !ğ
HLL_REGISTERS
è 
C_ERR
;

1075  
C_OK
;

1076 
	}
}

1082 
robj
 *
	$ü—‹HLLObjeù
() {

1083 
robj
 *
o
;

1084 
hÎhdr
 *
hdr
;

1085 
sds
 
s
;

1086 
ušt8_t
 *
p
;

1087 
¥¬£Ën
 = 
HLL_HDR_SIZE
 +

1088 (((
HLL_REGISTERS
+(
HLL_SPARSE_XZERO_MAX_LEN
-1)) /

1089 
HLL_SPARSE_XZERO_MAX_LEN
)*2);

1090 
aux
;

1094 
aux
 = 
HLL_REGISTERS
;

1095 
s
 = 
	`sd¢ewËn
(
NULL
,
¥¬£Ën
);

1096 
p
 = (
ušt8_t
*)
s
 + 
HLL_HDR_SIZE
;

1097 
aux
) {

1098 
xz”o
 = 
HLL_SPARSE_XZERO_MAX_LEN
;

1099 ià(
xz”o
 > 
aux
) xzero =‡ux;

1100 
	`HLL_SPARSE_XZERO_SET
(
p
,
xz”o
);

1101 
p
 += 2;

1102 
aux
 -ğ
xz”o
;

1104 
	`£rv”As£¹
((
p
-(
ušt8_t
*)
s
è=ğ
¥¬£Ën
);

1107 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
s
);

1108 
hdr
 = 
o
->
±r
;

1109 
	`memıy
(
hdr
->
magic
,"HYLL",4);

1110 
hdr
->
’codšg
 = 
HLL_SPARSE
;

1111  
o
;

1112 
	}
}

1117 
	$isHLLObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
) {

1118 
hÎhdr
 *
hdr
;

1121 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
))

1122  
C_ERR
;

1124 ià(!
	`sdsEncodedObjeù
(
o
)è
šv®id
;

1125 ià(
	`¡ršgObjeùL’
(
o
è< (*
hdr
)è
šv®id
;

1126 
hdr
 = 
o
->
±r
;

1129 ià(
hdr
->
magic
[0] != 'H' || hdr->magic[1] != 'Y' ||

1130 
hdr
->
magic
[2] !ğ'L' || hdr->magic[3] !ğ'L'è
šv®id
;

1132 ià(
hdr
->
’codšg
 > 
HLL_MAX_ENCODING
è
šv®id
;

1135 ià(
hdr
->
’codšg
 =ğ
HLL_DENSE
 &&

1136 
	`¡ršgObjeùL’
(
o
è!ğ
HLL_DENSE_SIZE
è
šv®id
;

1139  
C_OK
;

1141 
šv®id
:

1142 
	`addR•lySds
(
c
,

1143 
	`sd¢ew
("-WRONGTYPE Key is‚ot‡ valid "

1145  
C_ERR
;

1146 
	}
}

1149 
	$pçddCommªd
(
ş›Á
 *
c
) {

1150 
robj
 *
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

1151 
hÎhdr
 *
hdr
;

1152 
upd©ed
 = 0, 
j
;

1154 ià(
o
 =ğ
NULL
) {

1158 
o
 = 
	`ü—‹HLLObjeù
();

1159 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
o
);

1160 
upd©ed
++;

1162 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
C_OK
) ;

1163 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

1166 
j
 = 2; j < 
c
->
¬gc
; j++) {

1167 
»tv®
 = 
	`hÎAdd
(
o
, (*)
c
->
¬gv
[
j
]->
±r
,

1168 
	`sd¦’
(
c
->
¬gv
[
j
]->
±r
));

1169 
»tv®
) {

1171 
upd©ed
++;

1174 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1178 
hdr
 = 
o
->
±r
;

1179 ià(
upd©ed
) {

1180 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

1181 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"pçdd",
c
->
¬gv
[1],c->
db
->
id
);

1182 
£rv”
.
dœty
++;

1183 
	`HLL_INVALIDATE_CACHE
(
hdr
);

1185 
	`addR•ly
(
c
, 
upd©ed
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

1186 
	}
}

1189 
	$pfcouÁCommªd
(
ş›Á
 *
c
) {

1190 
robj
 *
o
;

1191 
hÎhdr
 *
hdr
;

1192 
ušt64_t
 
ÿrd
;

1198 ià(
c
->
¬gc
 > 2) {

1199 
ušt8_t
 
max
[
HLL_HDR_SIZE
+
HLL_REGISTERS
], *
»gi¡”s
;

1200 
j
;

1203 
	`mem£t
(
max
,0,(max));

1204 
hdr
 = (
hÎhdr
*è
max
;

1205 
hdr
->
’codšg
 = 
HLL_RAW
;

1206 
»gi¡”s
 = 
max
 + 
HLL_HDR_SIZE
;

1207 
j
 = 1; j < 
c
->
¬gc
; j++) {

1209 
robj
 *
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
j
]);

1210 ià(
o
 =ğ
NULL
) ;

1211 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
C_OK
) ;

1215 ià(
	`hÎM”ge
(
»gi¡”s
,
o
è=ğ
C_ERR
) {

1216 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1222 
	`addR•lyLÚgLÚg
(
c
,
	`hÎCouÁ
(
hdr
,
NULL
));

1230 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

1231 ià(
o
 =ğ
NULL
) {

1234 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1236 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
C_OK
) ;

1237 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

1240 
hdr
 = 
o
->
±r
;

1241 ià(
	`HLL_VALID_CACHE
(
hdr
)) {

1243 
ÿrd
 = (
ušt64_t
)
hdr
->card[0];

1244 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[1] << 8;

1245 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[2] << 16;

1246 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[3] << 24;

1247 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[4] << 32;

1248 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[5] << 40;

1249 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[6] << 48;

1250 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[7] << 56;

1252 
šv®id
 = 0;

1254 
ÿrd
 = 
	`hÎCouÁ
(
hdr
,&
šv®id
);

1255 ià(
šv®id
) {

1256 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1259 
hdr
->
ÿrd
[0] = card & 0xff;

1260 
hdr
->
ÿrd
[1] = (card >> 8) & 0xff;

1261 
hdr
->
ÿrd
[2] = (card >> 16) & 0xff;

1262 
hdr
->
ÿrd
[3] = (card >> 24) & 0xff;

1263 
hdr
->
ÿrd
[4] = (card >> 32) & 0xff;

1264 
hdr
->
ÿrd
[5] = (card >> 40) & 0xff;

1265 
hdr
->
ÿrd
[6] = (card >> 48) & 0xff;

1266 
hdr
->
ÿrd
[7] = (card >> 56) & 0xff;

1271 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

1272 
£rv”
.
dœty
++;

1274 
	`addR•lyLÚgLÚg
(
c
,
ÿrd
);

1276 
	}
}

1279 
	$pfm”geCommªd
(
ş›Á
 *
c
) {

1280 
ušt8_t
 
max
[
HLL_REGISTERS
];

1281 
hÎhdr
 *
hdr
;

1282 
j
;

1287 
	`mem£t
(
max
,0,(max));

1288 
j
 = 1; j < 
c
->
¬gc
; j++) {

1290 
robj
 *
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
j
]);

1291 ià(
o
 =ğ
NULL
) ;

1292 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
C_OK
) ;

1296 ià(
	`hÎM”ge
(
max
,
o
è=ğ
C_ERR
) {

1297 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1303 
robj
 *
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

1304 ià(
o
 =ğ
NULL
) {

1308 
o
 = 
	`ü—‹HLLObjeù
();

1309 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
o
);

1314 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

1318 ià(
	`hÎS·r£ToD’£
(
o
è=ğ
C_ERR
) {

1319 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1325 
hdr
 = 
o
->
±r
;

1326 
j
 = 0; j < 
HLL_REGISTERS
; j++) {

1327 
	`HLL_DENSE_SET_REGISTER
(
hdr
->
»gi¡”s
,
j
,
max
[j]);

1329 
	`HLL_INVALIDATE_CACHE
(
hdr
);

1331 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

1334 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"pçdd",
c
->
¬gv
[1],c->
db
->
id
);

1335 
£rv”
.
dœty
++;

1336 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1337 
	}
}

1344 
	#HLL_TEST_CYCLES
 1000

	)

1345 
	$pf£láe¡Commªd
(
ş›Á
 *
c
) {

1346 
j
, 
i
;

1347 
sds
 
b™couÁ”s
 = 
	`sd¢ewËn
(
NULL
,
HLL_DENSE_SIZE
);

1348 
hÎhdr
 *
hdr
 = (hÎhdr*è
b™couÁ”s
, *
hdr2
;

1349 
robj
 *
o
 = 
NULL
;

1350 
ušt8_t
 
by‹couÁ”s
[
HLL_REGISTERS
];

1356 
j
 = 0; j < 
HLL_TEST_CYCLES
; j++) {

1359 
i
 = 0; i < 
HLL_REGISTERS
; i++) {

1360 
r
 = 
	`¿nd
(è& 
HLL_REGISTER_MAX
;

1362 
by‹couÁ”s
[
i
] = 
r
;

1363 
	`HLL_DENSE_SET_REGISTER
(
hdr
->
»gi¡”s
,
i
,
r
);

1366 
i
 = 0; i < 
HLL_REGISTERS
; i++) {

1367 
v®
;

1369 
	`HLL_DENSE_GET_REGISTER
(
v®
,
hdr
->
»gi¡”s
,
i
);

1370 ià(
v®
 !ğ
by‹couÁ”s
[
i
]) {

1371 
	`addR•lyE¼ÜFÜm©
(
c
,

1373 
i
, (è
by‹couÁ”s
[i], (è
v®
);

1374 
ş—nup
;

1389 
	`mem£t
(
hdr
->
»gi¡”s
,0,
HLL_DENSE_SIZE
-
HLL_HDR_SIZE
);

1390 
o
 = 
	`ü—‹HLLObjeù
();

1391 
»Ë¼
 = 1.04/
	`sq¹
(
HLL_REGISTERS
);

1392 
št64_t
 
checkpošt
 = 1;

1393 
ušt64_t
 
£ed
 = (ušt64_t)
	`¿nd
() | (uint64_t)rand() << 32;

1394 
ušt64_t
 
–e
;

1395 
j
 = 1; j <= 10000000; j++) {

1396 
–e
 = 
j
 ^ 
£ed
;

1397 
	`hÎD’£Add
(
hdr
->
»gi¡”s
,(*)&
–e
,(ele));

1398 
	`hÎAdd
(
o
,(*)&
–e
,(ele));

1402 ià(
j
 =ğ
checkpošt
 && j < 
£rv”
.
hÎ_¥¬£_max_by‹s
/2) {

1403 
hdr2
 = 
o
->
±r
;

1404 ià(
hdr2
->
’codšg
 !ğ
HLL_SPARSE
) {

1405 
	`addR•lyE¼Ü
(
c
, "TESTFAILED sparseƒncoding‚ot used");

1406 
ş—nup
;

1411 ià(
j
 =ğ
checkpošt
 && 
	`hÎCouÁ
(
hdr
,
NULL
è!ğhÎCouÁ(
o
->
±r
,NULL)) {

1412 
	`addR•lyE¼Ü
(
c
, "TESTFAILED dense/sparse disagree");

1413 
ş—nup
;

1417 ià(
j
 =ğ
checkpošt
) {

1418 
št64_t
 
ab£¼
 = 
checkpošt
 - (št64_t)
	`hÎCouÁ
(
hdr
,
NULL
);

1419 
ušt64_t
 
max”r
 = 
	`û
(
»Ë¼
*6*
checkpošt
);

1425 ià(
j
 =ğ10è
max”r
 = 1;

1427 ià(
ab£¼
 < 0)‡bserr = -abserr;

1428 ià(
ab£¼
 > (
št64_t
)
max”r
) {

1429 
	`addR•lyE¼ÜFÜm©
(
c
,

1431 (è
checkpošt
,

1432 (è
ab£¼
);

1433 
ş—nup
;

1435 
checkpošt
 *= 10;

1440 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1442 
ş—nup
:

1443 
	`sdsä“
(
b™couÁ”s
);

1444 ià(
o
è
	`deüRefCouÁ
(o);

1445 
	}
}

1449 
	$pfdebugCommªd
(
ş›Á
 *
c
) {

1450 *
cmd
 = 
c
->
¬gv
[1]->
±r
;

1451 
hÎhdr
 *
hdr
;

1452 
robj
 *
o
;

1453 
j
;

1455 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[2]);

1456 ià(
o
 =ğ
NULL
) {

1457 
	`addR•lyE¼Ü
(
c
,"The specified key does‚otƒxist");

1460 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
C_OK
) ;

1461 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[2],o);

1462 
hdr
 = 
o
->
±r
;

1465 ià(!
	`¡rÿ£cmp
(
cmd
,"getreg")) {

1466 ià(
c
->
¬gc
 !ğ3è
¬™y”r
;

1468 ià(
hdr
->
’codšg
 =ğ
HLL_SPARSE
) {

1469 ià(
	`hÎS·r£ToD’£
(
o
è=ğ
C_ERR
) {

1470 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1473 
£rv”
.
dœty
++;

1476 
hdr
 = 
o
->
±r
;

1477 
	`addR•lyMuÉiBulkL’
(
c
,
HLL_REGISTERS
);

1478 
j
 = 0; j < 
HLL_REGISTERS
; j++) {

1479 
ušt8_t
 
v®
;

1481 
	`HLL_DENSE_GET_REGISTER
(
v®
,
hdr
->
»gi¡”s
,
j
);

1482 
	`addR•lyLÚgLÚg
(
c
,
v®
);

1486 ià(!
	`¡rÿ£cmp
(
cmd
,"decode")) {

1487 ià(
c
->
¬gc
 !ğ3è
¬™y”r
;

1489 
ušt8_t
 *
p
 = 
o
->
±r
, *
’d
 =…+
	`sd¦’
(o->ptr);

1490 
sds
 
decoded
 = 
	`sd£m±y
();

1492 ià(
hdr
->
’codšg
 !ğ
HLL_SPARSE
) {

1493 
	`addR•lyE¼Ü
(
c
,"HLLƒncoding is‚ot sparse");

1497 
p
 +ğ
HLL_HDR_SIZE
;

1498 
p
 < 
’d
) {

1499 
ruÆ’
, 
»gv®
;

1501 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

1502 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

1503 
p
++;

1504 
decoded
 = 
	`sdsÿrštf
(decoded,"z:%d ",
ruÆ’
);

1505 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

1506 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

1507 
p
 += 2;

1508 
decoded
 = 
	`sdsÿrštf
(decoded,"Z:%d ",
ruÆ’
);

1510 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

1511 
»gv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

1512 
p
++;

1513 
decoded
 = 
	`sdsÿrštf
(decoded,"v:%d,%d ",
»gv®
,
ruÆ’
);

1516 
decoded
 = 
	`sd¡rim
(decoded," ");

1517 
	`addR•lyBulkCBufãr
(
c
,
decoded
,
	`sd¦’
(decoded));

1518 
	`sdsä“
(
decoded
);

1521 ià(!
	`¡rÿ£cmp
(
cmd
,"encoding")) {

1522 *
’codšg¡r
[2] = {"dense","sparse"};

1523 ià(
c
->
¬gc
 !ğ3è
¬™y”r
;

1525 
	`addR•lyStus
(
c
,
’codšg¡r
[
hdr
->
’codšg
]);

1528 ià(!
	`¡rÿ£cmp
(
cmd
,"todense")) {

1529 
cÚv
 = 0;

1530 ià(
c
->
¬gc
 !ğ3è
¬™y”r
;

1532 ià(
hdr
->
’codšg
 =ğ
HLL_SPARSE
) {

1533 ià(
	`hÎS·r£ToD’£
(
o
è=ğ
C_ERR
) {

1534 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1537 
cÚv
 = 1;

1538 
£rv”
.
dœty
++;

1540 
	`addR•ly
(
c
,
cÚv
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

1542 
	`addR•lyE¼ÜFÜm©
(
c
,"UnknowÀPFDEBUG subcommªd '%s'", 
cmd
);

1546 
¬™y”r
:

1547 
	`addR•lyE¼ÜFÜm©
(
c
,

1548 "WrÚg‚umb” oà¬gum’t fÜh'%s' subcommªd",
cmd
);

1549 
	}
}

	@intset.c

31 
	~<¡dio.h
>

32 
	~<¡dlib.h
>

33 
	~<¡ršg.h
>

34 
	~"št£t.h
"

35 
	~"zm®loc.h
"

36 
	~"’dŸncÚv.h
"

40 
	#INTSET_ENC_INT16
 ((
št16_t
))

	)

41 
	#INTSET_ENC_INT32
 ((
št32_t
))

	)

42 
	#INTSET_ENC_INT64
 ((
št64_t
))

	)

45 
ušt8_t
 
	$_št£tV®ueEncodšg
(
št64_t
 
v
) {

46 ià(
v
 < 
INT32_MIN
 || v > 
INT32_MAX
)

47  
INTSET_ENC_INT64
;

48 ià(
v
 < 
INT16_MIN
 || v > 
INT16_MAX
)

49  
INTSET_ENC_INT32
;

51  
INTSET_ENC_INT16
;

52 
	}
}

55 
št64_t
 
	$_št£tG‘Encoded
(
št£t
 *
is
, 
pos
, 
ušt8_t
 
’c
) {

56 
št64_t
 
v64
;

57 
št32_t
 
v32
;

58 
št16_t
 
v16
;

60 ià(
’c
 =ğ
INTSET_ENC_INT64
) {

61 
	`memıy
(&
v64
,((
št64_t
*)
is
->
cÚ‹Ás
)+
pos
,(v64));

62 
	`mem»v64ifbe
(&
v64
);

63  
v64
;

64 } ià(
’c
 =ğ
INTSET_ENC_INT32
) {

65 
	`memıy
(&
v32
,((
št32_t
*)
is
->
cÚ‹Ás
)+
pos
,(v32));

66 
	`mem»v32ifbe
(&
v32
);

67  
v32
;

69 
	`memıy
(&
v16
,((
št16_t
*)
is
->
cÚ‹Ás
)+
pos
,(v16));

70 
	`mem»v16ifbe
(&
v16
);

71  
v16
;

73 
	}
}

76 
št64_t
 
	$_št£tG‘
(
št£t
 *
is
, 
pos
) {

77  
	`_št£tG‘Encoded
(
is
,
pos
,
	`šŒev32ifbe
(is->
’codšg
));

78 
	}
}

81 
	$_št£tS‘
(
št£t
 *
is
, 
pos
, 
št64_t
 
v®ue
) {

82 
ušt32_t
 
’codšg
 = 
	`šŒev32ifbe
(
is
->encoding);

84 ià(
’codšg
 =ğ
INTSET_ENC_INT64
) {

85 ((
št64_t
*)
is
->
cÚ‹Ás
)[
pos
] = 
v®ue
;

86 
	`mem»v64ifbe
(((
št64_t
*)
is
->
cÚ‹Ás
)+
pos
);

87 } ià(
’codšg
 =ğ
INTSET_ENC_INT32
) {

88 ((
št32_t
*)
is
->
cÚ‹Ás
)[
pos
] = 
v®ue
;

89 
	`mem»v32ifbe
(((
št32_t
*)
is
->
cÚ‹Ás
)+
pos
);

91 ((
št16_t
*)
is
->
cÚ‹Ás
)[
pos
] = 
v®ue
;

92 
	`mem»v16ifbe
(((
št16_t
*)
is
->
cÚ‹Ás
)+
pos
);

94 
	}
}

97 
št£t
 *
	$št£tNew
() {

98 
št£t
 *
is
 = 
	`zm®loc
((intset));

99 
is
->
’codšg
 = 
	`šŒev32ifbe
(
INTSET_ENC_INT16
);

100 
is
->
Ëngth
 = 0;

101  
is
;

102 
	}
}

105 
št£t
 *
	$št£tResize
(
št£t
 *
is
, 
ušt32_t
 
Ën
) {

106 
ušt32_t
 
size
 = 
Ën
*
	`šŒev32ifbe
(
is
->
’codšg
);

107 
is
 = 
	`z»®loc
(is,(
št£t
)+
size
);

108  
is
;

109 
	}
}

115 
ušt8_t
 
	$št£tS—rch
(
št£t
 *
is
, 
št64_t
 
v®ue
, 
ušt32_t
 *
pos
) {

116 
mš
 = 0, 
max
 = 
	`šŒev32ifbe
(
is
->
Ëngth
)-1, 
mid
 = -1;

117 
št64_t
 
cur
 = -1;

120 ià(
	`šŒev32ifbe
(
is
->
Ëngth
) == 0) {

121 ià(
pos
) *pos = 0;

126 ià(
v®ue
 > 
	`_št£tG‘
(
is
,
	`šŒev32ifbe
(is->
Ëngth
)-1)) {

127 ià(
pos
è*po ğ
	`šŒev32ifbe
(
is
->
Ëngth
);

129 } ià(
v®ue
 < 
	`_št£tG‘
(
is
,0)) {

130 ià(
pos
) *pos = 0;

135 
max
 >ğ
mš
) {

136 
mid
 = (()
mš
 + ()
max
) >> 1;

137 
cur
 = 
	`_št£tG‘
(
is
,
mid
);

138 ià(
v®ue
 > 
cur
) {

139 
mš
 = 
mid
+1;

140 } ià(
v®ue
 < 
cur
) {

141 
max
 = 
mid
-1;

147 ià(
v®ue
 =ğ
cur
) {

148 ià(
pos
è*po ğ
mid
;

151 ià(
pos
è*po ğ
mš
;

154 
	}
}

157 
št£t
 *
	$št£tUpg¿deAndAdd
(
št£t
 *
is
, 
št64_t
 
v®ue
) {

158 
ušt8_t
 
cu»nc
 = 
	`šŒev32ifbe
(
is
->
’codšg
);

159 
ušt8_t
 
Ãw’c
 = 
	`_št£tV®ueEncodšg
(
v®ue
);

160 
Ëngth
 = 
	`šŒev32ifbe
(
is
->length);

161 
´•’d
 = 
v®ue
 < 0 ? 1 : 0;

164 
is
->
’codšg
 = 
	`šŒev32ifbe
(
Ãw’c
);

165 
is
 = 
	`št£tResize
(is,
	`šŒev32ifbe
(is->
Ëngth
)+1);

170 
Ëngth
--)

171 
	`_št£tS‘
(
is
,
Ëngth
+
´•’d
,
	`_št£tG‘Encoded
(is,Ëngth,
cu»nc
));

174 ià(
´•’d
)

175 
	`_št£tS‘
(
is
,0,
v®ue
);

177 
	`_št£tS‘
(
is
,
	`šŒev32ifbe
(is->
Ëngth
),
v®ue
);

178 
is
->
Ëngth
 = 
	`šŒev32ifbe
(intrev32ifbe(is->length)+1);

179  
is
;

180 
	}
}

182 
	$št£tMoveTa
(
št£t
 *
is
, 
ušt32_t
 
äom
, ušt32_ˆ
to
) {

183 *
¤c
, *
d¡
;

184 
ušt32_t
 
by‹s
 = 
	`šŒev32ifbe
(
is
->
Ëngth
)-
äom
;

185 
ušt32_t
 
’codšg
 = 
	`šŒev32ifbe
(
is
->encoding);

187 ià(
’codšg
 =ğ
INTSET_ENC_INT64
) {

188 
¤c
 = (
št64_t
*)
is
->
cÚ‹Ás
+
äom
;

189 
d¡
 = (
št64_t
*)
is
->
cÚ‹Ás
+
to
;

190 
by‹s
 *ğ(
št64_t
);

191 } ià(
’codšg
 =ğ
INTSET_ENC_INT32
) {

192 
¤c
 = (
št32_t
*)
is
->
cÚ‹Ás
+
äom
;

193 
d¡
 = (
št32_t
*)
is
->
cÚ‹Ás
+
to
;

194 
by‹s
 *ğ(
št32_t
);

196 
¤c
 = (
št16_t
*)
is
->
cÚ‹Ás
+
äom
;

197 
d¡
 = (
št16_t
*)
is
->
cÚ‹Ás
+
to
;

198 
by‹s
 *ğ(
št16_t
);

200 
	`memmove
(
d¡
,
¤c
,
by‹s
);

201 
	}
}

204 
št£t
 *
	$št£tAdd
(
št£t
 *
is
, 
št64_t
 
v®ue
, 
ušt8_t
 *
sucûss
) {

205 
ušt8_t
 
v®’c
 = 
	`_št£tV®ueEncodšg
(
v®ue
);

206 
ušt32_t
 
pos
;

207 ià(
sucûss
) *success = 1;

212 ià(
v®’c
 > 
	`šŒev32ifbe
(
is
->
’codšg
)) {

214  
	`št£tUpg¿deAndAdd
(
is
,
v®ue
);

219 ià(
	`št£tS—rch
(
is
,
v®ue
,&
pos
)) {

220 ià(
sucûss
) *success = 0;

221  
is
;

224 
is
 = 
	`št£tResize
(is,
	`šŒev32ifbe
(is->
Ëngth
)+1);

225 ià(
pos
 < 
	`šŒev32ifbe
(
is
->
Ëngth
)è
	`št£tMoveTa
(is,pos,pos+1);

228 
	`_št£tS‘
(
is
,
pos
,
v®ue
);

229 
is
->
Ëngth
 = 
	`šŒev32ifbe
(intrev32ifbe(is->length)+1);

230  
is
;

231 
	}
}

234 
št£t
 *
	$št£tRemove
(
št£t
 *
is
, 
št64_t
 
v®ue
, *
sucûss
) {

235 
ušt8_t
 
v®’c
 = 
	`_št£tV®ueEncodšg
(
v®ue
);

236 
ušt32_t
 
pos
;

237 ià(
sucûss
) *success = 0;

239 ià(
v®’c
 <ğ
	`šŒev32ifbe
(
is
->
’codšg
è&& 
	`št£tS—rch
(is,
v®ue
,&
pos
)) {

240 
ušt32_t
 
Ën
 = 
	`šŒev32ifbe
(
is
->
Ëngth
);

243 ià(
sucûss
) *success = 1;

246 ià(
pos
 < (
Ën
-1)è
	`št£tMoveTa
(
is
,pos+1,pos);

247 
is
 = 
	`št£tResize
(is,
Ën
-1);

248 
is
->
Ëngth
 = 
	`šŒev32ifbe
(
Ën
-1);

250  
is
;

251 
	}
}

254 
ušt8_t
 
	$št£tFšd
(
št£t
 *
is
, 
št64_t
 
v®ue
) {

255 
ušt8_t
 
v®’c
 = 
	`_št£tV®ueEncodšg
(
v®ue
);

256  
v®’c
 <ğ
	`šŒev32ifbe
(
is
->
’codšg
è&& 
	`št£tS—rch
(is,
v®ue
,
NULL
);

257 
	}
}

260 
št64_t
 
	$št£tRªdom
(
št£t
 *
is
) {

261  
	`_št£tG‘
(
is
,
	`¿nd
()%
	`šŒev32ifbe
(is->
Ëngth
));

262 
	}
}

266 
ušt8_t
 
	$št£tG‘
(
št£t
 *
is
, 
ušt32_t
 
pos
, 
št64_t
 *
v®ue
) {

267 ià(
pos
 < 
	`šŒev32ifbe
(
is
->
Ëngth
)) {

268 *
v®ue
 = 
	`_št£tG‘
(
is
,
pos
);

272 
	}
}

275 
ušt32_t
 
	$št£tL’
(cÚ¡ 
št£t
 *
is
) {

276  
	`šŒev32ifbe
(
is
->
Ëngth
);

277 
	}
}

280 
size_t
 
	$št£tBlobL’
(
št£t
 *
is
) {

281  (
št£t
)+
	`šŒev32ifbe
(
is
->
Ëngth
)*šŒev32ifbe(is->
’codšg
);

282 
	}
}

284 #ifdeà
REDIS_TEST


285 
	~<sys/time.h
>

286 
	~<time.h
>

289 
	$št£tR•r
(
št£t
 *
is
) {

290 
ušt32_t
 
i
 = 0; i < 
	`šŒev32ifbe
(
is
->
Ëngth
); i++) {

291 
	`´štf
("%Îd\n", (
ušt64_t
)
	`_št£tG‘
(
is
,
i
));

293 
	`´štf
("\n");

294 
	}
}

296 
	$”rÜ
(*
”r
) {

297 
	`´štf
("%s\n", 
”r
);

298 
	`ex™
(1);

299 
	}
}

302 
	$ok
() {

303 
	`´štf
("OK\n");

304 
	}
}

306 
	$u£c
() {

307 
timev®
 
tv
;

308 
	`g‘timeofday
(&
tv
,
NULL
);

309  ((()
tv
.
tv_£c
)*1000000)+tv.
tv_u£c
;

310 
	}
}

312 
	#as£¹
(
_e
è((_e)?()0:(
	`_as£¹
(#_e,
__FILE__
,
__LINE__
),
	`ex™
(1)))

	)

313 
	$_as£¹
(*
e¡r
, *
fe
, 
lše
) {

314 
	`´štf
("\n\n=== ASSERTION FAILED ===\n");

315 
	`´štf
("==> %s:%d '%s' i nÙrue\n",
fe
,
lše
,
e¡r
);

316 
	}
}

318 
št£t
 *
	$ü—‹S‘
(
b™s
, 
size
) {

319 
ušt64_t
 
mask
 = (1<<
b™s
)-1;

320 
ušt64_t
 
v®ue
;

321 
št£t
 *
is
 = 
	`št£tNew
();

323 
i
 = 0; i < 
size
; i++) {

324 ià(
b™s
 > 32) {

325 
v®ue
 = (
	`¿nd
()*¿nd()è& 
mask
;

327 
v®ue
 = 
	`¿nd
(è& 
mask
;

329 
is
 = 
	`št£tAdd
(is,
v®ue
,
NULL
);

331  
is
;

332 
	}
}

334 
	$checkCÚsi¡’cy
(
št£t
 *
is
) {

335 
ušt32_t
 
i
 = 0; i < (
	`šŒev32ifbe
(
is
->
Ëngth
)-1); i++) {

336 
ušt32_t
 
’codšg
 = 
	`šŒev32ifbe
(
is
->encoding);

338 ià(
’codšg
 =ğ
INTSET_ENC_INT16
) {

339 
št16_t
 *
i16
 = (št16_t*)
is
->
cÚ‹Ás
;

340 
	`as£¹
(
i16
[
i
] < i16[i+1]);

341 } ià(
’codšg
 =ğ
INTSET_ENC_INT32
) {

342 
št32_t
 *
i32
 = (št32_t*)
is
->
cÚ‹Ás
;

343 
	`as£¹
(
i32
[
i
] < i32[i+1]);

345 
št64_t
 *
i64
 = (št64_t*)
is
->
cÚ‹Ás
;

346 
	`as£¹
(
i64
[
i
] < i64[i+1]);

349 
	}
}

351 
	#UNUSED
(
x
è()(x)

	)

352 
	$št£tTe¡
(
¬gc
, **
¬gv
) {

353 
ušt8_t
 
sucûss
;

354 
i
;

355 
št£t
 *
is
;

356 
	`¤ªd
(
	`time
(
NULL
));

358 
	`UNUSED
(
¬gc
);

359 
	`UNUSED
(
¬gv
);

361 
	`´štf
("Valueƒncodings: "); {

362 
	`as£¹
(
	`_št£tV®ueEncodšg
(-32768è=ğ
INTSET_ENC_INT16
);

363 
	`as£¹
(
	`_št£tV®ueEncodšg
(+32767è=ğ
INTSET_ENC_INT16
);

364 
	`as£¹
(
	`_št£tV®ueEncodšg
(-32769è=ğ
INTSET_ENC_INT32
);

365 
	`as£¹
(
	`_št£tV®ueEncodšg
(+32768è=ğ
INTSET_ENC_INT32
);

366 
	`as£¹
(
	`_št£tV®ueEncodšg
(-2147483648è=ğ
INTSET_ENC_INT32
);

367 
	`as£¹
(
	`_št£tV®ueEncodšg
(+2147483647è=ğ
INTSET_ENC_INT32
);

368 
	`as£¹
(
	`_št£tV®ueEncodšg
(-2147483649è=ğ
INTSET_ENC_INT64
);

369 
	`as£¹
(
	`_št£tV®ueEncodšg
(+2147483648è=ğ
INTSET_ENC_INT64
);

370 
	`as£¹
(
	`_št£tV®ueEncodšg
(-9223372036854775808ull) ==

371 
INTSET_ENC_INT64
);

372 
	`as£¹
(
	`_št£tV®ueEncodšg
(+9223372036854775807ull) ==

373 
INTSET_ENC_INT64
);

374 
	`ok
();

377 
	`´štf
("Basic‡dding: "); {

378 
is
 = 
	`št£tNew
();

379 
is
 = 
	`št£tAdd
(is,5,&
sucûss
); 
	`as£¹
(success);

380 
is
 = 
	`št£tAdd
(is,6,&
sucûss
); 
	`as£¹
(success);

381 
is
 = 
	`št£tAdd
(is,4,&
sucûss
); 
	`as£¹
(success);

382 
is
 = 
	`št£tAdd
(is,4,&
sucûss
); 
	`as£¹
(!success);

383 
	`ok
();

386 
	`´štf
("Large‚umber of„andom‡dds: "); {

387 
ušt32_t
 
š£¹s
 = 0;

388 
is
 = 
	`št£tNew
();

389 
i
 = 0; i < 1024; i++) {

390 
is
 = 
	`št£tAdd
(is,
	`¿nd
()%0x800,&
sucûss
);

391 ià(
sucûss
è
š£¹s
++;

393 
	`as£¹
(
	`šŒev32ifbe
(
is
->
Ëngth
è=ğ
š£¹s
);

394 
	`checkCÚsi¡’cy
(
is
);

395 
	`ok
();

398 
	`´štf
("Upgrade from int16o int32: "); {

399 
is
 = 
	`št£tNew
();

400 
is
 = 
	`št£tAdd
(is,32,
NULL
);

401 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT16
);

402 
is
 = 
	`št£tAdd
(is,65535,
NULL
);

403 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT32
);

404 
	`as£¹
(
	`št£tFšd
(
is
,32));

405 
	`as£¹
(
	`št£tFšd
(
is
,65535));

406 
	`checkCÚsi¡’cy
(
is
);

408 
is
 = 
	`št£tNew
();

409 
is
 = 
	`št£tAdd
(is,32,
NULL
);

410 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT16
);

411 
is
 = 
	`št£tAdd
(is,-65535,
NULL
);

412 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT32
);

413 
	`as£¹
(
	`št£tFšd
(
is
,32));

414 
	`as£¹
(
	`št£tFšd
(
is
,-65535));

415 
	`checkCÚsi¡’cy
(
is
);

416 
	`ok
();

419 
	`´štf
("Upgrade from int16o int64: "); {

420 
is
 = 
	`št£tNew
();

421 
is
 = 
	`št£tAdd
(is,32,
NULL
);

422 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT16
);

423 
is
 = 
	`št£tAdd
(is,4294967295,
NULL
);

424 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT64
);

425 
	`as£¹
(
	`št£tFšd
(
is
,32));

426 
	`as£¹
(
	`št£tFšd
(
is
,4294967295));

427 
	`checkCÚsi¡’cy
(
is
);

429 
is
 = 
	`št£tNew
();

430 
is
 = 
	`št£tAdd
(is,32,
NULL
);

431 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT16
);

432 
is
 = 
	`št£tAdd
(is,-4294967295,
NULL
);

433 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT64
);

434 
	`as£¹
(
	`št£tFšd
(
is
,32));

435 
	`as£¹
(
	`št£tFšd
(
is
,-4294967295));

436 
	`checkCÚsi¡’cy
(
is
);

437 
	`ok
();

440 
	`´štf
("Upgrade from int32o int64: "); {

441 
is
 = 
	`št£tNew
();

442 
is
 = 
	`št£tAdd
(is,65535,
NULL
);

443 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT32
);

444 
is
 = 
	`št£tAdd
(is,4294967295,
NULL
);

445 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT64
);

446 
	`as£¹
(
	`št£tFšd
(
is
,65535));

447 
	`as£¹
(
	`št£tFšd
(
is
,4294967295));

448 
	`checkCÚsi¡’cy
(
is
);

450 
is
 = 
	`št£tNew
();

451 
is
 = 
	`št£tAdd
(is,65535,
NULL
);

452 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT32
);

453 
is
 = 
	`št£tAdd
(is,-4294967295,
NULL
);

454 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT64
);

455 
	`as£¹
(
	`št£tFšd
(
is
,65535));

456 
	`as£¹
(
	`št£tFšd
(
is
,-4294967295));

457 
	`checkCÚsi¡’cy
(
is
);

458 
	`ok
();

461 
	`´štf
("Stress†ookups: "); {

462 
num
 = 100000, 
size
 = 10000;

463 
i
, 
b™s
 = 20;

464 
¡¬t
;

465 
is
 = 
	`ü—‹S‘
(
b™s
,
size
);

466 
	`checkCÚsi¡’cy
(
is
);

468 
¡¬t
 = 
	`u£c
();

469 
i
 = 0; i < 
num
; i++è
	`št£tS—rch
(
is
,
	`¿nd
(è% ((1<<
b™s
)-1),
NULL
);

470 
	`´štf
("%ld†ookups, %ldƒlement set, %lldusec\n",

471 
num
,
size
,
	`u£c
()-
¡¬t
);

474 
	`´štf
("Stress‡dd+delete: "); {

475 
i
, 
v1
, 
v2
;

476 
is
 = 
	`št£tNew
();

477 
i
 = 0; i < 0xffff; i++) {

478 
v1
 = 
	`¿nd
() % 0xfff;

479 
is
 = 
	`št£tAdd
(is,
v1
,
NULL
);

480 
	`as£¹
(
	`št£tFšd
(
is
,
v1
));

482 
v2
 = 
	`¿nd
() % 0xfff;

483 
is
 = 
	`št£tRemove
(is,
v2
,
NULL
);

484 
	`as£¹
(!
	`št£tFšd
(
is
,
v2
));

486 
	`checkCÚsi¡’cy
(
is
);

487 
	`ok
();

491 
	}
}

	@intset.h

31 #iâdeà
__INTSET_H


32 
	#__INTSET_H


	)

33 
	~<¡dšt.h
>

35 
	sšt£t
 {

36 
ušt32_t
 
	m’codšg
;

37 
ušt32_t
 
	mËngth
;

38 
št8_t
 
	mcÚ‹Ás
[];

39 } 
	tšt£t
;

41 
št£t
 *
št£tNew
();

42 
št£t
 *
št£tAdd
(št£ˆ*
is
, 
št64_t
 
v®ue
, 
ušt8_t
 *
sucûss
);

43 
št£t
 *
št£tRemove
(št£ˆ*
is
, 
št64_t
 
v®ue
, *
sucûss
);

44 
ušt8_t
 
št£tFšd
(
št£t
 *
is
, 
št64_t
 
v®ue
);

45 
št64_t
 
št£tRªdom
(
št£t
 *
is
);

46 
ušt8_t
 
št£tG‘
(
št£t
 *
is
, 
ušt32_t
 
pos
, 
št64_t
 *
v®ue
);

47 
ušt32_t
 
št£tL’
(cÚ¡ 
št£t
 *
is
);

48 
size_t
 
št£tBlobL’
(
št£t
 *
is
);

50 #ifdeà
REDIS_TEST


51 
št£tTe¡
(
¬gc
, *
¬gv
[]);

	@latency.c

36 
	~"£rv”.h
"

39 
	$diùSŒšgKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
) {

40 
	`UNUSED
(
´ivd©a
);

41  
	`¡rcmp
(
key1
,
key2
) == 0;

42 
	}
}

44 
ušt64_t
 
	$diùSŒšgHash
(cÚ¡ *
key
) {

45  
	`diùG’HashFunùiÚ
(
key
, 
	`¡¾’
(key));

46 
	}
}

48 
diùVªÏF»e
(*
´ivd©a
, *
v®
);

50 
diùTy³
 
	gÏ‹ncyTimeS”›sDiùTy³
 = {

51 
diùSŒšgHash
,

52 
NULL
,

53 
NULL
,

54 
diùSŒšgKeyCom·»
,

55 
diùVªÏF»e
,

56 
diùVªÏF»e


61 #ifdeà
__lšux__


64 
	$THPIsEÇbËd
() {

65 
buf
[1024];

67 
FILE
 *
å
 = 
	`fİ’
("/sys/kernel/mm/transparent_hugepage/enabled","r");

68 ià(!
å
)  0;

69 ià(
	`fg‘s
(
buf
,(buf),
å
è=ğ
NULL
) {

70 
	`fşo£
(
å
);

73 
	`fşo£
(
å
);

74  (
	`¡r¡r
(
buf
,"[Ãv”]"è=ğ
NULL
) ? 1 : 0;

75 
	}
}

81 
	$THPG‘AnÚHugePagesSize
() {

82  
	`zm®loc_g‘_sm­_by‹s_by_f›ld
("AnonHugePages:",-1);

83 
	}
}

90 
	$Ï‹ncyMÚ™ÜIn™
() {

91 
£rv”
.
Ï‹ncy_ev’ts
 = 
	`diùC»©e
(&
Ï‹ncyTimeS”›sDiùTy³
,
NULL
);

92 
	}
}

98 
	$Ï‹ncyAddSam¶e
(*
ev’t
, 
m¡ime_t
 
Ï‹ncy
) {

99 
Ï‹ncyTimeS”›s
 *
ts
 = 
	`diùF‘chV®ue
(
£rv”
.
Ï‹ncy_ev’ts
,
ev’t
);

100 
time_t
 
now
 = 
	`time
(
NULL
);

101 
´ev
;

104 ià(
ts
 =ğ
NULL
) {

105 
ts
 = 
	`zm®loc
((*ts));

106 
ts
->
idx
 = 0;

107 
ts
->
max
 = 0;

108 
	`mem£t
(
ts
->
§m¶es
,0,(ts->samples));

109 
	`diùAdd
(
£rv”
.
Ï‹ncy_ev’ts
,
	`z¡rdup
(
ev’t
),
ts
);

114 
´ev
 = (
ts
->
idx
 + 
LATENCY_TS_LEN
 - 1) % LATENCY_TS_LEN;

115 ià(
ts
->
§m¶es
[
´ev
].
time
 =ğ
now
) {

116 ià(
Ï‹ncy
 > 
ts
->
§m¶es
[
´ev
].latency)

117 
ts
->
§m¶es
[
´ev
].
Ï‹ncy
 =†atency;

121 
ts
->
§m¶es
[ts->
idx
].
time
 = 
	`time
(
NULL
);

122 
ts
->
§m¶es
[ts->
idx
].
Ï‹ncy
 =†atency;

123 ià(
Ï‹ncy
 > 
ts
->
max
)s->max =†atency;

125 
ts
->
idx
++;

126 ià(
ts
->
idx
 =ğ
LATENCY_TS_LEN
)s->idx = 0;

127 
	}
}

134 
	$Ï‹ncyRe£tEv’t
(*
ev’t_to_»£t
) {

135 
diùI‹¿tÜ
 *
di
;

136 
diùEÁry
 *
de
;

137 
»£ts
 = 0;

139 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
Ï‹ncy_ev’ts
);

140 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

141 *
ev’t
 = 
	`diùG‘Key
(
de
);

143 ià(
ev’t_to_»£t
 =ğ
NULL
 || 
	`¡rÿ£cmp
(
ev’t
,event_to_reset) == 0) {

144 
	`diùD–‘e
(
£rv”
.
Ï‹ncy_ev’ts
, 
ev’t
);

145 
»£ts
++;

148 
	`diùR–—£I‹¿tÜ
(
di
);

149  
»£ts
;

150 
	}
}

159 
	$ª®yzeL©’cyFÜEv’t
(*
ev’t
, 
Ï‹ncySts
 *
ls
) {

160 
Ï‹ncyTimeS”›s
 *
ts
 = 
	`diùF‘chV®ue
(
£rv”
.
Ï‹ncy_ev’ts
,
ev’t
);

161 
j
;

162 
ušt64_t
 
sum
;

164 
ls
->
®l_time_high
 = 
ts
 ?s->
max
 : 0;

165 
ls
->
avg
 = 0;

166 
ls
->
mš
 = 0;

167 
ls
->
max
 = 0;

168 
ls
->
mad
 = 0;

169 
ls
->
§m¶es
 = 0;

170 
ls
->
³riod
 = 0;

171 ià(!
ts
) ;

174 
sum
 = 0;

175 
j
 = 0; j < 
LATENCY_TS_LEN
; j++) {

176 ià(
ts
->
§m¶es
[
j
].
time
 == 0) ;

177 
ls
->
§m¶es
++;

178 ià(
ls
->
§m¶es
 == 1) {

179 
ls
->
mš
 =†s->
max
 = 
ts
->
§m¶es
[
j
].
Ï‹ncy
;

181 ià(
ls
->
mš
 > 
ts
->
§m¶es
[
j
].
Ï‹ncy
)

182 
ls
->
mš
 = 
ts
->
§m¶es
[
j
].
Ï‹ncy
;

183 ià(
ls
->
max
 < 
ts
->
§m¶es
[
j
].
Ï‹ncy
)

184 
ls
->
max
 = 
ts
->
§m¶es
[
j
].
Ï‹ncy
;

186 
sum
 +ğ
ts
->
§m¶es
[
j
].
Ï‹ncy
;

189 ià(
ls
->
³riod
 =ğ0 || 
ts
->
§m¶es
[
j
].
time
 <†s->period)

190 
ls
->
³riod
 = 
ts
->
§m¶es
[
j
].
time
;

196 ià(
ls
->
§m¶es
) {

197 
ls
->
avg
 = 
sum
 /†s->
§m¶es
;

198 
ls
->
³riod
 = 
	`time
(
NULL
) -†s->period;

199 ià(
ls
->
³riod
 == 0)†s->period = 1;

203 
sum
 = 0;

204 
j
 = 0; j < 
LATENCY_TS_LEN
; j++) {

205 
št64_t
 
d–
;

207 ià(
ts
->
§m¶es
[
j
].
time
 == 0) ;

208 
d–
 = (
št64_t
)
ls
->
avg
 - 
ts
->
§m¶es
[
j
].
Ï‹ncy
;

209 ià(
d–
 < 0) delta = -delta;

210 
sum
 +ğ
d–
;

212 ià(
ls
->
§m¶es
èls->
mad
 = 
sum
 /†s->samples;

213 
	}
}

216 
sds
 
	$ü—‹L©’cyR•Üt
() {

217 
sds
 
»pÜt
 = 
	`sd£m±y
();

218 
advi£_b‘‹r_vm
 = 0;

219 
advi£_¦owlog_’abËd
 = 0;

220 
advi£_¦owlog_tunšg
 = 0;

221 
advi£_¦owlog_š¥eù
 = 0;

222 
advi£_disk_cÚ‹ÁiÚ
 = 0;

223 
advi£_scheduËr
 = 0;

224 
advi£_d©a_wr™eback
 = 0;

225 
advi£_no_­³ndfsync
 = 0;

226 
advi£_loÿl_disk
 = 0;

227 
advi£_ssd
 = 0;

228 
advi£_wr™e_lßd_šfo
 = 0;

229 
advi£_hz
 = 0;

230 
advi£_Ïrge_objeùs
 = 0;

231 
advi£_mass_eviùiÚ
 = 0;

232 
advi£_»Ïx_fsync_pŞicy
 = 0;

233 
advi£_di§bË_thp
 = 0;

234 
adviûs
 = 0;

238 ià(
	`diùSize
(
£rv”
.
Ï‹ncy_ev’ts
) == 0 &&

239 
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
 == 0)

241 
»pÜt
 = 
	`sdsÿt
(report,"I'm sorry, Dave, I can't dohat. Latency monitoring is disabled inhis Redis instance. You may use \"CONFIG SET†atency-monitor-threshold <milliseconds>.\" in orderoƒnable it. If we weren't in‡ deep space mission I'd suggestoake‡†ook‡t http://redis.io/topics/latency-monitor.\n");

242  
»pÜt
;

247 
diùI‹¿tÜ
 *
di
;

248 
diùEÁry
 *
de
;

249 
ev’Šum
 = 0;

251 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
Ï‹ncy_ev’ts
);

252 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

253 *
ev’t
 = 
	`diùG‘Key
(
de
);

254 
Ï‹ncyTimeS”›s
 *
ts
 = 
	`diùG‘V®
(
de
);

255 
Ï‹ncySts
 
ls
;

257 ià(
ts
 =ğ
NULL
) ;

258 
ev’Šum
++;

259 ià(
ev’Šum
 == 1) {

260 
»pÜt
 = 
	`sdsÿt
(report,"Dave, I have observed†atency spikes inhis Redis instance. You don't mindalking‡bout it, do you Dave?\n\n");

262 
	`ª®yzeL©’cyFÜEv’t
(
ev’t
,&
ls
);

264 
»pÜt
 = 
	`sdsÿrštf
(report,

266 
ev’Šum
, 
ev’t
,

267 
ls
.
§m¶es
,

268 (è
ls
.
avg
,

269 (è
ls
.
mad
,

270 (è
ls
.
³riod
/ls.
§m¶es
,

271 (è
ts
->
max
);

274 ià(!
	`¡rÿ£cmp
(
ev’t
,"fork")) {

275 *
fÜk_qu®™y
;

276 ià(
£rv”
.
¡©_fÜk_¿‹
 < 10) {

277 
fÜk_qu®™y
 = "terrible";

278 
advi£_b‘‹r_vm
 = 1;

279 
adviûs
++;

280 } ià(
£rv”
.
¡©_fÜk_¿‹
 < 25) {

281 
fÜk_qu®™y
 = "poor";

282 
advi£_b‘‹r_vm
 = 1;

283 
adviûs
++;

284 } ià(
£rv”
.
¡©_fÜk_¿‹
 < 100) {

285 
fÜk_qu®™y
 = "good";

287 
fÜk_qu®™y
 = "excellent";

289 
»pÜt
 = 
	`sdsÿrštf
(report,

290 " FÜk„©i %.2àGB/£ø(%s).", 
£rv”
.
¡©_fÜk_¿‹
,

291 
fÜk_qu®™y
);

295 ià(!
	`¡rÿ£cmp
(
ev’t
,"command")) {

296 ià(
£rv”
.
¦owlog_log_¦ow”_thª
 == 0) {

297 
advi£_¦owlog_’abËd
 = 1;

298 
adviûs
++;

299 } ià(
£rv”
.
¦owlog_log_¦ow”_thª
/1000 >

300 
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
)

302 
advi£_¦owlog_tunšg
 = 1;

303 
adviûs
++;

305 
advi£_¦owlog_š¥eù
 = 1;

306 
advi£_Ïrge_objeùs
 = 1;

307 
adviûs
 += 2;

311 ià(!
	`¡rÿ£cmp
(
ev’t
,"fast-command")) {

312 
advi£_scheduËr
 = 1;

313 
adviûs
++;

317 ià(!
	`¡rÿ£cmp
(
ev’t
,"aof-write-pending-fsync")) {

318 
advi£_loÿl_disk
 = 1;

319 
advi£_disk_cÚ‹ÁiÚ
 = 1;

320 
advi£_ssd
 = 1;

321 
advi£_d©a_wr™eback
 = 1;

322 
adviûs
 += 4;

325 ià(!
	`¡rÿ£cmp
(
ev’t
,"aof-write-active-child")) {

326 
advi£_no_­³ndfsync
 = 1;

327 
advi£_d©a_wr™eback
 = 1;

328 
advi£_ssd
 = 1;

329 
adviûs
 += 3;

332 ià(!
	`¡rÿ£cmp
(
ev’t
,"aof-write-alone")) {

333 
advi£_loÿl_disk
 = 1;

334 
advi£_d©a_wr™eback
 = 1;

335 
advi£_ssd
 = 1;

336 
adviûs
 += 3;

339 ià(!
	`¡rÿ£cmp
(
ev’t
,"aof-fsync-always")) {

340 
advi£_»Ïx_fsync_pŞicy
 = 1;

341 
adviûs
++;

344 ià(!
	`¡rÿ£cmp
(
ev’t
,"aof-fstat") ||

345 !
	`¡rÿ£cmp
(
ev’t
,"rdb-unlik-temp-file")) {

346 
advi£_disk_cÚ‹ÁiÚ
 = 1;

347 
advi£_loÿl_disk
 = 1;

348 
adviûs
 += 2;

351 ià(!
	`¡rÿ£cmp
(
ev’t
,"aof-rewrite-diff-write") ||

352 !
	`¡rÿ£cmp
(
ev’t
,"aof-rename")) {

353 
advi£_wr™e_lßd_šfo
 = 1;

354 
advi£_d©a_wr™eback
 = 1;

355 
advi£_ssd
 = 1;

356 
advi£_loÿl_disk
 = 1;

357 
adviûs
 += 4;

361 ià(!
	`¡rÿ£cmp
(
ev’t
,"expire-cycle")) {

362 
advi£_hz
 = 1;

363 
advi£_Ïrge_objeùs
 = 1;

364 
adviûs
 += 2;

368 ià(!
	`¡rÿ£cmp
(
ev’t
,"eviction-del")) {

369 
advi£_Ïrge_objeùs
 = 1;

370 
adviûs
++;

373 ià(!
	`¡rÿ£cmp
(
ev’t
,"eviction-cycle")) {

374 
advi£_mass_eviùiÚ
 = 1;

375 
adviûs
++;

378 
»pÜt
 = 
	`sdsÿ’
(report,"\n",1);

380 
	`diùR–—£I‹¿tÜ
(
di
);

383 ià(
	`THPG‘AnÚHugePagesSize
() > 0) {

384 
advi£_di§bË_thp
 = 1;

385 
adviûs
++;

388 ià(
ev’Šum
 =ğ0 && 
adviûs
 == 0) {

389 
»pÜt
 = 
	`sdsÿt
(report,"Dave,‚o†atency spike was observed duringhe†ifetime ofhis Redis instance,‚ot inhe slightest bit. I honestlyhink you oughto sit down calmly,ake‡ stress…ill,‡ndhinkhings over.\n");

390 } ià(
ev’Šum
 > 0 && 
adviûs
 == 0) {

391 
»pÜt
 = 
	`sdsÿt
(report,"\nWhilehere‡re†atencyƒvents†ogged, I'm‚ot‡bleo suggest‡nyƒasy fix. Please usehe Redis communityo get some help,…rovidinghis„eport in your help„equest.\n");

396 
»pÜt
 = 
	`sdsÿt
(report,"\nI have‡ few‡dvices for you:\n\n");

397 ià(
advi£_b‘‹r_vm
) {

398 
»pÜt
 = 
	`sdsÿt
(report,"- If you‡re using‡ virtual machine, consider upgrading it with‡ faster one using‡n hypervisiorhat…rovides†ess†atency during fork() calls. Xen is knowno have…oor fork()…erformance. Even inhe context ofhe same VM…rovider, certain kinds of instances canƒxecute fork fasterhan others.\n");

402 ià(
advi£_¦owlog_’abËd
) {

403 
»pÜt
 = 
	`sdsÿrštf
Ô•Üt,"- Th”¬Ï‹ncy issue w™h…Ù’tŸÎy slow commªd you‡» usšg. TryØ’abËhSlow Log Redi ã©u» usšghcommªd 'CONFIG SET slowlog-log-¦ow”-thª %Îu'. IàthSlow†og i di§bËd Redi i nÙ‡bËØlog slow commªd executiÚ fÜ you.\n", ()
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
*1000);

406 ià(
advi£_¦owlog_tunšg
) {

407 
»pÜt
 = 
	`sdsÿrštf
Ô•Üt,"- You¸cu¼’ˆSlow Log cÚfigu¿tiÚ oÆy†og ev’t th©‡» slow”hª you¸cÚfigu»d†©’cy mÚ™Üh»shŞd. PËa£ u£ 'CONFIG SET slowlog-log-¦ow”-thª %Îu'.\n", ()
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
*1000);

410 ià(
advi£_¦owlog_š¥eù
) {

411 
»pÜt
 = 
	`sdsÿt
(report,"- Check your Slow Logo understand what‡rehe commands you‡re„unning which‡reoo slowoƒxecute. Please check http://redis.io/commands/slowlog for more information.\n");

415 ià(
advi£_scheduËr
) {

416 
»pÜt
 = 
	`sdsÿt
(report,"- The system is slowoƒxecute Redis code…aths‚ot containing system calls. This usually meanshe system does‚ot…rovide Redis CPUimeo„un for†ong…eriods. You shouldryo:\n"

425 ià(
advi£_loÿl_disk
) {

426 
»pÜt
 = 
	`sdsÿt
(report,"- It is strongly‡dvisedo use†ocal disks for…ersistence,ƒspecially if you‡re using AOF. Remote disks…rovided by…latform-as-a-service…roviders‡re knowno be slow.\n");

429 ià(
advi£_ssd
) {

430 
»pÜt
 = 
	`sdsÿt
(report,"- SSD disks‡re‡bleo„educe fsync†atency,‡ndotalime‚eeded for snapshotting‡nd AOF†og„ewriting (resulting in smaller memory usage‡nd smaller final AOF„ewrite buffer flushes). Withƒxtremely high write†oad SSD disks can be‡ good option. However Redis should…erform„easonably with high†oad using‚ormal disks. Usehis‡dvice‡s‡†ast„esort.\n");

433 ià(
advi£_d©a_wr™eback
) {

434 
»pÜt
 = 
	`sdsÿt
(report,"- Mountingƒxt3/4 filesystems with data=writeback can…rovide‡…erformance boost comparedo data=ordered, howeverhis mode of operation…rovides†ess guarantees,‡nd sometimes it can happenhat‡fter‡ hard crashhe AOF file will have‡n half-written command‡theƒnd‡nd will„equireo be„epaired before Redis„estarts.\n");

437 ià(
advi£_disk_cÚ‹ÁiÚ
) {

438 
»pÜt
 = 
	`sdsÿt
(report,"- Tryo†owerhe disk contention. This is often caused by other disk intensive…rocesses„unning inhe same computer (including other Redis instances).\n");

441 ià(
advi£_no_­³ndfsync
) {

442 
»pÜt
 = 
	`sdsÿt
(report,"- Assuming fromhe…oint of view of data safetyhis is viable in yourƒnvironment, you couldryoƒnablehe 'no-appendfsync-on-rewrite' option, sohat fsync will‚ot be…erformed whilehere is‡ child„ewritinghe AOF file or…roducing‡n RDB file (the moment wherehere is high disk contention).\n");

445 ià(
advi£_»Ïx_fsync_pŞicy
 && 
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_ALWAYS
) {

446 
»pÜt
 = 
	`sdsÿt
(report,"- Your fsync…olicy is seto 'always'. It is very hardo get good…erformances with such‡ setup, if…ossibleryo„elaxhe fsync…olicyo 'onesec'.\n");

449 ià(
advi£_wr™e_lßd_šfo
) {

450 
»pÜt
 = 
	`sdsÿt
(report,"- Latency duringhe AOF‡tomic„ename operation or whenhe final difference is flushedohe AOF file‡theƒnd ofhe„ewrite, sometimes is caused by very high write†oad, causinghe AOF buffero get very†arge. If…ossibleryo send†ess commandso‡ccomplishhe same work, or use Lua scriptso group multiple operations into‡ single EVALSHA call.\n");

453 ià(
advi£_hz
 && 
£rv”
.
hz
 < 100) {

454 
»pÜt
 = 
	`sdsÿt
(report,"- In ordero makehe Redis keysƒxpiring…rocess more incremental,ryo sethe 'hz' configuration…arametero 100 using 'CONFIG SET hz 100'.\n");

457 ià(
advi£_Ïrge_objeùs
) {

458 
»pÜt
 = 
	`sdsÿt
(report,"- Deleting,ƒxpiring orƒvicting (because of maxmemory…olicy)†arge objects is‡ blocking operation. If you have very†arge objectshat‡re often deleted,ƒxpired, orƒvicted,ryo fragmenthose objects into multiple smaller objects.\n");

461 ià(
advi£_mass_eviùiÚ
) {

462 
»pÜt
 = 
	`sdsÿt
(report,"- Sudden changesohe 'maxmemory' setting via 'CONFIG SET', or‡llocation of†arge objects via sets or sorted sets intersections, STORE option of SORT, Redis Cluster†arge keys migrations (RESTORE command), may create sudden memory…ressure forcinghe servero blockryingoƒvict keys. \n");

465 ià(
advi£_di§bË_thp
) {

466 
»pÜt
 = 
	`sdsÿt
(report,"- I detected‡‚on zero‡mount of‡nonymous huge…ages used by your…rocess. This creates very serious†atencyƒvents in different conditions,ƒspecially when Redis is…ersisting on disk. To disable THP support usehe command 'echo‚ever > /sys/kernel/mm/transparent_hugepage/enabled', make sureo‡lso‡dd it into /etc/rc.local sohathe command will beƒxecuted‡gain‡fter‡„eboot. Notehatƒven if you have‡lready disabled THP, you still‚eedo„estarthe Redis…rocesso get„id ofhe huge…ages‡lready created.\n");

470  
»pÜt
;

471 
	}
}

477 
	$Ï‹ncyCommªdR•lyW™hSam¶es
(
ş›Á
 *
c
, 
Ï‹ncyTimeS”›s
 *
ts
) {

478 *
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

479 
§m¶es
 = 0, 
j
;

481 
j
 = 0; j < 
LATENCY_TS_LEN
; j++) {

482 
i
 = (
ts
->
idx
 + 
j
è% 
LATENCY_TS_LEN
;

484 ià(
ts
->
§m¶es
[
i
].
time
 == 0) ;

485 
	`addR•lyMuÉiBulkL’
(
c
,2);

486 
	`addR•lyLÚgLÚg
(
c
,
ts
->
§m¶es
[
i
].
time
);

487 
	`addR•lyLÚgLÚg
(
c
,
ts
->
§m¶es
[
i
].
Ï‹ncy
);

488 
§m¶es
++;

490 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn
,
§m¶es
);

491 
	}
}

495 
	$Ï‹ncyCommªdR•lyW™hL©e¡Ev’ts
(
ş›Á
 *
c
) {

496 
diùI‹¿tÜ
 *
di
;

497 
diùEÁry
 *
de
;

499 
	`addR•lyMuÉiBulkL’
(
c
,
	`diùSize
(
£rv”
.
Ï‹ncy_ev’ts
));

500 
di
 = 
	`diùG‘I‹¿tÜ
(
£rv”
.
Ï‹ncy_ev’ts
);

501 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

502 *
ev’t
 = 
	`diùG‘Key
(
de
);

503 
Ï‹ncyTimeS”›s
 *
ts
 = 
	`diùG‘V®
(
de
);

504 
Ï¡
 = (
ts
->
idx
 + 
LATENCY_TS_LEN
 - 1) % LATENCY_TS_LEN;

506 
	`addR•lyMuÉiBulkL’
(
c
,4);

507 
	`addR•lyBulkCSŒšg
(
c
,
ev’t
);

508 
	`addR•lyLÚgLÚg
(
c
,
ts
->
§m¶es
[
Ï¡
].
time
);

509 
	`addR•lyLÚgLÚg
(
c
,
ts
->
§m¶es
[
Ï¡
].
Ï‹ncy
);

510 
	`addR•lyLÚgLÚg
(
c
,
ts
->
max
);

512 
	`diùR–—£I‹¿tÜ
(
di
);

513 
	}
}

515 
	#LATENCY_GRAPH_COLS
 80

	)

516 
sds
 
	$Ï‹ncyCommªdG’S·rk–še
(*
ev’t
, 
Ï‹ncyTimeS”›s
 *
ts
) {

517 
j
;

518 
£qu’û
 *
£q
 = 
	`ü—‹S·rklšeSequ’û
();

519 
sds
 
g¿ph
 = 
	`sd£m±y
();

520 
ušt32_t
 
mš
 = 0, 
max
 = 0;

522 
j
 = 0; j < 
LATENCY_TS_LEN
; j++) {

523 
i
 = (
ts
->
idx
 + 
j
è% 
LATENCY_TS_LEN
;

524 
–­£d
;

525 
buf
[64];

527 ià(
ts
->
§m¶es
[
i
].
time
 == 0) ;

529 ià(
£q
->
Ëngth
 == 0) {

530 
mš
 = 
max
 = 
ts
->
§m¶es
[
i
].
Ï‹ncy
;

532 ià(
ts
->
§m¶es
[
i
].
Ï‹ncy
 > 
max
) max =s->samples[i].latency;

533 ià(
ts
->
§m¶es
[
i
].
Ï‹ncy
 < 
mš
) min =s->samples[i].latency;

537 
–­£d
 = 
	`time
(
NULL
è- 
ts
->
§m¶es
[
i
].
time
;

538 ià(
–­£d
 < 60)

539 
	`¢´štf
(
buf
,(buf),"%ds",
–­£d
);

540 ià(
–­£d
 < 3600)

541 
	`¢´štf
(
buf
,(buf),"%dm",
–­£d
/60);

542 ià(
–­£d
 < 3600*24)

543 
	`¢´štf
(
buf
,(buf),"%dh",
–­£d
/3600);

545 
	`¢´štf
(
buf
,(buf),"%dd",
–­£d
/(3600*24));

546 
	`¥¬klšeSequ’ûAddSam¶e
(
£q
,
ts
->
§m¶es
[
i
].
Ï‹ncy
,
buf
);

549 
g¿ph
 = 
	`sdsÿrštf
(graph,

550 "% - high %lu ms,†ow %lu m ×Îimhigh %lu ms)\n", 
ev’t
,

551 (è
max
, (è
mš
, (è
ts
->max);

552 
j
 = 0; j < 
LATENCY_GRAPH_COLS
; j++)

553 
g¿ph
 = 
	`sdsÿ’
(graph,"-",1);

554 
g¿ph
 = 
	`sdsÿ’
(graph,"\n",1);

555 
g¿ph
 = 
	`¥¬klšeR’d”
(g¿ph,
£q
,
LATENCY_GRAPH_COLS
,4,
SPARKLINE_FILL
);

556 
	`ä“S·rklšeSequ’û
(
£q
);

557  
g¿ph
;

558 
	}
}

567 
	$Ï‹ncyCommªd
(
ş›Á
 *
c
) {

568 
Ï‹ncyTimeS”›s
 *
ts
;

570 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"hi¡Üy"è&& c->
¬gc
 == 3) {

572 
ts
 = 
	`diùF‘chV®ue
(
£rv”
.
Ï‹ncy_ev’ts
,
c
->
¬gv
[2]->
±r
);

573 ià(
ts
 =ğ
NULL
) {

574 
	`addR•lyMuÉiBulkL’
(
c
,0);

576 
	`Ï‹ncyCommªdR•lyW™hSam¶es
(
c
,
ts
);

578 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"g¿ph"è&& c->
¬gc
 == 3) {

580 
sds
 
g¿ph
;

581 
diùEÁry
 *
de
;

582 *
ev’t
;

584 
de
 = 
	`diùFšd
(
£rv”
.
Ï‹ncy_ev’ts
,
c
->
¬gv
[2]->
±r
);

585 ià(
de
 =ğ
NULL
è
nod©«¼
;

586 
ts
 = 
	`diùG‘V®
(
de
);

587 
ev’t
 = 
	`diùG‘Key
(
de
);

589 
g¿ph
 = 
	`Ï‹ncyCommªdG’S·rk–še
(
ev’t
,
ts
);

590 
	`addR•lyBulkCSŒšg
(
c
,
g¿ph
);

591 
	`sdsä“
(
g¿ph
);

592 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"Ï‹¡"è&& c->
¬gc
 == 2) {

594 
	`Ï‹ncyCommªdR•lyW™hL©e¡Ev’ts
(
c
);

595 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"doùÜ"è&& c->
¬gc
 == 2) {

597 
sds
 
»pÜt
 = 
	`ü—‹L©’cyR•Üt
();

599 
	`addR•lyBulkCBufãr
(
c
,
»pÜt
,
	`sd¦’
(report));

600 
	`sdsä“
(
»pÜt
);

601 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"»£t"è&& c->
¬gc
 >= 2) {

603 ià(
c
->
¬gc
 == 2) {

604 
	`addR•lyLÚgLÚg
(
c
,
	`Ï‹ncyRe£tEv’t
(
NULL
));

606 
j
, 
»£ts
 = 0;

608 
j
 = 2; j < 
c
->
¬gc
; j++)

609 
»£ts
 +ğ
	`Ï‹ncyRe£tEv’t
(
c
->
¬gv
[
j
]->
±r
);

610 
	`addR•lyLÚgLÚg
(
c
,
»£ts
);

613 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

617 
nod©«¼
:

620 
	`addR•lyE¼ÜFÜm©
(
c
,

621 "NØ§m¶e avaabË fÜƒv’ˆ'%s'", (*è
c
->
¬gv
[2]->
±r
);

622 
	}
}

	@latency.h

34 #iâdeà
__LATENCY_H


35 
	#__LATENCY_H


	)

37 
	#LATENCY_TS_LEN
 160

	)

41 
	sÏ‹ncySam¶e
 {

42 
št32_t
 
	mtime
;

43 
ušt32_t
 
	mÏ‹ncy
;

47 
	sÏ‹ncyTimeS”›s
 {

48 
	midx
;

49 
ušt32_t
 
	mmax
;

50 
Ï‹ncySam¶e
 
	m§m¶es
[
LATENCY_TS_LEN
];

54 
	sÏ‹ncySts
 {

55 
ušt32_t
 
	m®l_time_high
;

56 
ušt32_t
 
	mavg
;

57 
ušt32_t
 
	mmš
;

58 
ušt32_t
 
	mmax
;

59 
ušt32_t
 
	mmad
;

60 
ušt32_t
 
	m§m¶es
;

61 
time_t
 
	m³riod
;

64 
Ï‹ncyMÚ™ÜIn™
();

65 
Ï‹ncyAddSam¶e
(*
ev’t
, 
m¡ime_t
 
Ï‹ncy
);

66 
THPIsEÇbËd
();

71 
	#Ï‹ncyS¹MÚ™Ü
(
v¬
èià(
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
) { \

72 
v¬
 = 
	`m¡ime
(); \

74 
v¬
 = 0; \

75 }

	)

79 
	#Ï‹ncyEndMÚ™Ü
(
v¬
èià(
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
) { \

80 
v¬
 = 
	`m¡ime
() - var; \

81 }

	)

84 
	#Ï‹ncyAddSam¶eIfN“ded
(
ev’t
,
v¬
) \

85 ià(
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
 && \

86 (
v¬
è>ğ
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
) \

87 
	`Ï‹ncyAddSam¶e
((
ev’t
),(
v¬
));

	)

90 
	#Ï‹ncyRemoveNe¡edEv’t
(
ev’t_v¬
,
Ã¡ed_v¬
) \

91 
ev’t_v¬
 +ğ
Ã¡ed_v¬
;

	)

	@lazyfree.c

1 
	~"£rv”.h
"

2 
	~"bio.h
"

3 
	~"©omicv¬.h
"

4 
	~"şu¡”.h
"

6 
size_t
 
	gÏzyä“_objeùs
 = 0;

7 
±h»ad_mu‹x_t
 
	gÏzyä“_objeùs_mu‹x
 = 
PTHREAD_MUTEX_INITIALIZER
;

10 
size_t
 
	$Ïzyä“G‘P’dšgObjeùsCouÁ
() {

11 
size_t
 
aux
;

12 
	`©omicG‘
(
Ïzyä“_objeùs
,
aux
);

13  
aux
;

14 
	}
}

31 
size_t
 
	$Ïzyä“G‘F»eEffÜt
(
robj
 *
obj
) {

32 ià(
obj
->
ty³
 =ğ
OBJ_LIST
) {

33 
quickli¡
 *
ql
 = 
obj
->
±r
;

34  
ql
->
Ën
;

35 } ià(
obj
->
ty³
 =ğ
OBJ_SET
 && obj->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

36 
diù
 *
ht
 = 
obj
->
±r
;

37  
	`diùSize
(
ht
);

38 } ià(
obj
->
ty³
 =ğ
OBJ_ZSET
 && obj->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
){

39 
z£t
 *
zs
 = 
obj
->
±r
;

40  
zs
->
z¦
->
Ëngth
;

41 } ià(
obj
->
ty³
 =ğ
OBJ_HASH
 && obj->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

42 
diù
 *
ht
 = 
obj
->
±r
;

43  
	`diùSize
(
ht
);

47 
	}
}

53 
	#LAZYFREE_THRESHOLD
 64

	)

54 
	$dbAsyncD–‘e
(
»disDb
 *
db
, 
robj
 *
key
) {

57 ià(
	`diùSize
(
db
->
expœes
è> 0è
	`diùD–‘e
(db->expœes,
key
->
±r
);

62 
diùEÁry
 *
de
 = 
	`diùUÆšk
(
db
->
diù
,
key
->
±r
);

63 ià(
de
) {

64 
robj
 *
v®
 = 
	`diùG‘V®
(
de
);

65 
size_t
 
ä“_effÜt
 = 
	`Ïzyä“G‘F»eEffÜt
(
v®
);

69 ià(
ä“_effÜt
 > 
LAZYFREE_THRESHOLD
) {

70 
	`©omicInü
(
Ïzyä“_objeùs
,1);

71 
	`bioC»©eBackgroundJob
(
BIO_LAZY_FREE
,
v®
,
NULL
,NULL);

72 
	`diùS‘V®
(
db
->
diù
,
de
,
NULL
);

78 ià(
de
) {

79 
	`diùF»eUÆškedEÁry
(
db
->
diù
,
de
);

80 ià(
£rv”
.
şu¡”_’abËd
è
	`¦ÙToKeyD–
(
key
);

85 
	}
}

90 
	$em±yDbAsync
(
»disDb
 *
db
) {

91 
diù
 *
Şdht1
 = 
db
->diù, *
Şdht2
 = db->
expœes
;

92 
db
->
diù
 = 
	`diùC»©e
(&
dbDiùTy³
,
NULL
);

93 
db
->
expœes
 = 
	`diùC»©e
(&
key±rDiùTy³
,
NULL
);

94 
	`©omicInü
(
Ïzyä“_objeùs
,
	`diùSize
(
Şdht1
));

95 
	`bioC»©eBackgroundJob
(
BIO_LAZY_FREE
,
NULL
,
Şdht1
,
Şdht2
);

96 
	}
}

100 
	$¦ÙToKeyFlushAsync
() {

101 
¿x
 *
Şd
 = 
£rv”
.
şu¡”
->
¦Ùs_to_keys
;

103 
£rv”
.
şu¡”
->
¦Ùs_to_keys
 = 
	`¿xNew
();

104 
	`mem£t
(
£rv”
.
şu¡”
->
¦Ùs_keys_couÁ
,0,

105 (
£rv”
.
şu¡”
->
¦Ùs_keys_couÁ
));

106 
	`©omicInü
(
Ïzyä“_objeùs
,
Şd
->
num–e
);

107 
	`bioC»©eBackgroundJob
(
BIO_LAZY_FREE
,
NULL
,NULL,
Şd
);

108 
	}
}

112 
	$Ïzyä“F»eObjeùFromBioTh»ad
(
robj
 *
o
) {

113 
	`deüRefCouÁ
(
o
);

114 
	`©omicDeü
(
Ïzyä“_objeùs
,1);

115 
	}
}

122 
	$Ïzyä“F»eD©aba£FromBioTh»ad
(
diù
 *
ht1
, diù *
ht2
) {

123 
size_t
 
numkeys
 = 
	`diùSize
(
ht1
);

124 
	`diùR–—£
(
ht1
);

125 
	`diùR–—£
(
ht2
);

126 
	`©omicDeü
(
Ïzyä“_objeùs
,
numkeys
);

127 
	}
}

131 
	$Ïzyä“F»eSlÙsM­FromBioTh»ad
(
¿x
 *
¹
) {

132 
size_t
 
Ën
 = 
¹
->
num–e
;

133 
	`¿xF»e
(
¹
);

134 
	`©omicDeü
(
Ïzyä“_objeùs
,
Ën
);

135 
	}
}

	@lzf.h

37 #iâdeà
LZF_H


38 
	#LZF_H


	)

49 
	#LZF_VERSION
 0x0105

	)

77 
lzf_com´ess
 (cÚ¡ *cÚ¡ 
š_d©a
, 
š_Ën
,

78 *
out_d©a
, 
out_Ën
);

96 
lzf_decom´ess
 (cÚ¡ *cÚ¡ 
š_d©a
, 
š_Ën
,

97 *
out_d©a
, 
out_Ën
);

	@lzfP.h

37 #iâdeà
LZFP_h


38 
	#LZFP_h


	)

40 
	#STANDALONE
 1

	)

42 #iâdeà
STANDALONE


43 
	~"lzf.h
"

54 #iâdeà
HLOG


55 
	#HLOG
 16

	)

63 #iâdeà
VERY_FAST


64 
	#VERY_FAST
 1

	)

74 #iâdeà
ULTRA_FAST


75 
	#ULTRA_FAST
 0

	)

81 #iâdeà
STRICT_ALIGN


82 
	#STRICT_ALIGN
 !(
	`defšed
(
__i386
è|| defšed (
__amd64
))

	)

90 #iâdeà
INIT_HTAB


91 
	#INIT_HTAB
 0

	)

99 #iâdeà
AVOID_ERRNO


100 
	#AVOID_ERRNO
 0

	)

108 #iâdeà
LZF_STATE_ARG


109 
	#LZF_STATE_ARG
 0

	)

120 #iâdeà
CHECK_INPUT


121 
	#CHECK_INPUT
 1

	)

134 #ifdeà
__ılu¥lus


135 
	~<c¡ršg
>

136 
	~<şim™s
>

137 
usšg
 
Çme¥aû
 
	g¡d
;

139 
	~<¡ršg.h
>

140 
	~<lim™s.h
>

143 #iâdeà
LZF_USE_OFFSETS


144 #ià
defšed
 (
WIN32
)

145 
	#LZF_USE_OFFSETS
 
	`defšed
(
_M_X64
)

	)

147 #ià
__ılu¥lus
 > 199711L

148 
	~<c¡dšt
>

150 
	~<¡dšt.h
>

152 
	#LZF_USE_OFFSETS
 (
UINTPTR_MAX
 > 0xffffffffU)

	)

156 
	tu8
;

158 #ià
LZF_USE_OFFSETS


159 
	#LZF_HSLOT_BIAS
 ((cÚ¡ 
u8
 *)
š_d©a
)

	)

160 
	tLZF_HSLOT
;

162 
	#LZF_HSLOT_BIAS
 0

	)

163 cÚ¡ 
	tu8
 *
	tLZF_HSLOT
;

166 
LZF_HSLOT
 
	tLZF_STATE
[1 << (
HLOG
)];

168 #ià!
STRICT_ALIGN


170 #ià
USHRT_MAX
 == 65535

171 
	tu16
;

172 #–ià
UINT_MAX
 == 65535

173 
	tu16
;

175 #undeà
STRICT_ALIGN


176 
	#STRICT_ALIGN
 1

	)

180 #ià
ULTRA_FAST


181 #undeà
VERY_FAST


	@lzf_c.c

37 
	~"lzfP.h
"

39 
	#HSIZE
 (1 << (
HLOG
))

	)

47 #iâdeà
FRST


48 
	#FRST
(
p
è((Õ[0]è<< 8è|…[1])

	)

49 
	#NEXT
(
v
,
p
è(((vè<< 8è|…[2])

	)

50 #ià
ULTRA_FAST


51 
	#IDX
(
h
è((Ğh >> (3*8 - 
HLOG
)è- h ) & (
HSIZE
 - 1))

	)

52 #–ià
VERY_FAST


53 
	#IDX
(
h
è((Ğh >> (3*8 - 
HLOG
)è- h*5è& (
HSIZE
 - 1))

	)

55 
	#IDX
(
h
è((((h ^ (h << 5)è>> (3*8 - 
HLOG
)è- h*5è& (
HSIZE
 - 1))

	)

69 
	#FRST
(
p
èÕ[0] << 5è^…[1]

	)

70 
	#NEXT
(
v
,
p
è((vè<< 5è^…[2]

	)

71 
	#IDX
(
h
è((hè& (
HSIZE
 - 1))

	)

74 
	#MAX_LIT
 (1 << 5)

	)

75 
	#MAX_OFF
 (1 << 13)

	)

76 
	#MAX_REF
 ((1 << 8è+ (1 << 3))

	)

78 #ià
__GNUC__
 >= 3

79 
	#ex³ù
(
ex´
,
v®ue
è
	`__butš_ex³ù
 (Óx´),(v®ue))

	)

80 
	#šlše
 
šlše


	)

82 
	#ex³ù
(
ex´
,
v®ue
èÓx´)

	)

83 
	#šlše
 

	)

86 
	#ex³ù_çl£
(
ex´
è
	`ex³ù
 (Óx´è!ğ0, 0)

	)

87 
	#ex³ù_Œue
(
ex´
è
	`ex³ù
 (Óx´è!ğ0, 1)

	)

99 
lzf_com´ess
 (cÚ¡ *cÚ¡ 
š_d©a
, 
š_Ën
,

100 *
out_d©a
, 
out_Ën


101 #ià
LZF_STATE_ARG


102 , 
LZF_STATE
 
hb


106 #ià!
LZF_STATE_ARG


107 
LZF_STATE
 
	ghb
;

109 cÚ¡ 
u8
 *
	g
 = (cÚ¡ u8 *)
š_d©a
;

110 
u8
 *
	gİ
 = (u8 *)
out_d©a
;

111 cÚ¡ 
u8
 *
	gš_’d
 = 

 + 
š_Ën
;

112 
u8
 *
	gout_’d
 = 
İ
 + 
out_Ën
;

113 cÚ¡ 
u8
 *
	g»f
;

122 #ià
defšed
 (
WIN32
è&& defšed (
_M_X64
)

123 
_št64
 
	goff
;

125 
	goff
;

127 
	ghv®
;

128 
	gl™
;

130 ià(!
	gš_Ën
 || !
	gout_Ën
)

133 #ià
INIT_HTAB


134 
mem£t
 (
hb
, 0,  (htab));

137 
	gl™
 = 0; 
	gİ
++;

139 
	ghv®
 = 
FRST
 (

);

140 
	g
 < 
	gš_’d
 - 2)

142 
LZF_HSLOT
 *
	gh¦Ù
;

144 
	ghv®
 = 
NEXT
 (
hv®
, 

);

145 
	gh¦Ù
 = 
hb
 + 
IDX
 (
hv®
);

146 
	g»f
 = *
h¦Ù
 + 
LZF_HSLOT_BIAS
; *
	gh¦Ù
 = 

 - LZF_HSLOT_BIAS;

149 #ià
INIT_HTAB


150 && 
	g»f
 < 
	g


152 && (
	goff
 = 

 - 
»f
 - 1è< 
MAX_OFF


153 && 
»f
 > (
u8
 *)
š_d©a


154 && 
»f
[2] =ğ

[2]

155 #ià
STRICT_ALIGN


156 && ((
»f
[1] << 8è|„ef[0]è=ğ((

[1] << 8) | ip[0])

158 && *(
u16
 *)
»f
 =ğ*(u16 *)



163 
Ën
 = 2;

164 
	gmaxËn
 = 
š_’d
 - 

 - 
Ën
;

165 
	gmaxËn
 = 
maxËn
 > 
MAX_REF
 ? MAX_REF : maxlen;

167 ià(
ex³ù_çl£
 (
İ
 + 3 + 1 >ğ
out_’d
))

168 ià(
İ
 - !
l™
 + 3 + 1 >ğ
out_’d
)

171 
	gİ
 [- 
l™
 - 1] =†it - 1;

172 
	gİ
 -ğ!
l™
;

176 ià(
ex³ù_Œue
 (
maxËn
 > 16))

178 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

179 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

180 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

181 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

183 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

184 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

185 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

186 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

188 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

189 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

190 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

191 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

193 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

194 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

195 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

196 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

200 
	gËn
++;

201 
	gËn
 < 
	gmaxËn
 && 
	g»f
[
Ën
] =ğ

[len]);

206 
	gËn
 -= 2;

207 
	g
++;

209 ià(
	gËn
 < 7)

211 *
	gİ
++ = (
off
 >> 8è+ (
Ën
 << 5);

215 *
	gİ
++ = (
off
 >> 8) + ( 7 << 5);

216 *
	gİ
++ = 
Ën
 - 7;

219 *
	gİ
++ = 
off
;

221 
	gl™
 = 0; 
	gİ
++;

223 
	g
 +ğ
Ën
 + 1;

225 ià(
ex³ù_çl£
 (

 >ğ
š_’d
 - 2))

228 #ià
ULTRA_FAST
 || 
VERY_FAST


229 --
	g
;

230 #ià
VERY_FAST
 && !
ULTRA_FAST


231 --
	g
;

233 
	ghv®
 = 
FRST
 (

);

235 
	ghv®
 = 
NEXT
 (
hv®
, 

);

236 
	ghb
[
IDX
 (
hv®
)] = 

 - 
LZF_HSLOT_BIAS
;

237 
	g
++;

239 #ià
VERY_FAST
 && !
ULTRA_FAST


240 
	ghv®
 = 
NEXT
 (
hv®
, 

);

241 
	ghb
[
IDX
 (
hv®
)] = 

 - 
LZF_HSLOT_BIAS
;

242 
	g
++;

245 
	g
 -ğ
Ën
 + 1;

249 
	ghv®
 = 
NEXT
 (
hv®
, 

);

250 
	ghb
[
IDX
 (
hv®
)] = 

 - 
LZF_HSLOT_BIAS
;

251 
	g
++;

253 
	gËn
--);

259 ià(
ex³ù_çl£
 (
İ
 >ğ
out_’d
))

262 
	gl™
++; *
	gİ
++ = *

++;

264 ià(
ex³ù_çl£
 (
l™
 =ğ
MAX_LIT
))

266 
İ
 [- 
l™
 - 1] =†it - 1;

267 
	gl™
 = 0; 
	gİ
++;

272 ià(
	gİ
 + 3 > 
	gout_’d
)

275 
	g
 < 
	gš_’d
)

277 
	gl™
++; *
	gİ
++ = *

++;

279 ià(
ex³ù_çl£
 (
l™
 =ğ
MAX_LIT
))

281 
İ
 [- 
l™
 - 1] =†it - 1;

282 
	gl™
 = 0; 
	gİ
++;

286 
	gİ
 [- 
l™
 - 1] =†it - 1;

287 
	gİ
 -ğ!
l™
;

289  
	gİ
 - (
	gu8
 *)
	gout_d©a
;

	@lzf_d.c

37 
	~"lzfP.h
"

39 #ià
AVOID_ERRNO


40 
	#SET_ERRNO
(
n
)

	)

42 
	~<”ºo.h
>

43 
	#SET_ERRNO
(
n
è
”ºo
 = (n)

	)

46 #ià
USE_REP_MOVSB


47 #ià(
__i386
 || 
__amd64
è&& 
__GNUC__
 >= 3

48 
	#lzf_movsb
(
d¡
, 
¤c
, 
Ën
) \

49 
	`asm
 ("rep movsb" \

50 : "=D" (
d¡
), "=S" (
¤c
), "=c" (
Ën
) \

51 : "0" (
d¡
), "1" (
¤c
), "2" (
Ën
));

	)

56 
	$lzf_decom´ess
 (cÚ¡ *cÚ¡ 
š_d©a
, 
š_Ën
,

57 *
out_d©a
, 
out_Ën
)

59 
u8
 cÚ¡ *

 = (cÚ¡ u8 *)
š_d©a
;

60 
u8
 *
İ
 = (u8 *)
out_d©a
;

61 
u8
 cÚ¡ *cÚ¡ 
š_’d
 = 

 + 
š_Ën
;

62 
u8
 *cÚ¡ 
out_’d
 = 
İ
 + 
out_Ën
;

66 
ù¾
 = *

++;

68 ià(
ù¾
 < (1 << 5))

70 
ù¾
++;

72 ià(
İ
 + 
ù¾
 > 
out_’d
)

74 
	`SET_ERRNO
 (
E2BIG
);

78 #ià
CHECK_INPUT


79 ià(

 + 
ù¾
 > 
š_’d
)

81 
	`SET_ERRNO
 (
EINVAL
);

86 #ifdeà
lzf_movsb


87 
	`lzf_movsb
 (
İ
, 

, 
ù¾
);

89 
ù¾
)

91 32: *
İ
++ = *

++; 31: *op++ = *ip++; 30: *op++ = *ip++; 29: *op++ = *ip++;

92 28: *
İ
++ = *

++; 27: *op++ = *ip++; 26: *op++ = *ip++; 25: *op++ = *ip++;

93 24: *
İ
++ = *

++; 23: *op++ = *ip++; 22: *op++ = *ip++; 21: *op++ = *ip++;

94 20: *
İ
++ = *

++; 19: *op++ = *ip++; 18: *op++ = *ip++; 17: *op++ = *ip++;

95 16: *
İ
++ = *

++; 15: *op++ = *ip++; 14: *op++ = *ip++; 13: *op++ = *ip++;

96 12: *
İ
++ = *

++; 11: *op++ = *ip++; 10: *op++ = *ip++; 9: *op++ = *ip++;

97 8: *
İ
++ = *

++; 7: *op++ = *ip++; 6: *op++ = *ip++; 5: *op++ = *ip++;

98 4: *
İ
++ = *

++; 3: *op++ = *ip++; 2: *op++ = *ip++; 1: *op++ = *ip++;

104 
Ën
 = 
ù¾
 >> 5;

106 
u8
 *
»f
 = 
İ
 - ((
ù¾
 & 0x1f) << 8) - 1;

108 #ià
CHECK_INPUT


109 ià(

 >ğ
š_’d
)

111 
	`SET_ERRNO
 (
EINVAL
);

115 ià(
Ën
 == 7)

117 
Ën
 +ğ*

++;

118 #ià
CHECK_INPUT


119 ià(

 >ğ
š_’d
)

121 
	`SET_ERRNO
 (
EINVAL
);

127 
»f
 -ğ*

++;

129 ià(
İ
 + 
Ën
 + 2 > 
out_’d
)

131 
	`SET_ERRNO
 (
E2BIG
);

135 ià(
»f
 < (
u8
 *)
out_d©a
)

137 
	`SET_ERRNO
 (
EINVAL
);

141 #ifdeà
lzf_movsb


142 
Ën
 += 2;

143 
	`lzf_movsb
 (
İ
, 
»f
, 
Ën
);

145 
Ën
)

148 
Ën
 += 2;

150 ià(
İ
 >ğ
»f
 + 
Ën
)

153 
	`memıy
 (
İ
, 
»f
, 
Ën
);

154 
İ
 +ğ
Ën
;

160 *
İ
++ = *
»f
++;

161 --
Ën
);

166 9: *
İ
++ = *
»f
++;

167 8: *
İ
++ = *
»f
++;

168 7: *
İ
++ = *
»f
++;

169 6: *
İ
++ = *
»f
++;

170 5: *
İ
++ = *
»f
++;

171 4: *
İ
++ = *
»f
++;

172 3: *
İ
++ = *
»f
++;

173 2: *
İ
++ = *
»f
++;

174 1: *
İ
++ = *
»f
++;

175 0: *
İ
++ = *
»f
++;

176 *
İ
++ = *
»f
++;

181 

 < 
š_’d
);

183  
İ
 - (
u8
 *)
out_d©a
;

184 
	}
}

	@memtest.c

29 
	~<¡dšt.h
>

30 
	~<¡dlib.h
>

31 
	~<¡dio.h
>

32 
	~<¡ršg.h
>

33 
	~<as£¹.h
>

34 
	~<lim™s.h
>

35 
	~<”ºo.h
>

36 
	~<‹rmios.h
>

37 
	~<sys/ioùl.h
>

38 #ià
defšed
(
__sun
)

39 
	~<¡rİts.h
>

41 
	~"cÚfig.h
"

43 #ià(
ULONG_MAX
 == 4294967295UL)

44 
	#MEMTEST_32BIT


	)

45 #–ià(
ULONG_MAX
 == 18446744073709551615ULL)

46 
	#MEMTEST_64BIT


	)

51 #ifdeà
MEMTEST_32BIT


52 
	#ULONG_ONEZERO
 0x¯¯¯¯UL

	)

53 
	#ULONG_ZEROONE
 0x55555555UL

	)

55 
	#ULONG_ONEZERO
 0x¯¯¯¯¯¯¯¯UL

	)

56 
	#ULONG_ZEROONE
 0x5555555555555555UL

	)

59 
wšsize
 
	gws
;

60 
size_t
 
	g´og»ss_´š‹d
;

61 
size_t
 
	g´og»ss_fuÎ
;

63 
	$mem‹¡_´og»ss_¡¬t
(*
t™Ë
, 
·ss
) {

64 
j
;

66 
	`´štf
("\x1b[H\x1b[2J");

68 
j
 = 0; j < 
ws
.
ws_cŞ
*(ws.
ws_row
-2); j++è
	`´štf
(".");

69 
	`´štf
("Please keepheest„unning several minutes…er GB of memory.\n");

70 
	`´štf
("Also check http://www.memtest86.com/‡nd http://pyropus.ca/software/memtester/");

71 
	`´štf
("\x1b[H\x1b[2K");

72 
	`´štf
("% [%d]\n", 
t™Ë
, 
·ss
);

73 
´og»ss_´š‹d
 = 0;

74 
´og»ss_fuÎ
 = 
ws
.
ws_cŞ
*(ws.
ws_row
-3);

75 
	`fæush
(
¡dout
);

76 
	}
}

78 
	$mem‹¡_´og»ss_’d
() {

79 
	`´štf
("\x1b[H\x1b[2J");

80 
	}
}

82 
	$mem‹¡_´og»ss_¡•
(
size_t
 
cu¼
, size_ˆ
size
, 
c
) {

83 
size_t
 
ch¬s
 = (()
cu¼
*
´og»ss_fuÎ
)/
size
, 
j
;

85 
j
 = 0; j < 
ch¬s
-
´og»ss_´š‹d
; j++è
	`´štf
("%c",
c
);

86 
´og»ss_´š‹d
 = 
ch¬s
;

87 
	`fæush
(
¡dout
);

88 
	}
}

93 
	$mem‹¡_add»ssšg
(*
l
, 
size_t
 
by‹s
, 
š‹¿ùive
) {

94 
wÜds
 = 
by‹s
/();

95 
j
, *
p
;

98 
p
 = 
l
;

99 
j
 = 0; j < 
wÜds
; j++) {

100 *
p
 = ()p;

101 
p
++;

102 ià((
j
 & 0xffffè=ğ0 && 
š‹¿ùive
)

103 
	`mem‹¡_´og»ss_¡•
(
j
,
wÜds
*2,'A');

106 
p
 = 
l
;

107 
j
 = 0; j < 
wÜds
; j++) {

108 ià(*
p
 != ()p) {

109 ià(
š‹¿ùive
) {

110 
	`´štf
("\n*** MEMORY ADDRESSING ERROR: %p contains %lu\n",

111 (*è
p
, *p);

112 
	`ex™
(1);

116 
p
++;

117 ià((
j
 & 0xffffè=ğ0 && 
š‹¿ùive
)

118 
	`mem‹¡_´og»ss_¡•
(
j
+
wÜds
,words*2,'A');

121 
	}
}

131 
	#xÜshiá64¡¬_Ãxt
() do { \

132 
r£ed
 ^=„seed >> 12; \

133 
r£ed
 ^=„seed << 25; \

134 
r£ed
 ^=„seed >> 27; \

135 
rout
 = 
r£ed
 * 
	`UINT64_C
(2685821657736338717); \

136 } 0)

	)

138 
	$mem‹¡_fl_¿ndom
(*
l
, 
size_t
 
by‹s
, 
š‹¿ùive
) {

139 
¡•
 = 4096/();

140 
wÜds
 = 
by‹s
/()/2;

141 
iwÜds
 = 
wÜds
/
¡•
;

142 
off
, 
w
, *
l1
, *
l2
;

143 
ušt64_t
 
r£ed
 = 
	`UINT64_C
(0xd13133de9afdb566);

144 
ušt64_t
 
rout
 = 0;

146 
	`as£¹
((
by‹s
 & 4095) == 0);

147 
off
 = 0; ofà< 
¡•
; off++) {

148 
l1
 = 
l
+
off
;

149 
l2
 = 
l1
+
wÜds
;

150 
w
 = 0; w < 
iwÜds
; w++) {

151 
	`xÜshiá64¡¬_Ãxt
();

152 *
l1
 = *
l2
 = (è
rout
;

153 
l1
 +ğ
¡•
;

154 
l2
 +ğ
¡•
;

155 ià((
w
 & 0xffffè=ğ0 && 
š‹¿ùive
)

156 
	`mem‹¡_´og»ss_¡•
(
w
+
iwÜds
*
off
,
wÜds
,'R');

159 
	}
}

163 
	$mem‹¡_fl_v®ue
(*
l
, 
size_t
 
by‹s
, 
v1
,

164 
v2
, 
sym
, 
š‹¿ùive
)

166 
¡•
 = 4096/();

167 
wÜds
 = 
by‹s
/()/2;

168 
iwÜds
 = 
wÜds
/
¡•
;

169 
off
, 
w
, *
l1
, *
l2
, 
v
;

171 
	`as£¹
((
by‹s
 & 4095) == 0);

172 
off
 = 0; ofà< 
¡•
; off++) {

173 
l1
 = 
l
+
off
;

174 
l2
 = 
l1
+
wÜds
;

175 
v
 = (
off
 & 1è? 
v2
 : 
v1
;

176 
w
 = 0; w < 
iwÜds
; w++) {

177 #ifdeà
MEMTEST_32BIT


178 *
l1
 = *
l2
 = ((è
v
) |

179 (((è
v
) << 16);

181 *
l1
 = *
l2
 = ((è
v
) |

182 (((è
v
) << 16) |

183 (((è
v
) << 32) |

184 (((è
v
) << 48);

186 
l1
 +ğ
¡•
;

187 
l2
 +ğ
¡•
;

188 ià((
w
 & 0xffffè=ğ0 && 
š‹¿ùive
)

189 
	`mem‹¡_´og»ss_¡•
(
w
+
iwÜds
*
off
,
wÜds
,
sym
);

192 
	}
}

194 
	$mem‹¡_com·»
(*
l
, 
size_t
 
by‹s
, 
š‹¿ùive
) {

195 
wÜds
 = 
by‹s
/()/2;

196 
w
, *
l1
, *
l2
;

198 
	`as£¹
((
by‹s
 & 4095) == 0);

199 
l1
 = 
l
;

200 
l2
 = 
l1
+
wÜds
;

201 
w
 = 0; w < 
wÜds
; w++) {

202 ià(*
l1
 !ğ*
l2
) {

203 ià(
š‹¿ùive
) {

204 
	`´štf
("\n*** MEMORY ERROR DETECTED: %p != %p (%lu vs %lu)\n",

205 (*)
l1
, (*)
l2
, *l1, *l2);

206 
	`ex™
(1);

210 
l1
 ++;

211 
l2
 ++;

212 ià((
w
 & 0xffffè=ğ0 && 
š‹¿ùive
)

213 
	`mem‹¡_´og»ss_¡•
(
w
,
wÜds
,'=');

216 
	}
}

218 
	$mem‹¡_com·»_times
(*
m
, 
size_t
 
by‹s
, 
·ss
, 
times
,

219 
š‹¿ùive
)

221 
j
;

222 
”rÜs
 = 0;

224 
j
 = 0; j < 
times
; j++) {

225 ià(
š‹¿ùive
è
	`mem‹¡_´og»ss_¡¬t
("Com·»",
·ss
);

226 
”rÜs
 +ğ
	`mem‹¡_com·»
(
m
,
by‹s
,
š‹¿ùive
);

227 ià(
š‹¿ùive
è
	`mem‹¡_´og»ss_’d
();

229  
”rÜs
;

230 
	}
}

237 
	$mem‹¡_‹¡
(*
m
, 
size_t
 
by‹s
, 
·s£s
, 
š‹¿ùive
) {

238 
·ss
 = 0;

239 
”rÜs
 = 0;

241 
·ss
 !ğ
·s£s
) {

242 
·ss
++;

244 ià(
š‹¿ùive
è
	`mem‹¡_´og»ss_¡¬t
("Add»ssšge¡",
·ss
);

245 
”rÜs
 +ğ
	`mem‹¡_add»ssšg
(
m
,
by‹s
,
š‹¿ùive
);

246 ià(
š‹¿ùive
è
	`mem‹¡_´og»ss_’d
();

248 ià(
š‹¿ùive
è
	`mem‹¡_´og»ss_¡¬t
("Rªdom fl",
·ss
);

249 
	`mem‹¡_fl_¿ndom
(
m
,
by‹s
,
š‹¿ùive
);

250 ià(
š‹¿ùive
è
	`mem‹¡_´og»ss_’d
();

251 
”rÜs
 +ğ
	`mem‹¡_com·»_times
(
m
,
by‹s
,
·ss
,4,
š‹¿ùive
);

253 ià(
š‹¿ùive
è
	`mem‹¡_´og»ss_¡¬t
("SŞid fl",
·ss
);

254 
	`mem‹¡_fl_v®ue
(
m
,
by‹s
,0,()-1,'S',
š‹¿ùive
);

255 ià(
š‹¿ùive
è
	`mem‹¡_´og»ss_’d
();

256 
”rÜs
 +ğ
	`mem‹¡_com·»_times
(
m
,
by‹s
,
·ss
,4,
š‹¿ùive
);

258 ià(
š‹¿ùive
è
	`mem‹¡_´og»ss_¡¬t
("Check”bßrd fl",
·ss
);

259 
	`mem‹¡_fl_v®ue
(
m
,
by‹s
,
ULONG_ONEZERO
,
ULONG_ZEROONE
,'C',
š‹¿ùive
);

260 ià(
š‹¿ùive
è
	`mem‹¡_´og»ss_’d
();

261 
”rÜs
 +ğ
	`mem‹¡_com·»_times
(
m
,
by‹s
,
·ss
,4,
š‹¿ùive
);

263  
”rÜs
;

264 
	}
}

275 
	#MEMTEST_BACKUP_WORDS
 (1024*(1024/()))

	)

279 
	#MEMTEST_DECACHE_SIZE
 (1024*8)

	)

280 
	$mem‹¡_´e£rvšg_‹¡
(*
m
, 
size_t
 
by‹s
, 
·s£s
) {

281 
backup
[
MEMTEST_BACKUP_WORDS
];

282 *
p
 = 
m
;

283 *
’d
 = (*è(((*)
m
)+(
by‹s
-
MEMTEST_DECACHE_SIZE
));

284 
size_t
 
Ëá
 = 
by‹s
;

285 
”rÜs
 = 0;

287 ià(
by‹s
 & 4095)  0;

288 ià(
by‹s
 < 4096*2)  0;

290 
Ëá
) {

294 ià(
Ëá
 == 4096) {

295 
Ëá
 += 4096;

296 
p
 -= 4096/();

299 
·ss
 = 0;

300 
size_t
 
Ën
 = (
Ëá
 > (
backup
)) ? (backup) :†eft;

303 ià(
Ën
/4096 % 2)†en -= 4096;

305 
	`memıy
(
backup
,
p
,
Ën
);

306 
·ss
 !ğ
·s£s
) {

307 
·ss
++;

308 
”rÜs
 +ğ
	`mem‹¡_add»ssšg
(
p
,
Ën
,0);

309 
	`mem‹¡_fl_¿ndom
(
p
,
Ën
,0);

310 ià(
by‹s
 >ğ
MEMTEST_DECACHE_SIZE
) {

311 
	`mem‹¡_com·»_times
(
m
,
MEMTEST_DECACHE_SIZE
,
·ss
,1,0);

312 
	`mem‹¡_com·»_times
(
’d
,
MEMTEST_DECACHE_SIZE
,
·ss
,1,0);

314 
”rÜs
 +ğ
	`mem‹¡_com·»_times
(
p
,
Ën
,
·ss
,4,0);

315 
	`mem‹¡_fl_v®ue
(
p
,
Ën
,0,()-1,'S',0);

316 ià(
by‹s
 >ğ
MEMTEST_DECACHE_SIZE
) {

317 
	`mem‹¡_com·»_times
(
m
,
MEMTEST_DECACHE_SIZE
,
·ss
,1,0);

318 
	`mem‹¡_com·»_times
(
’d
,
MEMTEST_DECACHE_SIZE
,
·ss
,1,0);

320 
”rÜs
 +ğ
	`mem‹¡_com·»_times
(
p
,
Ën
,
·ss
,4,0);

321 
	`mem‹¡_fl_v®ue
(
p
,
Ën
,
ULONG_ONEZERO
,
ULONG_ZEROONE
,'C',0);

322 ià(
by‹s
 >ğ
MEMTEST_DECACHE_SIZE
) {

323 
	`mem‹¡_com·»_times
(
m
,
MEMTEST_DECACHE_SIZE
,
·ss
,1,0);

324 
	`mem‹¡_com·»_times
(
’d
,
MEMTEST_DECACHE_SIZE
,
·ss
,1,0);

326 
”rÜs
 +ğ
	`mem‹¡_com·»_times
(
p
,
Ën
,
·ss
,4,0);

328 
	`memıy
(
p
,
backup
,
Ën
);

329 
Ëá
 -ğ
Ën
;

330 
p
 +ğ
Ën
/();

332  
”rÜs
;

333 
	}
}

336 
	$mem‹¡_®loc_ªd_‹¡
(
size_t
 
megaby‹s
, 
·s£s
) {

337 
size_t
 
by‹s
 = 
megaby‹s
*1024*1024;

338 *
m
 = 
	`m®loc
(
by‹s
);

340 ià(
m
 =ğ
NULL
) {

341 
	`årštf
(
¡d”r
,"Unableo‡llocate %zu megabytes: %s",

342 
megaby‹s
, 
	`¡»¼Ü
(
”ºo
));

343 
	`ex™
(1);

345 
	`mem‹¡_‹¡
(
m
,
by‹s
,
·s£s
,1);

346 
	`ä“
(
m
);

347 
	}
}

349 
	$mem‹¡
(
size_t
 
megaby‹s
, 
·s£s
) {

350 ià(
	`ioùl
(1, 
TIOCGWINSZ
, &
ws
) == -1) {

351 
ws
.
ws_cŞ
 = 80;

352 
ws
.
ws_row
 = 20;

354 
	`mem‹¡_®loc_ªd_‹¡
(
megaby‹s
,
·s£s
);

355 
	`´štf
("\nYour memory…assedhisest.\n");

356 
	`´štf
("Please if you‡re still in doubt usehe followingwoools:\n");

357 
	`´štf
("1) memtest86: http://www.memtest86.com/\n");

358 
	`´štf
("2) memtester: http://pyropus.ca/software/memtester/\n");

359 
	`ex™
(0);

360 
	}
}

	@module.c

30 
	~"£rv”.h
"

31 
	~"şu¡”.h
"

32 
	~<dlfú.h
>

34 
	#REDISMODULE_CORE
 1

	)

35 
	~"»dismoduË.h
"

44 
	sRedisModuË
 {

45 *
	mhªdË
;

46 *
	mÇme
;

47 
	mv”
;

48 
	m­iv”
;

49 
li¡
 *
	mty³s
;

51 
RedisModuË
 
	tRedisModuË
;

53 
diù
 *
	gmoduËs
;

57 
	sAutoMemEÁry
 {

58 *
	m±r
;

59 
	mty³
;

63 
	#REDISMODULE_AM_KEY
 0

	)

64 
	#REDISMODULE_AM_STRING
 1

	)

65 
	#REDISMODULE_AM_REPLY
 2

	)

66 
	#REDISMODULE_AM_FREED
 3

	)

81 
	#REDISMODULE_POOL_ALLOC_MIN_SIZE
 (1024*8)

	)

82 
	#REDISMODULE_POOL_ALLOC_ALIGN
 ((*))

	)

84 
	sRedisModuËPoŞAÎocBlock
 {

85 
ušt32_t
 
	msize
;

86 
ušt32_t
 
	mu£d
;

87 
RedisModuËPoŞAÎocBlock
 *
	mÃxt
;

88 
	mmemÜy
[];

89 } 
	tRedisModuËPoŞAÎocBlock
;

99 
	gRedisModuËBlockedCl›Á
;

101 
	sRedisModuËCtx
 {

102 *
	mg‘­ifunıŒ
;

103 
RedisModuË
 *
	mmoduË
;

104 
ş›Á
 *
	mş›Á
;

105 
RedisModuËBlockedCl›Á
 *
	mblocked_ş›Á
;

107 
AutoMemEÁry
 *
	mamqueue
;

108 
	mamqueue_Ën
;

109 
	mamqueue_u£d
;

110 
	mæags
;

111 **
	mpo¡pÚed_¬¿ys
;

112 
	mpo¡pÚed_¬¿ys_couÁ
;

113 *
	mblocked_´ivd©a
;

116 *
	mkeys_pos
;

117 
	mkeys_couÁ
;

119 
RedisModuËPoŞAÎocBlock
 *
	m·_h—d
;

121 
RedisModuËCtx
 
	tRedisModuËCtx
;

123 
	#REDISMODULE_CTX_INIT
 {(*)()&
RM_G‘Api
, 
NULL
, NULL, NULL, NULL, 0, 0, 0, NULL, 0, NULL, NULL, 0, NULL}

	)

124 
	#REDISMODULE_CTX_MULTI_EMITTED
 (1<<0)

	)

125 
	#REDISMODULE_CTX_AUTO_MEMORY
 (1<<1)

	)

126 
	#REDISMODULE_CTX_KEYS_POS_REQUEST
 (1<<2)

	)

127 
	#REDISMODULE_CTX_BLOCKED_REPLY
 (1<<3)

	)

128 
	#REDISMODULE_CTX_BLOCKED_TIMEOUT
 (1<<4)

	)

129 
	#REDISMODULE_CTX_THREAD_SAFE
 (1<<5)

	)

132 
	sRedisModuËKey
 {

133 
RedisModuËCtx
 *
	mùx
;

134 
»disDb
 *
	mdb
;

135 
robj
 *
	mkey
;

136 
robj
 *
	mv®ue
;

137 *
	m™”
;

138 
	mmode
;

141 
ušt32_t
 
	mzty³
;

142 
z¿nge¥ec
 
	mzrs
;

143 
zËx¿nge¥ec
 
	mzÌs
;

144 
ušt32_t
 
	mz¡¬t
;

145 
ušt32_t
 
	mz’d
;

146 *
	mzcu¼’t
;

147 
	mz”
;

150 
RedisModuËKey
 
	tRedisModuËKey
;

153 
	#REDISMODULE_ZSET_RANGE_NONE
 0

	)

154 
	#REDISMODULE_ZSET_RANGE_LEX
 1

	)

155 
	#REDISMODULE_ZSET_RANGE_SCORE
 2

	)

156 
	#REDISMODULE_ZSET_RANGE_POS
 3

	)

160 (*
	tRedisModuËCmdFunc
è(
	tRedisModuËCtx
 *
	tùx
, **
	t¬gv
, 
	t¬gc
);

163 
	sRedisModuËCommªdProxy
 {

164 
RedisModuË
 *
moduË
;

165 
RedisModuËCmdFunc
 
func
;

166 
»disCommªd
 *
»discmd
;

168 
RedisModuËCommªdProxy
 
	tRedisModuËCommªdProxy
;

170 
	#REDISMODULE_REPLYFLAG_NONE
 0

	)

171 
	#REDISMODULE_REPLYFLAG_TOPARSE
 (1<<0è

	)

172 
	#REDISMODULE_REPLYFLAG_NESTED
 (1<<1è

	)

178 
	sRedisModuËC®lR•ly
 {

179 
RedisModuËCtx
 *
ùx
;

180 
ty³
;

181 
æags
;

182 
size_t
 
Ën
;

183 *
´Ùo
;

184 
size_t
 
´ÙŞ’
;

186 cÚ¡ *
¡r
;

190 
Î
;

191 
RedisModuËC®lR•ly
 *
¬¿y
;

192 } 
v®
;

193 } 
	tRedisModuËC®lR•ly
;

197 
	sRedisModuËBlockedCl›Á
 {

198 
ş›Á
 *client;

200 
RedisModuË
 *
moduË
;

201 
RedisModuËCmdFunc
 
»¶y_ÿÎback
;

202 
RedisModuËCmdFunc
 
timeout_ÿÎback
;

203 (*
ä“_´ivd©a
)(*);

204 *
´ivd©a
;

207 
ş›Á
 *
»¶y_ş›Á
;

209 
dbid
;

210 } 
	tRedisModuËBlockedCl›Á
;

212 
±h»ad_mu‹x_t
 
moduËUnblockedCl›ÁsMu‹x
 = 
PTHREAD_MUTEX_INITIALIZER
;

213 
li¡
 *
moduËUnblockedCl›Ás
;

217 
±h»ad_mu‹x_t
 
moduËGIL
 = 
PTHREAD_MUTEX_INITIALIZER
;

223 
	`RM_F»eC®lR•ly
(
RedisModuËC®lR•ly
 *
»¶y
);

224 
	`RM_Clo£Key
(
RedisModuËKey
 *
key
);

225 
	`autoMemÜyCŞËù
(
RedisModuËCtx
 *
ùx
);

226 
robj
 **
	`moduËC»©eArgvFromU£rFÜm©
(cÚ¡ *
cmdÇme
, cÚ¡ *
fmt
, *
¬gı
, *
æags
, 
va_li¡
 
­
);

227 
	`moduËR•liÿ‹MuÉiIfN“ded
(
RedisModuËCtx
 *
ùx
);

228 
	`RM_Z£tRªgeStİ
(
RedisModuËKey
 *
kp
);

229 
	`z£tKeyRe£t
(
RedisModuËKey
 *
key
);

239 *
	$RM_AÎoc
(
size_t
 
by‹s
) {

240  
	`zm®loc
(
by‹s
);

241 
	}
}

247 *
	$RM_C®loc
(
size_t
 
nmemb
, size_ˆ
size
) {

248  
	`zÿÎoc
(
nmemb
*
size
);

249 
	}
}

252 * 
	$RM_R—Îoc
(*
±r
, 
size_t
 
by‹s
) {

253  
	`z»®loc
(
±r
,
by‹s
);

254 
	}
}

259 
	$RM_F»e
(*
±r
) {

260 
	`zä“
(
±r
);

261 
	}
}

264 *
	$RM_SŒdup
(cÚ¡ *
¡r
) {

265  
	`z¡rdup
(
¡r
);

266 
	}
}

273 
	$poŞAÎocR–—£
(
RedisModuËCtx
 *
ùx
) {

274 
RedisModuËPoŞAÎocBlock
 *
h—d
 = 
ùx
->
·_h—d
, *
Ãxt
;

276 
h—d
 !ğ
NULL
) {

277 
Ãxt
 = 
h—d
->next;

278 
	`zä“
(
h—d
);

279 
h—d
 = 
Ãxt
;

281 
ùx
->
·_h—d
 = 
NULL
;

282 
	}
}

296 *
	$RM_PoŞAÎoc
(
RedisModuËCtx
 *
ùx
, 
size_t
 
by‹s
) {

297 ià(
by‹s
 =ğ0è 
NULL
;

298 
RedisModuËPoŞAÎocBlock
 *
b
 = 
ùx
->
·_h—d
;

299 
size_t
 
Ëá
 = 
b
 ? b->
size
 - b->
u£d
 : 0;

302 ià(
Ëá
 >ğ
by‹s
) {

303 
size_t
 
®ignm’t
 = 
REDISMODULE_POOL_ALLOC_ALIGN
;

304 
by‹s
 < 
®ignm’t
 &&‡lignment/2 >= bytes)‡lignment /= 2;

305 ià(
b
->
u£d
 % 
®ignm’t
)

306 
b
->
u£d
 +ğ
®ignm’t
 - (b->used %‡lignment);

307 
Ëá
 = (
b
->
u£d
 > b->
size
) ? 0 : b->size - b->used;

311 ià(
Ëá
 < 
by‹s
) {

312 
size_t
 
blocksize
 = 
REDISMODULE_POOL_ALLOC_MIN_SIZE
;

313 ià(
blocksize
 < 
by‹s
) blocksize = bytes;

314 
b
 = 
	`zm®loc
((*bè+ 
blocksize
);

315 
b
->
size
 = 
blocksize
;

316 
b
->
u£d
 = 0;

317 
b
->
Ãxt
 = 
ùx
->
·_h—d
;

318 
ùx
->
·_h—d
 = 
b
;

321 *
»tv®
 = 
b
->
memÜy
 + b->
u£d
;

322 
b
->
u£d
 +ğ
by‹s
;

323  
»tv®
;

324 
	}
}

342 
	$moduËC»©eEm±yKey
(
RedisModuËKey
 *
key
, 
ty³
) {

343 
robj
 *
obj
;

346 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
è|| key->
v®ue
)

347  
REDISMODULE_ERR
;

349 
ty³
) {

350 
REDISMODULE_KEYTYPE_LIST
:

351 
obj
 = 
	`ü—‹Quickli¡Objeù
();

352 
	`quickli¡S‘O±iÚs
(
obj
->
±r
, 
£rv”
.
li¡_max_zli¡_size
,

353 
£rv”
.
li¡_com´ess_d•th
);

355 
REDISMODULE_KEYTYPE_ZSET
:

356 
obj
 = 
	`ü—‹Z£tZli¡Objeù
();

358 
REDISMODULE_KEYTYPE_HASH
:

359 
obj
 = 
	`ü—‹HashObjeù
();

361 :  
REDISMODULE_ERR
;

363 
	`dbAdd
(
key
->
db
,key->key,
obj
);

364 
key
->
v®ue
 = 
obj
;

365  
REDISMODULE_OK
;

366 
	}
}

378 
	$moduËD–KeyIfEm±y
(
RedisModuËKey
 *
key
) {

379 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
è|| key->
v®ue
 =ğ
NULL
)  0;

380 
i£m±y
;

381 
robj
 *
o
 = 
key
->
v®ue
;

383 
o
->
ty³
) {

384 
OBJ_LIST
: 
i£m±y
 = 
	`li¡Ty³L’gth
(
o
) == 0; ;

385 
OBJ_SET
: 
i£m±y
 = 
	`£tTy³Size
(
o
) == 0; ;

386 
OBJ_ZSET
: 
i£m±y
 = 
	`z£tL’gth
(
o
) == 0; ;

387 
OBJ_HASH
 : 
i£m±y
 = 
	`hashTy³L’gth
(
o
) == 0; ;

388 : 
i£m±y
 = 0;

391 ià(
i£m±y
) {

392 
	`dbD–‘e
(
key
->
db
,key->key);

393 
key
->
v®ue
 = 
NULL
;

398 
	}
}

416 
	$RM_G‘Api
(cÚ¡ *
funúame
, **
rg‘PŒPŒ
) {

417 
diùEÁry
 *
he
 = 
	`diùFšd
(
£rv”
.
moduË­i
, 
funúame
);

418 ià(!
he
è 
REDISMODULE_ERR
;

419 *
rg‘PŒPŒ
 = 
	`diùG‘V®
(
he
);

420  
REDISMODULE_OK
;

421 
	}
}

424 
	$moduËF»eCÚ‹xt
(
RedisModuËCtx
 *
ùx
) {

425 
	`autoMemÜyCŞËù
(
ùx
);

426 
	`poŞAÎocR–—£
(
ùx
);

427 ià(
ùx
->
po¡pÚed_¬¿ys
) {

428 
	`zä“
(
ùx
->
po¡pÚed_¬¿ys
);

429 
ùx
->
po¡pÚed_¬¿ys_couÁ
 = 0;

430 
	`£rv”Log
(
LL_WARNING
,

435 
ùx
->
moduË
->
Çme
);

437 ià(
ùx
->
æags
 & 
REDISMODULE_CTX_THREAD_SAFE
è
	`ä“Cl›Á
(ùx->
ş›Á
);

438 
	}
}

442 
	$moduËHªdËPrİag©iÚAá”CommªdC®lback
(
RedisModuËCtx
 *
ùx
) {

443 
ş›Á
 *
c
 = 
ùx
->client;

447 
	`´ev’tCommªdPrİag©iÚ
(
c
);

451 ià(
ùx
->
æags
 & 
REDISMODULE_CTX_MULTI_EMITTED
) {

452 
robj
 *
´İ¬gv
[1];

453 
´İ¬gv
[0] = 
	`ü—‹SŒšgObjeù
("EXEC",4);

454 
	`®soPrİag©e
(
£rv”
.
execCommªd
,
c
->
db
->
id
,
´İ¬gv
,1,

455 
PROPAGATE_AOF
|
PROPAGATE_REPL
);

456 
	`deüRefCouÁ
(
´İ¬gv
[0]);

458 
	}
}

462 
	$RedisModuËCommªdDi¥©ch”
(
ş›Á
 *
c
) {

463 
RedisModuËCommªdProxy
 *
ı
 = (*)()
c
->
cmd
->
g‘keys_´oc
;

464 
RedisModuËCtx
 
ùx
 = 
REDISMODULE_CTX_INIT
;

466 
ùx
.
moduË
 = 
ı
->module;

467 
ùx
.
ş›Á
 = 
c
;

468 
ı
->
	`func
(&
ùx
,(**)
c
->
¬gv
,c->
¬gc
);

469 
	`moduËHªdËPrİag©iÚAá”CommªdC®lback
(&
ùx
);

470 
	`moduËF»eCÚ‹xt
(&
ùx
);

471 
	}
}

482 *
	$moduËG‘CommªdKeysVŸAPI
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

483 
RedisModuËCommªdProxy
 *
ı
 = (*)()
cmd
->
g‘keys_´oc
;

484 
RedisModuËCtx
 
ùx
 = 
REDISMODULE_CTX_INIT
;

486 
ùx
.
moduË
 = 
ı
->module;

487 
ùx
.
ş›Á
 = 
NULL
;

488 
ùx
.
æags
 |ğ
REDISMODULE_CTX_KEYS_POS_REQUEST
;

489 
ı
->
	`func
(&
ùx
,(**)
¬gv
,
¬gc
);

490 *
»s
 = 
ùx
.
keys_pos
;

491 ià(
numkeys
è*numkey ğ
ùx
.
keys_couÁ
;

492 
	`moduËF»eCÚ‹xt
(&
ùx
);

493  
»s
;

494 
	}
}

499 
	$RM_IsKeysPos™iÚReque¡
(
RedisModuËCtx
 *
ùx
) {

500  (
ùx
->
æags
 & 
REDISMODULE_CTX_KEYS_POS_REQUEST
) != 0;

501 
	}
}

517 
	$RM_KeyAtPos
(
RedisModuËCtx
 *
ùx
, 
pos
) {

518 ià(!(
ùx
->
æags
 & 
REDISMODULE_CTX_KEYS_POS_REQUEST
)) ;

519 ià(
pos
 <= 0) ;

520 
ùx
->
keys_pos
 = 
	`z»®loc
(ùx->keys_pos,()*(ùx->
keys_couÁ
+1));

521 
ùx
->
keys_pos
[ùx->
keys_couÁ
++] = 
pos
;

522 
	}
}

528 
	$commªdFÏgsFromSŒšg
(*
s
) {

529 
couÁ
, 
j
;

530 
æags
 = 0;

531 
sds
 *
tok’s
 = 
	`sds¥l™Ën
(
s
,
	`¡¾’
(s)," ",1,&
couÁ
);

532 
j
 = 0; j < 
couÁ
; j++) {

533 *
t
 = 
tok’s
[
j
];

534 ià(!
	`¡rÿ£cmp
(
t
,"wr™e")è
æags
 |ğ
CMD_WRITE
;

535 ià(!
	`¡rÿ£cmp
(
t
,"»adÚly")è
æags
 |ğ
CMD_READONLY
;

536 ià(!
	`¡rÿ£cmp
(
t
,"admš")è
æags
 |ğ
CMD_ADMIN
;

537 ià(!
	`¡rÿ£cmp
(
t
,"d’y-oom")è
æags
 |ğ
CMD_DENYOOM
;

538 ià(!
	`¡rÿ£cmp
(
t
,"d’y-süt")è
æags
 |ğ
CMD_NOSCRIPT
;

539 ià(!
	`¡rÿ£cmp
(
t
,"®low-lßdšg")è
æags
 |ğ
CMD_LOADING
;

540 ià(!
	`¡rÿ£cmp
(
t
,"pubsub")è
æags
 |ğ
CMD_PUBSUB
;

541 ià(!
	`¡rÿ£cmp
(
t
,"¿ndom")è
æags
 |ğ
CMD_RANDOM
;

542 ià(!
	`¡rÿ£cmp
(
t
,"®low-¡®e")è
æags
 |ğ
CMD_STALE
;

543 ià(!
	`¡rÿ£cmp
(
t
,"no-mÚ™Ü")è
æags
 |ğ
CMD_SKIP_MONITOR
;

544 ià(!
	`¡rÿ£cmp
(
t
,"ç¡")è
æags
 |ğ
CMD_FAST
;

545 ià(!
	`¡rÿ£cmp
(
t
,"g‘keys-­i")è
æags
 |ğ
CMD_MODULE_GETKEYS
;

546 ià(!
	`¡rÿ£cmp
(
t
,"no-şu¡”")è
æags
 |ğ
CMD_MODULE_NO_CLUSTER
;

549 
	`sdsä“¥l™»s
(
tok’s
,
couÁ
);

550 ià(
j
 !ğ
couÁ
)  -1;

551  
æags
;

552 
	}
}

607 
	$RM_C»©eCommªd
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
Çme
, 
RedisModuËCmdFunc
 
cmdfunc
, cÚ¡ *
¡ræags
, 
fœ¡key
, 
Ï¡key
, 
key¡•
) {

608 
æags
 = 
¡ræags
 ? 
	`commªdFÏgsFromSŒšg
((*)strflags) : 0;

609 ià(
æags
 =ğ-1è 
REDISMODULE_ERR
;

610 ià((
æags
 & 
CMD_MODULE_NO_CLUSTER
è&& 
£rv”
.
şu¡”_’abËd
)

611  
REDISMODULE_ERR
;

613 
»disCommªd
 *
»discmd
;

614 
RedisModuËCommªdProxy
 *
ı
;

615 
sds
 
cmdÇme
 = 
	`sd¢ew
(
Çme
);

618 ià(
	`lookupCommªd
((*)
Çme
è!ğ
NULL
) {

619 
	`sdsä“
(
cmdÇme
);

620  
REDISMODULE_ERR
;

630 
ı
 = 
	`zm®loc
((*cp));

631 
ı
->
moduË
 = 
ùx
->module;

632 
ı
->
func
 = 
cmdfunc
;

633 
ı
->
»discmd
 = 
	`zm®loc
((*rediscmd));

634 
ı
->
»discmd
->
Çme
 = 
cmdÇme
;

635 
ı
->
»discmd
->
´oc
 = 
RedisModuËCommªdDi¥©ch”
;

636 
ı
->
»discmd
->
¬™y
 = -1;

637 
ı
->
»discmd
->
æags
 = fÏg | 
CMD_MODULE
;

638 
ı
->
»discmd
->
g‘keys_´oc
 = (
»disG‘KeysProc
*)()cp;

639 
ı
->
»discmd
->
fœ¡key
 = firstkey;

640 
ı
->
»discmd
->
Ï¡key
 =†astkey;

641 
ı
->
»discmd
->
key¡•
 = keystep;

642 
ı
->
»discmd
->
miüo£cÚds
 = 0;

643 
ı
->
»discmd
->
ÿÎs
 = 0;

644 
	`diùAdd
(
£rv”
.
commªds
,
	`sdsdup
(
cmdÇme
),
ı
->
»discmd
);

645 
	`diùAdd
(
£rv”
.
Üig_commªds
,
	`sdsdup
(
cmdÇme
),
ı
->
»discmd
);

646  
REDISMODULE_OK
;

647 
	}
}

653 
	$RM_S‘ModuËA‰ribs
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
Çme
, 
v”
, 
­iv”
){

654 
RedisModuË
 *
moduË
;

656 ià(
ùx
->
moduË
 !ğ
NULL
) ;

657 
moduË
 = 
	`zm®loc
((*module));

658 
moduË
->
Çme
 = 
	`sd¢ew
((*)name);

659 
moduË
->
v”
 = ver;

660 
moduË
->
­iv”
 =‡piver;

661 
moduË
->
ty³s
 = 
	`li¡C»©e
();

662 
ùx
->
moduË
 = module;

663 
	}
}

666 
	$RM_Mli£cÚds
() {

667  
	`m¡ime
();

668 
	}
}

678 
	$RM_AutoMemÜy
(
RedisModuËCtx
 *
ùx
) {

679 
ùx
->
æags
 |ğ
REDISMODULE_CTX_AUTO_MEMORY
;

680 
	}
}

683 
	$autoMemÜyAdd
(
RedisModuËCtx
 *
ùx
, 
ty³
, *
±r
) {

684 ià(!(
ùx
->
æags
 & 
REDISMODULE_CTX_AUTO_MEMORY
)) ;

685 ià(
ùx
->
amqueue_u£d
 =ğùx->
amqueue_Ën
) {

686 
ùx
->
amqueue_Ën
 *= 2;

687 ià(
ùx
->
amqueue_Ën
 < 16) ctx->amqueue_len = 16;

688 
ùx
->
amqueue
 = 
	`z»®loc
(ùx->amqueue,(
AutoMemEÁry
)*ùx->
amqueue_Ën
);

690 
ùx
->
amqueue
[ùx->
amqueue_u£d
].
ty³
 =ype;

691 
ùx
->
amqueue
[ùx->
amqueue_u£d
].
±r
 =…tr;

692 
ùx
->
amqueue_u£d
++;

693 
	}
}

700 
	$autoMemÜyF»ed
(
RedisModuËCtx
 *
ùx
, 
ty³
, *
±r
) {

701 ià(!(
ùx
->
æags
 & 
REDISMODULE_CTX_AUTO_MEMORY
))  0;

703 
couÁ
 = (
ùx
->
amqueue_u£d
+1)/2;

704 
j
 = 0; j < 
couÁ
; j++) {

705 
side
 = 0; side < 2; side++) {

708 
i
 = (
side
 =ğ0è? (
ùx
->
amqueue_u£d
 - 1 - 
j
) : j;

709 ià(
ùx
->
amqueue
[
i
].
ty³
 ==ype &&

710 
ùx
->
amqueue
[
i
].
±r
 ==…tr)

712 
ùx
->
amqueue
[
i
].
ty³
 = 
REDISMODULE_AM_FREED
;

716 ià(
i
 !ğ
ùx
->
amqueue_u£d
-1) {

717 
ùx
->
amqueue
[
i
] = ctx->amqueue[ùx->
amqueue_u£d
-1];

722 
ùx
->
amqueue_u£d
--;

728 
	}
}

731 
	$autoMemÜyCŞËù
(
RedisModuËCtx
 *
ùx
) {

732 ià(!(
ùx
->
æags
 & 
REDISMODULE_CTX_AUTO_MEMORY
)) ;

736 
ùx
->
æags
 &ğ~
REDISMODULE_CTX_AUTO_MEMORY
;

737 
j
;

738 
j
 = 0; j < 
ùx
->
amqueue_u£d
; j++) {

739 *
±r
 = 
ùx
->
amqueue
[
j
].ptr;

740 
ùx
->
amqueue
[
j
].
ty³
) {

741 
REDISMODULE_AM_STRING
: 
	`deüRefCouÁ
(
±r
); ;

742 
REDISMODULE_AM_REPLY
: 
	`RM_F»eC®lR•ly
(
±r
); ;

743 
REDISMODULE_AM_KEY
: 
	`RM_Clo£Key
(
±r
); ;

746 
ùx
->
æags
 |ğ
REDISMODULE_CTX_AUTO_MEMORY
;

747 
	`zä“
(
ùx
->
amqueue
);

748 
ùx
->
amqueue
 = 
NULL
;

749 
ùx
->
amqueue_Ën
 = 0;

750 
ùx
->
amqueue_u£d
 = 0;

751 
	}
}

762 
RedisModuËSŒšg
 *
	$RM_C»©eSŒšg
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
±r
, 
size_t
 
Ën
) {

763 
RedisModuËSŒšg
 *
o
 = 
	`ü—‹SŒšgObjeù
(
±r
,
Ën
);

764 
	`autoMemÜyAdd
(
ùx
,
REDISMODULE_AM_STRING
,
o
);

765  
o
;

766 
	}
}

774 
RedisModuËSŒšg
 *
	$RM_C»©eSŒšgPrštf
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
fmt
, ...) {

775 
sds
 
s
 = 
	`sd£m±y
();

777 
va_li¡
 
­
;

778 
	`va_¡¬t
(
­
, 
fmt
);

779 
s
 = 
	`sdsÿtv´štf
(s, 
fmt
, 
­
);

780 
	`va_’d
(
­
);

782 
RedisModuËSŒšg
 *
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
, 
s
);

783 
	`autoMemÜyAdd
(
ùx
,
REDISMODULE_AM_STRING
,
o
);

785  
o
;

786 
	}
}

794 
RedisModuËSŒšg
 *
	$RM_C»©eSŒšgFromLÚgLÚg
(
RedisModuËCtx
 *
ùx
, 
Î
) {

795 
buf
[
LONG_STR_SIZE
];

796 
size_t
 
Ën
 = 
	`Î2¡ršg
(
buf
,(buf),
Î
);

797  
	`RM_C»©eSŒšg
(
ùx
,
buf
,
Ën
);

798 
	}
}

805 
RedisModuËSŒšg
 *
	$RM_C»©eSŒšgFromSŒšg
(
RedisModuËCtx
 *
ùx
, cÚ¡ 
RedisModuËSŒšg
 *
¡r
) {

806 
RedisModuËSŒšg
 *
o
 = 
	`dupSŒšgObjeù
(
¡r
);

807 
	`autoMemÜyAdd
(
ùx
,
REDISMODULE_AM_STRING
,
o
);

808  
o
;

809 
	}
}

817 
	$RM_F»eSŒšg
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 *
¡r
) {

818 
	`deüRefCouÁ
(
¡r
);

819 
	`autoMemÜyF»ed
(
ùx
,
REDISMODULE_AM_STRING
,
¡r
);

820 
	}
}

844 
	$RM_R‘ašSŒšg
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 *
¡r
) {

845 ià(!
	`autoMemÜyF»ed
(
ùx
,
REDISMODULE_AM_STRING
,
¡r
)) {

855 
	`šüRefCouÁ
(
¡r
);

857 
	}
}

862 cÚ¡ *
	$RM_SŒšgPŒL’
(cÚ¡ 
RedisModuËSŒšg
 *
¡r
, 
size_t
 *
Ën
) {

863 ià(
¡r
 =ğ
NULL
) {

864 cÚ¡ *
”rmsg
 = "(NULL string„eply„eferenced in module)";

865 ià(
Ën
è*ËÀğ
	`¡¾’
(
”rmsg
);

866  
”rmsg
;

868 ià(
Ën
è*ËÀğ
	`sd¦’
(
¡r
->
±r
);

869  
¡r
->
±r
;

870 
	}
}

880 
	$RM_SŒšgToLÚgLÚg
(cÚ¡ 
RedisModuËSŒšg
 *
¡r
, *
Î
) {

881  
	`¡ršg2Î
(
¡r
->
±r
,
	`sd¦’
(¡r->±r),
Î
è? 
REDISMODULE_OK
 :

882 
REDISMODULE_ERR
;

883 
	}
}

888 
	$RM_SŒšgToDoubË
(cÚ¡ 
RedisModuËSŒšg
 *
¡r
, *
d
) {

889 
»tv®
 = 
	`g‘DoubËFromObjeù
(
¡r
,
d
);

890  (
»tv®
 =ğ
C_OK
è? 
REDISMODULE_OK
 : 
REDISMODULE_ERR
;

891 
	}
}

896 
	$RM_SŒšgCom·»
(
RedisModuËSŒšg
 *
a
, RedisModuËSŒšg *
b
) {

897  
	`com·»SŒšgObjeùs
(
a
,
b
);

898 
	}
}

902 
RedisModuËSŒšg
 *
	$moduËAs£¹Unsh¬edSŒšg
(
RedisModuËSŒšg
 *
¡r
) {

903 ià(
¡r
->
»fcouÁ
 != 1) {

904 
	`£rv”Log
(
LL_WARNING
,

908  
NULL
;

910 ià(
¡r
->
’codšg
 =ğ
OBJ_ENCODING_EMBSTR
) {

913 
¡r
->
±r
 = 
	`sd¢ewËn
(¡r->±r,
	`sd¦’
(str->ptr));

914 
¡r
->
’codšg
 = 
OBJ_ENCODING_RAW
;

915 } ià(
¡r
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

917 
¡r
->
±r
 = 
	`sdsäomlÚglÚg
(()str->ptr);

918 
¡r
->
’codšg
 = 
OBJ_ENCODING_RAW
;

920  
¡r
;

921 
	}
}

926 
	$RM_SŒšgAµ’dBufãr
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 *
¡r
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

927 
	`UNUSED
(
ùx
);

928 
¡r
 = 
	`moduËAs£¹Unsh¬edSŒšg
(str);

929 ià(
¡r
 =ğ
NULL
è 
REDISMODULE_ERR
;

930 
¡r
->
±r
 = 
	`sdsÿ’
(¡r->±r,
buf
,
Ën
);

931  
REDISMODULE_OK
;

932 
	}
}

951 
	$RM_WrÚgAr™y
(
RedisModuËCtx
 *
ùx
) {

952 
	`addR•lyE¼ÜFÜm©
(
ùx
->
ş›Á
,

954 (*)
ùx
->
ş›Á
->
¬gv
[0]->
±r
);

955  
REDISMODULE_OK
;

956 
	}
}

971 
ş›Á
 *
	$moduËG‘R•lyCl›Á
(
RedisModuËCtx
 *
ùx
) {

972 ià(!(
ùx
->
æags
 & 
REDISMODULE_CTX_THREAD_SAFE
è&& ctx->
ş›Á
)

973  
ùx
->
ş›Á
;

974 ià(
ùx
->
blocked_ş›Á
)

975  
ùx
->
blocked_ş›Á
->
»¶y_ş›Á
;

976  
NULL
;

977 
	}
}

981 
	$RM_R•lyW™hLÚgLÚg
(
RedisModuËCtx
 *
ùx
, 
Î
) {

982 
ş›Á
 *
c
 = 
	`moduËG‘R•lyCl›Á
(
ùx
);

983 ià(
c
 =ğ
NULL
è 
REDISMODULE_OK
;

984 
	`addR•lyLÚgLÚg
(
c
,
Î
);

985  
REDISMODULE_OK
;

986 
	}
}

991 
	$»¶yW™hStus
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
msg
, *
´efix
) {

992 
ş›Á
 *
c
 = 
	`moduËG‘R•lyCl›Á
(
ùx
);

993 ià(
c
 =ğ
NULL
è 
REDISMODULE_OK
;

994 
sds
 
¡rmsg
 = 
	`sd¢ewËn
(
´efix
,1);

995 
¡rmsg
 = 
	`sdsÿt
(¡rmsg,
msg
);

996 
¡rmsg
 = 
	`sdsÿ’
(strmsg,"\r\n",2);

997 
	`addR•lySds
(
c
,
¡rmsg
);

998  
REDISMODULE_OK
;

999 
	}
}

1015 
	$RM_R•lyW™hE¼Ü
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
”r
) {

1016  
	`»¶yW™hStus
(
ùx
,
”r
,"-");

1017 
	}
}

1024 
	$RM_R•lyW™hSim¶eSŒšg
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
msg
) {

1025  
	`»¶yW™hStus
(
ùx
,
msg
,"+");

1026 
	}
}

1039 
	$RM_R•lyW™hA¼ay
(
RedisModuËCtx
 *
ùx
, 
Ën
) {

1040 
ş›Á
 *
c
 = 
	`moduËG‘R•lyCl›Á
(
ùx
);

1041 ià(
c
 =ğ
NULL
è 
REDISMODULE_OK
;

1042 ià(
Ën
 =ğ
REDISMODULE_POSTPONED_ARRAY_LEN
) {

1043 
ùx
->
po¡pÚed_¬¿ys
 = 
	`z»®loc
(ctx->postponed_arrays,(*)*

1044 (
ùx
->
po¡pÚed_¬¿ys_couÁ
+1));

1045 
ùx
->
po¡pÚed_¬¿ys
[ùx->
po¡pÚed_¬¿ys_couÁ
] =

1046 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

1047 
ùx
->
po¡pÚed_¬¿ys_couÁ
++;

1049 
	`addR•lyMuÉiBulkL’
(
c
,
Ën
);

1051  
REDISMODULE_OK
;

1052 
	}
}

1080 
	$RM_R•lyS‘A¼ayL’gth
(
RedisModuËCtx
 *
ùx
, 
Ën
) {

1081 
ş›Á
 *
c
 = 
	`moduËG‘R•lyCl›Á
(
ùx
);

1082 ià(
c
 =ğ
NULL
) ;

1083 ià(
ùx
->
po¡pÚed_¬¿ys_couÁ
 == 0) {

1084 
	`£rv”Log
(
LL_WARNING
,

1088 "ÿÎ.", 
ùx
->
moduË
->
Çme
);

1091 
ùx
->
po¡pÚed_¬¿ys_couÁ
--;

1092 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,

1093 
ùx
->
po¡pÚed_¬¿ys
[ùx->
po¡pÚed_¬¿ys_couÁ
],

1094 
Ën
);

1095 ià(
ùx
->
po¡pÚed_¬¿ys_couÁ
 == 0) {

1096 
	`zä“
(
ùx
->
po¡pÚed_¬¿ys
);

1097 
ùx
->
po¡pÚed_¬¿ys
 = 
NULL
;

1099 
	}
}

1104 
	$RM_R•lyW™hSŒšgBufãr
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

1105 
ş›Á
 *
c
 = 
	`moduËG‘R•lyCl›Á
(
ùx
);

1106 ià(
c
 =ğ
NULL
è 
REDISMODULE_OK
;

1107 
	`addR•lyBulkCBufãr
(
c
,(*)
buf
,
Ën
);

1108  
REDISMODULE_OK
;

1109 
	}
}

1114 
	$RM_R•lyW™hSŒšg
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 *
¡r
) {

1115 
ş›Á
 *
c
 = 
	`moduËG‘R•lyCl›Á
(
ùx
);

1116 ià(
c
 =ğ
NULL
è 
REDISMODULE_OK
;

1117 
	`addR•lyBulk
(
c
,
¡r
);

1118  
REDISMODULE_OK
;

1119 
	}
}

1125 
	$RM_R•lyW™hNuÎ
(
RedisModuËCtx
 *
ùx
) {

1126 
ş›Á
 *
c
 = 
	`moduËG‘R•lyCl›Á
(
ùx
);

1127 ià(
c
 =ğ
NULL
è 
REDISMODULE_OK
;

1128 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

1129  
REDISMODULE_OK
;

1130 
	}
}

1138 
	$RM_R•lyW™hC®lR•ly
(
RedisModuËCtx
 *
ùx
, 
RedisModuËC®lR•ly
 *
»¶y
) {

1139 
ş›Á
 *
c
 = 
	`moduËG‘R•lyCl›Á
(
ùx
);

1140 ià(
c
 =ğ
NULL
è 
REDISMODULE_OK
;

1141 
sds
 
´Ùo
 = 
	`sd¢ewËn
(
»¶y
->´Ùo,„•ly->
´ÙŞ’
);

1142 
	`addR•lySds
(
c
,
´Ùo
);

1143  
REDISMODULE_OK
;

1144 
	}
}

1152 
	$RM_R•lyW™hDoubË
(
RedisModuËCtx
 *
ùx
, 
d
) {

1153 
ş›Á
 *
c
 = 
	`moduËG‘R•lyCl›Á
(
ùx
);

1154 ià(
c
 =ğ
NULL
è 
REDISMODULE_OK
;

1155 
	`addR•lyDoubË
(
c
,
d
);

1156  
REDISMODULE_OK
;

1157 
	}
}

1166 
	$moduËR•liÿ‹MuÉiIfN“ded
(
RedisModuËCtx
 *
ùx
) {

1168 ià(
ùx
->
æags
 & 
REDISMODULE_CTX_MULTI_EMITTED
) ;

1172 ià(
ùx
->
æags
 & 
REDISMODULE_CTX_THREAD_SAFE
) ;

1173 
	`execCommªdPrİag©eMuÉi
(
ùx
->
ş›Á
);

1174 
ùx
->
æags
 |ğ
REDISMODULE_CTX_MULTI_EMITTED
;

1175 
	}
}

1196 
	$RM_R•liÿ‹
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
cmdÇme
, cÚ¡ *
fmt
, ...) {

1197 
»disCommªd
 *
cmd
;

1198 
robj
 **
¬gv
 = 
NULL
;

1199 
¬gc
 = 0, 
æags
 = 0, 
j
;

1200 
va_li¡
 
­
;

1202 
cmd
 = 
	`lookupCommªdByCSŒšg
((*)
cmdÇme
);

1203 ià(!
cmd
è 
REDISMODULE_ERR
;

1206 
	`va_¡¬t
(
­
, 
fmt
);

1207 
¬gv
 = 
	`moduËC»©eArgvFromU£rFÜm©
(
cmdÇme
,
fmt
,&
¬gc
,&
æags
,
­
);

1208 
	`va_’d
(
­
);

1209 ià(
¬gv
 =ğ
NULL
è 
REDISMODULE_ERR
;

1212 
	`moduËR•liÿ‹MuÉiIfN“ded
(
ùx
);

1213 
	`®soPrİag©e
(
cmd
,
ùx
->
ş›Á
->
db
->
id
,
¬gv
,
¬gc
,

1214 
PROPAGATE_AOF
|
PROPAGATE_REPL
);

1217 
j
 = 0; j < 
¬gc
; j++è
	`deüRefCouÁ
(
¬gv
[j]);

1218 
	`zä“
(
¬gv
);

1219  
REDISMODULE_OK
;

1220 
	}
}

1233 
	$RM_R•liÿ‹V”b©im
(
RedisModuËCtx
 *
ùx
) {

1234 
	`®soPrİag©e
(
ùx
->
ş›Á
->
cmd
,ùx->ş›Á->
db
->
id
,

1235 
ùx
->
ş›Á
->
¬gv
,ùx->ş›Á->
¬gc
,

1236 
PROPAGATE_AOF
|
PROPAGATE_REPL
);

1237  
REDISMODULE_OK
;

1238 
	}
}

1255 
	$RM_G‘Cl›ÁId
(
RedisModuËCtx
 *
ùx
) {

1256 ià(
ùx
->
ş›Á
 =ğ
NULL
)  0;

1257  
ùx
->
ş›Á
->
id
;

1258 
	}
}

1261 
	$RM_G‘S–eùedDb
(
RedisModuËCtx
 *
ùx
) {

1262  
ùx
->
ş›Á
->
db
->
id
;

1263 
	}
}

1275 
	$RM_S–eùDb
(
RedisModuËCtx
 *
ùx
, 
Ãwid
) {

1276 
»tv®
 = 
	`£ËùDb
(
ùx
->
ş›Á
,
Ãwid
);

1277  (
»tv®
 =ğ
C_OK
è? 
REDISMODULE_OK
 : 
REDISMODULE_ERR
;

1278 
	}
}

1294 *
	$RM_O³nKey
(
RedisModuËCtx
 *
ùx
, 
robj
 *
keyÇme
, 
mode
) {

1295 
RedisModuËKey
 *
kp
;

1296 
robj
 *
v®ue
;

1298 ià(
mode
 & 
REDISMODULE_WRITE
) {

1299 
v®ue
 = 
	`lookupKeyWr™e
(
ùx
->
ş›Á
->
db
,
keyÇme
);

1301 
v®ue
 = 
	`lookupKeyR—d
(
ùx
->
ş›Á
->
db
,
keyÇme
);

1302 ià(
v®ue
 =ğ
NULL
) {

1303  
NULL
;

1308 
kp
 = 
	`zm®loc
((*kp));

1309 
kp
->
ùx
 = ctx;

1310 
kp
->
db
 = 
ùx
->
ş›Á
->db;

1311 
kp
->
key
 = 
keyÇme
;

1312 
	`šüRefCouÁ
(
keyÇme
);

1313 
kp
->
v®ue
 = value;

1314 
kp
->
™”
 = 
NULL
;

1315 
kp
->
mode
 = mode;

1316 
	`z£tKeyRe£t
(
kp
);

1317 
	`autoMemÜyAdd
(
ùx
,
REDISMODULE_AM_KEY
,
kp
);

1318  (*)
kp
;

1319 
	}
}

1322 
	$RM_Clo£Key
(
RedisModuËKey
 *
key
) {

1323 ià(
key
 =ğ
NULL
) ;

1324 ià(
key
->
mode
 & 
REDISMODULE_WRITE
è
	`sigÇlModif›dKey
(key->
db
,key->key);

1326 
	`RM_Z£tRªgeStİ
(
key
);

1327 
	`deüRefCouÁ
(
key
->key);

1328 
	`autoMemÜyF»ed
(
key
->
ùx
,
REDISMODULE_AM_KEY
,key);

1329 
	`zä“
(
key
);

1330 
	}
}

1334 
	$RM_KeyTy³
(
RedisModuËKey
 *
key
) {

1335 ià(
key
 =ğ
NULL
 || key->
v®ue
 =ğNULLè 
REDISMODULE_KEYTYPE_EMPTY
;

1338 
key
->
v®ue
->
ty³
) {

1339 
OBJ_STRING
:  
REDISMODULE_KEYTYPE_STRING
;

1340 
OBJ_LIST
:  
REDISMODULE_KEYTYPE_LIST
;

1341 
OBJ_SET
:  
REDISMODULE_KEYTYPE_SET
;

1342 
OBJ_ZSET
:  
REDISMODULE_KEYTYPE_ZSET
;

1343 
OBJ_HASH
:  
REDISMODULE_KEYTYPE_HASH
;

1344 
OBJ_MODULE
:  
REDISMODULE_KEYTYPE_MODULE
;

1347 
	}
}

1354 
size_t
 
	$RM_V®ueL’gth
(
RedisModuËKey
 *
key
) {

1355 ià(
key
 =ğ
NULL
 || key->
v®ue
 == NULL)  0;

1356 
key
->
v®ue
->
ty³
) {

1357 
OBJ_STRING
:  
	`¡ršgObjeùL’
(
key
->
v®ue
);

1358 
OBJ_LIST
:  
	`li¡Ty³L’gth
(
key
->
v®ue
);

1359 
OBJ_SET
:  
	`£tTy³Size
(
key
->
v®ue
);

1360 
OBJ_ZSET
:  
	`z£tL’gth
(
key
->
v®ue
);

1361 
OBJ_HASH
:  
	`hashTy³L’gth
(
key
->
v®ue
);

1364 
	}
}

1370 
	$RM_D–‘eKey
(
RedisModuËKey
 *
key
) {

1371 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
)è 
REDISMODULE_ERR
;

1372 ià(
key
->
v®ue
) {

1373 
	`dbD–‘e
(
key
->
db
,key->key);

1374 
key
->
v®ue
 = 
NULL
;

1376  
REDISMODULE_OK
;

1377 
	}
}

1382 
m¡ime_t
 
	$RM_G‘Expœe
(
RedisModuËKey
 *
key
) {

1383 
m¡ime_t
 
expœe
 = 
	`g‘Expœe
(
key
->
db
,key->key);

1384 ià(
expœe
 =ğ-1 || 
key
->
v®ue
 =ğ
NULL
)  -1;

1385 
expœe
 -ğ
	`m¡ime
();

1386  
expœe
 >= 0 ?ƒxpire : 0;

1387 
	}
}

1398 
	$RM_S‘Expœe
(
RedisModuËKey
 *
key
, 
m¡ime_t
 
expœe
) {

1399 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
è|| key->
v®ue
 =ğ
NULL
)

1400  
REDISMODULE_ERR
;

1401 ià(
expœe
 !ğ
REDISMODULE_NO_EXPIRE
) {

1402 
expœe
 +ğ
	`m¡ime
();

1403 
	`£tExpœe
(
key
->
ùx
->
ş›Á
,key->
db
,key->key,
expœe
);

1405 
	`»moveExpœe
(
key
->
db
,key->key);

1407  
REDISMODULE_OK
;

1408 
	}
}

1418 
	$RM_SŒšgS‘
(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
¡r
) {

1419 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
è|| key->
™”
è 
REDISMODULE_ERR
;

1420 
	`RM_D–‘eKey
(
key
);

1421 
	`£tKey
(
key
->
db
,key->key,
¡r
);

1422 
key
->
v®ue
 = 
¡r
;

1423  
REDISMODULE_OK
;

1424 
	}
}

1455 *
	$RM_SŒšgDMA
(
RedisModuËKey
 *
key
, 
size_t
 *
Ën
, 
mode
) {

1460 *
em±y¡ršg
 = "<dma-empty-string>";

1461 ià(
key
->
v®ue
 =ğ
NULL
) {

1462 *
Ën
 = 0;

1463  
em±y¡ršg
;

1466 ià(
key
->
v®ue
->
ty³
 !ğ
OBJ_STRING
è 
NULL
;

1470 ià((
mode
 & 
REDISMODULE_WRITE
è|| 
key
->
v®ue
->
’codšg
 !ğ
OBJ_ENCODING_RAW
)

1471 
key
->
v®ue
 = 
	`dbUnsh¬eSŒšgV®ue
(key->
db
, key->key, key->value);

1473 *
Ën
 = 
	`sd¦’
(
key
->
v®ue
->
±r
);

1474  
key
->
v®ue
->
±r
;

1475 
	}
}

1489 
	$RM_SŒšgTrunÿ‹
(
RedisModuËKey
 *
key
, 
size_t
 
ÃwËn
) {

1490 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
)è 
REDISMODULE_ERR
;

1491 ià(
key
->
v®ue
 && key->v®ue->
ty³
 !ğ
OBJ_STRING
è 
REDISMODULE_ERR
;

1492 ià(
ÃwËn
 > 512*1024*1024è 
REDISMODULE_ERR
;

1496 ià(
key
->
v®ue
 =ğ
NULL
 && 
ÃwËn
 =ğ0è 
REDISMODULE_OK
;

1498 ià(
key
->
v®ue
 =ğ
NULL
) {

1500 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ewËn
(
NULL
, 
ÃwËn
));

1501 
	`£tKey
(
key
->
db
,key->key,
o
);

1502 
key
->
v®ue
 = 
o
;

1503 
	`deüRefCouÁ
(
o
);

1506 
key
->
v®ue
 = 
	`dbUnsh¬eSŒšgV®ue
(key->
db
, key->key, key->value);

1507 
size_t
 
cu¾’
 = 
	`sd¦’
(
key
->
v®ue
->
±r
);

1508 ià(
ÃwËn
 > 
cu¾’
) {

1509 
key
->
v®ue
->
±r
 = 
	`sdsgrowz”o
(key->v®ue->±r,
ÃwËn
);

1510 } ià(
ÃwËn
 < 
cu¾’
) {

1511 
	`sd¤ªge
(
key
->
v®ue
->
±r
,0,
ÃwËn
-1);

1513 ià(
	`sd¦’
(
key
->
v®ue
->
±r
è< 
	`sd§va
(key->value->ptr))

1514 
key
->
v®ue
->
±r
 = 
	`sdsRemoveF»eS·û
(key->value->ptr);

1517  
REDISMODULE_OK
;

1518 
	}
}

1528 
	$RM_Li¡Push
(
RedisModuËKey
 *
key
, 
wh”e
, 
RedisModuËSŒšg
 *
–e
) {

1529 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
)è 
REDISMODULE_ERR
;

1530 ià(
key
->
v®ue
 && key->v®ue->
ty³
 !ğ
OBJ_LIST
è 
REDISMODULE_ERR
;

1531 ià(
key
->
v®ue
 =ğ
NULL
è
	`moduËC»©eEm±yKey
(key,
REDISMODULE_KEYTYPE_LIST
);

1532 
	`li¡Ty³Push
(
key
->
v®ue
, 
–e
,

1533 (
wh”e
 =ğ
REDISMODULE_LIST_HEAD
è? 
QUICKLIST_HEAD
 : 
QUICKLIST_TAIL
);

1534  
REDISMODULE_OK
;

1535 
	}
}

1544 
RedisModuËSŒšg
 *
	$RM_Li¡Pİ
(
RedisModuËKey
 *
key
, 
wh”e
) {

1545 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
) ||

1546 
key
->
v®ue
 =ğ
NULL
 ||

1547 
key
->
v®ue
->
ty³
 !ğ
OBJ_LIST
è 
NULL
;

1548 
robj
 *
–e
 = 
	`li¡Ty³Pİ
(
key
->
v®ue
,

1549 (
wh”e
 =ğ
REDISMODULE_LIST_HEAD
è? 
QUICKLIST_HEAD
 : 
QUICKLIST_TAIL
);

1550 
robj
 *
decoded
 = 
	`g‘DecodedObjeù
(
–e
);

1551 
	`deüRefCouÁ
(
–e
);

1552 
	`moduËD–KeyIfEm±y
(
key
);

1553 
	`autoMemÜyAdd
(
key
->
ùx
,
REDISMODULE_AM_STRING
,
decoded
);

1554  
decoded
;

1555 
	}
}

1563 
	$RM_Z£tAddFÏgsToCÜeFÏgs
(
æags
) {

1564 
»tæags
 = 0;

1565 ià(
æags
 & 
REDISMODULE_ZADD_XX
è
»tæags
 |ğ
ZADD_XX
;

1566 ià(
æags
 & 
REDISMODULE_ZADD_NX
è
»tæags
 |ğ
ZADD_NX
;

1567  
»tæags
;

1568 
	}
}

1571 
	$RM_Z£tAddFÏgsFromCÜeFÏgs
(
æags
) {

1572 
»tæags
 = 0;

1573 ià(
æags
 & 
ZADD_ADDED
è
»tæags
 |ğ
REDISMODULE_ZADD_ADDED
;

1574 ià(
æags
 & 
ZADD_UPDATED
è
»tæags
 |ğ
REDISMODULE_ZADD_UPDATED
;

1575 ià(
æags
 & 
ZADD_NOP
è
»tæags
 |ğ
REDISMODULE_ZADD_NOP
;

1576  
»tæags
;

1577 
	}
}

1607 
	$RM_Z£tAdd
(
RedisModuËKey
 *
key
, 
scÜe
, 
RedisModuËSŒšg
 *
–e
, *
æag¥Œ
) {

1608 
æags
 = 0;

1609 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
)è 
REDISMODULE_ERR
;

1610 ià(
key
->
v®ue
 && key->v®ue->
ty³
 !ğ
OBJ_ZSET
è 
REDISMODULE_ERR
;

1611 ià(
key
->
v®ue
 =ğ
NULL
è
	`moduËC»©eEm±yKey
(key,
REDISMODULE_KEYTYPE_ZSET
);

1612 ià(
æag¥Œ
è
æags
 = 
	`RM_Z£tAddFÏgsToCÜeFÏgs
(*flagsptr);

1613 ià(
	`z£tAdd
(
key
->
v®ue
,
scÜe
,
–e
->
±r
,&
æags
,
NULL
) == 0) {

1614 ià(
æag¥Œ
) *flagsptr = 0;

1615  
REDISMODULE_ERR
;

1617 ià(
æag¥Œ
è*æag¥Œ = 
	`RM_Z£tAddFÏgsFromCÜeFÏgs
(
æags
);

1618  
REDISMODULE_OK
;

1619 
	}
}

1634 
	$RM_Z£tInüby
(
RedisModuËKey
 *
key
, 
scÜe
, 
RedisModuËSŒšg
 *
–e
, *
æag¥Œ
, *
ÃwscÜe
) {

1635 
æags
 = 0;

1636 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
)è 
REDISMODULE_ERR
;

1637 ià(
key
->
v®ue
 && key->v®ue->
ty³
 !ğ
OBJ_ZSET
è 
REDISMODULE_ERR
;

1638 ià(
key
->
v®ue
 =ğ
NULL
è
	`moduËC»©eEm±yKey
(key,
REDISMODULE_KEYTYPE_ZSET
);

1639 ià(
æag¥Œ
è
æags
 = 
	`RM_Z£tAddFÏgsToCÜeFÏgs
(*flagsptr);

1640 
æags
 |ğ
ZADD_INCR
;

1641 ià(
	`z£tAdd
(
key
->
v®ue
,
scÜe
,
–e
->
±r
,&
æags
,
ÃwscÜe
) == 0) {

1642 ià(
æag¥Œ
) *flagsptr = 0;

1643  
REDISMODULE_ERR
;

1646 ià(
æag¥Œ
 && (*æag¥Œ & 
ZADD_NAN
)) {

1647 *
æag¥Œ
 = 0;

1648  
REDISMODULE_ERR
;

1650 ià(
æag¥Œ
è*æag¥Œ = 
	`RM_Z£tAddFÏgsFromCÜeFÏgs
(
æags
);

1651  
REDISMODULE_OK
;

1652 
	}
}

1672 
	$RM_Z£tRem
(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
–e
, *
d–‘ed
) {

1673 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
)è 
REDISMODULE_ERR
;

1674 ià(
key
->
v®ue
 && key->v®ue->
ty³
 !ğ
OBJ_ZSET
è 
REDISMODULE_ERR
;

1675 ià(
key
->
v®ue
 !ğ
NULL
 && 
	`z£tD–
(key->v®ue,
–e
->
±r
)) {

1676 ià(
d–‘ed
) *deleted = 1;

1678 ià(
d–‘ed
) *deleted = 0;

1680  
REDISMODULE_OK
;

1681 
	}
}

1691 
	$RM_Z£tScÜe
(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
–e
, *
scÜe
) {

1692 ià(
key
->
v®ue
 =ğ
NULL
è 
REDISMODULE_ERR
;

1693 ià(
key
->
v®ue
->
ty³
 !ğ
OBJ_ZSET
è 
REDISMODULE_ERR
;

1694 ià(
	`z£tScÜe
(
key
->
v®ue
,
–e
->
±r
,
scÜe
è=ğ
C_ERR
è 
REDISMODULE_ERR
;

1695  
REDISMODULE_OK
;

1696 
	}
}

1702 
	$z£tKeyRe£t
(
RedisModuËKey
 *
key
) {

1703 
key
->
zty³
 = 
REDISMODULE_ZSET_RANGE_NONE
;

1704 
key
->
zcu¼’t
 = 
NULL
;

1705 
key
->
z”
 = 1;

1706 
	}
}

1709 
	$RM_Z£tRªgeStİ
(
RedisModuËKey
 *
key
) {

1711 ià(
key
->
zty³
 =ğ
REDISMODULE_ZSET_RANGE_LEX
)

1712 
	`z¦F»eLexRªge
(&
key
->
zÌs
);

1716 
	`z£tKeyRe£t
(
key
);

1717 
	}
}

1720 
	$RM_Z£tRªgeEndR—ched
(
RedisModuËKey
 *
key
) {

1721  
key
->
z”
;

1722 
	}
}

1730 
	$z£tIn™ScÜeRªge
(
RedisModuËKey
 *
key
, 
mš
, 
max
, 
mšex
, 
maxex
, 
fœ¡
) {

1731 ià(!
key
->
v®ue
 || key->v®ue->
ty³
 !ğ
OBJ_ZSET
è 
REDISMODULE_ERR
;

1733 
	`RM_Z£tRªgeStİ
(
key
);

1734 
key
->
zty³
 = 
REDISMODULE_ZSET_RANGE_SCORE
;

1735 
key
->
z”
 = 0;

1739 
z¿nge¥ec
 *
zrs
 = &
key
->zrs;

1740 
zrs
->
mš
 = min;

1741 
zrs
->
max
 = max;

1742 
zrs
->
mšex
 = minex;

1743 
zrs
->
maxex
 = maxex;

1745 ià(
key
->
v®ue
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1746 
key
->
zcu¼’t
 = 
fœ¡
 ? 
	`zzlFœ¡InRªge
(key->
v®ue
->
±r
,
zrs
) :

1747 
	`zzlLa¡InRªge
(
key
->
v®ue
->
±r
,
zrs
);

1748 } ià(
key
->
v®ue
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1749 
z£t
 *
zs
 = 
key
->
v®ue
->
±r
;

1750 
zskli¡
 *
z¦
 = 
zs
->zsl;

1751 
key
->
zcu¼’t
 = 
fœ¡
 ? 
	`z¦Fœ¡InRªge
(
z¦
,
zrs
) :

1752 
	`z¦La¡InRªge
(
z¦
,
zrs
);

1754 
	`£rv”Pªic
("Unsupported zsetƒncoding");

1756 ià(
key
->
zcu¼’t
 =ğ
NULL
èkey->
z”
 = 1;

1757  
REDISMODULE_OK
;

1758 
	}
}

1775 
	$RM_Z£tFœ¡InScÜeRªge
(
RedisModuËKey
 *
key
, 
mš
, 
max
, 
mšex
, 
maxex
) {

1776  
	`z£tIn™ScÜeRªge
(
key
,
mš
,
max
,
mšex
,
maxex
,1);

1777 
	}
}

1781 
	$RM_Z£tLa¡InScÜeRªge
(
RedisModuËKey
 *
key
, 
mš
, 
max
, 
mšex
, 
maxex
) {

1782  
	`z£tIn™ScÜeRªge
(
key
,
mš
,
max
,
mšex
,
maxex
,0);

1783 
	}
}

1794 
	$z£tIn™LexRªge
(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
mš
, RedisModuËSŒšg *
max
, 
fœ¡
) {

1795 ià(!
key
->
v®ue
 || key->v®ue->
ty³
 !ğ
OBJ_ZSET
è 
REDISMODULE_ERR
;

1797 
	`RM_Z£tRªgeStİ
(
key
);

1798 
key
->
z”
 = 0;

1802 
zËx¿nge¥ec
 *
zÌs
 = &
key
->zlrs;

1803 ià(
	`z¦P¬£LexRªge
(
mš
, 
max
, 
zÌs
è=ğ
C_ERR
è 
REDISMODULE_ERR
;

1807 
key
->
zty³
 = 
REDISMODULE_ZSET_RANGE_LEX
;

1809 ià(
key
->
v®ue
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1810 
key
->
zcu¼’t
 = 
fœ¡
 ? 
	`zzlFœ¡InLexRªge
(key->
v®ue
->
±r
,
zÌs
) :

1811 
	`zzlLa¡InLexRªge
(
key
->
v®ue
->
±r
,
zÌs
);

1812 } ià(
key
->
v®ue
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1813 
z£t
 *
zs
 = 
key
->
v®ue
->
±r
;

1814 
zskli¡
 *
z¦
 = 
zs
->zsl;

1815 
key
->
zcu¼’t
 = 
fœ¡
 ? 
	`z¦Fœ¡InLexRªge
(
z¦
,
zÌs
) :

1816 
	`z¦La¡InLexRªge
(
z¦
,
zÌs
);

1818 
	`£rv”Pªic
("Unsupported zsetƒncoding");

1820 ià(
key
->
zcu¼’t
 =ğ
NULL
èkey->
z”
 = 1;

1822  
REDISMODULE_OK
;

1823 
	}
}

1837 
	$RM_Z£tFœ¡InLexRªge
(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
mš
, RedisModuËSŒšg *
max
) {

1838  
	`z£tIn™LexRªge
(
key
,
mš
,
max
,1);

1839 
	}
}

1843 
	$RM_Z£tLa¡InLexRªge
(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
mš
, RedisModuËSŒšg *
max
) {

1844  
	`z£tIn™LexRªge
(
key
,
mš
,
max
,0);

1845 
	}
}

1850 
RedisModuËSŒšg
 *
	$RM_Z£tRªgeCu¼’tEËm’t
(
RedisModuËKey
 *
key
, *
scÜe
) {

1851 
RedisModuËSŒšg
 *
¡r
;

1853 ià(
key
->
zcu¼’t
 =ğ
NULL
)  NULL;

1854 ià(
key
->
v®ue
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1855 *
•Œ
, *
¥Œ
;

1856 
•Œ
 = 
key
->
zcu¼’t
;

1857 
sds
 
–e
 = 
	`zli¡G‘Objeù
(
•Œ
);

1858 ià(
scÜe
) {

1859 
¥Œ
 = 
	`zli¡Next
(
key
->
v®ue
->
±r
,
•Œ
);

1860 *
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

1862 
¡r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
–e
);

1863 } ià(
key
->
v®ue
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1864 
zskli¡Node
 *
Ê
 = 
key
->
zcu¼’t
;

1865 ià(
scÜe
è*scÜğ
Ê
->score;

1866 
¡r
 = 
	`ü—‹SŒšgObjeù
(
Ê
->
–e
,
	`sd¦’
(ln->ele));

1868 
	`£rv”Pªic
("Unsupported zsetƒncoding");

1870 
	`autoMemÜyAdd
(
key
->
ùx
,
REDISMODULE_AM_STRING
,
¡r
);

1871  
¡r
;

1872 
	}
}

1877 
	$RM_Z£tRªgeNext
(
RedisModuËKey
 *
key
) {

1878 ià(!
key
->
zty³
 || !key->
zcu¼’t
)  0;

1880 ià(
key
->
v®ue
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1881 *
zl
 = 
key
->
v®ue
->
±r
;

1882 *
•Œ
 = 
key
->
zcu¼’t
;

1883 *
Ãxt
;

1884 
Ãxt
 = 
	`zli¡Next
(
zl
,
•Œ
);

1885 ià(
Ãxt
èÃxˆğ
	`zli¡Next
(
zl
,next);

1886 ià(
Ãxt
 =ğ
NULL
) {

1887 
key
->
z”
 = 1;

1891 ià(
key
->
zty³
 =ğ
REDISMODULE_ZSET_RANGE_SCORE
) {

1894 *
§ved_Ãxt
 = 
Ãxt
;

1895 
Ãxt
 = 
	`zli¡Next
(
zl
,next);

1896 
scÜe
 = 
	`zzlG‘ScÜe
(
Ãxt
);

1897 ià(!
	`z¦V®ueL‹Max
(
scÜe
,&
key
->
zrs
)) {

1898 
key
->
z”
 = 1;

1901 
Ãxt
 = 
§ved_Ãxt
;

1902 } ià(
key
->
zty³
 =ğ
REDISMODULE_ZSET_RANGE_LEX
) {

1903 ià(!
	`zzlLexV®ueL‹Max
(
Ãxt
,&
key
->
zÌs
)) {

1904 
key
->
z”
 = 1;

1908 
key
->
zcu¼’t
 = 
Ãxt
;

1911 } ià(
key
->
v®ue
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1912 
zskli¡Node
 *
Ê
 = 
key
->
zcu¼’t
, *
Ãxt
 =†n->
Ëv–
[0].
fÜw¬d
;

1913 ià(
Ãxt
 =ğ
NULL
) {

1914 
key
->
z”
 = 1;

1918 ià(
key
->
zty³
 =ğ
REDISMODULE_ZSET_RANGE_SCORE
 &&

1919 !
	`z¦V®ueL‹Max
(
Ãxt
->
scÜe
,&
key
->
zrs
))

1921 
key
->
z”
 = 1;

1923 } ià(
key
->
zty³
 =ğ
REDISMODULE_ZSET_RANGE_LEX
) {

1924 ià(!
	`z¦LexV®ueL‹Max
(
Ãxt
->
–e
,&
key
->
zÌs
)) {

1925 
key
->
z”
 = 1;

1929 
key
->
zcu¼’t
 = 
Ãxt
;

1933 
	`£rv”Pªic
("Unsupported zsetƒncoding");

1935 
	}
}

1940 
	$RM_Z£tRªgeP»v
(
RedisModuËKey
 *
key
) {

1941 ià(!
key
->
zty³
 || !key->
zcu¼’t
)  0;

1943 ià(
key
->
v®ue
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1944 *
zl
 = 
key
->
v®ue
->
±r
;

1945 *
•Œ
 = 
key
->
zcu¼’t
;

1946 *
´ev
;

1947 
´ev
 = 
	`zli¡P»v
(
zl
,
•Œ
);

1948 ià(
´ev
è´ev = 
	`zli¡P»v
(
zl
,prev);

1949 ià(
´ev
 =ğ
NULL
) {

1950 
key
->
z”
 = 1;

1954 ià(
key
->
zty³
 =ğ
REDISMODULE_ZSET_RANGE_SCORE
) {

1957 *
§ved_´ev
 = 
´ev
;

1958 
´ev
 = 
	`zli¡Next
(
zl
,prev);

1959 
scÜe
 = 
	`zzlG‘ScÜe
(
´ev
);

1960 ià(!
	`z¦V®ueG‹Mš
(
scÜe
,&
key
->
zrs
)) {

1961 
key
->
z”
 = 1;

1964 
´ev
 = 
§ved_´ev
;

1965 } ià(
key
->
zty³
 =ğ
REDISMODULE_ZSET_RANGE_LEX
) {

1966 ià(!
	`zzlLexV®ueG‹Mš
(
´ev
,&
key
->
zÌs
)) {

1967 
key
->
z”
 = 1;

1971 
key
->
zcu¼’t
 = 
´ev
;

1974 } ià(
key
->
v®ue
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1975 
zskli¡Node
 *
Ê
 = 
key
->
zcu¼’t
, *
´ev
 =†n->
backw¬d
;

1976 ià(
´ev
 =ğ
NULL
) {

1977 
key
->
z”
 = 1;

1981 ià(
key
->
zty³
 =ğ
REDISMODULE_ZSET_RANGE_SCORE
 &&

1982 !
	`z¦V®ueG‹Mš
(
´ev
->
scÜe
,&
key
->
zrs
))

1984 
key
->
z”
 = 1;

1986 } ià(
key
->
zty³
 =ğ
REDISMODULE_ZSET_RANGE_LEX
) {

1987 ià(!
	`z¦LexV®ueG‹Mš
(
´ev
->
–e
,&
key
->
zÌs
)) {

1988 
key
->
z”
 = 1;

1992 
key
->
zcu¼’t
 = 
´ev
;

1996 
	`£rv”Pªic
("Unsupported zsetƒncoding");

1998 
	}
}

2054 
	$RM_HashS‘
(
RedisModuËKey
 *
key
, 
æags
, ...) {

2055 
va_li¡
 
­
;

2056 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
))  0;

2057 ià(
key
->
v®ue
 && key->v®ue->
ty³
 !ğ
OBJ_HASH
)  0;

2058 ià(
key
->
v®ue
 =ğ
NULL
è
	`moduËC»©eEm±yKey
(key,
REDISMODULE_KEYTYPE_HASH
);

2060 
upd©ed
 = 0;

2061 
	`va_¡¬t
(
­
, 
æags
);

2063 
RedisModuËSŒšg
 *
f›ld
, *
v®ue
;

2065 ià(
æags
 & 
REDISMODULE_HASH_CFIELDS
) {

2066 *
cf›ld
 = 
	`va_¬g
(
­
,*);

2067 ià(
cf›ld
 =ğ
NULL
) ;

2068 
f›ld
 = 
	`ü—‹RawSŒšgObjeù
(
cf›ld
,
	`¡¾’
(cfield));

2070 
f›ld
 = 
	`va_¬g
(
­
,
RedisModuËSŒšg
*);

2071 ià(
f›ld
 =ğ
NULL
) ;

2073 
v®ue
 = 
	`va_¬g
(
­
,
RedisModuËSŒšg
*);

2076 ià(
æags
 & (
REDISMODULE_HASH_XX
|
REDISMODULE_HASH_NX
)) {

2077 
exi¡s
 = 
	`hashTy³Exi¡s
(
key
->
v®ue
, 
f›ld
->
±r
);

2078 ià(((
æags
 & 
REDISMODULE_HASH_XX
è&& !
exi¡s
) ||

2079 ((
æags
 & 
REDISMODULE_HASH_NX
è&& 
exi¡s
))

2081 ià(
æags
 & 
REDISMODULE_HASH_CFIELDS
è
	`deüRefCouÁ
(
f›ld
);

2087 ià(
v®ue
 =ğ
REDISMODULE_HASH_DELETE
) {

2088 
upd©ed
 +ğ
	`hashTy³D–‘e
(
key
->
v®ue
, 
f›ld
->
±r
);

2089 ià(
æags
 & 
REDISMODULE_HASH_CFIELDS
è
	`deüRefCouÁ
(
f›ld
);

2093 
low_æags
 = 
HASH_SET_COPY
;

2097 ià(
æags
 & 
REDISMODULE_HASH_CFIELDS
)

2098 
low_æags
 |ğ
HASH_SET_TAKE_FIELD
;

2099 
upd©ed
 +ğ
	`hashTy³S‘
(
key
->
v®ue
, 
f›ld
->
±r
, v®ue->±r, 
low_æags
);

2103 ià(
æags
 & 
REDISMODULE_HASH_CFIELDS
) {

2104 
f›ld
->
±r
 = 
NULL
;

2105 
	`deüRefCouÁ
(
f›ld
);

2108 
	`va_’d
(
­
);

2109 
	`moduËD–KeyIfEm±y
(
key
);

2110  
upd©ed
;

2111 
	}
}

2154 
	$RM_HashG‘
(
RedisModuËKey
 *
key
, 
æags
, ...) {

2155 
va_li¡
 
­
;

2156 ià(
key
->
v®ue
 && key->v®ue->
ty³
 !ğ
OBJ_HASH
è 
REDISMODULE_ERR
;

2158 
	`va_¡¬t
(
­
, 
æags
);

2160 
RedisModuËSŒšg
 *
f›ld
, **
v®u•Œ
;

2161 *
exi¡¥Œ
;

2163 ià(
æags
 & 
REDISMODULE_HASH_CFIELDS
) {

2164 *
cf›ld
 = 
	`va_¬g
(
­
,*);

2165 ià(
cf›ld
 =ğ
NULL
) ;

2166 
f›ld
 = 
	`ü—‹RawSŒšgObjeù
(
cf›ld
,
	`¡¾’
(cfield));

2168 
f›ld
 = 
	`va_¬g
(
­
,
RedisModuËSŒšg
*);

2169 ià(
f›ld
 =ğ
NULL
) ;

2173 ià(
æags
 & 
REDISMODULE_HASH_EXISTS
) {

2174 
exi¡¥Œ
 = 
	`va_¬g
(
­
,*);

2175 ià(
key
->
v®ue
)

2176 *
exi¡¥Œ
 = 
	`hashTy³Exi¡s
(
key
->
v®ue
,
f›ld
->
±r
);

2178 *
exi¡¥Œ
 = 0;

2180 
v®u•Œ
 = 
	`va_¬g
(
­
,
RedisModuËSŒšg
**);

2181 ià(
key
->
v®ue
) {

2182 *
v®u•Œ
 = 
	`hashTy³G‘V®ueObjeù
(
key
->
v®ue
,
f›ld
->
±r
);

2183 ià(*
v®u•Œ
) {

2184 
robj
 *
decoded
 = 
	`g‘DecodedObjeù
(*
v®u•Œ
);

2185 
	`deüRefCouÁ
(*
v®u•Œ
);

2186 *
v®u•Œ
 = 
decoded
;

2188 ià(*
v®u•Œ
)

2189 
	`autoMemÜyAdd
(
key
->
ùx
,
REDISMODULE_AM_STRING
,*
v®u•Œ
);

2191 *
v®u•Œ
 = 
NULL
;

2196 ià(
æags
 & 
REDISMODULE_HASH_CFIELDS
è
	`deüRefCouÁ
(
f›ld
);

2198 
	`va_’d
(
­
);

2199  
REDISMODULE_OK
;

2200 
	}
}

2210 
RedisModuËC®lR•ly
 *
	$moduËC»©eC®lR•lyFromPrÙo
(
RedisModuËCtx
 *
ùx
, 
sds
 
´Ùo
) {

2211 
RedisModuËC®lR•ly
 *
»¶y
 = 
	`zm®loc
((*reply));

2212 
»¶y
->
ùx
 = ctx;

2213 
»¶y
->
´Ùo
 =…roto;

2214 
»¶y
->
´ÙŞ’
 = 
	`sd¦’
(
´Ùo
);

2215 
»¶y
->
æags
 = 
REDISMODULE_REPLYFLAG_TOPARSE
;

2216 
´Ùo
[0]) {

2218 '+': 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_STRING
; ;

2219 '-': 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_ERROR
; ;

2220 ':': 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_INTEGER
; ;

2221 '*': 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_ARRAY
; ;

2222 : 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_UNKNOWN
; ;

2224 ià((
´Ùo
[0] == '*' ||…roto[0] == '$') &&…roto[1] == '-')

2225 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_NULL
;

2226  
»¶y
;

2227 
	}
}

2229 
moduËP¬£C®lR•ly_IÁ
(
RedisModuËC®lR•ly
 *
»¶y
);

2230 
moduËP¬£C®lR•ly_BulkSŒšg
(
RedisModuËC®lR•ly
 *
»¶y
);

2231 
moduËP¬£C®lR•ly_Sim¶eSŒšg
(
RedisModuËC®lR•ly
 *
»¶y
);

2232 
moduËP¬£C®lR•ly_A¼ay
(
RedisModuËC®lR•ly
 *
»¶y
);

2237 
	$moduËP¬£C®lR•ly
(
RedisModuËC®lR•ly
 *
»¶y
) {

2238 ià(!(
»¶y
->
æags
 & 
REDISMODULE_REPLYFLAG_TOPARSE
)) ;

2239 
»¶y
->
æags
 &ğ~
REDISMODULE_REPLYFLAG_TOPARSE
;

2241 
»¶y
->
´Ùo
[0]) {

2242 ':': 
	`moduËP¬£C®lR•ly_IÁ
(
»¶y
); ;

2243 '$': 
	`moduËP¬£C®lR•ly_BulkSŒšg
(
»¶y
); ;

2245 '+': 
	`moduËP¬£C®lR•ly_Sim¶eSŒšg
(
»¶y
); ;

2246 '*': 
	`moduËP¬£C®lR•ly_A¼ay
(
»¶y
); ;

2248 
	}
}

2250 
	$moduËP¬£C®lR•ly_IÁ
(
RedisModuËC®lR•ly
 *
»¶y
) {

2251 *
´Ùo
 = 
»¶y
->proto;

2252 *
p
 = 
	`¡rchr
(
´Ùo
+1,'\r');

2254 
	`¡ršg2Î
(
´Ùo
+1,
p
-´Ùo-1,&
»¶y
->
v®
.
Î
);

2255 
»¶y
->
´ÙŞ’
 = 
p
-
´Ùo
+2;

2256 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_INTEGER
;

2257 
	}
}

2259 
	$moduËP¬£C®lR•ly_BulkSŒšg
(
RedisModuËC®lR•ly
 *
»¶y
) {

2260 *
´Ùo
 = 
»¶y
->proto;

2261 *
p
 = 
	`¡rchr
(
´Ùo
+1,'\r');

2262 
bulkËn
;

2264 
	`¡ršg2Î
(
´Ùo
+1,
p
-´Ùo-1,&
bulkËn
);

2265 ià(
bulkËn
 == -1) {

2266 
»¶y
->
´ÙŞ’
 = 
p
-
´Ùo
+2;

2267 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_NULL
;

2269 
»¶y
->
v®
.
¡r
 = 
p
+2;

2270 
»¶y
->
Ën
 = 
bulkËn
;

2271 
»¶y
->
´ÙŞ’
 = 
p
-
´Ùo
+2+
bulkËn
+2;

2272 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_STRING
;

2274 
	}
}

2276 
	$moduËP¬£C®lR•ly_Sim¶eSŒšg
(
RedisModuËC®lR•ly
 *
»¶y
) {

2277 *
´Ùo
 = 
»¶y
->proto;

2278 *
p
 = 
	`¡rchr
(
´Ùo
+1,'\r');

2280 
»¶y
->
v®
.
¡r
 = 
´Ùo
+1;

2281 
»¶y
->
Ën
 = 
p
-
´Ùo
-1;

2282 
»¶y
->
´ÙŞ’
 = 
p
-
´Ùo
+2;

2283 
»¶y
->
ty³
 = 
´Ùo
[0] =ğ'+' ? 
REDISMODULE_REPLY_STRING
 :

2284 
REDISMODULE_REPLY_ERROR
;

2285 
	}
}

2287 
	$moduËP¬£C®lR•ly_A¼ay
(
RedisModuËC®lR•ly
 *
»¶y
) {

2288 *
´Ùo
 = 
»¶y
->proto;

2289 *
p
 = 
	`¡rchr
(
´Ùo
+1,'\r');

2290 
¬¿yËn
, 
j
;

2292 
	`¡ršg2Î
(
´Ùo
+1,
p
-´Ùo-1,&
¬¿yËn
);

2293 
p
 += 2;

2295 ià(
¬¿yËn
 == -1) {

2296 
»¶y
->
´ÙŞ’
 = 
p
-
´Ùo
;

2297 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_NULL
;

2301 
»¶y
->
v®
.
¬¿y
 = 
	`zm®loc
((
RedisModuËC®lR•ly
)*
¬¿yËn
);

2302 
»¶y
->
Ën
 = 
¬¿yËn
;

2303 
j
 = 0; j < 
¬¿yËn
; j++) {

2304 
RedisModuËC®lR•ly
 *
–e
 = 
»¶y
->
v®
.
¬¿y
+
j
;

2305 
–e
->
æags
 = 
REDISMODULE_REPLYFLAG_NESTED
 |

2306 
REDISMODULE_REPLYFLAG_TOPARSE
;

2307 
–e
->
´Ùo
 = 
p
;

2308 
–e
->
ùx
 = 
»¶y
->ctx;

2309 
	`moduËP¬£C®lR•ly
(
–e
);

2310 
p
 +ğ
–e
->
´ÙŞ’
;

2312 
»¶y
->
´ÙŞ’
 = 
p
-
´Ùo
;

2313 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_ARRAY
;

2314 
	}
}

2318 
	$RM_F»eC®lR•ly_Rec
(
RedisModuËC®lR•ly
 *
»¶y
, 
ä“Ã¡ed
){

2322 ià(!
ä“Ã¡ed
 && 
»¶y
->
æags
 & 
REDISMODULE_REPLYFLAG_NESTED
) ;

2324 ià(!(
»¶y
->
æags
 & 
REDISMODULE_REPLYFLAG_TOPARSE
)) {

2325 ià(
»¶y
->
ty³
 =ğ
REDISMODULE_REPLY_ARRAY
) {

2326 
size_t
 
j
;

2327 
j
 = 0; j < 
»¶y
->
Ën
; j++)

2328 
	`RM_F»eC®lR•ly_Rec
(
»¶y
->
v®
.
¬¿y
+
j
,1);

2329 
	`zä“
(
»¶y
->
v®
.
¬¿y
);

2337 ià(!(
»¶y
->
æags
 & 
REDISMODULE_REPLYFLAG_NESTED
)) {

2338 ià(
»¶y
->
´Ùo
è
	`sdsä“
(reply->proto);

2339 
	`zä“
(
»¶y
);

2341 
	}
}

2346 
	$RM_F»eC®lR•ly
(
RedisModuËC®lR•ly
 *
»¶y
) {

2348 
RedisModuËCtx
 *
ùx
 = 
»¶y
->ctx;

2349 
	`RM_F»eC®lR•ly_Rec
(
»¶y
,0);

2350 
	`autoMemÜyF»ed
(
ùx
,
REDISMODULE_AM_REPLY
,
»¶y
);

2351 
	}
}

2354 
	$RM_C®lR•lyTy³
(
RedisModuËC®lR•ly
 *
»¶y
) {

2355 ià(!
»¶y
è 
REDISMODULE_REPLY_UNKNOWN
;

2356  
»¶y
->
ty³
;

2357 
	}
}

2360 
size_t
 
	$RM_C®lR•lyL’gth
(
RedisModuËC®lR•ly
 *
»¶y
) {

2361 
	`moduËP¬£C®lR•ly
(
»¶y
);

2362 
»¶y
->
ty³
) {

2363 
REDISMODULE_REPLY_STRING
:

2364 
REDISMODULE_REPLY_ERROR
:

2365 
REDISMODULE_REPLY_ARRAY
:

2366  
»¶y
->
Ën
;

2370 
	}
}

2374 
RedisModuËC®lR•ly
 *
	$RM_C®lR•lyA¼ayEËm’t
(
RedisModuËC®lR•ly
 *
»¶y
, 
size_t
 
idx
) {

2375 
	`moduËP¬£C®lR•ly
(
»¶y
);

2376 ià(
»¶y
->
ty³
 !ğ
REDISMODULE_REPLY_ARRAY
è 
NULL
;

2377 ià(
idx
 >ğ
»¶y
->
Ën
è 
NULL
;

2378  
»¶y
->
v®
.
¬¿y
+
idx
;

2379 
	}
}

2382 
	$RM_C®lR•lyIÁeg”
(
RedisModuËC®lR•ly
 *
»¶y
) {

2383 
	`moduËP¬£C®lR•ly
(
»¶y
);

2384 ià(
»¶y
->
ty³
 !ğ
REDISMODULE_REPLY_INTEGER
è 
LLONG_MIN
;

2385  
»¶y
->
v®
.
Î
;

2386 
	}
}

2389 cÚ¡ *
	$RM_C®lR•lySŒšgPŒ
(
RedisModuËC®lR•ly
 *
»¶y
, 
size_t
 *
Ën
) {

2390 
	`moduËP¬£C®lR•ly
(
»¶y
);

2391 ià(
»¶y
->
ty³
 !ğ
REDISMODULE_REPLY_STRING
 &&

2392 
»¶y
->
ty³
 !ğ
REDISMODULE_REPLY_ERROR
è 
NULL
;

2393 ià(
Ën
è*ËÀğ
»¶y
->len;

2394  
»¶y
->
v®
.
¡r
;

2395 
	}
}

2399 
RedisModuËSŒšg
 *
	$RM_C»©eSŒšgFromC®lR•ly
(
RedisModuËC®lR•ly
 *
»¶y
) {

2400 
	`moduËP¬£C®lR•ly
(
»¶y
);

2401 
»¶y
->
ty³
) {

2402 
REDISMODULE_REPLY_STRING
:

2403 
REDISMODULE_REPLY_ERROR
:

2404  
	`RM_C»©eSŒšg
(
»¶y
->
ùx
,»¶y->
v®
.
¡r
,»¶y->
Ën
);

2405 
REDISMODULE_REPLY_INTEGER
: {

2406 
buf
[64];

2407 
Ën
 = 
	`Î2¡ršg
(
buf
,(buf),
»¶y
->
v®
.
Î
);

2408  
	`RM_C»©eSŒšg
(
»¶y
->
ùx
,
buf
,
Ën
);

2410 :  
NULL
;

2412 
	}
}

2426 
	#REDISMODULE_ARGV_REPLICATE
 (1<<0)

	)

2428 
robj
 **
	$moduËC»©eArgvFromU£rFÜm©
(cÚ¡ *
cmdÇme
, cÚ¡ *
fmt
, *
¬gı
, *
æags
, 
va_li¡
 
­
) {

2429 
¬gc
 = 0, 
¬gv_size
, 
j
;

2430 
robj
 **
¬gv
 = 
NULL
;

2434 
¬gv_size
 = 
	`¡¾’
(
fmt
)+1;

2435 
¬gv
 = 
	`z»®loc
×rgv,(
robj
*)*
¬gv_size
);

2438 
¬gv
[0] = 
	`ü—‹SŒšgObjeù
(
cmdÇme
,
	`¡¾’
(cmdname));

2439 
¬gc
++;

2442 cÚ¡ *
p
 = 
fmt
;

2443 *
p
) {

2444 ià(*
p
 == 'c') {

2445 *
c¡r
 = 
	`va_¬g
(
­
,*);

2446 
¬gv
[
¬gc
++] = 
	`ü—‹SŒšgObjeù
(
c¡r
,
	`¡¾’
(cstr));

2447 } ià(*
p
 == 's') {

2448 
robj
 *
obj
 = 
	`va_¬g
(
­
,*);

2449 
¬gv
[
¬gc
++] = 
obj
;

2450 
	`šüRefCouÁ
(
obj
);

2451 } ià(*
p
 == 'b') {

2452 *
buf
 = 
	`va_¬g
(
­
,*);

2453 
size_t
 
Ën
 = 
	`va_¬g
(
­
,size_t);

2454 
¬gv
[
¬gc
++] = 
	`ü—‹SŒšgObjeù
(
buf
,
Ën
);

2455 } ià(*
p
 == 'l') {

2456 
Î
 = 
	`va_¬g
(
­
,);

2457 
¬gv
[
¬gc
++] = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sdsäomlÚglÚg
(
Î
));

2458 } ià(*
p
 == 'v') {

2460 
robj
 **
v
 = 
	`va_¬g
(
­
, *);

2461 
size_t
 
vËn
 = 
	`va_¬g
(
­
, size_t);

2466 
¬gv_size
 +ğ
vËn
-1;

2467 
¬gv
 = 
	`z»®loc
×rgv,(
robj
*)*
¬gv_size
);

2469 
size_t
 
i
 = 0;

2470 
i
 = 0; i < 
vËn
; i++) {

2471 
	`šüRefCouÁ
(
v
[
i
]);

2472 
¬gv
[
¬gc
++] = 
v
[
i
];

2474 } ià(*
p
 == '!') {

2475 ià(
æags
è(*æagsè|ğ
REDISMODULE_ARGV_REPLICATE
;

2477 
fm‹¼
;

2479 
p
++;

2481 *
¬gı
 = 
¬gc
;

2482  
¬gv
;

2484 
fm‹¼
:

2485 
j
 = 0; j < 
¬gc
; j++)

2486 
	`deüRefCouÁ
(
¬gv
[
j
]);

2487 
	`zä“
(
¬gv
);

2488  
NULL
;

2489 
	}
}

2497 
RedisModuËC®lR•ly
 *
	$RM_C®l
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
cmdÇme
, cÚ¡ *
fmt
, ...) {

2498 
»disCommªd
 *
cmd
;

2499 
ş›Á
 *
c
 = 
NULL
;

2500 
robj
 **
¬gv
 = 
NULL
;

2501 
¬gc
 = 0, 
æags
 = 0;

2502 
va_li¡
 
­
;

2503 
RedisModuËC®lR•ly
 *
»¶y
 = 
NULL
;

2504 
»¶iÿ‹
 = 0;

2506 
cmd
 = 
	`lookupCommªdByCSŒšg
((*)
cmdÇme
);

2507 ià(!
cmd
) {

2508 
”ºo
 = 
EINVAL
;

2509  
NULL
;

2513 
	`va_¡¬t
(
­
, 
fmt
);

2514 
c
 = 
	`ü—‹Cl›Á
(-1);

2515 
¬gv
 = 
	`moduËC»©eArgvFromU£rFÜm©
(
cmdÇme
,
fmt
,&
¬gc
,&
æags
,
­
);

2516 
»¶iÿ‹
 = 
æags
 & 
REDISMODULE_ARGV_REPLICATE
;

2517 
	`va_’d
(
­
);

2520 
c
->
æags
 |ğ
CLIENT_MODULE
;

2521 
c
->
db
 = 
ùx
->
ş›Á
->db;

2522 
c
->
¬gv
 =‡rgv;

2523 
c
->
¬gc
 =‡rgc;

2524 
c
->
cmd
 = c->
Ï¡cmd
 = cmd;

2527 ià(
¬gv
 =ğ
NULL
è
ş—nup
;

2530 ià((
cmd
->
¬™y
 > 0 && cmd->¬™y !ğ
¬gc
) || (argc < -cmd->arity)) {

2531 
”ºo
 = 
EINVAL
;

2532 
ş—nup
;

2538 ià(
£rv”
.
şu¡”_’abËd
 && !(
ùx
->
ş›Á
->
æags
 & 
CLIENT_MASTER
)) {

2540 
c
->
æags
 &ğ~(
CLIENT_READONLY
|
CLIENT_ASKING
);

2541 
c
->
æags
 |ğ
ùx
->
ş›Á
->æag & (
CLIENT_READONLY
|
CLIENT_ASKING
);

2542 ià(
	`g‘NodeByQu”y
(
c
,c->
cmd
,c->
¬gv
,c->
¬gc
,
NULL
,NULL) !=

2543 
£rv”
.
şu¡”
->
my£lf
)

2545 
”ºo
 = 
EPERM
;

2546 
ş—nup
;

2553 ià(
»¶iÿ‹
è
	`moduËR•liÿ‹MuÉiIfN“ded
(
ùx
);

2556 
ÿÎ_æags
 = 
CMD_CALL_SLOWLOG
 | 
CMD_CALL_STATS
;

2557 ià(
»¶iÿ‹
) {

2558 
ÿÎ_æags
 |ğ
CMD_CALL_PROPAGATE_AOF
;

2559 
ÿÎ_æags
 |ğ
CMD_CALL_PROPAGATE_REPL
;

2561 
	`ÿÎ
(
c
,
ÿÎ_æags
);

2566 
sds
 
´Ùo
 = 
	`sd¢ewËn
(
c
->
buf
,c->
buåos
);

2567 
c
->
buåos
 = 0;

2568 
	`li¡L’gth
(
c
->
»¶y
)) {

2569 
sds
 
o
 = 
	`li¡NodeV®ue
(
	`li¡Fœ¡
(
c
->
»¶y
));

2571 
´Ùo
 = 
	`sdsÿtsds
ÕrÙo,
o
);

2572 
	`li¡D–Node
(
c
->
»¶y
,
	`li¡Fœ¡
(c->reply));

2574 
»¶y
 = 
	`moduËC»©eC®lR•lyFromPrÙo
(
ùx
,
´Ùo
);

2575 
	`autoMemÜyAdd
(
ùx
,
REDISMODULE_AM_REPLY
,
»¶y
);

2577 
ş—nup
:

2578 
	`ä“Cl›Á
(
c
);

2579  
»¶y
;

2580 
	}
}

2584 cÚ¡ *
	$RM_C®lR•lyPrÙo
(
RedisModuËC®lR•ly
 *
»¶y
, 
size_t
 *
Ën
) {

2585 ià(
»¶y
->
´Ùo
è*
Ën
 = 
	`sd¦’
(reply->proto);

2586  
»¶y
->
´Ùo
;

2587 
	}
}

2622 cÚ¡ *
	gModuËTy³NameCh¬S‘
 =

2627 
ušt64_t
 
	$moduËTy³EncodeId
(cÚ¡ *
Çme
, 
’cv”
) {

2630 cÚ¡ *
c£t
 = 
ModuËTy³NameCh¬S‘
;

2631 ià(
	`¡¾’
(
Çme
) != 9)  0;

2632 ià(
’cv”
 < 0 ||ƒncver > 1023)  0;

2634 
ušt64_t
 
id
 = 0;

2635 
j
 = 0; j < 9; j++) {

2636 *
p
 = 
	`¡rchr
(
c£t
,
Çme
[
j
]);

2637 ià(!
p
)  0;

2638 
pos
 = 
p
-
c£t
;

2639 
id
 = (id << 6è| 
pos
;

2641 
id
 = (id << 10è| 
’cv”
;

2642  
id
;

2643 
	}
}

2648 
moduËTy³
 *
	$moduËTy³LookupModuËByName
(cÚ¡ *
Çme
) {

2649 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
moduËs
);

2650 
diùEÁry
 *
de
;

2652 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2653 
RedisModuË
 *
moduË
 = 
	`diùG‘V®
(
de
);

2654 
li¡I‹r
 
li
;

2655 
li¡Node
 *
Ê
;

2657 
	`li¡Rewšd
(
moduË
->
ty³s
,&
li
);

2658 (
Ê
 = 
	`li¡Next
(&
li
))) {

2659 
moduËTy³
 *
mt
 = 
Ê
->
v®ue
;

2660 ià(
	`memcmp
(
Çme
,
mt
->name,(mt->name)) == 0) {

2661 
	`diùR–—£I‹¿tÜ
(
di
);

2662  
mt
;

2666 
	`diùR–—£I‹¿tÜ
(
di
);

2667  
NULL
;

2668 
	}
}

2673 
	#MODULE_LOOKUP_CACHE_SIZE
 3

	)

2675 
moduËTy³
 *
	$moduËTy³LookupModuËByID
(
ušt64_t
 
id
) {

2677 
ušt64_t
 
id
;

2678 
moduËTy³
 *
mt
;

2679 } 
ÿche
[
MODULE_LOOKUP_CACHE_SIZE
];

2682 
j
;

2683 
j
 = 0; j < 
MODULE_LOOKUP_CACHE_SIZE
 && 
ÿche
[j].
mt
 !ğ
NULL
; j++)

2684 ià(
ÿche
[
j
].
id
 =ğidè cache[j].
mt
;

2687 
moduËTy³
 *
mt
 = 
NULL
;

2688 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
moduËs
);

2689 
diùEÁry
 *
de
;

2691 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
 && 
mt
 == NULL) {

2692 
RedisModuË
 *
moduË
 = 
	`diùG‘V®
(
de
);

2693 
li¡I‹r
 
li
;

2694 
li¡Node
 *
Ê
;

2696 
	`li¡Rewšd
(
moduË
->
ty³s
,&
li
);

2697 (
Ê
 = 
	`li¡Next
(&
li
))) {

2698 
moduËTy³
 *
this_mt
 = 
Ê
->
v®ue
;

2701 ià(
this_mt
->
id
 >> 10 == id >> 10) {

2702 
mt
 = 
this_mt
;

2707 
	`diùR–—£I‹¿tÜ
(
di
);

2710 ià(
mt
 && 
j
 < 
MODULE_LOOKUP_CACHE_SIZE
) {

2711 
ÿche
[
j
].
id
 = id;

2712 
ÿche
[
j
].
mt
 = mt;

2714  
mt
;

2715 
	}
}

2721 
	$moduËTy³NameByID
(*
Çme
, 
ušt64_t
 
moduËid
) {

2722 cÚ¡ *
c£t
 = 
ModuËTy³NameCh¬S‘
;

2724 
Çme
[9] = '\0';

2725 *
p
 = 
Çme
+8;

2726 
moduËid
 >>= 10;

2727 
j
 = 0; j < 9; j++) {

2728 *
p
-- = 
c£t
[
moduËid
 & 63];

2729 
moduËid
 >>= 6;

2731 
	}
}

2797 
moduËTy³
 *
	$RM_C»©eD©aTy³
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
Çme
, 
’cv”
, *
ty³m‘hods_±r
) {

2798 
ušt64_t
 
id
 = 
	`moduËTy³EncodeId
(
Çme
,
’cv”
);

2799 ià(
id
 =ğ0è 
NULL
;

2800 ià(
	`moduËTy³LookupModuËByName
(
Çme
è!ğ
NULL
)  NULL;

2802 
ty³m‘hods_v”siÚ
 = ((*)
ty³m‘hods_±r
)[0];

2803 ià(
ty³m‘hods_v”siÚ
 =ğ0è 
NULL
;

2805 
	sty³m‘hods
 {

2806 
ušt64_t
 
v”siÚ
;

2807 
moduËTy³LßdFunc
 
rdb_lßd
;

2808 
moduËTy³SaveFunc
 
rdb_§ve
;

2809 
moduËTy³Rewr™eFunc
 
aof_»wr™e
;

2810 
moduËTy³MemU§geFunc
 
mem_u§ge
;

2811 
moduËTy³Dige¡Func
 
dige¡
;

2812 
moduËTy³F»eFunc
 
ä“
;

2813 } *
tms
 = (
ty³m‘hods
*è
ty³m‘hods_±r
;

2815 
moduËTy³
 *
mt
 = 
	`zÿÎoc
((*mt));

2816 
mt
->
id
 = id;

2817 
mt
->
moduË
 = 
ùx
->module;

2818 
mt
->
rdb_lßd
 = 
tms
->rdb_load;

2819 
mt
->
rdb_§ve
 = 
tms
->rdb_save;

2820 
mt
->
aof_»wr™e
 = 
tms
->aof_rewrite;

2821 
mt
->
mem_u§ge
 = 
tms
->mem_usage;

2822 
mt
->
dige¡
 = 
tms
->digest;

2823 
mt
->
ä“
 = 
tms
->free;

2824 
	`memıy
(
mt
->
Çme
,name,(mt->name));

2825 
	`li¡AddNodeTa
(
ùx
->
moduË
->
ty³s
,
mt
);

2826  
mt
;

2827 
	}
}

2833 
	$RM_ModuËTy³S‘V®ue
(
RedisModuËKey
 *
key
, 
moduËTy³
 *
mt
, *
v®ue
) {

2834 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
è|| key->
™”
è 
REDISMODULE_ERR
;

2835 
	`RM_D–‘eKey
(
key
);

2836 
robj
 *
o
 = 
	`ü—‹ModuËObjeù
(
mt
,
v®ue
);

2837 
	`£tKey
(
key
->
db
,key->key,
o
);

2838 
	`deüRefCouÁ
(
o
);

2839 
key
->
v®ue
 = 
o
;

2840  
REDISMODULE_OK
;

2841 
	}
}

2848 
moduËTy³
 *
	$RM_ModuËTy³G‘Ty³
(
RedisModuËKey
 *
key
) {

2849 ià(
key
 =ğ
NULL
 ||

2850 
key
->
v®ue
 =ğ
NULL
 ||

2851 
	`RM_KeyTy³
(
key
è!ğ
REDISMODULE_KEYTYPE_MODULE
è 
NULL
;

2852 
moduËV®ue
 *
mv
 = 
key
->
v®ue
->
±r
;

2853  
mv
->
ty³
;

2854 
	}
}

2862 *
	$RM_ModuËTy³G‘V®ue
(
RedisModuËKey
 *
key
) {

2863 ià(
key
 =ğ
NULL
 ||

2864 
key
->
v®ue
 =ğ
NULL
 ||

2865 
	`RM_KeyTy³
(
key
è!ğ
REDISMODULE_KEYTYPE_MODULE
è 
NULL
;

2866 
moduËV®ue
 *
mv
 = 
key
->
v®ue
->
±r
;

2867  
mv
->
v®ue
;

2868 
	}
}

2876 
	$moduËRDBLßdE¼Ü
(
RedisModuËIO
 *
io
) {

2877 
	`£rv”Log
(
LL_WARNING
,

2881 
io
->
ty³
->
moduË
->
Çme
,

2882 
io
->
ty³
->
Çme
,

2883 ()
io
->
by‹s
);

2884 
	`ex™
(1);

2885 
	}
}

2890 
	$RM_SaveUnsigÃd
(
RedisModuËIO
 *
io
, 
ušt64_t
 
v®ue
) {

2891 ià(
io
->
”rÜ
) ;

2893 
»tv®
 = 
	`rdbSaveL’
(
io
->
rio
, 
RDB_MODULE_OPCODE_UINT
);

2894 ià(
»tv®
 =ğ-1è
§v“¼
;

2895 
io
->
by‹s
 +ğ
»tv®
;

2897 
»tv®
 = 
	`rdbSaveL’
(
io
->
rio
, 
v®ue
);

2898 ià(
»tv®
 =ğ-1è
§v“¼
;

2899 
io
->
by‹s
 +ğ
»tv®
;

2902 
§v“¼
:

2903 
io
->
”rÜ
 = 1;

2904 
	}
}

2909 
ušt64_t
 
	$RM_LßdUnsigÃd
(
RedisModuËIO
 *
io
) {

2910 ià(
io
->
v”
 == 2) {

2911 
ušt64_t
 
İcode
 = 
	`rdbLßdL’
(
io
->
rio
,
NULL
);

2912 ià(
İcode
 !ğ
RDB_MODULE_OPCODE_UINT
è
lßd”r
;

2914 
ušt64_t
 
v®ue
;

2915 
»tv®
 = 
	`rdbLßdL’ByRef
(
io
->
rio
, 
NULL
, &
v®ue
);

2916 ià(
»tv®
 =ğ-1è
lßd”r
;

2917  
v®ue
;

2919 
lßd”r
:

2920 
	`moduËRDBLßdE¼Ü
(
io
);

2922 
	}
}

2925 
	$RM_SaveSigÃd
(
RedisModuËIO
 *
io
, 
št64_t
 
v®ue
) {

2926 uniÚ {
ušt64_t
 
u
; 
št64_t
 
i
;} 
cÚv
;

2927 
cÚv
.
i
 = 
v®ue
;

2928 
	`RM_SaveUnsigÃd
(
io
,
cÚv
.
u
);

2929 
	}
}

2932 
št64_t
 
	$RM_LßdSigÃd
(
RedisModuËIO
 *
io
) {

2933 uniÚ {
ušt64_t
 
u
; 
št64_t
 
i
;} 
cÚv
;

2934 
cÚv
.
u
 = 
	`RM_LßdUnsigÃd
(
io
);

2935  
cÚv
.
i
;

2936 
	}
}

2944 
	$RM_SaveSŒšg
(
RedisModuËIO
 *
io
, 
RedisModuËSŒšg
 *
s
) {

2945 ià(
io
->
”rÜ
) ;

2947 
»tv®
 = 
	`rdbSaveL’
(
io
->
rio
, 
RDB_MODULE_OPCODE_STRING
);

2948 ià(
»tv®
 =ğ-1è
§v“¼
;

2949 
io
->
by‹s
 +ğ
»tv®
;

2951 
»tv®
 = 
	`rdbSaveSŒšgObjeù
(
io
->
rio
, 
s
);

2952 ià(
»tv®
 =ğ-1è
§v“¼
;

2953 
io
->
by‹s
 +ğ
»tv®
;

2956 
§v“¼
:

2957 
io
->
”rÜ
 = 1;

2958 
	}
}

2962 
	$RM_SaveSŒšgBufãr
(
RedisModuËIO
 *
io
, cÚ¡ *
¡r
, 
size_t
 
Ën
) {

2963 ià(
io
->
”rÜ
) ;

2965 
»tv®
 = 
	`rdbSaveL’
(
io
->
rio
, 
RDB_MODULE_OPCODE_STRING
);

2966 ià(
»tv®
 =ğ-1è
§v“¼
;

2967 
io
->
by‹s
 +ğ
»tv®
;

2969 
»tv®
 = 
	`rdbSaveRawSŒšg
(
io
->
rio
, (*)
¡r
,
Ën
);

2970 ià(
»tv®
 =ğ-1è
§v“¼
;

2971 
io
->
by‹s
 +ğ
»tv®
;

2974 
§v“¼
:

2975 
io
->
”rÜ
 = 1;

2976 
	}
}

2979 *
	$moduËLßdSŒšg
(
RedisModuËIO
 *
io
, 
¶aš
, 
size_t
 *
ËÅŒ
) {

2980 ià(
io
->
v”
 == 2) {

2981 
ušt64_t
 
İcode
 = 
	`rdbLßdL’
(
io
->
rio
,
NULL
);

2982 ià(
İcode
 !ğ
RDB_MODULE_OPCODE_STRING
è
lßd”r
;

2984 *
s
 = 
	`rdbG’”icLßdSŒšgObjeù
(
io
->
rio
,

2985 
¶aš
 ? 
RDB_LOAD_PLAIN
 : 
RDB_LOAD_NONE
, 
ËÅŒ
);

2986 ià(
s
 =ğ
NULL
è
lßd”r
;

2987  
s
;

2989 
lßd”r
:

2990 
	`moduËRDBLßdE¼Ü
(
io
);

2991  
NULL
;

2992 
	}
}

3003 
RedisModuËSŒšg
 *
	$RM_LßdSŒšg
(
RedisModuËIO
 *
io
) {

3004  
	`moduËLßdSŒšg
(
io
,0,
NULL
);

3005 
	}
}

3014 *
	$RM_LßdSŒšgBufãr
(
RedisModuËIO
 *
io
, 
size_t
 *
ËÅŒ
) {

3015  
	`moduËLßdSŒšg
(
io
,1,
ËÅŒ
);

3016 
	}
}

3021 
	$RM_SaveDoubË
(
RedisModuËIO
 *
io
, 
v®ue
) {

3022 ià(
io
->
”rÜ
) ;

3024 
»tv®
 = 
	`rdbSaveL’
(
io
->
rio
, 
RDB_MODULE_OPCODE_DOUBLE
);

3025 ià(
»tv®
 =ğ-1è
§v“¼
;

3026 
io
->
by‹s
 +ğ
»tv®
;

3028 
»tv®
 = 
	`rdbSaveBš¬yDoubËV®ue
(
io
->
rio
, 
v®ue
);

3029 ià(
»tv®
 =ğ-1è
§v“¼
;

3030 
io
->
by‹s
 +ğ
»tv®
;

3033 
§v“¼
:

3034 
io
->
”rÜ
 = 1;

3035 
	}
}

3039 
	$RM_LßdDoubË
(
RedisModuËIO
 *
io
) {

3040 ià(
io
->
v”
 == 2) {

3041 
ušt64_t
 
İcode
 = 
	`rdbLßdL’
(
io
->
rio
,
NULL
);

3042 ià(
İcode
 !ğ
RDB_MODULE_OPCODE_DOUBLE
è
lßd”r
;

3044 
v®ue
;

3045 
»tv®
 = 
	`rdbLßdBš¬yDoubËV®ue
(
io
->
rio
, &
v®ue
);

3046 ià(
»tv®
 =ğ-1è
lßd”r
;

3047  
v®ue
;

3049 
lßd”r
:

3050 
	`moduËRDBLßdE¼Ü
(
io
);

3052 
	}
}

3057 
	$RM_SaveFlßt
(
RedisModuËIO
 *
io
, 
v®ue
) {

3058 ià(
io
->
”rÜ
) ;

3060 
»tv®
 = 
	`rdbSaveL’
(
io
->
rio
, 
RDB_MODULE_OPCODE_FLOAT
);

3061 ià(
»tv®
 =ğ-1è
§v“¼
;

3062 
io
->
by‹s
 +ğ
»tv®
;

3064 
»tv®
 = 
	`rdbSaveBš¬yFlßtV®ue
(
io
->
rio
, 
v®ue
);

3065 ià(
»tv®
 =ğ-1è
§v“¼
;

3066 
io
->
by‹s
 +ğ
»tv®
;

3069 
§v“¼
:

3070 
io
->
”rÜ
 = 1;

3071 
	}
}

3075 
	$RM_LßdFlßt
(
RedisModuËIO
 *
io
) {

3076 ià(
io
->
v”
 == 2) {

3077 
ušt64_t
 
İcode
 = 
	`rdbLßdL’
(
io
->
rio
,
NULL
);

3078 ià(
İcode
 !ğ
RDB_MODULE_OPCODE_FLOAT
è
lßd”r
;

3080 
v®ue
;

3081 
»tv®
 = 
	`rdbLßdBš¬yFlßtV®ue
(
io
->
rio
, &
v®ue
);

3082 ià(
»tv®
 =ğ-1è
lßd”r
;

3083  
v®ue
;

3085 
lßd”r
:

3086 
	`moduËRDBLßdE¼Ü
(
io
);

3088 
	}
}

3132 
	$RM_Dige¡AddSŒšgBufãr
(
RedisModuËDige¡
 *
md
, *
–e
, 
size_t
 
Ën
) {

3133 
	`mixDige¡
(
md
->
o
,
–e
,
Ën
);

3134 
	}
}

3138 
	$RM_Dige¡AddLÚgLÚg
(
RedisModuËDige¡
 *
md
, 
Î
) {

3139 
buf
[
LONG_STR_SIZE
];

3140 
size_t
 
Ën
 = 
	`Î2¡ršg
(
buf
,(buf),
Î
);

3141 
	`mixDige¡
(
md
->
o
,
buf
,
Ën
);

3142 
	}
}

3145 
	$RM_Dige¡EndSequ’û
(
RedisModuËDige¡
 *
md
) {

3146 
	`xÜDige¡
(
md
->
x
,md->
o
,(md->o));

3147 
	`mem£t
(
md
->
o
,0,(md->o));

3148 
	}
}

3159 
	$RM_Em™AOF
(
RedisModuËIO
 *
io
, cÚ¡ *
cmdÇme
, cÚ¡ *
fmt
, ...) {

3160 ià(
io
->
”rÜ
) ;

3161 
»disCommªd
 *
cmd
;

3162 
robj
 **
¬gv
 = 
NULL
;

3163 
¬gc
 = 0, 
æags
 = 0, 
j
;

3164 
va_li¡
 
­
;

3166 
cmd
 = 
	`lookupCommªdByCSŒšg
((*)
cmdÇme
);

3167 ià(!
cmd
) {

3168 
	`£rv”Log
(
LL_WARNING
,

3171 
io
->
ty³
->
Çme
, 
cmdÇme
);

3172 
io
->
”rÜ
 = 1;

3173 
”ºo
 = 
EINVAL
;

3178 
	`va_¡¬t
(
­
, 
fmt
);

3179 
¬gv
 = 
	`moduËC»©eArgvFromU£rFÜm©
(
cmdÇme
,
fmt
,&
¬gc
,&
æags
,
­
);

3180 
	`va_’d
(
­
);

3181 ià(
¬gv
 =ğ
NULL
) {

3182 
	`£rv”Log
(
LL_WARNING
,

3185 
io
->
ty³
->
Çme
, 
fmt
);

3186 
io
->
”rÜ
 = 1;

3187 
”ºo
 = 
EINVAL
;

3192 ià(!
io
->
”rÜ
 && 
	`rioWr™eBulkCouÁ
(io->
rio
,'*',
¬gc
) == 0)

3193 
io
->
”rÜ
 = 1;

3196 
j
 = 0; j < 
¬gc
; j++) {

3197 ià(!
io
->
”rÜ
 && 
	`rioWr™eBulkObjeù
(io->
rio
,
¬gv
[
j
]) == 0)

3198 
io
->
”rÜ
 = 1;

3199 
	`deüRefCouÁ
(
¬gv
[
j
]);

3201 
	`zä“
(
¬gv
);

3203 
	}
}

3209 
RedisModuËCtx
 *
	$RM_G‘CÚ‹xtFromIO
(
RedisModuËIO
 *
io
) {

3210 ià(
io
->
ùx
)  io->ctx;

3211 
RedisModuËCtx
 
ùx‹m¶©e
 = 
REDISMODULE_CTX_INIT
;

3212 
io
->
ùx
 = 
	`zm®loc
((
RedisModuËCtx
));

3213 *(
io
->
ùx
èğ
ùx‹m¶©e
;

3214 
io
->
ùx
->
moduË
 = io->
ty³
->module;

3215 
io
->
ùx
->
ş›Á
 = 
NULL
;

3216  
io
->
ùx
;

3217 
	}
}

3229 
	$RM_LogRaw
(
RedisModuË
 *
moduË
, cÚ¡ *
Ëv–¡r
, cÚ¡ *
fmt
, 
va_li¡
 
­
) {

3230 
msg
[
LOG_MAX_LEN
];

3231 
size_t
 
Çme_Ën
;

3232 
Ëv–
;

3234 ià(!
	`¡rÿ£cmp
(
Ëv–¡r
,"debug")è
Ëv–
 = 
LL_DEBUG
;

3235 ià(!
	`¡rÿ£cmp
(
Ëv–¡r
,"v”bo£")è
Ëv–
 = 
LL_VERBOSE
;

3236 ià(!
	`¡rÿ£cmp
(
Ëv–¡r
,"nÙiû")è
Ëv–
 = 
LL_NOTICE
;

3237 ià(!
	`¡rÿ£cmp
(
Ëv–¡r
,"w¬nšg")è
Ëv–
 = 
LL_WARNING
;

3238 
Ëv–
 = 
LL_VERBOSE
;

3240 
Çme_Ën
 = 
	`¢´štf
(
msg
, (msg),"<%s> ", 
moduË
->
Çme
);

3241 
	`v¢´štf
(
msg
 + 
Çme_Ën
, (msgè-‚ame_Ën, 
fmt
, 
­
);

3242 
	`£rv”LogRaw
(
Ëv–
,
msg
);

3243 
	}
}

3259 
	$RM_Log
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
Ëv–¡r
, cÚ¡ *
fmt
, ...) {

3260 ià(!
ùx
->
moduË
) ;

3262 
va_li¡
 
­
;

3263 
	`va_¡¬t
(
­
, 
fmt
);

3264 
	`RM_LogRaw
(
ùx
->
moduË
,
Ëv–¡r
,
fmt
,
­
);

3265 
	`va_’d
(
­
);

3266 
	}
}

3273 
	$RM_LogIOE¼Ü
(
RedisModuËIO
 *
io
, cÚ¡ *
Ëv–¡r
, cÚ¡ *
fmt
, ...) {

3274 
va_li¡
 
­
;

3275 
	`va_¡¬t
(
­
, 
fmt
);

3276 
	`RM_LogRaw
(
io
->
ty³
->
moduË
,
Ëv–¡r
,
fmt
,
­
);

3277 
	`va_’d
(
­
);

3278 
	}
}

3288 
	$moduËBlockedCl›ÁPeR—dabË
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

3289 
	`UNUSED
(
–
);

3290 
	`UNUSED
(
fd
);

3291 
	`UNUSED
(
mask
);

3292 
	`UNUSED
(
´ivd©a
);

3293 
	}
}

3307 
	$unblockCl›ÁFromModuË
(
ş›Á
 *
c
) {

3308 
RedisModuËBlockedCl›Á
 *
bc
 = 
c
->
bpİ
.
moduË_blocked_hªdË
;

3309 
bc
->
ş›Á
 = 
NULL
;

3314 
	`»£tCl›Á
(
c
);

3315 
	}
}

3333 
RedisModuËBlockedCl›Á
 *
	$RM_BlockCl›Á
(
RedisModuËCtx
 *
ùx
, 
RedisModuËCmdFunc
 
»¶y_ÿÎback
, RedisModuËCmdFunø
timeout_ÿÎback
, (*
ä“_´ivd©a
)(*), 
timeout_ms
) {

3334 
ş›Á
 *
c
 = 
ùx
->client;

3335 
i¦ua
 = 
c
->
æags
 & 
CLIENT_LUA
;

3337 
c
->
bpİ
.
moduË_blocked_hªdË
 = 
	`zm®loc
((
RedisModuËBlockedCl›Á
));

3338 
RedisModuËBlockedCl›Á
 *
bc
 = 
c
->
bpİ
.
moduË_blocked_hªdË
;

3343 
bc
->
ş›Á
 = 
i¦ua
 ? 
NULL
 : 
c
;

3344 
bc
->
moduË
 = 
ùx
->module;

3345 
bc
->
»¶y_ÿÎback
 =„eply_callback;

3346 
bc
->
timeout_ÿÎback
 =imeout_callback;

3347 
bc
->
ä“_´ivd©a
 = free_privdata;

3348 
bc
->
´ivd©a
 = 
NULL
;

3349 
bc
->
»¶y_ş›Á
 = 
	`ü—‹Cl›Á
(-1);

3350 
bc
->
»¶y_ş›Á
->
æags
 |ğ
CLIENT_MODULE
;

3351 
bc
->
dbid
 = 
c
->
db
->
id
;

3352 
c
->
bpİ
.
timeout
 = 
timeout_ms
 ? (
	`m¡ime
()+timeout_ms) : 0;

3354 ià(
i¦ua
) {

3355 
c
->
bpİ
.
moduË_blocked_hªdË
 = 
NULL
;

3356 
	`addR•lyE¼Ü
(
c
,"Blocking module command called from Lua script");

3358 
	`blockCl›Á
(
c
,
BLOCKED_MODULE
);

3360  
bc
;

3361 
	}
}

3374 
	$RM_UnblockCl›Á
(
RedisModuËBlockedCl›Á
 *
bc
, *
´ivd©a
) {

3375 
	`±h»ad_mu‹x_lock
(&
moduËUnblockedCl›ÁsMu‹x
);

3376 
bc
->
´ivd©a
 =…rivdata;

3377 
	`li¡AddNodeTa
(
moduËUnblockedCl›Ás
,
bc
);

3378 ià(
	`wr™e
(
£rv”
.
moduË_blocked_pe
[1],"A",1) != 1) {

3381 
	`±h»ad_mu‹x_uÆock
(&
moduËUnblockedCl›ÁsMu‹x
);

3382  
REDISMODULE_OK
;

3383 
	}
}

3387 
	$RM_AbÜtBlock
(
RedisModuËBlockedCl›Á
 *
bc
) {

3388 
bc
->
»¶y_ÿÎback
 = 
NULL
;

3389  
	`RM_UnblockCl›Á
(
bc
,
NULL
);

3390 
	}
}

3400 
	$moduËHªdËBlockedCl›Ás
() {

3401 
li¡Node
 *
Ê
;

3402 
RedisModuËBlockedCl›Á
 *
bc
;

3404 
	`±h»ad_mu‹x_lock
(&
moduËUnblockedCl›ÁsMu‹x
);

3407 
buf
[1];

3408 
	`»ad
(
£rv”
.
moduË_blocked_pe
[0],
buf
,1) == 1);

3409 
	`li¡L’gth
(
moduËUnblockedCl›Ás
)) {

3410 
Ê
 = 
	`li¡Fœ¡
(
moduËUnblockedCl›Ás
);

3411 
bc
 = 
Ê
->
v®ue
;

3412 
ş›Á
 *
c
 = 
bc
->client;

3413 
	`li¡D–Node
(
moduËUnblockedCl›Ás
,
Ê
);

3414 
	`±h»ad_mu‹x_uÆock
(&
moduËUnblockedCl›ÁsMu‹x
);

3421 ià(
c
 && 
bc
->
»¶y_ÿÎback
) {

3422 
RedisModuËCtx
 
ùx
 = 
REDISMODULE_CTX_INIT
;

3423 
ùx
.
æags
 |ğ
REDISMODULE_CTX_BLOCKED_REPLY
;

3424 
ùx
.
blocked_´ivd©a
 = 
bc
->
´ivd©a
;

3425 
ùx
.
moduË
 = 
bc
->module;

3426 
ùx
.
ş›Á
 = 
bc
->client;

3427 
bc
->
	`»¶y_ÿÎback
(&
ùx
,(**)
c
->
¬gv
,c->
¬gc
);

3428 
	`moduËHªdËPrİag©iÚAá”CommªdC®lback
(&
ùx
);

3429 
	`moduËF»eCÚ‹xt
(&
ùx
);

3433 ià(
bc
->
´ivd©a
 && bc->
ä“_´ivd©a
)

3434 
bc
->
	`ä“_´ivd©a
(bc->
´ivd©a
);

3440 ià(
c
) {

3441 ià(
bc
->
»¶y_ş›Á
->
buåos
)

3442 
	`addR•lySŒšg
(
c
,
bc
->
»¶y_ş›Á
->
buf
,

3443 
bc
->
»¶y_ş›Á
->
buåos
);

3444 ià(
	`li¡L’gth
(
bc
->
»¶y_ş›Á
->
»¶y
))

3445 
	`li¡Još
(
c
->
»¶y
,
bc
->
»¶y_ş›Á
->reply);

3446 
c
->
»¶y_by‹s
 +ğ
bc
->
»¶y_ş›Á
->reply_bytes;

3448 
	`ä“Cl›Á
(
bc
->
»¶y_ş›Á
);

3450 ià(
c
 !ğ
NULL
) {

3451 
	`unblockCl›Á
(
c
);

3455 ià(
	`ş›ÁHasP’dšgR•l›s
(
c
) &&

3456 !(
c
->
æags
 & 
CLIENT_PENDING_WRITE
))

3458 
c
->
æags
 |ğ
CLIENT_PENDING_WRITE
;

3459 
	`li¡AddNodeH—d
(
£rv”
.
ş›Ás_³ndšg_wr™e
,
c
);

3466 
	`zä“
(
bc
);

3469 
	`±h»ad_mu‹x_lock
(&
moduËUnblockedCl›ÁsMu‹x
);

3471 
	`±h»ad_mu‹x_uÆock
(&
moduËUnblockedCl›ÁsMu‹x
);

3472 
	}
}

3478 
	$moduËBlockedCl›ÁTimedOut
(
ş›Á
 *
c
) {

3479 
RedisModuËBlockedCl›Á
 *
bc
 = 
c
->
bpİ
.
moduË_blocked_hªdË
;

3480 
RedisModuËCtx
 
ùx
 = 
REDISMODULE_CTX_INIT
;

3481 
ùx
.
æags
 |ğ
REDISMODULE_CTX_BLOCKED_TIMEOUT
;

3482 
ùx
.
moduË
 = 
bc
->module;

3483 
ùx
.
ş›Á
 = 
bc
->client;

3484 
bc
->
	`timeout_ÿÎback
(&
ùx
,(**)
c
->
¬gv
,c->
¬gc
);

3485 
	`moduËF»eCÚ‹xt
(&
ùx
);

3486 
	}
}

3490 
	$RM_IsBlockedR•lyReque¡
(
RedisModuËCtx
 *
ùx
) {

3491  (
ùx
->
æags
 & 
REDISMODULE_CTX_BLOCKED_REPLY
) != 0;

3492 
	}
}

3496 
	$RM_IsBlockedTimeoutReque¡
(
RedisModuËCtx
 *
ùx
) {

3497  (
ùx
->
æags
 & 
REDISMODULE_CTX_BLOCKED_TIMEOUT
) != 0;

3498 
	}
}

3501 *
	$RM_G‘BlockedCl›ÁPriv©eD©a
(
RedisModuËCtx
 *
ùx
) {

3502  
ùx
->
blocked_´ivd©a
;

3503 
	}
}

3528 
RedisModuËCtx
 *
	$RM_G‘Th»adSaãCÚ‹xt
(
RedisModuËBlockedCl›Á
 *
bc
) {

3529 
RedisModuËCtx
 *
ùx
 = 
	`zm®loc
((*ctx));

3530 
RedisModuËCtx
 
em±y
 = 
REDISMODULE_CTX_INIT
;

3531 
	`memıy
(
ùx
,&
em±y
,(empty));

3532 ià(
bc
) {

3533 
ùx
->
blocked_ş›Á
 = 
bc
;

3534 
ùx
->
moduË
 = 
bc
->module;

3536 
ùx
->
æags
 |ğ
REDISMODULE_CTX_THREAD_SAFE
;

3541 
ùx
->
ş›Á
 = 
	`ü—‹Cl›Á
(-1);

3542 ià(
bc
è
	`£ËùDb
(
ùx
->
ş›Á
,bc->
dbid
);

3543  
ùx
;

3544 
	}
}

3547 
	$RM_F»eTh»adSaãCÚ‹xt
(
RedisModuËCtx
 *
ùx
) {

3548 
	`moduËF»eCÚ‹xt
(
ùx
);

3549 
	`zä“
(
ùx
);

3550 
	}
}

3555 
	$RM_Th»adSaãCÚ‹xtLock
(
RedisModuËCtx
 *
ùx
) {

3556 
	`DICT_NOTUSED
(
ùx
);

3557 
	`moduËAcquœeGIL
();

3558 
	}
}

3561 
	$RM_Th»adSaãCÚ‹xtUÆock
(
RedisModuËCtx
 *
ùx
) {

3562 
	`DICT_NOTUSED
(
ùx
);

3563 
	`moduËR–—£GIL
();

3564 
	}
}

3566 
	$moduËAcquœeGIL
() {

3567 
	`±h»ad_mu‹x_lock
(&
moduËGIL
);

3568 
	}
}

3570 
	$moduËR–—£GIL
() {

3571 
	`±h»ad_mu‹x_uÆock
(&
moduËGIL
);

3572 
	}
}

3581 
ušt64_t
 
	$diùCSŒšgKeyHash
(cÚ¡ *
key
) {

3582  
	`diùG’HashFunùiÚ
((*)
key
, 
	`¡¾’
((*)key));

3583 
	}
}

3585 
	$diùCSŒšgKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
) {

3586 
	`DICT_NOTUSED
(
´ivd©a
);

3587  
	`¡rcmp
(
key1
,
key2
) == 0;

3588 
	}
}

3590 
diùTy³
 
	gmoduËAPIDiùTy³
 = {

3591 
diùCSŒšgKeyHash
,

3592 
NULL
,

3593 
NULL
,

3594 
diùCSŒšgKeyCom·»
,

3595 
NULL
,

3596 
NULL


3599 
	$moduËRegi¡”Api
(cÚ¡ *
funúame
, *
funıŒ
) {

3600  
	`diùAdd
(
£rv”
.
moduË­i
, (*)
funúame
, 
funıŒ
);

3601 
	}
}

3603 
	#REGISTER_API
(
Çme
) \

3604 
	`moduËRegi¡”Api
("RedisModuË_" #Çme, (*)()
RM_
 ## 
Çme
)

	)

3607 
moduËRegi¡”CÜeAPI
();

3609 
	$moduËIn™ModuËsSy¡em
() {

3610 
moduËUnblockedCl›Ás
 = 
	`li¡C»©e
();

3612 
£rv”
.
lßdmoduË_queue
 = 
	`li¡C»©e
();

3613 
moduËs
 = 
	`diùC»©e
(&
moduËsDiùTy³
,
NULL
);

3614 
	`moduËRegi¡”CÜeAPI
();

3615 ià(
	`pe
(
£rv”
.
moduË_blocked_pe
) == -1) {

3616 
	`£rv”Log
(
LL_WARNING
,

3618 
	`¡»¼Ü
(
”ºo
));

3619 
	`ex™
(1);

3623 
	`ª‘NÚBlock
(
NULL
,
£rv”
.
moduË_blocked_pe
[0]);

3624 
	`ª‘NÚBlock
(
NULL
,
£rv”
.
moduË_blocked_pe
[1]);

3628 
	`±h»ad_mu‹x_lock
(&
moduËGIL
);

3629 
	}
}

3640 
	$moduËLßdFromQueue
() {

3641 
li¡I‹r
 
li
;

3642 
li¡Node
 *
Ê
;

3644 
	`li¡Rewšd
(
£rv”
.
lßdmoduË_queue
,&
li
);

3645 (
Ê
 = 
	`li¡Next
(&
li
))) {

3646 
moduËLßdQueueEÁry
 *
lßdmod
 = 
Ê
->
v®ue
;

3647 ià(
	`moduËLßd
(
lßdmod
->
·th
,(**îßdmod->
¬gv
,lßdmod->
¬gc
)

3648 =ğ
C_ERR
)

3650 
	`£rv”Log
(
LL_WARNING
,

3652 
lßdmod
->
·th
);

3653 
	`ex™
(1);

3656 
	}
}

3658 
	$moduËF»eModuËSŒuùu»
(
RedisModuË
 *
moduË
) {

3659 
	`li¡R–—£
(
moduË
->
ty³s
);

3660 
	`sdsä“
(
moduË
->
Çme
);

3661 
	`zä“
(
moduË
);

3662 
	}
}

3666 
	$moduËLßd
(cÚ¡ *
·th
, **
moduË_¬gv
, 
moduË_¬gc
) {

3667 (*
Úlßd
)(*, **, );

3668 *
hªdË
;

3669 
RedisModuËCtx
 
ùx
 = 
REDISMODULE_CTX_INIT
;

3671 
hªdË
 = 
	`dlİ’
(
·th
,
RTLD_NOW
|
RTLD_LOCAL
);

3672 ià(
hªdË
 =ğ
NULL
) {

3673 
	`£rv”Log
(
LL_WARNING
, "ModuË % çedØlßd: %s", 
·th
, 
	`dË¼Ü
());

3674  
C_ERR
;

3676 
Úlßd
 = ((*)(*, **, ))(è
	`dlsym
(
hªdË
,"RedisModule_OnLoad");

3677 ià(
Úlßd
 =ğ
NULL
) {

3678 
	`£rv”Log
(
LL_WARNING
,

3680 "symbŞ. ModuË‚Ù†ßded.",
·th
);

3681  
C_ERR
;

3683 ià(
	`Úlßd
((*)&
ùx
,
moduË_¬gv
,
moduË_¬gc
è=ğ
REDISMODULE_ERR
) {

3684 ià(
ùx
.
moduË
è
	`moduËF»eModuËSŒuùu»
(ctx.module);

3685 
	`dlşo£
(
hªdË
);

3686 
	`£rv”Log
(
LL_WARNING
,

3687 "ModuË % š™Ÿliz©iÚ faed. ModuË‚Ù†ßded",
·th
);

3688  
C_ERR
;

3692 
	`diùAdd
(
moduËs
,
ùx
.
moduË
->
Çme
,ctx.module);

3693 
ùx
.
moduË
->
hªdË
 = handle;

3694 
	`£rv”Log
(
LL_NOTICE
,"ModuË '%s'†ßded from %s",
ùx
.
moduË
->
Çme
,
·th
);

3695 
	`moduËF»eCÚ‹xt
(&
ùx
);

3696  
C_OK
;

3697 
	}
}

3705 
	$moduËUÆßd
(
sds
 
Çme
) {

3706 
RedisModuË
 *
moduË
 = 
	`diùF‘chV®ue
(
moduËs
,
Çme
);

3708 ià(
moduË
 =ğ
NULL
) {

3709 
”ºo
 = 
ENOENT
;

3710  
REDISMODULE_ERR
;

3713 ià(
	`li¡L’gth
(
moduË
->
ty³s
)) {

3714 
”ºo
 = 
EBUSY
;

3715  
REDISMODULE_ERR
;

3719 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
commªds
);

3720 
diùEÁry
 *
de
;

3721 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3722 
»disCommªd
 *
cmd
 = 
	`diùG‘V®
(
de
);

3723 ià(
cmd
->
´oc
 =ğ
RedisModuËCommªdDi¥©ch”
) {

3724 
RedisModuËCommªdProxy
 *
ı
 =

3725 (*)()
cmd
->
g‘keys_´oc
;

3726 
sds
 
cmdÇme
 = 
ı
->
»discmd
->
Çme
;

3727 ià(
ı
->
moduË
 == module) {

3728 
	`diùD–‘e
(
£rv”
.
commªds
,
cmdÇme
);

3729 
	`diùD–‘e
(
£rv”
.
Üig_commªds
,
cmdÇme
);

3730 
	`sdsä“
(
cmdÇme
);

3731 
	`zä“
(
ı
->
»discmd
);

3732 
	`zä“
(
ı
);

3736 
	`diùR–—£I‹¿tÜ
(
di
);

3741 ià(
	`dlşo£
(
moduË
->
hªdË
) == -1) {

3742 *
”rÜ
 = 
	`dË¼Ü
();

3743 ià(
”rÜ
 =ğ
NULL
)ƒrror = "Unknownƒrror";

3744 
	`£rv”Log
(
LL_WARNING
,"Error whenryingo closehe %s module: %s",

3745 
moduË
->
Çme
, 
”rÜ
);

3749 
	`£rv”Log
(
LL_NOTICE
,"ModuË % uÆßded",
moduË
->
Çme
);

3750 
	`diùD–‘e
(
moduËs
,
moduË
->
Çme
);

3751 
moduË
->
Çme
 = 
NULL
;

3752 
	`moduËF»eModuËSŒuùu»
(
moduË
);

3754  
REDISMODULE_OK
;

3755 
	}
}

3760 
	$moduËCommªd
(
ş›Á
 *
c
) {

3761 *
subcmd
 = 
c
->
¬gv
[1]->
±r
;

3763 ià(!
	`¡rÿ£cmp
(
subcmd
,"lßd"è&& 
c
->
¬gc
 >= 3) {

3764 
robj
 **
¬gv
 = 
NULL
;

3765 
¬gc
 = 0;

3767 ià(
c
->
¬gc
 > 3) {

3768 
¬gc
 = 
c
->argc - 3;

3769 
¬gv
 = &
c
->argv[3];

3772 ià(
	`moduËLßd
(
c
->
¬gv
[2]->
±r
,(**ïrgv,
¬gc
è=ğ
C_OK
)

3773 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

3775 
	`addR•lyE¼Ü
(
c
,

3777 } ià(!
	`¡rÿ£cmp
(
subcmd
,"uÆßd"è&& 
c
->
¬gc
 == 3) {

3778 ià(
	`moduËUÆßd
(
c
->
¬gv
[2]->
±r
è=ğ
C_OK
)

3779 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

3781 *
”rmsg
;

3782 
”ºo
) {

3783 
ENOENT
:

3784 
”rmsg
 = "no such module withhat‚ame";

3786 
EBUSY
:

3787 
”rmsg
 = "the moduleƒxports one or more module-side dataypes, can't unload";

3790 
”rmsg
 = "operation‚ot…ossible.";

3793 
	`addR•lyE¼ÜFÜm©
(
c
,"E¼Ü uÆßdšg moduË: %s",
”rmsg
);

3795 } ià(!
	`¡rÿ£cmp
(
subcmd
,"li¡"è&& 
c
->
¬gc
 == 2) {

3796 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
moduËs
);

3797 
diùEÁry
 *
de
;

3799 
	`addR•lyMuÉiBulkL’
(
c
,
	`diùSize
(
moduËs
));

3800 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3801 
sds
 
Çme
 = 
	`diùG‘Key
(
de
);

3802 
RedisModuË
 *
moduË
 = 
	`diùG‘V®
(
de
);

3803 
	`addR•lyMuÉiBulkL’
(
c
,4);

3804 
	`addR•lyBulkCSŒšg
(
c
,"name");

3805 
	`addR•lyBulkCBufãr
(
c
,
Çme
,
	`sd¦’
(name));

3806 
	`addR•lyBulkCSŒšg
(
c
,"ver");

3807 
	`addR•lyLÚgLÚg
(
c
,
moduË
->
v”
);

3809 
	`diùR–—£I‹¿tÜ
(
di
);

3811 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

3813 
	}
}

3816 
size_t
 
	$moduËCouÁ
() {

3817  
	`diùSize
(
moduËs
);

3818 
	}
}

3822 
	$moduËRegi¡”CÜeAPI
() {

3823 
£rv”
.
moduË­i
 = 
	`diùC»©e
(&
moduËAPIDiùTy³
,
NULL
);

3824 
	`REGISTER_API
(
AÎoc
);

3825 
	`REGISTER_API
(
C®loc
);

3826 
	`REGISTER_API
(
R—Îoc
);

3827 
	`REGISTER_API
(
F»e
);

3828 
	`REGISTER_API
(
SŒdup
);

3829 
	`REGISTER_API
(
C»©eCommªd
);

3830 
	`REGISTER_API
(
S‘ModuËA‰ribs
);

3831 
	`REGISTER_API
(
WrÚgAr™y
);

3832 
	`REGISTER_API
(
R•lyW™hLÚgLÚg
);

3833 
	`REGISTER_API
(
R•lyW™hE¼Ü
);

3834 
	`REGISTER_API
(
R•lyW™hSim¶eSŒšg
);

3835 
	`REGISTER_API
(
R•lyW™hA¼ay
);

3836 
	`REGISTER_API
(
R•lyS‘A¼ayL’gth
);

3837 
	`REGISTER_API
(
R•lyW™hSŒšg
);

3838 
	`REGISTER_API
(
R•lyW™hSŒšgBufãr
);

3839 
	`REGISTER_API
(
R•lyW™hNuÎ
);

3840 
	`REGISTER_API
(
R•lyW™hC®lR•ly
);

3841 
	`REGISTER_API
(
R•lyW™hDoubË
);

3842 
	`REGISTER_API
(
G‘S–eùedDb
);

3843 
	`REGISTER_API
(
S–eùDb
);

3844 
	`REGISTER_API
(
O³nKey
);

3845 
	`REGISTER_API
(
Clo£Key
);

3846 
	`REGISTER_API
(
KeyTy³
);

3847 
	`REGISTER_API
(
V®ueL’gth
);

3848 
	`REGISTER_API
(
Li¡Push
);

3849 
	`REGISTER_API
(
Li¡Pİ
);

3850 
	`REGISTER_API
(
SŒšgToLÚgLÚg
);

3851 
	`REGISTER_API
(
SŒšgToDoubË
);

3852 
	`REGISTER_API
(
C®l
);

3853 
	`REGISTER_API
(
C®lR•lyPrÙo
);

3854 
	`REGISTER_API
(
F»eC®lR•ly
);

3855 
	`REGISTER_API
(
C®lR•lyIÁeg”
);

3856 
	`REGISTER_API
(
C®lR•lyTy³
);

3857 
	`REGISTER_API
(
C®lR•lyL’gth
);

3858 
	`REGISTER_API
(
C®lR•lyA¼ayEËm’t
);

3859 
	`REGISTER_API
(
C®lR•lySŒšgPŒ
);

3860 
	`REGISTER_API
(
C»©eSŒšgFromC®lR•ly
);

3861 
	`REGISTER_API
(
C»©eSŒšg
);

3862 
	`REGISTER_API
(
C»©eSŒšgFromLÚgLÚg
);

3863 
	`REGISTER_API
(
C»©eSŒšgFromSŒšg
);

3864 
	`REGISTER_API
(
C»©eSŒšgPrštf
);

3865 
	`REGISTER_API
(
F»eSŒšg
);

3866 
	`REGISTER_API
(
SŒšgPŒL’
);

3867 
	`REGISTER_API
(
AutoMemÜy
);

3868 
	`REGISTER_API
(
R•liÿ‹
);

3869 
	`REGISTER_API
(
R•liÿ‹V”b©im
);

3870 
	`REGISTER_API
(
D–‘eKey
);

3871 
	`REGISTER_API
(
SŒšgS‘
);

3872 
	`REGISTER_API
(
SŒšgDMA
);

3873 
	`REGISTER_API
(
SŒšgTrunÿ‹
);

3874 
	`REGISTER_API
(
S‘Expœe
);

3875 
	`REGISTER_API
(
G‘Expœe
);

3876 
	`REGISTER_API
(
Z£tAdd
);

3877 
	`REGISTER_API
(
Z£tInüby
);

3878 
	`REGISTER_API
(
Z£tScÜe
);

3879 
	`REGISTER_API
(
Z£tRem
);

3880 
	`REGISTER_API
(
Z£tRªgeStİ
);

3881 
	`REGISTER_API
(
Z£tFœ¡InScÜeRªge
);

3882 
	`REGISTER_API
(
Z£tLa¡InScÜeRªge
);

3883 
	`REGISTER_API
(
Z£tFœ¡InLexRªge
);

3884 
	`REGISTER_API
(
Z£tLa¡InLexRªge
);

3885 
	`REGISTER_API
(
Z£tRªgeCu¼’tEËm’t
);

3886 
	`REGISTER_API
(
Z£tRªgeNext
);

3887 
	`REGISTER_API
(
Z£tRªgeP»v
);

3888 
	`REGISTER_API
(
Z£tRªgeEndR—ched
);

3889 
	`REGISTER_API
(
HashS‘
);

3890 
	`REGISTER_API
(
HashG‘
);

3891 
	`REGISTER_API
(
IsKeysPos™iÚReque¡
);

3892 
	`REGISTER_API
(
KeyAtPos
);

3893 
	`REGISTER_API
(
G‘Cl›ÁId
);

3894 
	`REGISTER_API
(
PoŞAÎoc
);

3895 
	`REGISTER_API
(
C»©eD©aTy³
);

3896 
	`REGISTER_API
(
ModuËTy³S‘V®ue
);

3897 
	`REGISTER_API
(
ModuËTy³G‘Ty³
);

3898 
	`REGISTER_API
(
ModuËTy³G‘V®ue
);

3899 
	`REGISTER_API
(
SaveUnsigÃd
);

3900 
	`REGISTER_API
(
LßdUnsigÃd
);

3901 
	`REGISTER_API
(
SaveSigÃd
);

3902 
	`REGISTER_API
(
LßdSigÃd
);

3903 
	`REGISTER_API
(
SaveSŒšg
);

3904 
	`REGISTER_API
(
SaveSŒšgBufãr
);

3905 
	`REGISTER_API
(
LßdSŒšg
);

3906 
	`REGISTER_API
(
LßdSŒšgBufãr
);

3907 
	`REGISTER_API
(
SaveDoubË
);

3908 
	`REGISTER_API
(
LßdDoubË
);

3909 
	`REGISTER_API
(
SaveFlßt
);

3910 
	`REGISTER_API
(
LßdFlßt
);

3911 
	`REGISTER_API
(
Em™AOF
);

3912 
	`REGISTER_API
(
Log
);

3913 
	`REGISTER_API
(
LogIOE¼Ü
);

3914 
	`REGISTER_API
(
SŒšgAµ’dBufãr
);

3915 
	`REGISTER_API
(
R‘ašSŒšg
);

3916 
	`REGISTER_API
(
SŒšgCom·»
);

3917 
	`REGISTER_API
(
G‘CÚ‹xtFromIO
);

3918 
	`REGISTER_API
(
BlockCl›Á
);

3919 
	`REGISTER_API
(
UnblockCl›Á
);

3920 
	`REGISTER_API
(
IsBlockedR•lyReque¡
);

3921 
	`REGISTER_API
(
IsBlockedTimeoutReque¡
);

3922 
	`REGISTER_API
(
G‘BlockedCl›ÁPriv©eD©a
);

3923 
	`REGISTER_API
(
AbÜtBlock
);

3924 
	`REGISTER_API
(
Mli£cÚds
);

3925 
	`REGISTER_API
(
G‘Th»adSaãCÚ‹xt
);

3926 
	`REGISTER_API
(
F»eTh»adSaãCÚ‹xt
);

3927 
	`REGISTER_API
(
Th»adSaãCÚ‹xtLock
);

3928 
	`REGISTER_API
(
Th»adSaãCÚ‹xtUÆock
);

3929 
	`REGISTER_API
(
Dige¡AddSŒšgBufãr
);

3930 
	`REGISTER_API
(
Dige¡AddLÚgLÚg
);

3931 
	`REGISTER_API
(
Dige¡EndSequ’û
);

3932 
	}
}

	@modules/helloblock.c

34 
	#REDISMODULE_EXPERIMENTAL_API


	)

35 
	~"../»dismoduË.h
"

36 
	~<¡dio.h
>

37 
	~<¡dlib.h
>

38 
	~<±h»ad.h
>

39 
	~<uni¡d.h
>

42 
	$H–loBlock_R•ly
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

43 
	`REDISMODULE_NOT_USED
(
¬gv
);

44 
	`REDISMODULE_NOT_USED
(
¬gc
);

45 *
myšt
 = 
	`RedisModuË_G‘BlockedCl›ÁPriv©eD©a
(
ùx
);

46  
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,*
myšt
);

47 
	}
}

50 
	$H–loBlock_Timeout
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

51 
	`REDISMODULE_NOT_USED
(
¬gv
);

52 
	`REDISMODULE_NOT_USED
(
¬gc
);

53  
	`RedisModuË_R•lyW™hSim¶eSŒšg
(
ùx
,"Requestimedout");

54 
	}
}

57 
	$H–loBlock_F»eD©a
(*
´ivd©a
) {

58 
	`RedisModuË_F»e
(
´ivd©a
);

59 
	}
}

63 *
	$H–loBlock_Th»adMaš
(*
¬g
) {

64 **
rg
 = 
¬g
;

65 
RedisModuËBlockedCl›Á
 *
bc
 = 
rg
[0];

66 
d–ay
 = ()
rg
[1];

67 
	`RedisModuË_F»e
(
rg
);

69 
	`¦“p
(
d–ay
);

70 *
r
 = 
	`RedisModuË_AÎoc
(());

71 *
r
 = 
	`¿nd
();

72 
	`RedisModuË_UnblockCl›Á
(
bc
,
r
);

73  
NULL
;

74 
	}
}

79 
	$H–loBlock_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

80 ià(
¬gc
 !ğ3è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

81 
d–ay
;

82 
timeout
;

84 ià(
	`RedisModuË_SŒšgToLÚgLÚg
(
¬gv
[1],&
d–ay
è!ğ
REDISMODULE_OK
) {

85  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,"ERR invalid count");

88 ià(
	`RedisModuË_SŒšgToLÚgLÚg
(
¬gv
[2],&
timeout
è!ğ
REDISMODULE_OK
) {

89  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,"ERR invalid count");

92 
±h»ad_t
 
tid
;

93 
RedisModuËBlockedCl›Á
 *
bc
 = 
	`RedisModuË_BlockCl›Á
(
ùx
,
H–loBlock_R•ly
,
H–loBlock_Timeout
,
H–loBlock_F»eD©a
,
timeout
);

98 **
rg
 = 
	`RedisModuË_AÎoc
((*)*2);

99 
rg
[0] = 
bc
;

100 
rg
[1] = (*)(è
d–ay
;

102 ià(
	`±h»ad_ü—‹
(&
tid
,
NULL
,
H–loBlock_Th»adMaš
,
rg
) != 0) {

103 
	`RedisModuË_AbÜtBlock
(
bc
);

104  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,"-ERR Can't starthread");

106  
REDISMODULE_OK
;

107 
	}
}

116 *
	$H–loKeys_Th»adMaš
(*
¬g
) {

117 
RedisModuËBlockedCl›Á
 *
bc
 = 
¬g
;

118 
RedisModuËCtx
 *
ùx
 = 
	`RedisModuË_G‘Th»adSaãCÚ‹xt
(
bc
);

119 
cursÜ
 = 0;

120 
size_t
 
»¶yËn
 = 0;

122 
	`RedisModuË_R•lyW™hA¼ay
(
ùx
,
REDISMODULE_POSTPONED_ARRAY_LEN
);

124 
	`RedisModuË_Th»adSaãCÚ‹xtLock
(
ùx
);

125 
RedisModuËC®lR•ly
 *
»¶y
 = 
	`RedisModuË_C®l
(
ùx
,

126 "SCAN","l",()
cursÜ
);

127 
	`RedisModuË_Th»adSaãCÚ‹xtUÆock
(
ùx
);

129 
RedisModuËC®lR•ly
 *
ü_cursÜ
 =

130 
	`RedisModuË_C®lR•lyA¼ayEËm’t
(
»¶y
,0);

131 
RedisModuËC®lR•ly
 *
ü_keys
 =

132 
	`RedisModuË_C®lR•lyA¼ayEËm’t
(
»¶y
,1);

134 
RedisModuËSŒšg
 *
s
 = 
	`RedisModuË_C»©eSŒšgFromC®lR•ly
(
ü_cursÜ
);

135 
	`RedisModuË_SŒšgToLÚgLÚg
(
s
,&
cursÜ
);

136 
	`RedisModuË_F»eSŒšg
(
ùx
,
s
);

138 
size_t
 
™ems
 = 
	`RedisModuË_C®lR•lyL’gth
(
ü_keys
);

139 
size_t
 
j
 = 0; j < 
™ems
; j++) {

140 
RedisModuËC®lR•ly
 *
–e
 =

141 
	`RedisModuË_C®lR•lyA¼ayEËm’t
(
ü_keys
,
j
);

142 
	`RedisModuË_R•lyW™hC®lR•ly
(
ùx
,
–e
);

143 
»¶yËn
++;

145 
	`RedisModuË_F»eC®lR•ly
(
»¶y
);

146 } 
cursÜ
 != 0);

147 
	`RedisModuË_R•lyS‘A¼ayL’gth
(
ùx
,
»¶yËn
);

149 
	`RedisModuË_F»eTh»adSaãCÚ‹xt
(
ùx
);

150 
	`RedisModuË_UnblockCl›Á
(
bc
,
NULL
);

151  
NULL
;

152 
	}
}

158 
	$H–loKeys_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

159 
	`REDISMODULE_NOT_USED
(
¬gv
);

160 ià(
¬gc
 !ğ1è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

162 
±h»ad_t
 
tid
;

167 
RedisModuËBlockedCl›Á
 *
bc
 = 
	`RedisModuË_BlockCl›Á
(
ùx
,
NULL
,NULL,NULL,0);

172 ià(
	`±h»ad_ü—‹
(&
tid
,
NULL
,
H–loKeys_Th»adMaš
,
bc
) != 0) {

173 
	`RedisModuË_AbÜtBlock
(
bc
);

174  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,"-ERR Can't starthread");

176  
REDISMODULE_OK
;

177 
	}
}

181 
	$RedisModuË_OnLßd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

182 
	`REDISMODULE_NOT_USED
(
¬gv
);

183 
	`REDISMODULE_NOT_USED
(
¬gc
);

185 ià(
	`RedisModuË_In™
(
ùx
,"h–loblock",1,
REDISMODULE_APIVER_1
)

186 =ğ
REDISMODULE_ERR
)  REDISMODULE_ERR;

188 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.block",

189 
H–loBlock_RedisCommªd
,"",0,0,0è=ğ
REDISMODULE_ERR
)

190  
REDISMODULE_ERR
;

191 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.keys",

192 
H–loKeys_RedisCommªd
,"",0,0,0è=ğ
REDISMODULE_ERR
)

193  
REDISMODULE_ERR
;

195  
REDISMODULE_OK
;

196 
	}
}

	@modules/hellotype.c

38 
	~"../»dismoduË.h
"

39 
	~<¡dio.h
>

40 
	~<¡dlib.h
>

41 
	~<ùy³.h
>

42 
	~<¡ršg.h
>

43 
	~<¡dšt.h
>

45 
RedisModuËTy³
 *
	gH–loTy³
;

53 
	sH–loTy³Node
 {

54 
št64_t
 
	mv®ue
;

55 
H–loTy³Node
 *
	mÃxt
;

58 
	sH–loTy³Objeù
 {

59 
H–loTy³Node
 *
	mh—d
;

60 
size_t
 
	mËn
;

63 
H–loTy³Objeù
 *
	$ü—‹H–loTy³Objeù
() {

64 
H–loTy³Objeù
 *
o
;

65 
o
 = 
	`RedisModuË_AÎoc
((*o));

66 
o
->
h—d
 = 
NULL
;

67 
o
->
Ën
 = 0;

68  
o
;

69 
	}
}

71 
	$H–loTy³In£¹
(
H–loTy³Objeù
 *
o
, 
št64_t
 
–e
) {

72 
H–loTy³Node
 *
Ãxt
 = 
o
->
h—d
, *
Ãwnode
, *
´ev
 = 
NULL
;

74 
Ãxt
 &&‚ext->
v®ue
 < 
–e
) {

75 
´ev
 = 
Ãxt
;

76 
Ãxt
 =‚ext->next;

78 
Ãwnode
 = 
	`RedisModuË_AÎoc
((*newnode));

79 
Ãwnode
->
v®ue
 = 
–e
;

80 
Ãwnode
->
Ãxt
 =‚ext;

81 ià(
´ev
) {

82 
´ev
->
Ãxt
 = 
Ãwnode
;

84 
o
->
h—d
 = 
Ãwnode
;

86 
o
->
Ën
++;

87 
	}
}

89 
	$H–loTy³R–—£Objeù
(
H–loTy³Objeù
 *
o
) {

90 
H–loTy³Node
 *
cur
, *
Ãxt
;

91 
cur
 = 
o
->
h—d
;

92 
cur
) {

93 
Ãxt
 = 
cur
->next;

94 
	`RedisModuË_F»e
(
cur
);

95 
cur
 = 
Ãxt
;

97 
	`RedisModuË_F»e
(
o
);

98 
	}
}

103 
	$H–loTy³In£¹_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

104 
	`RedisModuË_AutoMemÜy
(
ùx
);

106 ià(
¬gc
 !ğ3è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

107 
RedisModuËKey
 *
key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

108 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

109 
ty³
 = 
	`RedisModuË_KeyTy³
(
key
);

110 ià(
ty³
 !ğ
REDISMODULE_KEYTYPE_EMPTY
 &&

111 
	`RedisModuË_ModuËTy³G‘Ty³
(
key
è!ğ
H–loTy³
)

113  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,
REDISMODULE_ERRORMSG_WRONGTYPE
);

116 
v®ue
;

117 ià((
	`RedisModuË_SŒšgToLÚgLÚg
(
¬gv
[2],&
v®ue
è!ğ
REDISMODULE_OK
)) {

118  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,"ERR invalid value: must be‡ signed 64 bit integer");

122 
H–loTy³Objeù
 *
hto
;

123 ià(
ty³
 =ğ
REDISMODULE_KEYTYPE_EMPTY
) {

124 
hto
 = 
	`ü—‹H–loTy³Objeù
();

125 
	`RedisModuË_ModuËTy³S‘V®ue
(
key
,
H–loTy³
,
hto
);

127 
hto
 = 
	`RedisModuË_ModuËTy³G‘V®ue
(
key
);

131 
	`H–loTy³In£¹
(
hto
,
v®ue
);

133 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
hto
->
Ën
);

134 
	`RedisModuË_R•liÿ‹V”b©im
(
ùx
);

135  
REDISMODULE_OK
;

136 
	}
}

139 
	$H–loTy³Rªge_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

140 
	`RedisModuË_AutoMemÜy
(
ùx
);

142 ià(
¬gc
 !ğ4è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

143 
RedisModuËKey
 *
key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

144 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

145 
ty³
 = 
	`RedisModuË_KeyTy³
(
key
);

146 ià(
ty³
 !ğ
REDISMODULE_KEYTYPE_EMPTY
 &&

147 
	`RedisModuË_ModuËTy³G‘Ty³
(
key
è!ğ
H–loTy³
)

149  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,
REDISMODULE_ERRORMSG_WRONGTYPE
);

152 
fœ¡
, 
couÁ
;

153 ià(
	`RedisModuË_SŒšgToLÚgLÚg
(
¬gv
[2],&
fœ¡
è!ğ
REDISMODULE_OK
 ||

154 
	`RedisModuË_SŒšgToLÚgLÚg
(
¬gv
[3],&
couÁ
è!ğ
REDISMODULE_OK
 ||

155 
fœ¡
 < 0 || 
couÁ
 < 0)

157  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,

161 
H–loTy³Objeù
 *
hto
 = 
	`RedisModuË_ModuËTy³G‘V®ue
(
key
);

162 
H–loTy³Node
 *
node
 = 
hto
 ? hto->
h—d
 : 
NULL
;

163 
	`RedisModuË_R•lyW™hA¼ay
(
ùx
,
REDISMODULE_POSTPONED_ARRAY_LEN
);

164 
¬¿yËn
 = 0;

165 
node
 && 
couÁ
--) {

166 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
node
->
v®ue
);

167 
¬¿yËn
++;

168 
node
 =‚ode->
Ãxt
;

170 
	`RedisModuË_R•lyS‘A¼ayL’gth
(
ùx
,
¬¿yËn
);

171  
REDISMODULE_OK
;

172 
	}
}

175 
	$H–loTy³L’_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

176 
	`RedisModuË_AutoMemÜy
(
ùx
);

178 ià(
¬gc
 !ğ2è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

179 
RedisModuËKey
 *
key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

180 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

181 
ty³
 = 
	`RedisModuË_KeyTy³
(
key
);

182 ià(
ty³
 !ğ
REDISMODULE_KEYTYPE_EMPTY
 &&

183 
	`RedisModuË_ModuËTy³G‘Ty³
(
key
è!ğ
H–loTy³
)

185  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,
REDISMODULE_ERRORMSG_WRONGTYPE
);

188 
H–loTy³Objeù
 *
hto
 = 
	`RedisModuË_ModuËTy³G‘V®ue
(
key
);

189 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
hto
 ? hto->
Ën
 : 0);

190  
REDISMODULE_OK
;

191 
	}
}

196 *
	$H–loTy³RdbLßd
(
RedisModuËIO
 *
rdb
, 
’cv”
) {

197 ià(
’cv”
 != 0) {

199  
NULL
;

201 
ušt64_t
 
–em’ts
 = 
	`RedisModuË_LßdUnsigÃd
(
rdb
);

202 
H–loTy³Objeù
 *
hto
 = 
	`ü—‹H–loTy³Objeù
();

203 
–em’ts
--) {

204 
št64_t
 
–e
 = 
	`RedisModuË_LßdSigÃd
(
rdb
);

205 
	`H–loTy³In£¹
(
hto
,
–e
);

207  
hto
;

208 
	}
}

210 
	$H–loTy³RdbSave
(
RedisModuËIO
 *
rdb
, *
v®ue
) {

211 
H–loTy³Objeù
 *
hto
 = 
v®ue
;

212 
H–loTy³Node
 *
node
 = 
hto
->
h—d
;

213 
	`RedisModuË_SaveUnsigÃd
(
rdb
,
hto
->
Ën
);

214 
node
) {

215 
	`RedisModuË_SaveSigÃd
(
rdb
,
node
->
v®ue
);

216 
node
 =‚ode->
Ãxt
;

218 
	}
}

220 
	$H–loTy³AofRewr™e
(
RedisModuËIO
 *
aof
, 
RedisModuËSŒšg
 *
key
, *
v®ue
) {

221 
H–loTy³Objeù
 *
hto
 = 
v®ue
;

222 
H–loTy³Node
 *
node
 = 
hto
->
h—d
;

223 
node
) {

224 
	`RedisModuË_Em™AOF
(
aof
,"HELLOTYPE.INSERT","¦",
key
,
node
->
v®ue
);

225 
node
 =‚ode->
Ãxt
;

227 
	}
}

231 
size_t
 
	$H–loTy³MemU§ge
(cÚ¡ *
v®ue
) {

232 cÚ¡ 
H–loTy³Objeù
 *
hto
 = 
v®ue
;

233 
H–loTy³Node
 *
node
 = 
hto
->
h—d
;

234  (*
hto
è+ (*
node
)*hto->
Ën
;

235 
	}
}

237 
	$H–loTy³F»e
(*
v®ue
) {

238 
	`H–loTy³R–—£Objeù
(
v®ue
);

239 
	}
}

241 
	$H–loTy³Dige¡
(
RedisModuËDige¡
 *
md
, *
v®ue
) {

242 
H–loTy³Objeù
 *
hto
 = 
v®ue
;

243 
H–loTy³Node
 *
node
 = 
hto
->
h—d
;

244 
node
) {

245 
	`RedisModuË_Dige¡AddLÚgLÚg
(
md
,
node
->
v®ue
);

246 
node
 =‚ode->
Ãxt
;

248 
	`RedisModuË_Dige¡EndSequ’û
(
md
);

249 
	}
}

253 
	$RedisModuË_OnLßd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

254 
	`REDISMODULE_NOT_USED
(
¬gv
);

255 
	`REDISMODULE_NOT_USED
(
¬gc
);

257 ià(
	`RedisModuË_In™
(
ùx
,"h–lÙy³",1,
REDISMODULE_APIVER_1
)

258 =ğ
REDISMODULE_ERR
)  REDISMODULE_ERR;

260 
RedisModuËTy³M‘hods
 
tm
 = {

261 .
v”siÚ
 = 
REDISMODULE_TYPE_METHOD_VERSION
,

262 .
rdb_lßd
 = 
H–loTy³RdbLßd
,

263 .
rdb_§ve
 = 
H–loTy³RdbSave
,

264 .
aof_»wr™e
 = 
H–loTy³AofRewr™e
,

265 .
mem_u§ge
 = 
H–loTy³MemU§ge
,

266 .
ä“
 = 
H–loTy³F»e
,

267 .
dige¡
 = 
H–loTy³Dige¡


270 
H–loTy³
 = 
	`RedisModuË_C»©eD©aTy³
(
ùx
,"h–lÙy³",0,&
tm
);

271 ià(
H–loTy³
 =ğ
NULL
è 
REDISMODULE_ERR
;

273 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hellotype.insert",

274 
H–loTy³In£¹_RedisCommªd
,"wr™d’y-oom",1,1,1è=ğ
REDISMODULE_ERR
)

275  
REDISMODULE_ERR
;

277 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hellotype.range",

278 
H–loTy³Rªge_RedisCommªd
,"»adÚly",1,1,1è=ğ
REDISMODULE_ERR
)

279  
REDISMODULE_ERR
;

281 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hellotype.len",

282 
H–loTy³L’_RedisCommªd
,"»adÚly",1,1,1è=ğ
REDISMODULE_ERR
)

283  
REDISMODULE_ERR
;

285  
REDISMODULE_OK
;

286 
	}
}

	@modules/helloworld.c

37 
	~"../»dismoduË.h
"

38 
	~<¡dio.h
>

39 
	~<¡dlib.h
>

40 
	~<ùy³.h
>

41 
	~<¡ršg.h
>

48 
	$H–loSim¶e_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

49 
	`REDISMODULE_NOT_USED
(
¬gv
);

50 
	`REDISMODULE_NOT_USED
(
¬gc
);

51 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
	`RedisModuË_G‘S–eùedDb
(ctx));

52  
REDISMODULE_OK
;

53 
	}
}

61 
	$H–loPushN©ive_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
)

63 ià(
¬gc
 !ğ3è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

65 
RedisModuËKey
 *
key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

66 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

68 
	`RedisModuË_Li¡Push
(
key
,
REDISMODULE_LIST_TAIL
,
¬gv
[2]);

69 
size_t
 
ÃwËn
 = 
	`RedisModuË_V®ueL’gth
(
key
);

70 
	`RedisModuË_Clo£Key
(
key
);

71 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
ÃwËn
);

72  
REDISMODULE_OK
;

73 
	}
}

80 
	$H–loPushC®l_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
)

82 ià(
¬gc
 !ğ3è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

84 
RedisModuËC®lR•ly
 *
»¶y
;

86 
»¶y
 = 
	`RedisModuË_C®l
(
ùx
,"RPUSH","ss",
¬gv
[1],argv[2]);

87 
Ën
 = 
	`RedisModuË_C®lR•lyIÁeg”
(
»¶y
);

88 
	`RedisModuË_F»eC®lR•ly
(
»¶y
);

89 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
Ën
);

90  
REDISMODULE_OK
;

91 
	}
}

96 
	$H–loPushC®l2_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
)

98 ià(
¬gc
 !ğ3è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

100 
RedisModuËC®lR•ly
 *
»¶y
;

102 
»¶y
 = 
	`RedisModuË_C®l
(
ùx
,"RPUSH","ss",
¬gv
[1],argv[2]);

103 
	`RedisModuË_R•lyW™hC®lR•ly
(
ùx
,
»¶y
);

104 
	`RedisModuË_F»eC®lR•ly
(
»¶y
);

105  
REDISMODULE_OK
;

106 
	}
}

111 
	$H–loLi¡SumL’_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
)

113 ià(
¬gc
 !ğ2è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

115 
RedisModuËC®lR•ly
 *
»¶y
;

117 
»¶y
 = 
	`RedisModuË_C®l
(
ùx
,"LRANGE","¦l",
¬gv
[1],()0,()-1);

118 
size_t
 
¡¾’
 = 0;

119 
size_t
 
™ems
 = 
	`RedisModuË_C®lR•lyL’gth
(
»¶y
);

120 
size_t
 
j
;

121 
j
 = 0; j < 
™ems
; j++) {

122 
RedisModuËC®lR•ly
 *
–e
 = 
	`RedisModuË_C®lR•lyA¼ayEËm’t
(
»¶y
,
j
);

123 
¡¾’
 +ğ
	`RedisModuË_C®lR•lyL’gth
(
–e
);

125 
	`RedisModuË_F»eC®lR•ly
(
»¶y
);

126 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
¡¾’
);

127  
REDISMODULE_OK
;

128 
	}
}

134 
	$H–loLi¡S¶iû_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

135 ià(
¬gc
 !ğ4è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

137 
RedisModuËKey
 *
¤ckey
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

138 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

139 
RedisModuËKey
 *
d¡key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[2],

140 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

143 ià((
	`RedisModuË_KeyTy³
(
¤ckey
è!ğ
REDISMODULE_KEYTYPE_LIST
 &&

144 
	`RedisModuË_KeyTy³
(
¤ckey
è!ğ
REDISMODULE_KEYTYPE_EMPTY
) ||

145 (
	`RedisModuË_KeyTy³
(
d¡key
è!ğ
REDISMODULE_KEYTYPE_LIST
 &&

146 
	`RedisModuË_KeyTy³
(
d¡key
è!ğ
REDISMODULE_KEYTYPE_EMPTY
))

148 
	`RedisModuË_Clo£Key
(
¤ckey
);

149 
	`RedisModuË_Clo£Key
(
d¡key
);

150  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,
REDISMODULE_ERRORMSG_WRONGTYPE
);

153 
couÁ
;

154 ià((
	`RedisModuË_SŒšgToLÚgLÚg
(
¬gv
[3],&
couÁ
è!ğ
REDISMODULE_OK
) ||

155 (
couÁ
 < 0)) {

156 
	`RedisModuË_Clo£Key
(
¤ckey
);

157 
	`RedisModuË_Clo£Key
(
d¡key
);

158  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,"ERR invalid count");

161 
couÁ
-- > 0) {

162 
RedisModuËSŒšg
 *
–e
;

164 
–e
 = 
	`RedisModuË_Li¡Pİ
(
¤ckey
,
REDISMODULE_LIST_TAIL
);

165 ià(
–e
 =ğ
NULL
) ;

166 
	`RedisModuË_Li¡Push
(
d¡key
,
REDISMODULE_LIST_HEAD
,
–e
);

167 
	`RedisModuË_F»eSŒšg
(
ùx
,
–e
);

170 
size_t
 
Ën
 = 
	`RedisModuË_V®ueL’gth
(
¤ckey
);

171 
	`RedisModuË_Clo£Key
(
¤ckey
);

172 
	`RedisModuË_Clo£Key
(
d¡key
);

173 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
Ën
);

174  
REDISMODULE_OK
;

175 
	}
}

179 
	$H–loLi¡S¶iûAuto_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

180 ià(
¬gc
 !ğ4è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

182 
	`RedisModuË_AutoMemÜy
(
ùx
);

184 
RedisModuËKey
 *
¤ckey
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

185 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

186 
RedisModuËKey
 *
d¡key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[2],

187 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

190 ià((
	`RedisModuË_KeyTy³
(
¤ckey
è!ğ
REDISMODULE_KEYTYPE_LIST
 &&

191 
	`RedisModuË_KeyTy³
(
¤ckey
è!ğ
REDISMODULE_KEYTYPE_EMPTY
) ||

192 (
	`RedisModuË_KeyTy³
(
d¡key
è!ğ
REDISMODULE_KEYTYPE_LIST
 &&

193 
	`RedisModuË_KeyTy³
(
d¡key
è!ğ
REDISMODULE_KEYTYPE_EMPTY
))

195  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,
REDISMODULE_ERRORMSG_WRONGTYPE
);

198 
couÁ
;

199 ià((
	`RedisModuË_SŒšgToLÚgLÚg
(
¬gv
[3],&
couÁ
è!ğ
REDISMODULE_OK
) ||

200 (
couÁ
 < 0))

202  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,"ERR invalid count");

205 
couÁ
-- > 0) {

206 
RedisModuËSŒšg
 *
–e
;

208 
–e
 = 
	`RedisModuË_Li¡Pİ
(
¤ckey
,
REDISMODULE_LIST_TAIL
);

209 ià(
–e
 =ğ
NULL
) ;

210 
	`RedisModuË_Li¡Push
(
d¡key
,
REDISMODULE_LIST_HEAD
,
–e
);

213 
size_t
 
Ën
 = 
	`RedisModuË_V®ueL’gth
(
¤ckey
);

214 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
Ën
);

215  
REDISMODULE_OK
;

216 
	}
}

221 
	$H–loRªdA¼ay_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

222 ià(
¬gc
 !ğ2è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

223 
couÁ
;

224 ià(
	`RedisModuË_SŒšgToLÚgLÚg
(
¬gv
[1],&
couÁ
è!ğ
REDISMODULE_OK
 ||

225 
couÁ
 < 0)

226  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,"ERR invalid count");

231 
	`RedisModuË_R•lyW™hA¼ay
(
ùx
,
couÁ
);

232 
couÁ
--è
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
	`¿nd
());

233  
REDISMODULE_OK
;

234 
	}
}

240 
	$H–loR•l1_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
)

242 
	`REDISMODULE_NOT_USED
(
¬gv
);

243 
	`REDISMODULE_NOT_USED
(
¬gc
);

244 
	`RedisModuË_AutoMemÜy
(
ùx
);

256 
	`RedisModuË_R•liÿ‹
(
ùx
,"ECHO","c","foo");

260 
	`RedisModuË_C®l
(
ùx
,"INCR","c!","foo");

261 
	`RedisModuË_C®l
(
ùx
,"INCR","c!","bar");

263 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,0);

265  
REDISMODULE_OK
;

266 
	}
}

278 
	$H–loR•l2_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

279 ià(
¬gc
 !ğ2è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

281 
	`RedisModuË_AutoMemÜy
(
ùx
);

282 
RedisModuËKey
 *
key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

283 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

285 ià(
	`RedisModuË_KeyTy³
(
key
è!ğ
REDISMODULE_KEYTYPE_LIST
)

286  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,
REDISMODULE_ERRORMSG_WRONGTYPE
);

288 
size_t
 
li¡Ën
 = 
	`RedisModuË_V®ueL’gth
(
key
);

289 
sum
 = 0;

292 
li¡Ën
--) {

293 
RedisModuËSŒšg
 *
–e
 = 
	`RedisModuË_Li¡Pİ
(
key
,
REDISMODULE_LIST_TAIL
);

294 
v®
;

295 ià(
	`RedisModuË_SŒšgToLÚgLÚg
(
–e
,&
v®
è!ğ
REDISMODULE_OK
) val = 0;

296 
v®
++;

297 
sum
 +ğ
v®
;

298 
RedisModuËSŒšg
 *
Ãw–e
 = 
	`RedisModuË_C»©eSŒšgFromLÚgLÚg
(
ùx
,
v®
);

299 
	`RedisModuË_Li¡Push
(
key
,
REDISMODULE_LIST_HEAD
,
Ãw–e
);

301 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
sum
);

302 
	`RedisModuË_R•liÿ‹V”b©im
(
ùx
);

303  
REDISMODULE_OK
;

304 
	}
}

314 
	$H–loToggËCa£_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

315 ià(
¬gc
 !ğ2è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

317 
RedisModuËKey
 *
key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

318 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

320 
keyty³
 = 
	`RedisModuË_KeyTy³
(
key
);

321 ià(
keyty³
 !ğ
REDISMODULE_KEYTYPE_STRING
 &&

322 
keyty³
 !ğ
REDISMODULE_KEYTYPE_EMPTY
)

324 
	`RedisModuË_Clo£Key
(
key
);

325  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,
REDISMODULE_ERRORMSG_WRONGTYPE
);

328 ià(
keyty³
 =ğ
REDISMODULE_KEYTYPE_STRING
) {

329 
size_t
 
Ën
, 
j
;

330 *
s
 = 
	`RedisModuË_SŒšgDMA
(
key
,&
Ën
,
REDISMODULE_WRITE
);

331 
j
 = 0; j < 
Ën
; j++) {

332 ià(
	`isuµ”
(
s
[
j
])) {

333 
s
[
j
] = 
	`tŞow”
(s[j]);

335 
s
[
j
] = 
	`touµ”
(s[j]);

340 
	`RedisModuË_Clo£Key
(
key
);

341 
	`RedisModuË_R•lyW™hSim¶eSŒšg
(
ùx
,"OK");

342 
	`RedisModuË_R•liÿ‹V”b©im
(
ùx
);

343  
REDISMODULE_OK
;

344 
	}
}

350 
	$H–loMÜeExpœe_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

351 
	`RedisModuË_AutoMemÜy
(
ùx
);

352 ià(
¬gc
 !ğ3è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

354 
m¡ime_t
 
addms
, 
expœe
;

356 ià(
	`RedisModuË_SŒšgToLÚgLÚg
(
¬gv
[2],&
addms
è!ğ
REDISMODULE_OK
)

357  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,"ERR invalidƒxpireime");

359 
RedisModuËKey
 *
key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

360 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

361 
expœe
 = 
	`RedisModuË_G‘Expœe
(
key
);

362 ià(
expœe
 !ğ
REDISMODULE_NO_EXPIRE
) {

363 
expœe
 +ğ
addms
;

364 
	`RedisModuË_S‘Expœe
(
key
,
expœe
);

366  
	`RedisModuË_R•lyW™hSim¶eSŒšg
(
ùx
,"OK");

367 
	}
}

375 
	$H–loZsumRªge_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

376 
scÜe_¡¬t
, 
scÜe_’d
;

377 ià(
¬gc
 !ğ4è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

379 ià(
	`RedisModuË_SŒšgToDoubË
(
¬gv
[2],&
scÜe_¡¬t
è!ğ
REDISMODULE_OK
 ||

380 
	`RedisModuË_SŒšgToDoubË
(
¬gv
[3],&
scÜe_’d
è!ğ
REDISMODULE_OK
)

382  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,"ERR invalid„ange");

385 
RedisModuËKey
 *
key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

386 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

387 ià(
	`RedisModuË_KeyTy³
(
key
è!ğ
REDISMODULE_KEYTYPE_ZSET
) {

388  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,
REDISMODULE_ERRORMSG_WRONGTYPE
);

391 
scÜesum_a
 = 0;

392 
scÜesum_b
 = 0;

394 
	`RedisModuË_Z£tFœ¡InScÜeRªge
(
key
,
scÜe_¡¬t
,
scÜe_’d
,0,0);

395 !
	`RedisModuË_Z£tRªgeEndR—ched
(
key
)) {

396 
scÜe
;

397 
RedisModuËSŒšg
 *
–e
 = 
	`RedisModuË_Z£tRªgeCu¼’tEËm’t
(
key
,&
scÜe
);

398 
	`RedisModuË_F»eSŒšg
(
ùx
,
–e
);

399 
scÜesum_a
 +ğ
scÜe
;

400 
	`RedisModuË_Z£tRªgeNext
(
key
);

402 
	`RedisModuË_Z£tRªgeStİ
(
key
);

404 
	`RedisModuË_Z£tLa¡InScÜeRªge
(
key
,
scÜe_¡¬t
,
scÜe_’d
,0,0);

405 !
	`RedisModuË_Z£tRªgeEndR—ched
(
key
)) {

406 
scÜe
;

407 
RedisModuËSŒšg
 *
–e
 = 
	`RedisModuË_Z£tRªgeCu¼’tEËm’t
(
key
,&
scÜe
);

408 
	`RedisModuË_F»eSŒšg
(
ùx
,
–e
);

409 
scÜesum_b
 +ğ
scÜe
;

410 
	`RedisModuË_Z£tRªgeP»v
(
key
);

413 
	`RedisModuË_Z£tRªgeStİ
(
key
);

415 
	`RedisModuË_Clo£Key
(
key
);

417 
	`RedisModuË_R•lyW™hA¼ay
(
ùx
,2);

418 
	`RedisModuË_R•lyW™hDoubË
(
ùx
,
scÜesum_a
);

419 
	`RedisModuË_R•lyW™hDoubË
(
ùx
,
scÜesum_b
);

420  
REDISMODULE_OK
;

421 
	}
}

430 
	$H–loLexRªge_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

431 
	`RedisModuË_AutoMemÜy
(
ùx
);

433 ià(
¬gc
 !ğ6è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

435 
RedisModuËKey
 *
key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

436 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

437 ià(
	`RedisModuË_KeyTy³
(
key
è!ğ
REDISMODULE_KEYTYPE_ZSET
) {

438  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,
REDISMODULE_ERRORMSG_WRONGTYPE
);

441 ià(
	`RedisModuË_Z£tFœ¡InLexRªge
(
key
,
¬gv
[2],¬gv[3]è!ğ
REDISMODULE_OK
) {

442  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,"invalid„ange");

445 
¬¿yËn
 = 0;

446 
	`RedisModuË_R•lyW™hA¼ay
(
ùx
,
REDISMODULE_POSTPONED_ARRAY_LEN
);

447 !
	`RedisModuË_Z£tRªgeEndR—ched
(
key
)) {

448 
scÜe
;

449 
RedisModuËSŒšg
 *
–e
 = 
	`RedisModuË_Z£tRªgeCu¼’tEËm’t
(
key
,&
scÜe
);

450 
	`RedisModuË_R•lyW™hSŒšg
(
ùx
,
–e
);

451 
	`RedisModuË_F»eSŒšg
(
ùx
,
–e
);

452 
	`RedisModuË_Z£tRªgeNext
(
key
);

453 
¬¿yËn
++;

455 
	`RedisModuË_Z£tRªgeStİ
(
key
);

456 
	`RedisModuË_R•lyS‘A¼ayL’gth
(
ùx
,
¬¿yËn
);

457 
	`RedisModuË_Clo£Key
(
key
);

458  
REDISMODULE_OK
;

459 
	}
}

468 
	$H–loHCİy_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

469 
	`RedisModuË_AutoMemÜy
(
ùx
);

471 ià(
¬gc
 !ğ4è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

472 
RedisModuËKey
 *
key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

473 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

474 
ty³
 = 
	`RedisModuË_KeyTy³
(
key
);

475 ià(
ty³
 !ğ
REDISMODULE_KEYTYPE_HASH
 &&

476 
ty³
 !ğ
REDISMODULE_KEYTYPE_EMPTY
)

478  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,
REDISMODULE_ERRORMSG_WRONGTYPE
);

482 
RedisModuËSŒšg
 *
Şdv®
;

483 
	`RedisModuË_HashG‘
(
key
,
REDISMODULE_HASH_NONE
,
¬gv
[2],&
Şdv®
,
NULL
);

484 ià(
Şdv®
) {

485 
	`RedisModuË_HashS‘
(
key
,
REDISMODULE_HASH_NONE
,
¬gv
[3],
Şdv®
,
NULL
);

487 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
Şdv®
 !ğ
NULL
);

488  
REDISMODULE_OK
;

489 
	}
}

509 
	$H–loLeáPad_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

510 
	`RedisModuË_AutoMemÜy
(
ùx
);

511 
·dËn
;

513 ià(
¬gc
 !ğ4è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

515 ià((
	`RedisModuË_SŒšgToLÚgLÚg
(
¬gv
[2],&
·dËn
è!ğ
REDISMODULE_OK
) ||

516 (
·dËn
< 0)) {

517  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,"ERR invalid…adding†ength");

519 
size_t
 
¡¾’
, 
chËn
;

520 cÚ¡ *
¡r
 = 
	`RedisModuË_SŒšgPŒL’
(
¬gv
[1], &
¡¾’
);

521 cÚ¡ *
ch
 = 
	`RedisModuË_SŒšgPŒL’
(
¬gv
[3], &
chËn
);

525 ià(
¡¾’
 >ğ(
size_t
)
·dËn
)

526  
	`RedisModuË_R•lyW™hSŒšg
(
ùx
,
¬gv
[1]);

529 ià(
chËn
 != 1)

530  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,

534 
·dËn
 -ğ
¡¾’
;

535 *
buf
 = 
	`RedisModuË_PoŞAÎoc
(
ùx
,
·dËn
+
¡¾’
);

536 
j
 = 0; j < 
·dËn
; j++è
buf
[j] = *
ch
;

537 
	`memıy
(
buf
+
·dËn
,
¡r
,
¡¾’
);

539 
	`RedisModuË_R•lyW™hSŒšgBufãr
(
ùx
,
buf
,
·dËn
+
¡¾’
);

540  
REDISMODULE_OK
;

541 
	}
}

545 
	$RedisModuË_OnLßd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

546 ià(
	`RedisModuË_In™
(
ùx
,"h–lowÜld",1,
REDISMODULE_APIVER_1
)

547 =ğ
REDISMODULE_ERR
)  REDISMODULE_ERR;

550 
j
 = 0; j < 
¬gc
; j++) {

551 cÚ¡ *
s
 = 
	`RedisModuË_SŒšgPŒL’
(
¬gv
[
j
],
NULL
);

552 
	`´štf
("ModuË†ßded w™h ARGV[%d] = %s\n", 
j
, 
s
);

555 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.simple",

556 
H–loSim¶e_RedisCommªd
,"»adÚly",0,0,0è=ğ
REDISMODULE_ERR
)

557  
REDISMODULE_ERR
;

559 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.push.native",

560 
H–loPushN©ive_RedisCommªd
,"wr™d’y-oom",1,1,1è=ğ
REDISMODULE_ERR
)

561  
REDISMODULE_ERR
;

563 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.push.call",

564 
H–loPushC®l_RedisCommªd
,"wr™d’y-oom",1,1,1è=ğ
REDISMODULE_ERR
)

565  
REDISMODULE_ERR
;

567 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.push.call2",

568 
H–loPushC®l2_RedisCommªd
,"wr™d’y-oom",1,1,1è=ğ
REDISMODULE_ERR
)

569  
REDISMODULE_ERR
;

571 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.list.sum.len",

572 
H–loLi¡SumL’_RedisCommªd
,"»adÚly",1,1,1è=ğ
REDISMODULE_ERR
)

573  
REDISMODULE_ERR
;

575 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.list.splice",

576 
H–loLi¡S¶iû_RedisCommªd
,"wr™d’y-oom",1,2,1è=ğ
REDISMODULE_ERR
)

577  
REDISMODULE_ERR
;

579 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.list.splice.auto",

580 
H–loLi¡S¶iûAuto_RedisCommªd
,

581 "wr™d’y-oom",1,2,1è=ğ
REDISMODULE_ERR
)

582  
REDISMODULE_ERR
;

584 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.rand.array",

585 
H–loRªdA¼ay_RedisCommªd
,"»adÚly",0,0,0è=ğ
REDISMODULE_ERR
)

586  
REDISMODULE_ERR
;

588 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.repl1",

589 
H–loR•l1_RedisCommªd
,"wr™e",0,0,0è=ğ
REDISMODULE_ERR
)

590  
REDISMODULE_ERR
;

592 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.repl2",

593 
H–loR•l2_RedisCommªd
,"wr™e",1,1,1è=ğ
REDISMODULE_ERR
)

594  
REDISMODULE_ERR
;

596 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.toggle.case",

597 
H–loToggËCa£_RedisCommªd
,"wr™e",1,1,1è=ğ
REDISMODULE_ERR
)

598  
REDISMODULE_ERR
;

600 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.more.expire",

601 
H–loMÜeExpœe_RedisCommªd
,"wr™e",1,1,1è=ğ
REDISMODULE_ERR
)

602  
REDISMODULE_ERR
;

604 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.zsumrange",

605 
H–loZsumRªge_RedisCommªd
,"»adÚly",1,1,1è=ğ
REDISMODULE_ERR
)

606  
REDISMODULE_ERR
;

608 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.lexrange",

609 
H–loLexRªge_RedisCommªd
,"»adÚly",1,1,1è=ğ
REDISMODULE_ERR
)

610  
REDISMODULE_ERR
;

612 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.hcopy",

613 
H–loHCİy_RedisCommªd
,"wr™d’y-oom",1,1,1è=ğ
REDISMODULE_ERR
)

614  
REDISMODULE_ERR
;

616 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.leftpad",

617 
H–loLeáPad_RedisCommªd
,"",1,1,1è=ğ
REDISMODULE_ERR
)

618  
REDISMODULE_ERR
;

620  
REDISMODULE_OK
;

621 
	}
}

	@modules/testmodule.c

33 
	~"../»dismoduË.h
"

34 
	~<¡ršg.h
>

39 
	$Te¡M©chR•ly
(
RedisModuËC®lR•ly
 *
»¶y
, *
¡r
) {

40 
RedisModuËSŒšg
 *
my¡r
;

41 
my¡r
 = 
	`RedisModuË_C»©eSŒšgFromC®lR•ly
(
»¶y
);

42 ià(!
my¡r
)  0;

43 cÚ¡ *
±r
 = 
	`RedisModuË_SŒšgPŒL’
(
my¡r
,
NULL
);

44  
	`¡rcmp
(
±r
,
¡r
) == 0;

45 
	}
}

50 
	$Te¡C®l
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

51 
	`REDISMODULE_NOT_USED
(
¬gv
);

52 
	`REDISMODULE_NOT_USED
(
¬gc
);

54 
	`RedisModuË_AutoMemÜy
(
ùx
);

55 
RedisModuËC®lR•ly
 *
»¶y
;

57 
	`RedisModuË_C®l
(
ùx
,"DEL","c","mylist");

58 
RedisModuËSŒšg
 *
my¡r
 = 
	`RedisModuË_C»©eSŒšg
(
ùx
,"foo",3);

59 
	`RedisModuË_C®l
(
ùx
,"RPUSH","c¦","myli¡",
my¡r
,()1234);

60 
»¶y
 = 
	`RedisModuË_C®l
(
ùx
,"LRANGE","ccc","mylist","0","-1");

61 
™ems
 = 
	`RedisModuË_C®lR•lyL’gth
(
»¶y
);

62 ià(
™ems
 !ğ2è
ç
;

64 
RedisModuËC®lR•ly
 *
™em0
, *
™em1
;

66 
™em0
 = 
	`RedisModuË_C®lR•lyA¼ayEËm’t
(
»¶y
,0);

67 
™em1
 = 
	`RedisModuË_C®lR•lyA¼ayEËm’t
(
»¶y
,1);

68 ià(!
	`Te¡M©chR•ly
(
™em0
,"foo")è
ç
;

69 ià(!
	`Te¡M©chR•ly
(
™em1
,"1234")è
ç
;

71 
	`RedisModuË_R•lyW™hSim¶eSŒšg
(
ùx
,"OK");

72  
REDISMODULE_OK
;

74 
ç
:

75 
	`RedisModuË_R•lyW™hSim¶eSŒšg
(
ùx
,"ERR");

76  
REDISMODULE_OK
;

77 
	}
}

80 
	$Te¡SŒšgAµ’d
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

81 
	`REDISMODULE_NOT_USED
(
¬gv
);

82 
	`REDISMODULE_NOT_USED
(
¬gc
);

84 
RedisModuËSŒšg
 *
s
 = 
	`RedisModuË_C»©eSŒšg
(
ùx
,"foo",3);

85 
	`RedisModuË_SŒšgAµ’dBufãr
(
ùx
,
s
,"bar",3);

86 
	`RedisModuË_R•lyW™hSŒšg
(
ùx
,
s
);

87 
	`RedisModuË_F»eSŒšg
(
ùx
,
s
);

88  
REDISMODULE_OK
;

89 
	}
}

92 
	$Te¡SŒšgAµ’dAM
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

93 
	`REDISMODULE_NOT_USED
(
¬gv
);

94 
	`REDISMODULE_NOT_USED
(
¬gc
);

96 
	`RedisModuË_AutoMemÜy
(
ùx
);

97 
RedisModuËSŒšg
 *
s
 = 
	`RedisModuË_C»©eSŒšg
(
ùx
,"foo",3);

98 
	`RedisModuË_R‘ašSŒšg
(
ùx
,
s
);

99 
	`RedisModuË_SŒšgAµ’dBufãr
(
ùx
,
s
,"bar",3);

100 
	`RedisModuË_R•lyW™hSŒšg
(
ùx
,
s
);

101 
	`RedisModuË_F»eSŒšg
(
ùx
,
s
);

102  
REDISMODULE_OK
;

103 
	}
}

106 
	$Te¡SŒšgPrštf
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

107 
	`RedisModuË_AutoMemÜy
(
ùx
);

108 ià(
¬gc
 < 3) {

109  
	`RedisModuË_WrÚgAr™y
(
ùx
);

111 
RedisModuËSŒšg
 *
s
 = 
	`RedisModuË_C»©eSŒšgPrštf
(
ùx
,

113 
¬gc
,

114 
	`RedisModuË_SŒšgPŒL’
(
¬gv
[1], 
NULL
),

115 
	`RedisModuË_SŒšgPŒL’
(
¬gv
[2], 
NULL
)

118 
	`RedisModuË_R•lyW™hSŒšg
(
ùx
,
s
);

120  
REDISMODULE_OK
;

121 
	}
}

128 
	$Te¡As£¹SŒšgR•ly
(
RedisModuËCtx
 *
ùx
, 
RedisModuËC®lR•ly
 *
»¶y
, *
¡r
, 
size_t
 
Ën
) {

129 
RedisModuËSŒšg
 *
my¡r
, *
ex³ùed
;

131 ià(
	`RedisModuË_C®lR•lyTy³
(
»¶y
è!ğ
REDISMODULE_REPLY_STRING
) {

132 
	`RedisModuË_Log
(
ùx
,"warning","Unexpected„eplyype %d",

133 
	`RedisModuË_C®lR•lyTy³
(
»¶y
));

136 
my¡r
 = 
	`RedisModuË_C»©eSŒšgFromC®lR•ly
(
»¶y
);

137 
ex³ùed
 = 
	`RedisModuË_C»©eSŒšg
(
ùx
,
¡r
,
Ën
);

138 ià(
	`RedisModuË_SŒšgCom·»
(
my¡r
,
ex³ùed
) != 0) {

139 cÚ¡ *
my¡r_±r
 = 
	`RedisModuË_SŒšgPŒL’
(
my¡r
,
NULL
);

140 cÚ¡ *
ex³ùed_±r
 = 
	`RedisModuË_SŒšgPŒL’
(
ex³ùed
,
NULL
);

141 
	`RedisModuË_Log
(
ùx
,"warning",

143 
my¡r_±r
, 
ex³ùed_±r
);

147 
	}
}

151 
	$Te¡As£¹IÁeg”R•ly
(
RedisModuËCtx
 *
ùx
, 
RedisModuËC®lR•ly
 *
»¶y
, 
ex³ùed
) {

152 ià(
	`RedisModuË_C®lR•lyTy³
(
»¶y
è!ğ
REDISMODULE_REPLY_INTEGER
) {

153 
	`RedisModuË_Log
(
ùx
,"warning","Unexpected„eplyype %d",

154 
	`RedisModuË_C®lR•lyTy³
(
»¶y
));

157 
v®
 = 
	`RedisModuË_C®lR•lyIÁeg”
(
»¶y
);

158 ià(
v®
 !ğ
ex³ùed
) {

159 
	`RedisModuË_Log
(
ùx
,"warning",

161 
v®
, 
ex³ùed
);

165 
	}
}

167 
	#T
(
Çme
,...) \

169 
	`RedisModuË_Log
(
ùx
,"w¬nšg","Te¡šg %s", 
Çme
); \

170 
»¶y
 = 
	`RedisModuË_C®l
(
ùx
,
Çme
,
__VA_ARGS__
); \

171 } 0);

	)

174 
	$Te¡It
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

175 
	`REDISMODULE_NOT_USED
(
¬gv
);

176 
	`REDISMODULE_NOT_USED
(
¬gc
);

178 
	`RedisModuË_AutoMemÜy
(
ùx
);

179 
RedisModuËC®lR•ly
 *
»¶y
;

182 
	`T
("dbsize","");

183 ià(!
	`Te¡As£¹IÁeg”R•ly
(
ùx
,
»¶y
,0)è
ç
;

185 
	`T
("ping","");

186 ià(!
	`Te¡As£¹SŒšgR•ly
(
ùx
,
»¶y
,"PONG",4)è
ç
;

188 
	`T
("test.call","");

189 ià(!
	`Te¡As£¹SŒšgR•ly
(
ùx
,
»¶y
,"OK",2)è
ç
;

191 
	`T
("test.string.append","");

192 ià(!
	`Te¡As£¹SŒšgR•ly
(
ùx
,
»¶y
,"foob¬",6)è
ç
;

194 
	`T
("test.string.append.am","");

195 ià(!
	`Te¡As£¹SŒšgR•ly
(
ùx
,
»¶y
,"foob¬",6)è
ç
;

197 
	`T
("test.string.printf", "cc", "foo", "bar");

198 ià(!
	`Te¡As£¹SŒšgR•ly
(
ùx
,
»¶y
,"GÙ 3‡rgs.‡rgv[1]: foo,‡rgv[2]: b¬",38)è
ç
;

200 
	`RedisModuË_R•lyW™hSim¶eSŒšg
(
ùx
,"ALL TESTS PASSED");

201  
REDISMODULE_OK
;

203 
ç
:

204 
	`RedisModuË_R•lyW™hSim¶eSŒšg
(
ùx
,

206  
REDISMODULE_OK
;

207 
	}
}

209 
	$RedisModuË_OnLßd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

210 
	`REDISMODULE_NOT_USED
(
¬gv
);

211 
	`REDISMODULE_NOT_USED
(
¬gc
);

213 ià(
	`RedisModuË_In™
(
ùx
,"‹¡",1,
REDISMODULE_APIVER_1
)

214 =ğ
REDISMODULE_ERR
)  REDISMODULE_ERR;

216 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"test.call",

217 
Te¡C®l
,"wr™d’y-oom",1,1,1è=ğ
REDISMODULE_ERR
)

218  
REDISMODULE_ERR
;

220 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"test.string.append",

221 
Te¡SŒšgAµ’d
,"wr™d’y-oom",1,1,1è=ğ
REDISMODULE_ERR
)

222  
REDISMODULE_ERR
;

224 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"test.string.append.am",

225 
Te¡SŒšgAµ’dAM
,"wr™d’y-oom",1,1,1è=ğ
REDISMODULE_ERR
)

226  
REDISMODULE_ERR
;

228 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"test.string.printf",

229 
Te¡SŒšgPrštf
,"wr™d’y-oom",1,1,1è=ğ
REDISMODULE_ERR
)

230  
REDISMODULE_ERR
;

232 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"test.it",

233 
Te¡It
,"»adÚly",1,1,1è=ğ
REDISMODULE_ERR
)

234  
REDISMODULE_ERR
;

236  
REDISMODULE_OK
;

237 
	}
}

	@multi.c

30 
	~"£rv”.h
"

35 
	$š™Cl›ÁMuÉiS‹
(
ş›Á
 *
c
) {

36 
c
->
m¡©e
.
commªds
 = 
NULL
;

37 
c
->
m¡©e
.
couÁ
 = 0;

38 
	}
}

41 
	$ä“Cl›ÁMuÉiS‹
(
ş›Á
 *
c
) {

42 
j
;

44 
j
 = 0; j < 
c
->
m¡©e
.
couÁ
; j++) {

45 
i
;

46 
muÉiCmd
 *
mc
 = 
c
->
m¡©e
.
commªds
+
j
;

48 
i
 = 0; i < 
mc
->
¬gc
; i++)

49 
	`deüRefCouÁ
(
mc
->
¬gv
[
i
]);

50 
	`zä“
(
mc
->
¬gv
);

52 
	`zä“
(
c
->
m¡©e
.
commªds
);

53 
	}
}

56 
	$queueMuÉiCommªd
(
ş›Á
 *
c
) {

57 
muÉiCmd
 *
mc
;

58 
j
;

60 
c
->
m¡©e
.
commªds
 = 
	`z»®loc
(c->mstate.commands,

61 (
muÉiCmd
)*(
c
->
m¡©e
.
couÁ
+1));

62 
mc
 = 
c
->
m¡©e
.
commªds
+c->m¡©e.
couÁ
;

63 
mc
->
cmd
 = 
c
->cmd;

64 
mc
->
¬gc
 = 
c
->argc;

65 
mc
->
¬gv
 = 
	`zm®loc
((
robj
*)*
c
->
¬gc
);

66 
	`memıy
(
mc
->
¬gv
,
c
->¬gv,(
robj
*)*c->
¬gc
);

67 
j
 = 0; j < 
c
->
¬gc
; j++)

68 
	`šüRefCouÁ
(
mc
->
¬gv
[
j
]);

69 
c
->
m¡©e
.
couÁ
++;

70 
	}
}

72 
	$disÿrdT¿n§ùiÚ
(
ş›Á
 *
c
) {

73 
	`ä“Cl›ÁMuÉiS‹
(
c
);

74 
	`š™Cl›ÁMuÉiS‹
(
c
);

75 
c
->
æags
 &ğ~(
CLIENT_MULTI
|
CLIENT_DIRTY_CAS
|
CLIENT_DIRTY_EXEC
);

76 
	`unw©chAÎKeys
(
c
);

77 
	}
}

81 
	$æagT¿n§ùiÚ
(
ş›Á
 *
c
) {

82 ià(
c
->
æags
 & 
CLIENT_MULTI
)

83 
c
->
æags
 |ğ
CLIENT_DIRTY_EXEC
;

84 
	}
}

86 
	$muÉiCommªd
(
ş›Á
 *
c
) {

87 ià(
c
->
æags
 & 
CLIENT_MULTI
) {

88 
	`addR•lyE¼Ü
(
c
,"MULTI calls can‚ot be‚ested");

91 
c
->
æags
 |ğ
CLIENT_MULTI
;

92 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

93 
	}
}

95 
	$disÿrdCommªd
(
ş›Á
 *
c
) {

96 ià(!(
c
->
æags
 & 
CLIENT_MULTI
)) {

97 
	`addR•lyE¼Ü
(
c
,"DISCARD without MULTI");

100 
	`disÿrdT¿n§ùiÚ
(
c
);

101 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

102 
	}
}

106 
	$execCommªdPrİag©eMuÉi
(
ş›Á
 *
c
) {

107 
robj
 *
muÉi¡ršg
 = 
	`ü—‹SŒšgObjeù
("MULTI",5);

109 
	`´İag©e
(
£rv”
.
muÉiCommªd
,
c
->
db
->
id
,&
muÉi¡ršg
,1,

110 
PROPAGATE_AOF
|
PROPAGATE_REPL
);

111 
	`deüRefCouÁ
(
muÉi¡ršg
);

112 
	}
}

114 
	$execCommªd
(
ş›Á
 *
c
) {

115 
j
;

116 
robj
 **
Üig_¬gv
;

117 
Üig_¬gc
;

118 
»disCommªd
 *
Üig_cmd
;

119 
mu¡_´İag©e
 = 0;

120 
was_ma¡”
 = 
£rv”
.
ma¡”ho¡
 =ğ
NULL
;

122 ià(!(
c
->
æags
 & 
CLIENT_MULTI
)) {

123 
	`addR•lyE¼Ü
(
c
,"EXEC without MULTI");

133 ià(
c
->
æags
 & (
CLIENT_DIRTY_CAS
|
CLIENT_DIRTY_EXEC
)) {

134 
	`addR•ly
(
c
, c->
æags
 & 
CLIENT_DIRTY_EXEC
 ? 
sh¬ed
.
exeÿbÜ‹¼
 :

135 
sh¬ed
.
nuÎmuÉibulk
);

136 
	`disÿrdT¿n§ùiÚ
(
c
);

137 
hªdË_mÚ™Ü
;

141 
	`unw©chAÎKeys
(
c
);

142 
Üig_¬gv
 = 
c
->
¬gv
;

143 
Üig_¬gc
 = 
c
->
¬gc
;

144 
Üig_cmd
 = 
c
->
cmd
;

145 
	`addR•lyMuÉiBulkL’
(
c
,c->
m¡©e
.
couÁ
);

146 
j
 = 0; j < 
c
->
m¡©e
.
couÁ
; j++) {

147 
c
->
¬gc
 = c->
m¡©e
.
commªds
[
j
].argc;

148 
c
->
¬gv
 = c->
m¡©e
.
commªds
[
j
].argv;

149 
c
->
cmd
 = c->
m¡©e
.
commªds
[
j
].cmd;

156 ià(!
mu¡_´İag©e
 && !(
c
->
cmd
->
æags
 & (
CMD_READONLY
|
CMD_ADMIN
))) {

157 
	`execCommªdPrİag©eMuÉi
(
c
);

158 
mu¡_´İag©e
 = 1;

161 
	`ÿÎ
(
c
,
CMD_CALL_FULL
);

164 
c
->
m¡©e
.
commªds
[
j
].
¬gc
 = c->argc;

165 
c
->
m¡©e
.
commªds
[
j
].
¬gv
 = c->argv;

166 
c
->
m¡©e
.
commªds
[
j
].
cmd
 = c->cmd;

168 
c
->
¬gv
 = 
Üig_¬gv
;

169 
c
->
¬gc
 = 
Üig_¬gc
;

170 
c
->
cmd
 = 
Üig_cmd
;

171 
	`disÿrdT¿n§ùiÚ
(
c
);

175 ià(
mu¡_´İag©e
) {

176 
is_ma¡”
 = 
£rv”
.
ma¡”ho¡
 =ğ
NULL
;

177 
£rv”
.
dœty
++;

183 ià(
£rv”
.
»¶_backlog
 && 
was_ma¡”
 && !
is_ma¡”
) {

184 *
execcmd
 = "*1\r\n$4\r\nEXEC\r\n";

185 
	`ãedR•liÿtiÚBacklog
(
execcmd
,
	`¡¾’
(execcmd));

189 
hªdË_mÚ™Ü
:

195 ià(
	`li¡L’gth
(
£rv”
.
mÚ™Üs
è&& !£rv”.
lßdšg
)

196 
	`»¶iÿtiÚF“dMÚ™Üs
(
c
,
£rv”
.
mÚ™Üs
,c->
db
->
id
,c->
¬gv
,c->
¬gc
);

197 
	}
}

211 
	sw©chedKey
 {

212 
robj
 *
	mkey
;

213 
»disDb
 *
	mdb
;

214 } 
	tw©chedKey
;

217 
	$w©chFÜKey
(
ş›Á
 *
c
, 
robj
 *
key
) {

218 
li¡
 *
ş›Ás
 = 
NULL
;

219 
li¡I‹r
 
li
;

220 
li¡Node
 *
Ê
;

221 
w©chedKey
 *
wk
;

224 
	`li¡Rewšd
(
c
->
w©ched_keys
,&
li
);

225 (
Ê
 = 
	`li¡Next
(&
li
))) {

226 
wk
 = 
	`li¡NodeV®ue
(
Ê
);

227 ià(
wk
->
db
 =ğ
c
->db && 
	`equ®SŒšgObjeùs
(
key
,wk->key))

231 
ş›Ás
 = 
	`diùF‘chV®ue
(
c
->
db
->
w©ched_keys
,
key
);

232 ià(!
ş›Ás
) {

233 
ş›Ás
 = 
	`li¡C»©e
();

234 
	`diùAdd
(
c
->
db
->
w©ched_keys
,
key
,
ş›Ás
);

235 
	`šüRefCouÁ
(
key
);

237 
	`li¡AddNodeTa
(
ş›Ás
,
c
);

239 
wk
 = 
	`zm®loc
((*wk));

240 
wk
->
key
 = key;

241 
wk
->
db
 = 
c
->db;

242 
	`šüRefCouÁ
(
key
);

243 
	`li¡AddNodeTa
(
c
->
w©ched_keys
,
wk
);

244 
	}
}

248 
	$unw©chAÎKeys
(
ş›Á
 *
c
) {

249 
li¡I‹r
 
li
;

250 
li¡Node
 *
Ê
;

252 ià(
	`li¡L’gth
(
c
->
w©ched_keys
) == 0) ;

253 
	`li¡Rewšd
(
c
->
w©ched_keys
,&
li
);

254 (
Ê
 = 
	`li¡Next
(&
li
))) {

255 
li¡
 *
ş›Ás
;

256 
w©chedKey
 *
wk
;

260 
wk
 = 
	`li¡NodeV®ue
(
Ê
);

261 
ş›Ás
 = 
	`diùF‘chV®ue
(
wk
->
db
->
w©ched_keys
, wk->
key
);

262 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
ş›Ás
 != NULL);

263 
	`li¡D–Node
(
ş›Ás
,
	`li¡S—rchKey
(ş›Ás,
c
));

265 ià(
	`li¡L’gth
(
ş›Ás
) == 0)

266 
	`diùD–‘e
(
wk
->
db
->
w©ched_keys
, wk->
key
);

268 
	`li¡D–Node
(
c
->
w©ched_keys
,
Ê
);

269 
	`deüRefCouÁ
(
wk
->
key
);

270 
	`zä“
(
wk
);

272 
	}
}

276 
	$touchW©chedKey
(
»disDb
 *
db
, 
robj
 *
key
) {

277 
li¡
 *
ş›Ás
;

278 
li¡I‹r
 
li
;

279 
li¡Node
 *
Ê
;

281 ià(
	`diùSize
(
db
->
w©ched_keys
) == 0) ;

282 
ş›Ás
 = 
	`diùF‘chV®ue
(
db
->
w©ched_keys
, 
key
);

283 ià(!
ş›Ás
) ;

287 
	`li¡Rewšd
(
ş›Ás
,&
li
);

288 (
Ê
 = 
	`li¡Next
(&
li
))) {

289 
ş›Á
 *
c
 = 
	`li¡NodeV®ue
(
Ê
);

291 
c
->
æags
 |ğ
CLIENT_DIRTY_CAS
;

293 
	}
}

299 
	$touchW©chedKeysOnFlush
(
dbid
) {

300 
li¡I‹r
 
li1
, 
li2
;

301 
li¡Node
 *
Ê
;

304 
	`li¡Rewšd
(
£rv”
.
ş›Ás
,&
li1
);

305 (
Ê
 = 
	`li¡Next
(&
li1
))) {

306 
ş›Á
 *
c
 = 
	`li¡NodeV®ue
(
Ê
);

307 
	`li¡Rewšd
(
c
->
w©ched_keys
,&
li2
);

308 (
Ê
 = 
	`li¡Next
(&
li2
))) {

309 
w©chedKey
 *
wk
 = 
	`li¡NodeV®ue
(
Ê
);

314 ià(
dbid
 =ğ-1 || 
wk
->
db
->
id
 == dbid) {

315 ià(
	`diùFšd
(
wk
->
db
->
diù
, wk->
key
->
±r
è!ğ
NULL
)

316 
c
->
æags
 |ğ
CLIENT_DIRTY_CAS
;

320 
	}
}

322 
	$w©chCommªd
(
ş›Á
 *
c
) {

323 
j
;

325 ià(
c
->
æags
 & 
CLIENT_MULTI
) {

326 
	`addR•lyE¼Ü
(
c
,"WATCH inside MULTI is‚ot‡llowed");

329 
j
 = 1; j < 
c
->
¬gc
; j++)

330 
	`w©chFÜKey
(
c
,c->
¬gv
[
j
]);

331 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

332 
	}
}

334 
	$unw©chCommªd
(
ş›Á
 *
c
) {

335 
	`unw©chAÎKeys
(
c
);

336 
c
->
æags
 &ğ(~
CLIENT_DIRTY_CAS
);

337 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

338 
	}
}

	@networking.c

30 
	~"£rv”.h
"

31 
	~"©omicv¬.h
"

32 
	~<sys/uio.h
>

33 
	~<m©h.h
>

34 
	~<ùy³.h
>

36 
£tPrÙocŞE¼Ü
(cÚ¡ *
”r¡r
, 
ş›Á
 *
c
, 
pos
);

41 
size_t
 
	$sdsZm®locSize
(
sds
 
s
) {

42 *
sh
 = 
	`sdsAÎocPŒ
(
s
);

43  
	`zm®loc_size
(
sh
);

44 
	}
}

48 
size_t
 
	$g‘SŒšgObjeùSdsU£dMemÜy
(
robj
 *
o
) {

49 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

50 
o
->
’codšg
) {

51 
OBJ_ENCODING_RAW
:  
	`sdsZm®locSize
(
o
->
±r
);

52 
OBJ_ENCODING_EMBSTR
:  
	`zm®loc_size
(
o
)-(
robj
);

55 
	}
}

58 *
	$dupCl›ÁR•lyV®ue
(*
o
) {

59  
	`sdsdup
(
o
);

60 
	}
}

62 
	$ä“Cl›ÁR•lyV®ue
(*
o
) {

63 
	`sdsä“
(
o
);

64 
	}
}

66 
	$li¡M©chObjeùs
(*
a
, *
b
) {

67  
	`equ®SŒšgObjeùs
(
a
,
b
);

68 
	}
}

70 
ş›Á
 *
	$ü—‹Cl›Á
(
fd
) {

71 
ş›Á
 *
c
 = 
	`zm®loc
((client));

77 ià(
fd
 != -1) {

78 
	`ª‘NÚBlock
(
NULL
,
fd
);

79 
	`ª‘EÇbËTıNoD–ay
(
NULL
,
fd
);

80 ià(
£rv”
.
tık“·live
)

81 
	`ª‘K“pAlive
(
NULL
,
fd
,
£rv”
.
tık“·live
);

82 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
,
fd
,
AE_READABLE
,

83 
»adQu”yFromCl›Á
, 
c
è=ğ
AE_ERR
)

85 
	`şo£
(
fd
);

86 
	`zä“
(
c
);

87  
NULL
;

91 
	`£ËùDb
(
c
,0);

92 
ušt64_t
 
ş›Á_id
;

93 
	`©omicG‘Inü
(
£rv”
.
Ãxt_ş›Á_id
,
ş›Á_id
,1);

94 
c
->
id
 = 
ş›Á_id
;

95 
c
->
fd
 = fd;

96 
c
->
Çme
 = 
NULL
;

97 
c
->
buåos
 = 0;

98 
c
->
qu”ybuf
 = 
	`sd£m±y
();

99 
c
->
³ndšg_qu”ybuf
 = 
	`sd£m±y
();

100 
c
->
qu”ybuf_³ak
 = 0;

101 
c
->
»qty³
 = 0;

102 
c
->
¬gc
 = 0;

103 
c
->
¬gv
 = 
NULL
;

104 
c
->
cmd
 = c->
Ï¡cmd
 = 
NULL
;

105 
c
->
muÉibulkËn
 = 0;

106 
c
->
bulkËn
 = -1;

107 
c
->
£ÁËn
 = 0;

108 
c
->
æags
 = 0;

109 
c
->
ùime
 = c->
Ï¡š‹¿ùiÚ
 = 
£rv”
.
unixtime
;

110 
c
->
auth’tiÿ‹d
 = 0;

111 
c
->
»¶¡©e
 = 
REPL_STATE_NONE
;

112 
c
->
»¶_put_Úlše_Ú_ack
 = 0;

113 
c
->
»¶off
 = 0;

114 
c
->
»ad_»¶off
 = 0;

115 
c
->
»¶_ack_off
 = 0;

116 
c
->
»¶_ack_time
 = 0;

117 
c
->
¦ave_li¡’šg_pÜt
 = 0;

118 
c
->
¦ave_
[0] = '\0';

119 
c
->
¦ave_ÿ·
 = 
SLAVE_CAPA_NONE
;

120 
c
->
»¶y
 = 
	`li¡C»©e
();

121 
c
->
»¶y_by‹s
 = 0;

122 
c
->
obuf_soá_lim™_»ached_time
 = 0;

123 
	`li¡S‘F»eM‘hod
(
c
->
»¶y
,
ä“Cl›ÁR•lyV®ue
);

124 
	`li¡S‘DupM‘hod
(
c
->
»¶y
,
dupCl›ÁR•lyV®ue
);

125 
c
->
bty³
 = 
BLOCKED_NONE
;

126 
c
->
bpİ
.
timeout
 = 0;

127 
c
->
bpİ
.
keys
 = 
	`diùC»©e
(&
objeùKeyPoš‹rV®ueDiùTy³
,
NULL
);

128 
c
->
bpİ
.
rg‘
 = 
NULL
;

129 
c
->
bpİ
.
num»¶iÿs
 = 0;

130 
c
->
bpİ
.
»¶off£t
 = 0;

131 
c
->
woff
 = 0;

132 
c
->
w©ched_keys
 = 
	`li¡C»©e
();

133 
c
->
pubsub_chªÃls
 = 
	`diùC»©e
(&
objeùKeyPoš‹rV®ueDiùTy³
,
NULL
);

134 
c
->
pubsub_·‰”ns
 = 
	`li¡C»©e
();

135 
c
->
³”id
 = 
NULL
;

136 
	`li¡S‘F»eM‘hod
(
c
->
pubsub_·‰”ns
,
deüRefCouÁVoid
);

137 
	`li¡S‘M©chM‘hod
(
c
->
pubsub_·‰”ns
,
li¡M©chObjeùs
);

138 ià(
fd
 !ğ-1è
	`li¡AddNodeTa
(
£rv”
.
ş›Ás
,
c
);

139 
	`š™Cl›ÁMuÉiS‹
(
c
);

140  
c
;

141 
	}
}

165 
	$´•¬eCl›ÁToWr™e
(
ş›Á
 *
c
) {

168 ià(
c
->
æags
 & (
CLIENT_LUA
|
CLIENT_MODULE
)è 
C_OK
;

171 ià(
c
->
æags
 & (
CLIENT_REPLY_OFF
|
CLIENT_REPLY_SKIP
)è 
C_ERR
;

175 ià((
c
->
æags
 & 
CLIENT_MASTER
) &&

176 !(
c
->
æags
 & 
CLIENT_MASTER_FORCE_REPLY
)è 
C_ERR
;

178 ià(
c
->
fd
 <ğ0è 
C_ERR
;

184 ià(!
	`ş›ÁHasP’dšgR•l›s
(
c
) &&

185 !(
c
->
æags
 & 
CLIENT_PENDING_WRITE
) &&

186 (
c
->
»¶¡©e
 =ğ
REPL_STATE_NONE
 ||

187 (
c
->
»¶¡©e
 =ğ
SLAVE_STATE_ONLINE
 && !c->
»¶_put_Úlše_Ú_ack
)))

195 
c
->
æags
 |ğ
CLIENT_PENDING_WRITE
;

196 
	`li¡AddNodeH—d
(
£rv”
.
ş›Ás_³ndšg_wr™e
,
c
);

200  
C_OK
;

201 
	}
}

207 
	$_addR•lyToBufãr
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
) {

208 
size_t
 
avaabË
 = (
c
->
buf
)-c->
buåos
;

210 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
è 
C_OK
;

214 ià(
	`li¡L’gth
(
c
->
»¶y
è> 0è 
C_ERR
;

217 ià(
Ën
 > 
avaabË
è 
C_ERR
;

219 
	`memıy
(
c
->
buf
+c->
buåos
,
s
,
Ën
);

220 
c
->
buåos
+=
Ën
;

221  
C_OK
;

222 
	}
}

224 
	$_addR•lyObjeùToLi¡
(
ş›Á
 *
c
, 
robj
 *
o
) {

225 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
) ;

227 ià(
	`li¡L’gth
(
c
->
»¶y
) == 0) {

228 
sds
 
s
 = 
	`sdsdup
(
o
->
±r
);

229 
	`li¡AddNodeTa
(
c
->
»¶y
,
s
);

230 
c
->
»¶y_by‹s
 +ğ
	`sd¦’
(
s
);

232 
li¡Node
 *
Ê
 = 
	`li¡La¡
(
c
->
»¶y
);

233 
sds
 

 = 
	`li¡NodeV®ue
(
Ê
);

237 ià(

 && 
	`sd¦’
Ña)+sd¦’(
o
->
±r
è<ğ
PROTO_REPLY_CHUNK_BYTES
) {

238 

 = 
	`sdsÿtsds
Ña,
o
->
±r
);

239 
	`li¡NodeV®ue
(
Ê
èğ

;

240 
c
->
»¶y_by‹s
 +ğ
	`sd¦’
(
o
->
±r
);

242 
sds
 
s
 = 
	`sdsdup
(
o
->
±r
);

243 
	`li¡AddNodeTa
(
c
->
»¶y
,
s
);

244 
c
->
»¶y_by‹s
 +ğ
	`sd¦’
(
s
);

247 
	`asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
c
);

248 
	}
}

252 
	$_addR•lySdsToLi¡
(
ş›Á
 *
c
, 
sds
 
s
) {

253 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
) {

254 
	`sdsä“
(
s
);

258 ià(
	`li¡L’gth
(
c
->
»¶y
) == 0) {

259 
	`li¡AddNodeTa
(
c
->
»¶y
,
s
);

260 
c
->
»¶y_by‹s
 +ğ
	`sd¦’
(
s
);

262 
li¡Node
 *
Ê
 = 
	`li¡La¡
(
c
->
»¶y
);

263 
sds
 

 = 
	`li¡NodeV®ue
(
Ê
);

267 ià(

 && 
	`sd¦’
Ña)+sd¦’(
s
è<ğ
PROTO_REPLY_CHUNK_BYTES
) {

268 

 = 
	`sdsÿtsds
Ña,
s
);

269 
	`li¡NodeV®ue
(
Ê
èğ

;

270 
c
->
»¶y_by‹s
 +ğ
	`sd¦’
(
s
);

271 
	`sdsä“
(
s
);

273 
	`li¡AddNodeTa
(
c
->
»¶y
,
s
);

274 
c
->
»¶y_by‹s
 +ğ
	`sd¦’
(
s
);

277 
	`asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
c
);

278 
	}
}

280 
	$_addR•lySŒšgToLi¡
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
) {

281 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
) ;

283 ià(
	`li¡L’gth
(
c
->
»¶y
) == 0) {

284 
sds
 
node
 = 
	`sd¢ewËn
(
s
,
Ën
);

285 
	`li¡AddNodeTa
(
c
->
»¶y
,
node
);

286 
c
->
»¶y_by‹s
 +ğ
Ën
;

288 
li¡Node
 *
Ê
 = 
	`li¡La¡
(
c
->
»¶y
);

289 
sds
 

 = 
	`li¡NodeV®ue
(
Ê
);

293 ià(

 && 
	`sd¦’
Ña)+
Ën
 <ğ
PROTO_REPLY_CHUNK_BYTES
) {

294 

 = 
	`sdsÿ’
Ña,
s
,
Ën
);

295 
	`li¡NodeV®ue
(
Ê
èğ

;

296 
c
->
»¶y_by‹s
 +ğ
Ën
;

298 
sds
 
node
 = 
	`sd¢ewËn
(
s
,
Ën
);

299 
	`li¡AddNodeTa
(
c
->
»¶y
,
node
);

300 
c
->
»¶y_by‹s
 +ğ
Ën
;

303 
	`asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
c
);

304 
	}
}

311 
	$addR•ly
(
ş›Á
 *
c
, 
robj
 *
obj
) {

312 ià(
	`´•¬eCl›ÁToWr™e
(
c
è!ğ
C_OK
) ;

321 ià(
	`sdsEncodedObjeù
(
obj
)) {

322 ià(
	`_addR•lyToBufãr
(
c
,
obj
->
±r
,
	`sd¦’
(obj->±r)è!ğ
C_OK
)

323 
	`_addR•lyObjeùToLi¡
(
c
,
obj
);

324 } ià(
obj
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

328 ià(
	`li¡L’gth
(
c
->
»¶y
è=ğ0 && ((c->
buf
è- c->
buåos
) >= 32) {

329 
buf
[32];

330 
Ën
;

332 
Ën
 = 
	`Î2¡ršg
(
buf
,(buf),()
obj
->
±r
);

333 ià(
	`_addR•lyToBufãr
(
c
,
buf
,
Ën
è=ğ
C_OK
)

338 
obj
 = 
	`g‘DecodedObjeù
(obj);

339 ià(
	`_addR•lyToBufãr
(
c
,
obj
->
±r
,
	`sd¦’
(obj->±r)è!ğ
C_OK
)

340 
	`_addR•lyObjeùToLi¡
(
c
,
obj
);

341 
	`deüRefCouÁ
(
obj
);

343 
	`£rv”Pªic
("Wrong obj->encoding in‡ddReply()");

345 
	}
}

347 
	$addR•lySds
(
ş›Á
 *
c
, 
sds
 
s
) {

348 ià(
	`´•¬eCl›ÁToWr™e
(
c
è!ğ
C_OK
) {

350 
	`sdsä“
(
s
);

353 ià(
	`_addR•lyToBufãr
(
c
,
s
,
	`sd¦’
(s)è=ğ
C_OK
) {

354 
	`sdsä“
(
s
);

357 
	`_addR•lySdsToLi¡
(
c
,
s
);

359 
	}
}

369 
	$addR•lySŒšg
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
) {

370 ià(
	`´•¬eCl›ÁToWr™e
(
c
è!ğ
C_OK
) ;

371 ià(
	`_addR•lyToBufãr
(
c
,
s
,
Ën
è!ğ
C_OK
)

372 
	`_addR•lySŒšgToLi¡
(
c
,
s
,
Ën
);

373 
	}
}

375 
	$addR•lyE¼ÜL’gth
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
) {

376 
	`addR•lySŒšg
(
c
,"-ERR ",5);

377 
	`addR•lySŒšg
(
c
,
s
,
Ën
);

378 
	`addR•lySŒšg
(
c
,"\r\n",2);

379 
	}
}

381 
	$addR•lyE¼Ü
(
ş›Á
 *
c
, cÚ¡ *
”r
) {

382 
	`addR•lyE¼ÜL’gth
(
c
,
”r
,
	`¡¾’
(err));

383 
	}
}

385 
	$addR•lyE¼ÜFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...) {

386 
size_t
 
l
, 
j
;

387 
va_li¡
 
­
;

388 
	`va_¡¬t
(
­
,
fmt
);

389 
sds
 
s
 = 
	`sdsÿtv´štf
(
	`sd£m±y
(),
fmt
,
­
);

390 
	`va_’d
(
­
);

393 
l
 = 
	`sd¦’
(
s
);

394 
j
 = 0; j < 
l
; j++) {

395 ià(
s
[
j
] == '\r' || s[j] == '\n') s[j] = ' ';

397 
	`addR•lyE¼ÜL’gth
(
c
,
s
,
	`sd¦’
(s));

398 
	`sdsä“
(
s
);

399 
	}
}

401 
	$addR•lyStusL’gth
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
) {

402 
	`addR•lySŒšg
(
c
,"+",1);

403 
	`addR•lySŒšg
(
c
,
s
,
Ën
);

404 
	`addR•lySŒšg
(
c
,"\r\n",2);

405 
	}
}

407 
	$addR•lyStus
(
ş›Á
 *
c
, cÚ¡ *
¡©us
) {

408 
	`addR•lyStusL’gth
(
c
,
¡©us
,
	`¡¾’
(status));

409 
	}
}

411 
	$addR•lyStusFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...) {

412 
va_li¡
 
­
;

413 
	`va_¡¬t
(
­
,
fmt
);

414 
sds
 
s
 = 
	`sdsÿtv´štf
(
	`sd£m±y
(),
fmt
,
­
);

415 
	`va_’d
(
­
);

416 
	`addR•lyStusL’gth
(
c
,
s
,
	`sd¦’
(s));

417 
	`sdsä“
(
s
);

418 
	}
}

422 *
	$addDeã¼edMuÉiBulkL’gth
(
ş›Á
 *
c
) {

426 ià(
	`´•¬eCl›ÁToWr™e
(
c
è!ğ
C_OK
è 
NULL
;

427 
	`li¡AddNodeTa
(
c
->
»¶y
,
NULL
);

428  
	`li¡La¡
(
c
->
»¶y
);

429 
	}
}

432 
	$£tDeã¼edMuÉiBulkL’gth
(
ş›Á
 *
c
, *
node
, 
Ëngth
) {

433 
li¡Node
 *
Ê
 = (li¡Node*)
node
;

434 
sds
 
Ën
, 
Ãxt
;

438 ià(
node
 =ğ
NULL
) ;

440 
Ën
 = 
	`sdsÿrštf
(
	`sd¢ewËn
("*",1),"%ld\r\n",
Ëngth
);

441 
	`li¡NodeV®ue
(
Ê
èğ
Ën
;

442 
c
->
»¶y_by‹s
 +ğ
	`sd¦’
(
Ën
);

443 ià(
Ê
->
Ãxt
 !ğ
NULL
) {

444 
Ãxt
 = 
	`li¡NodeV®ue
(
Ê
->next);

447 ià(
Ãxt
 !ğ
NULL
) {

448 
Ën
 = 
	`sdsÿtsds
Ö’,
Ãxt
);

449 
	`li¡D–Node
(
c
->
»¶y
,
Ê
->
Ãxt
);

450 
	`li¡NodeV®ue
(
Ê
èğ
Ën
;

455 
	`asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
c
);

456 
	}
}

459 
	$addR•lyDoubË
(
ş›Á
 *
c
, 
d
) {

460 
dbuf
[128], 
sbuf
[128];

461 
dËn
, 
¦’
;

462 ià(
	`isšf
(
d
)) {

465 
	`addR•lyBulkCSŒšg
(
c
, 
d
 > 0 ? "inf" : "-inf");

467 
dËn
 = 
	`¢´štf
(
dbuf
,(dbuf),"%.17g",
d
);

468 
¦’
 = 
	`¢´štf
(
sbuf
,(sbuf),"$%d\r\n%s\r\n",
dËn
,
dbuf
);

469 
	`addR•lySŒšg
(
c
,
sbuf
,
¦’
);

471 
	}
}

476 
	$addR•lyHumªLÚgDoubË
(
ş›Á
 *
c
, 
d
) {

477 
robj
 *
o
 = 
	`ü—‹SŒšgObjeùFromLÚgDoubË
(
d
,1);

478 
	`addR•lyBulk
(
c
,
o
);

479 
	`deüRefCouÁ
(
o
);

480 
	}
}

484 
	$addR•lyLÚgLÚgW™hP»fix
(
ş›Á
 *
c
, 
Î
, 
´efix
) {

485 
buf
[128];

486 
Ën
;

491 ià(
´efix
 =ğ'*' && 
Î
 < 
OBJ_SHARED_BULKHDR_LEN
 &&†l >= 0) {

492 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[
Î
]);

494 } ià(
´efix
 =ğ'$' && 
Î
 < 
OBJ_SHARED_BULKHDR_LEN
 &&†l >= 0) {

495 
	`addR•ly
(
c
,
sh¬ed
.
bulkhdr
[
Î
]);

499 
buf
[0] = 
´efix
;

500 
Ën
 = 
	`Î2¡ršg
(
buf
+1,(buf)-1,
Î
);

501 
buf
[
Ën
+1] = '\r';

502 
buf
[
Ën
+2] = '\n';

503 
	`addR•lySŒšg
(
c
,
buf
,
Ën
+3);

504 
	}
}

506 
	$addR•lyLÚgLÚg
(
ş›Á
 *
c
, 
Î
) {

507 ià(
Î
 == 0)

508 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

509 ià(
Î
 == 1)

510 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

512 
	`addR•lyLÚgLÚgW™hP»fix
(
c
,
Î
,':');

513 
	}
}

515 
	$addR•lyMuÉiBulkL’
(
ş›Á
 *
c
, 
Ëngth
) {

516 ià(
Ëngth
 < 
OBJ_SHARED_BULKHDR_LEN
)

517 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[
Ëngth
]);

519 
	`addR•lyLÚgLÚgW™hP»fix
(
c
,
Ëngth
,'*');

520 
	}
}

523 
	$addR•lyBulkL’
(
ş›Á
 *
c
, 
robj
 *
obj
) {

524 
size_t
 
Ën
;

526 ià(
	`sdsEncodedObjeù
(
obj
)) {

527 
Ën
 = 
	`sd¦’
(
obj
->
±r
);

529 
n
 = ()
obj
->
±r
;

532 
Ën
 = 1;

533 ià(
n
 < 0) {

534 
Ën
++;

535 
n
 = -n;

537 (
n
 =‚/10) != 0) {

538 
Ën
++;

542 ià(
Ën
 < 
OBJ_SHARED_BULKHDR_LEN
)

543 
	`addR•ly
(
c
,
sh¬ed
.
bulkhdr
[
Ën
]);

545 
	`addR•lyLÚgLÚgW™hP»fix
(
c
,
Ën
,'$');

546 
	}
}

549 
	$addR•lyBulk
(
ş›Á
 *
c
, 
robj
 *
obj
) {

550 
	`addR•lyBulkL’
(
c
,
obj
);

551 
	`addR•ly
(
c
,
obj
);

552 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

553 
	}
}

556 
	$addR•lyBulkCBufãr
(
ş›Á
 *
c
, cÚ¡ *
p
, 
size_t
 
Ën
) {

557 
	`addR•lyLÚgLÚgW™hP»fix
(
c
,
Ën
,'$');

558 
	`addR•lySŒšg
(
c
,
p
,
Ën
);

559 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

560 
	}
}

563 
	$addR•lyBulkSds
(
ş›Á
 *
c
, 
sds
 
s
) {

564 
	`addR•lyLÚgLÚgW™hP»fix
(
c
,
	`sd¦’
(
s
),'$');

565 
	`addR•lySds
(
c
,
s
);

566 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

567 
	}
}

570 
	$addR•lyBulkCSŒšg
(
ş›Á
 *
c
, cÚ¡ *
s
) {

571 ià(
s
 =ğ
NULL
) {

572 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

574 
	`addR•lyBulkCBufãr
(
c
,
s
,
	`¡¾’
(s));

576 
	}
}

579 
	$addR•lyBulkLÚgLÚg
(
ş›Á
 *
c
, 
Î
) {

580 
buf
[64];

581 
Ën
;

583 
Ën
 = 
	`Î2¡ršg
(
buf
,64,
Î
);

584 
	`addR•lyBulkCBufãr
(
c
,
buf
,
Ën
);

585 
	}
}

590 
	$cİyCl›ÁOuutBufãr
(
ş›Á
 *
d¡
, cl›Á *
¤c
) {

591 
	`li¡R–—£
(
d¡
->
»¶y
);

592 
d¡
->
»¶y
 = 
	`li¡Dup
(
¤c
->reply);

593 
	`memıy
(
d¡
->
buf
,
¤c
->buf,¤c->
buåos
);

594 
d¡
->
buåos
 = 
¤c
->bufpos;

595 
d¡
->
»¶y_by‹s
 = 
¤c
->reply_bytes;

596 
	}
}

600 
	$ş›ÁHasP’dšgR•l›s
(
ş›Á
 *
c
) {

601  
c
->
buåos
 || 
	`li¡L’gth
(c->
»¶y
);

602 
	}
}

604 
	#MAX_ACCEPTS_PER_CALL
 1000

	)

605 
	$acû±CommÚHªdËr
(
fd
, 
æags
, *

) {

606 
ş›Á
 *
c
;

607 ià((
c
 = 
	`ü—‹Cl›Á
(
fd
)è=ğ
NULL
) {

608 
	`£rv”Log
(
LL_WARNING
,

610 
	`¡»¼Ü
(
”ºo
),
fd
);

611 
	`şo£
(
fd
);

618 ià(
	`li¡L’gth
(
£rv”
.
ş›Ás
è> s”v”.
maxş›Ás
) {

619 *
”r
 = "-ERR max‚umber of clients„eached\r\n";

622 ià(
	`wr™e
(
c
->
fd
,
”r
,
	`¡¾’
(err)) == -1) {

625 
£rv”
.
¡©_»jeùed_cÚn
++;

626 
	`ä“Cl›Á
(
c
);

634 ià(
£rv”
.
´Ùeùed_mode
 &&

635 
£rv”
.
bšdaddr_couÁ
 == 0 &&

636 
£rv”
.
»quœ•ass
 =ğ
NULL
 &&

637 !(
æags
 & 
CLIENT_UNIX_SOCKET
) &&

638 

 !ğ
NULL
)

640 ià(
	`¡rcmp
(

,"127.0.0.1") && strcmp(ip,"::1")) {

641 *
”r
 =

662 ià(
	`wr™e
(
c
->
fd
,
”r
,
	`¡¾’
(err)) == -1) {

665 
£rv”
.
¡©_»jeùed_cÚn
++;

666 
	`ä“Cl›Á
(
c
);

671 
£rv”
.
¡©_numcÚÃùiÚs
++;

672 
c
->
æags
 |= flags;

673 
	}
}

675 
	$acû±TıHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

676 
ıÜt
, 
cfd
, 
max
 = 
MAX_ACCEPTS_PER_CALL
;

677 
c
[
NET_IP_STR_LEN
];

678 
	`UNUSED
(
–
);

679 
	`UNUSED
(
mask
);

680 
	`UNUSED
(
´ivd©a
);

682 
max
--) {

683 
cfd
 = 
	`ª‘TıAcû±
(
£rv”
.
Ã‹¼
, 
fd
, 
c
, (c), &
ıÜt
);

684 ià(
cfd
 =ğ
ANET_ERR
) {

685 ià(
”ºo
 !ğ
EWOULDBLOCK
)

686 
	`£rv”Log
(
LL_WARNING
,

687 "Acû±šg cl›Á cÚÃùiÚ: %s", 
£rv”
.
Ã‹¼
);

690 
	`£rv”Log
(
LL_VERBOSE
,"Acû±ed %s:%d", 
c
, 
ıÜt
);

691 
	`acû±CommÚHªdËr
(
cfd
,0,
c
);

693 
	}
}

695 
	$acû±UnixHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

696 
cfd
, 
max
 = 
MAX_ACCEPTS_PER_CALL
;

697 
	`UNUSED
(
–
);

698 
	`UNUSED
(
mask
);

699 
	`UNUSED
(
´ivd©a
);

701 
max
--) {

702 
cfd
 = 
	`ª‘UnixAcû±
(
£rv”
.
Ã‹¼
, 
fd
);

703 ià(
cfd
 =ğ
ANET_ERR
) {

704 ià(
”ºo
 !ğ
EWOULDBLOCK
)

705 
	`£rv”Log
(
LL_WARNING
,

706 "Acû±šg cl›Á cÚÃùiÚ: %s", 
£rv”
.
Ã‹¼
);

709 
	`£rv”Log
(
LL_VERBOSE
,"Acû±ed cÚÃùiÚØ%s", 
£rv”
.
unixsock‘
);

710 
	`acû±CommÚHªdËr
(
cfd
,
CLIENT_UNIX_SOCKET
,
NULL
);

712 
	}
}

714 
	$ä“Cl›ÁArgv
(
ş›Á
 *
c
) {

715 
j
;

716 
j
 = 0; j < 
c
->
¬gc
; j++)

717 
	`deüRefCouÁ
(
c
->
¬gv
[
j
]);

718 
c
->
¬gc
 = 0;

719 
c
->
cmd
 = 
NULL
;

720 
	}
}

725 
	$discÚÃùSÏves
() {

726 
	`li¡L’gth
(
£rv”
.
¦aves
)) {

727 
li¡Node
 *
Ê
 = 
	`li¡Fœ¡
(
£rv”
.
¦aves
);

728 
	`ä“Cl›Á
((
ş›Á
*)
Ê
->
v®ue
);

730 
	}
}

735 
	$uÆškCl›Á
(
ş›Á
 *
c
) {

736 
li¡Node
 *
Ê
;

739 ià(
£rv”
.
cu¼’t_ş›Á
 =ğ
c
è£rv”.cu¼’t_ş›Á = 
NULL
;

744 ià(
c
->
fd
 != -1) {

746 
Ê
 = 
	`li¡S—rchKey
(
£rv”
.
ş›Ás
,
c
);

747 
	`£rv”As£¹
(
Ê
 !ğ
NULL
);

748 
	`li¡D–Node
(
£rv”
.
ş›Ás
,
Ê
);

751 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
c
->
fd
,
AE_READABLE
);

752 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
c
->
fd
,
AE_WRITABLE
);

753 
	`şo£
(
c
->
fd
);

754 
c
->
fd
 = -1;

758 ià(
c
->
æags
 & 
CLIENT_PENDING_WRITE
) {

759 
Ê
 = 
	`li¡S—rchKey
(
£rv”
.
ş›Ás_³ndšg_wr™e
,
c
);

760 
	`£rv”As£¹
(
Ê
 !ğ
NULL
);

761 
	`li¡D–Node
(
£rv”
.
ş›Ás_³ndšg_wr™e
,
Ê
);

762 
c
->
æags
 &ğ~
CLIENT_PENDING_WRITE
;

767 ià(
c
->
æags
 & 
CLIENT_UNBLOCKED
) {

768 
Ê
 = 
	`li¡S—rchKey
(
£rv”
.
unblocked_ş›Ás
,
c
);

769 
	`£rv”As£¹
(
Ê
 !ğ
NULL
);

770 
	`li¡D–Node
(
£rv”
.
unblocked_ş›Ás
,
Ê
);

771 
c
->
æags
 &ğ~
CLIENT_UNBLOCKED
;

773 
	}
}

775 
	$ä“Cl›Á
(
ş›Á
 *
c
) {

776 
li¡Node
 *
Ê
;

783 ià(
£rv”
.
ma¡”
 && 
c
->
æags
 & 
CLIENT_MASTER
) {

784 
	`£rv”Log
(
LL_WARNING
,"Connection with master†ost.");

785 ià(!(
c
->
æags
 & (
CLIENT_CLOSE_AFTER_REPLY
|

786 
CLIENT_CLOSE_ASAP
|

787 
CLIENT_BLOCKED
|

788 
CLIENT_UNBLOCKED
)))

790 
	`»¶iÿtiÚCacheMa¡”
(
c
);

796 ià((
c
->
æags
 & 
CLIENT_SLAVE
è&& !(c->æag & 
CLIENT_MONITOR
)) {

797 
	`£rv”Log
(
LL_WARNING
,"Connection with slave %s†ost.",

798 
	`»¶iÿtiÚG‘SÏveName
(
c
));

802 
	`sdsä“
(
c
->
qu”ybuf
);

803 
	`sdsä“
(
c
->
³ndšg_qu”ybuf
);

804 
c
->
qu”ybuf
 = 
NULL
;

807 ià(
c
->
æags
 & 
CLIENT_BLOCKED
è
	`unblockCl›Á
(c);

808 
	`diùR–—£
(
c
->
bpİ
.
keys
);

811 
	`unw©chAÎKeys
(
c
);

812 
	`li¡R–—£
(
c
->
w©ched_keys
);

815 
	`pubsubUnsubsüibeAÎChªÃls
(
c
,0);

816 
	`pubsubUnsubsüibeAÎP©‹ºs
(
c
,0);

817 
	`diùR–—£
(
c
->
pubsub_chªÃls
);

818 
	`li¡R–—£
(
c
->
pubsub_·‰”ns
);

821 
	`li¡R–—£
(
c
->
»¶y
);

822 
	`ä“Cl›ÁArgv
(
c
);

827 
	`uÆškCl›Á
(
c
);

831 ià(
c
->
æags
 & 
CLIENT_SLAVE
) {

832 ià(
c
->
»¶¡©e
 =ğ
SLAVE_STATE_SEND_BULK
) {

833 ià(
c
->
»¶dbfd
 !ğ-1è
	`şo£
(c->repldbfd);

834 ià(
c
->
»¶´—mbË
è
	`sdsä“
(c->replpreamble);

836 
li¡
 *
l
 = (
c
->
æags
 & 
CLIENT_MONITOR
è? 
£rv”
.
mÚ™Üs
 : s”v”.
¦aves
;

837 
Ê
 = 
	`li¡S—rchKey
(
l
,
c
);

838 
	`£rv”As£¹
(
Ê
 !ğ
NULL
);

839 
	`li¡D–Node
(
l
,
Ê
);

843 ià(
c
->
æags
 & 
CLIENT_SLAVE
 && 
	`li¡L’gth
(
£rv”
.
¦aves
) == 0)

844 
£rv”
.
»¶_no_¦aves_sšû
 = s”v”.
unixtime
;

845 
	`»äeshGoodSÏvesCouÁ
();

850 ià(
c
->
æags
 & 
CLIENT_MASTER
è
	`»¶iÿtiÚHªdËMa¡”DiscÚÃùiÚ
();

854 ià(
c
->
æags
 & 
CLIENT_CLOSE_ASAP
) {

855 
Ê
 = 
	`li¡S—rchKey
(
£rv”
.
ş›Ás_to_şo£
,
c
);

856 
	`£rv”As£¹
(
Ê
 !ğ
NULL
);

857 
	`li¡D–Node
(
£rv”
.
ş›Ás_to_şo£
,
Ê
);

862 ià(
c
->
Çme
è
	`deüRefCouÁ
(c->name);

863 
	`zä“
(
c
->
¬gv
);

864 
	`ä“Cl›ÁMuÉiS‹
(
c
);

865 
	`sdsä“
(
c
->
³”id
);

866 
	`zä“
(
c
);

867 
	}
}

873 
	$ä“Cl›ÁAsync
(
ş›Á
 *
c
) {

874 ià(
c
->
æags
 & 
CLIENT_CLOSE_ASAP
 || c->æag & 
CLIENT_LUA
) ;

875 
c
->
æags
 |ğ
CLIENT_CLOSE_ASAP
;

876 
	`li¡AddNodeTa
(
£rv”
.
ş›Ás_to_şo£
,
c
);

877 
	}
}

879 
	$ä“Cl›ÁsInAsyncF»eQueue
() {

880 
	`li¡L’gth
(
£rv”
.
ş›Ás_to_şo£
)) {

881 
li¡Node
 *
Ê
 = 
	`li¡Fœ¡
(
£rv”
.
ş›Ás_to_şo£
);

882 
ş›Á
 *
c
 = 
	`li¡NodeV®ue
(
Ê
);

884 
c
->
æags
 &ğ~
CLIENT_CLOSE_ASAP
;

885 
	`ä“Cl›Á
(
c
);

886 
	`li¡D–Node
(
£rv”
.
ş›Ás_to_şo£
,
Ê
);

888 
	}
}

892 
	$wr™eToCl›Á
(
fd
, 
ş›Á
 *
c
, 
hªdËr_š¡®Ëd
) {

893 
ssize_t
 
nwr™‹n
 = 0, 
tÙwr™‹n
 = 0;

894 
size_t
 
objËn
;

895 
sds
 
o
;

897 
	`ş›ÁHasP’dšgR•l›s
(
c
)) {

898 ià(
c
->
buåos
 > 0) {

899 
nwr™‹n
 = 
	`wr™e
(
fd
,
c
->
buf
+c->
£ÁËn
,c->
buåos
-c->sentlen);

900 ià(
nwr™‹n
 <= 0) ;

901 
c
->
£ÁËn
 +ğ
nwr™‹n
;

902 
tÙwr™‹n
 +ğ
nwr™‹n
;

906 ià(()
c
->
£ÁËn
 =ğc->
buåos
) {

907 
c
->
buåos
 = 0;

908 
c
->
£ÁËn
 = 0;

911 
o
 = 
	`li¡NodeV®ue
(
	`li¡Fœ¡
(
c
->
»¶y
));

912 
objËn
 = 
	`sd¦’
(
o
);

914 ià(
objËn
 == 0) {

915 
	`li¡D–Node
(
c
->
»¶y
,
	`li¡Fœ¡
(c->reply));

919 
nwr™‹n
 = 
	`wr™e
(
fd
, 
o
 + 
c
->
£ÁËn
, 
objËn
 - c->sentlen);

920 ià(
nwr™‹n
 <= 0) ;

921 
c
->
£ÁËn
 +ğ
nwr™‹n
;

922 
tÙwr™‹n
 +ğ
nwr™‹n
;

925 ià(
c
->
£ÁËn
 =ğ
objËn
) {

926 
	`li¡D–Node
(
c
->
»¶y
,
	`li¡Fœ¡
(c->reply));

927 
c
->
£ÁËn
 = 0;

928 
c
->
»¶y_by‹s
 -ğ
objËn
;

931 ià(
	`li¡L’gth
(
c
->
»¶y
) == 0)

932 
	`£rv”As£¹
(
c
->
»¶y_by‹s
 == 0);

943 ià(
tÙwr™‹n
 > 
NET_MAX_WRITES_PER_EVENT
 &&

944 (
£rv”
.
maxmemÜy
 == 0 ||

945 
	`zm®loc_u£d_memÜy
(è< 
£rv”
.
maxmemÜy
)) ;

947 
£rv”
.
¡©_Ãt_ouut_by‹s
 +ğ
tÙwr™‹n
;

948 ià(
nwr™‹n
 == -1) {

949 ià(
”ºo
 =ğ
EAGAIN
) {

950 
nwr™‹n
 = 0;

952 
	`£rv”Log
(
LL_VERBOSE
,

953 "E¼Ü wr™šgØş›Á: %s", 
	`¡»¼Ü
(
”ºo
));

954 
	`ä“Cl›Á
(
c
);

955  
C_ERR
;

958 ià(
tÙwr™‹n
 > 0) {

963 ià(!(
c
->
æags
 & 
CLIENT_MASTER
)èc->
Ï¡š‹¿ùiÚ
 = 
£rv”
.
unixtime
;

965 ià(!
	`ş›ÁHasP’dšgR•l›s
(
c
)) {

966 
c
->
£ÁËn
 = 0;

967 ià(
hªdËr_š¡®Ëd
è
	`«D–‘eFeEv’t
(
£rv”
.
–
,
c
->
fd
,
AE_WRITABLE
);

970 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
) {

971 
	`ä“Cl›Á
(
c
);

972  
C_ERR
;

975  
C_OK
;

976 
	}
}

979 
	$£ndR•lyToCl›Á
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

980 
	`UNUSED
(
–
);

981 
	`UNUSED
(
mask
);

982 
	`wr™eToCl›Á
(
fd
,
´ivd©a
,1);

983 
	}
}

989 
	$hªdËCl›ÁsW™hP’dšgWr™es
() {

990 
li¡I‹r
 
li
;

991 
li¡Node
 *
Ê
;

992 
´oûs£d
 = 
	`li¡L’gth
(
£rv”
.
ş›Ás_³ndšg_wr™e
);

994 
	`li¡Rewšd
(
£rv”
.
ş›Ás_³ndšg_wr™e
,&
li
);

995 (
Ê
 = 
	`li¡Next
(&
li
))) {

996 
ş›Á
 *
c
 = 
	`li¡NodeV®ue
(
Ê
);

997 
c
->
æags
 &ğ~
CLIENT_PENDING_WRITE
;

998 
	`li¡D–Node
(
£rv”
.
ş›Ás_³ndšg_wr™e
,
Ê
);

1001 ià(
	`wr™eToCl›Á
(
c
->
fd
,c,0è=ğ
C_ERR
) ;

1005 ià(
	`ş›ÁHasP’dšgR•l›s
(
c
) &&

1006 
	`«C»©eFeEv’t
(
£rv”
.
–
, 
c
->
fd
, 
AE_WRITABLE
,

1007 
£ndR•lyToCl›Á
, 
c
è=ğ
AE_ERR
)

1009 
	`ä“Cl›ÁAsync
(
c
);

1012  
´oûs£d
;

1013 
	}
}

1016 
	$»£tCl›Á
(
ş›Á
 *
c
) {

1017 
»disCommªdProc
 *
´evcmd
 = 
c
->
cmd
 ? c->cmd->
´oc
 : 
NULL
;

1019 
	`ä“Cl›ÁArgv
(
c
);

1020 
c
->
»qty³
 = 0;

1021 
c
->
muÉibulkËn
 = 0;

1022 
c
->
bulkËn
 = -1;

1026 ià(!(
c
->
æags
 & 
CLIENT_MULTI
è&& 
´evcmd
 !ğ
askšgCommªd
)

1027 
c
->
æags
 &ğ~
CLIENT_ASKING
;

1032 
c
->
æags
 &ğ~
CLIENT_REPLY_SKIP
;

1033 ià(
c
->
æags
 & 
CLIENT_REPLY_SKIP_NEXT
) {

1034 
c
->
æags
 |ğ
CLIENT_REPLY_SKIP
;

1035 
c
->
æags
 &ğ~
CLIENT_REPLY_SKIP_NEXT
;

1037 
	}
}

1046 
	$´oûssIÆšeBufãr
(
ş›Á
 *
c
) {

1047 *
Ãwlše
;

1048 
¬gc
, 
j
;

1049 
sds
 *
¬gv
, 
aux
;

1050 
size_t
 
qu”yËn
;

1053 
Ãwlše
 = 
	`¡rchr
(
c
->
qu”ybuf
,'\n');

1056 ià(
Ãwlše
 =ğ
NULL
) {

1057 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
PROTO_INLINE_MAX_SIZE
) {

1058 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror:oo big inline„equest");

1059 
	`£tPrÙocŞE¼Ü
("toØbig iÆš»que¡",
c
,0);

1061  
C_ERR
;

1065 ià(
Ãwlše
 &&‚ewlš!ğ
c
->
qu”ybuf
 && *(newline-1) == '\r')

1066 
Ãwlše
--;

1069 
qu”yËn
 = 
Ãwlše
-(
c
->
qu”ybuf
);

1070 
aux
 = 
	`sd¢ewËn
(
c
->
qu”ybuf
,
qu”yËn
);

1071 
¬gv
 = 
	`sds¥l™¬gs
(
aux
,&
¬gc
);

1072 
	`sdsä“
(
aux
);

1073 ià(
¬gv
 =ğ
NULL
) {

1074 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror: unbalanced quotes in„equest");

1075 
	`£tPrÙocŞE¼Ü
("unb®ªûd quÙe š iÆš»que¡",
c
,0);

1076  
C_ERR
;

1082 ià(
qu”yËn
 =ğ0 && 
c
->
æags
 & 
CLIENT_SLAVE
)

1083 
c
->
»¶_ack_time
 = 
£rv”
.
unixtime
;

1086 
	`sd¤ªge
(
c
->
qu”ybuf
,
qu”yËn
+2,-1);

1089 ià(
¬gc
) {

1090 ià(
c
->
¬gv
è
	`zä“
(c->argv);

1091 
c
->
¬gv
 = 
	`zm®loc
((
robj
*)*
¬gc
);

1095 
c
->
¬gc
 = 0, 
j
 = 0; j <‡rgc; j++) {

1096 ià(
	`sd¦’
(
¬gv
[
j
])) {

1097 
c
->
¬gv
[c->
¬gc
] = 
	`ü—‹Objeù
(
OBJ_STRING
,¬gv[
j
]);

1098 
c
->
¬gc
++;

1100 
	`sdsä“
(
¬gv
[
j
]);

1103 
	`zä“
(
¬gv
);

1104  
C_OK
;

1105 
	}
}

1109 
	#PROTO_DUMP_LEN
 128

	)

1110 
	$£tPrÙocŞE¼Ü
(cÚ¡ *
”r¡r
, 
ş›Á
 *
c
, 
pos
) {

1111 ià(
£rv”
.
v”bos™y
 <ğ
LL_VERBOSE
) {

1112 
sds
 
ş›Á
 = 
	`ÿtCl›ÁInfoSŒšg
(
	`sd£m±y
(),
c
);

1115 
buf
[256];

1116 ià(
	`sd¦’
(
c
->
qu”ybuf
è< 
PROTO_DUMP_LEN
) {

1117 
	`¢´štf
(
buf
,(buf),"Qu”y bufã¸duršg…rÙocŞƒ¼Ü: '%s'", 
c
->
qu”ybuf
);

1119 
	`¢´štf
(
buf
,(buf),"Qu”y bufã¸duršg…rÙocŞƒ¼Ü: '%.*s' (... mÜ%zu by‹ ...è'%.*s'", 
PROTO_DUMP_LEN
/2, 
c
->
qu”ybuf
, 
	`sd¦’
(c->querybuf)-PROTO_DUMP_LEN, PROTO_DUMP_LEN/2, c->querybuf+sdslen(c->querybuf)-PROTO_DUMP_LEN/2);

1123 *
p
 = 
buf
;

1124 *
p
 != '\0') {

1125 ià(!
	`i¥ršt
(*
p
)) *p = '.';

1126 
p
++;

1130 
	`£rv”Log
(
LL_VERBOSE
,

1131 "PrÙocŞƒ¼Ü (%sèäom cl›Á: %s. %s", 
”r¡r
, 
ş›Á
, 
buf
);

1132 
	`sdsä“
(
ş›Á
);

1134 
c
->
æags
 |ğ
CLIENT_CLOSE_AFTER_REPLY
;

1135 
	`sd¤ªge
(
c
->
qu”ybuf
,
pos
,-1);

1136 
	}
}

1149 
	$´oûssMuÉibulkBufãr
(
ş›Á
 *
c
) {

1150 *
Ãwlše
 = 
NULL
;

1151 
pos
 = 0, 
ok
;

1152 
Î
;

1154 ià(
c
->
muÉibulkËn
 == 0) {

1156 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
¬gc
 == 0);

1159 
Ãwlše
 = 
	`¡rchr
(
c
->
qu”ybuf
,'\r');

1160 ià(
Ãwlše
 =ğ
NULL
) {

1161 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
PROTO_INLINE_MAX_SIZE
) {

1162 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror:oo big mbulk count string");

1163 
	`£tPrÙocŞE¼Ü
("toØbig mbulk couÁ sŒšg",
c
,0);

1165  
C_ERR
;

1169 ià(
Ãwlše
-(
c
->
qu”ybuf
è> ((sigÃd)
	`sd¦’
(c->querybuf)-2))

1170  
C_ERR
;

1174 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
qu”ybuf
[0] == '*');

1175 
ok
 = 
	`¡ršg2Î
(
c
->
qu”ybuf
+1,
Ãwlše
-(c->qu”ybuf+1),&
Î
);

1176 ià(!
ok
 || 
Î
 > 1024*1024) {

1177 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror: invalid multibulk†ength");

1178 
	`£tPrÙocŞE¼Ü
("šv®id mbulk couÁ",
c
,
pos
);

1179  
C_ERR
;

1182 
pos
 = (
Ãwlše
-
c
->
qu”ybuf
)+2;

1183 ià(
Î
 <= 0) {

1184 
	`sd¤ªge
(
c
->
qu”ybuf
,
pos
,-1);

1185  
C_OK
;

1188 
c
->
muÉibulkËn
 = 
Î
;

1191 ià(
c
->
¬gv
è
	`zä“
(c->argv);

1192 
c
->
¬gv
 = 
	`zm®loc
((
robj
*)*c->
muÉibulkËn
);

1195 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
muÉibulkËn
 > 0);

1196 
c
->
muÉibulkËn
) {

1198 ià(
c
->
bulkËn
 == -1) {

1199 
Ãwlše
 = 
	`¡rchr
(
c
->
qu”ybuf
+
pos
,'\r');

1200 ià(
Ãwlše
 =ğ
NULL
) {

1201 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
PROTO_INLINE_MAX_SIZE
) {

1202 
	`addR•lyE¼Ü
(
c
,

1204 
	`£tPrÙocŞE¼Ü
("toØbig bulk couÁ sŒšg",
c
,0);

1205  
C_ERR
;

1211 ià(
Ãwlše
-(
c
->
qu”ybuf
è> ((sigÃd)
	`sd¦’
(c->querybuf)-2))

1214 ià(
c
->
qu”ybuf
[
pos
] != '$') {

1215 
	`addR•lyE¼ÜFÜm©
(
c
,

1217 
c
->
qu”ybuf
[
pos
]);

1218 
	`£tPrÙocŞE¼Ü
("ex³ùed $ buˆgÙ som‘hšgƒl£",
c
,
pos
);

1219  
C_ERR
;

1222 
ok
 = 
	`¡ršg2Î
(
c
->
qu”ybuf
+
pos
+1,
Ãwlše
-(c->qu”ybuf+pos+1),&
Î
);

1223 ià(!
ok
 || 
Î
 < 0 ||†l > 512*1024*1024) {

1224 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror: invalid bulk†ength");

1225 
	`£tPrÙocŞE¼Ü
("šv®id bulk†’gth",
c
,
pos
);

1226  
C_ERR
;

1229 
pos
 +ğ
Ãwlše
-(
c
->
qu”ybuf
+pos)+2;

1230 ià(
Î
 >ğ
PROTO_MBULK_BIG_ARG
) {

1231 
size_t
 
qbËn
;

1237 
	`sd¤ªge
(
c
->
qu”ybuf
,
pos
,-1);

1238 
pos
 = 0;

1239 
qbËn
 = 
	`sd¦’
(
c
->
qu”ybuf
);

1242 ià(
qbËn
 < (
size_t
)
Î
+2)

1243 
c
->
qu”ybuf
 = 
	`sdsMakeRoomFÜ
(c->qu”ybuf,
Î
+2-
qbËn
);

1245 
c
->
bulkËn
 = 
Î
;

1249 ià(
	`sd¦’
(
c
->
qu”ybuf
)-
pos
 < ()(c->
bulkËn
+2)) {

1256 ià(
pos
 == 0 &&

1257 
c
->
bulkËn
 >ğ
PROTO_MBULK_BIG_ARG
 &&

1258 (sigÃdè
	`sd¦’
(
c
->
qu”ybuf
è=ğc->
bulkËn
+2)

1260 
c
->
¬gv
[c->
¬gc
++] = 
	`ü—‹Objeù
(
OBJ_STRING
,c->
qu”ybuf
);

1261 
	`sdsInüL’
(
c
->
qu”ybuf
,-2);

1264 
c
->
qu”ybuf
 = 
	`sd¢ewËn
(
NULL
,c->
bulkËn
+2);

1265 
	`sdsş—r
(
c
->
qu”ybuf
);

1266 
pos
 = 0;

1268 
c
->
¬gv
[c->
¬gc
++] =

1269 
	`ü—‹SŒšgObjeù
(
c
->
qu”ybuf
+
pos
,c->
bulkËn
);

1270 
pos
 +ğ
c
->
bulkËn
+2;

1272 
c
->
bulkËn
 = -1;

1273 
c
->
muÉibulkËn
--;

1278 ià(
pos
è
	`sd¤ªge
(
c
->
qu”ybuf
,pos,-1);

1281 ià(
c
->
muÉibulkËn
 =ğ0è 
C_OK
;

1284  
C_ERR
;

1285 
	}
}

1291 
	$´oûssIÅutBufãr
(
ş›Á
 *
c
) {

1292 
£rv”
.
cu¼’t_ş›Á
 = 
c
;

1294 
	`sd¦’
(
c
->
qu”ybuf
)) {

1296 ià(!(
c
->
æags
 & 
CLIENT_SLAVE
è&& 
	`ş›ÁsA»Pau£d
()) ;

1299 ià(
c
->
æags
 & 
CLIENT_BLOCKED
) ;

1306 ià(
c
->
æags
 & (
CLIENT_CLOSE_AFTER_REPLY
|
CLIENT_CLOSE_ASAP
)) ;

1309 ià(!
c
->
»qty³
) {

1310 ià(
c
->
qu”ybuf
[0] == '*') {

1311 
c
->
»qty³
 = 
PROTO_REQ_MULTIBULK
;

1313 
c
->
»qty³
 = 
PROTO_REQ_INLINE
;

1317 ià(
c
->
»qty³
 =ğ
PROTO_REQ_INLINE
) {

1318 ià(
	`´oûssIÆšeBufãr
(
c
è!ğ
C_OK
) ;

1319 } ià(
c
->
»qty³
 =ğ
PROTO_REQ_MULTIBULK
) {

1320 ià(
	`´oûssMuÉibulkBufãr
(
c
è!ğ
C_OK
) ;

1322 
	`£rv”Pªic
("Unknown„equestype");

1326 ià(
c
->
¬gc
 == 0) {

1327 
	`»£tCl›Á
(
c
);

1330 ià(
	`´oûssCommªd
(
c
è=ğ
C_OK
) {

1331 ià(
c
->
æags
 & 
CLIENT_MASTER
 && !(c->æag & 
CLIENT_MULTI
)) {

1333 
c
->
»¶off
 = c->
»ad_»¶off
 - 
	`sd¦’
(c->
qu”ybuf
);

1340 ià(!(
c
->
æags
 & 
CLIENT_BLOCKED
è|| c->
bty³
 !ğ
BLOCKED_MODULE
)

1341 
	`»£tCl›Á
(
c
);

1346 ià(
£rv”
.
cu¼’t_ş›Á
 =ğ
NULL
) ;

1349 
£rv”
.
cu¼’t_ş›Á
 = 
NULL
;

1350 
	}
}

1352 
	$»adQu”yFromCl›Á
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

1353 
ş›Á
 *
c
 = (ş›Á*è
´ivd©a
;

1354 
Ä—d
, 
»adËn
;

1355 
size_t
 
qbËn
;

1356 
	`UNUSED
(
–
);

1357 
	`UNUSED
(
mask
);

1359 
»adËn
 = 
PROTO_IOBUF_LEN
;

1366 ià(
c
->
»qty³
 =ğ
PROTO_REQ_MULTIBULK
 && c->
muÉibulkËn
 && c->
bulkËn
 != -1

1367 && 
c
->
bulkËn
 >ğ
PROTO_MBULK_BIG_ARG
)

1369 
»maššg
 = ()(
c
->
bulkËn
+2)-
	`sd¦’
(c->
qu”ybuf
);

1371 ià(
»maššg
 < 
»adËn
)„eadlen =„emaining;

1374 
qbËn
 = 
	`sd¦’
(
c
->
qu”ybuf
);

1375 ià(
c
->
qu”ybuf_³ak
 < 
qbËn
) c->querybuf_peak = qblen;

1376 
c
->
qu”ybuf
 = 
	`sdsMakeRoomFÜ
(c->qu”ybuf, 
»adËn
);

1377 
Ä—d
 = 
	`»ad
(
fd
, 
c
->
qu”ybuf
+
qbËn
, 
»adËn
);

1378 ià(
Ä—d
 == -1) {

1379 ià(
”ºo
 =ğ
EAGAIN
) {

1382 
	`£rv”Log
(
LL_VERBOSE
, "R—dšg from cl›Á: %s",
	`¡»¼Ü
(
”ºo
));

1383 
	`ä“Cl›Á
(
c
);

1386 } ià(
Ä—d
 == 0) {

1387 
	`£rv”Log
(
LL_VERBOSE
, "Client closed connection");

1388 
	`ä“Cl›Á
(
c
);

1390 } ià(
c
->
æags
 & 
CLIENT_MASTER
) {

1394 
c
->
³ndšg_qu”ybuf
 = 
	`sdsÿ’
(c->pending_querybuf,

1395 
c
->
qu”ybuf
+
qbËn
,
Ä—d
);

1398 
	`sdsInüL’
(
c
->
qu”ybuf
,
Ä—d
);

1399 
c
->
Ï¡š‹¿ùiÚ
 = 
£rv”
.
unixtime
;

1400 ià(
c
->
æags
 & 
CLIENT_MASTER
èc->
»ad_»¶off
 +ğ
Ä—d
;

1401 
£rv”
.
¡©_Ãt_šput_by‹s
 +ğ
Ä—d
;

1402 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
£rv”
.
ş›Á_max_qu”ybuf_Ën
) {

1403 
sds
 
ci
 = 
	`ÿtCl›ÁInfoSŒšg
(
	`sd£m±y
(),
c
), 
by‹s
 = sdsempty();

1405 
by‹s
 = 
	`sdsÿŒ•r
(by‹s,
c
->
qu”ybuf
,64);

1406 
	`£rv”Log
(
LL_WARNING
,"Closšg cl›Áh©„—ched max qu”y bufã¸Ëngth: % (qbuàš™ŸÈby‹s: %s)", 
ci
, 
by‹s
);

1407 
	`sdsä“
(
ci
);

1408 
	`sdsä“
(
by‹s
);

1409 
	`ä“Cl›Á
(
c
);

1419 ià(!(
c
->
æags
 & 
CLIENT_MASTER
)) {

1420 
	`´oûssIÅutBufãr
(
c
);

1422 
size_t
 
´ev_off£t
 = 
c
->
»¶off
;

1423 
	`´oûssIÅutBufãr
(
c
);

1424 
size_t
 
­¶›d
 = 
c
->
»¶off
 - 
´ev_off£t
;

1425 ià(
­¶›d
) {

1426 
	`»¶iÿtiÚF“dSÏvesFromMa¡”SŒ—m
(
£rv”
.
¦aves
,

1427 
c
->
³ndšg_qu”ybuf
, 
­¶›d
);

1428 
	`sd¤ªge
(
c
->
³ndšg_qu”ybuf
,
­¶›d
,-1);

1431 
	}
}

1433 
	$g‘Cl›ÁsMaxBufãrs
(*
lÚge¡_ouut_li¡
,

1434 *
bigge¡_šput_bufãr
) {

1435 
ş›Á
 *
c
;

1436 
li¡Node
 *
Ê
;

1437 
li¡I‹r
 
li
;

1438 
lŞ
 = 0, 
bib
 = 0;

1440 
	`li¡Rewšd
(
£rv”
.
ş›Ás
,&
li
);

1441 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

1442 
c
 = 
	`li¡NodeV®ue
(
Ê
);

1444 ià(
	`li¡L’gth
(
c
->
»¶y
è> 
lŞ
)†ol =†istLength(c->reply);

1445 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
bib
) bib = sdslen(c->querybuf);

1447 *
lÚge¡_ouut_li¡
 = 
lŞ
;

1448 *
bigge¡_šput_bufãr
 = 
bib
;

1449 
	}
}

1462 
	$g’Cl›ÁP“rId
(
ş›Á
 *ş›Á, *
³”id
,

1463 
size_t
 
³”id_Ën
) {

1464 ià(
ş›Á
->
æags
 & 
CLIENT_UNIX_SOCKET
) {

1466 
	`¢´štf
(
³”id
,
³”id_Ën
,"%s:0",
£rv”
.
unixsock‘
);

1469 
	`ª‘FÜm©P“r
(
ş›Á
->
fd
,
³”id
,
³”id_Ën
);

1471 
	}
}

1477 *
	$g‘Cl›ÁP“rId
(
ş›Á
 *
c
) {

1478 
³”id
[
NET_PEER_ID_LEN
];

1480 ià(
c
->
³”id
 =ğ
NULL
) {

1481 
	`g’Cl›ÁP“rId
(
c
,
³”id
,(peerid));

1482 
c
->
³”id
 = 
	`sd¢ew
(peerid);

1484  
c
->
³”id
;

1485 
	}
}

1489 
sds
 
	$ÿtCl›ÁInfoSŒšg
(
sds
 
s
, 
ş›Á
 *client) {

1490 
æags
[16], 
ev’ts
[3], *
p
;

1491 
emask
;

1493 
p
 = 
æags
;

1494 ià(
ş›Á
->
æags
 & 
CLIENT_SLAVE
) {

1495 ià(
ş›Á
->
æags
 & 
CLIENT_MONITOR
)

1496 *
p
++ = 'O';

1498 *
p
++ = 'S';

1500 ià(
ş›Á
->
æags
 & 
CLIENT_MASTER
è*
p
++ = 'M';

1501 ià(
ş›Á
->
æags
 & 
CLIENT_MULTI
è*
p
++ = 'x';

1502 ià(
ş›Á
->
æags
 & 
CLIENT_BLOCKED
è*
p
++ = 'b';

1503 ià(
ş›Á
->
æags
 & 
CLIENT_DIRTY_CAS
è*
p
++ = 'd';

1504 ià(
ş›Á
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
è*
p
++ = 'c';

1505 ià(
ş›Á
->
æags
 & 
CLIENT_UNBLOCKED
è*
p
++ = 'u';

1506 ià(
ş›Á
->
æags
 & 
CLIENT_CLOSE_ASAP
è*
p
++ = 'A';

1507 ià(
ş›Á
->
æags
 & 
CLIENT_UNIX_SOCKET
è*
p
++ = 'U';

1508 ià(
ş›Á
->
æags
 & 
CLIENT_READONLY
è*
p
++ = 'r';

1509 ià(
p
 =ğ
æags
) *p++ = 'N';

1510 *
p
++ = '\0';

1512 
emask
 = 
ş›Á
->
fd
 =ğ-1 ? 0 : 
	`«G‘FeEv’ts
(
£rv”
.
–
,client->fd);

1513 
p
 = 
ev’ts
;

1514 ià(
emask
 & 
AE_READABLE
è*
p
++ = 'r';

1515 ià(
emask
 & 
AE_WRITABLE
è*
p
++ = 'w';

1516 *
p
 = '\0';

1517  
	`sdsÿtfmt
(
s
,

1519 (è
ş›Á
->
id
,

1520 
	`g‘Cl›ÁP“rId
(
ş›Á
),

1521 
ş›Á
->
fd
,

1522 
ş›Á
->
Çme
 ? (*)ş›Á->Çme->
±r
 : "",

1523 ()(
£rv”
.
unixtime
 - 
ş›Á
->
ùime
),

1524 ()(
£rv”
.
unixtime
 - 
ş›Á
->
Ï¡š‹¿ùiÚ
),

1525 
æags
,

1526 
ş›Á
->
db
->
id
,

1527 (è
	`diùSize
(
ş›Á
->
pubsub_chªÃls
),

1528 (è
	`li¡L’gth
(
ş›Á
->
pubsub_·‰”ns
),

1529 (
ş›Á
->
æags
 & 
CLIENT_MULTI
è? cl›Á->
m¡©e
.
couÁ
 : -1,

1530 (è
	`sd¦’
(
ş›Á
->
qu”ybuf
),

1531 (è
	`sd§va
(
ş›Á
->
qu”ybuf
),

1532 (è
ş›Á
->
buåos
,

1533 (è
	`li¡L’gth
(
ş›Á
->
»¶y
),

1534 (è
	`g‘Cl›ÁOuutBufãrMemÜyU§ge
(
ş›Á
),

1535 
ev’ts
,

1536 
ş›Á
->
Ï¡cmd
 ? cl›Á->Ï¡cmd->
Çme
 : "NULL");

1537 
	}
}

1539 
sds
 
	$g‘AÎCl›ÁsInfoSŒšg
() {

1540 
li¡Node
 *
Ê
;

1541 
li¡I‹r
 
li
;

1542 
ş›Á
 *client;

1543 
sds
 
o
 = 
	`sd¢ewËn
(
NULL
,200*
	`li¡L’gth
(
£rv”
.
ş›Ás
));

1544 
	`sdsş—r
(
o
);

1545 
	`li¡Rewšd
(
£rv”
.
ş›Ás
,&
li
);

1546 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

1547 
ş›Á
 = 
	`li¡NodeV®ue
(
Ê
);

1548 
o
 = 
	`ÿtCl›ÁInfoSŒšg
(o,
ş›Á
);

1549 
o
 = 
	`sdsÿ’
(o,"\n",1);

1551  
o
;

1552 
	}
}

1554 
	$ş›ÁCommªd
(
ş›Á
 *
c
) {

1555 
li¡Node
 *
Ê
;

1556 
li¡I‹r
 
li
;

1557 
ş›Á
 *client;

1559 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"li¡"è&& c->
¬gc
 == 2) {

1561 
sds
 
o
 = 
	`g‘AÎCl›ÁsInfoSŒšg
();

1562 
	`addR•lyBulkCBufãr
(
c
,
o
,
	`sd¦’
(o));

1563 
	`sdsä“
(
o
);

1564 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"»¶y"è&& c->
¬gc
 == 3) {

1566 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"on")) {

1567 
c
->
æags
 &ğ~(
CLIENT_REPLY_SKIP
|
CLIENT_REPLY_OFF
);

1568 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1569 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"off")) {

1570 
c
->
æags
 |ğ
CLIENT_REPLY_OFF
;

1571 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"skip")) {

1572 ià(!(
c
->
æags
 & 
CLIENT_REPLY_OFF
))

1573 
c
->
æags
 |ğ
CLIENT_REPLY_SKIP_NEXT
;

1575 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1578 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"kill")) {

1581 *
addr
 = 
NULL
;

1582 
ty³
 = -1;

1583 
ušt64_t
 
id
 = 0;

1584 
skme
 = 1;

1585 
kËd
 = 0, 
şo£_this_ş›Á
 = 0;

1587 ià(
c
->
¬gc
 == 3) {

1589 
addr
 = 
c
->
¬gv
[2]->
±r
;

1590 
skme
 = 0;

1591 } ià(
c
->
¬gc
 > 3) {

1592 
i
 = 2;

1595 
i
 < 
c
->
¬gc
) {

1596 
mÜ—rgs
 = 
c
->
¬gc
 > 
i
+1;

1598 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
,"id"è&& 
mÜ—rgs
) {

1599 
tmp
;

1601 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[
i
+1],&
tmp
,
NULL
)

1602 !ğ
C_OK
) ;

1603 
id
 = 
tmp
;

1604 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
,"ty³"è&& 
mÜ—rgs
) {

1605 
ty³
 = 
	`g‘Cl›ÁTy³ByName
(
c
->
¬gv
[
i
+1]->
±r
);

1606 ià(
ty³
 == -1) {

1607 
	`addR•lyE¼ÜFÜm©
(
c
,"Unknown clientype '%s'",

1608 (*è
c
->
¬gv
[
i
+1]->
±r
);

1611 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
,"addr"è&& 
mÜ—rgs
) {

1612 
addr
 = 
c
->
¬gv
[
i
+1]->
±r
;

1613 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
,"skme"è&& 
mÜ—rgs
) {

1614 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
+1]->
±r
,"yes")) {

1615 
skme
 = 1;

1616 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
+1]->
±r
,"no")) {

1617 
skme
 = 0;

1619 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1623 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1626 
i
 += 2;

1629 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1634 
	`li¡Rewšd
(
£rv”
.
ş›Ás
,&
li
);

1635 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

1636 
ş›Á
 = 
	`li¡NodeV®ue
(
Ê
);

1637 ià(
addr
 && 
	`¡rcmp
(
	`g‘Cl›ÁP“rId
(
ş›Á
),addr) != 0) ;

1638 ià(
ty³
 !ğ-1 && 
	`g‘Cl›ÁTy³
(
ş›Á
) !=ype) ;

1639 ià(
id
 !ğ0 && 
ş›Á
->id != id) ;

1640 ià(
c
 =ğ
ş›Á
 && 
skme
) ;

1643 ià(
c
 =ğ
ş›Á
) {

1644 
şo£_this_ş›Á
 = 1;

1646 
	`ä“Cl›Á
(
ş›Á
);

1648 
kËd
++;

1652 ià(
c
->
¬gc
 == 3) {

1653 ià(
kËd
 == 0)

1654 
	`addR•lyE¼Ü
(
c
,"No such client");

1656 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1658 
	`addR•lyLÚgLÚg
(
c
,
kËd
);

1663 ià(
şo£_this_ş›Á
è
c
->
æags
 |ğ
CLIENT_CLOSE_AFTER_REPLY
;

1664 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"£Šame"è&& c->
¬gc
 == 3) {

1665 
j
, 
Ën
 = 
	`sd¦’
(
c
->
¬gv
[2]->
±r
);

1666 *
p
 = 
c
->
¬gv
[2]->
±r
;

1670 ià(
Ën
 == 0) {

1671 ià(
c
->
Çme
è
	`deüRefCouÁ
(c->name);

1672 
c
->
Çme
 = 
NULL
;

1673 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1680 
j
 = 0; j < 
Ën
; j++) {

1681 ià(
p
[
j
] < '!' ||…[j] > '~') {

1682 
	`addR•lyE¼Ü
(
c
,

1688 ià(
c
->
Çme
è
	`deüRefCouÁ
(c->name);

1689 
c
->
Çme
 = c->
¬gv
[2];

1690 
	`šüRefCouÁ
(
c
->
Çme
);

1691 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1692 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"g‘Çme"è&& c->
¬gc
 == 2) {

1693 ià(
c
->
Çme
)

1694 
	`addR•lyBulk
(
c
,c->
Çme
);

1696 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

1697 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"·u£"è&& c->
¬gc
 == 3) {

1698 
du¿tiÚ
;

1700 ià(
	`g‘TimeoutFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
du¿tiÚ
,
UNIT_MILLISECONDS
)

1701 !ğ
C_OK
) ;

1702 
	`·u£Cl›Ás
(
du¿tiÚ
);

1703 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1705 
	`addR•lyE¼Ü
(
c
, "Syntaxƒrror,ry CLIENT (LIST | KILL | GETNAME | SETNAME | PAUSE | REPLY)");

1707 
	}
}

1718 
	$£cur™yW¬nšgCommªd
(
ş›Á
 *
c
) {

1719 
time_t
 
logged_time
;

1720 
time_t
 
now
 = 
	`time
(
NULL
);

1722 ià(
	`Ïbs
(
now
-
logged_time
) > 60) {

1723 
	`£rv”Log
(
LL_WARNING
,"Possible SECURITY ATTACK detected. It†ooks†ike somebody is sending POST or Host: commandso Redis. This is†ikely dueo‡n‡ttacker‡ttemptingo use Cross Protocol Scriptingo compromise your Redis instance. Connection‡borted.");

1724 
logged_time
 = 
now
;

1726 
	`ä“Cl›ÁAsync
(
c
);

1727 
	}
}

1732 
	$»wr™eCl›ÁCommªdVeùÜ
(
ş›Á
 *
c
, 
¬gc
, ...) {

1733 
va_li¡
 
­
;

1734 
j
;

1735 
robj
 **
¬gv
;

1737 
¬gv
 = 
	`zm®loc
((
robj
*)*
¬gc
);

1738 
	`va_¡¬t
(
­
,
¬gc
);

1739 
j
 = 0; j < 
¬gc
; j++) {

1740 
robj
 *
a
;

1742 
a
 = 
	`va_¬g
(
­
, 
robj
*);

1743 
¬gv
[
j
] = 
a
;

1744 
	`šüRefCouÁ
(
a
);

1749 
j
 = 0; j < 
c
->
¬gc
; j++è
	`deüRefCouÁ
(c->
¬gv
[j]);

1750 
	`zä“
(
c
->
¬gv
);

1752 
c
->
¬gv
 =‡rgv;

1753 
c
->
¬gc
 =‡rgc;

1754 
c
->
cmd
 = 
	`lookupCommªdOrOrigš®
(c->
¬gv
[0]->
±r
);

1755 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
cmd
 != NULL);

1756 
	`va_’d
(
­
);

1757 
	}
}

1760 
	$»¶aûCl›ÁCommªdVeùÜ
(
ş›Á
 *
c
, 
¬gc
, 
robj
 **
¬gv
) {

1761 
	`ä“Cl›ÁArgv
(
c
);

1762 
	`zä“
(
c
->
¬gv
);

1763 
c
->
¬gv
 =‡rgv;

1764 
c
->
¬gc
 =‡rgc;

1765 
c
->
cmd
 = 
	`lookupCommªdOrOrigš®
(c->
¬gv
[0]->
±r
);

1766 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
cmd
 != NULL);

1767 
	}
}

1780 
	$»wr™eCl›ÁCommªdArgum’t
(
ş›Á
 *
c
, 
i
, 
robj
 *
Ãwv®
) {

1781 
robj
 *
Şdv®
;

1783 ià(
i
 >ğ
c
->
¬gc
) {

1784 
c
->
¬gv
 = 
	`z»®loc
(c->¬gv,(
robj
*)*(
i
+1));

1785 
c
->
¬gc
 = 
i
+1;

1786 
c
->
¬gv
[
i
] = 
NULL
;

1788 
Şdv®
 = 
c
->
¬gv
[
i
];

1789 
c
->
¬gv
[
i
] = 
Ãwv®
;

1790 
	`šüRefCouÁ
(
Ãwv®
);

1791 ià(
Şdv®
è
	`deüRefCouÁ
(oldval);

1794 ià(
i
 == 0) {

1795 
c
->
cmd
 = 
	`lookupCommªdOrOrigš®
(c->
¬gv
[0]->
±r
);

1796 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
cmd
 != NULL);

1798 
	}
}

1813 
	$g‘Cl›ÁOuutBufãrMemÜyU§ge
(
ş›Á
 *
c
) {

1814 
li¡_™em_size
 = (
li¡Node
)+5;

1818  
c
->
»¶y_by‹s
 + (
li¡_™em_size
*
	`li¡L’gth
(c->
»¶y
));

1819 
	}
}

1830 
	$g‘Cl›ÁTy³
(
ş›Á
 *
c
) {

1831 ià(
c
->
æags
 & 
CLIENT_MASTER
è 
CLIENT_TYPE_MASTER
;

1832 ià((
c
->
æags
 & 
CLIENT_SLAVE
è&& !(c->æag & 
CLIENT_MONITOR
))

1833  
CLIENT_TYPE_SLAVE
;

1834 ià(
c
->
æags
 & 
CLIENT_PUBSUB
è 
CLIENT_TYPE_PUBSUB
;

1835  
CLIENT_TYPE_NORMAL
;

1836 
	}
}

1838 
	$g‘Cl›ÁTy³ByName
(*
Çme
) {

1839 ià(!
	`¡rÿ£cmp
(
Çme
,"nÜm®")è 
CLIENT_TYPE_NORMAL
;

1840 ià(!
	`¡rÿ£cmp
(
Çme
,"¦ave")è 
CLIENT_TYPE_SLAVE
;

1841 ià(!
	`¡rÿ£cmp
(
Çme
,"pubsub")è 
CLIENT_TYPE_PUBSUB
;

1842 ià(!
	`¡rÿ£cmp
(
Çme
,"ma¡”")è 
CLIENT_TYPE_MASTER
;

1844 
	}
}

1846 *
	$g‘Cl›ÁTy³Name
(
şass
) {

1847 
şass
) {

1848 
CLIENT_TYPE_NORMAL
:  "normal";

1849 
CLIENT_TYPE_SLAVE
:  "slave";

1850 
CLIENT_TYPE_PUBSUB
:  "pubsub";

1851 
CLIENT_TYPE_MASTER
:  "master";

1852 :  
NULL
;

1854 
	}
}

1862 
	$checkCl›ÁOuutBufãrLim™s
(
ş›Á
 *
c
) {

1863 
soá
 = 0, 
h¬d
 = 0, 
şass
;

1864 
u£d_mem
 = 
	`g‘Cl›ÁOuutBufãrMemÜyU§ge
(
c
);

1866 
şass
 = 
	`g‘Cl›ÁTy³
(
c
);

1869 ià(
şass
 =ğ
CLIENT_TYPE_MASTER
èşas ğ
CLIENT_TYPE_NORMAL
;

1871 ià(
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
h¬d_lim™_by‹s
 &&

1872 
u£d_mem
 >ğ
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
h¬d_lim™_by‹s
)

1873 
h¬d
 = 1;

1874 ià(
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_by‹s
 &&

1875 
u£d_mem
 >ğ
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_by‹s
)

1876 
soá
 = 1;

1880 ià(
soá
) {

1881 ià(
c
->
obuf_soá_lim™_»ached_time
 == 0) {

1882 
c
->
obuf_soá_lim™_»ached_time
 = 
£rv”
.
unixtime
;

1883 
soá
 = 0;

1885 
time_t
 
–­£d
 = 
£rv”
.
unixtime
 - 
c
->
obuf_soá_lim™_»ached_time
;

1887 ià(
–­£d
 <=

1888 
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_£cÚds
) {

1889 
soá
 = 0;

1895 
c
->
obuf_soá_lim™_»ached_time
 = 0;

1897  
soá
 || 
h¬d
;

1898 
	}
}

1907 
	$asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
ş›Á
 *
c
) {

1908 
	`£rv”As£¹
(
c
->
»¶y_by‹s
 < 
SIZE_MAX
-(1024*64));

1909 ià(
c
->
»¶y_by‹s
 =ğ0 || c->
æags
 & 
CLIENT_CLOSE_ASAP
) ;

1910 ià(
	`checkCl›ÁOuutBufãrLim™s
(
c
)) {

1911 
sds
 
ş›Á
 = 
	`ÿtCl›ÁInfoSŒšg
(
	`sd£m±y
(),
c
);

1913 
	`ä“Cl›ÁAsync
(
c
);

1914 
	`£rv”Log
(
LL_WARNING
,"Cl›Á % scheduËdØbşo£d ASAP fÜ ov”comšg oàouuˆbufã¸lim™s.", 
ş›Á
);

1915 
	`sdsä“
(
ş›Á
);

1917 
	}
}

1923 
	$æushSÏvesOuutBufãrs
() {

1924 
li¡I‹r
 
li
;

1925 
li¡Node
 *
Ê
;

1927 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

1928 (
Ê
 = 
	`li¡Next
(&
li
))) {

1929 
ş›Á
 *
¦ave
 = 
	`li¡NodeV®ue
(
Ê
);

1930 
ev’ts
;

1938 
ev’ts
 = 
	`«G‘FeEv’ts
(
£rv”
.
–
,
¦ave
->
fd
);

1939 ià(
ev’ts
 & 
AE_WRITABLE
 &&

1940 
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_ONLINE
 &&

1941 
	`ş›ÁHasP’dšgR•l›s
(
¦ave
))

1943 
	`wr™eToCl›Á
(
¦ave
->
fd
,slave,0);

1946 
	}
}

1965 
	$·u£Cl›Ás
(
m¡ime_t
 
’d
) {

1966 ià(!
£rv”
.
ş›Ás_·u£d
 || 
’d
 > s”v”.
ş›Ás_·u£_’d_time
)

1967 
£rv”
.
ş›Ás_·u£_’d_time
 = 
’d
;

1968 
£rv”
.
ş›Ás_·u£d
 = 1;

1969 
	}
}

1973 
	$ş›ÁsA»Pau£d
() {

1974 ià(
£rv”
.
ş›Ás_·u£d
 &&

1975 
£rv”
.
ş›Ás_·u£_’d_time
 < s”v”.
m¡ime
)

1977 
li¡Node
 *
Ê
;

1978 
li¡I‹r
 
li
;

1979 
ş›Á
 *
c
;

1981 
£rv”
.
ş›Ás_·u£d
 = 0;

1985 
	`li¡Rewšd
(
£rv”
.
ş›Ás
,&
li
);

1986 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

1987 
c
 = 
	`li¡NodeV®ue
(
Ê
);

1991 ià(
c
->
æags
 & (
CLIENT_SLAVE
|
CLIENT_BLOCKED
)) ;

1992 
c
->
æags
 |ğ
CLIENT_UNBLOCKED
;

1993 
	`li¡AddNodeTa
(
£rv”
.
unblocked_ş›Ás
,
c
);

1996  
£rv”
.
ş›Ás_·u£d
;

1997 
	}
}

2011 
	$´oûssEv’tsWheBlocked
() {

2012 
™”©iÚs
 = 4;

2013 
couÁ
 = 0;

2014 
™”©iÚs
--) {

2015 
ev’ts
 = 0;

2016 
ev’ts
 +ğ
	`«ProûssEv’ts
(
£rv”
.
–
, 
AE_FILE_EVENTS
|
AE_DONT_WAIT
);

2017 
ev’ts
 +ğ
	`hªdËCl›ÁsW™hP’dšgWr™es
();

2018 ià(!
ev’ts
) ;

2019 
couÁ
 +ğ
ev’ts
;

2021  
couÁ
;

2022 
	}
}

	@notify.c

30 
	~"£rv”.h
"

40 
	$key¥aûEv’tsSŒšgToFÏgs
(*
şas£s
) {

41 *
p
 = 
şas£s
;

42 
c
, 
æags
 = 0;

44 (
c
 = *
p
++) != '\0') {

45 
c
) {

46 'A': 
æags
 |ğ
NOTIFY_ALL
; ;

47 'g': 
æags
 |ğ
NOTIFY_GENERIC
; ;

48 '$': 
æags
 |ğ
NOTIFY_STRING
; ;

49 'l': 
æags
 |ğ
NOTIFY_LIST
; ;

50 's': 
æags
 |ğ
NOTIFY_SET
; ;

51 'h': 
æags
 |ğ
NOTIFY_HASH
; ;

52 'z': 
æags
 |ğ
NOTIFY_ZSET
; ;

53 'x': 
æags
 |ğ
NOTIFY_EXPIRED
; ;

54 'e': 
æags
 |ğ
NOTIFY_EVICTED
; ;

55 'K': 
æags
 |ğ
NOTIFY_KEYSPACE
; ;

56 'E': 
æags
 |ğ
NOTIFY_KEYEVENT
; ;

60  
æags
;

61 
	}
}

67 
sds
 
	$key¥aûEv’tsFÏgsToSŒšg
(
æags
) {

68 
sds
 
»s
;

70 
»s
 = 
	`sd£m±y
();

71 ià((
æags
 & 
NOTIFY_ALL
) == NOTIFY_ALL) {

72 
»s
 = 
	`sdsÿ’
(res,"A",1);

74 ià(
æags
 & 
NOTIFY_GENERIC
è
»s
 = 
	`sdsÿ’
(res,"g",1);

75 ià(
æags
 & 
NOTIFY_STRING
è
»s
 = 
	`sdsÿ’
(res,"$",1);

76 ià(
æags
 & 
NOTIFY_LIST
è
»s
 = 
	`sdsÿ’
(res,"l",1);

77 ià(
æags
 & 
NOTIFY_SET
è
»s
 = 
	`sdsÿ’
(res,"s",1);

78 ià(
æags
 & 
NOTIFY_HASH
è
»s
 = 
	`sdsÿ’
(res,"h",1);

79 ià(
æags
 & 
NOTIFY_ZSET
è
»s
 = 
	`sdsÿ’
(res,"z",1);

80 ià(
æags
 & 
NOTIFY_EXPIRED
è
»s
 = 
	`sdsÿ’
(res,"x",1);

81 ià(
æags
 & 
NOTIFY_EVICTED
è
»s
 = 
	`sdsÿ’
(res,"e",1);

83 ià(
æags
 & 
NOTIFY_KEYSPACE
è
»s
 = 
	`sdsÿ’
(res,"K",1);

84 ià(
æags
 & 
NOTIFY_KEYEVENT
è
»s
 = 
	`sdsÿ’
(res,"E",1);

85  
»s
;

86 
	}
}

95 
	$nÙifyKey¥aûEv’t
(
ty³
, *
ev’t
, 
robj
 *
key
, 
dbid
) {

96 
sds
 
chª
;

97 
robj
 *
chªobj
, *
ev’tobj
;

98 
Ën
 = -1;

99 
buf
[24];

102 ià(!(
£rv”
.
nÙify_key¥aû_ev’ts
 & 
ty³
)) ;

104 
ev’tobj
 = 
	`ü—‹SŒšgObjeù
(
ev’t
,
	`¡¾’
(event));

107 ià(
£rv”
.
nÙify_key¥aû_ev’ts
 & 
NOTIFY_KEYSPACE
) {

108 
chª
 = 
	`sd¢ewËn
("__keyspace@",11);

109 
Ën
 = 
	`Î2¡ršg
(
buf
,(buf),
dbid
);

110 
chª
 = 
	`sdsÿ’
(chª, 
buf
, 
Ën
);

111 
chª
 = 
	`sdsÿ’
(chan, "__:", 3);

112 
chª
 = 
	`sdsÿtsds
(chª, 
key
->
±r
);

113 
chªobj
 = 
	`ü—‹Objeù
(
OBJ_STRING
, 
chª
);

114 
	`pubsubPublishMes§ge
(
chªobj
, 
ev’tobj
);

115 
	`deüRefCouÁ
(
chªobj
);

119 ià(
£rv”
.
nÙify_key¥aû_ev’ts
 & 
NOTIFY_KEYEVENT
) {

120 
chª
 = 
	`sd¢ewËn
("__keyevent@",11);

121 ià(
Ën
 =ğ-1èËÀğ
	`Î2¡ršg
(
buf
,(buf),
dbid
);

122 
chª
 = 
	`sdsÿ’
(chª, 
buf
, 
Ën
);

123 
chª
 = 
	`sdsÿ’
(chan, "__:", 3);

124 
chª
 = 
	`sdsÿtsds
(chª, 
ev’tobj
->
±r
);

125 
chªobj
 = 
	`ü—‹Objeù
(
OBJ_STRING
, 
chª
);

126 
	`pubsubPublishMes§ge
(
chªobj
, 
key
);

127 
	`deüRefCouÁ
(
chªobj
);

129 
	`deüRefCouÁ
(
ev’tobj
);

130 
	}
}

	@object.c

31 
	~"£rv”.h
"

32 
	~<m©h.h
>

33 
	~<ùy³.h
>

35 #ifdeà
__CYGWIN__


36 
	#¡¹Şd
(
a
,
b
è(()
	`¡¹od
(×),(b)))

	)

41 
robj
 *
	$ü—‹Objeù
(
ty³
, *
±r
) {

42 
robj
 *
o
 = 
	`zm®loc
((*o));

43 
o
->
ty³
 =ype;

44 
o
->
’codšg
 = 
OBJ_ENCODING_RAW
;

45 
o
->
±r
 =…tr;

46 
o
->
»fcouÁ
 = 1;

50 ià(
£rv”
.
maxmemÜy_pŞicy
 & 
MAXMEMORY_FLAG_LFU
) {

51 
o
->
Ìu
 = (
	`LFUG‘TimeInMšu‹s
()<<8è| 
LFU_INIT_VAL
;

53 
o
->
Ìu
 = 
	`LRU_CLOCK
();

55  
o
;

56 
	}
}

69 
robj
 *
	$makeObjeùSh¬ed
(
robj
 *
o
) {

70 
	`£rv”As£¹
(
o
->
»fcouÁ
 == 1);

71 
o
->
»fcouÁ
 = 
OBJ_SHARED_REFCOUNT
;

72  
o
;

73 
	}
}

77 
robj
 *
	$ü—‹RawSŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
) {

78  
	`ü—‹Objeù
(
OBJ_STRING
, 
	`sd¢ewËn
(
±r
,
Ën
));

79 
	}
}

84 
robj
 *
	$ü—‹EmbeddedSŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
) {

85 
robj
 *
o
 = 
	`zm®loc
(Ôobj)+(
sdshdr8
)+
Ën
+1);

86 
sdshdr8
 *
sh
 = (*)(
o
+1);

88 
o
->
ty³
 = 
OBJ_STRING
;

89 
o
->
’codšg
 = 
OBJ_ENCODING_EMBSTR
;

90 
o
->
±r
 = 
sh
+1;

91 
o
->
»fcouÁ
 = 1;

92 ià(
£rv”
.
maxmemÜy_pŞicy
 & 
MAXMEMORY_FLAG_LFU
) {

93 
o
->
Ìu
 = (
	`LFUG‘TimeInMšu‹s
()<<8è| 
LFU_INIT_VAL
;

95 
o
->
Ìu
 = 
	`LRU_CLOCK
();

98 
sh
->
Ën
 =†en;

99 
sh
->
®loc
 = 
Ën
;

100 
sh
->
æags
 = 
SDS_TYPE_8
;

101 ià(
±r
) {

102 
	`memıy
(
sh
->
buf
,
±r
,
Ën
);

103 
sh
->
buf
[
Ën
] = '\0';

105 
	`mem£t
(
sh
->
buf
,0,
Ën
+1);

107  
o
;

108 
	}
}

116 
	#OBJ_ENCODING_EMBSTR_SIZE_LIMIT
 44

	)

117 
robj
 *
	$ü—‹SŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
) {

118 ià(
Ën
 <ğ
OBJ_ENCODING_EMBSTR_SIZE_LIMIT
)

119  
	`ü—‹EmbeddedSŒšgObjeù
(
±r
,
Ën
);

121  
	`ü—‹RawSŒšgObjeù
(
±r
,
Ën
);

122 
	}
}

124 
robj
 *
	$ü—‹SŒšgObjeùFromLÚgLÚg
(
v®ue
) {

125 
robj
 *
o
;

126 ià(
v®ue
 >ğ0 && v®u< 
OBJ_SHARED_INTEGERS
) {

127 
	`šüRefCouÁ
(
sh¬ed
.
š‹g”s
[
v®ue
]);

128 
o
 = 
sh¬ed
.
š‹g”s
[
v®ue
];

130 ià(
v®ue
 >ğ
LONG_MIN
 && v®u<ğ
LONG_MAX
) {

131 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
, 
NULL
);

132 
o
->
’codšg
 = 
OBJ_ENCODING_INT
;

133 
o
->
±r
 = (*)(()
v®ue
);

135 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sdsäomlÚglÚg
(
v®ue
));

138  
o
;

139 
	}
}

147 
robj
 *
	$ü—‹SŒšgObjeùFromLÚgDoubË
(
v®ue
, 
humªä›ndly
) {

148 
buf
[256];

149 
Ën
 = 
	`ld2¡ršg
(
buf
,(buf),
v®ue
,
humªä›ndly
);

150  
	`ü—‹SŒšgObjeù
(
buf
,
Ën
);

151 
	}
}

161 
robj
 *
	$dupSŒšgObjeù
(cÚ¡ 
robj
 *
o
) {

162 
robj
 *
d
;

164 
	`£rv”As£¹
(
o
->
ty³
 =ğ
OBJ_STRING
);

166 
o
->
’codšg
) {

167 
OBJ_ENCODING_RAW
:

168  
	`ü—‹RawSŒšgObjeù
(
o
->
±r
,
	`sd¦’
(o->ptr));

169 
OBJ_ENCODING_EMBSTR
:

170  
	`ü—‹EmbeddedSŒšgObjeù
(
o
->
±r
,
	`sd¦’
(o->ptr));

171 
OBJ_ENCODING_INT
:

172 
d
 = 
	`ü—‹Objeù
(
OBJ_STRING
, 
NULL
);

173 
d
->
’codšg
 = 
OBJ_ENCODING_INT
;

174 
d
->
±r
 = 
o
->ptr;

175  
d
;

177 
	`£rv”Pªic
("Wrongƒncoding.");

180 
	}
}

182 
robj
 *
	$ü—‹Quickli¡Objeù
() {

183 
quickli¡
 *
l
 = 
	`quickli¡C»©e
();

184 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_LIST
,
l
);

185 
o
->
’codšg
 = 
OBJ_ENCODING_QUICKLIST
;

186  
o
;

187 
	}
}

189 
robj
 *
	$ü—‹Zli¡Objeù
() {

190 *
zl
 = 
	`zli¡New
();

191 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_LIST
,
zl
);

192 
o
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

193  
o
;

194 
	}
}

196 
robj
 *
	$ü—‹S‘Objeù
() {

197 
diù
 *
d
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

198 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_SET
,
d
);

199 
o
->
’codšg
 = 
OBJ_ENCODING_HT
;

200  
o
;

201 
	}
}

203 
robj
 *
	$ü—‹IÁ£tObjeù
() {

204 
št£t
 *
is
 = 
	`št£tNew
();

205 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_SET
,
is
);

206 
o
->
’codšg
 = 
OBJ_ENCODING_INTSET
;

207  
o
;

208 
	}
}

210 
robj
 *
	$ü—‹HashObjeù
() {

211 *
zl
 = 
	`zli¡New
();

212 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_HASH
, 
zl
);

213 
o
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

214  
o
;

215 
	}
}

217 
robj
 *
	$ü—‹Z£tObjeù
() {

218 
z£t
 *
zs
 = 
	`zm®loc
((*zs));

219 
robj
 *
o
;

221 
zs
->
diù
 = 
	`diùC»©e
(&
z£tDiùTy³
,
NULL
);

222 
zs
->
z¦
 = 
	`z¦C»©e
();

223 
o
 = 
	`ü—‹Objeù
(
OBJ_ZSET
,
zs
);

224 
o
->
’codšg
 = 
OBJ_ENCODING_SKIPLIST
;

225  
o
;

226 
	}
}

228 
robj
 *
	$ü—‹Z£tZli¡Objeù
() {

229 *
zl
 = 
	`zli¡New
();

230 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_ZSET
,
zl
);

231 
o
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

232  
o
;

233 
	}
}

235 
robj
 *
	$ü—‹ModuËObjeù
(
moduËTy³
 *
mt
, *
v®ue
) {

236 
moduËV®ue
 *
mv
 = 
	`zm®loc
((*mv));

237 
mv
->
ty³
 = 
mt
;

238 
mv
->
v®ue
 = value;

239  
	`ü—‹Objeù
(
OBJ_MODULE
,
mv
);

240 
	}
}

242 
	$ä“SŒšgObjeù
(
robj
 *
o
) {

243 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_RAW
) {

244 
	`sdsä“
(
o
->
±r
);

246 
	}
}

248 
	$ä“Li¡Objeù
(
robj
 *
o
) {

249 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

250 
	`quickli¡R–—£
(
o
->
±r
);

252 
	`£rv”Pªic
("Unknown†istƒncodingype");

254 
	}
}

256 
	$ä“S‘Objeù
(
robj
 *
o
) {

257 
o
->
’codšg
) {

258 
OBJ_ENCODING_HT
:

259 
	`diùR–—£
((
diù
*è
o
->
±r
);

261 
OBJ_ENCODING_INTSET
:

262 
	`zä“
(
o
->
±r
);

265 
	`£rv”Pªic
("Unknown setƒncodingype");

267 
	}
}

269 
	$ä“Z£tObjeù
(
robj
 *
o
) {

270 
z£t
 *
zs
;

271 
o
->
’codšg
) {

272 
OBJ_ENCODING_SKIPLIST
:

273 
zs
 = 
o
->
±r
;

274 
	`diùR–—£
(
zs
->
diù
);

275 
	`z¦F»e
(
zs
->
z¦
);

276 
	`zä“
(
zs
);

278 
OBJ_ENCODING_ZIPLIST
:

279 
	`zä“
(
o
->
±r
);

282 
	`£rv”Pªic
("Unknown sorted setƒncoding");

284 
	}
}

286 
	$ä“HashObjeù
(
robj
 *
o
) {

287 
o
->
’codšg
) {

288 
OBJ_ENCODING_HT
:

289 
	`diùR–—£
((
diù
*è
o
->
±r
);

291 
OBJ_ENCODING_ZIPLIST
:

292 
	`zä“
(
o
->
±r
);

295 
	`£rv”Pªic
("Unknown hashƒncodingype");

298 
	}
}

300 
	$ä“ModuËObjeù
(
robj
 *
o
) {

301 
moduËV®ue
 *
mv
 = 
o
->
±r
;

302 
mv
->
ty³
->
	`ä“
(mv->
v®ue
);

303 
	`zä“
(
mv
);

304 
	}
}

306 
	$šüRefCouÁ
(
robj
 *
o
) {

307 ià(
o
->
»fcouÁ
 !ğ
OBJ_SHARED_REFCOUNT
) o->refcount++;

308 
	}
}

310 
	$deüRefCouÁ
(
robj
 *
o
) {

311 ià(
o
->
»fcouÁ
 == 1) {

312 
o
->
ty³
) {

313 
OBJ_STRING
: 
	`ä“SŒšgObjeù
(
o
); ;

314 
OBJ_LIST
: 
	`ä“Li¡Objeù
(
o
); ;

315 
OBJ_SET
: 
	`ä“S‘Objeù
(
o
); ;

316 
OBJ_ZSET
: 
	`ä“Z£tObjeù
(
o
); ;

317 
OBJ_HASH
: 
	`ä“HashObjeù
(
o
); ;

318 
OBJ_MODULE
: 
	`ä“ModuËObjeù
(
o
); ;

319 : 
	`£rv”Pªic
("Unknown objectype"); ;

321 
	`zä“
(
o
);

323 ià(
o
->
»fcouÁ
 <ğ0è
	`£rv”Pªic
("decrRefCount‡gainst„efcount <= 0");

324 ià(
o
->
»fcouÁ
 !ğ
OBJ_SHARED_REFCOUNT
) o->refcount--;

326 
	}
}

331 
	$deüRefCouÁVoid
(*
o
) {

332 
	`deüRefCouÁ
(
o
);

333 
	}
}

347 
robj
 *
	$»£tRefCouÁ
(
robj
 *
obj
) {

348 
obj
->
»fcouÁ
 = 0;

349  
obj
;

350 
	}
}

352 
	$checkTy³
(
ş›Á
 *
c
, 
robj
 *
o
, 
ty³
) {

353 ià(
o
->
ty³
 !=ype) {

354 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

358 
	}
}

360 
	$isSdsR•»£ÁabËAsLÚgLÚg
(
sds
 
s
, *
Îv®
) {

361  
	`¡ršg2Î
(
s
,
	`sd¦’
(s),
Îv®
è? 
C_OK
 : 
C_ERR
;

362 
	}
}

364 
	$isObjeùR•»£ÁabËAsLÚgLÚg
(
robj
 *
o
, *
Îv®
) {

365 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

366 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

367 ià(
Îv®
è*Îv® = (è
o
->
±r
;

368  
C_OK
;

370  
	`isSdsR•»£ÁabËAsLÚgLÚg
(
o
->
±r
,
Îv®
);

372 
	}
}

375 
robj
 *
	$ŒyObjeùEncodšg
(
robj
 *
o
) {

376 
v®ue
;

377 
sds
 
s
 = 
o
->
±r
;

378 
size_t
 
Ën
;

384 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

389 ià(!
	`sdsEncodedObjeù
(
o
))  o;

394 ià(
o
->
»fcouÁ
 > 1)  o;

399 
Ën
 = 
	`sd¦’
(
s
);

400 ià(
Ën
 <ğ20 && 
	`¡ršg2l
(
s
,Ën,&
v®ue
)) {

405 ià((
£rv”
.
maxmemÜy
 == 0 ||

406 !(
£rv”
.
maxmemÜy_pŞicy
 & 
MAXMEMORY_FLAG_NO_SHARED_INTEGERS
)) &&

407 
v®ue
 >= 0 &&

408 
v®ue
 < 
OBJ_SHARED_INTEGERS
)

410 
	`deüRefCouÁ
(
o
);

411 
	`šüRefCouÁ
(
sh¬ed
.
š‹g”s
[
v®ue
]);

412  
sh¬ed
.
š‹g”s
[
v®ue
];

414 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_RAW
è
	`sdsä“
(o->
±r
);

415 
o
->
’codšg
 = 
OBJ_ENCODING_INT
;

416 
o
->
±r
 = (*è
v®ue
;

417  
o
;

425 ià(
Ën
 <ğ
OBJ_ENCODING_EMBSTR_SIZE_LIMIT
) {

426 
robj
 *
emb
;

428 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_EMBSTR
)  o;

429 
emb
 = 
	`ü—‹EmbeddedSŒšgObjeù
(
s
,
	`sd¦’
(s));

430 
	`deüRefCouÁ
(
o
);

431  
emb
;

443 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_RAW
 &&

444 
	`sd§va
(
s
è> 
Ën
/10)

446 
o
->
±r
 = 
	`sdsRemoveF»eS·û
(o->ptr);

450  
o
;

451 
	}
}

455 
robj
 *
	$g‘DecodedObjeù
(
robj
 *
o
) {

456 
robj
 *
dec
;

458 ià(
	`sdsEncodedObjeù
(
o
)) {

459 
	`šüRefCouÁ
(
o
);

460  
o
;

462 ià(
o
->
ty³
 =ğ
OBJ_STRING
 && o->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

463 
buf
[32];

465 
	`Î2¡ršg
(
buf
,32,()
o
->
±r
);

466 
dec
 = 
	`ü—‹SŒšgObjeù
(
buf
,
	`¡¾’
(buf));

467  
dec
;

469 
	`£rv”Pªic
("Unknownƒncodingype");

471 
	}
}

481 
	#REDIS_COMPARE_BINARY
 (1<<0)

	)

482 
	#REDIS_COMPARE_COLL
 (1<<1)

	)

484 
	$com·»SŒšgObjeùsW™hFÏgs
(
robj
 *
a
,„obj *
b
, 
æags
) {

485 
	`£rv”As£¹W™hInfo
(
NULL
,
a
,a->
ty³
 =ğ
OBJ_STRING
 && 
b
->type == OBJ_STRING);

486 
buç
[128], 
bufb
[128], *
a¡r
, *
b¡r
;

487 
size_t
 
®’
, 
bËn
, 
mšËn
;

489 ià(
a
 =ğ
b
)  0;

490 ià(
	`sdsEncodedObjeù
(
a
)) {

491 
a¡r
 = 
a
->
±r
;

492 
®’
 = 
	`sd¦’
(
a¡r
);

494 
®’
 = 
	`Î2¡ršg
(
buç
,(buç),(è
a
->
±r
);

495 
a¡r
 = 
buç
;

497 ià(
	`sdsEncodedObjeù
(
b
)) {

498 
b¡r
 = 
b
->
±r
;

499 
bËn
 = 
	`sd¦’
(
b¡r
);

501 
bËn
 = 
	`Î2¡ršg
(
bufb
,(bufb),(è
b
->
±r
);

502 
b¡r
 = 
bufb
;

504 ià(
æags
 & 
REDIS_COMPARE_COLL
) {

505  
	`¡rcŞl
(
a¡r
,
b¡r
);

507 
cmp
;

509 
mšËn
 = (
®’
 < 
bËn
) ?‡len : blen;

510 
cmp
 = 
	`memcmp
(
a¡r
,
b¡r
,
mšËn
);

511 ià(
cmp
 =ğ0è 
®’
-
bËn
;

512  
cmp
;

514 
	}
}

517 
	$com·»SŒšgObjeùs
(
robj
 *
a
,„obj *
b
) {

518  
	`com·»SŒšgObjeùsW™hFÏgs
(
a
,
b
,
REDIS_COMPARE_BINARY
);

519 
	}
}

522 
	$cŞÏ‹SŒšgObjeùs
(
robj
 *
a
,„obj *
b
) {

523  
	`com·»SŒšgObjeùsW™hFÏgs
(
a
,
b
,
REDIS_COMPARE_COLL
);

524 
	}
}

530 
	$equ®SŒšgObjeùs
(
robj
 *
a
,„obj *
b
) {

531 ià(
a
->
’codšg
 =ğ
OBJ_ENCODING_INT
 &&

532 
b
->
’codšg
 =ğ
OBJ_ENCODING_INT
){

535  
a
->
±r
 =ğ
b
->ptr;

537  
	`com·»SŒšgObjeùs
(
a
,
b
) == 0;

539 
	}
}

541 
size_t
 
	$¡ršgObjeùL’
(
robj
 *
o
) {

542 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

543 ià(
	`sdsEncodedObjeù
(
o
)) {

544  
	`sd¦’
(
o
->
±r
);

546  
	`sdig™s10
(()
o
->
±r
);

548 
	}
}

550 
	$g‘DoubËFromObjeù
(cÚ¡ 
robj
 *
o
, *
rg‘
) {

551 
v®ue
;

552 *
•Œ
;

554 ià(
o
 =ğ
NULL
) {

555 
v®ue
 = 0;

557 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

558 ià(
	`sdsEncodedObjeù
(
o
)) {

559 
”ºo
 = 0;

560 
v®ue
 = 
	`¡¹od
(
o
->
±r
, &
•Œ
);

561 ià(
	`is¥aû
(((cÚ¡ *)
o
->
±r
)[0]) ||

562 
•Œ
[0] != '\0' ||

563 (
”ºo
 =ğ
ERANGE
 &&

564 (
v®ue
 =ğ
HUGE_VAL
 || value == -HUGE_VAL || value == 0)) ||

565 
”ºo
 =ğ
EINVAL
 ||

566 
	`i¢ª
(
v®ue
))

567  
C_ERR
;

568 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

569 
v®ue
 = ()
o
->
±r
;

571 
	`£rv”Pªic
("Unknown stringƒncoding");

574 *
rg‘
 = 
v®ue
;

575  
C_OK
;

576 
	}
}

578 
	$g‘DoubËFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
) {

579 
v®ue
;

580 ià(
	`g‘DoubËFromObjeù
(
o
, &
v®ue
è!ğ
C_OK
) {

581 ià(
msg
 !ğ
NULL
) {

582 
	`addR•lyE¼Ü
(
c
,(*)
msg
);

584 
	`addR•lyE¼Ü
(
c
,"value is‚ot‡ valid float");

586  
C_ERR
;

588 *
rg‘
 = 
v®ue
;

589  
C_OK
;

590 
	}
}

592 
	$g‘LÚgDoubËFromObjeù
(
robj
 *
o
, *
rg‘
) {

593 
v®ue
;

594 *
•Œ
;

596 ià(
o
 =ğ
NULL
) {

597 
v®ue
 = 0;

599 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

600 ià(
	`sdsEncodedObjeù
(
o
)) {

601 
”ºo
 = 0;

602 
v®ue
 = 
	`¡¹Şd
(
o
->
±r
, &
•Œ
);

603 ià(
	`is¥aû
(((*)
o
->
±r
)[0]è|| 
•Œ
[0] != '\0' ||

604 
”ºo
 =ğ
ERANGE
 || 
	`i¢ª
(
v®ue
))

605  
C_ERR
;

606 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

607 
v®ue
 = ()
o
->
±r
;

609 
	`£rv”Pªic
("Unknown stringƒncoding");

612 *
rg‘
 = 
v®ue
;

613  
C_OK
;

614 
	}
}

616 
	$g‘LÚgDoubËFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
) {

617 
v®ue
;

618 ià(
	`g‘LÚgDoubËFromObjeù
(
o
, &
v®ue
è!ğ
C_OK
) {

619 ià(
msg
 !ğ
NULL
) {

620 
	`addR•lyE¼Ü
(
c
,(*)
msg
);

622 
	`addR•lyE¼Ü
(
c
,"value is‚ot‡ valid float");

624  
C_ERR
;

626 *
rg‘
 = 
v®ue
;

627  
C_OK
;

628 
	}
}

630 
	$g‘LÚgLÚgFromObjeù
(
robj
 *
o
, *
rg‘
) {

631 
v®ue
;

633 ià(
o
 =ğ
NULL
) {

634 
v®ue
 = 0;

636 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

637 ià(
	`sdsEncodedObjeù
(
o
)) {

638 ià(
	`¡ršg2Î
(
o
->
±r
,
	`sd¦’
(o->±r),&
v®ue
è=ğ0è 
C_ERR
;

639 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

640 
v®ue
 = ()
o
->
±r
;

642 
	`£rv”Pªic
("Unknown stringƒncoding");

645 ià(
rg‘
è*rg‘ = 
v®ue
;

646  
C_OK
;

647 
	}
}

649 
	$g‘LÚgLÚgFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
) {

650 
v®ue
;

651 ià(
	`g‘LÚgLÚgFromObjeù
(
o
, &
v®ue
è!ğ
C_OK
) {

652 ià(
msg
 !ğ
NULL
) {

653 
	`addR•lyE¼Ü
(
c
,(*)
msg
);

655 
	`addR•lyE¼Ü
(
c
,"value is‚ot‡n integer or out of„ange");

657  
C_ERR
;

659 *
rg‘
 = 
v®ue
;

660  
C_OK
;

661 
	}
}

663 
	$g‘LÚgFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
) {

664 
v®ue
;

666 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, 
o
, &
v®ue
, 
msg
è!ğ
C_OK
è 
C_ERR
;

667 ià(
v®ue
 < 
LONG_MIN
 || v®u> 
LONG_MAX
) {

668 ià(
msg
 !ğ
NULL
) {

669 
	`addR•lyE¼Ü
(
c
,(*)
msg
);

671 
	`addR•lyE¼Ü
(
c
,"value is out of„ange");

673  
C_ERR
;

675 *
rg‘
 = 
v®ue
;

676  
C_OK
;

677 
	}
}

679 *
	$¡rEncodšg
(
’codšg
) {

680 
’codšg
) {

681 
OBJ_ENCODING_RAW
:  "raw";

682 
OBJ_ENCODING_INT
:  "int";

683 
OBJ_ENCODING_HT
:  "hashtable";

684 
OBJ_ENCODING_QUICKLIST
:  "quicklist";

685 
OBJ_ENCODING_ZIPLIST
:  "ziplist";

686 
OBJ_ENCODING_INTSET
:  "intset";

687 
OBJ_ENCODING_SKIPLIST
:  "skiplist";

688 
OBJ_ENCODING_EMBSTR
:  "embstr";

691 
	}
}

699 
	#OBJ_COMPUTE_SIZE_DEF_SAMPLES
 5

	)

700 
size_t
 
	$objeùCompu‹Size
(
robj
 *
o
, 
size_t
 
§m¶e_size
) {

701 
sds
 
–e
, 
–e2
;

702 
diù
 *
d
;

703 
diùI‹¿tÜ
 *
di
;

704 
diùEÁry
 *
de
;

705 
size_t
 
asize
 = 0, 
–esize
 = 0, 
§m¶es
 = 0;

707 ià(
o
->
ty³
 =ğ
OBJ_STRING
) {

708 if(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

709 
asize
 = (*
o
);

710 } if(
o
->
’codšg
 =ğ
OBJ_ENCODING_RAW
) {

711 
asize
 = 
	`sdsAÎocSize
(
o
->
±r
)+(*o);

712 } if(
o
->
’codšg
 =ğ
OBJ_ENCODING_EMBSTR
) {

713 
asize
 = 
	`sd¦’
(
o
->
±r
)+2+(*o);

715 
	`£rv”Pªic
("Unknown stringƒncoding");

717 } ià(
o
->
ty³
 =ğ
OBJ_LIST
) {

718 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

719 
quickli¡
 *
ql
 = 
o
->
±r
;

720 
quickli¡Node
 *
node
 = 
ql
->
h—d
;

721 
asize
 = (*
o
)+(
quickli¡
);

723 
–esize
 +ğ(
quickli¡Node
)+
	`zli¡BlobL’
(
node
->
zl
);

724 
§m¶es
++;

725 } (
node
 =‚ode->
Ãxt
è&& 
§m¶es
 < 
§m¶e_size
);

726 
asize
 +ğ()
–esize
/
§m¶es
*
	`li¡Ty³L’gth
(
o
);

727 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

728 
asize
 = (*
o
)+
	`zli¡BlobL’
(o->
±r
);

730 
	`£rv”Pªic
("Unknown†istƒncoding");

732 } ià(
o
->
ty³
 =ğ
OBJ_SET
) {

733 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

734 
d
 = 
o
->
±r
;

735 
di
 = 
	`diùG‘I‹¿tÜ
(
d
);

736 
asize
 = (*
o
)+(
diù
)+((
diùEÁry
*)*
	`diùSlÙs
(
d
));

737 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
 && 
§m¶es
 < 
§m¶e_size
) {

738 
–e
 = 
	`diùG‘Key
(
de
);

739 
–esize
 +ğ(
diùEÁry
è+ 
	`sdsAÎocSize
(
–e
);

740 
§m¶es
++;

742 
	`diùR–—£I‹¿tÜ
(
di
);

743 ià(
§m¶es
è
asize
 +ğ()
–esize
/§m¶es*
	`diùSize
(
d
);

744 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

745 
št£t
 *
is
 = 
o
->
±r
;

746 
asize
 = (*
o
)+(*
is
)+is->
’codšg
*is->
Ëngth
;

748 
	`£rv”Pªic
("Unknown setƒncoding");

750 } ià(
o
->
ty³
 =ğ
OBJ_ZSET
) {

751 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

752 
asize
 = (*
o
)+(
	`zli¡BlobL’
(o->
±r
));

753 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

754 
d
 = ((
z£t
*)
o
->
±r
)->
diù
;

755 
zskli¡
 *
z¦
 = ((
z£t
*)
o
->
±r
)->zsl;

756 
zskli¡Node
 *
znode
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

757 
asize
 = (*
o
)+(
z£t
)+((
diùEÁry
*)*
	`diùSlÙs
(
d
));

758 
znode
 !ğ
NULL
 && 
§m¶es
 < 
§m¶e_size
) {

759 
–esize
 +ğ
	`sdsAÎocSize
(
znode
->
–e
);

760 
–esize
 +ğ(
diùEÁry
è+ 
	`zm®loc_size
(
znode
);

761 
§m¶es
++;

762 
znode
 = znode->
Ëv–
[0].
fÜw¬d
;

764 ià(
§m¶es
è
asize
 +ğ()
–esize
/§m¶es*
	`diùSize
(
d
);

766 
	`£rv”Pªic
("Unknown sorted setƒncoding");

768 } ià(
o
->
ty³
 =ğ
OBJ_HASH
) {

769 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

770 
asize
 = (*
o
)+(
	`zli¡BlobL’
(o->
±r
));

771 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

772 
d
 = 
o
->
±r
;

773 
di
 = 
	`diùG‘I‹¿tÜ
(
d
);

774 
asize
 = (*
o
)+(
diù
)+((
diùEÁry
*)*
	`diùSlÙs
(
d
));

775 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
 && 
§m¶es
 < 
§m¶e_size
) {

776 
–e
 = 
	`diùG‘Key
(
de
);

777 
–e2
 = 
	`diùG‘V®
(
de
);

778 
–esize
 +ğ
	`sdsAÎocSize
(
–e
è+ sdsAÎocSize(
–e2
);

779 
–esize
 +ğ(
diùEÁry
);

780 
§m¶es
++;

782 
	`diùR–—£I‹¿tÜ
(
di
);

783 ià(
§m¶es
è
asize
 +ğ()
–esize
/§m¶es*
	`diùSize
(
d
);

785 
	`£rv”Pªic
("Unknown hashƒncoding");

787 } ià(
o
->
ty³
 =ğ
OBJ_MODULE
) {

788 
moduËV®ue
 *
mv
 = 
o
->
±r
;

789 
moduËTy³
 *
mt
 = 
mv
->
ty³
;

790 ià(
mt
->
mem_u§ge
 !ğ
NULL
) {

791 
asize
 = 
mt
->
	`mem_u§ge
(
mv
->
v®ue
);

793 
asize
 = 0;

796 
	`£rv”Pªic
("Unknown objectype");

798  
asize
;

799 
	}
}

802 
	$ä“MemÜyOv”h—dD©a
(
»disMemOv”h—d
 *
mh
) {

803 
	`zä“
(
mh
->
db
);

804 
	`zä“
(
mh
);

805 
	}
}

810 
»disMemOv”h—d
 *
	$g‘MemÜyOv”h—dD©a
() {

811 
j
;

812 
size_t
 
mem_tÙ®
 = 0;

813 
size_t
 
mem
 = 0;

814 
size_t
 
zm®loc_u£d
 = 
	`zm®loc_u£d_memÜy
();

815 
»disMemOv”h—d
 *
mh
 = 
	`zÿÎoc
((*mh));

817 
mh
->
tÙ®_®loÿ‹d
 = 
zm®loc_u£d
;

818 
mh
->
¡¬tup_®loÿ‹d
 = 
£rv”
.
š™Ÿl_memÜy_u§ge
;

819 
mh
->
³ak_®loÿ‹d
 = 
£rv”
.
¡©_³ak_memÜy
;

820 
mh
->
äagm’tiÚ
 =

821 
	`zm®loc_g‘_äagm’tiÚ_¿tio
(
£rv”
.
»sid’t_£t_size
);

822 
mem_tÙ®
 +ğ
£rv”
.
š™Ÿl_memÜy_u§ge
;

824 
mem
 = 0;

825 ià(
£rv”
.
»¶_backlog
)

826 
mem
 +ğ
	`zm®loc_size
(
£rv”
.
»¶_backlog
);

827 
mh
->
»¶_backlog
 = 
mem
;

828 
mem_tÙ®
 +ğ
mem
;

830 
mem
 = 0;

831 ià(
	`li¡L’gth
(
£rv”
.
¦aves
)) {

832 
li¡I‹r
 
li
;

833 
li¡Node
 *
Ê
;

835 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

836 (
Ê
 = 
	`li¡Next
(&
li
))) {

837 
ş›Á
 *
c
 = 
	`li¡NodeV®ue
(
Ê
);

838 
mem
 +ğ
	`g‘Cl›ÁOuutBufãrMemÜyU§ge
(
c
);

839 
mem
 +ğ
	`sdsAÎocSize
(
c
->
qu”ybuf
);

840 
mem
 +ğ(
ş›Á
);

843 
mh
->
ş›Ás_¦aves
 = 
mem
;

844 
mem_tÙ®
+=
mem
;

846 
mem
 = 0;

847 ià(
	`li¡L’gth
(
£rv”
.
ş›Ás
)) {

848 
li¡I‹r
 
li
;

849 
li¡Node
 *
Ê
;

851 
	`li¡Rewšd
(
£rv”
.
ş›Ás
,&
li
);

852 (
Ê
 = 
	`li¡Next
(&
li
))) {

853 
ş›Á
 *
c
 = 
	`li¡NodeV®ue
(
Ê
);

854 ià(
c
->
æags
 & 
CLIENT_SLAVE
)

856 
mem
 +ğ
	`g‘Cl›ÁOuutBufãrMemÜyU§ge
(
c
);

857 
mem
 +ğ
	`sdsAÎocSize
(
c
->
qu”ybuf
);

858 
mem
 +ğ(
ş›Á
);

861 
mh
->
ş›Ás_nÜm®
 = 
mem
;

862 
mem_tÙ®
+=
mem
;

864 
mem
 = 0;

865 ià(
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
) {

866 
mem
 +ğ
	`sd¦’
(
£rv”
.
aof_buf
);

867 
mem
 +ğ
	`aofRewr™eBufãrSize
();

869 
mh
->
aof_bufãr
 = 
mem
;

870 
mem_tÙ®
+=
mem
;

872 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

873 
»disDb
 *
db
 = 
£rv”
.db+
j
;

874 
keyscouÁ
 = 
	`diùSize
(
db
->
diù
);

875 ià(
keyscouÁ
==0) ;

877 
mh
->
tÙ®_keys
 +ğ
keyscouÁ
;

878 
mh
->
db
 = 
	`z»®loc
(mh->db,(mh->db[0])*(mh->
num_dbs
+1));

879 
mh
->
db
[mh->
num_dbs
].
dbid
 = 
j
;

881 
mem
 = 
	`diùSize
(
db
->
diù
è* (
diùEÁry
) +

882 
	`diùSlÙs
(
db
->
diù
è* (
diùEÁry
*) +

883 
	`diùSize
(
db
->
diù
è* (
robj
);

884 
mh
->
db
[mh->
num_dbs
].
ov”h—d_ht_maš
 = 
mem
;

885 
mem_tÙ®
+=
mem
;

887 
mem
 = 
	`diùSize
(
db
->
expœes
è* (
diùEÁry
) +

888 
	`diùSlÙs
(
db
->
expœes
è* (
diùEÁry
*);

889 
mh
->
db
[mh->
num_dbs
].
ov”h—d_ht_expœes
 = 
mem
;

890 
mem_tÙ®
+=
mem
;

892 
mh
->
num_dbs
++;

895 
mh
->
ov”h—d_tÙ®
 = 
mem_tÙ®
;

896 
mh
->
d©a£t
 = 
zm®loc_u£d
 - 
mem_tÙ®
;

897 
mh
->
³ak_³rc
 = ()
zm®loc_u£d
*100/mh->
³ak_®loÿ‹d
;

901 
size_t
 
Ãt_u§ge
 = 1;

902 ià(
zm®loc_u£d
 > 
mh
->
¡¬tup_®loÿ‹d
)

903 
Ãt_u§ge
 = 
zm®loc_u£d
 - 
mh
->
¡¬tup_®loÿ‹d
;

904 
mh
->
d©a£t_³rc
 = ()mh->
d©a£t
*100/
Ãt_u§ge
;

905 
mh
->
by‹s_³r_key
 = mh->
tÙ®_keys
 ? (
Ãt_u§ge
 / mh->total_keys) : 0;

907  
mh
;

908 
	}
}

912 
	$šputC©Sds
(*
»suÉ
, cÚ¡ *
¡r
) {

914 
sds
 *
šfo
 = (sd *)
»suÉ
;

915 *
šfo
 = 
	`sdsÿt
(*šfo, 
¡r
);

916 
	}
}

920 
sds
 
	$g‘MemÜyDoùÜR•Üt
() {

921 
em±y
 = 0;

922 
big_³ak
 = 0;

923 
high_äag
 = 0;

924 
big_¦ave_buf
 = 0;

925 
big_ş›Á_buf
 = 0;

926 
num_»pÜts
 = 0;

927 
»disMemOv”h—d
 *
mh
 = 
	`g‘MemÜyOv”h—dD©a
();

929 ià(
mh
->
tÙ®_®loÿ‹d
 < (1024*1024*5)) {

930 
em±y
 = 1;

931 
num_»pÜts
++;

934 ià((()
mh
->
³ak_®loÿ‹d
 / mh->
tÙ®_®loÿ‹d
) > 1.5) {

935 
big_³ak
 = 1;

936 
num_»pÜts
++;

940 ià(
mh
->
äagm’tiÚ
 > 1.4) {

941 
high_äag
 = 1;

942 
num_»pÜts
++;

946 
num¦aves
 = 
	`li¡L’gth
(
£rv”
.
¦aves
);

947 
numş›Ás
 = 
	`li¡L’gth
(
£rv”
.
ş›Ás
)-
num¦aves
;

948 ià(
mh
->
ş›Ás_nÜm®
 / 
numş›Ás
 > (1024*200)) {

949 
big_ş›Á_buf
 = 1;

950 
num_»pÜts
++;

954 ià(
num¦aves
 > 0 && 
mh
->
ş›Ás_¦aves
 /‚umslaves > (1024*1024*10)) {

955 
big_¦ave_buf
 = 1;

956 
num_»pÜts
++;

960 
sds
 
s
;

961 ià(
num_»pÜts
 == 0) {

962 
s
 = 
	`sd¢ew
(

965 } ià(
em±y
 == 1) {

966 
s
 = 
	`sd¢ew
(

973 
s
 = 
	`sd¢ew
("Sam, I detected‡ few issues inhis Redis instance memory implants:\n\n");

974 ià(
big_³ak
) {

975 
s
 = 
	`sdsÿt
(s," * Peak memory: Inhe…asthis instance used morehan 150%he memoryhat is currently using. The‡llocator is‚ormally‚ot‡bleo„elease memory‡fter‡…eak, so you canƒxpecto see‡ big fragmentation„atio, howeverhis is‡ctually harmless‡nd is only dueohe memory…eak,‡nd ifhe Redis instance Resident Set Size (RSS) is currently biggerhanƒxpected,he memory will be used‡s soon‡s you fillhe Redis instance with more data. Ifhe memory…eak was only occasional‡nd you wantoryo„eclaim memory,…leaseryhe MEMORY PURGE command, otherwisehe only other option iso shutdown‡nd„estarthe instance.\n\n");

977 ià(
high_äag
) {

978 
s
 = 
	`sdsÿrštf
(s," * High f¿gm’tiÚ: Thi š¡ªû ha ¨memÜy f¿gm’tiÚ g»©”hª 1.4 (thi m—n th©hResid’ˆS‘ SizoàthRedi ´oûs i much†¬g”hªhsum oàthlogiÿÈ®loÿtiÚ Redi ³rfÜmed). Thi ´obËm i usu®ly due™h”Ø¨Ïrg³ak memÜy (check iàth”i ¨³ak memÜyƒÁry‡bovšh»pÜtèÜ may„esuÉ from‡ wÜklßdh© cau£ th®loÿtÜØäagm’ˆmemÜy‡†Ù. Iàth´obËm i ¨Ïrg³ak memÜy,h’h”i nØissue. Oth”wi£, maksu» you‡» usšghJem®loø®loÿtÜ‡nd‚ÙhdeçuÉ†ibøm®loc. NÙe: Thcu¼’y u£d‡ÎoÿtÜ i \"%s\".\n\n", 
ZMALLOC_LIB
);

980 ià(
big_¦ave_buf
) {

981 
s
 = 
	`sdsÿt
(s," * Big slave buffers: The slave output buffers inhis instance‡re greaterhan 10MB forƒach slave (on‡verage). This†ikely meanshathere is some slave instancehat is struggling„eceiving data,ƒither because it isoo slow or because of‚etworking issues. As‡„esult, data…iles onhe master output buffers. Pleaseryo identify what slave is‚ot„eceiving data correctly‡nd why. You can usehe INFO output in ordero checkhe slaves delays‡ndhe CLIENT LIST commando checkhe output buffers ofƒach slave.\n\n");

983 ià(
big_ş›Á_buf
) {

984 
s
 = 
	`sdsÿt
(s," * Big client buffers: The clients output buffers inhis instance‡re greaterhan 200K…er client (on‡verage). This may„esult from different causes,†ike Pub/Sub clients subscribedo channels bot‚ot„eceiving data fastƒnough, sohat data…iles onhe Redis instance output buffer, or clients sending commands with†arge„eplies or very†arge sequences of commands inhe same…ipeline. Please usehe CLIENT LIST command in ordero investigatehe issue if it causes…roblems in your instance, oro understand better why certain clients‡re using‡ big‡mount of memory.\n\n");

986 
s
 = 
	`sdsÿt
(s,"I'm hereo keep you safe, Sam. I wanto help you.\n");

988 
	`ä“MemÜyOv”h—dD©a
(
mh
);

989  
s
;

990 
	}
}

996 
robj
 *
	$objeùCommªdLookup
(
ş›Á
 *
c
, 
robj
 *
key
) {

997 
diùEÁry
 *
de
;

999 ià((
de
 = 
	`diùFšd
(
c
->
db
->
diù
,
key
->
±r
)è=ğ
NULL
)  NULL;

1000  (
robj
*è
	`diùG‘V®
(
de
);

1001 
	}
}

1003 
robj
 *
	$objeùCommªdLookupOrR•ly
(
ş›Á
 *
c
, 
robj
 *
key
,„obj *
»¶y
) {

1004 
robj
 *
o
 = 
	`objeùCommªdLookup
(
c
,
key
);

1006 ià(!
o
è
	`addR•ly
(
c
, 
»¶y
);

1007  
o
;

1008 
	}
}

1012 
	$objeùCommªd
(
ş›Á
 *
c
) {

1013 
robj
 *
o
;

1015 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"»fcouÁ"è&& c->
¬gc
 == 3) {

1016 ià((
o
 = 
	`objeùCommªdLookupOrR•ly
(
c
,c->
¬gv
[2],
sh¬ed
.
nuÎbulk
))

1017 =ğ
NULL
) ;

1018 
	`addR•lyLÚgLÚg
(
c
,
o
->
»fcouÁ
);

1019 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"’codšg"è&& c->
¬gc
 == 3) {

1020 ià((
o
 = 
	`objeùCommªdLookupOrR•ly
(
c
,c->
¬gv
[2],
sh¬ed
.
nuÎbulk
))

1021 =ğ
NULL
) ;

1022 
	`addR•lyBulkCSŒšg
(
c
,
	`¡rEncodšg
(
o
->
’codšg
));

1023 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"idËtime"è&& c->
¬gc
 == 3) {

1024 ià((
o
 = 
	`objeùCommªdLookupOrR•ly
(
c
,c->
¬gv
[2],
sh¬ed
.
nuÎbulk
))

1025 =ğ
NULL
) ;

1026 ià(
£rv”
.
maxmemÜy_pŞicy
 & 
MAXMEMORY_FLAG_LFU
) {

1027 
	`addR•lyE¼Ü
(
c
,"An LFU maxmemory…olicy is selected, idleime‚otracked. Please‚otehat when switching between…olicies‡t„untime LRU‡nd LFU data willake someimeo‡djust.");

1030 
	`addR•lyLÚgLÚg
(
c
,
	`e¡im©eObjeùIdËTime
(
o
)/1000);

1031 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"äeq"è&& c->
¬gc
 == 3) {

1032 ià((
o
 = 
	`objeùCommªdLookupOrR•ly
(
c
,c->
¬gv
[2],
sh¬ed
.
nuÎbulk
))

1033 =ğ
NULL
) ;

1034 ià(
£rv”
.
maxmemÜy_pŞicy
 & 
MAXMEMORY_FLAG_LRU
) {

1035 
	`addR•lyE¼Ü
(
c
,"An LRU maxmemory…olicy is selected,‡ccess frequency‚otracked. Please‚otehat when switching between…olicies‡t„untime LRU‡nd LFU data willake someimeo‡djust.");

1038 
	`addR•lyLÚgLÚg
(
c
,
o
->
Ìu
&255);

1040 
	`addR•lyE¼Ü
(
c
,"Syntaxƒrror. Try OBJECT (refcount|encoding|idletime|freq)");

1042 
	}
}

1048 
	$memÜyCommªd
(
ş›Á
 *
c
) {

1049 
robj
 *
o
;

1051 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"u§ge"è&& c->
¬gc
 >= 3) {

1052 
§m¶es
 = 
OBJ_COMPUTE_SIZE_DEF_SAMPLES
;

1053 
j
 = 3; j < 
c
->
¬gc
; j++) {

1054 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"samples") &&

1055 
j
+1 < 
c
->
¬gc
)

1057 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[
j
+1],&
§m¶es
,
NULL
)

1058 =ğ
C_ERR
) ;

1059 ià(
§m¶es
 < 0) {

1060 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1063 ià(
§m¶es
 =ğ0è§m¶e ğ
LLONG_MAX
;;

1064 
j
++;

1066 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1070 ià((
o
 = 
	`objeùCommªdLookupOrR•ly
(
c
,c->
¬gv
[2],
sh¬ed
.
nuÎbulk
))

1071 =ğ
NULL
) ;

1072 
size_t
 
u§ge
 = 
	`objeùCompu‹Size
(
o
,
§m¶es
);

1073 
u§ge
 +ğ
	`sdsAÎocSize
(
c
->
¬gv
[1]->
±r
);

1074 
u§ge
 +ğ(
diùEÁry
);

1075 
	`addR•lyLÚgLÚg
(
c
,
u§ge
);

1076 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"¡©s"è&& c->
¬gc
 == 2) {

1077 
»disMemOv”h—d
 *
mh
 = 
	`g‘MemÜyOv”h—dD©a
();

1079 
	`addR•lyMuÉiBulkL’
(
c
,(14+
mh
->
num_dbs
)*2);

1081 
	`addR•lyBulkCSŒšg
(
c
,"peak.allocated");

1082 
	`addR•lyLÚgLÚg
(
c
,
mh
->
³ak_®loÿ‹d
);

1084 
	`addR•lyBulkCSŒšg
(
c
,"total.allocated");

1085 
	`addR•lyLÚgLÚg
(
c
,
mh
->
tÙ®_®loÿ‹d
);

1087 
	`addR•lyBulkCSŒšg
(
c
,"startup.allocated");

1088 
	`addR•lyLÚgLÚg
(
c
,
mh
->
¡¬tup_®loÿ‹d
);

1090 
	`addR•lyBulkCSŒšg
(
c
,"replication.backlog");

1091 
	`addR•lyLÚgLÚg
(
c
,
mh
->
»¶_backlog
);

1093 
	`addR•lyBulkCSŒšg
(
c
,"clients.slaves");

1094 
	`addR•lyLÚgLÚg
(
c
,
mh
->
ş›Ás_¦aves
);

1096 
	`addR•lyBulkCSŒšg
(
c
,"clients.normal");

1097 
	`addR•lyLÚgLÚg
(
c
,
mh
->
ş›Ás_nÜm®
);

1099 
	`addR•lyBulkCSŒšg
(
c
,"aof.buffer");

1100 
	`addR•lyLÚgLÚg
(
c
,
mh
->
aof_bufãr
);

1102 
size_t
 
j
 = 0; j < 
mh
->
num_dbs
; j++) {

1103 
dbÇme
[32];

1104 
	`¢´štf
(
dbÇme
,(dbÇme),"db.%zd",
mh
->
db
[
j
].
dbid
);

1105 
	`addR•lyBulkCSŒšg
(
c
,
dbÇme
);

1106 
	`addR•lyMuÉiBulkL’
(
c
,4);

1108 
	`addR•lyBulkCSŒšg
(
c
,"overhead.hashtable.main");

1109 
	`addR•lyLÚgLÚg
(
c
,
mh
->
db
[
j
].
ov”h—d_ht_maš
);

1111 
	`addR•lyBulkCSŒšg
(
c
,"overhead.hashtable.expires");

1112 
	`addR•lyLÚgLÚg
(
c
,
mh
->
db
[
j
].
ov”h—d_ht_expœes
);

1115 
	`addR•lyBulkCSŒšg
(
c
,"overhead.total");

1116 
	`addR•lyLÚgLÚg
(
c
,
mh
->
ov”h—d_tÙ®
);

1118 
	`addR•lyBulkCSŒšg
(
c
,"keys.count");

1119 
	`addR•lyLÚgLÚg
(
c
,
mh
->
tÙ®_keys
);

1121 
	`addR•lyBulkCSŒšg
(
c
,"keys.bytes-per-key");

1122 
	`addR•lyLÚgLÚg
(
c
,
mh
->
by‹s_³r_key
);

1124 
	`addR•lyBulkCSŒšg
(
c
,"dataset.bytes");

1125 
	`addR•lyLÚgLÚg
(
c
,
mh
->
d©a£t
);

1127 
	`addR•lyBulkCSŒšg
(
c
,"dataset.percentage");

1128 
	`addR•lyDoubË
(
c
,
mh
->
d©a£t_³rc
);

1130 
	`addR•lyBulkCSŒšg
(
c
,"peak.percentage");

1131 
	`addR•lyDoubË
(
c
,
mh
->
³ak_³rc
);

1133 
	`addR•lyBulkCSŒšg
(
c
,"fragmentation");

1134 
	`addR•lyDoubË
(
c
,
mh
->
äagm’tiÚ
);

1136 
	`ä“MemÜyOv”h—dD©a
(
mh
);

1137 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"m®loc-¡©s"è&& c->
¬gc
 == 2) {

1138 #ià
	`defšed
(
USE_JEMALLOC
)

1139 
sds
 
šfo
 = 
	`sd£m±y
();

1140 
	`je_m®loc_¡©s_´št
(
šputC©Sds
, &
šfo
, 
NULL
);

1141 
	`addR•lyBulkSds
(
c
, 
šfo
);

1143 
	`addR•lyBulkCSŒšg
(
c
,"Stats‚ot supported forhe current‡llocator");

1145 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"doùÜ"è&& c->
¬gc
 == 2) {

1146 
sds
 
»pÜt
 = 
	`g‘MemÜyDoùÜR•Üt
();

1147 
	`addR•lyBulkSds
(
c
,
»pÜt
);

1148 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"purge"è&& c->
¬gc
 == 2) {

1149 #ià
	`defšed
(
USE_JEMALLOC
)

1150 
tmp
[32];

1151 
Ç»Çs
 = 0;

1152 
size_t
 
sz
 = ();

1153 ià(!
	`je_m®lùl
("¬’as.Ç»Çs", &
Ç»Çs
, &
sz
, 
NULL
, 0)) {

1154 
	`¥rštf
(
tmp
, "¬’a.%d.purge", 
Ç»Çs
);

1155 ià(!
	`je_m®lùl
(
tmp
, 
NULL
, 0, NULL, 0)) {

1156 
	`addR•ly
(
c
, 
sh¬ed
.
ok
);

1160 
	`addR•lyE¼Ü
(
c
, "Error…urging dirty…ages");

1162 
	`addR•ly
(
c
, 
sh¬ed
.
ok
);

1165 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"h–p"è&& c->
¬gc
 == 2) {

1166 
	`addR•lyMuÉiBulkL’
(
c
,4);

1167 
	`addR•lyBulkCSŒšg
(
c
,

1169 
	`addR•lyBulkCSŒšg
(
c
,

1171 
	`addR•lyBulkCSŒšg
(
c
,

1173 
	`addR•lyBulkCSŒšg
(
c
,

1176 
	`addR•lyE¼Ü
(
c
,"Syntaxƒrror. Try MEMORY HELP");

1178 
	}
}

	@pqsort.c

40 
	~<sys/ty³s.h
>

42 
	~<”ºo.h
>

43 
	~<¡dlib.h
>

45 
šlše
 *
med3
 (*, *, *,

47 
šlše
 
	`sw­func
 (*, *, 
size_t
, );

49 
	#mš
(
a
, 
b
è×è< (bè?‡ : 
	)
b

54 
	#sw­code
(
TYPE
, 
·rmi
, 
·rmj
, 
n
) { \

55 
size_t
 
i
 = (
n
è/  (
TYPE
); \

56 
TYPE
 *
pi
 = (TYPE *)(*)(
·rmi
); \

57 
TYPE
 *
pj
 = (TYPE *)(*)(
·rmj
); \

59 
TYPE
 
t
 = *
pi
; \

60 *
pi
++ = *
pj
; \

61 *
pj
++ = 
t
; \

62 } --
i
 > 0); \

63 
	}

	)
}

65 
	#SWAPINIT
(
a
, 
es
è
sw­ty³
 = ((*)a - (*)0) % () || \

66 
es
 % (è? 2 :ƒ =ğ()? 0 : 1;

	)

68 
šlše
 

69 
	$sw­func
(*
a
, *
b
, 
size_t
 
n
, 
sw­ty³
)

72 ià(
sw­ty³
 <= 1)

73 
	`sw­code
(, 
a
, 
b
, 
n
)

75 
	`sw­code
(, 
a
, 
b
, 
n
)

76 
	}
}

78 
	#sw­
(
a
, 
b
) \

79 ià(
sw­ty³
 == 0) { \

80 
t
 = *(*)(*)(
a
); \

81 *(*)(*)(
a
èğ*(*)(*)(
b
); \

82 *(*)(*)(
b
èğ
t
; \

84 
	`sw­func
(
a
, 
b
, 
es
, 
sw­ty³
)

	)

86 
	#vecsw­
(
a
, 
b
, 
n
èià(Òè> 0è
	`sw­func
(×), (b), (
size_t
)Ò), 
sw­ty³
)

	)

88 
šlše
 *

89 
	$med3
(*
a
, *
b
, *
c
,

90 (*
cmp
) (const *, const *))

93  
	`cmp
(
a
, 
b
) < 0 ?

94 (
	`cmp
(
b
, 
c
è< 0 ? b : (cmp(
a
, c) < 0 ? c :‡ ))

95 :(
	`cmp
(
b
, 
c
è> 0 ? b : (cmp(
a
, c) < 0 ?‡ : c ));

96 
	}
}

99 
	$_pqsÜt
(*
a
, 
size_t
 
n
, size_ˆ
es
,

100 (*
cmp
è(cÚ¡ *, cÚ¡ *), *
Ìªge
, *
¼ªge
)

102 *
·
, *
pb
, *
pc
, *
pd
, *
¶
, *
pm
, *
²
;

103 
size_t
 
d
, 
r
;

104 
sw­ty³
, 
cmp_»suÉ
;

106 
loİ
: 
	`SWAPINIT
(
a
, 
es
);

107 ià(
n
 < 7) {

108 
pm
 = (*è
a
 + 
es
;…m < (*è¨+ 
n
 *ƒs;…m +=ƒs)

109 
¶
 = 
pm
;…È> (*è
a
 && 
	`cmp
ÕÈ- 
es
,…l) > 0;

110 
¶
 -ğ
es
)

111 
	`sw­
(
¶
,…È- 
es
);

114 
pm
 = (*è
a
 + (
n
 / 2è* 
es
;

115 ià(
n
 > 7) {

116 
¶
 = (*è
a
;

117 
²
 = (*è
a
 + (
n
 - 1è* 
es
;

118 ià(
n
 > 40) {

119 
d
 = (
n
 / 8è* 
es
;

120 
¶
 = 
	`med3
Õl,…È+ 
d
,…È+ 2 * d, 
cmp
);

121 
pm
 = 
	`med3
Õm - 
d
,…m,…m + d, 
cmp
);

122 
²
 = 
	`med3
ÕÀ- 2 * 
d
,…À- d,…n, 
cmp
);

124 
pm
 = 
	`med3
(
¶
,…m, 
²
, 
cmp
);

126 
	`sw­
(
a
, 
pm
);

127 
·
 = 
pb
 = (*è
a
 + 
es
;

129 
pc
 = 
pd
 = (*è
a
 + (
n
 - 1è* 
es
;

131 
pb
 <ğ
pc
 && (
cmp_»suÉ
 = 
	`cmp
Õb, 
a
)) <= 0) {

132 ià(
cmp_»suÉ
 == 0) {

133 
	`sw­
(
·
, 
pb
);

134 
·
 +ğ
es
;

136 
pb
 +ğ
es
;

138 
pb
 <ğ
pc
 && (
cmp_»suÉ
 = 
	`cmp
Õc, 
a
)) >= 0) {

139 ià(
cmp_»suÉ
 == 0) {

140 
	`sw­
(
pc
, 
pd
);

141 
pd
 -ğ
es
;

143 
pc
 -ğ
es
;

145 ià(
pb
 > 
pc
)

147 
	`sw­
(
pb
, 
pc
);

148 
pb
 +ğ
es
;

149 
pc
 -ğ
es
;

152 
²
 = (*è
a
 + 
n
 * 
es
;

153 
r
 = 
	`mš
(
·
 - (*è
a
, 
pb
 -…a);

154 
	`vecsw­
(
a
, 
pb
 - 
r
,„);

155 
r
 = 
	`mš
((
size_t
)(
pd
 - 
pc
), 
²
 -…d - 
es
);

156 
	`vecsw­
(
pb
, 
²
 - 
r
,„);

157 ià((
r
 = 
pb
 - 
·
è> 
es
) {

158 *
_l
 = 
a
, *
_r
 = ((*ï)+
r
-1;

159 ià(!((
Ìªge
 < 
_l
 && 
¼ªge
 < _l) ||

160 (
Ìªge
 > 
_r
 && 
¼ªge
 > _r)))

161 
	`_pqsÜt
(
a
, 
r
 / 
es
,ƒs, 
cmp
, 
Ìªge
, 
¼ªge
);

163 ià((
r
 = 
pd
 - 
pc
è> 
es
) {

164 *
_l
, *
_r
;

167 
a
 = 
²
 - 
r
;

168 
n
 = 
r
 / 
es
;

170 
_l
 = 
a
;

171 
_r
 = ((*)
a
)+
r
-1;

172 ià(!((
Ìªge
 < 
_l
 && 
¼ªge
 < _l) ||

173 (
Ìªge
 > 
_r
 && 
¼ªge
 > _r)))

174 
loİ
;

177 
	}
}

180 
	$pqsÜt
(*
a
, 
size_t
 
n
, size_ˆ
es
,

181 (*
cmp
è(cÚ¡ *, cÚ¡ *), 
size_t
 
Ìªge
, size_ˆ
¼ªge
)

183 
	`_pqsÜt
(
a
,
n
,
es
,
cmp
,((*ï)+(
Ìªge
*es),

184 ((*)
a
)+((
¼ªge
+1)*
es
)-1);

185 
	}
}

	@pqsort.h

33 #iâdeà
__PQSORT_H


34 
	#__PQSORT_H


	)

37 
pqsÜt
(*
a
, 
size_t
 
n
, size_ˆ
es
,

38 (*
cmp
è(cÚ¡ *, cÚ¡ *), 
size_t
 
Ìªge
, size_ˆ
¼ªge
);

	@pubsub.c

30 
	~"£rv”.h
"

36 
	$ä“PubsubP©‹º
(*
p
) {

37 
pubsubP©‹º
 *
·t
 = 
p
;

39 
	`deüRefCouÁ
(
·t
->
·‰”n
);

40 
	`zä“
(
·t
);

41 
	}
}

43 
	$li¡M©chPubsubP©‹º
(*
a
, *
b
) {

44 
pubsubP©‹º
 *
·
 = 
a
, *
pb
 = 
b
;

46  (
·
->
ş›Á
 =ğ
pb
->client) &&

47 (
	`equ®SŒšgObjeùs
(
·
->
·‰”n
,
pb
->pattern));

48 
	}
}

51 
	$ş›ÁSubsütiÚsCouÁ
(
ş›Á
 *
c
) {

52  
	`diùSize
(
c
->
pubsub_chªÃls
)+

53 
	`li¡L’gth
(
c
->
pubsub_·‰”ns
);

54 
	}
}

58 
	$pubsubSubsüibeChªÃl
(
ş›Á
 *
c
, 
robj
 *
chªÃl
) {

59 
diùEÁry
 *
de
;

60 
li¡
 *
ş›Ás
 = 
NULL
;

61 
»tv®
 = 0;

64 ià(
	`diùAdd
(
c
->
pubsub_chªÃls
,
chªÃl
,
NULL
è=ğ
DICT_OK
) {

65 
»tv®
 = 1;

66 
	`šüRefCouÁ
(
chªÃl
);

68 
de
 = 
	`diùFšd
(
£rv”
.
pubsub_chªÃls
,
chªÃl
);

69 ià(
de
 =ğ
NULL
) {

70 
ş›Ás
 = 
	`li¡C»©e
();

71 
	`diùAdd
(
£rv”
.
pubsub_chªÃls
,
chªÃl
,
ş›Ás
);

72 
	`šüRefCouÁ
(
chªÃl
);

74 
ş›Ás
 = 
	`diùG‘V®
(
de
);

76 
	`li¡AddNodeTa
(
ş›Ás
,
c
);

79 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

80 
	`addR•ly
(
c
,
sh¬ed
.
subsüibebulk
);

81 
	`addR•lyBulk
(
c
,
chªÃl
);

82 
	`addR•lyLÚgLÚg
(
c
,
	`ş›ÁSubsütiÚsCouÁ
(c));

83  
»tv®
;

84 
	}
}

88 
	$pubsubUnsubsüibeChªÃl
(
ş›Á
 *
c
, 
robj
 *
chªÃl
, 
nÙify
) {

89 
diùEÁry
 *
de
;

90 
li¡
 *
ş›Ás
;

91 
li¡Node
 *
Ê
;

92 
»tv®
 = 0;

95 
	`šüRefCouÁ
(
chªÃl
);

97 ià(
	`diùD–‘e
(
c
->
pubsub_chªÃls
,
chªÃl
è=ğ
DICT_OK
) {

98 
»tv®
 = 1;

100 
de
 = 
	`diùFšd
(
£rv”
.
pubsub_chªÃls
,
chªÃl
);

101 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
de
 != NULL);

102 
ş›Ás
 = 
	`diùG‘V®
(
de
);

103 
Ê
 = 
	`li¡S—rchKey
(
ş›Ás
,
c
);

104 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
Ê
 != NULL);

105 
	`li¡D–Node
(
ş›Ás
,
Ê
);

106 ià(
	`li¡L’gth
(
ş›Ás
) == 0) {

110 
	`diùD–‘e
(
£rv”
.
pubsub_chªÃls
,
chªÃl
);

114 ià(
nÙify
) {

115 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

116 
	`addR•ly
(
c
,
sh¬ed
.
unsubsüibebulk
);

117 
	`addR•lyBulk
(
c
,
chªÃl
);

118 
	`addR•lyLÚgLÚg
(
c
,
	`diùSize
(c->
pubsub_chªÃls
)+

119 
	`li¡L’gth
(
c
->
pubsub_·‰”ns
));

122 
	`deüRefCouÁ
(
chªÃl
);

123  
»tv®
;

124 
	}
}

127 
	$pubsubSubsüibeP©‹º
(
ş›Á
 *
c
, 
robj
 *
·‰”n
) {

128 
»tv®
 = 0;

130 ià(
	`li¡S—rchKey
(
c
->
pubsub_·‰”ns
,
·‰”n
è=ğ
NULL
) {

131 
»tv®
 = 1;

132 
pubsubP©‹º
 *
·t
;

133 
	`li¡AddNodeTa
(
c
->
pubsub_·‰”ns
,
·‰”n
);

134 
	`šüRefCouÁ
(
·‰”n
);

135 
·t
 = 
	`zm®loc
((*pat));

136 
·t
->
·‰”n
 = 
	`g‘DecodedObjeù
(pattern);

137 
·t
->
ş›Á
 = 
c
;

138 
	`li¡AddNodeTa
(
£rv”
.
pubsub_·‰”ns
,
·t
);

141 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

142 
	`addR•ly
(
c
,
sh¬ed
.
psubsüibebulk
);

143 
	`addR•lyBulk
(
c
,
·‰”n
);

144 
	`addR•lyLÚgLÚg
(
c
,
	`ş›ÁSubsütiÚsCouÁ
(c));

145  
»tv®
;

146 
	}
}

150 
	$pubsubUnsubsüibeP©‹º
(
ş›Á
 *
c
, 
robj
 *
·‰”n
, 
nÙify
) {

151 
li¡Node
 *
Ê
;

152 
pubsubP©‹º
 
·t
;

153 
»tv®
 = 0;

155 
	`šüRefCouÁ
(
·‰”n
);

156 ià((
Ê
 = 
	`li¡S—rchKey
(
c
->
pubsub_·‰”ns
,
·‰”n
)è!ğ
NULL
) {

157 
»tv®
 = 1;

158 
	`li¡D–Node
(
c
->
pubsub_·‰”ns
,
Ê
);

159 
·t
.
ş›Á
 = 
c
;

160 
·t
.
·‰”n
 =…attern;

161 
Ê
 = 
	`li¡S—rchKey
(
£rv”
.
pubsub_·‰”ns
,&
·t
);

162 
	`li¡D–Node
(
£rv”
.
pubsub_·‰”ns
,
Ê
);

165 ià(
nÙify
) {

166 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

167 
	`addR•ly
(
c
,
sh¬ed
.
punsubsüibebulk
);

168 
	`addR•lyBulk
(
c
,
·‰”n
);

169 
	`addR•lyLÚgLÚg
(
c
,
	`diùSize
(c->
pubsub_chªÃls
)+

170 
	`li¡L’gth
(
c
->
pubsub_·‰”ns
));

172 
	`deüRefCouÁ
(
·‰”n
);

173  
»tv®
;

174 
	}
}

178 
	$pubsubUnsubsüibeAÎChªÃls
(
ş›Á
 *
c
, 
nÙify
) {

179 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘SaãI‹¿tÜ
(
c
->
pubsub_chªÃls
);

180 
diùEÁry
 *
de
;

181 
couÁ
 = 0;

183 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

184 
robj
 *
chªÃl
 = 
	`diùG‘Key
(
de
);

186 
couÁ
 +ğ
	`pubsubUnsubsüibeChªÃl
(
c
,
chªÃl
,
nÙify
);

189 ià(
nÙify
 && 
couÁ
 == 0) {

190 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

191 
	`addR•ly
(
c
,
sh¬ed
.
unsubsüibebulk
);

192 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

193 
	`addR•lyLÚgLÚg
(
c
,
	`diùSize
(c->
pubsub_chªÃls
)+

194 
	`li¡L’gth
(
c
->
pubsub_·‰”ns
));

196 
	`diùR–—£I‹¿tÜ
(
di
);

197  
couÁ
;

198 
	}
}

202 
	$pubsubUnsubsüibeAÎP©‹ºs
(
ş›Á
 *
c
, 
nÙify
) {

203 
li¡Node
 *
Ê
;

204 
li¡I‹r
 
li
;

205 
couÁ
 = 0;

207 
	`li¡Rewšd
(
c
->
pubsub_·‰”ns
,&
li
);

208 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

209 
robj
 *
·‰”n
 = 
Ê
->
v®ue
;

211 
couÁ
 +ğ
	`pubsubUnsubsüibeP©‹º
(
c
,
·‰”n
,
nÙify
);

213 ià(
nÙify
 && 
couÁ
 == 0) {

215 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

216 
	`addR•ly
(
c
,
sh¬ed
.
punsubsüibebulk
);

217 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

218 
	`addR•lyLÚgLÚg
(
c
,
	`diùSize
(c->
pubsub_chªÃls
)+

219 
	`li¡L’gth
(
c
->
pubsub_·‰”ns
));

221  
couÁ
;

222 
	}
}

225 
	$pubsubPublishMes§ge
(
robj
 *
chªÃl
,„obj *
mes§ge
) {

226 
»ûiv”s
 = 0;

227 
diùEÁry
 *
de
;

228 
li¡Node
 *
Ê
;

229 
li¡I‹r
 
li
;

232 
de
 = 
	`diùFšd
(
£rv”
.
pubsub_chªÃls
,
chªÃl
);

233 ià(
de
) {

234 
li¡
 *li¡ = 
	`diùG‘V®
(
de
);

235 
li¡Node
 *
Ê
;

236 
li¡I‹r
 
li
;

238 
	`li¡Rewšd
(
li¡
,&
li
);

239 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

240 
ş›Á
 *
c
 = 
Ê
->
v®ue
;

242 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

243 
	`addR•ly
(
c
,
sh¬ed
.
mes§gebulk
);

244 
	`addR•lyBulk
(
c
,
chªÃl
);

245 
	`addR•lyBulk
(
c
,
mes§ge
);

246 
»ûiv”s
++;

250 ià(
	`li¡L’gth
(
£rv”
.
pubsub_·‰”ns
)) {

251 
	`li¡Rewšd
(
£rv”
.
pubsub_·‰”ns
,&
li
);

252 
chªÃl
 = 
	`g‘DecodedObjeù
(channel);

253 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

254 
pubsubP©‹º
 *
·t
 = 
Ê
->
v®ue
;

256 ià(
	`¡ršgm©chËn
((*)
·t
->
·‰”n
->
±r
,

257 
	`sd¦’
(
·t
->
·‰”n
->
±r
),

258 (*)
chªÃl
->
±r
,

259 
	`sd¦’
(
chªÃl
->
±r
),0)) {

260 
	`addR•ly
(
·t
->
ş›Á
,
sh¬ed
.
mbulkhdr
[4]);

261 
	`addR•ly
(
·t
->
ş›Á
,
sh¬ed
.
pmes§gebulk
);

262 
	`addR•lyBulk
(
·t
->
ş›Á
,·t->
·‰”n
);

263 
	`addR•lyBulk
(
·t
->
ş›Á
,
chªÃl
);

264 
	`addR•lyBulk
(
·t
->
ş›Á
,
mes§ge
);

265 
»ûiv”s
++;

268 
	`deüRefCouÁ
(
chªÃl
);

270  
»ûiv”s
;

271 
	}
}

277 
	$subsüibeCommªd
(
ş›Á
 *
c
) {

278 
j
;

280 
j
 = 1; j < 
c
->
¬gc
; j++)

281 
	`pubsubSubsüibeChªÃl
(
c
,c->
¬gv
[
j
]);

282 
c
->
æags
 |ğ
CLIENT_PUBSUB
;

283 
	}
}

285 
	$unsubsüibeCommªd
(
ş›Á
 *
c
) {

286 ià(
c
->
¬gc
 == 1) {

287 
	`pubsubUnsubsüibeAÎChªÃls
(
c
,1);

289 
j
;

291 
j
 = 1; j < 
c
->
¬gc
; j++)

292 
	`pubsubUnsubsüibeChªÃl
(
c
,c->
¬gv
[
j
],1);

294 ià(
	`ş›ÁSubsütiÚsCouÁ
(
c
è=ğ0èc->
æags
 &ğ~
CLIENT_PUBSUB
;

295 
	}
}

297 
	$psubsüibeCommªd
(
ş›Á
 *
c
) {

298 
j
;

300 
j
 = 1; j < 
c
->
¬gc
; j++)

301 
	`pubsubSubsüibeP©‹º
(
c
,c->
¬gv
[
j
]);

302 
c
->
æags
 |ğ
CLIENT_PUBSUB
;

303 
	}
}

305 
	$punsubsüibeCommªd
(
ş›Á
 *
c
) {

306 ià(
c
->
¬gc
 == 1) {

307 
	`pubsubUnsubsüibeAÎP©‹ºs
(
c
,1);

309 
j
;

311 
j
 = 1; j < 
c
->
¬gc
; j++)

312 
	`pubsubUnsubsüibeP©‹º
(
c
,c->
¬gv
[
j
],1);

314 ià(
	`ş›ÁSubsütiÚsCouÁ
(
c
è=ğ0èc->
æags
 &ğ~
CLIENT_PUBSUB
;

315 
	}
}

317 
	$publishCommªd
(
ş›Á
 *
c
) {

318 
»ûiv”s
 = 
	`pubsubPublishMes§ge
(
c
->
¬gv
[1],c->argv[2]);

319 ià(
£rv”
.
şu¡”_’abËd
)

320 
	`şu¡”Prİag©ePublish
(
c
->
¬gv
[1],c->argv[2]);

322 
	`fÜûCommªdPrİag©iÚ
(
c
,
PROPAGATE_REPL
);

323 
	`addR•lyLÚgLÚg
(
c
,
»ûiv”s
);

324 
	}
}

327 
	$pubsubCommªd
(
ş›Á
 *
c
) {

328 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"channels") &&

329 (
c
->
¬gc
 == 2 || c->argc ==3))

332 
sds
 
·t
 = (
c
->
¬gc
 =ğ2è? 
NULL
 : c->
¬gv
[2]->
±r
;

333 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
£rv”
.
pubsub_chªÃls
);

334 
diùEÁry
 *
de
;

335 
mbËn
 = 0;

336 *
»¶yËn
;

338 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

339 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

340 
robj
 *
cobj
 = 
	`diùG‘Key
(
de
);

341 
sds
 
chªÃl
 = 
cobj
->
±r
;

343 ià(!
·t
 || 
	`¡ršgm©chËn
Õ©, 
	`sd¦’
(pat),

344 
chªÃl
, 
	`sd¦’
(channel),0))

346 
	`addR•lyBulk
(
c
,
cobj
);

347 
mbËn
++;

350 
	`diùR–—£I‹¿tÜ
(
di
);

351 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn
,
mbËn
);

352 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"numsub"è&& c->
¬gc
 >= 2) {

354 
j
;

356 
	`addR•lyMuÉiBulkL’
(
c
,(c->
¬gc
-2)*2);

357 
j
 = 2; j < 
c
->
¬gc
; j++) {

358 
li¡
 *
l
 = 
	`diùF‘chV®ue
(
£rv”
.
pubsub_chªÃls
,
c
->
¬gv
[
j
]);

360 
	`addR•lyBulk
(
c
,c->
¬gv
[
j
]);

361 
	`addR•lyLÚgLÚg
(
c
,
l
 ? 
	`li¡L’gth
(l) : 0);

363 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"num·t"è&& c->
¬gc
 == 2) {

365 
	`addR•lyLÚgLÚg
(
c
,
	`li¡L’gth
(
£rv”
.
pubsub_·‰”ns
));

367 
	`addR•lyE¼ÜFÜm©
(
c
,

369 (*)
c
->
¬gv
[1]->
±r
);

371 
	}
}

	@quicklist.c

31 
	~<¡ršg.h
>

32 
	~"quickli¡.h
"

33 
	~"zm®loc.h
"

34 
	~"zli¡.h
"

35 
	~"ut.h
"

36 
	~"lzf.h
"

38 #ià
defšed
(
REDIS_TEST
è|| defšed(
REDIS_TEST_VERBOSE
)

39 
	~<¡dio.h
>

42 #iâdeà
REDIS_STATIC


43 
	#REDIS_STATIC
 

	)

47 cÚ¡ 
size_t
 
	gİtimiz©iÚ_Ëv–
[] = {4096, 8192, 16384, 32768, 65536};

51 
	#SIZE_SAFETY_LIMIT
 8192

	)

54 
	#MIN_COMPRESS_BYTES
 48

	)

59 
	#MIN_COMPRESS_IMPROVE
 8

	)

62 #iâdeà
REDIS_TEST_VERBOSE


63 
	#D
(...)

	)

65 
	#D
(...) \

67 
	`´štf
("%s:%s:%d:\t", 
__FILE__
, 
__FUNCTION__
, 
__LINE__
); \

68 
	`´štf
(
__VA_ARGS__
); \

69 
	`´štf
("\n"); \

70 } 0);

	)

74 
	#š™EÁry
(
e
) \

76 (
e
)->
zi
 = (e)->
v®ue
 = 
NULL
; \

77 (
e
)->
lÚgv®
 = -123456789; \

78 (
e
)->
quickli¡
 = 
NULL
; \

79 (
e
)->
node
 = 
NULL
; \

80 (
e
)->
off£t
 = 123456789; \

81 (
e
)->
sz
 = 0; \

82 } 0)

	)

84 #ià
__GNUC__
 >= 3

85 
	#lik–y
(
x
è
	`__butš_ex³ù
(!!(x), 1)

	)

86 
	#uÆik–y
(
x
è
	`__butš_ex³ù
(!!(x), 0)

	)

88 
	#lik–y
(
x
è(x)

	)

89 
	#uÆik–y
(
x
è(x)

	)

94 
quickli¡
 *
	$quickli¡C»©e
() {

95 
quickli¡
 *quicklist;

97 
quickli¡
 = 
	`zm®loc
((*quicklist));

98 
quickli¡
->
h—d
 = quickli¡->

 = 
NULL
;

99 
quickli¡
->
Ën
 = 0;

100 
quickli¡
->
couÁ
 = 0;

101 
quickli¡
->
com´ess
 = 0;

102 
quickli¡
->
fl
 = -2;

103  
quickli¡
;

104 
	}
}

106 
	#COMPRESS_MAX
 (1 << 16)

	)

107 
	$quickli¡S‘Com´essD•th
(
quickli¡
 *quickli¡, 
com´ess
) {

108 ià(
com´ess
 > 
COMPRESS_MAX
) {

109 
com´ess
 = 
COMPRESS_MAX
;

110 } ià(
com´ess
 < 0) {

111 
com´ess
 = 0;

113 
quickli¡
->
com´ess
 = compress;

114 
	}
}

116 
	#FILL_MAX
 (1 << 15)

	)

117 
	$quickli¡S‘Fl
(
quickli¡
 *quickli¡, 
fl
) {

118 ià(
fl
 > 
FILL_MAX
) {

119 
fl
 = 
FILL_MAX
;

120 } ià(
fl
 < -5) {

121 
fl
 = -5;

123 
quickli¡
->
fl
 = fill;

124 
	}
}

126 
	$quickli¡S‘O±iÚs
(
quickli¡
 *quickli¡, 
fl
, 
d•th
) {

127 
	`quickli¡S‘Fl
(
quickli¡
, 
fl
);

128 
	`quickli¡S‘Com´essD•th
(
quickli¡
, 
d•th
);

129 
	}
}

132 
quickli¡
 *
	$quickli¡New
(
fl
, 
com´ess
) {

133 
quickli¡
 *quickli¡ = 
	`quickli¡C»©e
();

134 
	`quickli¡S‘O±iÚs
(
quickli¡
, 
fl
, 
com´ess
);

135  
quickli¡
;

136 
	}
}

138 
REDIS_STATIC
 
quickli¡Node
 *
	$quickli¡C»©eNode
() {

139 
quickli¡Node
 *
node
;

140 
node
 = 
	`zm®loc
((*node));

141 
node
->
zl
 = 
NULL
;

142 
node
->
couÁ
 = 0;

143 
node
->
sz
 = 0;

144 
node
->
Ãxt
 =‚ode->
´ev
 = 
NULL
;

145 
node
->
’codšg
 = 
QUICKLIST_NODE_ENCODING_RAW
;

146 
node
->
cÚš”
 = 
QUICKLIST_NODE_CONTAINER_ZIPLIST
;

147 
node
->
»com´ess
 = 0;

148  
node
;

149 
	}
}

152 
	$quickli¡CouÁ
(cÚ¡ 
quickli¡
 *
ql
è{  ql->
couÁ
; 
	}
}

155 
	$quickli¡R–—£
(
quickli¡
 *quicklist) {

156 
Ën
;

157 
quickli¡Node
 *
cu¼’t
, *
Ãxt
;

159 
cu¼’t
 = 
quickli¡
->
h—d
;

160 
Ën
 = 
quickli¡
->len;

161 
Ën
--) {

162 
Ãxt
 = 
cu¼’t
->next;

164 
	`zä“
(
cu¼’t
->
zl
);

165 
quickli¡
->
couÁ
 -ğ
cu¼’t
->count;

167 
	`zä“
(
cu¼’t
);

169 
quickli¡
->
Ën
--;

170 
cu¼’t
 = 
Ãxt
;

172 
	`zä“
(
quickli¡
);

173 
	}
}

178 
REDIS_STATIC
 
	$__quickli¡Com´essNode
(
quickli¡Node
 *
node
) {

179 #ifdeà
REDIS_TEST


180 
node
->
©‹m±ed_com´ess
 = 1;

184 ià(
node
->
sz
 < 
MIN_COMPRESS_BYTES
)

187 
quickli¡LZF
 *
lzf
 = 
	`zm®loc
((*lzfè+ 
node
->
sz
);

190 ià(((
lzf
->
sz
 = 
	`lzf_com´ess
(
node
->
zl
,‚ode->sz,†zf->
com´es£d
,

191 
node
->
sz
)) == 0) ||

192 
lzf
->
sz
 + 
MIN_COMPRESS_IMPROVE
 >ğ
node
->sz) {

194 
	`zä“
(
lzf
);

197 
lzf
 = 
	`z»®loc
Özf, (*lzfè+†zf->
sz
);

198 
	`zä“
(
node
->
zl
);

199 
node
->
zl
 = (*)
lzf
;

200 
node
->
’codšg
 = 
QUICKLIST_NODE_ENCODING_LZF
;

201 
node
->
»com´ess
 = 0;

203 
	}
}

206 
	#quickli¡Com´essNode
(
_node
) \

208 ià((
_node
è&& (_node)->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_RAW
) { \

209 
	`__quickli¡Com´essNode
((
_node
)); \

211 } 0)

	)

215 
REDIS_STATIC
 
	$__quickli¡Decom´essNode
(
quickli¡Node
 *
node
) {

216 #ifdeà
REDIS_TEST


217 
node
->
©‹m±ed_com´ess
 = 0;

220 *
decom´es£d
 = 
	`zm®loc
(
node
->
sz
);

221 
quickli¡LZF
 *
lzf
 = (quickli¡LZF *)
node
->
zl
;

222 ià(
	`lzf_decom´ess
(
lzf
->
com´es£d
,†zf->
sz
, 
decom´es£d
, 
node
->sz) == 0) {

224 
	`zä“
(
decom´es£d
);

227 
	`zä“
(
lzf
);

228 
node
->
zl
 = 
decom´es£d
;

229 
node
->
’codšg
 = 
QUICKLIST_NODE_ENCODING_RAW
;

231 
	}
}

234 
	#quickli¡Decom´essNode
(
_node
) \

236 ià((
_node
è&& (_node)->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_LZF
) { \

237 
	`__quickli¡Decom´essNode
((
_node
)); \

239 } 0)

	)

242 
	#quickli¡Decom´essNodeFÜU£
(
_node
) \

244 ià((
_node
è&& (_node)->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_LZF
) { \

245 
	`__quickli¡Decom´essNode
((
_node
)); \

246 (
_node
)->
»com´ess
 = 1; \

248 } 0)

	)

253 
size_t
 
	$quickli¡G‘Lzf
(cÚ¡ 
quickli¡Node
 *
node
, **
d©a
) {

254 
quickli¡LZF
 *
lzf
 = (quickli¡LZF *)
node
->
zl
;

255 *
d©a
 = 
lzf
->
com´es£d
;

256  
lzf
->
sz
;

257 
	}
}

259 
	#quickli¡AÎowsCom´essiÚ
(
_ql
è((_ql)->
com´ess
 !ğ0)

	)

265 
REDIS_STATIC
 
	$__quickli¡Com´ess
(cÚ¡ 
quickli¡
 *quicklist,

266 
quickli¡Node
 *
node
) {

269 ià(!
	`quickli¡AÎowsCom´essiÚ
(
quickli¡
) ||

270 
quickli¡
->
Ën
 < ()(quickli¡->
com´ess
 * 2))

275 ià(
quickli¡
->
com´ess
 == 1) {

276 
quickli¡Node
 *
h
 = 
quickli¡
->
h—d
, *
t
 = quickli¡->

;

277 
	`quickli¡Decom´essNode
(
h
);

278 
	`quickli¡Decom´essNode
(
t
);

279 ià(
h
 !ğ
node
 && 
t
 !=‚ode)

280 
	`quickli¡Com´essNode
(
node
);

282 } ià(
quickli¡
->
com´ess
 == 2) {

283 
quickli¡Node
 *
h
 = 
quickli¡
->
h—d
, *
hn
 = h->
Ãxt
, *
hÂ
 = hn->next;

284 
quickli¡Node
 *
t
 = 
quickli¡
->

, *

 =->
´ev
, *
p
 =p->prev;

285 
	`quickli¡Decom´essNode
(
h
);

286 
	`quickli¡Decom´essNode
(
hn
);

287 
	`quickli¡Decom´essNode
(
t
);

288 
	`quickli¡Decom´essNode
(

);

289 ià(
h
 !ğ
node
 && 
hn
 !ğnod&& 
t
 !ğnod&& 

 !=‚ode) {

290 
	`quickli¡Com´essNode
(
node
);

292 ià(
hÂ
 !ğ
t
) {

293 
	`quickli¡Com´essNode
(
hÂ
);

295 ià(
p
 !ğ
h
) {

296 
	`quickli¡Com´essNode
(
p
);

305 
quickli¡Node
 *
fÜw¬d
 = 
quickli¡
->
h—d
;

306 
quickli¡Node
 *
»v”£
 = 
quickli¡
->

;

307 
d•th
 = 0;

308 
š_d•th
 = 0;

309 
d•th
++ < 
quickli¡
->
com´ess
) {

310 
	`quickli¡Decom´essNode
(
fÜw¬d
);

311 
	`quickli¡Decom´essNode
(
»v”£
);

313 ià(
fÜw¬d
 =ğ
node
 || 
»v”£
 ==‚ode)

314 
š_d•th
 = 1;

316 ià(
fÜw¬d
 =ğ
»v”£
)

319 
fÜw¬d
 = fÜw¬d->
Ãxt
;

320 
»v”£
 =„ev”£->
´ev
;

323 ià(!
š_d•th
)

324 
	`quickli¡Com´essNode
(
node
);

326 ià(
d•th
 > 2) {

328 
	`quickli¡Com´essNode
(
fÜw¬d
);

329 
	`quickli¡Com´essNode
(
»v”£
);

331 
	}
}

333 
	#quickli¡Com´ess
(
_ql
, 
_node
) \

335 ià((
_node
)->
»com´ess
) \

336 
	`quickli¡Com´essNode
((
_node
)); \

338 
	`__quickli¡Com´ess
((
_ql
), (
_node
)); \

339 } 0)

	)

342 
	#quickli¡Recom´essOÆy
(
_ql
, 
_node
) \

344 ià((
_node
)->
»com´ess
) \

345 
	`quickli¡Com´essNode
((
_node
)); \

346 } 0)

	)

352 
REDIS_STATIC
 
	$__quickli¡In£¹Node
(
quickli¡
 *quicklist,

353 
quickli¡Node
 *
Şd_node
,

354 
quickli¡Node
 *
Ãw_node
, 
aá”
) {

355 ià(
aá”
) {

356 
Ãw_node
->
´ev
 = 
Şd_node
;

357 ià(
Şd_node
) {

358 
Ãw_node
->
Ãxt
 = 
Şd_node
->next;

359 ià(
Şd_node
->
Ãxt
)

360 
Şd_node
->
Ãxt
->
´ev
 = 
Ãw_node
;

361 
Şd_node
->
Ãxt
 = 
Ãw_node
;

363 ià(
quickli¡
->

 =ğ
Şd_node
)

364 
quickli¡
->

 = 
Ãw_node
;

366 
Ãw_node
->
Ãxt
 = 
Şd_node
;

367 ià(
Şd_node
) {

368 
Ãw_node
->
´ev
 = 
Şd_node
->prev;

369 ià(
Şd_node
->
´ev
)

370 
Şd_node
->
´ev
->
Ãxt
 = 
Ãw_node
;

371 
Şd_node
->
´ev
 = 
Ãw_node
;

373 ià(
quickli¡
->
h—d
 =ğ
Şd_node
)

374 
quickli¡
->
h—d
 = 
Ãw_node
;

377 ià(
quickli¡
->
Ën
 == 0) {

378 
quickli¡
->
h—d
 = quickli¡->

 = 
Ãw_node
;

381 ià(
Şd_node
)

382 
	`quickli¡Com´ess
(
quickli¡
, 
Şd_node
);

384 
quickli¡
->
Ën
++;

385 
	}
}

388 
REDIS_STATIC
 
	$_quickli¡In£¹NodeBefÜe
(
quickli¡
 *quicklist,

389 
quickli¡Node
 *
Şd_node
,

390 
quickli¡Node
 *
Ãw_node
) {

391 
	`__quickli¡In£¹Node
(
quickli¡
, 
Şd_node
, 
Ãw_node
, 0);

392 
	}
}

394 
REDIS_STATIC
 
	$_quickli¡In£¹NodeAá”
(
quickli¡
 *quicklist,

395 
quickli¡Node
 *
Şd_node
,

396 
quickli¡Node
 *
Ãw_node
) {

397 
	`__quickli¡In£¹Node
(
quickli¡
, 
Şd_node
, 
Ãw_node
, 1);

398 
	}
}

400 
REDIS_STATIC
 

401 
	$_quickli¡NodeSizeM“tsO±imiz©iÚRequœem’t
(cÚ¡ 
size_t
 
sz
,

402 cÚ¡ 
fl
) {

403 ià(
fl
 >= 0)

406 
size_t
 
off£t
 = (-
fl
) - 1;

407 ià(
off£t
 < ((
İtimiz©iÚ_Ëv–
) / (*optimization_level))) {

408 ià(
sz
 <ğ
İtimiz©iÚ_Ëv–
[
off£t
]) {

416 
	}
}

418 
	#sizeM“tsSaãtyLim™
(
sz
è((szè<ğ
SIZE_SAFETY_LIMIT
)

	)

420 
REDIS_STATIC
 
	$_quickli¡NodeAÎowIn£¹
(cÚ¡ 
quickli¡Node
 *
node
,

421 cÚ¡ 
fl
, cÚ¡ 
size_t
 
sz
) {

422 ià(
	`uÆik–y
(!
node
))

425 
zli¡_ov”h—d
;

427 ià(
sz
 < 254)

428 
zli¡_ov”h—d
 = 1;

430 
zli¡_ov”h—d
 = 5;

433 ià(
sz
 < 64)

434 
zli¡_ov”h—d
 += 1;

435 ià(
	`lik–y
(
sz
 < 16384))

436 
zli¡_ov”h—d
 += 2;

438 
zli¡_ov”h—d
 += 5;

441 
Ãw_sz
 = 
node
->
sz
 + sz + 
zli¡_ov”h—d
;

442 ià(
	`lik–y
(
	`_quickli¡NodeSizeM“tsO±imiz©iÚRequœem’t
(
Ãw_sz
, 
fl
)))

444 ià(!
	`sizeM“tsSaãtyLim™
(
Ãw_sz
))

446 ià(()
node
->
couÁ
 < 
fl
)

450 
	}
}

452 
REDIS_STATIC
 
	$_quickli¡NodeAÎowM”ge
(cÚ¡ 
quickli¡Node
 *
a
,

453 cÚ¡ 
quickli¡Node
 *
b
,

454 cÚ¡ 
fl
) {

455 ià(!
a
 || !
b
)

460 
m”ge_sz
 = 
a
->
sz
 + 
b
->sz - 11;

461 ià(
	`lik–y
(
	`_quickli¡NodeSizeM“tsO±imiz©iÚRequœem’t
(
m”ge_sz
, 
fl
)))

463 ià(!
	`sizeM“tsSaãtyLim™
(
m”ge_sz
))

465 ià(()(
a
->
couÁ
 + 
b
->couÁè<ğ
fl
)

469 
	}
}

471 
	#quickli¡NodeUpd©eSz
(
node
) \

473 (
node
)->
sz
 = 
	`zli¡BlobL’
(Òode)->
zl
); \

474 } 0)

	)

480 
	$quickli¡PushH—d
(
quickli¡
 *quickli¡, *
v®ue
, 
size_t
 
sz
) {

481 
quickli¡Node
 *
Üig_h—d
 = 
quickli¡
->
h—d
;

482 ià(
	`lik–y
(

483 
	`_quickli¡NodeAÎowIn£¹
(
quickli¡
->
h—d
, quickli¡->
fl
, 
sz
))) {

484 
quickli¡
->
h—d
->
zl
 =

485 
	`zli¡Push
(
quickli¡
->
h—d
->
zl
, 
v®ue
, 
sz
, 
ZIPLIST_HEAD
);

486 
	`quickli¡NodeUpd©eSz
(
quickli¡
->
h—d
);

488 
quickli¡Node
 *
node
 = 
	`quickli¡C»©eNode
();

489 
node
->
zl
 = 
	`zli¡Push
(
	`zli¡New
(), 
v®ue
, 
sz
, 
ZIPLIST_HEAD
);

491 
	`quickli¡NodeUpd©eSz
(
node
);

492 
	`_quickli¡In£¹NodeBefÜe
(
quickli¡
, quickli¡->
h—d
, 
node
);

494 
quickli¡
->
couÁ
++;

495 
quickli¡
->
h—d
->
couÁ
++;

496  (
Üig_h—d
 !ğ
quickli¡
->
h—d
);

497 
	}
}

503 
	$quickli¡PushTa
(
quickli¡
 *quickli¡, *
v®ue
, 
size_t
 
sz
) {

504 
quickli¡Node
 *
Üig_
 = 
quickli¡
->

;

505 ià(
	`lik–y
(

506 
	`_quickli¡NodeAÎowIn£¹
(
quickli¡
->

, quickli¡->
fl
, 
sz
))) {

507 
quickli¡
->

->
zl
 =

508 
	`zli¡Push
(
quickli¡
->

->
zl
, 
v®ue
, 
sz
, 
ZIPLIST_TAIL
);

509 
	`quickli¡NodeUpd©eSz
(
quickli¡
->

);

511 
quickli¡Node
 *
node
 = 
	`quickli¡C»©eNode
();

512 
node
->
zl
 = 
	`zli¡Push
(
	`zli¡New
(), 
v®ue
, 
sz
, 
ZIPLIST_TAIL
);

514 
	`quickli¡NodeUpd©eSz
(
node
);

515 
	`_quickli¡In£¹NodeAá”
(
quickli¡
, quickli¡->

, 
node
);

517 
quickli¡
->
couÁ
++;

518 
quickli¡
->

->
couÁ
++;

519  (
Üig_
 !ğ
quickli¡
->

);

520 
	}
}

525 
	$quickli¡Aµ’dZli¡
(
quickli¡
 *quickli¡, *
zl
) {

526 
quickli¡Node
 *
node
 = 
	`quickli¡C»©eNode
();

528 
node
->
zl
 = zl;

529 
node
->
couÁ
 = 
	`zli¡L’
Òode->
zl
);

530 
node
->
sz
 = 
	`zli¡BlobL’
(
zl
);

532 
	`_quickli¡In£¹NodeAá”
(
quickli¡
, quickli¡->

, 
node
);

533 
quickli¡
->
couÁ
 +ğ
node
->count;

534 
	}
}

542 
quickli¡
 *
	$quickli¡Aµ’dV®uesFromZli¡
(
quickli¡
 *quicklist,

543 *
zl
) {

544 *
v®ue
;

545 
sz
;

546 
lÚgv®
;

547 
lÚg¡r
[32] = {0};

549 *
p
 = 
	`zli¡Index
(
zl
, 0);

550 
	`zli¡G‘
(
p
, &
v®ue
, &
sz
, &
lÚgv®
)) {

551 ià(!
v®ue
) {

553 
sz
 = 
	`Î2¡ršg
(
lÚg¡r
, ÖÚg¡r), 
lÚgv®
);

554 
v®ue
 = (*)
lÚg¡r
;

556 
	`quickli¡PushTa
(
quickli¡
, 
v®ue
, 
sz
);

557 
p
 = 
	`zli¡Next
(
zl
,…);

559 
	`zä“
(
zl
);

560  
quickli¡
;

561 
	}
}

566 
quickli¡
 *
	$quickli¡C»©eFromZli¡
(
fl
, 
com´ess
,

567 *
zl
) {

568  
	`quickli¡Aµ’dV®uesFromZli¡
(
	`quickli¡New
(
fl
, 
com´ess
), 
zl
);

569 
	}
}

571 
	#quickli¡D–‘eIfEm±y
(
ql
, 
n
) \

573 ià((
n
)->
couÁ
 == 0) { \

574 
	`__quickli¡D–Node
((
ql
), (
n
)); \

575 (
n
èğ
NULL
; \

577 } 0)

	)

579 
REDIS_STATIC
 
	$__quickli¡D–Node
(
quickli¡
 *quicklist,

580 
quickli¡Node
 *
node
) {

581 ià(
node
->
Ãxt
)

582 
node
->
Ãxt
->
´ev
 =‚ode->prev;

583 ià(
node
->
´ev
)

584 
node
->
´ev
->
Ãxt
 =‚ode->next;

586 ià(
node
 =ğ
quickli¡
->

) {

587 
quickli¡
->

 = 
node
->
´ev
;

590 ià(
node
 =ğ
quickli¡
->
h—d
) {

591 
quickli¡
->
h—d
 = 
node
->
Ãxt
;

596 
	`__quickli¡Com´ess
(
quickli¡
, 
NULL
);

598 
quickli¡
->
couÁ
 -ğ
node
->count;

600 
	`zä“
(
node
->
zl
);

601 
	`zä“
(
node
);

602 
quickli¡
->
Ën
--;

603 
	}
}

613 
REDIS_STATIC
 
	$quickli¡D–Index
(
quickli¡
 *quickli¡, 
quickli¡Node
 *
node
,

614 **
p
) {

615 
gÚe
 = 0;

617 
node
->
zl
 = 
	`zli¡D–‘e
Òode->zl, 
p
);

618 
node
->
couÁ
--;

619 ià(
node
->
couÁ
 == 0) {

620 
gÚe
 = 1;

621 
	`__quickli¡D–Node
(
quickli¡
, 
node
);

623 
	`quickli¡NodeUpd©eSz
(
node
);

625 
quickli¡
->
couÁ
--;

627  
gÚe
 ? 1 : 0;

628 
	}
}

634 
	$quickli¡D–EÁry
(
quickli¡I‹r
 *
™”
, 
quickli¡EÁry
 *
’Œy
) {

635 
quickli¡Node
 *
´ev
 = 
’Œy
->
node
->prev;

636 
quickli¡Node
 *
Ãxt
 = 
’Œy
->
node
->next;

637 
d–‘ed_node
 = 
	`quickli¡D–Index
((
quickli¡
 *)
’Œy
->quicklist,

638 
’Œy
->
node
, &’Œy->
zi
);

641 
™”
->
zi
 = 
NULL
;

644 ià(
d–‘ed_node
) {

645 ià(
™”
->
dœeùiÚ
 =ğ
AL_START_HEAD
) {

646 
™”
->
cu¼’t
 = 
Ãxt
;

647 
™”
->
off£t
 = 0;

648 } ià(
™”
->
dœeùiÚ
 =ğ
AL_START_TAIL
) {

649 
™”
->
cu¼’t
 = 
´ev
;

650 
™”
->
off£t
 = -1;

661 
	}
}

667 
	$quickli¡R•ÏûAtIndex
(
quickli¡
 *quickli¡, 
šdex
, *
d©a
,

668 
sz
) {

669 
quickli¡EÁry
 
’Œy
;

670 ià(
	`lik–y
(
	`quickli¡Index
(
quickli¡
, 
šdex
, &
’Œy
))) {

672 
’Œy
.
node
->
zl
 = 
	`zli¡D–‘e
ÓÁry.node->zl, &’Œy.
zi
);

673 
’Œy
.
node
->
zl
 = 
	`zli¡In£¹
ÓÁry.node->zl,ƒÁry.
zi
, 
d©a
, 
sz
);

674 
	`quickli¡NodeUpd©eSz
(
’Œy
.
node
);

675 
	`quickli¡Com´ess
(
quickli¡
, 
’Œy
.
node
);

680 
	}
}

695 
REDIS_STATIC
 
quickli¡Node
 *
	$_quickli¡Zli¡M”ge
(
quickli¡
 *quicklist,

696 
quickli¡Node
 *
a
,

697 
quickli¡Node
 *
b
) {

698 
	`D
("Reque¡ed m”g×,bè(%u, %u)", 
a
->
couÁ
, 
b
->count);

700 
	`quickli¡Decom´essNode
(
a
);

701 
	`quickli¡Decom´essNode
(
b
);

702 ià((
	`zli¡M”ge
(&
a
->
zl
, &
b
->zl))) {

704 
quickli¡Node
 *
k“p
 = 
NULL
, *
nok“p
 = NULL;

705 ià(!
a
->
zl
) {

706 
nok“p
 = 
a
;

707 
k“p
 = 
b
;

708 } ià(!
b
->
zl
) {

709 
nok“p
 = 
b
;

710 
k“p
 = 
a
;

712 
k“p
->
couÁ
 = 
	`zli¡L’
(k“p->
zl
);

713 
	`quickli¡NodeUpd©eSz
(
k“p
);

715 
nok“p
->
couÁ
 = 0;

716 
	`__quickli¡D–Node
(
quickli¡
, 
nok“p
);

717 
	`quickli¡Com´ess
(
quickli¡
, 
k“p
);

718  
k“p
;

721  
NULL
;

723 
	}
}

733 
REDIS_STATIC
 
	$_quickli¡M”geNodes
(
quickli¡
 *quicklist,

734 
quickli¡Node
 *
ûÁ”
) {

735 
fl
 = 
quickli¡
->fill;

736 
quickli¡Node
 *
´ev
, *
´ev_´ev
, *
Ãxt
, *
Ãxt_Ãxt
, *
rg‘
;

737 
´ev
 = 
´ev_´ev
 = 
Ãxt
 = 
Ãxt_Ãxt
 = 
rg‘
 = 
NULL
;

739 ià(
ûÁ”
->
´ev
) {

740 
´ev
 = 
ûÁ”
->prev;

741 ià(
ûÁ”
->
´ev
->prev)

742 
´ev_´ev
 = 
ûÁ”
->
´ev
->prev;

745 ià(
ûÁ”
->
Ãxt
) {

746 
Ãxt
 = 
ûÁ”
->next;

747 ià(
ûÁ”
->
Ãxt
->next)

748 
Ãxt_Ãxt
 = 
ûÁ”
->
Ãxt
->next;

752 ià(
	`_quickli¡NodeAÎowM”ge
(
´ev
, 
´ev_´ev
, 
fl
)) {

753 
	`_quickli¡Zli¡M”ge
(
quickli¡
, 
´ev_´ev
, 
´ev
);

754 
´ev_´ev
 = 
´ev
 = 
NULL
;

758 ià(
	`_quickli¡NodeAÎowM”ge
(
Ãxt
, 
Ãxt_Ãxt
, 
fl
)) {

759 
	`_quickli¡Zli¡M”ge
(
quickli¡
, 
Ãxt
, 
Ãxt_Ãxt
);

760 
Ãxt
 = 
Ãxt_Ãxt
 = 
NULL
;

764 ià(
	`_quickli¡NodeAÎowM”ge
(
ûÁ”
, c’‹r->
´ev
, 
fl
)) {

765 
rg‘
 = 
	`_quickli¡Zli¡M”ge
(
quickli¡
, 
ûÁ”
->
´ev
, center);

766 
ûÁ”
 = 
NULL
;

769 
rg‘
 = 
ûÁ”
;

773 ià(
	`_quickli¡NodeAÎowM”ge
(
rg‘
,¬g‘->
Ãxt
, 
fl
)) {

774 
	`_quickli¡Zli¡M”ge
(
quickli¡
, 
rg‘
,¬g‘->
Ãxt
);

776 
	}
}

797 
REDIS_STATIC
 
quickli¡Node
 *
	$_quickli¡S¶™Node
(
quickli¡Node
 *
node
, 
off£t
,

798 
aá”
) {

799 
size_t
 
zl_sz
 = 
node
->
sz
;

801 
quickli¡Node
 *
Ãw_node
 = 
	`quickli¡C»©eNode
();

802 
Ãw_node
->
zl
 = 
	`zm®loc
(
zl_sz
);

805 
	`memıy
(
Ãw_node
->
zl
, 
node
->zl, 
zl_sz
);

808 
Üig_¡¬t
 = 
aá”
 ? 
off£t
 + 1 : 0;

809 
Üig_ex‹Á
 = 
aá”
 ? -1 : 
off£t
;

810 
Ãw_¡¬t
 = 
aá”
 ? 0 : 
off£t
;

811 
Ãw_ex‹Á
 = 
aá”
 ? 
off£t
 + 1 : -1;

813 
	`D
("Aá” %d (%d);„ªges: [%d, %d], [%d, %d]", 
aá”
, 
off£t
, 
Üig_¡¬t
,

814 
Üig_ex‹Á
, 
Ãw_¡¬t
, 
Ãw_ex‹Á
);

816 
node
->
zl
 = 
	`zli¡D–‘eRªge
Òode->zl, 
Üig_¡¬t
, 
Üig_ex‹Á
);

817 
node
->
couÁ
 = 
	`zli¡L’
Òode->
zl
);

818 
	`quickli¡NodeUpd©eSz
(
node
);

820 
Ãw_node
->
zl
 = 
	`zli¡D–‘eRªge
Òew_node->zl, 
Ãw_¡¬t
, 
Ãw_ex‹Á
);

821 
Ãw_node
->
couÁ
 = 
	`zli¡L’
Òew_node->
zl
);

822 
	`quickli¡NodeUpd©eSz
(
Ãw_node
);

824 
	`D
("Aá” s¶™†’gths: orig (%d),‚ew (%d)", 
node
->
couÁ
, 
Ãw_node
->count);

825  
Ãw_node
;

826 
	}
}

832 
REDIS_STATIC
 
	$_quickli¡In£¹
(
quickli¡
 *quickli¡, 
quickli¡EÁry
 *
’Œy
,

833 *
v®ue
, cÚ¡ 
size_t
 
sz
, 
aá”
) {

834 
fuÎ
 = 0, 
©_
 = 0, 
©_h—d
 = 0, 
fuÎ_Ãxt
 = 0, 
fuÎ_´ev
 = 0;

835 
fl
 = 
quickli¡
->fill;

836 
quickli¡Node
 *
node
 = 
’Œy
->node;

837 
quickli¡Node
 *
Ãw_node
 = 
NULL
;

839 ià(!
node
) {

841 
	`D
("No‚ode given!");

842 
Ãw_node
 = 
	`quickli¡C»©eNode
();

843 
Ãw_node
->
zl
 = 
	`zli¡Push
(
	`zli¡New
(), 
v®ue
, 
sz
, 
ZIPLIST_HEAD
);

844 
	`__quickli¡In£¹Node
(
quickli¡
, 
NULL
, 
Ãw_node
, 
aá”
);

845 
Ãw_node
->
couÁ
++;

846 
quickli¡
->
couÁ
++;

851 ià(!
	`_quickli¡NodeAÎowIn£¹
(
node
, 
fl
, 
sz
)) {

852 
	`D
("Current‚ode is full with count %d with„equested fill %lu",

853 
node
->
couÁ
, 
fl
);

854 
fuÎ
 = 1;

857 ià(
aá”
 && (
’Œy
->
off£t
 =ğ
node
->
couÁ
)) {

858 
	`D
("At Tail of current ziplist");

859 
©_
 = 1;

860 ià(!
	`_quickli¡NodeAÎowIn£¹
(
node
->
Ãxt
, 
fl
, 
sz
)) {

861 
	`D
("Next‚ode is fulloo.");

862 
fuÎ_Ãxt
 = 1;

866 ià(!
aá”
 && (
’Œy
->
off£t
 == 0)) {

867 
	`D
("At Head");

868 
©_h—d
 = 1;

869 ià(!
	`_quickli¡NodeAÎowIn£¹
(
node
->
´ev
, 
fl
, 
sz
)) {

870 
	`D
("Prev‚ode is fulloo.");

871 
fuÎ_´ev
 = 1;

876 ià(!
fuÎ
 && 
aá”
) {

877 
	`D
("Not full, inserting‡fter current…osition.");

878 
	`quickli¡Decom´essNodeFÜU£
(
node
);

879 *
Ãxt
 = 
	`zli¡Next
(
node
->
zl
, 
’Œy
->
zi
);

880 ià(
Ãxt
 =ğ
NULL
) {

881 
node
->
zl
 = 
	`zli¡Push
Òode->zl, 
v®ue
, 
sz
, 
ZIPLIST_TAIL
);

883 
node
->
zl
 = 
	`zli¡In£¹
Òode->zl, 
Ãxt
, 
v®ue
, 
sz
);

885 
node
->
couÁ
++;

886 
	`quickli¡NodeUpd©eSz
(
node
);

887 
	`quickli¡Recom´essOÆy
(
quickli¡
, 
node
);

888 } ià(!
fuÎ
 && !
aá”
) {

889 
	`D
("Not full, inserting before current…osition.");

890 
	`quickli¡Decom´essNodeFÜU£
(
node
);

891 
node
->
zl
 = 
	`zli¡In£¹
Òode->zl, 
’Œy
->
zi
, 
v®ue
, 
sz
);

892 
node
->
couÁ
++;

893 
	`quickli¡NodeUpd©eSz
(
node
);

894 
	`quickli¡Recom´essOÆy
(
quickli¡
, 
node
);

895 } ià(
fuÎ
 && 
©_
 && 
node
->
Ãxt
 && !
fuÎ_Ãxt
 && 
aá”
) {

898 
	`D
("Full‡ndail, but‚ext isn't full; inserting‚ext‚ode head");

899 
Ãw_node
 = 
node
->
Ãxt
;

900 
	`quickli¡Decom´essNodeFÜU£
(
Ãw_node
);

901 
Ãw_node
->
zl
 = 
	`zli¡Push
Òew_node->zl, 
v®ue
, 
sz
, 
ZIPLIST_HEAD
);

902 
Ãw_node
->
couÁ
++;

903 
	`quickli¡NodeUpd©eSz
(
Ãw_node
);

904 
	`quickli¡Recom´essOÆy
(
quickli¡
, 
Ãw_node
);

905 } ià(
fuÎ
 && 
©_h—d
 && 
node
->
´ev
 && !
fuÎ_´ev
 && !
aá”
) {

908 
	`D
("Full‡nd head, but…rev isn't full, inserting…rev‚odeail");

909 
Ãw_node
 = 
node
->
´ev
;

910 
	`quickli¡Decom´essNodeFÜU£
(
Ãw_node
);

911 
Ãw_node
->
zl
 = 
	`zli¡Push
Òew_node->zl, 
v®ue
, 
sz
, 
ZIPLIST_TAIL
);

912 
Ãw_node
->
couÁ
++;

913 
	`quickli¡NodeUpd©eSz
(
Ãw_node
);

914 
	`quickli¡Recom´essOÆy
(
quickli¡
, 
Ãw_node
);

915 } ià(
fuÎ
 && ((
©_
 && 
node
->
Ãxt
 && 
fuÎ_Ãxt
 && 
aá”
) ||

916 (
©_h—d
 && 
node
->
´ev
 && 
fuÎ_´ev
 && !
aá”
))) {

919 
	`D
("\tprovisioning‚ew‚ode...");

920 
Ãw_node
 = 
	`quickli¡C»©eNode
();

921 
Ãw_node
->
zl
 = 
	`zli¡Push
(
	`zli¡New
(), 
v®ue
, 
sz
, 
ZIPLIST_HEAD
);

922 
Ãw_node
->
couÁ
++;

923 
	`quickli¡NodeUpd©eSz
(
Ãw_node
);

924 
	`__quickli¡In£¹Node
(
quickli¡
, 
node
, 
Ãw_node
, 
aá”
);

925 } ià(
fuÎ
) {

928 
	`D
("\tsplitting‚ode...");

929 
	`quickli¡Decom´essNodeFÜU£
(
node
);

930 
Ãw_node
 = 
	`_quickli¡S¶™Node
(
node
, 
’Œy
->
off£t
, 
aá”
);

931 
Ãw_node
->
zl
 = 
	`zli¡Push
Òew_node->zl, 
v®ue
, 
sz
,

932 
aá”
 ? 
ZIPLIST_HEAD
 : 
ZIPLIST_TAIL
);

933 
Ãw_node
->
couÁ
++;

934 
	`quickli¡NodeUpd©eSz
(
Ãw_node
);

935 
	`__quickli¡In£¹Node
(
quickli¡
, 
node
, 
Ãw_node
, 
aá”
);

936 
	`_quickli¡M”geNodes
(
quickli¡
, 
node
);

939 
quickli¡
->
couÁ
++;

940 
	}
}

942 
	$quickli¡In£¹BefÜe
(
quickli¡
 *quickli¡, 
quickli¡EÁry
 *
’Œy
,

943 *
v®ue
, cÚ¡ 
size_t
 
sz
) {

944 
	`_quickli¡In£¹
(
quickli¡
, 
’Œy
, 
v®ue
, 
sz
, 0);

945 
	}
}

947 
	$quickli¡In£¹Aá”
(
quickli¡
 *quickli¡, 
quickli¡EÁry
 *
’Œy
,

948 *
v®ue
, cÚ¡ 
size_t
 
sz
) {

949 
	`_quickli¡In£¹
(
quickli¡
, 
’Œy
, 
v®ue
, 
sz
, 1);

950 
	}
}

958 
	$quickli¡D–Rªge
(
quickli¡
 *quickli¡, cÚ¡ 
¡¬t
,

959 cÚ¡ 
couÁ
) {

960 ià(
couÁ
 <= 0)

963 
ex‹Á
 = 
couÁ
;

965 ià(
¡¬t
 >ğ0 && 
ex‹Á
 > (
quickli¡
->
couÁ
 - start)) {

967 
ex‹Á
 = 
quickli¡
->
couÁ
 - 
¡¬t
;

968 } ià(
¡¬t
 < 0 && 
ex‹Á
 > ()(-start)) {

970 
ex‹Á
 = -
¡¬t
;

973 
quickli¡EÁry
 
’Œy
;

974 ià(!
	`quickli¡Index
(
quickli¡
, 
¡¬t
, &
’Œy
))

977 
	`D
("Quickli¡ d–‘»que¡ fÜ s¹ %ld, couÁ %ld,ƒx‹Á: %ld", 
¡¬t
,

978 
couÁ
, 
ex‹Á
);

979 
quickli¡Node
 *
node
 = 
’Œy
.node;

982 
ex‹Á
) {

983 
quickli¡Node
 *
Ãxt
 = 
node
->next;

985 
d–
;

986 
d–‘e_’tœe_node
 = 0;

987 ià(
’Œy
.
off£t
 =ğ0 && 
ex‹Á
 >ğ
node
->
couÁ
) {

990 
d–‘e_’tœe_node
 = 1;

991 
d–
 = 
node
->
couÁ
;

992 } ià(
’Œy
.
off£t
 >ğ0 && 
ex‹Á
 >ğ
node
->
couÁ
) {

995 
d–
 = 
node
->
couÁ
 - 
’Œy
.
off£t
;

996 } ià(
’Œy
.
off£t
 < 0) {

1002 
d–
 = -
’Œy
.
off£t
;

1007 ià(
d–
 > 
ex‹Á
)

1008 
d–
 = 
ex‹Á
;

1012 
d–
 = 
ex‹Á
;

1015 
	`D
("[%ld]:‡skingo del: %ld because offset: %d; (ENTIRE NODE: %d), "

1017 
ex‹Á
, 
d–
, 
’Œy
.
off£t
, 
d–‘e_’tœe_node
, 
node
->
couÁ
);

1019 ià(
d–‘e_’tœe_node
) {

1020 
	`__quickli¡D–Node
(
quickli¡
, 
node
);

1022 
	`quickli¡Decom´essNodeFÜU£
(
node
);

1023 
node
->
zl
 = 
	`zli¡D–‘eRªge
Òode->zl, 
’Œy
.
off£t
, 
d–
);

1024 
	`quickli¡NodeUpd©eSz
(
node
);

1025 
node
->
couÁ
 -ğ
d–
;

1026 
quickli¡
->
couÁ
 -ğ
d–
;

1027 
	`quickli¡D–‘eIfEm±y
(
quickli¡
, 
node
);

1028 ià(
node
)

1029 
	`quickli¡Recom´essOÆy
(
quickli¡
, 
node
);

1032 
ex‹Á
 -ğ
d–
;

1034 
node
 = 
Ãxt
;

1036 
’Œy
.
off£t
 = 0;

1039 
	}
}

1042 
	$quickli¡Com·»
(*
p1
, *
p2
, 
p2_Ën
) {

1043  
	`zli¡Com·»
(
p1
, 
p2
, 
p2_Ën
);

1044 
	}
}

1048 
quickli¡I‹r
 *
	$quickli¡G‘I‹¿tÜ
(cÚ¡ 
quickli¡
 *quickli¡, 
dœeùiÚ
) {

1049 
quickli¡I‹r
 *
™”
;

1051 
™”
 = 
	`zm®loc
((*iter));

1053 ià(
dœeùiÚ
 =ğ
AL_START_HEAD
) {

1054 
™”
->
cu¼’t
 = 
quickli¡
->
h—d
;

1055 
™”
->
off£t
 = 0;

1056 } ià(
dœeùiÚ
 =ğ
AL_START_TAIL
) {

1057 
™”
->
cu¼’t
 = 
quickli¡
->

;

1058 
™”
->
off£t
 = -1;

1061 
™”
->
dœeùiÚ
 = direction;

1062 
™”
->
quickli¡
 = quicklist;

1064 
™”
->
zi
 = 
NULL
;

1066  
™”
;

1067 
	}
}

1071 
quickli¡I‹r
 *
	$quickli¡G‘I‹¿tÜAtIdx
(cÚ¡ 
quickli¡
 *quicklist,

1072 cÚ¡ 
dœeùiÚ
,

1073 cÚ¡ 
idx
) {

1074 
quickli¡EÁry
 
’Œy
;

1076 ià(
	`quickli¡Index
(
quickli¡
, 
idx
, &
’Œy
)) {

1077 
quickli¡I‹r
 *
ba£
 = 
	`quickli¡G‘I‹¿tÜ
(
quickli¡
, 
dœeùiÚ
);

1078 
ba£
->
zi
 = 
NULL
;

1079 
ba£
->
cu¼’t
 = 
’Œy
.
node
;

1080 
ba£
->
off£t
 = 
’Œy
.offset;

1081  
ba£
;

1083  
NULL
;

1085 
	}
}

1089 
	$quickli¡R–—£I‹¿tÜ
(
quickli¡I‹r
 *
™”
) {

1090 ià(
™”
->
cu¼’t
)

1091 
	`quickli¡Com´ess
(
™”
->
quickli¡
, i‹r->
cu¼’t
);

1093 
	`zä“
(
™”
);

1094 
	}
}

1117 
	$quickli¡Next
(
quickli¡I‹r
 *
™”
, 
quickli¡EÁry
 *
’Œy
) {

1118 
	`š™EÁry
(
’Œy
);

1120 ià(!
™”
) {

1121 
	`D
("Returning because‚o iter!");

1125 
’Œy
->
quickli¡
 = 
™”
->quicklist;

1126 
’Œy
->
node
 = 
™”
->
cu¼’t
;

1128 ià(!
™”
->
cu¼’t
) {

1129 
	`D
("Returning because current‚ode is NULL")

1133 *(*
ÃxtFn
)(*, *èğ
NULL
;

1134 
off£t_upd©e
 = 0;

1136 ià(!
™”
->
zi
) {

1138 
	`quickli¡Decom´essNodeFÜU£
(
™”
->
cu¼’t
);

1139 
™”
->
zi
 = 
	`zli¡Index
(™”->
cu¼’t
->
zl
, i‹r->
off£t
);

1142 ià(
™”
->
dœeùiÚ
 =ğ
AL_START_HEAD
) {

1143 
ÃxtFn
 = 
zli¡Next
;

1144 
off£t_upd©e
 = 1;

1145 } ià(
™”
->
dœeùiÚ
 =ğ
AL_START_TAIL
) {

1146 
ÃxtFn
 = 
zli¡P»v
;

1147 
off£t_upd©e
 = -1;

1149 
™”
->
zi
 = 
	`ÃxtFn
(™”->
cu¼’t
->
zl
, iter->zi);

1150 
™”
->
off£t
 +ğ
off£t_upd©e
;

1153 
’Œy
->
zi
 = 
™”
->zi;

1154 
’Œy
->
off£t
 = 
™”
->offset;

1156 ià(
™”
->
zi
) {

1158 
	`zli¡G‘
(
’Œy
->
zi
, &’Œy->
v®ue
, &’Œy->
sz
, &’Œy->
lÚgv®
);

1163 
	`quickli¡Com´ess
(
™”
->
quickli¡
, i‹r->
cu¼’t
);

1164 ià(
™”
->
dœeùiÚ
 =ğ
AL_START_HEAD
) {

1166 
	`D
("Jumpingo start of‚ext‚ode");

1167 
™”
->
cu¼’t
 = i‹r->cu¼’t->
Ãxt
;

1168 
™”
->
off£t
 = 0;

1169 } ià(
™”
->
dœeùiÚ
 =ğ
AL_START_TAIL
) {

1171 
	`D
("Jumpingoƒnd of…revious‚ode");

1172 
™”
->
cu¼’t
 = i‹r->cu¼’t->
´ev
;

1173 
™”
->
off£t
 = -1;

1175 
™”
->
zi
 = 
NULL
;

1176  
	`quickli¡Next
(
™”
, 
’Œy
);

1178 
	}
}

1186 
quickli¡
 *
	$quickli¡Dup
(
quickli¡
 *
Üig
) {

1187 
quickli¡
 *
cİy
;

1189 
cİy
 = 
	`quickli¡New
(
Üig
->
fl
, orig->
com´ess
);

1191 
quickli¡Node
 *
cu¼’t
 = 
Üig
->
h—d
; current;

1192 
cu¼’t
 = cu¼’t->
Ãxt
) {

1193 
quickli¡Node
 *
node
 = 
	`quickli¡C»©eNode
();

1195 ià(
cu¼’t
->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_LZF
) {

1196 
quickli¡LZF
 *
lzf
 = (quickli¡LZF *)
cu¼’t
->
zl
;

1197 
size_t
 
lzf_sz
 = (*
lzf
è+†zf->
sz
;

1198 
node
->
zl
 = 
	`zm®loc
(
lzf_sz
);

1199 
	`memıy
(
node
->
zl
, 
cu¼’t
->zl, 
lzf_sz
);

1200 } ià(
cu¼’t
->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_RAW
) {

1201 
node
->
zl
 = 
	`zm®loc
(
cu¼’t
->
sz
);

1202 
	`memıy
(
node
->
zl
, 
cu¼’t
->zl, cu¼’t->
sz
);

1205 
node
->
couÁ
 = 
cu¼’t
->count;

1206 
cİy
->
couÁ
 +ğ
node
->count;

1207 
node
->
sz
 = 
cu¼’t
->sz;

1208 
node
->
’codšg
 = 
cu¼’t
->encoding;

1210 
	`_quickli¡In£¹NodeAá”
(
cİy
, cİy->

, 
node
);

1214  
cİy
;

1215 
	}
}

1225 
	$quickli¡Index
(cÚ¡ 
quickli¡
 *quickli¡, cÚ¡ 
idx
,

1226 
quickli¡EÁry
 *
’Œy
) {

1227 
quickli¡Node
 *
n
;

1228 
accum
 = 0;

1229 
šdex
;

1230 
fÜw¬d
 = 
idx
 < 0 ? 0 : 1;

1232 
	`š™EÁry
(
’Œy
);

1233 
’Œy
->
quickli¡
 = quicklist;

1235 ià(!
fÜw¬d
) {

1236 
šdex
 = (-
idx
) - 1;

1237 
n
 = 
quickli¡
->

;

1239 
šdex
 = 
idx
;

1240 
n
 = 
quickli¡
->
h—d
;

1243 ià(
šdex
 >ğ
quickli¡
->
couÁ
)

1246 
	`lik–y
(
n
)) {

1247 ià((
accum
 + 
n
->
couÁ
è> 
šdex
) {

1250 
	`D
("Skpšg ov” (%pè%u‡ˆaccum %Îd", (*)
n
,‚->
couÁ
,

1251 
accum
);

1252 
accum
 +ğ
n
->
couÁ
;

1253 
n
 = 
fÜw¬d
 ?‚->
Ãxt
 :‚->
´ev
;

1257 ià(!
n
)

1260 
	`D
("Found‚ode: %°©‡ccum %Îu, idx %Îu, sub+ %Îu, sub- %Îu", (*)
n
,

1261 
accum
, 
šdex
, index -‡ccum, (-index) - 1 +‡ccum);

1263 
’Œy
->
node
 = 
n
;

1264 ià(
fÜw¬d
) {

1266 
’Œy
->
off£t
 = 
šdex
 - 
accum
;

1270 
’Œy
->
off£t
 = (-
šdex
è- 1 + 
accum
;

1273 
	`quickli¡Decom´essNodeFÜU£
(
’Œy
->
node
);

1274 
’Œy
->
zi
 = 
	`zli¡Index
ÓÁry->
node
->
zl
,ƒÁry->
off£t
);

1275 
	`zli¡G‘
(
’Œy
->
zi
, &’Œy->
v®ue
, &’Œy->
sz
, &’Œy->
lÚgv®
);

1279 
	}
}

1282 
	$quickli¡RÙ©e
(
quickli¡
 *quicklist) {

1283 ià(
quickli¡
->
couÁ
 <= 1)

1287 *
p
 = 
	`zli¡Index
(
quickli¡
->

->
zl
, -1);

1288 *
v®ue
;

1289 
lÚgv®
;

1290 
sz
;

1291 
lÚg¡r
[32] = {0};

1292 
	`zli¡G‘
(
p
, &
v®ue
, &
sz
, &
lÚgv®
);

1295 ià(!
v®ue
) {

1297 
sz
 = 
	`Î2¡ršg
(
lÚg¡r
, ÖÚg¡r), 
lÚgv®
);

1298 
v®ue
 = (*)
lÚg¡r
;

1302 
	`quickli¡PushH—d
(
quickli¡
, 
v®ue
, 
sz
);

1307 ià(
quickli¡
->
Ën
 == 1) {

1308 
p
 = 
	`zli¡Index
(
quickli¡
->

->
zl
, -1);

1312 
	`quickli¡D–Index
(
quickli¡
, quickli¡->

, &
p
);

1313 
	}
}

1324 
	$quickli¡PİCu¡om
(
quickli¡
 *quickli¡, 
wh”e
, **
d©a
,

1325 *
sz
, *
sv®
,

1326 *(*
§v”
)(*
d©a
, 
sz
)) {

1327 *
p
;

1328 *
v¡r
;

1329 
vËn
;

1330 
vlÚg
;

1331 
pos
 = (
wh”e
 =ğ
QUICKLIST_HEAD
) ? 0 : -1;

1333 ià(
quickli¡
->
couÁ
 == 0)

1336 ià(
d©a
)

1337 *
d©a
 = 
NULL
;

1338 ià(
sz
)

1339 *
sz
 = 0;

1340 ià(
sv®
)

1341 *
sv®
 = -123456789;

1343 
quickli¡Node
 *
node
;

1344 ià(
wh”e
 =ğ
QUICKLIST_HEAD
 && 
quickli¡
->
h—d
) {

1345 
node
 = 
quickli¡
->
h—d
;

1346 } ià(
wh”e
 =ğ
QUICKLIST_TAIL
 && 
quickli¡
->

) {

1347 
node
 = 
quickli¡
->

;

1352 
p
 = 
	`zli¡Index
(
node
->
zl
, 
pos
);

1353 ià(
	`zli¡G‘
(
p
, &
v¡r
, &
vËn
, &
vlÚg
)) {

1354 ià(
v¡r
) {

1355 ià(
d©a
)

1356 *
d©a
 = 
	`§v”
(
v¡r
, 
vËn
);

1357 ià(
sz
)

1358 *
sz
 = 
vËn
;

1360 ià(
d©a
)

1361 *
d©a
 = 
NULL
;

1362 ià(
sv®
)

1363 *
sv®
 = 
vlÚg
;

1365 
	`quickli¡D–Index
(
quickli¡
, 
node
, &
p
);

1369 
	}
}

1372 
REDIS_STATIC
 *
	$_quickli¡Sav”
(*
d©a
, 
sz
) {

1373 *
v¡r
;

1374 ià(
d©a
) {

1375 
v¡r
 = 
	`zm®loc
(
sz
);

1376 
	`memıy
(
v¡r
, 
d©a
, 
sz
);

1377  
v¡r
;

1379  
NULL
;

1380 
	}
}

1385 
	$quickli¡Pİ
(
quickli¡
 *quickli¡, 
wh”e
, **
d©a
,

1386 *
sz
, *
¦Úg
) {

1387 *
v¡r
;

1388 
vËn
;

1389 
vlÚg
;

1390 ià(
quickli¡
->
couÁ
 == 0)

1392 
»t
 = 
	`quickli¡PİCu¡om
(
quickli¡
, 
wh”e
, &
v¡r
, &
vËn
, &
vlÚg
,

1393 
_quickli¡Sav”
);

1394 ià(
d©a
)

1395 *
d©a
 = 
v¡r
;

1396 ià(
¦Úg
)

1397 *
¦Úg
 = 
vlÚg
;

1398 ià(
sz
)

1399 *
sz
 = 
vËn
;

1400  
»t
;

1401 
	}
}

1404 
	$quickli¡Push
(
quickli¡
 *quickli¡, *
v®ue
, cÚ¡ 
size_t
 
sz
,

1405 
wh”e
) {

1406 ià(
wh”e
 =ğ
QUICKLIST_HEAD
) {

1407 
	`quickli¡PushH—d
(
quickli¡
, 
v®ue
, 
sz
);

1408 } ià(
wh”e
 =ğ
QUICKLIST_TAIL
) {

1409 
	`quickli¡PushTa
(
quickli¡
, 
v®ue
, 
sz
);

1411 
	}
}

1414 #ifdeà
REDIS_TEST


1415 
	~<¡dšt.h
>

1416 
	~<sys/time.h
>

1418 
	#as£¹
(
_e
) \

1420 ià(!(
_e
)) { \

1421 
	`´štf
("\n\n=== ASSERTION FAILED ===\n"); \

1422 
	`´štf
("==> %s:%d '%s' i nÙrue\n", 
__FILE__
, 
__LINE__
, #_e); \

1423 
”r
++; \

1425 } 0)

	)

1427 
	#y–l
(
¡r
, ...è
	`´štf
("ERROR! " sŒ "\n\n", 
__VA_ARGS__
)

	)

1429 
	#OK
 
	`´štf
("\tOK\n")

	)

1431 
	#ERROR
 \

1433 
	`´štf
("\tERROR!\n"); \

1434 
”r
++; \

1435 } 0)

	)

1437 
	#ERR
(
x
, ...) \

1439 
	`´štf
("%s:%s:%d:\t", 
__FILE__
, 
__FUNCTION__
, 
__LINE__
); \

1440 
	`´štf
("ERROR! " 
x
 "\n", 
__VA_ARGS__
); \

1441 
”r
++; \

1442 } 0)

	)

1444 
	#TEST
(
Çme
è
	`´štf
("‹¡ â€” %s\n",‚ame);

	)

1445 
	#TEST_DESC
(
Çme
, ...è
	`´štf
("‹¡ â€” "‚am"\n", 
__VA_ARGS__
);

	)

1447 
	#QL_TEST_VERBOSE
 0

	)

1449 
	#UNUSED
(
x
è()(x)

	)

1450 
	$ql_šfo
(
quickli¡
 *
ql
) {

1451 #ià
QL_TEST_VERBOSE


1452 
	`´štf
("CÚš”†’gth: %lu\n", 
ql
->
Ën
);

1453 
	`´štf
("CÚš” size: %lu\n", 
ql
->
couÁ
);

1454 ià(
ql
->
h—d
)

1455 
	`´štf
("\t(zsizh—d: %d)\n", 
	`zli¡L’
(
ql
->
h—d
->
zl
));

1456 ià(
ql
->

)

1457 
	`´štf
("\t(zsiz: %d)\n", 
	`zli¡L’
(
ql
->

->
zl
));

1458 
	`´štf
("\n");

1460 
	`UNUSED
(
ql
);

1462 
	}
}

1465 
	$u¡ime
() {

1466 
timev®
 
tv
;

1467 
u¡
;

1469 
	`g‘timeofday
(&
tv
, 
NULL
);

1470 
u¡
 = (()
tv
.
tv_£c
) * 1000000;

1471 
u¡
 +ğ
tv
.
tv_u£c
;

1472  
u¡
;

1473 
	}
}

1476 
	$m¡ime
(è{  
	`u¡ime
(è/ 1000; 
	}
}

1482 
	$_™½ršŒ
(
quickli¡
 *
ql
, 
´št
, 
fÜw¬d
) {

1483 
quickli¡I‹r
 *
™”
 =

1484 
	`quickli¡G‘I‹¿tÜ
(
ql
, 
fÜw¬d
 ? 
AL_START_HEAD
 : 
AL_START_TAIL
);

1485 
quickli¡EÁry
 
’Œy
;

1486 
i
 = 0;

1487 
p
 = 0;

1488 
quickli¡Node
 *
´ev
 = 
NULL
;

1489 
	`quickli¡Next
(
™”
, &
’Œy
)) {

1490 ià(
’Œy
.
node
 !ğ
´ev
) {

1492 
p
++;

1493 
´ev
 = 
’Œy
.
node
;

1495 ià(
´št
) {

1496 
	`´štf
("[%3d (%2d)]: [%.*s] (%Îd)\n", 
i
, 
p
, 
’Œy
.
sz
,

1497 (*)
’Œy
.
v®ue
,ƒÁry.
lÚgv®
);

1499 
i
++;

1501 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

1502  
i
;

1503 
	}
}

1504 
	$™½ršŒ
(
quickli¡
 *
ql
, 
´št
) {

1505  
	`_™½ršŒ
(
ql
, 
´št
, 1);

1506 
	}
}

1508 
	$™½ršŒ_»v
(
quickli¡
 *
ql
, 
´št
) {

1509  
	`_™½ršŒ
(
ql
, 
´št
, 0);

1510 
	}
}

1512 
	#ql_v”ify
(
a
, 
b
, 
c
, 
d
, 
e
) \

1514 
”r
 +ğ
	`_ql_v”ify
((
a
), (
b
), (
c
), (
d
), (
e
)); \

1515 } 0)

	)

1518 
	$_ql_v”ify
(
quickli¡
 *
ql
, 
ušt32_t
 
Ën
, ušt32_ˆ
couÁ
,

1519 
ušt32_t
 
h—d_couÁ
, ušt32_ˆ
_couÁ
) {

1520 
”rÜs
 = 0;

1522 
	`ql_šfo
(
ql
);

1523 ià(
Ën
 !ğ
ql
->len) {

1524 
	`y–l
("quickli¡†’gth wrÚg:ƒx³ùed %d, gÙ %u", 
Ën
, 
ql
->len);

1525 
”rÜs
++;

1528 ià(
couÁ
 !ğ
ql
->count) {

1529 
	`y–l
("quickli¡ couÁ wrÚg:ƒx³ùed %d, gÙ %lu", 
couÁ
, 
ql
->count);

1530 
”rÜs
++;

1533 
loİr
 = 
	`™½ršŒ
(
ql
, 0);

1534 ià(
loİr
 !ğ()
ql
->
couÁ
) {

1535 
	`y–l
("quicklist cached count‚ot match‡ctual count:ƒxpected %lu, got "

1537 
ql
->
couÁ
, 
loİr
);

1538 
”rÜs
++;

1541 
¾oİr
 = 
	`™½ršŒ_»v
(
ql
, 0);

1542 ià(
loİr
 !ğ
¾oİr
) {

1543 
	`y–l
("quicklist has different forward counthan„everse count! "

1545 
loİr
, 
¾oİr
);

1546 
”rÜs
++;

1549 ià(
ql
->
Ën
 =ğ0 && !
”rÜs
) {

1550 
OK
;

1551  
”rÜs
;

1554 ià(
ql
->
h—d
 && 
h—d_couÁ
 !ğql->h—d->
couÁ
 &&

1555 
h—d_couÁ
 !ğ
	`zli¡L’
(
ql
->
h—d
->
zl
)) {

1556 
	`y–l
("quicklist head count wrong:ƒxpected %d, "

1558 
h—d_couÁ
, 
ql
->
h—d
->
couÁ
, 
	`zli¡L’
(ql->h—d->
zl
));

1559 
”rÜs
++;

1562 ià(
ql
->

 && 
_couÁ
 !ğql->->
couÁ
 &&

1563 
_couÁ
 !ğ
	`zli¡L’
(
ql
->

->
zl
)) {

1564 
	`y–l
("quicklistail count wrong:ƒxpected %d, "

1566 
_couÁ
, 
ql
->

->
couÁ
, 
	`zli¡L’
(ql->->
zl
));

1567 
”rÜs
++;

1570 ià(
	`quickli¡AÎowsCom´essiÚ
(
ql
)) {

1571 
quickli¡Node
 *
node
 = 
ql
->
h—d
;

1572 
low_¿w
 = 
ql
->
com´ess
;

1573 
high_¿w
 = 
ql
->
Ën
 - ql->
com´ess
;

1575 
©
 = 0;‡ˆ< 
ql
->
Ën
;‡t++, 
node
 =‚ode->
Ãxt
) {

1576 ià(
node
 && (
©
 < 
low_¿w
 ||‡ˆ>ğ
high_¿w
)) {

1577 ià(
node
->
’codšg
 !ğ
QUICKLIST_NODE_ENCODING_RAW
) {

1578 
	`y–l
("Incorrect compression:‚ode %d is "

1581 
©
, 
ql
->
com´ess
, 
low_¿w
, 
high_¿w
, ql->
Ën
, 
node
->
sz
,

1582 
node
->
»com´ess
);

1583 
”rÜs
++;

1586 ià(
node
->
’codšg
 !ğ
QUICKLIST_NODE_ENCODING_LZF
 &&

1587 !
node
->
©‹m±ed_com´ess
) {

1588 
	`y–l
("Incorrect‚on-compression:‚ode %d is NOT "

1591 
©
, 
ql
->
com´ess
, 
low_¿w
, 
high_¿w
, ql->
Ën
, 
node
->
sz
,

1592 
node
->
»com´ess
,‚ode->
©‹m±ed_com´ess
);

1593 
”rÜs
++;

1599 ià(!
”rÜs
)

1600 
OK
;

1601  
”rÜs
;

1602 
	}
}

1605 *
	$g’¡r
(*
´efix
, 
i
) {

1606 
»suÉ
[64] = {0};

1607 
	`¢´štf
(
»suÉ
, ÔesuÉ), "%s%d", 
´efix
, 
i
);

1608  
»suÉ
;

1609 
	}
}

1612 
	$quickli¡Te¡
(
¬gc
, *
¬gv
[]) {

1613 
	`UNUSED
(
¬gc
);

1614 
	`UNUSED
(
¬gv
);

1616 
”r
 = 0;

1617 
İtimize_¡¬t
 =

1618 -()((
İtimiz©iÚ_Ëv–
) / (*optimization_level));

1620 
	`´štf
("S¹šg o±imiz©iÚ off£ˆ©: %d\n", 
İtimize_¡¬t
);

1622 
İtiÚs
[] = {0, 1, 2, 3, 4, 5, 6, 10};

1623 
size_t
 
İtiÚ_couÁ
 = (
İtiÚs
) / (*options);

1624 
ruÁime
[
İtiÚ_couÁ
];

1626 
_i
 = 0; _˜< ()
İtiÚ_couÁ
; _i++) {

1627 
	`´štf
("Te¡šg O±iÚ %d\n", 
İtiÚs
[
_i
]);

1628 
¡¬t
 = 
	`m¡ime
();

1630 
	`TEST
("create†ist") {

1631 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1632 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

1633 
	`quickli¡R–—£
(
ql
);

1636 
	`TEST
("addoail ofƒmpty†ist") {

1637 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1638 
	`quickli¡PushTa
(
ql
, "hello", 6);

1640 
	`ql_v”ify
(
ql
, 1, 1, 1, 1);

1641 
	`quickli¡R–—£
(
ql
);

1644 
	`TEST
("addo head ofƒmpty†ist") {

1645 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1646 
	`quickli¡PushH—d
(
ql
, "hello", 6);

1648 
	`ql_v”ify
(
ql
, 1, 1, 1, 1);

1649 
	`quickli¡R–—£
(
ql
);

1652 
f
 = 
İtimize_¡¬t
; f < 32; f++) {

1653 
	`TEST_DESC
("addØ 5x‡ˆfÈ%d‡ˆcom´es %d", 
f
,

1654 
İtiÚs
[
_i
]) {

1655 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

1656 
i
 = 0; i < 5; i++)

1657 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

1658 ià(
ql
->
couÁ
 != 5)

1659 
ERROR
;

1660 ià(
f
 == 32)

1661 
	`ql_v”ify
(
ql
, 1, 5, 5, 5);

1662 
	`quickli¡R–—£
(
ql
);

1666 
f
 = 
İtimize_¡¬t
; f < 32; f++) {

1667 
	`TEST_DESC
("addØh—d 5x‡ˆfÈ%d‡ˆcom´es %d", 
f
,

1668 
İtiÚs
[
_i
]) {

1669 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

1670 
i
 = 0; i < 5; i++)

1671 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

1672 ià(
ql
->
couÁ
 != 5)

1673 
ERROR
;

1674 ià(
f
 == 32)

1675 
	`ql_v”ify
(
ql
, 1, 5, 5, 5);

1676 
	`quickli¡R–—£
(
ql
);

1680 
f
 = 
İtimize_¡¬t
; f < 512; f++) {

1681 
	`TEST_DESC
("addØ 500x‡ˆfÈ%d‡ˆcom´es %d", 
f
,

1682 
İtiÚs
[
_i
]) {

1683 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

1684 
i
 = 0; i < 500; i++)

1685 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
), 64);

1686 ià(
ql
->
couÁ
 != 500)

1687 
ERROR
;

1688 ià(
f
 == 32)

1689 
	`ql_v”ify
(
ql
, 16, 500, 32, 20);

1690 
	`quickli¡R–—£
(
ql
);

1694 
f
 = 
İtimize_¡¬t
; f < 512; f++) {

1695 
	`TEST_DESC
("addØh—d 500x‡ˆfÈ%d‡ˆcom´es %d", 
f
,

1696 
İtiÚs
[
_i
]) {

1697 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

1698 
i
 = 0; i < 500; i++)

1699 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

1700 ià(
ql
->
couÁ
 != 500)

1701 
ERROR
;

1702 ià(
f
 == 32)

1703 
	`ql_v”ify
(
ql
, 16, 500, 20, 32);

1704 
	`quickli¡R–—£
(
ql
);

1708 
	`TEST
("rotateƒmpty") {

1709 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1710 
	`quickli¡RÙ©e
(
ql
);

1711 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

1712 
	`quickli¡R–—£
(
ql
);

1715 
f
 = 
İtimize_¡¬t
; f < 32; f++) {

1716 
	`TEST
("rotate one val once") {

1717 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

1718 
	`quickli¡PushH—d
(
ql
, "hello", 6);

1719 
	`quickli¡RÙ©e
(
ql
);

1722 
	`ql_v”ify
(
ql
, 1, 1, 1, 1);

1723 
	`quickli¡R–—£
(
ql
);

1727 
f
 = 
İtimize_¡¬t
; f < 3; f++) {

1728 
	`TEST_DESC
("rÙ©500 v® 5000ime © fÈ%d‡ˆcom´es %d", 
f
,

1729 
İtiÚs
[
_i
]) {

1730 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

1731 
	`quickli¡PushH—d
(
ql
, "900", 3);

1732 
	`quickli¡PushH—d
(
ql
, "7000", 4);

1733 
	`quickli¡PushH—d
(
ql
, "-1200", 5);

1734 
	`quickli¡PushH—d
(
ql
, "42", 2);

1735 
i
 = 0; i < 500; i++)

1736 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 64);

1737 
	`ql_šfo
(
ql
);

1738 
i
 = 0; i < 5000; i++) {

1739 
	`ql_šfo
(
ql
);

1740 
	`quickli¡RÙ©e
(
ql
);

1742 ià(
f
 == 1)

1743 
	`ql_v”ify
(
ql
, 504, 504, 1, 1);

1744 ià(
f
 == 2)

1745 
	`ql_v”ify
(
ql
, 252, 504, 2, 2);

1746 ià(
f
 == 32)

1747 
	`ql_v”ify
(
ql
, 16, 504, 32, 24);

1748 
	`quickli¡R–—£
(
ql
);

1752 
	`TEST
("popƒmpty") {

1753 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1754 
	`quickli¡Pİ
(
ql
, 
QUICKLIST_HEAD
, 
NULL
, NULL, NULL);

1755 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

1756 
	`quickli¡R–—£
(
ql
);

1759 
	`TEST
("pop 1 string from 1") {

1760 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1761 *
pİuÏ‹
 = 
	`g’¡r
("hello", 331);

1762 
	`quickli¡PushH—d
(
ql
, 
pİuÏ‹
, 32);

1763 *
d©a
;

1764 
sz
;

1765 
lv
;

1766 
	`ql_šfo
(
ql
);

1767 
	`quickli¡Pİ
(
ql
, 
QUICKLIST_HEAD
, &
d©a
, &
sz
, &
lv
);

1768 
	`as£¹
(
d©a
 !ğ
NULL
);

1769 
	`as£¹
(
sz
 == 32);

1770 ià(
	`¡rcmp
(
pİuÏ‹
, (*)
d©a
))

1771 
	`ERR
("Pİ'd v®u(%.*sèdidn'ˆequ® origš® v®u(%s)", 
sz
,

1772 
d©a
, 
pİuÏ‹
);

1773 
	`zä“
(
d©a
);

1774 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

1775 
	`quickli¡R–—£
(
ql
);

1778 
	`TEST
("pop head 1‚umber from 1") {

1779 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1780 
	`quickli¡PushH—d
(
ql
, "55513", 5);

1781 *
d©a
;

1782 
sz
;

1783 
lv
;

1784 
	`ql_šfo
(
ql
);

1785 
	`quickli¡Pİ
(
ql
, 
QUICKLIST_HEAD
, &
d©a
, &
sz
, &
lv
);

1786 
	`as£¹
(
d©a
 =ğ
NULL
);

1787 
	`as£¹
(
lv
 == 55513);

1788 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

1789 
	`quickli¡R–—£
(
ql
);

1792 
	`TEST
("pop head 500 from 500") {

1793 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1794 
i
 = 0; i < 500; i++)

1795 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

1796 
	`ql_šfo
(
ql
);

1797 
i
 = 0; i < 500; i++) {

1798 *
d©a
;

1799 
sz
;

1800 
lv
;

1801 
»t
 = 
	`quickli¡Pİ
(
ql
, 
QUICKLIST_HEAD
, &
d©a
, &
sz
, &
lv
);

1802 
	`as£¹
(
»t
 == 1);

1803 
	`as£¹
(
d©a
 !ğ
NULL
);

1804 
	`as£¹
(
sz
 == 32);

1805 ià(
	`¡rcmp
(
	`g’¡r
("h–lo", 499 - 
i
), (*)
d©a
))

1806 
	`ERR
("Pop'd value (%.*s) didn'tƒqual original value (%s)",

1807 
sz
, 
d©a
, 
	`g’¡r
("h–lo", 499 - 
i
));

1808 
	`zä“
(
d©a
);

1810 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

1811 
	`quickli¡R–—£
(
ql
);

1814 
	`TEST
("pop head 5000 from 500") {

1815 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1816 
i
 = 0; i < 500; i++)

1817 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

1818 
i
 = 0; i < 5000; i++) {

1819 *
d©a
;

1820 
sz
;

1821 
lv
;

1822 
»t
 = 
	`quickli¡Pİ
(
ql
, 
QUICKLIST_HEAD
, &
d©a
, &
sz
, &
lv
);

1823 ià(
i
 < 500) {

1824 
	`as£¹
(
»t
 == 1);

1825 
	`as£¹
(
d©a
 !ğ
NULL
);

1826 
	`as£¹
(
sz
 == 32);

1827 ià(
	`¡rcmp
(
	`g’¡r
("h–lo", 499 - 
i
), (*)
d©a
))

1828 
	`ERR
("Pop'd value (%.*s) didn'tƒqual original value "

1830 
sz
, 
d©a
, 
	`g’¡r
("h–lo", 499 - 
i
));

1831 
	`zä“
(
d©a
);

1833 
	`as£¹
(
»t
 == 0);

1836 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

1837 
	`quickli¡R–—£
(
ql
);

1840 
	`TEST
("iterate forward over 500†ist") {

1841 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1842 
	`quickli¡S‘Fl
(
ql
, 32);

1843 
i
 = 0; i < 500; i++)

1844 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

1845 
quickli¡I‹r
 *
™”
 = 
	`quickli¡G‘I‹¿tÜ
(
ql
, 
AL_START_HEAD
);

1846 
quickli¡EÁry
 
’Œy
;

1847 
i
 = 499, 
couÁ
 = 0;

1848 
	`quickli¡Next
(
™”
, &
’Œy
)) {

1849 *
h
 = 
	`g’¡r
("h–lo", 
i
);

1850 ià(
	`¡rcmp
((*)
’Œy
.
v®ue
, 
h
))

1851 
	`ERR
("value [%s] didn't match [%s]‡t…osition %d",

1852 
’Œy
.
v®ue
, 
h
, 
i
);

1853 
i
--;

1854 
couÁ
++;

1856 ià(
couÁ
 != 500)

1857 
	`ERR
("Didn'ˆ™”©ov”ƒxaùly 500ƒËm’t (%d)", 
i
);

1858 
	`ql_v”ify
(
ql
, 16, 500, 20, 32);

1859 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

1860 
	`quickli¡R–—£
(
ql
);

1863 
	`TEST
("iterate„everse over 500†ist") {

1864 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1865 
	`quickli¡S‘Fl
(
ql
, 32);

1866 
i
 = 0; i < 500; i++)

1867 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

1868 
quickli¡I‹r
 *
™”
 = 
	`quickli¡G‘I‹¿tÜ
(
ql
, 
AL_START_TAIL
);

1869 
quickli¡EÁry
 
’Œy
;

1870 
i
 = 0;

1871 
	`quickli¡Next
(
™”
, &
’Œy
)) {

1872 *
h
 = 
	`g’¡r
("h–lo", 
i
);

1873 ià(
	`¡rcmp
((*)
’Œy
.
v®ue
, 
h
))

1874 
	`ERR
("value [%s] didn't match [%s]‡t…osition %d",

1875 
’Œy
.
v®ue
, 
h
, 
i
);

1876 
i
++;

1878 ià(
i
 != 500)

1879 
	`ERR
("Didn'ˆ™”©ov”ƒxaùly 500ƒËm’t (%d)", 
i
);

1880 
	`ql_v”ify
(
ql
, 16, 500, 20, 32);

1881 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

1882 
	`quickli¡R–—£
(
ql
);

1885 
	`TEST
("insert before with 0ƒlements") {

1886 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1887 
quickli¡EÁry
 
’Œy
;

1888 
	`quickli¡Index
(
ql
, 0, &
’Œy
);

1889 
	`quickli¡In£¹BefÜe
(
ql
, &
’Œy
, "abc", 4);

1890 
	`ql_v”ify
(
ql
, 1, 1, 1, 1);

1891 
	`quickli¡R–—£
(
ql
);

1894 
	`TEST
("insert‡fter with 0ƒlements") {

1895 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1896 
quickli¡EÁry
 
’Œy
;

1897 
	`quickli¡Index
(
ql
, 0, &
’Œy
);

1898 
	`quickli¡In£¹Aá”
(
ql
, &
’Œy
, "abc", 4);

1899 
	`ql_v”ify
(
ql
, 1, 1, 1, 1);

1900 
	`quickli¡R–—£
(
ql
);

1903 
	`TEST
("insert‡fter 1ƒlement") {

1904 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1905 
	`quickli¡PushH—d
(
ql
, "hello", 6);

1906 
quickli¡EÁry
 
’Œy
;

1907 
	`quickli¡Index
(
ql
, 0, &
’Œy
);

1908 
	`quickli¡In£¹Aá”
(
ql
, &
’Œy
, "abc", 4);

1909 
	`ql_v”ify
(
ql
, 1, 2, 2, 2);

1910 
	`quickli¡R–—£
(
ql
);

1913 
	`TEST
("insert before 1ƒlement") {

1914 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1915 
	`quickli¡PushH—d
(
ql
, "hello", 6);

1916 
quickli¡EÁry
 
’Œy
;

1917 
	`quickli¡Index
(
ql
, 0, &
’Œy
);

1918 
	`quickli¡In£¹Aá”
(
ql
, &
’Œy
, "abc", 4);

1919 
	`ql_v”ify
(
ql
, 1, 2, 2, 2);

1920 
	`quickli¡R–—£
(
ql
);

1923 
f
 = 
İtimize_¡¬t
; f < 12; f++) {

1924 
	`TEST_DESC
("insert once inƒlements while iterating‡t fill %d‡t "

1926 
f
, 
İtiÚs
[
_i
]) {

1927 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

1928 
	`quickli¡PushTa
(
ql
, "abc", 3);

1929 
	`quickli¡S‘Fl
(
ql
, 1);

1930 
	`quickli¡PushTa
(
ql
, "def", 3);

1931 
	`quickli¡S‘Fl
(
ql
, 
f
);

1932 
	`quickli¡PushTa
(
ql
, "bob", 3);

1933 
	`quickli¡PushTa
(
ql
, "foo", 3);

1934 
	`quickli¡PushTa
(
ql
, "zoo", 3);

1936 
	`™½ršŒ
(
ql
, 0);

1938 
quickli¡I‹r
 *
™”
 = 
	`quickli¡G‘I‹¿tÜ
(
ql
, 
AL_START_HEAD
);

1939 
quickli¡EÁry
 
’Œy
;

1940 
	`quickli¡Next
(
™”
, &
’Œy
)) {

1941 ià(!
	`¡ºcmp
((*)
’Œy
.
v®ue
, "bob", 3)) {

1943 
	`quickli¡In£¹BefÜe
(
ql
, &
’Œy
, "bar", 3);

1947 
	`™½ršŒ
(
ql
, 0);

1950 
	`quickli¡Index
(
ql
, 0, &
’Œy
);

1951 ià(
	`¡ºcmp
((*)
’Œy
.
v®ue
, "abc", 3))

1952 
	`ERR
("V®u0 didn'ˆm©ch, in¡—d gÙ: %.*s", 
’Œy
.
sz
,

1953 
’Œy
.
v®ue
);

1954 
	`quickli¡Index
(
ql
, 1, &
’Œy
);

1955 ià(
	`¡ºcmp
((*)
’Œy
.
v®ue
, "def", 3))

1956 
	`ERR
("V®u1 didn'ˆm©ch, in¡—d gÙ: %.*s", 
’Œy
.
sz
,

1957 
’Œy
.
v®ue
);

1958 
	`quickli¡Index
(
ql
, 2, &
’Œy
);

1959 ià(
	`¡ºcmp
((*)
’Œy
.
v®ue
, "bar", 3))

1960 
	`ERR
("V®u2 didn'ˆm©ch, in¡—d gÙ: %.*s", 
’Œy
.
sz
,

1961 
’Œy
.
v®ue
);

1962 
	`quickli¡Index
(
ql
, 3, &
’Œy
);

1963 ià(
	`¡ºcmp
((*)
’Œy
.
v®ue
, "bob", 3))

1964 
	`ERR
("V®u3 didn'ˆm©ch, in¡—d gÙ: %.*s", 
’Œy
.
sz
,

1965 
’Œy
.
v®ue
);

1966 
	`quickli¡Index
(
ql
, 4, &
’Œy
);

1967 ià(
	`¡ºcmp
((*)
’Œy
.
v®ue
, "foo", 3))

1968 
	`ERR
("V®u4 didn'ˆm©ch, in¡—d gÙ: %.*s", 
’Œy
.
sz
,

1969 
’Œy
.
v®ue
);

1970 
	`quickli¡Index
(
ql
, 5, &
’Œy
);

1971 ià(
	`¡ºcmp
((*)
’Œy
.
v®ue
, "zoo", 3))

1972 
	`ERR
("V®u5 didn'ˆm©ch, in¡—d gÙ: %.*s", 
’Œy
.
sz
,

1973 
’Œy
.
v®ue
);

1974 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

1975 
	`quickli¡R–—£
(
ql
);

1979 
f
 = 
İtimize_¡¬t
; f < 1024; f++) {

1980 
	`TEST_DESC
(

1983 
f
, 
İtiÚs
[
_i
]) {

1984 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

1985 
i
 = 0; i < 500; i++)

1986 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

1987 
i
 = 0; i < 250; i++) {

1988 
quickli¡EÁry
 
’Œy
;

1989 
	`quickli¡Index
(
ql
, 250, &
’Œy
);

1990 
	`quickli¡In£¹BefÜe
(
ql
, &
’Œy
, 
	`g’¡r
("abc", 
i
), 32);

1992 ià(
f
 == 32)

1993 
	`ql_v”ify
(
ql
, 25, 750, 32, 20);

1994 
	`quickli¡R–—£
(
ql
);

1998 
f
 = 
İtimize_¡¬t
; f < 1024; f++) {

1999 
	`TEST_DESC
("insert [after] 250‚ew in middle of 500ƒlements‡t "

2001 
f
, 
İtiÚs
[
_i
]) {

2002 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2003 
i
 = 0; i < 500; i++)

2004 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

2005 
i
 = 0; i < 250; i++) {

2006 
quickli¡EÁry
 
’Œy
;

2007 
	`quickli¡Index
(
ql
, 250, &
’Œy
);

2008 
	`quickli¡In£¹Aá”
(
ql
, &
’Œy
, 
	`g’¡r
("abc", 
i
), 32);

2011 ià(
ql
->
couÁ
 != 750)

2012 
	`ERR
("Li¡ siznÙ 750, buˆ¿th” %ld", 
ql
->
couÁ
);

2014 ià(
f
 == 32)

2015 
	`ql_v”ify
(
ql
, 26, 750, 20, 32);

2016 
	`quickli¡R–—£
(
ql
);

2020 
	`TEST
("duplicateƒmpty†ist") {

2021 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2022 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

2023 
quickli¡
 *
cİy
 = 
	`quickli¡Dup
(
ql
);

2024 
	`ql_v”ify
(
cİy
, 0, 0, 0, 0);

2025 
	`quickli¡R–—£
(
ql
);

2026 
	`quickli¡R–—£
(
cİy
);

2029 
	`TEST
("duplicate†ist of 1ƒlement") {

2030 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2031 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("hello", 3), 32);

2032 
	`ql_v”ify
(
ql
, 1, 1, 1, 1);

2033 
quickli¡
 *
cİy
 = 
	`quickli¡Dup
(
ql
);

2034 
	`ql_v”ify
(
cİy
, 1, 1, 1, 1);

2035 
	`quickli¡R–—£
(
ql
);

2036 
	`quickli¡R–—£
(
cİy
);

2039 
	`TEST
("duplicate†ist of 500") {

2040 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2041 
	`quickli¡S‘Fl
(
ql
, 32);

2042 
i
 = 0; i < 500; i++)

2043 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

2044 
	`ql_v”ify
(
ql
, 16, 500, 20, 32);

2046 
quickli¡
 *
cİy
 = 
	`quickli¡Dup
(
ql
);

2047 
	`ql_v”ify
(
cİy
, 16, 500, 20, 32);

2048 
	`quickli¡R–—£
(
ql
);

2049 
	`quickli¡R–—£
(
cİy
);

2052 
f
 = 
İtimize_¡¬t
; f < 512; f++) {

2053 
	`TEST_DESC
("šdex 1,200 from 500†i¡‡ˆfÈ%d‡ˆcom´es %d", 
f
,

2054 
İtiÚs
[
_i
]) {

2055 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2056 
i
 = 0; i < 500; i++)

2057 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
 + 1), 32);

2058 
quickli¡EÁry
 
’Œy
;

2059 
	`quickli¡Index
(
ql
, 1, &
’Œy
);

2060 ià(!
	`¡rcmp
((*)
’Œy
.
v®ue
, "hello2"))

2061 
OK
;

2063 
	`ERR
("V®ue: %s", 
’Œy
.
v®ue
);

2064 
	`quickli¡Index
(
ql
, 200, &
’Œy
);

2065 ià(!
	`¡rcmp
((*)
’Œy
.
v®ue
, "hello201"))

2066 
OK
;

2068 
	`ERR
("V®ue: %s", 
’Œy
.
v®ue
);

2069 
	`quickli¡R–—£
(
ql
);

2072 
	`TEST_DESC
("šdex -1,-2 from 500†i¡‡ˆfÈ%d‡ˆcom´es %d", 
f
,

2073 
İtiÚs
[
_i
]) {

2074 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2075 
i
 = 0; i < 500; i++)

2076 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
 + 1), 32);

2077 
quickli¡EÁry
 
’Œy
;

2078 
	`quickli¡Index
(
ql
, -1, &
’Œy
);

2079 ià(!
	`¡rcmp
((*)
’Œy
.
v®ue
, "hello500"))

2080 
OK
;

2082 
	`ERR
("V®ue: %s", 
’Œy
.
v®ue
);

2083 
	`quickli¡Index
(
ql
, -2, &
’Œy
);

2084 ià(!
	`¡rcmp
((*)
’Œy
.
v®ue
, "hello499"))

2085 
OK
;

2087 
	`ERR
("V®ue: %s", 
’Œy
.
v®ue
);

2088 
	`quickli¡R–—£
(
ql
);

2091 
	`TEST_DESC
("šdex -100 from 500†i¡‡ˆfÈ%d‡ˆcom´es %d", 
f
,

2092 
İtiÚs
[
_i
]) {

2093 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2094 
i
 = 0; i < 500; i++)

2095 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
 + 1), 32);

2096 
quickli¡EÁry
 
’Œy
;

2097 
	`quickli¡Index
(
ql
, -100, &
’Œy
);

2098 ià(!
	`¡rcmp
((*)
’Œy
.
v®ue
, "hello401"))

2099 
OK
;

2101 
	`ERR
("V®ue: %s", 
’Œy
.
v®ue
);

2102 
	`quickli¡R–—£
(
ql
);

2105 
	`TEST_DESC
("indexoo big +1 from 50†ist‡t fill %d‡t compress %d",

2106 
f
, 
İtiÚs
[
_i
]) {

2107 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2108 
i
 = 0; i < 50; i++)

2109 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
 + 1), 32);

2110 
quickli¡EÁry
 
’Œy
;

2111 ià(
	`quickli¡Index
(
ql
, 50, &
’Œy
))

2112 
	`ERR
("Index found‡ˆ50 w™h 50†i¡: %.*s", 
’Œy
.
sz
,

2113 
’Œy
.
v®ue
);

2115 
OK
;

2116 
	`quickli¡R–—£
(
ql
);

2120 
	`TEST
("delete„angeƒmpty†ist") {

2121 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2122 
	`quickli¡D–Rªge
(
ql
, 5, 20);

2123 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

2124 
	`quickli¡R–—£
(
ql
);

2127 
	`TEST
("delete„ange ofƒntire‚ode in†ist of one‚ode") {

2128 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2129 
i
 = 0; i < 32; i++)

2130 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

2131 
	`ql_v”ify
(
ql
, 1, 32, 32, 32);

2132 
	`quickli¡D–Rªge
(
ql
, 0, 32);

2133 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

2134 
	`quickli¡R–—£
(
ql
);

2137 
	`TEST
("delete„ange ofƒntire‚ode with overflow counts") {

2138 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2139 
i
 = 0; i < 32; i++)

2140 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

2141 
	`ql_v”ify
(
ql
, 1, 32, 32, 32);

2142 
	`quickli¡D–Rªge
(
ql
, 0, 128);

2143 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

2144 
	`quickli¡R–—£
(
ql
);

2147 
	`TEST
("delete middle 100 of 500†ist") {

2148 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2149 
	`quickli¡S‘Fl
(
ql
, 32);

2150 
i
 = 0; i < 500; i++)

2151 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
 + 1), 32);

2152 
	`ql_v”ify
(
ql
, 16, 500, 32, 20);

2153 
	`quickli¡D–Rªge
(
ql
, 200, 100);

2154 
	`ql_v”ify
(
ql
, 14, 400, 32, 20);

2155 
	`quickli¡R–—£
(
ql
);

2158 
	`TEST
("delete‚egative 1 from 500†ist") {

2159 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2160 
	`quickli¡S‘Fl
(
ql
, 32);

2161 
i
 = 0; i < 500; i++)

2162 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
 + 1), 32);

2163 
	`ql_v”ify
(
ql
, 16, 500, 32, 20);

2164 
	`quickli¡D–Rªge
(
ql
, -1, 1);

2165 
	`ql_v”ify
(
ql
, 16, 499, 32, 19);

2166 
	`quickli¡R–—£
(
ql
);

2169 
	`TEST
("delete‚egative 1 from 500†ist with overflow counts") {

2170 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2171 
	`quickli¡S‘Fl
(
ql
, 32);

2172 
i
 = 0; i < 500; i++)

2173 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
 + 1), 32);

2174 
	`ql_v”ify
(
ql
, 16, 500, 32, 20);

2175 
	`quickli¡D–Rªge
(
ql
, -1, 128);

2176 
	`ql_v”ify
(
ql
, 16, 499, 32, 19);

2177 
	`quickli¡R–—£
(
ql
);

2180 
	`TEST
("delete‚egative 100 from 500†ist") {

2181 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2182 
	`quickli¡S‘Fl
(
ql
, 32);

2183 
i
 = 0; i < 500; i++)

2184 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
 + 1), 32);

2185 
	`quickli¡D–Rªge
(
ql
, -100, 100);

2186 
	`ql_v”ify
(
ql
, 13, 400, 32, 16);

2187 
	`quickli¡R–—£
(
ql
);

2190 
	`TEST
("delete -10 count 5 from 50†ist") {

2191 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2192 
	`quickli¡S‘Fl
(
ql
, 32);

2193 
i
 = 0; i < 50; i++)

2194 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
 + 1), 32);

2195 
	`ql_v”ify
(
ql
, 2, 50, 32, 18);

2196 
	`quickli¡D–Rªge
(
ql
, -10, 5);

2197 
	`ql_v”ify
(
ql
, 2, 45, 32, 13);

2198 
	`quickli¡R–—£
(
ql
);

2201 
	`TEST
("numbers only†ist„ead") {

2202 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2203 
	`quickli¡PushTa
(
ql
, "1111", 4);

2204 
	`quickli¡PushTa
(
ql
, "2222", 4);

2205 
	`quickli¡PushTa
(
ql
, "3333", 4);

2206 
	`quickli¡PushTa
(
ql
, "4444", 4);

2207 
	`ql_v”ify
(
ql
, 1, 4, 4, 4);

2208 
quickli¡EÁry
 
’Œy
;

2209 
	`quickli¡Index
(
ql
, 0, &
’Œy
);

2210 ià(
’Œy
.
lÚgv®
 != 1111)

2211 
	`ERR
("NÙ 1111, %Îd", 
’Œy
.
lÚgv®
);

2212 
	`quickli¡Index
(
ql
, 1, &
’Œy
);

2213 ià(
’Œy
.
lÚgv®
 != 2222)

2214 
	`ERR
("NÙ 2222, %Îd", 
’Œy
.
lÚgv®
);

2215 
	`quickli¡Index
(
ql
, 2, &
’Œy
);

2216 ià(
’Œy
.
lÚgv®
 != 3333)

2217 
	`ERR
("NÙ 3333, %Îd", 
’Œy
.
lÚgv®
);

2218 
	`quickli¡Index
(
ql
, 3, &
’Œy
);

2219 ià(
’Œy
.
lÚgv®
 != 4444)

2220 
	`ERR
("NÙ 4444, %Îd", 
’Œy
.
lÚgv®
);

2221 ià(
	`quickli¡Index
(
ql
, 4, &
’Œy
))

2222 
	`ERR
("Index…a¡ƒËm’ts: %Îd", 
’Œy
.
lÚgv®
);

2223 
	`quickli¡Index
(
ql
, -1, &
’Œy
);

2224 ià(
’Œy
.
lÚgv®
 != 4444)

2225 
	`ERR
("NÙ 4444 (»v”£), %Îd", 
’Œy
.
lÚgv®
);

2226 
	`quickli¡Index
(
ql
, -2, &
’Œy
);

2227 ià(
’Œy
.
lÚgv®
 != 3333)

2228 
	`ERR
("NÙ 3333 (»v”£), %Îd", 
’Œy
.
lÚgv®
);

2229 
	`quickli¡Index
(
ql
, -3, &
’Œy
);

2230 ià(
’Œy
.
lÚgv®
 != 2222)

2231 
	`ERR
("NÙ 2222 (»v”£), %Îd", 
’Œy
.
lÚgv®
);

2232 
	`quickli¡Index
(
ql
, -4, &
’Œy
);

2233 ià(
’Œy
.
lÚgv®
 != 1111)

2234 
	`ERR
("NÙ 1111 (»v”£), %Îd", 
’Œy
.
lÚgv®
);

2235 ià(
	`quickli¡Index
(
ql
, -5, &
’Œy
))

2236 
	`ERR
("Index…a¡ƒËm’t Ôev”£), %Îd", 
’Œy
.
lÚgv®
);

2237 
	`quickli¡R–—£
(
ql
);

2240 
	`TEST
("numbers†arger†ist„ead") {

2241 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2242 
	`quickli¡S‘Fl
(
ql
, 32);

2243 
num
[32];

2244 
nums
[5000];

2245 
i
 = 0; i < 5000; i++) {

2246 
nums
[
i
] = -5157318210846258176 + i;

2247 
sz
 = 
	`Î2¡ršg
(
num
, Òum), 
nums
[
i
]);

2248 
	`quickli¡PushTa
(
ql
, 
num
, 
sz
);

2250 
	`quickli¡PushTa
(
ql
, "xxxxxxxxxxxxxxxxxxxx", 20);

2251 
quickli¡EÁry
 
’Œy
;

2252 
i
 = 0; i < 5000; i++) {

2253 
	`quickli¡Index
(
ql
, 
i
, &
’Œy
);

2254 ià(
’Œy
.
lÚgv®
 !ğ
nums
[
i
])

2255 
	`ERR
("[%d] NÙ†Úgv® %Îd buˆ¿th” %Îd", 
i
, 
nums
[i],

2256 
’Œy
.
lÚgv®
);

2257 
’Œy
.
lÚgv®
 = 0xdeadbeef;

2259 
	`quickli¡Index
(
ql
, 5000, &
’Œy
);

2260 ià(
	`¡ºcmp
((*)
’Œy
.
v®ue
, "xxxxxxxxxxxxxxxxxxxx", 20))

2261 
	`ERR
("SŒšg v®‚Ù m©ch: %s", 
’Œy
.
v®ue
);

2262 
	`ql_v”ify
(
ql
, 157, 5001, 32, 9);

2263 
	`quickli¡R–—£
(
ql
);

2266 
	`TEST
("numbers†arger†ist„ead B") {

2267 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2268 
	`quickli¡PushTa
(
ql
, "99", 2);

2269 
	`quickli¡PushTa
(
ql
, "98", 2);

2270 
	`quickli¡PushTa
(
ql
, "xxxxxxxxxxxxxxxxxxxx", 20);

2271 
	`quickli¡PushTa
(
ql
, "96", 2);

2272 
	`quickli¡PushTa
(
ql
, "95", 2);

2273 
	`quickli¡R•ÏûAtIndex
(
ql
, 1, "foo", 3);

2274 
	`quickli¡R•ÏûAtIndex
(
ql
, -1, "bar", 3);

2275 
	`quickli¡R–—£
(
ql
);

2276 
OK
;

2279 
f
 = 
İtimize_¡¬t
; f < 16; f++) {

2280 
	`TEST_DESC
("Ìeme¡‡ˆfÈ%d‡ˆcom´es %d", 
f
, 
İtiÚs
[
_i
]) {

2281 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2282 *
wÜds
[] = {"abc", "foo", "bar", "foobar", "foobared",

2284 *
»suÉ
[] = {"abc", "foo", "foobar", "foobared",

2286 *
»suÉB
[] = {"abc", "foo", "foobar",

2288 
i
 = 0; i < 9; i++)

2289 
	`quickli¡PushTa
(
ql
, 
wÜds
[
i
], 
	`¡¾’
(words[i]));

2292 
quickli¡I‹r
 *
™”
 = 
	`quickli¡G‘I‹¿tÜ
(
ql
, 
AL_START_HEAD
);

2293 
quickli¡EÁry
 
’Œy
;

2294 
i
 = 0;

2295 
	`quickli¡Next
(
™”
, &
’Œy
)) {

2296 ià(
	`quickli¡Com·»
(
’Œy
.
zi
, (*)"bar", 3)) {

2297 
	`quickli¡D–EÁry
(
™”
, &
’Œy
);

2299 
i
++;

2301 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

2304 
™”
 = 
	`quickli¡G‘I‹¿tÜ
(
ql
, 
AL_START_HEAD
);

2305 
i
 = 0;

2306 
ok
 = 1;

2307 
	`quickli¡Next
(
™”
, &
’Œy
)) {

2310 ià(
	`¡ºcmp
((*)
’Œy
.
v®ue
, 
»suÉ
[
i
],ƒÁry.
sz
)) {

2311 
	`ERR
("No match‡t…osition %d, got %.*s instead of %s",

2312 
i
, 
’Œy
.
sz
,ƒÁry.
v®ue
, 
»suÉ
[i]);

2313 
ok
 = 0;

2315 
i
++;

2317 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

2319 
	`quickli¡PushTa
(
ql
, "foo", 3);

2322 
™”
 = 
	`quickli¡G‘I‹¿tÜ
(
ql
, 
AL_START_TAIL
);

2323 
i
 = 0;

2324 
d–
 = 2;

2325 
	`quickli¡Next
(
™”
, &
’Œy
)) {

2326 ià(
	`quickli¡Com·»
(
’Œy
.
zi
, (*)"foo", 3)) {

2327 
	`quickli¡D–EÁry
(
™”
, &
’Œy
);

2328 
d–
--;

2330 ià(!
d–
)

2332 
i
++;

2334 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

2340 
™”
 = 
	`quickli¡G‘I‹¿tÜ
(
ql
, 
AL_START_TAIL
);

2341 
i
 = 0;

2342 
size_t
 
»sB
 = (
»suÉB
) / (*resultB);

2343 
	`quickli¡Next
(
™”
, &
’Œy
)) {

2346 ià(
	`¡ºcmp
((*)
’Œy
.
v®ue
, 
»suÉB
[
»sB
 - 1 - 
i
],

2347 
’Œy
.
sz
)) {

2348 
	`ERR
("No match‡t…osition %d, got %.*s instead of %s",

2349 
i
, 
’Œy
.
sz
,ƒÁry.
v®ue
, 
»suÉB
[
»sB
 - 1 - i]);

2350 
ok
 = 0;

2352 
i
++;

2355 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

2357 ià(
ok
)

2358 
OK
;

2359 
	`quickli¡R–—£
(
ql
);

2363 
f
 = 
İtimize_¡¬t
; f < 16; f++) {

2364 
	`TEST_DESC
("™”©»v”£ + d–‘© fÈ%d‡ˆcom´es %d", 
f
,

2365 
İtiÚs
[
_i
]) {

2366 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2367 
	`quickli¡PushTa
(
ql
, "abc", 3);

2368 
	`quickli¡PushTa
(
ql
, "def", 3);

2369 
	`quickli¡PushTa
(
ql
, "hij", 3);

2370 
	`quickli¡PushTa
(
ql
, "jkl", 3);

2371 
	`quickli¡PushTa
(
ql
, "oop", 3);

2373 
quickli¡EÁry
 
’Œy
;

2374 
quickli¡I‹r
 *
™”
 = 
	`quickli¡G‘I‹¿tÜ
(
ql
, 
AL_START_TAIL
);

2375 
i
 = 0;

2376 
	`quickli¡Next
(
™”
, &
’Œy
)) {

2377 ià(
	`quickli¡Com·»
(
’Œy
.
zi
, (*)"hij", 3)) {

2378 
	`quickli¡D–EÁry
(
™”
, &
’Œy
);

2380 
i
++;

2382 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

2384 ià(
i
 != 5)

2385 
	`ERR
("Didn'ˆ™”©5imes, i‹¿‹d %dimes.", 
i
);

2388 
™”
 = 
	`quickli¡G‘I‹¿tÜ
(
ql
, 
AL_START_HEAD
);

2389 
i
 = 0;

2390 *
v®s
[] = {"abc", "def", "jkl", "oop"};

2391 
	`quickli¡Next
(
™”
, &
’Œy
)) {

2392 ià(!
	`quickli¡Com·»
(
’Œy
.
zi
, (*)
v®s
[
i
],

2394 
	`ERR
("V®u© %d didn'ˆm©ch %s\n", 
i
, 
v®s
[i]);

2396 
i
++;

2398 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

2399 
	`quickli¡R–—£
(
ql
);

2403 
f
 = 
İtimize_¡¬t
; f < 800; f++) {

2404 
	`TEST_DESC
("™”©Ü‡ˆšdexe¡‡ˆfÈ%d‡ˆcom´es %d", 
f
,

2405 
İtiÚs
[
_i
]) {

2406 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2407 
num
[32];

2408 
nums
[5000];

2409 
i
 = 0; i < 760; i++) {

2410 
nums
[
i
] = -5157318210846258176 + i;

2411 
sz
 = 
	`Î2¡ršg
(
num
, Òum), 
nums
[
i
]);

2412 
	`quickli¡PushTa
(
ql
, 
num
, 
sz
);

2415 
quickli¡EÁry
 
’Œy
;

2416 
quickli¡I‹r
 *
™”
 =

2417 
	`quickli¡G‘I‹¿tÜAtIdx
(
ql
, 
AL_START_HEAD
, 437);

2418 
i
 = 437;

2419 
	`quickli¡Next
(
™”
, &
’Œy
)) {

2420 ià(
’Œy
.
lÚgv®
 !ğ
nums
[
i
])

2421 
	`ERR
("Ex³ùed %Îd, buˆgÙ %Îd", 
’Œy
.
lÚgv®
,

2422 
nums
[
i
]);

2423 
i
++;

2425 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

2426 
	`quickli¡R–—£
(
ql
);

2430 
f
 = 
İtimize_¡¬t
; f < 40; f++) {

2431 
	`TEST_DESC
("Érime¡ A‡ˆfÈ%d‡ˆcom´es %d", 
f
,

2432 
İtiÚs
[
_i
]) {

2433 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2434 
num
[32];

2435 
nums
[5000];

2436 
i
 = 0; i < 32; i++) {

2437 
nums
[
i
] = -5157318210846258176 + i;

2438 
sz
 = 
	`Î2¡ršg
(
num
, Òum), 
nums
[
i
]);

2439 
	`quickli¡PushTa
(
ql
, 
num
, 
sz
);

2441 ià(
f
 == 32)

2442 
	`ql_v”ify
(
ql
, 1, 32, 32, 32);

2444 
	`quickli¡D–Rªge
(
ql
, 0, 25);

2445 
	`quickli¡D–Rªge
(
ql
, 0, 0);

2446 
quickli¡EÁry
 
’Œy
;

2447 
i
 = 0; i < 7; i++) {

2448 
	`quickli¡Index
(
ql
, 
i
, &
’Œy
);

2449 ià(
’Œy
.
lÚgv®
 !ğ
nums
[25 + 
i
])

2450 
	`ERR
("Deleted invalid„ange! Expected %lld but got "

2452 
’Œy
.
lÚgv®
, 
nums
[25 + 
i
]);

2454 ià(
f
 == 32)

2455 
	`ql_v”ify
(
ql
, 1, 7, 7, 7);

2456 
	`quickli¡R–—£
(
ql
);

2460 
f
 = 
İtimize_¡¬t
; f < 40; f++) {

2461 
	`TEST_DESC
("Érime¡ B‡ˆfÈ%d‡ˆcom´es %d", 
f
,

2462 
İtiÚs
[
_i
]) {

2465 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
QUICKLIST_NOCOMPRESS
);

2466 
num
[32];

2467 
nums
[5000];

2468 
i
 = 0; i < 33; i++) {

2469 
nums
[
i
] = i;

2470 
sz
 = 
	`Î2¡ršg
(
num
, Òum), 
nums
[
i
]);

2471 
	`quickli¡PushTa
(
ql
, 
num
, 
sz
);

2473 ià(
f
 == 32)

2474 
	`ql_v”ify
(
ql
, 2, 33, 32, 1);

2476 
	`quickli¡D–Rªge
(
ql
, 0, 5);

2477 
	`quickli¡D–Rªge
(
ql
, -16, 16);

2478 ià(
f
 == 32)

2479 
	`ql_v”ify
(
ql
, 1, 12, 12, 12);

2480 
quickli¡EÁry
 
’Œy
;

2481 
	`quickli¡Index
(
ql
, 0, &
’Œy
);

2482 ià(
’Œy
.
lÚgv®
 != 5)

2483 
	`ERR
("A:†Úgv®‚Ù 5, buˆ%Îd", 
’Œy
.
lÚgv®
);

2485 
OK
;

2486 
	`quickli¡Index
(
ql
, -1, &
’Œy
);

2487 ià(
’Œy
.
lÚgv®
 != 16)

2488 
	`ERR
("B! gÙ in¡—d: %Îd", 
’Œy
.
lÚgv®
);

2490 
OK
;

2491 
	`quickli¡PushTa
(
ql
, "bobobob", 7);

2492 
	`quickli¡Index
(
ql
, -1, &
’Œy
);

2493 ià(
	`¡ºcmp
((*)
’Œy
.
v®ue
, "bobobob", 7))

2494 
	`ERR
("Tail doesn't match bobobob, it's %.*s instead",

2495 
’Œy
.
sz
,ƒÁry.
v®ue
);

2496 
i
 = 0; i < 12; i++) {

2497 
	`quickli¡Index
(
ql
, 
i
, &
’Œy
);

2498 ià(
’Œy
.
lÚgv®
 !ğ
nums
[5 + 
i
])

2499 
	`ERR
("Deleted invalid„ange! Expected %lld but got "

2501 
’Œy
.
lÚgv®
, 
nums
[5 + 
i
]);

2503 
	`quickli¡R–—£
(
ql
);

2507 
f
 = 
İtimize_¡¬t
; f < 40; f++) {

2508 
	`TEST_DESC
("Érime¡ C‡ˆfÈ%d‡ˆcom´es %d", 
f
,

2509 
İtiÚs
[
_i
]) {

2510 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2511 
num
[32];

2512 
nums
[5000];

2513 
i
 = 0; i < 33; i++) {

2514 
nums
[
i
] = -5157318210846258176 + i;

2515 
sz
 = 
	`Î2¡ršg
(
num
, Òum), 
nums
[
i
]);

2516 
	`quickli¡PushTa
(
ql
, 
num
, 
sz
);

2518 ià(
f
 == 32)

2519 
	`ql_v”ify
(
ql
, 2, 33, 32, 1);

2521 
	`quickli¡D–Rªge
(
ql
, 0, 3);

2522 
	`quickli¡D–Rªge
(
ql
, -29,

2524 ià(
f
 == 32)

2525 
	`ql_v”ify
(
ql
, 1, 1, 1, 1);

2526 
quickli¡EÁry
 
’Œy
;

2527 
	`quickli¡Index
(
ql
, 0, &
’Œy
);

2528 ià(
’Œy
.
lÚgv®
 != -5157318210846258173)

2529 
ERROR
;

2531 
OK
;

2532 
	`quickli¡R–—£
(
ql
);

2536 
f
 = 
İtimize_¡¬t
; f < 40; f++) {

2537 
	`TEST_DESC
("Érime¡ D‡ˆfÈ%d‡ˆcom´es %d", 
f
,

2538 
İtiÚs
[
_i
]) {

2539 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2540 
num
[32];

2541 
nums
[5000];

2542 
i
 = 0; i < 33; i++) {

2543 
nums
[
i
] = -5157318210846258176 + i;

2544 
sz
 = 
	`Î2¡ršg
(
num
, Òum), 
nums
[
i
]);

2545 
	`quickli¡PushTa
(
ql
, 
num
, 
sz
);

2547 ià(
f
 == 32)

2548 
	`ql_v”ify
(
ql
, 2, 33, 32, 1);

2549 
	`quickli¡D–Rªge
(
ql
, -12, 3);

2550 ià(
ql
->
couÁ
 != 30)

2551 
	`ERR
("Didn't deleteƒxactlyhreeƒlements! Count is: %lu",

2552 
ql
->
couÁ
);

2553 
	`quickli¡R–—£
(
ql
);

2557 
f
 = 
İtimize_¡¬t
; f < 72; f++) {

2558 
	`TEST_DESC
("create quicklist from ziplist‡t fill %d‡t compress %d",

2559 
f
, 
İtiÚs
[
_i
]) {

2560 *
zl
 = 
	`zli¡New
();

2561 
nums
[64];

2562 
num
[64];

2563 
i
 = 0; i < 33; i++) {

2564 
nums
[
i
] = -5157318210846258176 + i;

2565 
sz
 = 
	`Î2¡ršg
(
num
, Òum), 
nums
[
i
]);

2566 
zl
 =

2567 
	`zli¡Push
(
zl
, (*)
num
, 
sz
, 
ZIPLIST_TAIL
);

2569 
i
 = 0; i < 33; i++) {

2570 
zl
 = 
	`zli¡Push
(zl, (*)
	`g’¡r
("h–lo", 
i
),

2571 32, 
ZIPLIST_TAIL
);

2573 
quickli¡
 *
ql
 = 
	`quickli¡C»©eFromZli¡
(
f
, 
İtiÚs
[
_i
], 
zl
);

2574 ià(
f
 == 1)

2575 
	`ql_v”ify
(
ql
, 66, 66, 1, 1);

2576 ià(
f
 == 32)

2577 
	`ql_v”ify
(
ql
, 3, 66, 32, 2);

2578 ià(
f
 == 66)

2579 
	`ql_v”ify
(
ql
, 1, 66, 66, 66);

2580 
	`quickli¡R–—£
(
ql
);

2584 
¡İ
 = 
	`m¡ime
();

2585 
ruÁime
[
_i
] = 
¡İ
 - 
¡¬t
;

2589 
li¡_sizes
[] = {250, 251, 500, 999, 1000};

2590 
¡¬t
 = 
	`m¡ime
();

2591 
li¡
 = 0;†i¡ < ()((
li¡_sizes
) / (*list_sizes));

2592 
li¡
++) {

2593 
f
 = 
İtimize_¡¬t
; f < 128; f++) {

2594 
d•th
 = 1; depth < 40; depth++) {

2596 
	`TEST_DESC
("verify specific compression of interior‚odes with "

2599 
li¡_sizes
[
li¡
], 
f
, 
d•th
) {

2600 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
d•th
);

2601 
i
 = 0; i < 
li¡_sizes
[
li¡
]; i++) {

2602 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lØTAIL", 
i
 + 1), 64);

2603 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lØHEAD", 
i
 + 1), 64);

2606 
quickli¡Node
 *
node
 = 
ql
->
h—d
;

2607 
low_¿w
 = 
ql
->
com´ess
;

2608 
high_¿w
 = 
ql
->
Ën
 - ql->
com´ess
;

2610 
©
 = 0;‡ˆ< 
ql
->
Ën
;

2611 
©
++, 
node
 =‚ode->
Ãxt
) {

2612 ià(
©
 < 
low_¿w
 ||‡ˆ>ğ
high_¿w
) {

2613 ià(
node
->
’codšg
 !ğ
QUICKLIST_NODE_ENCODING_RAW
) {

2614 
	`ERR
("Incorrect compression:‚ode %d is "

2617 
©
, 
d•th
, 
low_¿w
, 
high_¿w
, 
ql
->
Ën
,

2618 
node
->
sz
);

2621 ià(
node
->
’codšg
 !ğ
QUICKLIST_NODE_ENCODING_LZF
) {

2622 
	`ERR
("Incorrect‚on-compression:‚ode %d is NOT "

2625 
©
, 
d•th
, 
low_¿w
, 
high_¿w
, 
ql
->
Ën
,

2626 
node
->
sz
,‚ode->
©‹m±ed_com´ess
);

2630 
	`quickli¡R–—£
(
ql
);

2635 
¡İ
 = 
	`m¡ime
();

2637 
	`´štf
("\n");

2638 
size_t
 
i
 = 0; i < 
İtiÚ_couÁ
; i++)

2639 
	`´štf
("Te¡ Loİ %02d: %0.2à£cÚds.\n", 
İtiÚs
[
i
],

2640 ()
ruÁime
[
i
] / 1000);

2641 
	`´štf
("Com´essiÚs: %0.2à£cÚds.\n", ()(
¡İ
 - 
¡¬t
) / 1000);

2642 
	`´štf
("\n");

2644 ià(!
”r
)

2645 
	`´štf
("ALL TESTS PASSED!\n");

2647 
	`ERR
("SÜry,‚Ù‡Îe¡ ·s£d! IÀçù, %de¡ çed.", 
”r
);

2649  
”r
;

2650 
	}
}

	@quicklist.h

31 #iâdeà
__QUICKLIST_H__


32 
	#__QUICKLIST_H__


	)

44 
	squickli¡Node
 {

45 
quickli¡Node
 *
	m´ev
;

46 
quickli¡Node
 *
	mÃxt
;

47 *
	mzl
;

48 
	msz
;

49 
	mcouÁ
 : 16;

50 
	m’codšg
 : 2;

51 
	mcÚš”
 : 2;

52 
	m»com´ess
 : 1;

53 
	m©‹m±ed_com´ess
 : 1;

54 
	mexŒa
 : 10;

55 } 
	tquickli¡Node
;

62 
	squickli¡LZF
 {

63 
	msz
;

64 
	mcom´es£d
[];

65 } 
	tquickli¡LZF
;

73 
	squickli¡
 {

74 
quickli¡Node
 *
	mh—d
;

75 
quickli¡Node
 *
	m
;

76 
	mcouÁ
;

77 
	mËn
;

78 
	mfl
 : 16;

79 
	mcom´ess
 : 16;

80 } 
	tquickli¡
;

82 
	squickli¡I‹r
 {

83 cÚ¡ 
quickli¡
 *
	mquickli¡
;

84 
quickli¡Node
 *
	mcu¼’t
;

85 *
	mzi
;

86 
	moff£t
;

87 
	mdœeùiÚ
;

88 } 
	tquickli¡I‹r
;

90 
	squickli¡EÁry
 {

91 cÚ¡ 
quickli¡
 *
	mquickli¡
;

92 
quickli¡Node
 *
	mnode
;

93 *
	mzi
;

94 *
	mv®ue
;

95 
	mlÚgv®
;

96 
	msz
;

97 
	moff£t
;

98 } 
	tquickli¡EÁry
;

100 
	#QUICKLIST_HEAD
 0

	)

101 
	#QUICKLIST_TAIL
 -1

	)

104 
	#QUICKLIST_NODE_ENCODING_RAW
 1

	)

105 
	#QUICKLIST_NODE_ENCODING_LZF
 2

	)

108 
	#QUICKLIST_NOCOMPRESS
 0

	)

111 
	#QUICKLIST_NODE_CONTAINER_NONE
 1

	)

112 
	#QUICKLIST_NODE_CONTAINER_ZIPLIST
 2

	)

114 
	#quickli¡NodeIsCom´es£d
(
node
) \

115 ((
node
)->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_LZF
)

	)

118 
quickli¡
 *
quickli¡C»©e
();

119 
quickli¡
 *
quickli¡New
(
fl
, 
com´ess
);

120 
quickli¡S‘Com´essD•th
(
quickli¡
 *quickli¡, 
d•th
);

121 
quickli¡S‘Fl
(
quickli¡
 *quickli¡, 
fl
);

122 
quickli¡S‘O±iÚs
(
quickli¡
 *quickli¡, 
fl
, 
d•th
);

123 
quickli¡R–—£
(
quickli¡
 *quicklist);

124 
quickli¡PushH—d
(
quickli¡
 *quickli¡, *
v®ue
, cÚ¡ 
size_t
 
sz
);

125 
quickli¡PushTa
(
quickli¡
 *quickli¡, *
v®ue
, cÚ¡ 
size_t
 
sz
);

126 
quickli¡Push
(
quickli¡
 *quickli¡, *
v®ue
, cÚ¡ 
size_t
 
sz
,

127 
wh”e
);

128 
quickli¡Aµ’dZli¡
(
quickli¡
 *quickli¡, *
zl
);

129 
quickli¡
 *
quickli¡Aµ’dV®uesFromZli¡
(quicklist *quicklist,

130 *
zl
);

131 
quickli¡
 *
quickli¡C»©eFromZli¡
(
fl
, 
com´ess
,

132 *
zl
);

133 
quickli¡In£¹Aá”
(
quickli¡
 *quickli¡, 
quickli¡EÁry
 *
node
,

134 *
v®ue
, cÚ¡ 
size_t
 
sz
);

135 
quickli¡In£¹BefÜe
(
quickli¡
 *quickli¡, 
quickli¡EÁry
 *
node
,

136 *
v®ue
, cÚ¡ 
size_t
 
sz
);

137 
quickli¡D–EÁry
(
quickli¡I‹r
 *
™”
, 
quickli¡EÁry
 *
’Œy
);

138 
quickli¡R•ÏûAtIndex
(
quickli¡
 *quickli¡, 
šdex
, *
d©a
,

139 
sz
);

140 
quickli¡D–Rªge
(
quickli¡
 *quickli¡, cÚ¡ 
¡¬t
, cÚ¡ 
¡İ
);

141 
quickli¡I‹r
 *
quickli¡G‘I‹¿tÜ
(cÚ¡ 
quickli¡
 *quickli¡, 
dœeùiÚ
);

142 
quickli¡I‹r
 *
quickli¡G‘I‹¿tÜAtIdx
(cÚ¡ 
quickli¡
 *quicklist,

143 
dœeùiÚ
, cÚ¡ 
idx
);

144 
quickli¡Next
(
quickli¡I‹r
 *
™”
, 
quickli¡EÁry
 *
node
);

145 
quickli¡R–—£I‹¿tÜ
(
quickli¡I‹r
 *
™”
);

146 
quickli¡
 *
quickli¡Dup
(quickli¡ *
Üig
);

147 
quickli¡Index
(cÚ¡ 
quickli¡
 *quickli¡, cÚ¡ 
šdex
,

148 
quickli¡EÁry
 *
’Œy
);

149 
quickli¡Rewšd
(
quickli¡
 *quickli¡, 
quickli¡I‹r
 *
li
);

150 
quickli¡RewšdTa
(
quickli¡
 *quickli¡, 
quickli¡I‹r
 *
li
);

151 
quickli¡RÙ©e
(
quickli¡
 *quicklist);

152 
quickli¡PİCu¡om
(
quickli¡
 *quickli¡, 
wh”e
, **
d©a
,

153 *
sz
, *
sv®
,

154 *(*
§v”
)(*
d©a
, 
sz
));

155 
quickli¡Pİ
(
quickli¡
 *quickli¡, 
wh”e
, **
d©a
,

156 *
sz
, *
¦Úg
);

157 
quickli¡CouÁ
(cÚ¡ 
quickli¡
 *
ql
);

158 
quickli¡Com·»
(*
p1
, *
p2
, 
p2_Ën
);

159 
size_t
 
quickli¡G‘Lzf
(cÚ¡ 
quickli¡Node
 *
node
, **
d©a
);

161 #ifdeà
REDIS_TEST


162 
quickli¡Te¡
(
¬gc
, *
¬gv
[]);

166 
	#AL_START_HEAD
 0

	)

167 
	#AL_START_TAIL
 1

	)

	@rand.c

44 
	~<¡dšt.h
>

46 
	#N
 16

	)

47 
	#MASK
 ((1 << (
N
 - 1)è+ (1 << (N - 1)è- 1)

	)

48 
	#LOW
(
x
è(()(xè& 
MASK
)

	)

49 
	#HIGH
(
x
è
	`LOW
((xè>> 
N
)

	)

50 
	#MUL
(
x
, 
y
, 
z
è{ 
št32_t
 
l
 = ()(x) * ()(y); \

51 (
z
)[0] = 
	`LOW
(
l
); (z)[1] = 
	`HIGH
Ö); }

	)

52 
	#CARRY
(
x
, 
y
è((
št32_t
)(xè+ ()(yè> 
MASK
)

	)

53 
	#ADDEQU
(
x
, 
y
, 
z
è(z = 
	`CARRY
(x, (y)), x = 
	`LOW
(x + (y)))

	)

54 
	#X0
 0x330E

	)

55 
	#X1
 0xABCD

	)

56 
	#X2
 0x1234

	)

57 
	#A0
 0xE66D

	)

58 
	#A1
 0xDEEC

	)

59 
	#A2
 0x5

	)

60 
	#C
 0xB

	)

61 
	#SET3
(
x
, 
x0
, 
x1
, 
x2
è((x)[0] = (x0), (x)[1] = (x1), (x)[2] = (x2))

	)

62 
	#SETLOW
(
x
, 
y
, 
n
è
	`SET3
(x, 
	`LOW
((y)[n]), LOW((y)[Ò)+1]), LOW((y)[Ò)+2]))

	)

63 
	#SEED
(
x0
, 
x1
, 
x2
è(
	`SET3
(
x
, x0, x1, x2), SET3(
a
, 
A0
, 
A1
, 
A2
), 
c
 = 
C
)

	)

64 
	#REST
(
v
è
i
 = 0; i < 3; i++è{ 
xsubi
[i] = 
x
[i]; x[i] = 
‹mp
[i]; } \

65  (
v
);

	)

66 
	#HI_BIT
 (1L << (2 * 
N
 - 1))

	)

68 
ušt32_t
 
	gx
[3] = { 
X0
, 
X1
, 
X2
 }, 
	ga
[3] = { 
A0
, 
A1
, 
A2
 }, 
	gc
 = 
C
;

69 
Ãxt
();

71 
št32_t
 
	$»disL¿nd48
() {

72 
	`Ãxt
();

73  (((
št32_t
)
x
[2] << (
N
 - 1)) + (x[1] >> 1));

74 
	}
}

76 
	$»disS¿nd48
(
št32_t
 
£edv®
) {

77 
	`SEED
(
X0
, 
	`LOW
(
£edv®
), 
	`HIGH
(seedval));

78 
	}
}

80 
	$Ãxt
() {

81 
ušt32_t
 
p
[2], 
q
[2], 
r
[2], 
ÿ¼y0
, 
ÿ¼y1
;

83 
	`MUL
(
a
[0], 
x
[0], 
p
);

84 
	`ADDEQU
(
p
[0], 
c
, 
ÿ¼y0
);

85 
	`ADDEQU
(
p
[1], 
ÿ¼y0
, 
ÿ¼y1
);

86 
	`MUL
(
a
[0], 
x
[1], 
q
);

87 
	`ADDEQU
(
p
[1], 
q
[0], 
ÿ¼y0
);

88 
	`MUL
(
a
[1], 
x
[0], 
r
);

89 
x
[2] = 
	`LOW
(
ÿ¼y0
 + 
ÿ¼y1
 + 
	`CARRY
(
p
[1], 
r
[0]è+ 
q
[1] +„[1] +

90 
a
[0] * 
x
[2] +‡[1] * x[1] +‡[2] * x[0]);

91 
x
[1] = 
	`LOW
(
p
[1] + 
r
[0]);

92 
x
[0] = 
	`LOW
(
p
[0]);

93 
	}
}

	@rand.h

30 #iâdeà
REDIS_RANDOM_H


31 
	#REDIS_RANDOM_H


	)

33 
št32_t
 
»disL¿nd48
();

34 
»disS¿nd48
(
št32_t
 
£edv®
);

36 
	#REDIS_LRAND48_MAX
 
INT32_MAX


	)

	@rax.c

31 
	~<¡dlib.h
>

32 
	~<¡ršg.h
>

33 
	~<as£¹.h
>

34 
	~<¡dio.h
>

35 
	~<”ºo.h
>

36 
	~<m©h.h
>

37 
	~"¿x.h
"

39 #iâdeà
RAX_MALLOC_INCLUDE


40 
	#RAX_MALLOC_INCLUDE
 "¿x_m®loc.h"

	)

43 #šşud
RAX_MALLOC_INCLUDE


48 *
	g¿xNÙFound
 = (*)"rax-not-found-pointer";

52 
¿xDebugShowNode
(cÚ¡ *
msg
, 
¿xNode
 *
n
);

56 
	#debugf
(...) \

58 
	`´štf
("%s:%s:%d:\t", 
__FILE__
, 
__FUNCTION__
, 
__LINE__
); \

59 
	`´štf
(
__VA_ARGS__
); \

60 
	`fæush
(
¡dout
); \

61 } 0);

	)

63 
	#debugnode
(
msg
,
n
è
	`¿xDebugShowNode
(msg,n)

	)

65 
	#debugf
(...)

	)

66 
	#debugnode
(
msg
,
n
)

	)

78 
šlše
 
	$¿xSckIn™
(
¿xSck
 *
ts
) {

79 
ts
->
¡ack
 =s->
¡©ic_™ems
;

80 
ts
->
™ems
 = 0;

81 
ts
->
max™ems
 = 
RAX_STACK_STATIC_ITEMS
;

82 
ts
->
oom
 = 0;

83 
	}
}

86 
šlše
 
	$¿xSckPush
(
¿xSck
 *
ts
, *
±r
) {

87 ià(
ts
->
™ems
 =ğts->
max™ems
) {

88 ià(
ts
->
¡ack
 =ğts->
¡©ic_™ems
) {

89 
ts
->
¡ack
 = 
	`¿x_m®loc
((*)*ts->
max™ems
*2);

90 ià(
ts
->
¡ack
 =ğ
NULL
) {

91 
ts
->
¡ack
 =s->
¡©ic_™ems
;

92 
ts
->
oom
 = 1;

93 
”ºo
 = 
ENOMEM
;

96 
	`memıy
(
ts
->
¡ack
,ts->
¡©ic_™ems
,(*)*ts->
max™ems
);

98 **
Ãw®loc
 = 
	`¿x_»®loc
(
ts
->
¡ack
,(*)*ts->
max™ems
*2);

99 ià(
Ãw®loc
 =ğ
NULL
) {

100 
ts
->
oom
 = 1;

101 
”ºo
 = 
ENOMEM
;

104 
ts
->
¡ack
 = 
Ãw®loc
;

106 
ts
->
max™ems
 *= 2;

108 
ts
->
¡ack
[ts->
™ems
] = 
±r
;

109 
ts
->
™ems
++;

111 
	}
}

115 
šlše
 *
	$¿xSckPİ
(
¿xSck
 *
ts
) {

116 ià(
ts
->
™ems
 =ğ0è 
NULL
;

117 
ts
->
™ems
--;

118  
ts
->
¡ack
[ts->
™ems
];

119 
	}
}

123 
šlše
 *
	$¿xSckP“k
(
¿xSck
 *
ts
) {

124 ià(
ts
->
™ems
 =ğ0è 
NULL
;

125  
ts
->
¡ack
[ts->
™ems
-1];

126 
	}
}

129 
šlše
 
	$¿xSckF»e
(
¿xSck
 *
ts
) {

130 ià(
ts
->
¡ack
 !ğts->
¡©ic_™ems
è
	`¿x_ä“
(ts->stack);

131 
	}
}

141 
¿xNode
 *
	$¿xNewNode
(
size_t
 
chd»n
, 
d©af›ld
) {

142 
size_t
 
nodesize
 = (
¿xNode
)+
chd»n
+

143 (
¿xNode
*)*
chd»n
;

144 ià(
d©af›ld
è
nodesize
 += (*);

145 
¿xNode
 *
node
 = 
	`¿x_m®loc
(
nodesize
);

146 ià(
node
 =ğ
NULL
)  NULL;

147 
node
->
iskey
 = 0;

148 
node
->
i¢uÎ
 = 0;

149 
node
->
iscom´
 = 0;

150 
node
->
size
 = 
chd»n
;

151  
node
;

152 
	}
}

156 
¿x
 *
	$¿xNew
() {

157 
¿x
 *¿x = 
	`¿x_m®loc
((*rax));

158 ià(
¿x
 =ğ
NULL
)  NULL;

159 
¿x
->
num–e
 = 0;

160 
¿x
->
numnodes
 = 1;

161 
¿x
->
h—d
 = 
	`¿xNewNode
(0,0);

162 ià(
¿x
->
h—d
 =ğ
NULL
) {

163 
	`¿x_ä“
(
¿x
);

164  
NULL
;

166  
¿x
;

168 
	}
}

171 
	#¿xNodeCu¼’tL’gth
(
n
) ( \

172 (
¿xNode
)+(
n
)->
size
+ \

173 ((
n
)->
iscom´
 ? (
¿xNode
*è: ÔaxNode*)*Ò)->
size
)+ \

174 (((
n
)->
iskey
 && !Ò)->
i¢uÎ
)*(*)) \

175 )

	)

179 
¿xNode
 *
	$¿xR—ÎocFÜD©a
(
¿xNode
 *
n
, *
d©a
) {

180 ià(
d©a
 =ğ
NULL
è 
n
;

181 
size_t
 
cu¾’
 = 
	`¿xNodeCu¼’tL’gth
(
n
);

182  
	`¿x_»®loc
(
n
,
cu¾’
+(*));

183 
	}
}

186 
	$¿xS‘D©a
(
¿xNode
 *
n
, *
d©a
) {

187 
n
->
iskey
 = 1;

188 ià(
d©a
 !ğ
NULL
) {

189 **
nd©a
 = (**)

190 ((*)
n
+
	`¿xNodeCu¼’tL’gth
(n)-(*));

191 
	`memıy
(
nd©a
,&
d©a
,(data));

192 
n
->
i¢uÎ
 = 0;

194 
n
->
i¢uÎ
 = 1;

196 
	}
}

199 *
	$¿xG‘D©a
(
¿xNode
 *
n
) {

200 ià(
n
->
i¢uÎ
è 
NULL
;

201 **
nd©a
 =(**)((*)
n
+
	`¿xNodeCu¼’tL’gth
(n)-(*));

202 *
d©a
;

203 
	`memıy
(&
d©a
,
nd©a
,(data));

204  
d©a
;

205 
	}
}

216 
¿xNode
 *
	$¿xAddChd
(
¿xNode
 *
n
, 
c
,„axNod**
chd±r
,„axNod***
·»Álšk
) {

217 
	`as£¹
(
n
->
iscom´
 == 0);

219 
size_t
 
cu¾’
 = (
¿xNode
)+

220 
n
->
size
+

221 (
¿xNode
*)*
n
->
size
;

222 
size_t
 
ÃwËn
;

225 
¿xNode
 *
chd
 = 
	`¿xNewNode
(0,0);

226 ià(
chd
 =ğ
NULL
)  NULL;

229 ià(
n
->
iskey
è
cu¾’
 += (*);

230 
ÃwËn
 = 
cu¾’
+(
¿xNode
*)+1;

231 
¿xNode
 *
Ãwn
 = 
	`¿x_»®loc
(
n
,
ÃwËn
);

232 ià(
Ãwn
 =ğ
NULL
) {

233 
	`¿x_ä“
(
chd
);

234  
NULL
;

236 
n
 = 
Ãwn
;

246 
pos
;

247 
pos
 = 0;…o < 
n
->
size
;…os++) {

248 ià(
n
->
d©a
[
pos
] > 
c
) ;

256 *
¤c
;

257 ià(
n
->
iskey
 && !n->
i¢uÎ
) {

258 
¤c
 = 
n
->
d©a
+n->
size
+(
¿xNode
*)*n->size;

259 
	`memmove
(
¤c
+1+(
¿xNode
*),src,(*));

268 
¤c
 = 
n
->
d©a
+n->
size
+(
¿xNode
*)*
pos
;

269 
	`memmove
(
¤c
+1+(
¿xNode
*),¤c,ÔaxNode*)*(
n
->
size
-
pos
));

276 
¤c
 = 
n
->
d©a
+
pos
;

277 
	`memmove
(
¤c
+1,¤c,
n
->
size
-
pos
+(
¿xNode
*)*pos);

283 
n
->
d©a
[
pos
] = 
c
;

284 
n
->
size
++;

285 
¿xNode
 **
chdf›ld
 = (¿xNode**)(
n
->
d©a
+n->
size
+ÔaxNode*)*
pos
);

286 
	`memıy
(
chdf›ld
,&
chd
,(child));

287 *
chd±r
 = 
chd
;

288 *
·»Álšk
 = 
chdf›ld
;

289  
n
;

290 
	}
}

294 
	#¿xNodeLa¡ChdPŒ
(
n
è((
¿xNode
**) ( \

295 ((*)(
n
)) + \

296 
	`¿xNodeCu¼’tL’gth
(
n
) - \

297 (
¿xNode
*) - \

298 (((
n
)->
iskey
 && !Ò)->
i¢uÎ
) ? (*) : 0) \

299 ))

	)

302 
	#¿xNodeFœ¡ChdPŒ
(
n
è((
¿xNode
**)(Ò)->
d©a
+Ò)->
size
))

	)

312 
¿xNode
 *
	$¿xCom´essNode
(
¿xNode
 *
n
, *
s
, 
size_t
 
Ën
,„axNod**
chd
) {

313 
	`as£¹
(
n
->
size
 =ğ0 &&‚->
iscom´
 == 0);

314 *
d©a
 = 
NULL
;

315 
size_t
 
Ãwsize
;

317 
	`debugf
("Com´es node: %.*s\n", ()
Ën
,
s
);

320 *
chd
 = 
	`¿xNewNode
(0,0);

321 ià(*
chd
 =ğ
NULL
)  NULL;

324 
Ãwsize
 = (
¿xNode
)+
Ën
+(raxNode*);

325 ià(
n
->
iskey
) {

326 
d©a
 = 
	`¿xG‘D©a
(
n
);

327 ià(!
n
->
i¢uÎ
è
Ãwsize
 += (*);

329 
¿xNode
 *
Ãwn
 = 
	`¿x_»®loc
(
n
,
Ãwsize
);

330 ià(
Ãwn
 =ğ
NULL
) {

331 
	`¿x_ä“
(*
chd
);

332  
NULL
;

334 
n
 = 
Ãwn
;

336 
n
->
iscom´
 = 1;

337 
n
->
size
 = 
Ën
;

338 
	`memıy
(
n
->
d©a
,
s
,
Ën
);

339 ià(
n
->
iskey
è
	`¿xS‘D©a
Ò,
d©a
);

340 
¿xNode
 **
chdf›ld
 = 
	`¿xNodeLa¡ChdPŒ
(
n
);

341 
	`memıy
(
chdf›ld
,
chd
,(*child));

342  
n
;

343 
	}
}

363 
šlše
 
size_t
 
	$¿xLowW®k
(
¿x
 *¿x, *
s
, 
size_t
 
Ën
, 
¿xNode
 **
¡İnode
,„axNod***
¶šk
, *
¥l™pos
, 
¿xSck
 *
ts
) {

364 
¿xNode
 *
h
 = 
¿x
->
h—d
;

365 
¿xNode
 **
·»Álšk
 = &
¿x
->
h—d
;

367 
size_t
 
i
 = 0;

368 
size_t
 
j
 = 0;

369 
h
->
size
 && 
i
 < 
Ën
) {

370 
	`debugnode
("Looku°cu¼’ˆnode",
h
);

371 *
v
 = 
h
->
d©a
;

373 ià(
h
->
iscom´
) {

374 
j
 = 0; j < 
h
->
size
 && 
i
 < 
Ën
; j++, i++) {

375 ià(
v
[
j
] !ğ
s
[
i
]) ;

377 ià(
j
 !ğ
h
->
size
) ;

382 
j
 = 0; j < 
h
->
size
; j++) {

383 ià(
v
[
j
] =ğ
s
[
i
]) ;

385 ià(
j
 =ğ
h
->
size
) ;

386 
i
++;

389 ià(
ts
è
	`¿xSckPush
Ñs,
h
);

390 
¿xNode
 **
chd»n
 = 
	`¿xNodeFœ¡ChdPŒ
(
h
);

391 ià(
h
->
iscom´
è
j
 = 0;

392 
	`memıy
(&
h
,
chd»n
+
j
,(h));

393 
·»Álšk
 = 
chd»n
+
j
;

394 
j
 = 0;

399 ià(
¡İnode
è*¡İnodğ
h
;

400 ià(
¶šk
è*¶šk = 
·»Álšk
;

401 ià(
¥l™pos
 && 
h
->
iscom´
è*¥l™po ğ
j
;

402  
i
;

403 
	}
}

410 
	$¿xIn£¹
(
¿x
 *¿x, *
s
, 
size_t
 
Ën
, *
d©a
, **
Şd
) {

411 
size_t
 
i
;

412 
j
 = 0;

416 
¿xNode
 *
h
, **
·»Álšk
;

418 
	`debugf
("### In£¹ %.* w™h v®u%p\n", ()
Ën
, 
s
, 
d©a
);

419 
i
 = 
	`¿xLowW®k
(
¿x
,
s
,
Ën
,&
h
,&
·»Álšk
,&
j
,
NULL
);

426 ià(
i
 =ğ
Ën
 && (!
h
->
iscom´
 || 
j
 == 0 )) {

427 ià(
h
->
iskey
) {

428 ià(
Şd
è*Şd = 
	`¿xG‘D©a
(
h
);

429 
	`¿xS‘D©a
(
h
,
d©a
);

430 
”ºo
 = 0;

433 
h
 = 
	`¿xR—ÎocFÜD©a
(h,
d©a
);

434 ià(
h
 =ğ
NULL
) {

435 
”ºo
 = 
ENOMEM
;

438 
	`memıy
(
·»Álšk
,&
h
,(h));

439 
	`¿xS‘D©a
(
h
,
d©a
);

440 
¿x
->
num–e
++;

569 ià(
h
->
iscom´
 && 
i
 !ğ
Ën
) {

570 
	`debugf
("ALGO 1: Stopped‡t compressed‚ode %.*s (%p)\n",

571 
h
->
size
, h->
d©a
, (*)h);

572 
	`debugf
("StÈtØš£¹: %.*s\n", ()(
Ën
-
i
), 
s
+i);

573 
	`debugf
("S¶™tšg‡ˆ%d: '%c'\n", 
j
, ((*)
h
->
d©a
)[j]);

574 
	`debugf
("Oth” (keyèË‰” i '%c'\n", 
s
[
i
]);

577 
¿xNode
 **
chdf›ld
 = 
	`¿xNodeLa¡ChdPŒ
(
h
);

578 
¿xNode
 *
Ãxt
;

579 
	`memıy
(&
Ãxt
,
chdf›ld
,(next));

580 
	`debugf
("Nexˆi %p\n", (*)
Ãxt
);

581 
	`debugf
("iskey %d\n", 
h
->
iskey
);

582 ià(
h
->
iskey
) {

583 
	`debugf
("key v®ui %p\n", 
	`¿xG‘D©a
(
h
));

587 
size_t
 
ŒimmedËn
 = 
j
;

588 
size_t
 
po¡fixËn
 = 
h
->
size
 - 
j
 - 1;

589 
¥l™_node_is_key
 = !
ŒimmedËn
 && 
h
->
iskey
 && !h->
i¢uÎ
;

590 
size_t
 
nodesize
;

594 
¿xNode
 *
¥l™node
 = 
	`¿xNewNode
(1, 
¥l™_node_is_key
);

595 
¿xNode
 *
Œimmed
 = 
NULL
;

596 
¿xNode
 *
po¡fix
 = 
NULL
;

598 ià(
ŒimmedËn
) {

599 
nodesize
 = (
¿xNode
)+
ŒimmedËn
+(raxNode*);

600 ià(
h
->
iskey
 && !h->
i¢uÎ
è
nodesize
 += (*);

601 
Œimmed
 = 
	`¿x_m®loc
(
nodesize
);

604 ià(
po¡fixËn
) {

605 
nodesize
 = (
¿xNode
)+
po¡fixËn
+

606 (
¿xNode
*);

607 
po¡fix
 = 
	`¿x_m®loc
(
nodesize
);

611 ià(
¥l™node
 =ğ
NULL
 ||

612 (
ŒimmedËn
 && 
Œimmed
 =ğ
NULL
) ||

613 (
po¡fixËn
 && 
po¡fix
 =ğ
NULL
))

615 
	`¿x_ä“
(
¥l™node
);

616 
	`¿x_ä“
(
Œimmed
);

617 
	`¿x_ä“
(
po¡fix
);

618 
”ºo
 = 
ENOMEM
;

621 
¥l™node
->
d©a
[0] = 
h
->d©a[
j
];

623 ià(
j
 == 0) {

625 ià(
h
->
iskey
) {

626 *
nd©a
 = 
	`¿xG‘D©a
(
h
);

627 
	`¿xS‘D©a
(
¥l™node
,
nd©a
);

629 
	`memıy
(
·»Álšk
,&
¥l™node
,(splitnode));

632 
Œimmed
->
size
 = 
j
;

633 
	`memıy
(
Œimmed
->
d©a
,
h
->d©a,
j
);

634 
Œimmed
->
iscom´
 = 
j
 > 1 ? 1 : 0;

635 
Œimmed
->
iskey
 = 
h
->iskey;

636 
Œimmed
->
i¢uÎ
 = 
h
->isnull;

637 ià(
h
->
iskey
 && !h->
i¢uÎ
) {

638 *
nd©a
 = 
	`¿xG‘D©a
(
h
);

639 
	`¿xS‘D©a
(
Œimmed
,
nd©a
);

641 
¿xNode
 **
ı
 = 
	`¿xNodeLa¡ChdPŒ
(
Œimmed
);

642 
	`memıy
(
ı
,&
¥l™node
,(splitnode));

643 
	`memıy
(
·»Álšk
,&
Œimmed
,(trimmed));

644 
·»Álšk
 = 
ı
;

645 
¿x
->
numnodes
++;

650 ià(
po¡fixËn
) {

652 
po¡fix
->
iskey
 = 0;

653 
po¡fix
->
i¢uÎ
 = 0;

654 
po¡fix
->
size
 = 
po¡fixËn
;

655 
po¡fix
->
iscom´
 = 
po¡fixËn
 > 1;

656 
	`memıy
(
po¡fix
->
d©a
,
h
->d©a+
j
+1,
po¡fixËn
);

657 
¿xNode
 **
ı
 = 
	`¿xNodeLa¡ChdPŒ
(
po¡fix
);

658 
	`memıy
(
ı
,&
Ãxt
,(next));

659 
¿x
->
numnodes
++;

662 
po¡fix
 = 
Ãxt
;

666 
¿xNode
 **
¥l™chd
 = 
	`¿xNodeLa¡ChdPŒ
(
¥l™node
);

667 
	`memıy
(
¥l™chd
,&
po¡fix
,(postfix));

672 
	`¿x_ä“
(
h
);

673 
h
 = 
¥l™node
;

674 } ià(
h
->
iscom´
 && 
i
 =ğ
Ën
) {

676 
	`debugf
("ALGO 2: Stopped‡t compressed‚ode %.*s (%p) j = %d\n",

677 
h
->
size
, h->
d©a
, (*)h, 
j
);

680 
size_t
 
po¡fixËn
 = 
h
->
size
 - 
j
;

681 
size_t
 
nodesize
 = (
¿xNode
)+
po¡fixËn
+(raxNode*);

682 ià(
d©a
 !ğ
NULL
è
nodesize
 += (*);

683 
¿xNode
 *
po¡fix
 = 
	`¿x_m®loc
(
nodesize
);

685 
nodesize
 = (
¿xNode
)+
j
+(raxNode*);

686 ià(
h
->
iskey
 && !h->
i¢uÎ
è
nodesize
 += (*);

687 
¿xNode
 *
Œimmed
 = 
	`¿x_m®loc
(
nodesize
);

689 ià(
po¡fix
 =ğ
NULL
 || 
Œimmed
 == NULL) {

690 
	`¿x_ä“
(
po¡fix
);

691 
	`¿x_ä“
(
Œimmed
);

692 
”ºo
 = 
ENOMEM
;

697 
¿xNode
 **
chdf›ld
 = 
	`¿xNodeLa¡ChdPŒ
(
h
);

698 
¿xNode
 *
Ãxt
;

699 
	`memıy
(&
Ãxt
,
chdf›ld
,(next));

702 
po¡fix
->
size
 = 
po¡fixËn
;

703 
po¡fix
->
iscom´
 = 
po¡fixËn
 > 1;

704 
po¡fix
->
iskey
 = 1;

705 
po¡fix
->
i¢uÎ
 = 0;

706 
	`memıy
(
po¡fix
->
d©a
,
h
->d©a+
j
,
po¡fixËn
);

707 
	`¿xS‘D©a
(
po¡fix
,
d©a
);

708 
¿xNode
 **
ı
 = 
	`¿xNodeLa¡ChdPŒ
(
po¡fix
);

709 
	`memıy
(
ı
,&
Ãxt
,(next));

710 
¿x
->
numnodes
++;

713 
Œimmed
->
size
 = 
j
;

714 
Œimmed
->
iscom´
 = 
j
 > 1;

715 
Œimmed
->
iskey
 = 0;

716 
Œimmed
->
i¢uÎ
 = 0;

717 
	`memıy
(
Œimmed
->
d©a
,
h
->d©a,
j
);

718 
	`memıy
(
·»Álšk
,&
Œimmed
,(trimmed));

719 ià(
h
->
iskey
) {

720 *
aux
 = 
	`¿xG‘D©a
(
h
);

721 
	`¿xS‘D©a
(
Œimmed
,
aux
);

726 
ı
 = 
	`¿xNodeLa¡ChdPŒ
(
Œimmed
);

727 
	`memıy
(
ı
,&
po¡fix
,(postfix));

731 
¿x
->
num–e
++;

732 
	`¿x_ä“
(
h
);

740 
i
 < 
Ën
) {

741 
¿xNode
 *
chd
;

746 ià(
h
->
size
 =ğ0 && 
Ën
-
i
 > 1) {

747 
	`debugf
("Inserting compressed‚ode\n");

748 
size_t
 
com´size
 = 
Ën
-
i
;

749 ià(
com´size
 > 
RAX_NODE_MAX_SIZE
)

750 
com´size
 = 
RAX_NODE_MAX_SIZE
;

751 
¿xNode
 *
Ãwh
 = 
	`¿xCom´essNode
(
h
,
s
+
i
,
com´size
,&
chd
);

752 ià(
Ãwh
 =ğ
NULL
è
oom
;

753 
h
 = 
Ãwh
;

754 
	`memıy
(
·»Álšk
,&
h
,(h));

755 
·»Álšk
 = 
	`¿xNodeLa¡ChdPŒ
(
h
);

756 
i
 +ğ
com´size
;

758 
	`debugf
("Inserting‚ormal‚ode\n");

759 
¿xNode
 **
Ãw_·»Álšk
;

760 
¿xNode
 *
Ãwh
 = 
	`¿xAddChd
(
h
,
s
[
i
],&
chd
,&
Ãw_·»Álšk
);

761 ià(
Ãwh
 =ğ
NULL
è
oom
;

762 
h
 = 
Ãwh
;

763 
	`memıy
(
·»Álšk
,&
h
,(h));

764 
·»Álšk
 = 
Ãw_·»Álšk
;

765 
i
++;

767 
¿x
->
numnodes
++;

768 
h
 = 
chd
;

770 
¿xNode
 *
Ãwh
 = 
	`¿xR—ÎocFÜD©a
(
h
,
d©a
);

771 ià(
Ãwh
 =ğ
NULL
è
oom
;

772 
h
 = 
Ãwh
;

773 ià(!
h
->
iskey
è
¿x
->
num–e
++;

774 
	`¿xS‘D©a
(
h
,
d©a
);

775 
	`memıy
(
·»Álšk
,&
h
,(h));

778 
oom
:

784 ià(
h
->
size
 == 0) {

785 
h
->
i¢uÎ
 = 1;

786 
h
->
iskey
 = 1;

787 
¿x
->
num–e
++;

788 
	`as£¹
(
	`¿xRemove
(
¿x
,
s
,
i
,
NULL
) != 0);

790 
”ºo
 = 
ENOMEM
;

792 
	}
}

797 *
	$¿xFšd
(
¿x
 *¿x, *
s
, 
size_t
 
Ën
) {

798 
¿xNode
 *
h
;

800 
	`debugf
("### Lookup: %.*s\n", ()
Ën
, 
s
);

801 
¥l™pos
 = 0;

802 
size_t
 
i
 = 
	`¿xLowW®k
(
¿x
,
s
,
Ën
,&
h
,
NULL
,&
¥l™pos
,NULL);

803 ià(
i
 !ğ
Ën
 || (
h
->
iscom´
 && 
¥l™pos
 !ğ0è|| !h->
iskey
)

804  
¿xNÙFound
;

805  
	`¿xG‘D©a
(
h
);

806 
	}
}

813 
¿xNode
 **
	$¿xFšdP¬’tLšk
(
¿xNode
 *
·»Á
,„axNod*
chd
) {

814 
¿xNode
 **
ı
 = 
	`¿xNodeFœ¡ChdPŒ
(
·»Á
);

815 
¿xNode
 *
c
;

817 
	`memıy
(&
c
,
ı
,(c));

818 ià(
c
 =ğ
chd
) ;

819 
ı
++;

821  
ı
;

822 
	}
}

828 
¿xNode
 *
	$¿xRemoveChd
(
¿xNode
 *
·»Á
,„axNod*
chd
) {

829 
	`debugnode
("¿xRemoveChd befÜe", 
·»Á
);

833 ià(
·»Á
->
iscom´
) {

834 *
d©a
 = 
NULL
;

835 ià(
·»Á
->
iskey
è
d©a
 = 
	`¿xG‘D©a
(parent);

836 
·»Á
->
i¢uÎ
 = 0;

837 
·»Á
->
iscom´
 = 0;

838 
·»Á
->
size
 = 0;

839 ià(
·»Á
->
iskey
è
	`¿xS‘D©a
Õ¬’t,
d©a
);

840 
	`debugnode
("¿xRemoveChd‡á”", 
·»Á
);

841  
·»Á
;

849 
¿xNode
 **
ı
 = 
	`¿xNodeFœ¡ChdPŒ
(
·»Á
);

850 
¿xNode
 **
c
 = 
ı
;

851 *
e
 = 
·»Á
->
d©a
;

856 
¿xNode
 *
aux
;

857 
	`memıy
(&
aux
,
c
,(aux));

858 ià(
aux
 =ğ
chd
) ;

859 
c
++;

860 
e
++;

865 
Ën
 = 
·»Á
->
size
 - (
e
 -…¬’t->
d©a
) - 1;

866 
	`debugf
("¿xRemoveChda†’: %d\n", 
Ën
);

867 
	`memmove
(
e
,e+1,
Ën
);

871 
	`memmove
(((*)
ı
)-1,ı,(
·»Á
->
size
-
Ën
-1)*(
¿xNode
**));

874 
	`memmove
(((*)
c
)-1,c+1,
Ën
*(
¿xNode
**)+
·»Á
->
iskey
*(*));

877 
·»Á
->
size
--;

881 
¿xNode
 *
Ãwnode
 = 
	`¿x_»®loc
(
·»Á
,
	`¿xNodeCu¼’tL’gth
(parent));

882 ià(
Ãwnode
) {

883 
	`debugnode
("¿xRemoveChd‡á”", 
Ãwnode
);

887  
Ãwnode
 ?‚ewnod: 
·»Á
;

888 
	}
}

892 
	$¿xRemove
(
¿x
 *¿x, *
s
, 
size_t
 
Ën
, **
Şd
) {

893 
¿xNode
 *
h
;

894 
¿xSck
 
ts
;

896 
	`debugf
("### D–‘e: %.*s\n", ()
Ën
, 
s
);

897 
	`¿xSckIn™
(&
ts
);

898 
¥l™pos
 = 0;

899 
size_t
 
i
 = 
	`¿xLowW®k
(
¿x
,
s
,
Ën
,&
h
,
NULL
,&
¥l™pos
,&
ts
);

900 ià(
i
 !ğ
Ën
 || (
h
->
iscom´
 && 
¥l™pos
 !ğ0è|| !h->
iskey
) {

901 
	`¿xSckF»e
(&
ts
);

904 ià(
Şd
è*Şd = 
	`¿xG‘D©a
(
h
);

905 
h
->
iskey
 = 0;

906 
¿x
->
num–e
--;

914 
Œycom´ess
 = 0;

917 ià(
h
->
size
 == 0) {

918 
	`debugf
("Key deleted in‚ode without children. Cleanup‚eeded.\n");

919 
¿xNode
 *
chd
 = 
NULL
;

920 
h
 !ğ
¿x
->
h—d
) {

921 
chd
 = 
h
;

922 
	`debugf
("F»ešg chd %°[%.*s] key:%d\n", (*)
chd
,

923 ()
chd
->
size
, (*)chd->
d©a
, chd->
iskey
);

924 
	`¿x_ä“
(
chd
);

925 
¿x
->
numnodes
--;

926 
h
 = 
	`¿xSckPİ
(&
ts
);

929 ià(
h
->
iskey
 || (!h->
iscom´
 && h->
size
 != 1)) ;

931 ià(
chd
) {

932 
	`debugf
("Unlinking child %p from…arent %p\n",

933 (*)
chd
, (*)
h
);

934 
¿xNode
 *
Ãw
 = 
	`¿xRemoveChd
(
h
,
chd
);

935 ià(
Ãw
 !ğ
h
) {

936 
¿xNode
 *
·»Á
 = 
	`¿xSckP“k
(&
ts
);

937 
¿xNode
 **
·»Álšk
;

938 ià(
·»Á
 =ğ
NULL
) {

939 
·»Álšk
 = &
¿x
->
h—d
;

941 
·»Álšk
 = 
	`¿xFšdP¬’tLšk
(
·»Á
,
h
);

943 
	`memıy
(
·»Álšk
,&
Ãw
,(new));

948 ià(
Ãw
->
size
 =ğ1 &&‚ew->
iskey
 == 0) {

949 
Œycom´ess
 = 1;

950 
h
 = 
Ãw
;

953 } ià(
h
->
size
 == 1) {

956 
Œycom´ess
 = 1;

961 ià(
Œycom´ess
 && 
ts
.
oom
)rycompress = 0;

1006 ià(
Œycom´ess
) {

1007 
	`debugf
("Aá”„emovšg %.*s:\n", ()
Ën
, 
s
);

1008 
	`debugnode
("Com´essiÚ may bÃeded",
h
);

1009 
	`debugf
("Seek start‚ode\n");

1014 
¿xNode
 *
·»Á
;

1016 
·»Á
 = 
	`¿xSckPİ
(&
ts
);

1017 ià(!
·»Á
 ||…¬’t->
iskey
 ||

1018 (!
·»Á
->
iscom´
 &&…¬’t->
size
 != 1)) ;

1019 
h
 = 
·»Á
;

1020 
	`debugnode
("Gošg u°to",
h
);

1022 
¿xNode
 *
¡¬t
 = 
h
;

1025 
size_t
 
com´size
 = 
h
->
size
;

1026 
nodes
 = 1;

1027 
h
->
size
 != 0) {

1028 
¿xNode
 **
ı
 = 
	`¿xNodeLa¡ChdPŒ
(
h
);

1029 
	`memıy
(&
h
,
ı
,(h));

1030 ià(
h
->
iskey
 || (!h->
iscom´
 && h->
size
 != 1)) ;

1033 ià(
com´size
 + 
h
->
size
 > 
RAX_NODE_MAX_SIZE
) ;

1034 
nodes
++;

1035 
com´size
 +ğ
h
->
size
;

1037 ià(
nodes
 > 1) {

1039 
size_t
 
nodesize
 =

1040 (
¿xNode
)+
com´size
+(raxNode*);

1041 
¿xNode
 *
Ãw
 = 
	`¿x_m®loc
(
nodesize
);

1044 ià(
Ãw
 =ğ
NULL
) {

1045 
	`¿xSckF»e
(&
ts
);

1048 
Ãw
->
iskey
 = 0;

1049 
Ãw
->
i¢uÎ
 = 0;

1050 
Ãw
->
iscom´
 = 1;

1051 
Ãw
->
size
 = 
com´size
;

1052 
¿x
->
numnodes
++;

1057 
com´size
 = 0;

1058 
h
 = 
¡¬t
;

1059 
h
->
size
 != 0) {

1060 
	`memıy
(
Ãw
->
d©a
+
com´size
,
h
->d©a,h->
size
);

1061 
com´size
 +ğ
h
->
size
;

1062 
¿xNode
 **
ı
 = 
	`¿xNodeLa¡ChdPŒ
(
h
);

1063 
¿xNode
 *
toä“
 = 
h
;

1064 
	`memıy
(&
h
,
ı
,(h));

1065 
	`¿x_ä“
(
toä“
); 
¿x
->
numnodes
--;

1066 ià(
h
->
iskey
 || (!h->
iscom´
 && h->
size
 != 1)) ;

1068 
	`debugnode
("New‚ode",
Ãw
);

1072 
¿xNode
 **
ı
 = 
	`¿xNodeLa¡ChdPŒ
(
Ãw
);

1073 
	`memıy
(
ı
,&
h
,(h));

1076 ià(
·»Á
) {

1077 
¿xNode
 **
·»Álšk
 = 
	`¿xFšdP¬’tLšk
(
·»Á
,
¡¬t
);

1078 
	`memıy
(
·»Álšk
,&
Ãw
,(new));

1080 
¿x
->
h—d
 = 
Ãw
;

1083 
	`debugf
("Compressed %d‚odes, %dotal bytes\n",

1084 
nodes
, ()
com´size
);

1087 
	`¿xSckF»e
(&
ts
);

1089 
	}
}

1093 
	$¿xRecursiveF»e
(
¿x
 *¿x, 
¿xNode
 *
n
) {

1094 
numchd»n
 = 
n
->
iscom´
 ? 1 :‚->
size
;

1095 
¿xNode
 **
ı
 = 
	`¿xNodeLa¡ChdPŒ
(
n
);

1096 
numchd»n
--) {

1097 
¿xNode
 *
chd
;

1098 
	`memıy
(&
chd
,
ı
,(child));

1099 
	`¿xRecursiveF»e
(
¿x
,
chd
);

1100 
ı
--;

1102 
	`debugnode
("ä“ d•th-fœ¡",
n
);

1103 
	`¿x_ä“
(
n
);

1104 
¿x
->
numnodes
--;

1105 
	}
}

1108 
	$¿xF»e
(
¿x
 *rax) {

1109 
	`¿xRecursiveF»e
(
¿x
,¿x->
h—d
);

1110 
	`as£¹
(
¿x
->
numnodes
 == 0);

1111 
	`¿x_ä“
(
¿x
);

1112 
	}
}

1119 
	$¿xS¹
(
¿xI‹¿tÜ
 *
™
, 
¿x
 *
¹
) {

1120 
™
->
æags
 = 
RAX_ITER_EOF
;

1121 
™
->
¹
 =„t;

1122 
™
->
key_Ën
 = 0;

1123 
™
->
key
 = it->
key_¡©ic_¡ršg
;

1124 
™
->
key_max
 = 
RAX_ITER_STATIC_LEN
;

1125 
™
->
d©a
 = 
NULL
;

1126 
	`¿xSckIn™
(&
™
->
¡ack
);

1127 
	}
}

1132 
	$¿xI‹¿tÜAddCh¬s
(
¿xI‹¿tÜ
 *
™
, *
s
, 
size_t
 
Ën
) {

1133 ià(
™
->
key_max
 < it->
key_Ën
+
Ën
) {

1134 *
Şd
 = (
™
->
key
 =ğ™->
key_¡©ic_¡ršg
è? 
NULL
 :

1135 
™
->
key
;

1136 
size_t
 
Ãw_max
 = (
™
->
key_Ën
+
Ën
)*2;

1137 
™
->
key
 = 
	`¿x_»®loc
(
Şd
,
Ãw_max
);

1138 ià(
™
->
key
 =ğ
NULL
) {

1139 
™
->
key
 = (!
Şd
è? it->
key_¡©ic_¡ršg
 : old;

1140 
”ºo
 = 
ENOMEM
;

1143 ià(
Şd
 =ğ
NULL
è
	`memıy
(
™
->
key
,™->
key_¡©ic_¡ršg
,™->
key_Ën
);

1144 
™
->
key_max
 = 
Ãw_max
;

1148 
	`memmove
(
™
->
key
+™->
key_Ën
,
s
,
Ën
);

1149 
™
->
key_Ën
 +ğ
Ën
;

1151 
	}
}

1155 
	$¿xI‹¿tÜD–Ch¬s
(
¿xI‹¿tÜ
 *
™
, 
size_t
 
couÁ
) {

1156 
™
->
key_Ën
 -ğ
couÁ
;

1157 
	}
}

1173 
	$¿xI‹¿tÜNextS‹p
(
¿xI‹¿tÜ
 *
™
, 
noup
) {

1174 ià(
™
->
æags
 & 
RAX_ITER_EOF
) {

1176 } ià(
™
->
æags
 & 
RAX_ITER_JUST_SEEKED
) {

1177 
™
->
æags
 &ğ~
RAX_ITER_JUST_SEEKED
;

1183 
size_t
 
Üig_key_Ën
 = 
™
->
key_Ën
;

1184 
size_t
 
Üig_¡ack_™ems
 = 
™
->
¡ack
.
™ems
;

1185 
¿xNode
 *
Üig_node
 = 
™
->
node
;

1189 
™
->
æags
 &ğ~
RAX_ITER_EOF
;

1192 
chd»n
 = 
™
->
node
->
iscom´
 ? 1 : it->node->
size
;

1193 ià(!
noup
 && 
chd»n
) {

1194 
	`debugf
("GO DEEPER\n");

1198 ià(!
	`¿xSckPush
(&
™
->
¡ack
,™->
node
))  0;

1199 
¿xNode
 **
ı
 = 
	`¿xNodeFœ¡ChdPŒ
(
™
->
node
);

1200 ià(!
	`¿xI‹¿tÜAddCh¬s
(
™
,™->
node
->
d©a
,

1201 
™
->
node
->
iscom´
 ? it->node->
size
 : 1))  0;

1202 
	`memıy
(&
™
->
node
,
ı
,(it->node));

1206 ià(
™
->
node
->
iskey
) {

1207 
™
->
d©a
 = 
	`¿xG‘D©a
(™->
node
);

1216 
Şd_noup
 = 
noup
;

1219 ià(!
noup
 && 
™
->
node
 =ğ™->
¹
->
h—d
) {

1220 
™
->
æags
 |ğ
RAX_ITER_EOF
;

1221 
™
->
¡ack
.
™ems
 = 
Üig_¡ack_™ems
;

1222 
™
->
key_Ën
 = 
Üig_key_Ën
;

1223 
™
->
node
 = 
Üig_node
;

1228 
´evchd
 = 
™
->
key
[™->
key_Ën
-1];

1229 ià(!
noup
) {

1230 
™
->
node
 = 
	`¿xSckPİ
(&™->
¡ack
);

1232 
noup
 = 0;

1236 
tod–
 = 
™
->
node
->
iscom´
 ? it->node->
size
 : 1;

1237 
	`¿xI‹¿tÜD–Ch¬s
(
™
,
tod–
);

1241 ià(!
™
->
node
->
iscom´
 && it->node->
size
 > (
Şd_noup
 ? 0 : 1)) {

1242 
¿xNode
 **
ı
 = 
	`¿xNodeFœ¡ChdPŒ
(
™
->
node
);

1243 
i
 = 0;

1244 
i
 < 
™
->
node
->
size
) {

1245 
	`debugf
("SCAN NEXT %c\n", 
™
->
node
->
d©a
[
i
]);

1246 ià(
™
->
node
->
d©a
[
i
] > 
´evchd
) ;

1247 
i
++;

1248 
ı
++;

1250 ià(
i
 !ğ
™
->
node
->
size
) {

1251 
	`debugf
("SCAN found‡‚ew‚ode\n");

1252 
	`¿xI‹¿tÜAddCh¬s
(
™
,™->
node
->
d©a
+
i
,1);

1253 ià(!
	`¿xSckPush
(&
™
->
¡ack
,™->
node
))  0;

1254 
	`memıy
(&
™
->
node
,
ı
,(it->node));

1255 ià(
™
->
node
->
iskey
) {

1256 
™
->
d©a
 = 
	`¿xG‘D©a
(™->
node
);

1265 
	}
}

1270 
	$¿xS“kG»©e¡
(
¿xI‹¿tÜ
 *
™
) {

1271 
™
->
node
->
size
) {

1272 ià(
™
->
node
->
iscom´
) {

1273 ià(!
	`¿xI‹¿tÜAddCh¬s
(
™
,™->
node
->
d©a
,

1274 
™
->
node
->
size
))  0;

1276 ià(!
	`¿xI‹¿tÜAddCh¬s
(
™
,™->
node
->
d©a
+™->node->
size
-1,1))

1279 
¿xNode
 **
ı
 = 
	`¿xNodeLa¡ChdPŒ
(
™
->
node
);

1280 ià(!
	`¿xSckPush
(&
™
->
¡ack
,™->
node
))  0;

1281 
	`memıy
(&
™
->
node
,
ı
,(it->node));

1284 
	}
}

1289 
	$¿xI‹¿tÜP»vS‹p
(
¿xI‹¿tÜ
 *
™
, 
noup
) {

1290 ià(
™
->
æags
 & 
RAX_ITER_EOF
) {

1292 } ià(
™
->
æags
 & 
RAX_ITER_JUST_SEEKED
) {

1293 
™
->
æags
 &ğ~
RAX_ITER_JUST_SEEKED
;

1299 
size_t
 
Üig_key_Ën
 = 
™
->
key_Ën
;

1300 
size_t
 
Üig_¡ack_™ems
 = 
™
->
¡ack
.
™ems
;

1301 
¿xNode
 *
Üig_node
 = 
™
->
node
;

1304 
Şd_noup
 = 
noup
;

1307 ià(!
noup
 && 
™
->
node
 =ğ™->
¹
->
h—d
) {

1308 
™
->
æags
 |ğ
RAX_ITER_EOF
;

1309 
™
->
¡ack
.
™ems
 = 
Üig_¡ack_™ems
;

1310 
™
->
key_Ën
 = 
Üig_key_Ën
;

1311 
™
->
node
 = 
Üig_node
;

1315 
´evchd
 = 
™
->
key
[™->
key_Ën
-1];

1316 ià(!
noup
) {

1317 
™
->
node
 = 
	`¿xSckPİ
(&™->
¡ack
);

1319 
noup
 = 0;

1324 
tod–
 = 
™
->
node
->
iscom´
 ? it->node->
size
 : 1;

1325 
	`¿xI‹¿tÜD–Ch¬s
(
™
,
tod–
);

1329 ià(!
™
->
node
->
iscom´
 && it->node->
size
 > (
Şd_noup
 ? 0 : 1)) {

1330 
¿xNode
 **
ı
 = 
	`¿xNodeLa¡ChdPŒ
(
™
->
node
);

1331 
i
 = 
™
->
node
->
size
-1;

1332 
i
 >= 0) {

1333 
	`debugf
("SCAN PREV %c\n", 
™
->
node
->
d©a
[
i
]);

1334 ià(
™
->
node
->
d©a
[
i
] < 
´evchd
) ;

1335 
i
--;

1336 
ı
--;

1341 ià(
i
 != -1) {

1342 
	`debugf
("SCAN found‡‚ew‚ode\n");

1344 ià(!
	`¿xI‹¿tÜAddCh¬s
(
™
,™->
node
->
d©a
+
i
,1))  0;

1345 ià(!
	`¿xSckPush
(&
™
->
¡ack
,™->
node
))  0;

1346 
	`memıy
(&
™
->
node
,
ı
,(it->node));

1348 ià(!
	`¿xS“kG»©e¡
(
™
))  0;

1355 ià(
™
->
node
->
iskey
) {

1356 
™
->
d©a
 = 
	`¿xG‘D©a
(™->
node
);

1360 
	}
}

1366 
	$¿xS“k
(
¿xI‹¿tÜ
 *
™
, cÚ¡ *
İ
, *
–e
, 
size_t
 
Ën
) {

1367 
eq
 = 0, 
É
 = 0, 
gt
 = 0, 
fœ¡
 = 0, 
Ï¡
 = 0;

1369 
™
->
¡ack
.
™ems
 = 0;

1370 
™
->
æags
 |ğ
RAX_ITER_JUST_SEEKED
;

1371 
™
->
æags
 &ğ~
RAX_ITER_EOF
;

1372 
™
->
key_Ën
 = 0;

1373 
™
->
node
 = 
NULL
;

1376 ià(
İ
[0] == '>') {

1377 
gt
 = 1;

1378 ià(
İ
[1] =ğ'='è
eq
 = 1;

1379 } ià(
İ
[0] == '<') {

1380 
É
 = 1;

1381 ià(
İ
[1] =ğ'='è
eq
 = 1;

1382 } ià(
İ
[0] == '=') {

1383 
eq
 = 1;

1384 } ià(
İ
[0] == '^') {

1385 
fœ¡
 = 1;

1386 } ià(
İ
[0] == '$') {

1387 
Ï¡
 = 1;

1389 
”ºo
 = 0;

1395 ià(
™
->
¹
->
num–e
 == 0) {

1396 
™
->
æags
 |ğ
RAX_ITER_EOF
;

1400 ià(
fœ¡
) {

1403  
	`¿xS“k
(
™
,">=",
NULL
,0);

1406 ià(
Ï¡
) {

1409 
™
->
node
 = it->
¹
->
h—d
;

1410 ià(!
	`¿xS“kG»©e¡
(
™
))  0;

1411 
	`as£¹
(
™
->
node
->
iskey
);

1418 
¥l™pos
 = 0;

1419 
size_t
 
i
 = 
	`¿xLowW®k
(
™
->
¹
,
–e
,
Ën
,&™->
node
,
NULL
,&
¥l™pos
,&™->
¡ack
);

1422 ià(
™
->
¡ack
.
oom
)  0;

1424 ià(
eq
 && 
i
 =ğ
Ën
 && (!
™
->
node
->
iscom´
 || 
¥l™pos
 == 0) &&

1425 
™
->
node
->
iskey
)

1429 ià(!
	`¿xI‹¿tÜAddCh¬s
(
™
,
–e
,
Ën
))  0;

1430 } ià(
É
 || 
gt
) {

1436 ià(!
	`¿xSckPush
(&
™
->
¡ack
,™->
node
))  0;

1437 
size_t
 
j
 = 1; j < 
™
->
¡ack
.
™ems
; j++) {

1438 
¿xNode
 *
·»Á
 = 
™
->
¡ack
.¡ack[
j
-1];

1439 
¿xNode
 *
chd
 = 
™
->
¡ack
.¡ack[
j
];

1440 ià(
·»Á
->
iscom´
) {

1441 ià(!
	`¿xI‹¿tÜAddCh¬s
(
™
,
·»Á
->
d©a
,·»Á->
size
))

1444 
¿xNode
 **
ı
 = 
	`¿xNodeFœ¡ChdPŒ
(
·»Á
);

1445 *
p
 = 
·»Á
->
d©a
;

1447 
¿xNode
 *
aux
;

1448 
	`memıy
(&
aux
,
ı
,(aux));

1449 ià(
aux
 =ğ
chd
) ;

1450 
ı
++;

1451 
p
++;

1453 ià(!
	`¿xI‹¿tÜAddCh¬s
(
™
,
p
,1))  0;

1456 
	`¿xSckPİ
(&
™
->
¡ack
);

1460 
	`debugf
("After initial seek: i=%d†en=%d key=%.*s\n",

1461 ()
i
, ()
Ën
, ()
™
->
key_Ën
, it->
key
);

1462 ià(
i
 !ğ
Ën
 && !
™
->
node
->
iscom´
) {

1468 ià(!
	`¿xI‹¿tÜAddCh¬s
(
™
,
–e
+
i
,1))  0;

1469 
	`debugf
("Seek‚ormal‚ode on mismatch: %.*s\n",

1470 ()
™
->
key_Ën
, (*)™->
key
);

1472 
™
->
æags
 &ğ~
RAX_ITER_JUST_SEEKED
;

1473 ià(
É
 && !
	`¿xI‹¿tÜP»vS‹p
(
™
,1))  0;

1474 ià(
gt
 && !
	`¿xI‹¿tÜNextS‹p
(
™
,1))  0;

1475 
™
->
æags
 |ğ
RAX_ITER_JUST_SEEKED
;

1476 } ià(
i
 !ğ
Ën
 && 
™
->
node
->
iscom´
) {

1477 
	`debugf
("Compressed mismatch: %.*s\n",

1478 ()
™
->
key_Ën
, (*)™->
key
);

1480 
nodech¬
 = 
™
->
node
->
d©a
[
¥l™pos
];

1481 
keych¬
 = 
–e
[
i
];

1482 
™
->
æags
 &ğ~
RAX_ITER_JUST_SEEKED
;

1483 ià(
gt
) {

1487 ià(
nodech¬
 > 
keych¬
) {

1488 ià(!
	`¿xI‹¿tÜNextS‹p
(
™
,0))  0;

1490 ià(!
	`¿xI‹¿tÜAddCh¬s
(
™
,™->
node
->
d©a
,™->node->
size
))

1492 ià(!
	`¿xI‹¿tÜNextS‹p
(
™
,1))  0;

1495 ià(
É
) {

1500 ià(
nodech¬
 < 
keych¬
) {

1501 ià(!
	`¿xS“kG»©e¡
(
™
))  0;

1503 ià(!
	`¿xI‹¿tÜAddCh¬s
(
™
,™->
node
->
d©a
,™->node->
size
))

1505 ià(!
	`¿xI‹¿tÜP»vS‹p
(
™
,1))  0;

1508 
™
->
æags
 |ğ
RAX_ITER_JUST_SEEKED
;

1510 
	`debugf
("No mismatch: %.*s\n",

1511 ()
™
->
key_Ën
, (*)™->
key
);

1517 
™
->
æags
 &ğ~
RAX_ITER_JUST_SEEKED
;

1518 ià(
gt
 && !
	`¿xI‹¿tÜNextS‹p
(
™
,0))  0;

1519 ià(
É
 && !
	`¿xI‹¿tÜP»vS‹p
(
™
,0))  0;

1520 
™
->
æags
 |ğ
RAX_ITER_JUST_SEEKED
;

1524 
™
->
æags
 |ğ
RAX_ITER_EOF
;

1528 
	}
}

1533 
	$¿xNext
(
¿xI‹¿tÜ
 *
™
) {

1534 ià(!
	`¿xI‹¿tÜNextS‹p
(
™
,0)) {

1535 
”ºo
 = 
ENOMEM
;

1538 ià(
™
->
æags
 & 
RAX_ITER_EOF
) {

1539 
”ºo
 = 0;

1543 
	}
}

1548 
	$¿xP»v
(
¿xI‹¿tÜ
 *
™
) {

1549 ià(!
	`¿xI‹¿tÜP»vS‹p
(
™
,0)) {

1550 
”ºo
 = 
ENOMEM
;

1553 ià(
™
->
æags
 & 
RAX_ITER_EOF
) {

1554 
”ºo
 = 0;

1558 
	}
}

1572 
	$¿xRªdomW®k
(
¿xI‹¿tÜ
 *
™
, 
size_t
 
¡•s
) {

1573 ià(
™
->
¹
->
num–e
 == 0) {

1574 
™
->
æags
 |ğ
RAX_ITER_EOF
;

1578 ià(
¡•s
 == 0) {

1579 
size_t
 
æe
 = 
	`æoÜ
(
	`log
(
™
->
¹
->
num–e
));

1580 
æe
 *= 2;

1581 
¡•s
 = 1 + 
	`¿nd
(è% 
æe
;

1584 
¿xNode
 *
n
 = 
™
->
node
;

1585 
¡•s
 > 0 || !
n
->
iskey
) {

1586 
numchd»n
 = 
n
->
iscom´
 ? 1 :‚->
size
;

1587 
r
 = 
	`¿nd
(è% (
numchd»n
+(
n
 !ğ
™
->
¹
->
h—d
));

1589 ià(
r
 =ğ
numchd»n
) {

1591 
n
 = 
	`¿xSckPİ
(&
™
->
¡ack
);

1592 
tod–
 = 
n
->
iscom´
 ?‚->
size
 : 1;

1593 
	`¿xI‹¿tÜD–Ch¬s
(
™
,
tod–
);

1596 ià(
n
->
iscom´
) {

1597 ià(!
	`¿xI‹¿tÜAddCh¬s
(
™
,
n
->
d©a
,n->
size
))  0;

1599 ià(!
	`¿xI‹¿tÜAddCh¬s
(
™
,
n
->
d©a
+
r
,1))  0;

1601 
¿xNode
 **
ı
 = 
	`¿xNodeFœ¡ChdPŒ
(
n
)+
r
;

1602 ià(!
	`¿xSckPush
(&
™
->
¡ack
,
n
))  0;

1603 
	`memıy
(&
n
,
ı
,(n));

1605 ià(
n
->
iskey
è
¡•s
--;

1607 
™
->
node
 = 
n
;

1609 
	}
}

1614 
	$¿xCom·»
(
¿xI‹¿tÜ
 *
™”
, cÚ¡ *
İ
, *
key
, 
size_t
 
key_Ën
) {

1615 
eq
 = 0, 
É
 = 0, 
gt
 = 0;

1617 ià(
İ
[0] =ğ'=' || op[1] =ğ'='è
eq
 = 1;

1618 ià(
İ
[1] =ğ'>'è
gt
 = 1;

1619 ià(
İ
[1] =ğ'<'è
É
 = 1;

1620 ià(
İ
[1] != '=')  0;

1622 
size_t
 
mšËn
 = 
key_Ën
 < 
™”
->key_len ? key_len : iter->key_len;

1623 
cmp
 = 
	`memcmp
(
™”
->
key
,key,
mšËn
);

1626 ià(
É
 =ğ0 && 
gt
 =ğ0è 
cmp
 =ğ0 && 
key_Ën
 =ğ
™”
->key_len;

1629 ià(
cmp
 == 0) {

1631 ià(
eq
 && 
key_Ën
 =ğ
™”
->key_len)  1;

1632 ià(
É
è 
™”
->
key_Ën
 < key_len;

1633 ià(
gt
è 
™”
->
key_Ën
 > key_len;

1634 } ià(
cmp
 > 0) {

1635  
gt
 ? 1 : 0;

1637  
É
 ? 1 : 0;

1639 
	}
}

1642 
	$¿xStİ
(
¿xI‹¿tÜ
 *
™
) {

1643 ià(
™
->
key
 !ğ™->
key_¡©ic_¡ršg
è
	`¿x_ä“
(it->key);

1644 
	`¿xSckF»e
(&
™
->
¡ack
);

1645 
	}
}

1675 
	$¿xRecursiveShow
(
Ëv–
, 
Íad
, 
¿xNode
 *
n
) {

1676 
s
 = 
n
->
iscom´
 ? '"' : '[';

1677 
e
 = 
n
->
iscom´
 ? '"' : ']';

1679 
numch¬s
 = 
	`´štf
("%c%.*s%c", 
s
, 
n
->
size
,‚->
d©a
, 
e
);

1680 ià(
n
->
iskey
) {

1681 
numch¬s
 +ğ
	`´štf
("=%p",
	`¿xG‘D©a
(
n
));

1684 
numchd»n
 = 
n
->
iscom´
 ? 1 :‚->
size
;

1687 ià(
Ëv–
) {

1688 
Íad
 +ğ(
numchd»n
 > 1) ? 7 : 4;

1689 ià(
numchd»n
 =ğ1è
Íad
 +ğ
numch¬s
;

1691 
¿xNode
 **
ı
 = 
	`¿xNodeFœ¡ChdPŒ
(
n
);

1692 
i
 = 0; i < 
numchd»n
; i++) {

1693 *
b¿nch
 = " `-(%c) ";

1694 ià(
numchd»n
 > 1) {

1695 
	`´štf
("\n");

1696 
j
 = 0; j < 
Íad
; j++è
	`putch¬
(' ');

1697 
	`´štf
(
b¿nch
,
n
->
d©a
[
i
]);

1699 
	`´štf
(" -> ");

1701 
¿xNode
 *
chd
;

1702 
	`memıy
(&
chd
,
ı
,(child));

1703 
	`¿xRecursiveShow
(
Ëv–
+1,
Íad
,
chd
);

1704 
ı
++;

1706 
	}
}

1709 
	$¿xShow
(
¿x
 *rax) {

1710 
	`¿xRecursiveShow
(0,0,
¿x
->
h—d
);

1711 
	`putch¬
('\n');

1712 
	}
}

1715 
	$¿xDebugShowNode
(cÚ¡ *
msg
, 
¿xNode
 *
n
) {

1716 
	`´štf
("%s: %p [%.*s] key:%d size:%d children:",

1717 
msg
, (*)
n
, (ê->
size
, (*ê->
d©a
,‚->
iskey
,‚->size);

1718 
numşd
 = 
n
->
iscom´
 ? 1 :‚->
size
;

1719 
¿xNode
 **
şd±r
 = 
	`¿xNodeLa¡ChdPŒ
(
n
è- (
numşd
-1);

1720 
numşd
--) {

1721 
¿xNode
 *
chd
;

1722 
	`memıy
(&
chd
,
şd±r
,(child));

1723 
şd±r
++;

1724 
	`´štf
("%°", (*)
chd
);

1726 
	`´štf
("\n");

1727 
	`fæush
(
¡dout
);

1728 
	}
}

	@rax.h

1 #iâdeà
RAX_H


2 
	#RAX_H


	)

4 
	~<¡dšt.h
>

67 
	#RAX_NODE_MAX_SIZE
 ((1<<29)-1)

	)

68 
	s¿xNode
 {

69 
ušt32_t
 
	miskey
:1;

70 
ušt32_t
 
	mi¢uÎ
:1;

71 
ušt32_t
 
	miscom´
:1;

72 
ušt32_t
 
	msize
:29;

100 
	md©a
[];

101 } 
	t¿xNode
;

103 
	s¿x
 {

104 
¿xNode
 *
	mh—d
;

105 
ušt64_t
 
	mnum–e
;

106 
ušt64_t
 
	mnumnodes
;

107 } 
	t¿x
;

112 
	#RAX_STACK_STATIC_ITEMS
 32

	)

113 
	s¿xSck
 {

114 **
	m¡ack
;

115 
size_t
 
	m™ems
, 
	mmax™ems
;

118 *
	m¡©ic_™ems
[
RAX_STACK_STATIC_ITEMS
];

119 
	moom
;

120 } 
	t¿xSck
;

123 
	#RAX_ITER_STATIC_LEN
 128

	)

124 
	#RAX_ITER_JUST_SEEKED
 (1<<0è

	)

127 
	#RAX_ITER_EOF
 (1<<1è

	)

128 
	#RAX_ITER_SAFE
 (1<<2è

	)

130 
	s¿xI‹¿tÜ
 {

131 
	mæags
;

132 
¿x
 *
	m¹
;

133 *
	mkey
;

134 *
	md©a
;

135 
size_t
 
	mkey_Ën
;

136 
size_t
 
	mkey_max
;

137 
	mkey_¡©ic_¡ršg
[
RAX_ITER_STATIC_LEN
];

138 
¿xNode
 *
	mnode
;

139 
¿xSck
 
	m¡ack
;

140 } 
	t¿xI‹¿tÜ
;

143 *
¿xNÙFound
;

146 
¿x
 *
¿xNew
();

147 
¿xIn£¹
(
¿x
 *¿x, *
s
, 
size_t
 
Ën
, *
d©a
, **
Şd
);

148 
¿xRemove
(
¿x
 *¿x, *
s
, 
size_t
 
Ën
, **
Şd
);

149 *
¿xFšd
(
¿x
 *¿x, *
s
, 
size_t
 
Ën
);

150 
¿xF»e
(
¿x
 *rax);

151 
¿xS¹
(
¿xI‹¿tÜ
 *
™
, 
¿x
 *
¹
);

152 
¿xS“k
(
¿xI‹¿tÜ
 *
™
, cÚ¡ *
İ
, *
–e
, 
size_t
 
Ën
);

153 
¿xNext
(
¿xI‹¿tÜ
 *
™
);

154 
¿xP»v
(
¿xI‹¿tÜ
 *
™
);

155 
¿xRªdomW®k
(
¿xI‹¿tÜ
 *
™
, 
size_t
 
¡•s
);

156 
¿xCom·»
(
¿xI‹¿tÜ
 *
™”
, cÚ¡ *
İ
, *
key
, 
size_t
 
key_Ën
);

157 
¿xStİ
(
¿xI‹¿tÜ
 *
™
);

158 
¿xShow
(
¿x
 *rax);

	@rax_malloc.h

38 #iâdeà
RAX_ALLOC_H


39 
	#RAX_ALLOC_H


	)

40 
	~"zm®loc.h
"

41 
	#¿x_m®loc
 
zm®loc


	)

42 
	#¿x_»®loc
 
z»®loc


	)

43 
	#¿x_ä“
 
zä“


	)

	@rdb.c

30 
	~"£rv”.h
"

31 
	~"lzf.h
"

32 
	~"zm­.h
"

33 
	~"’dŸncÚv.h
"

35 
	~<m©h.h
>

36 
	~<sys/ty³s.h
>

37 
	~<sys/time.h
>

38 
	~<sys/»sourû.h
>

39 
	~<sys/wa™.h
>

40 
	~<¬·/š‘.h
>

41 
	~<sys/¡©.h
>

42 
	~<sys/·¿m.h
>

44 
	#rdbEx™R•ÜtCÜru±RDB
(...è
	`rdbCheckTh’Ex™
(
__LINE__
,
__VA_ARGS__
)

	)

46 
rdbCheckMode
;

47 
rdbCheckE¼Ü
(cÚ¡ *
fmt
, ...);

48 
rdbCheckS‘E¼Ü
(cÚ¡ *
fmt
, ...);

50 
	$rdbCheckTh’Ex™
(
lš’um
, *
»asÚ
, ...) {

51 
va_li¡
 
­
;

52 
msg
[1024];

53 
Ën
;

55 
Ën
 = 
	`¢´štf
(
msg
,(msg),

56 "IÁ”ÇÈ”rÜ iÀRDB„—dšg funùiÚ‡ˆrdb.c:%d -> ", 
lš’um
);

57 
	`va_¡¬t
(
­
,
»asÚ
);

58 
	`v¢´štf
(
msg
+
Ën
,(msg)-Ën,
»asÚ
,
­
);

59 
	`va_’d
(
­
);

61 ià(!
rdbCheckMode
) {

62 
	`£rv”Log
(
LL_WARNING
, "%s", 
msg
);

63 *
¬gv
[2] = {"",
£rv”
.
rdb_f’ame
};

64 
	`»dis_check_rdb_maš
(2,
¬gv
,
NULL
);

66 
	`rdbCheckE¼Ü
("%s",
msg
);

68 
	`ex™
(1);

69 
	}
}

71 
	$rdbWr™eRaw
(
rio
 *
rdb
, *
p
, 
size_t
 
Ën
) {

72 ià(
rdb
 && 
	`rioWr™e
Ôdb,
p
,
Ën
) == 0)

74  
Ën
;

75 
	}
}

77 
	$rdbSaveTy³
(
rio
 *
rdb
, 
ty³
) {

78  
	`rdbWr™eRaw
(
rdb
,&
ty³
,1);

79 
	}
}

84 
	$rdbLßdTy³
(
rio
 *
rdb
) {

85 
ty³
;

86 ià(
	`rioR—d
(
rdb
,&
ty³
,1) == 0)  -1;

87  
ty³
;

88 
	}
}

90 
time_t
 
	$rdbLßdTime
(
rio
 *
rdb
) {

91 
št32_t
 
t32
;

92 ià(
	`rioR—d
(
rdb
,&
t32
,4) == 0)  -1;

93  (
time_t
)
t32
;

94 
	}
}

96 
	$rdbSaveMli£cÚdTime
(
rio
 *
rdb
, 
t
) {

97 
št64_t
 
t64
 = (št64_tè
t
;

98  
	`rdbWr™eRaw
(
rdb
,&
t64
,8);

99 
	}
}

101 
	$rdbLßdMli£cÚdTime
(
rio
 *
rdb
) {

102 
št64_t
 
t64
;

103 ià(
	`rioR—d
(
rdb
,&
t64
,8) == 0)  -1;

104  ()
t64
;

105 
	}
}

110 
	$rdbSaveL’
(
rio
 *
rdb
, 
ušt64_t
 
Ën
) {

111 
buf
[2];

112 
size_t
 
nwr™‹n
;

114 ià(
Ën
 < (1<<6)) {

116 
buf
[0] = (
Ën
&0xFF)|(
RDB_6BITLEN
<<6);

117 ià(
	`rdbWr™eRaw
(
rdb
,
buf
,1) == -1)  -1;

118 
nwr™‹n
 = 1;

119 } ià(
Ën
 < (1<<14)) {

121 
buf
[0] = ((
Ën
>>8)&0xFF)|(
RDB_14BITLEN
<<6);

122 
buf
[1] = 
Ën
&0xFF;

123 ià(
	`rdbWr™eRaw
(
rdb
,
buf
,2) == -1)  -1;

124 
nwr™‹n
 = 2;

125 } ià(
Ën
 <ğ
UINT32_MAX
) {

127 
buf
[0] = 
RDB_32BITLEN
;

128 ià(
	`rdbWr™eRaw
(
rdb
,
buf
,1) == -1)  -1;

129 
ušt32_t
 
Ën32
 = 
	`htÚl
(
Ën
);

130 ià(
	`rdbWr™eRaw
(
rdb
,&
Ën32
,4) == -1)  -1;

131 
nwr™‹n
 = 1+4;

134 
buf
[0] = 
RDB_64BITLEN
;

135 ià(
	`rdbWr™eRaw
(
rdb
,
buf
,1) == -1)  -1;

136 
Ën
 = 
	`htÚu64
(len);

137 ià(
	`rdbWr™eRaw
(
rdb
,&
Ën
,8) == -1)  -1;

138 
nwr™‹n
 = 1+8;

140  
nwr™‹n
;

141 
	}
}

153 
	$rdbLßdL’ByRef
(
rio
 *
rdb
, *
i£ncoded
, 
ušt64_t
 *
ËÅŒ
) {

154 
buf
[2];

155 
ty³
;

157 ià(
i£ncoded
) *isencoded = 0;

158 ià(
	`rioR—d
(
rdb
,
buf
,1) == 0)  -1;

159 
ty³
 = (
buf
[0]&0xC0)>>6;

160 ià(
ty³
 =ğ
RDB_ENCVAL
) {

162 ià(
i£ncoded
) *isencoded = 1;

163 *
ËÅŒ
 = 
buf
[0]&0x3F;

164 } ià(
ty³
 =ğ
RDB_6BITLEN
) {

166 *
ËÅŒ
 = 
buf
[0]&0x3F;

167 } ià(
ty³
 =ğ
RDB_14BITLEN
) {

169 ià(
	`rioR—d
(
rdb
,
buf
+1,1) == 0)  -1;

170 *
ËÅŒ
 = ((
buf
[0]&0x3F)<<8)|buf[1];

171 } ià(
buf
[0] =ğ
RDB_32BITLEN
) {

173 
ušt32_t
 
Ën
;

174 ià(
	`rioR—d
(
rdb
,&
Ën
,4) == 0)  -1;

175 *
ËÅŒ
 = 
	`Áohl
(
Ën
);

176 } ià(
buf
[0] =ğ
RDB_64BITLEN
) {

178 
ušt64_t
 
Ën
;

179 ià(
	`rioR—d
(
rdb
,&
Ën
,8) == 0)  -1;

180 *
ËÅŒ
 = 
	`Áohu64
(
Ën
);

182 
	`rdbEx™R•ÜtCÜru±RDB
(

183 "UnknowÀËngthƒncodšg %d iÀrdbLßdL’()",
ty³
);

187 
	}
}

193 
ušt64_t
 
	$rdbLßdL’
(
rio
 *
rdb
, *
i£ncoded
) {

194 
ušt64_t
 
Ën
;

196 ià(
	`rdbLßdL’ByRef
(
rdb
,
i£ncoded
,&
Ën
è=ğ-1è 
RDB_LENERR
;

197  
Ën
;

198 
	}
}

204 
	$rdbEncodeIÁeg”
(
v®ue
, *
’c
) {

205 ià(
v®ue
 >= -(1<<7) && value <= (1<<7)-1) {

206 
’c
[0] = (
RDB_ENCVAL
<<6)|
RDB_ENC_INT8
;

207 
’c
[1] = 
v®ue
&0xFF;

209 } ià(
v®ue
 >= -(1<<15) && value <= (1<<15)-1) {

210 
’c
[0] = (
RDB_ENCVAL
<<6)|
RDB_ENC_INT16
;

211 
’c
[1] = 
v®ue
&0xFF;

212 
’c
[2] = (
v®ue
>>8)&0xFF;

214 } ià(
v®ue
 >= -(()1<<31) && value <= (()1<<31)-1) {

215 
’c
[0] = (
RDB_ENCVAL
<<6)|
RDB_ENC_INT32
;

216 
’c
[1] = 
v®ue
&0xFF;

217 
’c
[2] = (
v®ue
>>8)&0xFF;

218 
’c
[3] = (
v®ue
>>16)&0xFF;

219 
’c
[4] = (
v®ue
>>24)&0xFF;

224 
	}
}

229 *
	$rdbLßdIÁeg”Objeù
(
rio
 *
rdb
, 
’ùy³
, 
æags
, 
size_t
 *
ËÅŒ
) {

230 
¶aš
 = 
æags
 & 
RDB_LOAD_PLAIN
;

231 
sds
 = 
æags
 & 
RDB_LOAD_SDS
;

232 
’code
 = 
æags
 & 
RDB_LOAD_ENC
;

233 
’c
[4];

234 
v®
;

236 ià(
’ùy³
 =ğ
RDB_ENC_INT8
) {

237 ià(
	`rioR—d
(
rdb
,
’c
,1è=ğ0è 
NULL
;

238 
v®
 = (sigÃd )
’c
[0];

239 } ià(
’ùy³
 =ğ
RDB_ENC_INT16
) {

240 
ušt16_t
 
v
;

241 ià(
	`rioR—d
(
rdb
,
’c
,2è=ğ0è 
NULL
;

242 
v
 = 
’c
[0]|(enc[1]<<8);

243 
v®
 = (
št16_t
)
v
;

244 } ià(
’ùy³
 =ğ
RDB_ENC_INT32
) {

245 
ušt32_t
 
v
;

246 ià(
	`rioR—d
(
rdb
,
’c
,4è=ğ0è 
NULL
;

247 
v
 = 
’c
[0]|(enc[1]<<8)|(enc[2]<<16)|(enc[3]<<24);

248 
v®
 = (
št32_t
)
v
;

250 
v®
 = 0;

251 
	`rdbEx™R•ÜtCÜru±RDB
("UnknowÀRDB iÁeg”ƒncodšgy³ %d",
’ùy³
);

253 ià(
¶aš
 || 
sds
) {

254 
buf
[
LONG_STR_SIZE
], *
p
;

255 
Ën
 = 
	`Î2¡ršg
(
buf
,(buf),
v®
);

256 ià(
ËÅŒ
è*ËÅŒ = 
Ën
;

257 
p
 = 
¶aš
 ? 
	`zm®loc
(
Ën
è: 
	`sd¢ewËn
(
NULL
,len);

258 
	`memıy
(
p
,
buf
,
Ën
);

259  
p
;

260 } ià(
’code
) {

261  
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
v®
);

263  
	`ü—‹Objeù
(
OBJ_STRING
,
	`sdsäomlÚglÚg
(
v®
));

265 
	}
}

270 
	$rdbTryIÁeg”Encodšg
(*
s
, 
size_t
 
Ën
, *
’c
) {

271 
v®ue
;

272 *
’d±r
, 
buf
[32];

275 
v®ue
 = 
	`¡¹Şl
(
s
, &
’d±r
, 10);

276 ià(
’d±r
[0] != '\0')  0;

277 
	`Î2¡ršg
(
buf
,32,
v®ue
);

281 ià(
	`¡¾’
(
buf
è!ğ
Ën
 || 
	`memcmp
(buf,
s
,len))  0;

283  
	`rdbEncodeIÁeg”
(
v®ue
,
’c
);

284 
	}
}

286 
ssize_t
 
	$rdbSaveLzfBlob
(
rio
 *
rdb
, *
d©a
, 
size_t
 
com´ess_Ën
,

287 
size_t
 
Üigš®_Ën
) {

288 
by‹
;

289 
ssize_t
 
n
, 
nwr™‹n
 = 0;

292 
by‹
 = (
RDB_ENCVAL
<<6)|
RDB_ENC_LZF
;

293 ià((
n
 = 
	`rdbWr™eRaw
(
rdb
,&
by‹
,1)è=ğ-1è
wr™“¼
;

294 
nwr™‹n
 +ğ
n
;

296 ià((
n
 = 
	`rdbSaveL’
(
rdb
,
com´ess_Ën
)è=ğ-1è
wr™“¼
;

297 
nwr™‹n
 +ğ
n
;

299 ià((
n
 = 
	`rdbSaveL’
(
rdb
,
Üigš®_Ën
)è=ğ-1è
wr™“¼
;

300 
nwr™‹n
 +ğ
n
;

302 ià((
n
 = 
	`rdbWr™eRaw
(
rdb
,
d©a
,
com´ess_Ën
)è=ğ-1è
wr™“¼
;

303 
nwr™‹n
 +ğ
n
;

305  
nwr™‹n
;

307 
wr™“¼
:

309 
	}
}

311 
ssize_t
 
	$rdbSaveLzfSŒšgObjeù
(
rio
 *
rdb
, *
s
, 
size_t
 
Ën
) {

312 
size_t
 
com´Ën
, 
ou’
;

313 *
out
;

316 ià(
Ën
 <= 4)  0;

317 
ou’
 = 
Ën
-4;

318 ià((
out
 = 
	`zm®loc
(
ou’
+1)è=ğ
NULL
)  0;

319 
com´Ën
 = 
	`lzf_com´ess
(
s
, 
Ën
, 
out
, 
ou’
);

320 ià(
com´Ën
 == 0) {

321 
	`zä“
(
out
);

324 
ssize_t
 
nwr™‹n
 = 
	`rdbSaveLzfBlob
(
rdb
, 
out
, 
com´Ën
, 
Ën
);

325 
	`zä“
(
out
);

326  
nwr™‹n
;

327 
	}
}

332 *
	$rdbLßdLzfSŒšgObjeù
(
rio
 *
rdb
, 
æags
, 
size_t
 *
ËÅŒ
) {

333 
¶aš
 = 
æags
 & 
RDB_LOAD_PLAIN
;

334 
sds
 = 
æags
 & 
RDB_LOAD_SDS
;

335 
ušt64_t
 
Ën
, 
ş’
;

336 *
c
 = 
NULL
;

337 *
v®
 = 
NULL
;

339 ià((
ş’
 = 
	`rdbLßdL’
(
rdb
,
NULL
)è=ğ
RDB_LENERR
)  NULL;

340 ià((
Ën
 = 
	`rdbLßdL’
(
rdb
,
NULL
)è=ğ
RDB_LENERR
)  NULL;

341 ià((
c
 = 
	`zm®loc
(
ş’
)è=ğ
NULL
è
”r
;

344 ià(
¶aš
) {

345 
v®
 = 
	`zm®loc
(
Ën
);

346 ià(
ËÅŒ
è*ËÅŒ = 
Ën
;

348 
v®
 = 
	`sd¢ewËn
(
NULL
,
Ën
);

352 ià(
	`rioR—d
(
rdb
,
c
,
ş’
è=ğ0è
”r
;

353 ià(
	`lzf_decom´ess
(
c
,
ş’
,
v®
,
Ën
) == 0) {

354 ià(
rdbCheckMode
è
	`rdbCheckS‘E¼Ü
("Invalid LZF compressed string");

355 
”r
;

357 
	`zä“
(
c
);

359 ià(
¶aš
 || 
sds
) {

360  
v®
;

362  
	`ü—‹Objeù
(
OBJ_STRING
,
v®
);

364 
”r
:

365 
	`zä“
(
c
);

366 ià(
¶aš
)

367 
	`zä“
(
v®
);

369 
	`sdsä“
(
v®
);

370  
NULL
;

371 
	}
}

375 
ssize_t
 
	$rdbSaveRawSŒšg
(
rio
 *
rdb
, *
s
, 
size_t
 
Ën
) {

376 
’ş’
;

377 
ssize_t
 
n
, 
nwr™‹n
 = 0;

380 ià(
Ën
 <= 11) {

381 
buf
[5];

382 ià((
’ş’
 = 
	`rdbTryIÁeg”Encodšg
((*)
s
,
Ën
,
buf
)) > 0) {

383 ià(
	`rdbWr™eRaw
(
rdb
,
buf
,
’ş’
) == -1)  -1;

384  
’ş’
;

390 ià(
£rv”
.
rdb_com´essiÚ
 && 
Ën
 > 20) {

391 
n
 = 
	`rdbSaveLzfSŒšgObjeù
(
rdb
,
s
,
Ën
);

392 ià(
n
 == -1)  -1;

393 ià(
n
 > 0) ‚;

398 ià((
n
 = 
	`rdbSaveL’
(
rdb
,
Ën
)) == -1)  -1;

399 
nwr™‹n
 +ğ
n
;

400 ià(
Ën
 > 0) {

401 ià(
	`rdbWr™eRaw
(
rdb
,
s
,
Ën
) == -1)  -1;

402 
nwr™‹n
 +ğ
Ën
;

404  
nwr™‹n
;

405 
	}
}

408 
ssize_t
 
	$rdbSaveLÚgLÚgAsSŒšgObjeù
(
rio
 *
rdb
, 
v®ue
) {

409 
buf
[32];

410 
ssize_t
 
n
, 
nwr™‹n
 = 0;

411 
’ş’
 = 
	`rdbEncodeIÁeg”
(
v®ue
,
buf
);

412 ià(
’ş’
 > 0) {

413  
	`rdbWr™eRaw
(
rdb
,
buf
,
’ş’
);

416 
’ş’
 = 
	`Î2¡ršg
((*)
buf
,32,
v®ue
);

417 
	`£rv”As£¹
(
’ş’
 < 32);

418 ià((
n
 = 
	`rdbSaveL’
(
rdb
,
’ş’
)) == -1)  -1;

419 
nwr™‹n
 +ğ
n
;

420 ià((
n
 = 
	`rdbWr™eRaw
(
rdb
,
buf
,
’ş’
)) == -1)  -1;

421 
nwr™‹n
 +ğ
n
;

423  
nwr™‹n
;

424 
	}
}

427 
	$rdbSaveSŒšgObjeù
(
rio
 *
rdb
, 
robj
 *
obj
) {

430 ià(
obj
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

431  
	`rdbSaveLÚgLÚgAsSŒšgObjeù
(
rdb
,()
obj
->
±r
);

433 
	`£rv”As£¹W™hInfo
(
NULL
,
obj
,
	`sdsEncodedObjeù
(obj));

434  
	`rdbSaveRawSŒšg
(
rdb
,
obj
->
±r
,
	`sd¦’
(obj->ptr));

436 
	}
}

451 *
	$rdbG’”icLßdSŒšgObjeù
(
rio
 *
rdb
, 
æags
, 
size_t
 *
ËÅŒ
) {

452 
’code
 = 
æags
 & 
RDB_LOAD_ENC
;

453 
¶aš
 = 
æags
 & 
RDB_LOAD_PLAIN
;

454 
sds
 = 
æags
 & 
RDB_LOAD_SDS
;

455 
i£ncoded
;

456 
ušt64_t
 
Ën
;

458 
Ën
 = 
	`rdbLßdL’
(
rdb
,&
i£ncoded
);

459 ià(
i£ncoded
) {

460 
Ën
) {

461 
RDB_ENC_INT8
:

462 
RDB_ENC_INT16
:

463 
RDB_ENC_INT32
:

464  
	`rdbLßdIÁeg”Objeù
(
rdb
,
Ën
,
æags
,
ËÅŒ
);

465 
RDB_ENC_LZF
:

466  
	`rdbLßdLzfSŒšgObjeù
(
rdb
,
æags
,
ËÅŒ
);

468 
	`rdbEx™R•ÜtCÜru±RDB
("UnknowÀRDB sŒšgƒncodšgy³ %d",
Ën
);

472 ià(
Ën
 =ğ
RDB_LENERR
è 
NULL
;

473 ià(
¶aš
 || 
sds
) {

474 *
buf
 = 
¶aš
 ? 
	`zm®loc
(
Ën
è: 
	`sd¢ewËn
(
NULL
,len);

475 ià(
ËÅŒ
è*ËÅŒ = 
Ën
;

476 ià(
Ën
 && 
	`rioR—d
(
rdb
,
buf
,len) == 0) {

477 ià(
¶aš
)

478 
	`zä“
(
buf
);

480 
	`sdsä“
(
buf
);

481  
NULL
;

483  
buf
;

485 
robj
 *
o
 = 
’code
 ? 
	`ü—‹SŒšgObjeù
(
NULL
,
Ën
) :

486 
	`ü—‹RawSŒšgObjeù
(
NULL
,
Ën
);

487 ià(
Ën
 && 
	`rioR—d
(
rdb
,
o
->
±r
,len) == 0) {

488 
	`deüRefCouÁ
(
o
);

489  
NULL
;

491  
o
;

493 
	}
}

495 
robj
 *
	$rdbLßdSŒšgObjeù
(
rio
 *
rdb
) {

496  
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,
RDB_LOAD_NONE
,
NULL
);

497 
	}
}

499 
robj
 *
	$rdbLßdEncodedSŒšgObjeù
(
rio
 *
rdb
) {

500  
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,
RDB_LOAD_ENC
,
NULL
);

501 
	}
}

511 
	$rdbSaveDoubËV®ue
(
rio
 *
rdb
, 
v®
) {

512 
buf
[128];

513 
Ën
;

515 ià(
	`i¢ª
(
v®
)) {

516 
buf
[0] = 253;

517 
Ën
 = 1;

518 } ià(!
	`isfš™e
(
v®
)) {

519 
Ën
 = 1;

520 
buf
[0] = (
v®
 < 0) ? 255 : 254;

522 #ià(
DBL_MANT_DIG
 >ğ52è&& (
LLONG_MAX
 == 0x7fffffffffffffffLL)

532 
mš
 = -4503599627370495;

533 
max
 = 4503599627370496;

534 ià(
v®
 > 
mš
 && v® < 
max
 && val == (()(()val)))

535 
	`Î2¡ršg
((*)
buf
+1,(buf)-1,()
v®
);

538 
	`¢´štf
((*)
buf
+1,(buf)-1,"%.17g",
v®
);

539 
buf
[0] = 
	`¡¾’
((*)buf+1);

540 
Ën
 = 
buf
[0]+1;

542  
	`rdbWr™eRaw
(
rdb
,
buf
,
Ën
);

543 
	}
}

546 
	$rdbLßdDoubËV®ue
(
rio
 *
rdb
, *
v®
) {

547 
buf
[256];

548 
Ën
;

550 ià(
	`rioR—d
(
rdb
,&
Ën
,1) == 0)  -1;

551 
Ën
) {

552 255: *
v®
 = 
R_NegInf
;  0;

553 254: *
v®
 = 
R_PosInf
;  0;

554 253: *
v®
 = 
R_Nª
;  0;

556 ià(
	`rioR—d
(
rdb
,
buf
,
Ën
) == 0)  -1;

557 
buf
[
Ën
] = '\0';

558 
	`ssÿnf
(
buf
, "%lg", 
v®
);

561 
	}
}

568 
	$rdbSaveBš¬yDoubËV®ue
(
rio
 *
rdb
, 
v®
) {

569 
	`mem»v64ifbe
(&
v®
);

570  
	`rdbWr™eRaw
(
rdb
,&
v®
,(val));

571 
	}
}

575 
	$rdbLßdBš¬yDoubËV®ue
(
rio
 *
rdb
, *
v®
) {

576 ià(
	`rioR—d
(
rdb
,
v®
,(*val)) == 0)  -1;

577 
	`mem»v64ifbe
(
v®
);

579 
	}
}

582 
	$rdbSaveBš¬yFlßtV®ue
(
rio
 *
rdb
, 
v®
) {

583 
	`mem»v32ifbe
(&
v®
);

584  
	`rdbWr™eRaw
(
rdb
,&
v®
,(val));

585 
	}
}

588 
	$rdbLßdBš¬yFlßtV®ue
(
rio
 *
rdb
, *
v®
) {

589 ià(
	`rioR—d
(
rdb
,
v®
,(*val)) == 0)  -1;

590 
	`mem»v32ifbe
(
v®
);

592 
	}
}

595 
	$rdbSaveObjeùTy³
(
rio
 *
rdb
, 
robj
 *
o
) {

596 
o
->
ty³
) {

597 
OBJ_STRING
:

598  
	`rdbSaveTy³
(
rdb
,
RDB_TYPE_STRING
);

599 
OBJ_LIST
:

600 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
)

601  
	`rdbSaveTy³
(
rdb
,
RDB_TYPE_LIST_QUICKLIST
);

603 
	`£rv”Pªic
("Unknown†istƒncoding");

604 
OBJ_SET
:

605 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

606  
	`rdbSaveTy³
(
rdb
,
RDB_TYPE_SET_INTSET
);

607 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
)

608  
	`rdbSaveTy³
(
rdb
,
RDB_TYPE_SET
);

610 
	`£rv”Pªic
("Unknown setƒncoding");

611 
OBJ_ZSET
:

612 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
)

613  
	`rdbSaveTy³
(
rdb
,
RDB_TYPE_ZSET_ZIPLIST
);

614 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
)

615  
	`rdbSaveTy³
(
rdb
,
RDB_TYPE_ZSET_2
);

617 
	`£rv”Pªic
("Unknown sorted setƒncoding");

618 
OBJ_HASH
:

619 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
)

620  
	`rdbSaveTy³
(
rdb
,
RDB_TYPE_HASH_ZIPLIST
);

621 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
)

622  
	`rdbSaveTy³
(
rdb
,
RDB_TYPE_HASH
);

624 
	`£rv”Pªic
("Unknown hashƒncoding");

625 
OBJ_MODULE
:

626  
	`rdbSaveTy³
(
rdb
,
RDB_TYPE_MODULE_2
);

628 
	`£rv”Pªic
("Unknown objectype");

631 
	}
}

635 
	$rdbLßdObjeùTy³
(
rio
 *
rdb
) {

636 
ty³
;

637 ià((
ty³
 = 
	`rdbLßdTy³
(
rdb
)) == -1)  -1;

638 ià(!
	`rdbIsObjeùTy³
(
ty³
))  -1;

639  
ty³
;

640 
	}
}

643 
ssize_t
 
	$rdbSaveObjeù
(
rio
 *
rdb
, 
robj
 *
o
) {

644 
ssize_t
 
n
 = 0, 
nwr™‹n
 = 0;

646 ià(
o
->
ty³
 =ğ
OBJ_STRING
) {

648 ià((
n
 = 
	`rdbSaveSŒšgObjeù
(
rdb
,
o
)) == -1)  -1;

649 
nwr™‹n
 +ğ
n
;

650 } ià(
o
->
ty³
 =ğ
OBJ_LIST
) {

652 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

653 
quickli¡
 *
ql
 = 
o
->
±r
;

654 
quickli¡Node
 *
node
 = 
ql
->
h—d
;

656 ià((
n
 = 
	`rdbSaveL’
(
rdb
,
ql
->
Ën
)) == -1)  -1;

657 
nwr™‹n
 +ğ
n
;

660 ià(
	`quickli¡NodeIsCom´es£d
(
node
)) {

661 *
d©a
;

662 
size_t
 
com´ess_Ën
 = 
	`quickli¡G‘Lzf
(
node
, &
d©a
);

663 ià((
n
 = 
	`rdbSaveLzfBlob
(
rdb
,
d©a
,
com´ess_Ën
,
node
->
sz
)) == -1)  -1;

664 
nwr™‹n
 +ğ
n
;

666 ià((
n
 = 
	`rdbSaveRawSŒšg
(
rdb
,
node
->
zl
,node->
sz
)) == -1)  -1;

667 
nwr™‹n
 +ğ
n
;

669 } (
node
 =‚ode->
Ãxt
));

671 
	`£rv”Pªic
("Unknown†istƒncoding");

673 } ià(
o
->
ty³
 =ğ
OBJ_SET
) {

675 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

676 
diù
 *
£t
 = 
o
->
±r
;

677 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
£t
);

678 
diùEÁry
 *
de
;

680 ià((
n
 = 
	`rdbSaveL’
(
rdb
,
	`diùSize
(
£t
))) == -1)  -1;

681 
nwr™‹n
 +ğ
n
;

683 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

684 
sds
 
–e
 = 
	`diùG‘Key
(
de
);

685 ià((
n
 = 
	`rdbSaveRawSŒšg
(
rdb
,(*)
–e
,
	`sd¦’
(ele)))

687 
nwr™‹n
 +ğ
n
;

689 
	`diùR–—£I‹¿tÜ
(
di
);

690 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

691 
size_t
 
l
 = 
	`št£tBlobL’
((
št£t
*)
o
->
±r
);

693 ià((
n
 = 
	`rdbSaveRawSŒšg
(
rdb
,
o
->
±r
,
l
)) == -1)  -1;

694 
nwr™‹n
 +ğ
n
;

696 
	`£rv”Pªic
("Unknown setƒncoding");

698 } ià(
o
->
ty³
 =ğ
OBJ_ZSET
) {

700 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

701 
size_t
 
l
 = 
	`zli¡BlobL’
((*)
o
->
±r
);

703 ià((
n
 = 
	`rdbSaveRawSŒšg
(
rdb
,
o
->
±r
,
l
)) == -1)  -1;

704 
nwr™‹n
 +ğ
n
;

705 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

706 
z£t
 *
zs
 = 
o
->
±r
;

707 
zskli¡
 *
z¦
 = 
zs
->zsl;

709 ià((
n
 = 
	`rdbSaveL’
(
rdb
,
z¦
->
Ëngth
)) == -1)  -1;

710 
nwr™‹n
 +ğ
n
;

718 
zskli¡Node
 *
zn
 = 
z¦
->

;

719 
zn
 !ğ
NULL
) {

720 ià((
n
 = 
	`rdbSaveRawSŒšg
(
rdb
,

721 (*)
zn
->
–e
,
	`sd¦’
(zn->ele))) == -1)

725 
nwr™‹n
 +ğ
n
;

726 ià((
n
 = 
	`rdbSaveBš¬yDoubËV®ue
(
rdb
,
zn
->
scÜe
)) == -1)

728 
nwr™‹n
 +ğ
n
;

729 
zn
 = zn->
backw¬d
;

732 
	`£rv”Pªic
("Unknown sorted setƒncoding");

734 } ià(
o
->
ty³
 =ğ
OBJ_HASH
) {

736 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

737 
size_t
 
l
 = 
	`zli¡BlobL’
((*)
o
->
±r
);

739 ià((
n
 = 
	`rdbSaveRawSŒšg
(
rdb
,
o
->
±r
,
l
)) == -1)  -1;

740 
nwr™‹n
 +ğ
n
;

742 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

743 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
o
->
±r
);

744 
diùEÁry
 *
de
;

746 ià((
n
 = 
	`rdbSaveL’
(
rdb
,
	`diùSize
((
diù
*)
o
->
±r
))) == -1)  -1;

747 
nwr™‹n
 +ğ
n
;

749 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

750 
sds
 
f›ld
 = 
	`diùG‘Key
(
de
);

751 
sds
 
v®ue
 = 
	`diùG‘V®
(
de
);

753 ià((
n
 = 
	`rdbSaveRawSŒšg
(
rdb
,(*)
f›ld
,

754 
	`sd¦’
(
f›ld
))) == -1)  -1;

755 
nwr™‹n
 +ğ
n
;

756 ià((
n
 = 
	`rdbSaveRawSŒšg
(
rdb
,(*)
v®ue
,

757 
	`sd¦’
(
v®ue
))) == -1)  -1;

758 
nwr™‹n
 +ğ
n
;

760 
	`diùR–—£I‹¿tÜ
(
di
);

762 
	`£rv”Pªic
("Unknown hashƒncoding");

765 } ià(
o
->
ty³
 =ğ
OBJ_MODULE
) {

767 
RedisModuËIO
 
io
;

768 
moduËV®ue
 *
mv
 = 
o
->
±r
;

769 
moduËTy³
 *
mt
 = 
mv
->
ty³
;

770 
	`moduËIn™IOCÚ‹xt
(
io
,
mt
,
rdb
);

774 
»tv®
 = 
	`rdbSaveL’
(
rdb
,
mt
->
id
);

775 ià(
»tv®
 == -1)  -1;

776 
io
.
by‹s
 +ğ
»tv®
;

779 
mt
->
	`rdb_§ve
(&
io
,
mv
->
v®ue
);

780 
»tv®
 = 
	`rdbSaveL’
(
rdb
,
RDB_MODULE_OPCODE_EOF
);

781 ià(
»tv®
 == -1)  -1;

782 
io
.
by‹s
 +ğ
»tv®
;

784 ià(
io
.
ùx
) {

785 
	`moduËF»eCÚ‹xt
(
io
.
ùx
);

786 
	`zä“
(
io
.
ùx
);

788  
io
.
”rÜ
 ? -1 : (
ssize_t
)io.
by‹s
;

790 
	`£rv”Pªic
("Unknown objectype");

792  
nwr™‹n
;

793 
	}
}

799 
size_t
 
	$rdbSavedObjeùL’
(
robj
 *
o
) {

800 
ssize_t
 
Ën
 = 
	`rdbSaveObjeù
(
NULL
,
o
);

801 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,
Ën
 != -1);

802  
Ën
;

803 
	}
}

809 
	$rdbSaveKeyV®uePaœ
(
rio
 *
rdb
, 
robj
 *
key
,„obj *
v®
,

810 
expœ‘ime
, 
now
)

813 ià(
expœ‘ime
 != -1) {

815 ià(
expœ‘ime
 < 
now
)  0;

816 ià(
	`rdbSaveTy³
(
rdb
,
RDB_OPCODE_EXPIRETIME_MS
) == -1)  -1;

817 ià(
	`rdbSaveMli£cÚdTime
(
rdb
,
expœ‘ime
) == -1)  -1;

821 ià(
	`rdbSaveObjeùTy³
(
rdb
,
v®
) == -1)  -1;

822 ià(
	`rdbSaveSŒšgObjeù
(
rdb
,
key
) == -1)  -1;

823 ià(
	`rdbSaveObjeù
(
rdb
,
v®
) == -1)  -1;

825 
	}
}

828 
	$rdbSaveAuxF›ld
(
rio
 *
rdb
, *
key
, 
size_t
 
keyËn
, *
v®
, size_ˆ
v®Ën
) {

829 ià(
	`rdbSaveTy³
(
rdb
,
RDB_OPCODE_AUX
) == -1)  -1;

830 ià(
	`rdbSaveRawSŒšg
(
rdb
,
key
,
keyËn
) == -1)  -1;

831 ià(
	`rdbSaveRawSŒšg
(
rdb
,
v®
,
v®Ën
) == -1)  -1;

833 
	}
}

837 
	$rdbSaveAuxF›ldSŒSŒ
(
rio
 *
rdb
, *
key
, *
v®
) {

838  
	`rdbSaveAuxF›ld
(
rdb
,
key
,
	`¡¾’
(key),
v®
,strlen(val));

839 
	}
}

842 
	$rdbSaveAuxF›ldSŒIÁ
(
rio
 *
rdb
, *
key
, 
v®
) {

843 
buf
[
LONG_STR_SIZE
];

844 
vËn
 = 
	`Î2¡ršg
(
buf
,(buf),
v®
);

845  
	`rdbSaveAuxF›ld
(
rdb
,
key
,
	`¡¾’
(key),
buf
,
vËn
);

846 
	}
}

849 
	$rdbSaveInfoAuxF›lds
(
rio
 *
rdb
, 
æags
, 
rdbSaveInfo
 *
rsi
) {

850 
»dis_b™s
 = ((*) == 8) ? 64 : 32;

851 
aof_´—mbË
 = (
æags
 & 
RDB_SAVE_AOF_PREAMBLE
) != 0;

854 ià(
	`rdbSaveAuxF›ldSŒSŒ
(
rdb
,"»dis-v”",
REDIS_VERSION
) == -1)  -1;

855 ià(
	`rdbSaveAuxF›ldSŒIÁ
(
rdb
,"»dis-b™s",
»dis_b™s
) == -1)  -1;

856 ià(
	`rdbSaveAuxF›ldSŒIÁ
(
rdb
,"ùime",
	`time
(
NULL
)) == -1)  -1;

857 ià(
	`rdbSaveAuxF›ldSŒIÁ
(
rdb
,"u£d-mem",
	`zm®loc_u£d_memÜy
()) == -1)  -1;

860 ià(
rsi
) {

861 ià(
rsi
->
»¶_¡»am_db
 &&

862 
	`rdbSaveAuxF›ldSŒIÁ
(
rdb
,"»¶-¡»am-db",
rsi
->
»¶_¡»am_db
)

868 ià(
	`rdbSaveAuxF›ldSŒIÁ
(
rdb
,"aof-´—mbË",
aof_´—mbË
) == -1)  -1;

869 ià(
	`rdbSaveAuxF›ldSŒSŒ
(
rdb
,"»¶-id",
£rv”
.
»¶id
) == -1)  -1;

870 ià(
	`rdbSaveAuxF›ldSŒIÁ
(
rdb
,"»¶-off£t",
£rv”
.
ma¡”_»¶_off£t
) == -1)  -1;

872 
	}
}

882 
	$rdbSaveRio
(
rio
 *
rdb
, *
”rÜ
, 
æags
, 
rdbSaveInfo
 *
rsi
) {

883 
diùI‹¿tÜ
 *
di
 = 
NULL
;

884 
diùEÁry
 *
de
;

885 
magic
[10];

886 
j
;

887 
now
 = 
	`m¡ime
();

888 
ušt64_t
 
cksum
;

889 
size_t
 
´oûs£d
 = 0;

891 ià(
£rv”
.
rdb_checksum
)

892 
rdb
->
upd©e_cksum
 = 
rioG’”icUpd©eChecksum
;

893 
	`¢´štf
(
magic
,(magic),"REDIS%04d",
RDB_VERSION
);

894 ià(
	`rdbWr™eRaw
(
rdb
,
magic
,9è=ğ-1è
w”r
;

895 ià(
	`rdbSaveInfoAuxF›lds
(
rdb
,
æags
,
rsi
è=ğ-1è
w”r
;

897 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

898 
»disDb
 *
db
 = 
£rv”
.db+
j
;

899 
diù
 *
d
 = 
db
->dict;

900 ià(
	`diùSize
(
d
) == 0) ;

901 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
d
);

902 ià(!
di
è 
C_ERR
;

905 ià(
	`rdbSaveTy³
(
rdb
,
RDB_OPCODE_SELECTDB
è=ğ-1è
w”r
;

906 ià(
	`rdbSaveL’
(
rdb
,
j
è=ğ-1è
w”r
;

912 
ušt32_t
 
db_size
, 
expœes_size
;

913 
db_size
 = (
	`diùSize
(
db
->
diù
è<ğ
UINT32_MAX
) ?

914 
	`diùSize
(
db
->
diù
) :

915 
UINT32_MAX
;

916 
expœes_size
 = (
	`diùSize
(
db
->
expœes
è<ğ
UINT32_MAX
) ?

917 
	`diùSize
(
db
->
expœes
) :

918 
UINT32_MAX
;

919 ià(
	`rdbSaveTy³
(
rdb
,
RDB_OPCODE_RESIZEDB
è=ğ-1è
w”r
;

920 ià(
	`rdbSaveL’
(
rdb
,
db_size
è=ğ-1è
w”r
;

921 ià(
	`rdbSaveL’
(
rdb
,
expœes_size
è=ğ-1è
w”r
;

924 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

925 
sds
 
key¡r
 = 
	`diùG‘Key
(
de
);

926 
robj
 
key
, *
o
 = 
	`diùG‘V®
(
de
);

927 
expœe
;

929 
	`š™SticSŒšgObjeù
(
key
,
key¡r
);

930 
expœe
 = 
	`g‘Expœe
(
db
,&
key
);

931 ià(
	`rdbSaveKeyV®uePaœ
(
rdb
,&
key
,
o
,
expœe
,
now
è=ğ-1è
w”r
;

936 ià(
æags
 & 
RDB_SAVE_AOF_PREAMBLE
 &&

937 
rdb
->
´oûs£d_by‹s
 > 
´oûs£d
+
AOF_READ_DIFF_INTERVAL_BYTES
)

939 
´oûs£d
 = 
rdb
->
´oûs£d_by‹s
;

940 
	`aofR—dDiffFromP¬’t
();

943 
	`diùR–—£I‹¿tÜ
(
di
);

945 
di
 = 
NULL
;

948 ià(
	`rdbSaveTy³
(
rdb
,
RDB_OPCODE_EOF
è=ğ-1è
w”r
;

952 
cksum
 = 
rdb
->cksum;

953 
	`mem»v64ifbe
(&
cksum
);

954 ià(
	`rioWr™e
(
rdb
,&
cksum
,8è=ğ0è
w”r
;

955  
C_OK
;

957 
w”r
:

958 ià(
”rÜ
è*”rÜ = 
”ºo
;

959 ià(
di
è
	`diùR–—£I‹¿tÜ
(di);

960  
C_ERR
;

961 
	}
}

971 
	$rdbSaveRioW™hEOFM¬k
(
rio
 *
rdb
, *
”rÜ
, 
rdbSaveInfo
 *
rsi
) {

972 
eofm¬k
[
RDB_EOF_MARK_SIZE
];

974 
	`g‘RªdomHexCh¬s
(
eofm¬k
,
RDB_EOF_MARK_SIZE
);

975 ià(
”rÜ
) *error = 0;

976 ià(
	`rioWr™e
(
rdb
,"$EOF:",5è=ğ0è
w”r
;

977 ià(
	`rioWr™e
(
rdb
,
eofm¬k
,
RDB_EOF_MARK_SIZE
è=ğ0è
w”r
;

978 ià(
	`rioWr™e
(
rdb
,"\r\n",2è=ğ0è
w”r
;

979 ià(
	`rdbSaveRio
(
rdb
,
”rÜ
,
RDB_SAVE_NONE
,
rsi
è=ğ
C_ERR
è
w”r
;

980 ià(
	`rioWr™e
(
rdb
,
eofm¬k
,
RDB_EOF_MARK_SIZE
è=ğ0è
w”r
;

981  
C_OK
;

983 
w”r
:

985 ià(
”rÜ
 && *”rÜ =ğ0è*”rÜ = 
”ºo
;

986  
C_ERR
;

987 
	}
}

990 
	$rdbSave
(*
f’ame
, 
rdbSaveInfo
 *
rsi
) {

991 
tmpfe
[256];

992 
cwd
[
MAXPATHLEN
];

993 
FILE
 *
å
;

994 
rio
 
rdb
;

995 
”rÜ
 = 0;

997 
	`¢´štf
(
tmpfe
,256,"‹mp-%d.rdb", (è
	`g‘pid
());

998 
å
 = 
	`fİ’
(
tmpfe
,"w");

999 ià(!
å
) {

1000 *
cwdp
 = 
	`g‘cwd
(
cwd
,
MAXPATHLEN
);

1001 
	`£rv”Log
(
LL_WARNING
,

1004 
f’ame
,

1005 
cwdp
 ? cwdp : "unknown",

1006 
	`¡»¼Ü
(
”ºo
));

1007  
C_ERR
;

1010 
	`rioIn™W™hFe
(&
rdb
,
å
);

1011 ià(
	`rdbSaveRio
(&
rdb
,&
”rÜ
,
RDB_SAVE_NONE
,
rsi
è=ğ
C_ERR
) {

1012 
”ºo
 = 
”rÜ
;

1013 
w”r
;

1017 ià(
	`fæush
(
å
è=ğ
EOF
è
w”r
;

1018 ià(
	`fsync
(
	`f’o
(
å
)è=ğ-1è
w”r
;

1019 ià(
	`fşo£
(
å
è=ğ
EOF
è
w”r
;

1023 ià(
	`»Çme
(
tmpfe
,
f’ame
) == -1) {

1024 *
cwdp
 = 
	`g‘cwd
(
cwd
,
MAXPATHLEN
);

1025 
	`£rv”Log
(
LL_WARNING
,

1028 
tmpfe
,

1029 
f’ame
,

1030 
cwdp
 ? cwdp : "unknown",

1031 
	`¡»¼Ü
(
”ºo
));

1032 
	`uÆšk
(
tmpfe
);

1033  
C_ERR
;

1036 
	`£rv”Log
(
LL_NOTICE
,"DB saved on disk");

1037 
£rv”
.
dœty
 = 0;

1038 
£rv”
.
Ï¡§ve
 = 
	`time
(
NULL
);

1039 
£rv”
.
Ï¡bg§ve_¡©us
 = 
C_OK
;

1040  
C_OK
;

1042 
w”r
:

1043 
	`£rv”Log
(
LL_WARNING
,"Wr™”rÜ savšg DB oÀdisk: %s", 
	`¡»¼Ü
(
”ºo
));

1044 
	`fşo£
(
å
);

1045 
	`uÆšk
(
tmpfe
);

1046  
C_ERR
;

1047 
	}
}

1049 
	$rdbSaveBackground
(*
f’ame
, 
rdbSaveInfo
 *
rsi
) {

1050 
pid_t
 
chdpid
;

1051 
¡¬t
;

1053 ià(
£rv”
.
aof_chd_pid
 !ğ-1 || s”v”.
rdb_chd_pid
 !ğ-1è 
C_ERR
;

1055 
£rv”
.
dœty_befÜe_bg§ve
 = s”v”.
dœty
;

1056 
£rv”
.
Ï¡bg§ve_Œy
 = 
	`time
(
NULL
);

1057 
	`İ’ChdInfoPe
();

1059 
¡¬t
 = 
	`u¡ime
();

1060 ià((
chdpid
 = 
	`fÜk
()) == 0) {

1061 
»tv®
;

1064 
	`şo£Li¡’šgSock‘s
(0);

1065 
	`»disS‘ProcT™Ë
("redis-rdb-bgsave");

1066 
»tv®
 = 
	`rdbSave
(
f’ame
,
rsi
);

1067 ià(
»tv®
 =ğ
C_OK
) {

1068 
size_t
 
´iv©e_dœty
 = 
	`zm®loc_g‘_´iv©e_dœty
(-1);

1070 ià(
´iv©e_dœty
) {

1071 
	`£rv”Log
(
LL_NOTICE
,

1073 
´iv©e_dœty
/(1024*1024));

1076 
£rv”
.
chd_šfo_d©a
.
cow_size
 = 
´iv©e_dœty
;

1077 
	`£ndChdInfo
(
CHILD_INFO_TYPE_RDB
);

1079 
	`ex™FromChd
((
»tv®
 =ğ
C_OK
) ? 0 : 1);

1082 
£rv”
.
¡©_fÜk_time
 = 
	`u¡ime
()-
¡¬t
;

1083 
£rv”
.
¡©_fÜk_¿‹
 = (è
	`zm®loc_u£d_memÜy
(è* 1000000 / s”v”.
¡©_fÜk_time
 / (1024*1024*1024);

1084 
	`Ï‹ncyAddSam¶eIfN“ded
("fÜk",
£rv”
.
¡©_fÜk_time
/1000);

1085 ià(
chdpid
 == -1) {

1086 
	`şo£ChdInfoPe
();

1087 
£rv”
.
Ï¡bg§ve_¡©us
 = 
C_ERR
;

1088 
	`£rv”Log
(
LL_WARNING
,"Can't save in background: fork: %s",

1089 
	`¡»¼Ü
(
”ºo
));

1090  
C_ERR
;

1092 
	`£rv”Log
(
LL_NOTICE
,"Background savšg s¹ed by…id %d",
chdpid
);

1093 
£rv”
.
rdb_§ve_time_¡¬t
 = 
	`time
(
NULL
);

1094 
£rv”
.
rdb_chd_pid
 = 
chdpid
;

1095 
£rv”
.
rdb_chd_ty³
 = 
RDB_CHILD_TYPE_DISK
;

1096 
	`upd©eDiùResizePŞicy
();

1097  
C_OK
;

1099  
C_OK
;

1100 
	}
}

1102 
	$rdbRemoveTempFe
(
pid_t
 
chdpid
) {

1103 
tmpfe
[256];

1105 
	`¢´štf
(
tmpfe
,Ñmpfe),"‹mp-%d.rdb", (è
chdpid
);

1106 
	`uÆšk
(
tmpfe
);

1107 
	}
}

1113 
robj
 *
	$rdbLßdCheckModuËV®ue
(
rio
 *
rdb
, *
moduËÇme
) {

1114 
ušt64_t
 
İcode
;

1115 (
İcode
 = 
	`rdbLßdL’
(
rdb
,
NULL
)è!ğ
RDB_MODULE_OPCODE_EOF
) {

1116 ià(
İcode
 =ğ
RDB_MODULE_OPCODE_SINT
 ||

1117 
İcode
 =ğ
RDB_MODULE_OPCODE_UINT
)

1119 
ušt64_t
 
Ën
;

1120 ià(
	`rdbLßdL’ByRef
(
rdb
,
NULL
,&
Ën
) == -1) {

1121 
	`rdbEx™R•ÜtCÜru±RDB
(

1122 "E¼Ü„—dšg iÁeg” from moduË % v®ue", 
moduËÇme
);

1124 } ià(
İcode
 =ğ
RDB_MODULE_OPCODE_STRING
) {

1125 
robj
 *
o
 = 
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,
RDB_LOAD_NONE
,
NULL
);

1126 ià(
o
 =ğ
NULL
) {

1127 
	`rdbEx™R•ÜtCÜru±RDB
(

1128 "E¼Ü„—dšg sŒšg from moduË % v®ue", 
moduËÇme
);

1130 
	`deüRefCouÁ
(
o
);

1131 } ià(
İcode
 =ğ
RDB_MODULE_OPCODE_FLOAT
) {

1132 
v®
;

1133 ià(
	`rdbLßdBš¬yFlßtV®ue
(
rdb
,&
v®
) == -1) {

1134 
	`rdbEx™R•ÜtCÜru±RDB
(

1135 "E¼Ü„—dšg flßˆäom moduË % v®ue", 
moduËÇme
);

1137 } ià(
İcode
 =ğ
RDB_MODULE_OPCODE_DOUBLE
) {

1138 
v®
;

1139 ià(
	`rdbLßdBš¬yDoubËV®ue
(
rdb
,&
v®
) == -1) {

1140 
	`rdbEx™R•ÜtCÜru±RDB
(

1141 "E¼Ü„—dšg doubË from moduË % v®ue", 
moduËÇme
);

1145  
	`ü—‹SŒšgObjeù
("module-dummy-value",18);

1146 
	}
}

1150 
robj
 *
	$rdbLßdObjeù
(
rdbty³
, 
rio
 *
rdb
) {

1151 
robj
 *
o
 = 
NULL
, *
–e
, *
dec
;

1152 
ušt64_t
 
Ën
;

1153 
i
;

1155 ià(
rdbty³
 =ğ
RDB_TYPE_STRING
) {

1157 ià((
o
 = 
	`rdbLßdEncodedSŒšgObjeù
(
rdb
)è=ğ
NULL
)  NULL;

1158 
o
 = 
	`ŒyObjeùEncodšg
(o);

1159 } ià(
rdbty³
 =ğ
RDB_TYPE_LIST
) {

1161 ià((
Ën
 = 
	`rdbLßdL’
(
rdb
,
NULL
)è=ğ
RDB_LENERR
)  NULL;

1163 
o
 = 
	`ü—‹Quickli¡Objeù
();

1164 
	`quickli¡S‘O±iÚs
(
o
->
±r
, 
£rv”
.
li¡_max_zli¡_size
,

1165 
£rv”
.
li¡_com´ess_d•th
);

1168 
Ën
--) {

1169 ià((
–e
 = 
	`rdbLßdEncodedSŒšgObjeù
(
rdb
)è=ğ
NULL
)  NULL;

1170 
dec
 = 
	`g‘DecodedObjeù
(
–e
);

1171 
size_t
 
Ën
 = 
	`sd¦’
(
dec
->
±r
);

1172 
	`quickli¡PushTa
(
o
->
±r
, 
dec
->±r, 
Ën
);

1173 
	`deüRefCouÁ
(
dec
);

1174 
	`deüRefCouÁ
(
–e
);

1176 } ià(
rdbty³
 =ğ
RDB_TYPE_SET
) {

1178 ià((
Ën
 = 
	`rdbLßdL’
(
rdb
,
NULL
)è=ğ
RDB_LENERR
)  NULL;

1181 ià(
Ën
 > 
£rv”
.
£t_max_št£t_’Œ›s
) {

1182 
o
 = 
	`ü—‹S‘Objeù
();

1185 ià(
Ën
 > 
DICT_HT_INITIAL_SIZE
)

1186 
	`diùEx·nd
(
o
->
±r
,
Ën
);

1188 
o
 = 
	`ü—‹IÁ£tObjeù
();

1192 
i
 = 0; i < 
Ën
; i++) {

1193 
Îv®
;

1194 
sds
 
sd£Ë
;

1196 ià((
sd£Ë
 = 
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,
RDB_LOAD_SDS
,
NULL
))

1197 =ğ
NULL
)  NULL;

1199 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1201 ià(
	`isSdsR•»£ÁabËAsLÚgLÚg
(
sd£Ë
,&
Îv®
è=ğ
C_OK
) {

1202 
o
->
±r
 = 
	`št£tAdd
(o->±r,
Îv®
,
NULL
);

1204 
	`£tTy³CÚv”t
(
o
,
OBJ_ENCODING_HT
);

1205 
	`diùEx·nd
(
o
->
±r
,
Ën
);

1211 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

1212 
	`diùAdd
((
diù
*)
o
->
±r
,
sd£Ë
,
NULL
);

1214 
	`sdsä“
(
sd£Ë
);

1217 } ià(
rdbty³
 =ğ
RDB_TYPE_ZSET_2
 ||„dbty³ =ğ
RDB_TYPE_ZSET
) {

1219 
ušt64_t
 
z£’
;

1220 
size_t
 
max––’
 = 0;

1221 
z£t
 *
zs
;

1223 ià((
z£’
 = 
	`rdbLßdL’
(
rdb
,
NULL
)è=ğ
RDB_LENERR
)  NULL;

1224 
o
 = 
	`ü—‹Z£tObjeù
();

1225 
zs
 = 
o
->
±r
;

1228 
z£’
--) {

1229 
sds
 
sd£Ë
;

1230 
scÜe
;

1231 
zskli¡Node
 *
znode
;

1233 ià((
sd£Ë
 = 
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,
RDB_LOAD_SDS
,
NULL
))

1234 =ğ
NULL
)  NULL;

1236 ià(
rdbty³
 =ğ
RDB_TYPE_ZSET_2
) {

1237 ià(
	`rdbLßdBš¬yDoubËV®ue
(
rdb
,&
scÜe
è=ğ-1è 
NULL
;

1239 ià(
	`rdbLßdDoubËV®ue
(
rdb
,&
scÜe
è=ğ-1è 
NULL
;

1243 ià(
	`sd¦’
(
sd£Ë
è> 
max––’
) maxelelen = sdslen(sdsele);

1245 
znode
 = 
	`z¦In£¹
(
zs
->
z¦
,
scÜe
,
sd£Ë
);

1246 
	`diùAdd
(
zs
->
diù
,
sd£Ë
,&
znode
->
scÜe
);

1250 ià(
	`z£tL’gth
(
o
è<ğ
£rv”
.
z£t_max_zli¡_’Œ›s
 &&

1251 
max––’
 <ğ
£rv”
.
z£t_max_zli¡_v®ue
)

1252 
	`z£tCÚv”t
(
o
,
OBJ_ENCODING_ZIPLIST
);

1253 } ià(
rdbty³
 =ğ
RDB_TYPE_HASH
) {

1254 
ušt64_t
 
Ën
;

1255 
»t
;

1256 
sds
 
f›ld
, 
v®ue
;

1258 
Ën
 = 
	`rdbLßdL’
(
rdb
, 
NULL
);

1259 ià(
Ën
 =ğ
RDB_LENERR
è 
NULL
;

1261 
o
 = 
	`ü—‹HashObjeù
();

1264 ià(
Ën
 > 
£rv”
.
hash_max_zli¡_’Œ›s
)

1265 
	`hashTy³CÚv”t
(
o
, 
OBJ_ENCODING_HT
);

1268 
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
 && 
Ën
 > 0) {

1269 
Ën
--;

1271 ià((
f›ld
 = 
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,
RDB_LOAD_SDS
,
NULL
))

1272 =ğ
NULL
)  NULL;

1273 ià((
v®ue
 = 
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,
RDB_LOAD_SDS
,
NULL
))

1274 =ğ
NULL
)  NULL;

1277 
o
->
±r
 = 
	`zli¡Push
(o->±r, (*)
f›ld
,

1278 
	`sd¦’
(
f›ld
), 
ZIPLIST_TAIL
);

1279 
o
->
±r
 = 
	`zli¡Push
(o->±r, (*)
v®ue
,

1280 
	`sd¦’
(
v®ue
), 
ZIPLIST_TAIL
);

1283 ià(
	`sd¦’
(
f›ld
è> 
£rv”
.
hash_max_zli¡_v®ue
 ||

1284 
	`sd¦’
(
v®ue
è> 
£rv”
.
hash_max_zli¡_v®ue
)

1286 
	`sdsä“
(
f›ld
);

1287 
	`sdsä“
(
v®ue
);

1288 
	`hashTy³CÚv”t
(
o
, 
OBJ_ENCODING_HT
);

1291 
	`sdsä“
(
f›ld
);

1292 
	`sdsä“
(
v®ue
);

1296 
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
 && 
Ën
 > 0) {

1297 
Ën
--;

1299 ià((
f›ld
 = 
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,
RDB_LOAD_SDS
,
NULL
))

1300 =ğ
NULL
)  NULL;

1301 ià((
v®ue
 = 
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,
RDB_LOAD_SDS
,
NULL
))

1302 =ğ
NULL
)  NULL;

1305 
»t
 = 
	`diùAdd
((
diù
*)
o
->
±r
, 
f›ld
, 
v®ue
);

1306 ià(
»t
 =ğ
DICT_ERR
) {

1307 
	`rdbEx™R•ÜtCÜru±RDB
("Duplicate keys detected");

1312 
	`£rv”As£¹
(
Ën
 == 0);

1313 } ià(
rdbty³
 =ğ
RDB_TYPE_LIST_QUICKLIST
) {

1314 ià((
Ën
 = 
	`rdbLßdL’
(
rdb
,
NULL
)è=ğ
RDB_LENERR
)  NULL;

1315 
o
 = 
	`ü—‹Quickli¡Objeù
();

1316 
	`quickli¡S‘O±iÚs
(
o
->
±r
, 
£rv”
.
li¡_max_zli¡_size
,

1317 
£rv”
.
li¡_com´ess_d•th
);

1319 
Ën
--) {

1320 *
zl
 =

1321 
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,
RDB_LOAD_PLAIN
,
NULL
);

1322 ià(
zl
 =ğ
NULL
)  NULL;

1323 
	`quickli¡Aµ’dZli¡
(
o
->
±r
, 
zl
);

1325 } ià(
rdbty³
 =ğ
RDB_TYPE_HASH_ZIPMAP
 ||

1326 
rdbty³
 =ğ
RDB_TYPE_LIST_ZIPLIST
 ||

1327 
rdbty³
 =ğ
RDB_TYPE_SET_INTSET
 ||

1328 
rdbty³
 =ğ
RDB_TYPE_ZSET_ZIPLIST
 ||

1329 
rdbty³
 =ğ
RDB_TYPE_HASH_ZIPLIST
)

1331 *
’coded
 =

1332 
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,
RDB_LOAD_PLAIN
,
NULL
);

1333 ià(
’coded
 =ğ
NULL
)  NULL;

1334 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
’coded
);

1342 
rdbty³
) {

1343 
RDB_TYPE_HASH_ZIPMAP
:

1347 *
zl
 = 
	`zli¡New
();

1348 *
zi
 = 
	`zm­Rewšd
(
o
->
±r
);

1349 *
f¡r
, *
v¡r
;

1350 
æ’
, 
vËn
;

1351 
maxËn
 = 0;

1353 (
zi
 = 
	`zm­Next
(zi, &
f¡r
, &
æ’
, &
v¡r
, &
vËn
)è!ğ
NULL
) {

1354 ià(
æ’
 > 
maxËn
) maxlen = flen;

1355 ià(
vËn
 > 
maxËn
) maxlen = vlen;

1356 
zl
 = 
	`zli¡Push
(zl, 
f¡r
, 
æ’
, 
ZIPLIST_TAIL
);

1357 
zl
 = 
	`zli¡Push
(zl, 
v¡r
, 
vËn
, 
ZIPLIST_TAIL
);

1360 
	`zä“
(
o
->
±r
);

1361 
o
->
±r
 = 
zl
;

1362 
o
->
ty³
 = 
OBJ_HASH
;

1363 
o
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

1365 ià(
	`hashTy³L’gth
(
o
è> 
£rv”
.
hash_max_zli¡_’Œ›s
 ||

1366 
maxËn
 > 
£rv”
.
hash_max_zli¡_v®ue
)

1368 
	`hashTy³CÚv”t
(
o
, 
OBJ_ENCODING_HT
);

1372 
RDB_TYPE_LIST_ZIPLIST
:

1373 
o
->
ty³
 = 
OBJ_LIST
;

1374 
o
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

1375 
	`li¡Ty³CÚv”t
(
o
,
OBJ_ENCODING_QUICKLIST
);

1377 
RDB_TYPE_SET_INTSET
:

1378 
o
->
ty³
 = 
OBJ_SET
;

1379 
o
->
’codšg
 = 
OBJ_ENCODING_INTSET
;

1380 ià(
	`št£tL’
(
o
->
±r
è> 
£rv”
.
£t_max_št£t_’Œ›s
)

1381 
	`£tTy³CÚv”t
(
o
,
OBJ_ENCODING_HT
);

1383 
RDB_TYPE_ZSET_ZIPLIST
:

1384 
o
->
ty³
 = 
OBJ_ZSET
;

1385 
o
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

1386 ià(
	`z£tL’gth
(
o
è> 
£rv”
.
z£t_max_zli¡_’Œ›s
)

1387 
	`z£tCÚv”t
(
o
,
OBJ_ENCODING_SKIPLIST
);

1389 
RDB_TYPE_HASH_ZIPLIST
:

1390 
o
->
ty³
 = 
OBJ_HASH
;

1391 
o
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

1392 ià(
	`hashTy³L’gth
(
o
è> 
£rv”
.
hash_max_zli¡_’Œ›s
)

1393 
	`hashTy³CÚv”t
(
o
, 
OBJ_ENCODING_HT
);

1396 
	`rdbEx™R•ÜtCÜru±RDB
("UnknowÀRDBƒncodšgy³ %d",
rdbty³
);

1399 } ià(
rdbty³
 =ğ
RDB_TYPE_MODULE
 ||„dbty³ =ğ
RDB_TYPE_MODULE_2
) {

1400 
ušt64_t
 
moduËid
 = 
	`rdbLßdL’
(
rdb
,
NULL
);

1401 
moduËTy³
 *
mt
 = 
	`moduËTy³LookupModuËByID
(
moduËid
);

1402 
Çme
[10];

1404 ià(
rdbCheckMode
 && 
rdbty³
 =ğ
RDB_TYPE_MODULE_2
)

1405  
	`rdbLßdCheckModuËV®ue
(
rdb
,
Çme
);

1407 ià(
mt
 =ğ
NULL
) {

1408 
	`moduËTy³NameByID
(
Çme
,
moduËid
);

1409 
	`£rv”Log
(
LL_WARNING
,"ThRDB fcÚš moduË d©¨I cª'ˆlßd:‚Øm©chšg moduË '%s'", 
Çme
);

1410 
	`ex™
(1);

1412 
RedisModuËIO
 
io
;

1413 
	`moduËIn™IOCÚ‹xt
(
io
,
mt
,
rdb
);

1414 
io
.
v”
 = (
rdbty³
 =ğ
RDB_TYPE_MODULE
) ? 1 : 2;

1417 *
±r
 = 
mt
->
	`rdb_lßd
(&
io
,
moduËid
&1023);

1418 ià(
io
.
ùx
) {

1419 
	`moduËF»eCÚ‹xt
(
io
.
ùx
);

1420 
	`zä“
(
io
.
ùx
);

1424 ià(
io
.
v”
 == 2) {

1425 
ušt64_t
 
eof
 = 
	`rdbLßdL’
(
rdb
,
NULL
);

1426 ià(
eof
 !ğ
RDB_MODULE_OPCODE_EOF
) {

1427 
	`£rv”Log
(
LL_WARNING
,"ThRDB fcÚš moduË d©¨fÜhmoduË '%s'h© i nÙ”mš©ed byh´İ” moduË v®uEOF m¬k”", 
Çme
);

1428 
	`ex™
(1);

1432 ià(
±r
 =ğ
NULL
) {

1433 
	`moduËTy³NameByID
(
Çme
,
moduËid
);

1434 
	`£rv”Log
(
LL_WARNING
,"ThRDB fcÚš moduË d©¨fÜhmoduËy³ '%s',h©h»¥ÚsibË moduË i nÙ‡bËØlßd. Check fÜ moduË log‡bovfÜ‡dd™iÚ® clues.", 
Çme
);

1435 
	`ex™
(1);

1437 
o
 = 
	`ü—‹ModuËObjeù
(
mt
,
±r
);

1439 
	`rdbEx™R•ÜtCÜru±RDB
("UnknowÀRDBƒncodšgy³ %d",
rdbty³
);

1441  
o
;

1442 
	}
}

1446 
	$¡¬tLßdšg
(
FILE
 *
å
) {

1447 
¡©
 
sb
;

1450 
£rv”
.
lßdšg
 = 1;

1451 
£rv”
.
lßdšg_¡¬t_time
 = 
	`time
(
NULL
);

1452 
£rv”
.
lßdšg_lßded_by‹s
 = 0;

1453 ià(
	`f¡©
(
	`f’o
(
å
), &
sb
) == -1) {

1454 
£rv”
.
lßdšg_tÙ®_by‹s
 = 0;

1456 
£rv”
.
lßdšg_tÙ®_by‹s
 = 
sb
.
¡_size
;

1458 
	}
}

1461 
	$lßdšgProg»ss
(
off_t
 
pos
) {

1462 
£rv”
.
lßdšg_lßded_by‹s
 = 
pos
;

1463 ià(
£rv”
.
¡©_³ak_memÜy
 < 
	`zm®loc_u£d_memÜy
())

1464 
£rv”
.
¡©_³ak_memÜy
 = 
	`zm®loc_u£d_memÜy
();

1465 
	}
}

1468 
	$¡İLßdšg
() {

1469 
£rv”
.
lßdšg
 = 0;

1470 
	}
}

1474 
	$rdbLßdProg»ssC®lback
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

1475 ià(
£rv”
.
rdb_checksum
)

1476 
	`rioG’”icUpd©eChecksum
(
r
, 
buf
, 
Ën
);

1477 ià(
£rv”
.
lßdšg_´oûss_ev’ts_š‹rv®_by‹s
 &&

1478 (
r
->
´oûs£d_by‹s
 + 
Ën
)/
£rv”
.
lßdšg_´oûss_ev’ts_š‹rv®_by‹s
 >„->processed_bytes/server.loading_process_events_interval_bytes)

1483 
	`upd©eCachedTime
();

1484 ià(
£rv”
.
ma¡”ho¡
 && s”v”.
»¶_¡©e
 =ğ
REPL_STATE_TRANSFER
)

1485 
	`»¶iÿtiÚS’dNewlšeToMa¡”
();

1486 
	`lßdšgProg»ss
(
r
->
´oûs£d_by‹s
);

1487 
	`´oûssEv’tsWheBlocked
();

1489 
	}
}

1493 
	$rdbLßdRio
(
rio
 *
rdb
, 
rdbSaveInfo
 *
rsi
) {

1494 
ušt64_t
 
dbid
;

1495 
ty³
, 
rdbv”
;

1496 
»disDb
 *
db
 = 
£rv”
.db+0;

1497 
buf
[1024];

1498 
expœ‘ime
, 
now
 = 
	`m¡ime
();

1500 
rdb
->
upd©e_cksum
 = 
rdbLßdProg»ssC®lback
;

1501 
rdb
->
max_´oûssšg_chunk
 = 
£rv”
.
lßdšg_´oûss_ev’ts_š‹rv®_by‹s
;

1502 ià(
	`rioR—d
(
rdb
,
buf
,9è=ğ0è
eoã¼
;

1503 
buf
[9] = '\0';

1504 ià(
	`memcmp
(
buf
,"REDIS",5) != 0) {

1505 
	`£rv”Log
(
LL_WARNING
,"Wrong signatureryingo†oad DB from file");

1506 
”ºo
 = 
EINVAL
;

1507  
C_ERR
;

1509 
rdbv”
 = 
	`©oi
(
buf
+5);

1510 ià(
rdbv”
 < 1 ||„dbv” > 
RDB_VERSION
) {

1511 
	`£rv”Log
(
LL_WARNING
,"Cª'ˆhªdË RDB fÜm© v”siÚ %d",
rdbv”
);

1512 
”ºo
 = 
EINVAL
;

1513  
C_ERR
;

1517 
robj
 *
key
, *
v®
;

1518 
expœ‘ime
 = -1;

1521 ià((
ty³
 = 
	`rdbLßdTy³
(
rdb
)è=ğ-1è
eoã¼
;

1524 ià(
ty³
 =ğ
RDB_OPCODE_EXPIRETIME
) {

1528 ià((
expœ‘ime
 = 
	`rdbLßdTime
(
rdb
)è=ğ-1è
eoã¼
;

1530 ià((
ty³
 = 
	`rdbLßdTy³
(
rdb
)è=ğ-1è
eoã¼
;

1533 
expœ‘ime
 *= 1000;

1534 } ià(
ty³
 =ğ
RDB_OPCODE_EXPIRETIME_MS
) {

1537 ià((
expœ‘ime
 = 
	`rdbLßdMli£cÚdTime
(
rdb
)è=ğ-1è
eoã¼
;

1539 ià((
ty³
 = 
	`rdbLßdTy³
(
rdb
)è=ğ-1è
eoã¼
;

1540 } ià(
ty³
 =ğ
RDB_OPCODE_EOF
) {

1543 } ià(
ty³
 =ğ
RDB_OPCODE_SELECTDB
) {

1545 ià((
dbid
 = 
	`rdbLßdL’
(
rdb
,
NULL
)è=ğ
RDB_LENERR
)

1546 
eoã¼
;

1547 ià(
dbid
 >ğ()
£rv”
.
dbnum
) {

1548 
	`£rv”Log
(
LL_WARNING
,

1551 "d©aba£s. Ex™šg\n", 
£rv”
.
dbnum
);

1552 
	`ex™
(1);

1554 
db
 = 
£rv”
.db+
dbid
;

1556 } ià(
ty³
 =ğ
RDB_OPCODE_RESIZEDB
) {

1559 
ušt64_t
 
db_size
, 
expœes_size
;

1560 ià((
db_size
 = 
	`rdbLßdL’
(
rdb
,
NULL
)è=ğ
RDB_LENERR
)

1561 
eoã¼
;

1562 ià((
expœes_size
 = 
	`rdbLßdL’
(
rdb
,
NULL
)è=ğ
RDB_LENERR
)

1563 
eoã¼
;

1564 
	`diùEx·nd
(
db
->
diù
,
db_size
);

1565 
	`diùEx·nd
(
db
->
expœes
,
expœes_size
);

1567 } ià(
ty³
 =ğ
RDB_OPCODE_AUX
) {

1573 
robj
 *
auxkey
, *
auxv®
;

1574 ià((
auxkey
 = 
	`rdbLßdSŒšgObjeù
(
rdb
)è=ğ
NULL
è
eoã¼
;

1575 ià((
auxv®
 = 
	`rdbLßdSŒšgObjeù
(
rdb
)è=ğ
NULL
è
eoã¼
;

1577 ià(((*)
auxkey
->
±r
)[0] == '%') {

1581 
	`£rv”Log
(
LL_NOTICE
,"RDB '%s': %s",

1582 (*)
auxkey
->
±r
,

1583 (*)
auxv®
->
±r
);

1584 } ià(!
	`¡rÿ£cmp
(
auxkey
->
±r
,"repl-stream-db")) {

1585 ià(
rsi
èrsi->
»¶_¡»am_db
 = 
	`©oi
(
auxv®
->
±r
);

1586 } ià(!
	`¡rÿ£cmp
(
auxkey
->
±r
,"repl-id")) {

1587 ià(
rsi
 && 
	`sd¦’
(
auxv®
->
±r
è=ğ
CONFIG_RUN_ID_SIZE
) {

1588 
	`memıy
(
rsi
->
»¶_id
,
auxv®
->
±r
,
CONFIG_RUN_ID_SIZE
+1);

1589 
rsi
->
»¶_id_is_£t
 = 1;

1591 } ià(!
	`¡rÿ£cmp
(
auxkey
->
±r
,"repl-offset")) {

1592 ià(
rsi
èrsi->
»¶_off£t
 = 
	`¡¹Şl
(
auxv®
->
±r
,
NULL
,10);

1596 
	`£rv”Log
(
LL_DEBUG
,"Unrecognized RDB AUX field: '%s'",

1597 (*)
auxkey
->
±r
);

1600 
	`deüRefCouÁ
(
auxkey
);

1601 
	`deüRefCouÁ
(
auxv®
);

1606 ià((
key
 = 
	`rdbLßdSŒšgObjeù
(
rdb
)è=ğ
NULL
è
eoã¼
;

1608 ià((
v®
 = 
	`rdbLßdObjeù
(
ty³
,
rdb
)è=ğ
NULL
è
eoã¼
;

1614 ià(
£rv”
.
ma¡”ho¡
 =ğ
NULL
 && 
expœ‘ime
 !ğ-1 &&ƒxpœ‘im< 
now
) {

1615 
	`deüRefCouÁ
(
key
);

1616 
	`deüRefCouÁ
(
v®
);

1620 
	`dbAdd
(
db
,
key
,
v®
);

1623 ià(
expœ‘ime
 !ğ-1è
	`£tExpœe
(
NULL
,
db
,
key
,expiretime);

1625 
	`deüRefCouÁ
(
key
);

1628 ià(
rdbv”
 >ğ5 && 
£rv”
.
rdb_checksum
) {

1629 
ušt64_t
 
cksum
, 
ex³ùed
 = 
rdb
->cksum;

1631 ià(
	`rioR—d
(
rdb
,&
cksum
,8è=ğ0è
eoã¼
;

1632 
	`mem»v64ifbe
(&
cksum
);

1633 ià(
cksum
 == 0) {

1634 
	`£rv”Log
(
LL_WARNING
,"RDB file was saved with checksum disabled:‚o check…erformed.");

1635 } ià(
cksum
 !ğ
ex³ùed
) {

1636 
	`£rv”Log
(
LL_WARNING
,"Wrong RDB checksum. Aborting‚ow.");

1637 
	`rdbEx™R•ÜtCÜru±RDB
("RDB CRCƒrror");

1640  
C_OK
;

1642 
eoã¼
:

1643 
	`£rv”Log
(
LL_WARNING
,"Short„ead or OOM†oading DB. Unrecoverableƒrror,‡borting‚ow.");

1644 
	`rdbEx™R•ÜtCÜru±RDB
("Unexpected EOF„eading RDB file");

1645  
C_ERR
;

1646 
	}
}

1655 
	$rdbLßd
(*
f’ame
, 
rdbSaveInfo
 *
rsi
) {

1656 
FILE
 *
å
;

1657 
rio
 
rdb
;

1658 
»tv®
;

1660 ià((
å
 = 
	`fİ’
(
f’ame
,"r")è=ğ
NULL
è 
C_ERR
;

1661 
	`¡¬tLßdšg
(
å
);

1662 
	`rioIn™W™hFe
(&
rdb
,
å
);

1663 
»tv®
 = 
	`rdbLßdRio
(&
rdb
,
rsi
);

1664 
	`fşo£
(
å
);

1665 
	`¡İLßdšg
();

1666  
»tv®
;

1667 
	}
}

1671 
	$backgroundSaveDÚeHªdËrDisk
(
ex™code
, 
bysigÇl
) {

1672 ià(!
bysigÇl
 && 
ex™code
 == 0) {

1673 
	`£rv”Log
(
LL_NOTICE
,

1675 
£rv”
.
dœty
 = s”v”.dœty - s”v”.
dœty_befÜe_bg§ve
;

1676 
£rv”
.
Ï¡§ve
 = 
	`time
(
NULL
);

1677 
£rv”
.
Ï¡bg§ve_¡©us
 = 
C_OK
;

1678 } ià(!
bysigÇl
 && 
ex™code
 != 0) {

1679 
	`£rv”Log
(
LL_WARNING
, "Background savingƒrror");

1680 
£rv”
.
Ï¡bg§ve_¡©us
 = 
C_ERR
;

1682 
m¡ime_t
 
Ï‹ncy
;

1684 
	`£rv”Log
(
LL_WARNING
,

1685 "Background savšg”mš©ed by sigÇÈ%d", 
bysigÇl
);

1686 
	`Ï‹ncyS¹MÚ™Ü
(
Ï‹ncy
);

1687 
	`rdbRemoveTempFe
(
£rv”
.
rdb_chd_pid
);

1688 
	`Ï‹ncyEndMÚ™Ü
(
Ï‹ncy
);

1689 
	`Ï‹ncyAddSam¶eIfN“ded
("rdb-uÆšk-‹mp-fe",
Ï‹ncy
);

1692 ià(
bysigÇl
 !ğ
SIGUSR1
)

1693 
£rv”
.
Ï¡bg§ve_¡©us
 = 
C_ERR
;

1695 
£rv”
.
rdb_chd_pid
 = -1;

1696 
£rv”
.
rdb_chd_ty³
 = 
RDB_CHILD_TYPE_NONE
;

1697 
£rv”
.
rdb_§ve_time_Ï¡
 = 
	`time
(
NULL
)-£rv”.
rdb_§ve_time_¡¬t
;

1698 
£rv”
.
rdb_§ve_time_¡¬t
 = -1;

1701 
	`upd©eSÏvesWa™šgBg§ve
((!
bysigÇl
 && 
ex™code
 =ğ0è? 
C_OK
 : 
C_ERR
, 
RDB_CHILD_TYPE_DISK
);

1702 
	}
}

1707 
	$backgroundSaveDÚeHªdËrSock‘
(
ex™code
, 
bysigÇl
) {

1708 
ušt64_t
 *
ok_¦aves
;

1710 ià(!
bysigÇl
 && 
ex™code
 == 0) {

1711 
	`£rv”Log
(
LL_NOTICE
,

1713 } ià(!
bysigÇl
 && 
ex™code
 != 0) {

1714 
	`£rv”Log
(
LL_WARNING
, "Backgroundransferƒrror");

1716 
	`£rv”Log
(
LL_WARNING
,

1717 "Background¿nsã¸‹rmš©ed by sigÇÈ%d", 
bysigÇl
);

1719 
£rv”
.
rdb_chd_pid
 = -1;

1720 
£rv”
.
rdb_chd_ty³
 = 
RDB_CHILD_TYPE_NONE
;

1721 
£rv”
.
rdb_§ve_time_¡¬t
 = -1;

1730 
ok_¦aves
 = 
	`zm®loc
((
ušt64_t
));

1731 
ok_¦aves
[0] = 0;

1732 ià(!
bysigÇl
 && 
ex™code
 == 0) {

1733 
»adËn
 = (
ušt64_t
);

1735 ià(
	`»ad
(
£rv”
.
rdb_pe_»ad_»suÉ_äom_chd
, 
ok_¦aves
, 
»adËn
) ==

1736 
»adËn
)

1738 
»adËn
 = 
ok_¦aves
[0]*(
ušt64_t
)*2;

1742 
ok_¦aves
 = 
	`z»®loc
(ok_¦aves,(
ušt64_t
)+
»adËn
);

1743 ià(
»adËn
 &&

1744 
	`»ad
(
£rv”
.
rdb_pe_»ad_»suÉ_äom_chd
, 
ok_¦aves
+1,

1745 
»adËn
) !=„eadlen)

1747 
ok_¦aves
[0] = 0;

1752 
	`şo£
(
£rv”
.
rdb_pe_»ad_»suÉ_äom_chd
);

1753 
	`şo£
(
£rv”
.
rdb_pe_wr™e_»suÉ_to_·»Á
);

1757 
li¡Node
 *
Ê
;

1758 
li¡I‹r
 
li
;

1760 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

1761 (
Ê
 = 
	`li¡Next
(&
li
))) {

1762 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

1764 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_END
) {

1765 
ušt64_t
 
j
;

1766 
”rÜcode
 = 0;

1771 
j
 = 0; j < 
ok_¦aves
[0]; j++) {

1772 ià(
¦ave
->
id
 =ğ
ok_¦aves
[2*
j
+1]) {

1773 
”rÜcode
 = 
ok_¦aves
[2*
j
+2];

1777 ià(
j
 =ğ
ok_¦aves
[0] || 
”rÜcode
 != 0) {

1778 
	`£rv”Log
(
LL_WARNING
,

1780 
	`»¶iÿtiÚG‘SÏveName
(
¦ave
),

1781 (
”rÜcode
 == 0) ? "RDBransfer child‡borted"

1782 : 
	`¡»¼Ü
(
”rÜcode
));

1783 
	`ä“Cl›Á
(
¦ave
);

1785 
	`£rv”Log
(
LL_WARNING
,

1787 
	`»¶iÿtiÚG‘SÏveName
(
¦ave
));

1789 
	`ª‘NÚBlock
(
NULL
,
¦ave
->
fd
);

1790 
	`ª‘S’dTimeout
(
NULL
,
¦ave
->
fd
,0);

1794 
	`zä“
(
ok_¦aves
);

1796 
	`upd©eSÏvesWa™šgBg§ve
((!
bysigÇl
 && 
ex™code
 =ğ0è? 
C_OK
 : 
C_ERR
, 
RDB_CHILD_TYPE_SOCKET
);

1797 
	}
}

1800 
	$backgroundSaveDÚeHªdËr
(
ex™code
, 
bysigÇl
) {

1801 
£rv”
.
rdb_chd_ty³
) {

1802 
RDB_CHILD_TYPE_DISK
:

1803 
	`backgroundSaveDÚeHªdËrDisk
(
ex™code
,
bysigÇl
);

1805 
RDB_CHILD_TYPE_SOCKET
:

1806 
	`backgroundSaveDÚeHªdËrSock‘
(
ex™code
,
bysigÇl
);

1809 
	`£rv”Pªic
("Unknown RDB childype.");

1812 
	}
}

1816 
	$rdbSaveToSÏvesSock‘s
(
rdbSaveInfo
 *
rsi
) {

1817 *
fds
;

1818 
ušt64_t
 *
ş›Áids
;

1819 
numfds
;

1820 
li¡Node
 *
Ê
;

1821 
li¡I‹r
 
li
;

1822 
pid_t
 
chdpid
;

1823 
¡¬t
;

1824 
pefds
[2];

1826 ià(
£rv”
.
aof_chd_pid
 !ğ-1 || s”v”.
rdb_chd_pid
 !ğ-1è 
C_ERR
;

1831 ià(
	`pe
(
pefds
è=ğ-1è 
C_ERR
;

1832 
£rv”
.
rdb_pe_»ad_»suÉ_äom_chd
 = 
pefds
[0];

1833 
£rv”
.
rdb_pe_wr™e_»suÉ_to_·»Á
 = 
pefds
[1];

1837 
fds
 = 
	`zm®loc
(()*
	`li¡L’gth
(
£rv”
.
¦aves
));

1841 
ş›Áids
 = 
	`zm®loc
((
ušt64_t
)*
	`li¡L’gth
(
£rv”
.
¦aves
));

1842 
numfds
 = 0;

1844 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

1845 (
Ê
 = 
	`li¡Next
(&
li
))) {

1846 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

1848 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_START
) {

1849 
ş›Áids
[
numfds
] = 
¦ave
->
id
;

1850 
fds
[
numfds
++] = 
¦ave
->
fd
;

1851 
	`»¶iÿtiÚS‘upSÏveFÜFuÎResync
(
¦ave
,
	`g‘PsyncIn™ŸlOff£t
());

1855 
	`ª‘Block
(
NULL
,
¦ave
->
fd
);

1856 
	`ª‘S’dTimeout
(
NULL
,
¦ave
->
fd
,
£rv”
.
»¶_timeout
*1000);

1861 
	`İ’ChdInfoPe
();

1862 
¡¬t
 = 
	`u¡ime
();

1863 ià((
chdpid
 = 
	`fÜk
()) == 0) {

1865 
»tv®
;

1866 
rio
 
¦ave_sock‘s
;

1868 
	`rioIn™W™hFd£t
(&
¦ave_sock‘s
,
fds
,
numfds
);

1869 
	`zä“
(
fds
);

1871 
	`şo£Li¡’šgSock‘s
(0);

1872 
	`»disS‘ProcT™Ë
("redis-rdb-to-slaves");

1874 
»tv®
 = 
	`rdbSaveRioW™hEOFM¬k
(&
¦ave_sock‘s
,
NULL
,
rsi
);

1875 ià(
»tv®
 =ğ
C_OK
 && 
	`rioFlush
(&
¦ave_sock‘s
) == 0)

1876 
»tv®
 = 
C_ERR
;

1878 ià(
»tv®
 =ğ
C_OK
) {

1879 
size_t
 
´iv©e_dœty
 = 
	`zm®loc_g‘_´iv©e_dœty
(-1);

1881 ià(
´iv©e_dœty
) {

1882 
	`£rv”Log
(
LL_NOTICE
,

1884 
´iv©e_dœty
/(1024*1024));

1887 
£rv”
.
chd_šfo_d©a
.
cow_size
 = 
´iv©e_dœty
;

1888 
	`£ndChdInfo
(
CHILD_INFO_TYPE_RDB
);

1905 *
msg
 = 
	`zm®loc
((
ušt64_t
)*(1+2*
numfds
));

1906 
ušt64_t
 *
Ën
 = 
msg
;

1907 
ušt64_t
 *
ids
 = 
Ën
+1;

1908 
j
, 
msgËn
;

1910 *
Ën
 = 
numfds
;

1911 
j
 = 0; j < 
numfds
; j++) {

1912 *
ids
++ = 
ş›Áids
[
j
];

1913 *
ids
++ = 
¦ave_sock‘s
.
io
.
fd£t
.
¡©e
[
j
];

1920 
msgËn
 = (
ušt64_t
)*(1+2*
numfds
);

1921 ià(*
Ën
 == 0 ||

1922 
	`wr™e
(
£rv”
.
rdb_pe_wr™e_»suÉ_to_·»Á
,
msg
,
msgËn
)

1923 !ğ
msgËn
)

1925 
»tv®
 = 
C_ERR
;

1927 
	`zä“
(
msg
);

1929 
	`zä“
(
ş›Áids
);

1930 
	`rioF»eFd£t
(&
¦ave_sock‘s
);

1931 
	`ex™FromChd
((
»tv®
 =ğ
C_OK
) ? 0 : 1);

1934 ià(
chdpid
 == -1) {

1935 
	`£rv”Log
(
LL_WARNING
,"Can't save in background: fork: %s",

1936 
	`¡»¼Ü
(
”ºo
));

1941 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

1942 (
Ê
 = 
	`li¡Next
(&
li
))) {

1943 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

1944 
j
;

1946 
j
 = 0; j < 
numfds
; j++) {

1947 ià(
¦ave
->
id
 =ğ
ş›Áids
[
j
]) {

1948 
¦ave
->
»¶¡©e
 = 
SLAVE_STATE_WAIT_BGSAVE_START
;

1953 
	`şo£
(
pefds
[0]);

1954 
	`şo£
(
pefds
[1]);

1955 
	`şo£ChdInfoPe
();

1957 
£rv”
.
¡©_fÜk_time
 = 
	`u¡ime
()-
¡¬t
;

1958 
£rv”
.
¡©_fÜk_¿‹
 = (è
	`zm®loc_u£d_memÜy
(è* 1000000 / s”v”.
¡©_fÜk_time
 / (1024*1024*1024);

1959 
	`Ï‹ncyAddSam¶eIfN“ded
("fÜk",
£rv”
.
¡©_fÜk_time
/1000);

1961 
	`£rv”Log
(
LL_NOTICE
,"Background RDBransfer started by…id %d",

1962 
chdpid
);

1963 
£rv”
.
rdb_§ve_time_¡¬t
 = 
	`time
(
NULL
);

1964 
£rv”
.
rdb_chd_pid
 = 
chdpid
;

1965 
£rv”
.
rdb_chd_ty³
 = 
RDB_CHILD_TYPE_SOCKET
;

1966 
	`upd©eDiùResizePŞicy
();

1968 
	`zä“
(
ş›Áids
);

1969 
	`zä“
(
fds
);

1970  (
chdpid
 =ğ-1è? 
C_ERR
 : 
C_OK
;

1972  
C_OK
;

1973 
	}
}

1975 
	$§veCommªd
(
ş›Á
 *
c
) {

1976 ià(
£rv”
.
rdb_chd_pid
 != -1) {

1977 
	`addR•lyE¼Ü
(
c
,"Background save‡lready in…rogress");

1980 ià(
	`rdbSave
(
£rv”
.
rdb_f’ame
,
NULL
è=ğ
C_OK
) {

1981 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1983 
	`addR•ly
(
c
,
sh¬ed
.
”r
);

1985 
	}
}

1988 
	$bg§veCommªd
(
ş›Á
 *
c
) {

1989 
scheduË
 = 0;

1993 ià(
c
->
¬gc
 > 1) {

1994 ià(
c
->
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"schedule")) {

1995 
scheduË
 = 1;

1997 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2002 ià(
£rv”
.
rdb_chd_pid
 != -1) {

2003 
	`addR•lyE¼Ü
(
c
,"Background save‡lready in…rogress");

2004 } ià(
£rv”
.
aof_chd_pid
 != -1) {

2005 ià(
scheduË
) {

2006 
£rv”
.
rdb_bg§ve_scheduËd
 = 1;

2007 
	`addR•lyStus
(
c
,"Background saving scheduled");

2009 
	`addR•lyE¼Ü
(
c
,

2014 } ià(
	`rdbSaveBackground
(
£rv”
.
rdb_f’ame
,
NULL
è=ğ
C_OK
) {

2015 
	`addR•lyStus
(
c
,"Background saving started");

2017 
	`addR•ly
(
c
,
sh¬ed
.
”r
);

2019 
	}
}

	@rdb.h

30 #iâdeà
__RDB_H


31 
	#__RDB_H


	)

33 
	~<¡dio.h
>

34 
	~"rio.h
"

37 
	~"£rv”.h
"

41 
	#RDB_VERSION
 8

	)

57 
	#RDB_6BITLEN
 0

	)

58 
	#RDB_14BITLEN
 1

	)

59 
	#RDB_32BITLEN
 0x80

	)

60 
	#RDB_64BITLEN
 0x81

	)

61 
	#RDB_ENCVAL
 3

	)

62 
	#RDB_LENERR
 
UINT64_MAX


	)

67 
	#RDB_ENC_INT8
 0

	)

68 
	#RDB_ENC_INT16
 1

	)

69 
	#RDB_ENC_INT32
 2

	)

70 
	#RDB_ENC_LZF
 3

	)

74 
	#RDB_TYPE_STRING
 0

	)

75 
	#RDB_TYPE_LIST
 1

	)

76 
	#RDB_TYPE_SET
 2

	)

77 
	#RDB_TYPE_ZSET
 3

	)

78 
	#RDB_TYPE_HASH
 4

	)

79 
	#RDB_TYPE_ZSET_2
 5

	)

80 
	#RDB_TYPE_MODULE
 6

	)

81 
	#RDB_TYPE_MODULE_2
 7

	)

86 
	#RDB_TYPE_HASH_ZIPMAP
 9

	)

87 
	#RDB_TYPE_LIST_ZIPLIST
 10

	)

88 
	#RDB_TYPE_SET_INTSET
 11

	)

89 
	#RDB_TYPE_ZSET_ZIPLIST
 12

	)

90 
	#RDB_TYPE_HASH_ZIPLIST
 13

	)

91 
	#RDB_TYPE_LIST_QUICKLIST
 14

	)

95 
	#rdbIsObjeùTy³
(
t
è(Ñ >ğ0 && <ğ7è|| (ˆ>ğ9 && <ğ14))

	)

98 
	#RDB_OPCODE_AUX
 250

	)

99 
	#RDB_OPCODE_RESIZEDB
 251

	)

100 
	#RDB_OPCODE_EXPIRETIME_MS
 252

	)

101 
	#RDB_OPCODE_EXPIRETIME
 253

	)

102 
	#RDB_OPCODE_SELECTDB
 254

	)

103 
	#RDB_OPCODE_EOF
 255

	)

106 
	#RDB_MODULE_OPCODE_EOF
 0

	)

107 
	#RDB_MODULE_OPCODE_SINT
 1

	)

108 
	#RDB_MODULE_OPCODE_UINT
 2

	)

109 
	#RDB_MODULE_OPCODE_FLOAT
 3

	)

110 
	#RDB_MODULE_OPCODE_DOUBLE
 4

	)

111 
	#RDB_MODULE_OPCODE_STRING
 5

	)

114 
	#RDB_LOAD_NONE
 0

	)

115 
	#RDB_LOAD_ENC
 (1<<0)

	)

116 
	#RDB_LOAD_PLAIN
 (1<<1)

	)

117 
	#RDB_LOAD_SDS
 (1<<2)

	)

119 
	#RDB_SAVE_NONE
 0

	)

120 
	#RDB_SAVE_AOF_PREAMBLE
 (1<<0)

	)

122 
rdbSaveTy³
(
rio
 *
rdb
, 
ty³
);

123 
rdbLßdTy³
(
rio
 *
rdb
);

124 
rdbSaveTime
(
rio
 *
rdb
, 
time_t
 
t
);

125 
time_t
 
rdbLßdTime
(
rio
 *
rdb
);

126 
rdbSaveL’
(
rio
 *
rdb
, 
ušt64_t
 
Ën
);

127 
ušt64_t
 
rdbLßdL’
(
rio
 *
rdb
, *
i£ncoded
);

128 
rdbLßdL’ByRef
(
rio
 *
rdb
, *
i£ncoded
, 
ušt64_t
 *
ËÅŒ
);

129 
rdbSaveObjeùTy³
(
rio
 *
rdb
, 
robj
 *
o
);

130 
rdbLßdObjeùTy³
(
rio
 *
rdb
);

131 
rdbLßd
(*
f’ame
, 
rdbSaveInfo
 *
rsi
);

132 
rdbSaveBackground
(*
f’ame
, 
rdbSaveInfo
 *
rsi
);

133 
rdbSaveToSÏvesSock‘s
(
rdbSaveInfo
 *
rsi
);

134 
rdbRemoveTempFe
(
pid_t
 
chdpid
);

135 
rdbSave
(*
f’ame
, 
rdbSaveInfo
 *
rsi
);

136 
ssize_t
 
rdbSaveObjeù
(
rio
 *
rdb
, 
robj
 *
o
);

137 
size_t
 
rdbSavedObjeùL’
(
robj
 *
o
);

138 
robj
 *
rdbLßdObjeù
(
ty³
, 
rio
 *
rdb
);

139 
backgroundSaveDÚeHªdËr
(
ex™code
, 
bysigÇl
);

140 
rdbSaveKeyV®uePaœ
(
rio
 *
rdb
, 
robj
 *
key
,„obj *
v®
, 
expœ‘ime
, 
now
);

141 
robj
 *
rdbLßdSŒšgObjeù
(
rio
 *
rdb
);

142 
rdbSaveSŒšgObjeù
(
rio
 *
rdb
, 
robj
 *
obj
);

143 
ssize_t
 
rdbSaveRawSŒšg
(
rio
 *
rdb
, *
s
, 
size_t
 
Ën
);

144 *
rdbG’”icLßdSŒšgObjeù
(
rio
 *
rdb
, 
æags
, 
size_t
 *
ËÅŒ
);

145 
rdbSaveBš¬yDoubËV®ue
(
rio
 *
rdb
, 
v®
);

146 
rdbLßdBš¬yDoubËV®ue
(
rio
 *
rdb
, *
v®
);

147 
rdbSaveBš¬yFlßtV®ue
(
rio
 *
rdb
, 
v®
);

148 
rdbLßdBš¬yFlßtV®ue
(
rio
 *
rdb
, *
v®
);

149 
rdbLßdRio
(
rio
 *
rdb
, 
rdbSaveInfo
 *
rsi
);

	@redis-benchmark.c

31 
	~"fmaüos.h
"

33 
	~<¡dio.h
>

34 
	~<¡ršg.h
>

35 
	~<¡dlib.h
>

36 
	~<uni¡d.h
>

37 
	~<”ºo.h
>

38 
	~<time.h
>

39 
	~<sys/time.h
>

40 
	~<sigÇl.h
>

41 
	~<as£¹.h
>

43 
	~<sds.h
>

44 
	~"«.h
"

45 
	~"hœedis.h
"

46 
	~"adli¡.h
"

47 
	~"zm®loc.h
"

49 
	#UNUSED
(
V
è((èV)

	)

50 
	#RANDPTR_INITIAL_SIZE
 8

	)

52 
	scÚfig
 {

53 
«Ev’tLoİ
 *
	m–
;

54 cÚ¡ *
	mho¡
;

55 
	mho¡pÜt
;

56 cÚ¡ *
	mho¡sock‘
;

57 
	mnumş›Ás
;

58 
	mliveş›Ás
;

59 
	m»que¡s
;

60 
	m»que¡s_issued
;

61 
	m»que¡s_fšished
;

62 
	mkeysize
;

63 
	md©asize
;

64 
	m¿ndomkeys
;

65 
	m¿ndomkeys_key¥aûËn
;

66 
	mk“·live
;

67 
	mp–še
;

68 
	mshow”rÜs
;

69 
	m¡¬t
;

70 
	mtÙÏ‹ncy
;

71 *
	mÏ‹ncy
;

72 cÚ¡ *
	mt™Ë
;

73 
li¡
 *
	mş›Ás
;

74 
	mqu›t
;

75 
	mcsv
;

76 
	mloİ
;

77 
	midËmode
;

78 
	mdbnum
;

79 
sds
 
	mdbnum¡r
;

80 *
	m‹¡s
;

81 *
	mauth
;

82 } 
	gcÚfig
;

84 
	s_ş›Á
 {

85 
»disCÚ‹xt
 *
	mcÚ‹xt
;

86 
sds
 
	mobuf
;

87 **
	m¿nd±r
;

88 
size_t
 
	m¿ndËn
;

89 
size_t
 
	m¿ndä“
;

90 
size_t
 
	mwr™‹n
;

91 
	m¡¬t
;

92 
	mÏ‹ncy
;

93 
	m³ndšg
;

94 
	m´efix_³ndšg
;

97 
	m´efixËn
;

98 } *
	tş›Á
;

101 
wr™eHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

102 
ü—‹MissšgCl›Ás
(
ş›Á
 
c
);

105 
	$u¡ime
() {

106 
timev®
 
tv
;

107 
u¡
;

109 
	`g‘timeofday
(&
tv
, 
NULL
);

110 
u¡
 = (()
tv
.
tv_£c
)*1000000;

111 
u¡
 +ğ
tv
.
tv_u£c
;

112  
u¡
;

113 
	}
}

115 
	$m¡ime
() {

116 
timev®
 
tv
;

117 
m¡
;

119 
	`g‘timeofday
(&
tv
, 
NULL
);

120 
m¡
 = (()
tv
.
tv_£c
)*1000;

121 
m¡
 +ğ
tv
.
tv_u£c
/1000;

122  
m¡
;

123 
	}
}

125 
	$ä“Cl›Á
(
ş›Á
 
c
) {

126 
li¡Node
 *
Ê
;

127 
	`«D–‘eFeEv’t
(
cÚfig
.
–
,
c
->
cÚ‹xt
->
fd
,
AE_WRITABLE
);

128 
	`«D–‘eFeEv’t
(
cÚfig
.
–
,
c
->
cÚ‹xt
->
fd
,
AE_READABLE
);

129 
	`»disF»e
(
c
->
cÚ‹xt
);

130 
	`sdsä“
(
c
->
obuf
);

131 
	`zä“
(
c
->
¿nd±r
);

132 
	`zä“
(
c
);

133 
cÚfig
.
liveş›Ás
--;

134 
Ê
 = 
	`li¡S—rchKey
(
cÚfig
.
ş›Ás
,
c
);

135 
	`as£¹
(
Ê
 !ğ
NULL
);

136 
	`li¡D–Node
(
cÚfig
.
ş›Ás
,
Ê
);

137 
	}
}

139 
	$ä“AÎCl›Ás
() {

140 
li¡Node
 *
Ê
 = 
cÚfig
.
ş›Ás
->
h—d
, *
Ãxt
;

142 
Ê
) {

143 
Ãxt
 = 
Ê
->next;

144 
	`ä“Cl›Á
(
Ê
->
v®ue
);

145 
Ê
 = 
Ãxt
;

147 
	}
}

149 
	$»£tCl›Á
(
ş›Á
 
c
) {

150 
	`«D–‘eFeEv’t
(
cÚfig
.
–
,
c
->
cÚ‹xt
->
fd
,
AE_WRITABLE
);

151 
	`«D–‘eFeEv’t
(
cÚfig
.
–
,
c
->
cÚ‹xt
->
fd
,
AE_READABLE
);

152 
	`«C»©eFeEv’t
(
cÚfig
.
–
,
c
->
cÚ‹xt
->
fd
,
AE_WRITABLE
,
wr™eHªdËr
,c);

153 
c
->
wr™‹n
 = 0;

154 
c
->
³ndšg
 = 
cÚfig
.
p–še
;

155 
	}
}

157 
	$¿ndomizeCl›ÁKey
(
ş›Á
 
c
) {

158 
size_t
 
i
;

160 
i
 = 0; i < 
c
->
¿ndËn
; i++) {

161 *
p
 = 
c
->
¿nd±r
[
i
]+11;

162 
size_t
 
r
 = 
	`¿ndom
(è% 
cÚfig
.
¿ndomkeys_key¥aûËn
;

163 
size_t
 
j
;

165 
j
 = 0; j < 12; j++) {

166 *
p
 = '0'+
r
%10;

167 
r
/=10;

168 
p
--;

171 
	}
}

173 
	$ş›ÁDÚe
(
ş›Á
 
c
) {

174 ià(
cÚfig
.
»que¡s_fšished
 =ğcÚfig.
»que¡s
) {

175 
	`ä“Cl›Á
(
c
);

176 
	`«Stİ
(
cÚfig
.
–
);

179 ià(
cÚfig
.
k“·live
) {

180 
	`»£tCl›Á
(
c
);

182 
cÚfig
.
liveş›Ás
--;

183 
	`ü—‹MissšgCl›Ás
(
c
);

184 
cÚfig
.
liveş›Ás
++;

185 
	`ä“Cl›Á
(
c
);

187 
	}
}

189 
	$»adHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

190 
ş›Á
 
c
 = 
´ivd©a
;

191 *
»¶y
 = 
NULL
;

192 
	`UNUSED
(
–
);

193 
	`UNUSED
(
fd
);

194 
	`UNUSED
(
mask
);

199 ià(
c
->
Ï‹ncy
 < 0èc->Ï‹ncy = 
	`u¡ime
()-(c->
¡¬t
);

201 ià(
	`»disBufãrR—d
(
c
->
cÚ‹xt
è!ğ
REDIS_OK
) {

202 
	`årštf
(
¡d”r
,"E¼Ü: %s\n",
c
->
cÚ‹xt
->
”r¡r
);

203 
	`ex™
(1);

205 
c
->
³ndšg
) {

206 ià(
	`»disG‘R•ly
(
c
->
cÚ‹xt
,&
»¶y
è!ğ
REDIS_OK
) {

207 
	`årštf
(
¡d”r
,"E¼Ü: %s\n",
c
->
cÚ‹xt
->
”r¡r
);

208 
	`ex™
(1);

210 ià(
»¶y
 !ğ
NULL
) {

211 ià(
»¶y
 =ğ(*)
REDIS_REPLY_ERROR
) {

212 
	`årštf
(
¡d”r
,"Unexpectedƒrror„eply,ƒxiting...\n");

213 
	`ex™
(1);

216 ià(
cÚfig
.
show”rÜs
) {

217 
time_t
 
Ï¡”r_time
 = 0;

218 
time_t
 
now
 = 
	`time
(
NULL
);

219 
»disR•ly
 *
r
 = 
»¶y
;

220 ià(
r
->
ty³
 =ğ
REDIS_REPLY_ERROR
 && 
Ï¡”r_time
 !ğ
now
) {

221 
Ï¡”r_time
 = 
now
;

222 
	`´štf
("E¼Ü from s”v”: %s\n", 
r
->
¡r
);

226 
	`ä“R•lyObjeù
(
»¶y
);

228 ià(
c
->
´efix_³ndšg
 > 0) {

229 
c
->
´efix_³ndšg
--;

230 
c
->
³ndšg
--;

232 ià(
c
->
´efixËn
 > 0) {

233 
size_t
 
j
;

234 
	`sd¤ªge
(
c
->
obuf
, c->
´efixËn
, -1);

237 
j
 = 0; j < 
c
->
¿ndËn
; j++)

238 
c
->
¿nd±r
[
j
] -ğc->
´efixËn
;

239 
c
->
´efixËn
 = 0;

244 ià(
cÚfig
.
»que¡s_fšished
 < cÚfig.
»que¡s
)

245 
cÚfig
.
Ï‹ncy
[cÚfig.
»que¡s_fšished
++] = 
c
->latency;

246 
c
->
³ndšg
--;

247 ià(
c
->
³ndšg
 == 0) {

248 
	`ş›ÁDÚe
(
c
);

256 
	}
}

258 
	$wr™eHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

259 
ş›Á
 
c
 = 
´ivd©a
;

260 
	`UNUSED
(
–
);

261 
	`UNUSED
(
fd
);

262 
	`UNUSED
(
mask
);

265 ià(
c
->
wr™‹n
 == 0) {

267 ià(
cÚfig
.
»que¡s_issued
++ >ğcÚfig.
»que¡s
) {

268 
	`ä“Cl›Á
(
c
);

273 ià(
cÚfig
.
¿ndomkeys
è
	`¿ndomizeCl›ÁKey
(
c
);

274 
c
->
¡¬t
 = 
	`u¡ime
();

275 
c
->
Ï‹ncy
 = -1;

278 ià(
	`sd¦’
(
c
->
obuf
è> c->
wr™‹n
) {

279 *
±r
 = 
c
->
obuf
+c->
wr™‹n
;

280 
ssize_t
 
nwr™‹n
 = 
	`wr™e
(
c
->
cÚ‹xt
->
fd
,
±r
,
	`sd¦’
(c->
obuf
)-c->
wr™‹n
);

281 ià(
nwr™‹n
 == -1) {

282 ià(
”ºo
 !ğ
EPIPE
)

283 
	`årštf
(
¡d”r
, "Wr™šgØsock‘: %s\n", 
	`¡»¼Ü
(
”ºo
));

284 
	`ä“Cl›Á
(
c
);

287 
c
->
wr™‹n
 +ğ
nwr™‹n
;

288 ià(
	`sd¦’
(
c
->
obuf
è=ğc->
wr™‹n
) {

289 
	`«D–‘eFeEv’t
(
cÚfig
.
–
,
c
->
cÚ‹xt
->
fd
,
AE_WRITABLE
);

290 
	`«C»©eFeEv’t
(
cÚfig
.
–
,
c
->
cÚ‹xt
->
fd
,
AE_READABLE
,
»adHªdËr
,c);

293 
	}
}

316 
ş›Á
 
	$ü—‹Cl›Á
(*
cmd
, 
size_t
 
Ën
, 
ş›Á
 
äom
) {

317 
j
;

318 
ş›Á
 
c
 = 
	`zm®loc
((
_ş›Á
));

320 ià(
cÚfig
.
ho¡sock‘
 =ğ
NULL
) {

321 
c
->
cÚ‹xt
 = 
	`»disCÚÃùNÚBlock
(
cÚfig
.
ho¡
,cÚfig.
ho¡pÜt
);

323 
c
->
cÚ‹xt
 = 
	`»disCÚÃùUnixNÚBlock
(
cÚfig
.
ho¡sock‘
);

325 ià(
c
->
cÚ‹xt
->
”r
) {

326 
	`årštf
(
¡d”r
,"Could‚ot connecto Redis‡t ");

327 ià(
cÚfig
.
ho¡sock‘
 =ğ
NULL
)

328 
	`årštf
(
¡d”r
,"%s:%d: %s\n",
cÚfig
.
ho¡
,cÚfig.
ho¡pÜt
,
c
->
cÚ‹xt
->
”r¡r
);

330 
	`årštf
(
¡d”r
,"%s: %s\n",
cÚfig
.
ho¡sock‘
,
c
->
cÚ‹xt
->
”r¡r
);

331 
	`ex™
(1);

334 
c
->
cÚ‹xt
->
»ad”
->
maxbuf
 = 0;

339 
c
->
obuf
 = 
	`sd£m±y
();

343 
c
->
´efix_³ndšg
 = 0;

344 ià(
cÚfig
.
auth
) {

345 *
buf
 = 
NULL
;

346 
Ën
 = 
	`»disFÜm©Commªd
(&
buf
, "AUTH %s", 
cÚfig
.
auth
);

347 
c
->
obuf
 = 
	`sdsÿ’
(c->obuf, 
buf
, 
Ën
);

348 
	`ä“
(
buf
);

349 
c
->
´efix_³ndšg
++;

356 ià(
cÚfig
.
dbnum
 != 0) {

357 
c
->
obuf
 = 
	`sdsÿrštf
(c->obuf,"*2\r\n$6\r\nSELECT\r\n$%d\r\n%s\r\n",

358 ()
	`sd¦’
(
cÚfig
.
dbnum¡r
),config.dbnumstr);

359 
c
->
´efix_³ndšg
++;

361 
c
->
´efixËn
 = 
	`sd¦’
(c->
obuf
);

363 ià(
äom
) {

364 
c
->
obuf
 = 
	`sdsÿ’
(c->obuf,

365 
äom
->
obuf
+äom->
´efixËn
,

366 
	`sd¦’
(
äom
->
obuf
)-äom->
´efixËn
);

368 
j
 = 0; j < 
cÚfig
.
p–še
; j++)

369 
c
->
obuf
 = 
	`sdsÿ’
(c->obuf,
cmd
,
Ën
);

372 
c
->
wr™‹n
 = 0;

373 
c
->
³ndšg
 = 
cÚfig
.
p–še
+c->
´efix_³ndšg
;

374 
c
->
¿nd±r
 = 
NULL
;

375 
c
->
¿ndËn
 = 0;

378 ià(
cÚfig
.
¿ndomkeys
) {

379 ià(
äom
) {

380 
c
->
¿ndËn
 = 
äom
->randlen;

381 
c
->
¿ndä“
 = 0;

382 
c
->
¿nd±r
 = 
	`zm®loc
((*)*c->
¿ndËn
);

384 
j
 = 0; j < ()
c
->
¿ndËn
; j++) {

385 
c
->
¿nd±r
[
j
] = c->
obuf
 + (
äom
->randptr[j]-from->obuf);

387 
c
->
¿nd±r
[
j
] +ğc->
´efixËn
 - 
äom
->prefixlen;

390 *
p
 = 
c
->
obuf
;

392 
c
->
¿ndËn
 = 0;

393 
c
->
¿ndä“
 = 
RANDPTR_INITIAL_SIZE
;

394 
c
->
¿nd±r
 = 
	`zm®loc
((*)*c->
¿ndä“
);

395 (
p
 = 
	`¡r¡r
Õ,"__¿nd_št__")è!ğ
NULL
) {

396 ià(
c
->
¿ndä“
 == 0) {

397 
c
->
¿nd±r
 = 
	`z»®loc
(c->¿nd±r,(*)*c->
¿ndËn
*2);

398 
c
->
¿ndä“
 +ğc->
¿ndËn
;

400 
c
->
¿nd±r
[c->
¿ndËn
++] = 
p
;

401 
c
->
¿ndä“
--;

402 
p
 += 12;

406 ià(
cÚfig
.
idËmode
 == 0)

407 
	`«C»©eFeEv’t
(
cÚfig
.
–
,
c
->
cÚ‹xt
->
fd
,
AE_WRITABLE
,
wr™eHªdËr
,c);

408 
	`li¡AddNodeTa
(
cÚfig
.
ş›Ás
,
c
);

409 
cÚfig
.
liveş›Ás
++;

410  
c
;

411 
	}
}

413 
	$ü—‹MissšgCl›Ás
(
ş›Á
 
c
) {

414 
n
 = 0;

416 
cÚfig
.
liveş›Ás
 < cÚfig.
numş›Ás
) {

417 
	`ü—‹Cl›Á
(
NULL
,0,
c
);

420 ià(++
n
 > 64) {

421 
	`u¦“p
(50000);

422 
n
 = 0;

425 
	}
}

427 
	$com·»L©’cy
(cÚ¡ *
a
, cÚ¡ *
b
) {

428  (*(*)
a
)-(*(*)
b
);

429 
	}
}

431 
	$showL©’cyR•Üt
() {

432 
i
, 
cu¾©
 = 0;

433 
³rc
, 
»q³r£c
;

435 
»q³r£c
 = ()
cÚfig
.
»que¡s_fšished
/(()cÚfig.
tÙÏ‹ncy
/1000);

436 ià(!
cÚfig
.
qu›t
 && !cÚfig.
csv
) {

437 
	`´štf
("=====ğ% ======\n", 
cÚfig
.
t™Ë
);

438 
	`´štf
(" %d„eque¡ com¶‘ed iÀ%.2à£cÚds\n", 
cÚfig
.
»que¡s_fšished
,

439 ()
cÚfig
.
tÙÏ‹ncy
/1000);

440 
	`´štf
(" %d…¬®ËÈş›Ás\n", 
cÚfig
.
numş›Ás
);

441 
	`´štf
(" %d by‹ ·ylßd\n", 
cÚfig
.
d©asize
);

442 
	`´štf
(" k“°®ive: %d\n", 
cÚfig
.
k“·live
);

443 
	`´štf
("\n");

445 
	`qsÜt
(
cÚfig
.
Ï‹ncy
,cÚfig.
»que¡s
,(),
com·»L©’cy
);

446 
i
 = 0; i < 
cÚfig
.
»que¡s
; i++) {

447 ià(
cÚfig
.
Ï‹ncy
[
i
]/1000 !ğ
cu¾©
 || i =ğ(cÚfig.
»que¡s
-1)) {

448 
cu¾©
 = 
cÚfig
.
Ï‹ncy
[
i
]/1000;

449 
³rc
 = (()(
i
+1)*100)/
cÚfig
.
»que¡s
;

450 
	`´štf
("%.2f%% <ğ%d mli£cÚds\n", 
³rc
, 
cu¾©
);

453 
	`´štf
("%.2à»que¡ ³¸£cÚd\n\n", 
»q³r£c
);

454 } ià(
cÚfig
.
csv
) {

455 
	`´štf
("\"%s\",\"%.2f\"\n", 
cÚfig
.
t™Ë
, 
»q³r£c
);

457 
	`´štf
("%s: %.2à»que¡ ³¸£cÚd\n", 
cÚfig
.
t™Ë
, 
»q³r£c
);

459 
	}
}

461 
	$b’chm¬k
(*
t™Ë
, *
cmd
, 
Ën
) {

462 
ş›Á
 
c
;

464 
cÚfig
.
t™Ë
 =itle;

465 
cÚfig
.
»que¡s_issued
 = 0;

466 
cÚfig
.
»que¡s_fšished
 = 0;

468 
c
 = 
	`ü—‹Cl›Á
(
cmd
,
Ën
,
NULL
);

469 
	`ü—‹MissšgCl›Ás
(
c
);

471 
cÚfig
.
¡¬t
 = 
	`m¡ime
();

472 
	`«Maš
(
cÚfig
.
–
);

473 
cÚfig
.
tÙÏ‹ncy
 = 
	`m¡ime
()-cÚfig.
¡¬t
;

475 
	`showL©’cyR•Üt
();

476 
	`ä“AÎCl›Ás
();

477 
	}
}

480 
	$·r£O±iÚs
(
¬gc
, cÚ¡ **
¬gv
) {

481 
i
;

482 
Ï¡¬g
;

483 
ex™_¡©us
 = 1;

485 
i
 = 1; i < 
¬gc
; i++) {

486 
Ï¡¬g
 = (
i
 =ğ(
¬gc
-1));

488 ià(!
	`¡rcmp
(
¬gv
[
i
],"-c")) {

489 ià(
Ï¡¬g
è
šv®id
;

490 
cÚfig
.
numş›Ás
 = 
	`©oi
(
¬gv
[++
i
]);

491 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-n")) {

492 ià(
Ï¡¬g
è
šv®id
;

493 
cÚfig
.
»que¡s
 = 
	`©oi
(
¬gv
[++
i
]);

494 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-k")) {

495 ià(
Ï¡¬g
è
šv®id
;

496 
cÚfig
.
k“·live
 = 
	`©oi
(
¬gv
[++
i
]);

497 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-h")) {

498 ià(
Ï¡¬g
è
šv®id
;

499 
cÚfig
.
ho¡
 = 
	`¡rdup
(
¬gv
[++
i
]);

500 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-p")) {

501 ià(
Ï¡¬g
è
šv®id
;

502 
cÚfig
.
ho¡pÜt
 = 
	`©oi
(
¬gv
[++
i
]);

503 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-s")) {

504 ià(
Ï¡¬g
è
šv®id
;

505 
cÚfig
.
ho¡sock‘
 = 
	`¡rdup
(
¬gv
[++
i
]);

506 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-a") ) {

507 ià(
Ï¡¬g
è
šv®id
;

508 
cÚfig
.
auth
 = 
	`¡rdup
(
¬gv
[++
i
]);

509 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-d")) {

510 ià(
Ï¡¬g
è
šv®id
;

511 
cÚfig
.
d©asize
 = 
	`©oi
(
¬gv
[++
i
]);

512 ià(
cÚfig
.
d©asize
 < 1) config.datasize=1;

513 ià(
cÚfig
.
d©asize
 > 1024*1024*1024) config.datasize = 1024*1024*1024;

514 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-P")) {

515 ià(
Ï¡¬g
è
šv®id
;

516 
cÚfig
.
p–še
 = 
	`©oi
(
¬gv
[++
i
]);

517 ià(
cÚfig
.
p–še
 <= 0) config.pipeline=1;

518 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-r")) {

519 ià(
Ï¡¬g
è
šv®id
;

520 
cÚfig
.
¿ndomkeys
 = 1;

521 
cÚfig
.
¿ndomkeys_key¥aûËn
 = 
	`©oi
(
¬gv
[++
i
]);

522 ià(
cÚfig
.
¿ndomkeys_key¥aûËn
 < 0)

523 
cÚfig
.
¿ndomkeys_key¥aûËn
 = 0;

524 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-q")) {

525 
cÚfig
.
qu›t
 = 1;

526 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--csv")) {

527 
cÚfig
.
csv
 = 1;

528 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-l")) {

529 
cÚfig
.
loİ
 = 1;

530 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-I")) {

531 
cÚfig
.
idËmode
 = 1;

532 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-e")) {

533 
cÚfig
.
show”rÜs
 = 1;

534 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-t")) {

535 ià(
Ï¡¬g
è
šv®id
;

541 
cÚfig
.
‹¡s
 = 
	`sd¢ew
(",");

542 
cÚfig
.
‹¡s
 = 
	`sdsÿt
(cÚfig.‹¡s,(*)
¬gv
[++
i
]);

543 
cÚfig
.
‹¡s
 = 
	`sdsÿt
(config.tests,",");

544 
	`sd¡Şow”
(
cÚfig
.
‹¡s
);

545 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--dbnum")) {

546 ià(
Ï¡¬g
è
šv®id
;

547 
cÚfig
.
dbnum
 = 
	`©oi
(
¬gv
[++
i
]);

548 
cÚfig
.
dbnum¡r
 = 
	`sdsäomlÚglÚg
(cÚfig.
dbnum
);

549 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--help")) {

550 
ex™_¡©us
 = 0;

551 
u§ge
;

556 ià(
¬gv
[
i
][0] =ğ'-'è
šv®id
;

557  
i
;

561  
i
;

563 
šv®id
:

564 
	`´štf
("Inv®id o±iÚ \"%s\" o¸İtiÚ‡rgum’ˆmissšg\n\n",
¬gv
[
i
]);

566 
u§ge
:

567 
	`´štf
(

609 
	`ex™
(
ex™_¡©us
);

610 
	}
}

612 
	$showThroughput
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
) {

613 
	`UNUSED
(
ev’tLoİ
);

614 
	`UNUSED
(
id
);

615 
	`UNUSED
(
ş›ÁD©a
);

617 ià(
cÚfig
.
liveş›Ás
 == 0) {

618 
	`årštf
(
¡d”r
,"All clients disconnected...‡borting.\n");

619 
	`ex™
(1);

621 ià(
cÚfig
.
csv
)  250;

622 ià(
cÚfig
.
idËmode
 == 1) {

623 
	`´štf
("ş›Ás: %d\r", 
cÚfig
.
liveş›Ás
);

624 
	`fæush
(
¡dout
);

627 
dt
 = ()(
	`m¡ime
()-
cÚfig
.
¡¬t
)/1000.0;

628 
½s
 = ()
cÚfig
.
»que¡s_fšished
/
dt
;

629 
	`´štf
("%s: %.2f\r", 
cÚfig
.
t™Ë
, 
½s
);

630 
	`fæush
(
¡dout
);

632 
	}
}

636 
	$‹¡_is_£Ëùed
(*
Çme
) {

637 
buf
[256];

638 
l
 = 
	`¡¾’
(
Çme
);

640 ià(
cÚfig
.
‹¡s
 =ğ
NULL
)  1;

641 
buf
[0] = ',';

642 
	`memıy
(
buf
+1,
Çme
,
l
);

643 
buf
[
l
+1] = ',';

644 
buf
[
l
+2] = '\0';

645  
	`¡r¡r
(
cÚfig
.
‹¡s
,
buf
è!ğ
NULL
;

646 
	}
}

648 
	$maš
(
¬gc
, cÚ¡ **
¬gv
) {

649 
i
;

650 *
d©a
, *
cmd
;

651 
Ën
;

653 
ş›Á
 
c
;

655 
	`¤ªdom
(
	`time
(
NULL
));

656 
	`sigÇl
(
SIGHUP
, 
SIG_IGN
);

657 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

659 
cÚfig
.
numş›Ás
 = 50;

660 
cÚfig
.
»que¡s
 = 100000;

661 
cÚfig
.
liveş›Ás
 = 0;

662 
cÚfig
.
–
 = 
	`«C»©eEv’tLoİ
(1024*10);

663 
	`«C»©eTimeEv’t
(
cÚfig
.
–
,1,
showThroughput
,
NULL
,NULL);

664 
cÚfig
.
k“·live
 = 1;

665 
cÚfig
.
d©asize
 = 3;

666 
cÚfig
.
p–še
 = 1;

667 
cÚfig
.
show”rÜs
 = 0;

668 
cÚfig
.
¿ndomkeys
 = 0;

669 
cÚfig
.
¿ndomkeys_key¥aûËn
 = 0;

670 
cÚfig
.
qu›t
 = 0;

671 
cÚfig
.
csv
 = 0;

672 
cÚfig
.
loİ
 = 0;

673 
cÚfig
.
idËmode
 = 0;

674 
cÚfig
.
Ï‹ncy
 = 
NULL
;

675 
cÚfig
.
ş›Ás
 = 
	`li¡C»©e
();

676 
cÚfig
.
ho¡
 = "127.0.0.1";

677 
cÚfig
.
ho¡pÜt
 = 6379;

678 
cÚfig
.
ho¡sock‘
 = 
NULL
;

679 
cÚfig
.
‹¡s
 = 
NULL
;

680 
cÚfig
.
dbnum
 = 0;

681 
cÚfig
.
auth
 = 
NULL
;

683 
i
 = 
	`·r£O±iÚs
(
¬gc
,
¬gv
);

684 
¬gc
 -ğ
i
;

685 
¬gv
 +ğ
i
;

687 
cÚfig
.
Ï‹ncy
 = 
	`zm®loc
(()*cÚfig.
»que¡s
);

689 ià(
cÚfig
.
k“·live
 == 0) {

690 
	`´štf
("WARNING: keepalive disabled, you…robably‚eed 'echo 1 > /proc/sys/net/ipv4/tcp_tw_reuse' for Linux‡nd 'sudo sysctl -w‚et.inet.tcp.msl=1000' for Mac OS X in ordero use‡†ot of clients/requests\n");

693 ià(
cÚfig
.
idËmode
) {

694 
	`´štf
("C»©šg %d idË cÚÃùiÚ ªd wa™šg fÜev” (CŒl+C wh’ dÚe)\n", 
cÚfig
.
numş›Ás
);

695 
c
 = 
	`ü—‹Cl›Á
("",0,
NULL
);

696 
	`ü—‹MissšgCl›Ás
(
c
);

697 
	`«Maš
(
cÚfig
.
–
);

702 ià(
¬gc
) {

703 
sds
 
t™Ë
 = 
	`sd¢ew
(
¬gv
[0]);

704 
i
 = 1; i < 
¬gc
; i++) {

705 
t™Ë
 = 
	`sdsÿ’
(title, " ", 1);

706 
t™Ë
 = 
	`sdsÿ’
Ñ™Ë, (*)
¬gv
[
i
], 
	`¡¾’
(argv[i]));

710 
Ën
 = 
	`»disFÜm©CommªdArgv
(&
cmd
,
¬gc
,
¬gv
,
NULL
);

711 
	`b’chm¬k
(
t™Ë
,
cmd
,
Ën
);

712 
	`ä“
(
cmd
);

713 } 
cÚfig
.
loİ
);

719 
d©a
 = 
	`zm®loc
(
cÚfig
.
d©asize
+1);

721 
	`mem£t
(
d©a
,'x',
cÚfig
.
d©asize
);

722 
d©a
[
cÚfig
.
d©asize
] = '\0';

724 ià(
	`‹¡_is_£Ëùed
("ping_inline") ||est_is_selected("ping"))

725 
	`b’chm¬k
("PING_INLINE","PING\r\n",6);

727 ià(
	`‹¡_is_£Ëùed
("ping_mbulk") ||est_is_selected("ping")) {

728 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"PING");

729 
	`b’chm¬k
("PING_BULK",
cmd
,
Ën
);

730 
	`ä“
(
cmd
);

733 ià(
	`‹¡_is_£Ëùed
("set")) {

734 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"SET key:__¿nd_št__ %s",
d©a
);

735 
	`b’chm¬k
("SET",
cmd
,
Ën
);

736 
	`ä“
(
cmd
);

739 ià(
	`‹¡_is_£Ëùed
("get")) {

740 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"GET key:__rand_int__");

741 
	`b’chm¬k
("GET",
cmd
,
Ën
);

742 
	`ä“
(
cmd
);

745 ià(
	`‹¡_is_£Ëùed
("incr")) {

746 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"INCR counter:__rand_int__");

747 
	`b’chm¬k
("INCR",
cmd
,
Ën
);

748 
	`ä“
(
cmd
);

751 ià(
	`‹¡_is_£Ëùed
("lpush")) {

752 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LPUSH myli¡ %s",
d©a
);

753 
	`b’chm¬k
("LPUSH",
cmd
,
Ën
);

754 
	`ä“
(
cmd
);

757 ià(
	`‹¡_is_£Ëùed
("rpush")) {

758 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"RPUSH myli¡ %s",
d©a
);

759 
	`b’chm¬k
("RPUSH",
cmd
,
Ën
);

760 
	`ä“
(
cmd
);

763 ià(
	`‹¡_is_£Ëùed
("lpop")) {

764 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LPOP mylist");

765 
	`b’chm¬k
("LPOP",
cmd
,
Ën
);

766 
	`ä“
(
cmd
);

769 ià(
	`‹¡_is_£Ëùed
("rpop")) {

770 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"RPOP mylist");

771 
	`b’chm¬k
("RPOP",
cmd
,
Ën
);

772 
	`ä“
(
cmd
);

775 ià(
	`‹¡_is_£Ëùed
("sadd")) {

776 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,

778 
	`b’chm¬k
("SADD",
cmd
,
Ën
);

779 
	`ä“
(
cmd
);

782 ià(
	`‹¡_is_£Ëùed
("hset")) {

783 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,

784 "HSET my£t:__¿nd_št__ƒËm’t:__¿nd_št__ %s",
d©a
);

785 
	`b’chm¬k
("HSET",
cmd
,
Ën
);

786 
	`ä“
(
cmd
);

789 ià(
	`‹¡_is_£Ëùed
("spop")) {

790 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"SPOP myset");

791 
	`b’chm¬k
("SPOP",
cmd
,
Ën
);

792 
	`ä“
(
cmd
);

795 ià(
	`‹¡_is_£Ëùed
("lrange") ||

796 
	`‹¡_is_£Ëùed
("lrange_100") ||

797 
	`‹¡_is_£Ëùed
("lrange_300") ||

798 
	`‹¡_is_£Ëùed
("lrange_500") ||

799 
	`‹¡_is_£Ëùed
("lrange_600"))

801 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LPUSH myli¡ %s",
d©a
);

802 
	`b’chm¬k
("LPUSH (ÃededØb’chm¬k LRANGE)",
cmd
,
Ën
);

803 
	`ä“
(
cmd
);

806 ià(
	`‹¡_is_£Ëùed
("lrange") ||est_is_selected("lrange_100")) {

807 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LRANGE mylist 0 99");

808 
	`b’chm¬k
("LRANGE_100 (fœ¡ 100ƒËm’ts)",
cmd
,
Ën
);

809 
	`ä“
(
cmd
);

812 ià(
	`‹¡_is_£Ëùed
("lrange") ||est_is_selected("lrange_300")) {

813 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LRANGE mylist 0 299");

814 
	`b’chm¬k
("LRANGE_300 (fœ¡ 300ƒËm’ts)",
cmd
,
Ën
);

815 
	`ä“
(
cmd
);

818 ià(
	`‹¡_is_£Ëùed
("lrange") ||est_is_selected("lrange_500")) {

819 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LRANGE mylist 0 449");

820 
	`b’chm¬k
("LRANGE_500 (fœ¡ 450ƒËm’ts)",
cmd
,
Ën
);

821 
	`ä“
(
cmd
);

824 ià(
	`‹¡_is_£Ëùed
("lrange") ||est_is_selected("lrange_600")) {

825 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LRANGE mylist 0 599");

826 
	`b’chm¬k
("LRANGE_600 (fœ¡ 600ƒËm’ts)",
cmd
,
Ën
);

827 
	`ä“
(
cmd
);

830 ià(
	`‹¡_is_£Ëùed
("mset")) {

831 cÚ¡ *
¬gv
[21];

832 
¬gv
[0] = "MSET";

833 
i
 = 1; i < 21; i += 2) {

834 
¬gv
[
i
] = "key:__rand_int__";

835 
¬gv
[
i
+1] = 
d©a
;

837 
Ën
 = 
	`»disFÜm©CommªdArgv
(&
cmd
,21,
¬gv
,
NULL
);

838 
	`b’chm¬k
("MSET (10 keys)",
cmd
,
Ën
);

839 
	`ä“
(
cmd
);

842 ià(!
cÚfig
.
csv
è
	`´štf
("\n");

843 } 
cÚfig
.
loİ
);

846 
	}
}

	@redis-check-aof.c

31 
	~"£rv”.h
"

32 
	~<sys/¡©.h
>

34 
	#ERROR
(...) { \

35 
__buf
[1024]; \

36 
	`¥rštf
(
__buf
, 
__VA_ARGS__
); \

37 
	`¥rštf
(
”rÜ
, "0x%16Îx: %s", ()
•os
, 
__buf
); \

38 }

	)

40 
	g”rÜ
[1024];

41 
off_t
 
	g•os
;

43 
	$cÚsumeNewlše
(*
buf
) {

44 ià(
	`¡ºcmp
(
buf
,"\r\n",2) != 0) {

45 
	`ERROR
("Ex³ùed \\r\\n, gÙ: %02x%02x",
buf
[0],buf[1]);

49 
	}
}

51 
	$»adLÚg
(
FILE
 *
å
, 
´efix
, *
rg‘
) {

52 
buf
[128], *
•Œ
;

53 
•os
 = 
	`á–lo
(
å
);

54 ià(
	`fg‘s
(
buf
,(buf),
å
è=ğ
NULL
) {

57 ià(
buf
[0] !ğ
´efix
) {

58 
	`ERROR
("Ex³ùed…»fix '%c', gÙ: '%c'",
´efix
,
buf
[0]);

61 *
rg‘
 = 
	`¡¹Ş
(
buf
+1,&
•Œ
,10);

62  
	`cÚsumeNewlše
(
•Œ
);

63 
	}
}

65 
	$»adBy‹s
(
FILE
 *
å
, *
rg‘
, 
Ëngth
) {

66 
»®
;

67 
•os
 = 
	`á–lo
(
å
);

68 
»®
 = 
	`ä—d
(
rg‘
,1,
Ëngth
,
å
);

69 ià(
»®
 !ğ
Ëngth
) {

70 
	`ERROR
("Ex³ùedØ»ad %ld by‹s, gÙ %ld by‹s",
Ëngth
,
»®
);

74 
	}
}

76 
	$»adSŒšg
(
FILE
 *
å
, ** 
rg‘
) {

77 
Ën
;

78 *
rg‘
 = 
NULL
;

79 ià(!
	`»adLÚg
(
å
,'$',&
Ën
)) {

84 
Ën
 += 2;

85 *
rg‘
 = (*)
	`zm®loc
(
Ën
);

86 ià(!
	`»adBy‹s
(
å
,*
rg‘
,
Ën
)) {

89 ià(!
	`cÚsumeNewlše
(*
rg‘
+
Ën
-2)) {

92 (*
rg‘
)[
Ën
-2] = '\0';

94 
	}
}

96 
	$»adArgc
(
FILE
 *
å
, *
rg‘
) {

97  
	`»adLÚg
(
å
,'*',
rg‘
);

98 
	}
}

100 
off_t
 
	$´oûss
(
FILE
 *
å
) {

101 
¬gc
;

102 
off_t
 
pos
 = 0;

103 
i
, 
muÉi
 = 0;

104 *
¡r
;

107 ià(!
muÉi
è
pos
 = 
	`á–lo
(
å
);

108 ià(!
	`»adArgc
(
å
, &
¬gc
)) ;

110 
i
 = 0; i < 
¬gc
; i++) {

111 ià(!
	`»adSŒšg
(
å
,&
¡r
)) ;

112 ià(
i
 == 0) {

113 ià(
	`¡rÿ£cmp
(
¡r
, "multi") == 0) {

114 ià(
muÉi
++) {

115 
	`ERROR
("Unexpected MULTI");

118 } ià(
	`¡rÿ£cmp
(
¡r
, "exec") == 0) {

119 ià(--
muÉi
) {

120 
	`ERROR
("Unexpected EXEC");

125 
	`zä“
(
¡r
);

129 ià(
i
 < 
¬gc
) {

130 ià(
¡r
è
	`zä“
(str);

135 ià(
	`ãof
(
å
è&& 
muÉi
 && 
	`¡¾’
(
”rÜ
) == 0) {

136 
	`ERROR
("Reached EOF before„eading EXEC for MULTI");

138 ià(
	`¡¾’
(
”rÜ
) > 0) {

139 
	`´štf
("%s\n", 
”rÜ
);

141  
pos
;

142 
	}
}

144 
	$»dis_check_aof_maš
(
¬gc
, **
¬gv
) {

145 *
f’ame
;

146 
fix
 = 0;

148 ià(
¬gc
 < 2) {

149 
	`´štf
("U§ge: % [--fix] <fe.aof>\n", 
¬gv
[0]);

150 
	`ex™
(1);

151 } ià(
¬gc
 == 2) {

152 
f’ame
 = 
¬gv
[1];

153 } ià(
¬gc
 == 3) {

154 ià(
	`¡rcmp
(
¬gv
[1],"--fix") != 0) {

155 
	`´štf
("Inv®id‡rgum’t: %s\n", 
¬gv
[1]);

156 
	`ex™
(1);

158 
f’ame
 = 
¬gv
[2];

159 
fix
 = 1;

161 
	`´štf
("Invalid‡rguments\n");

162 
	`ex™
(1);

165 
FILE
 *
å
 = 
	`fİ’
(
f’ame
,"r+");

166 ià(
å
 =ğ
NULL
) {

167 
	`´štf
("CªnÙ o³Àfe: %s\n", 
f’ame
);

168 
	`ex™
(1);

171 
»dis_¡©
 
sb
;

172 ià(
	`»dis_f¡©
(
	`f’o
(
å
),&
sb
) == -1) {

173 
	`´štf
("CªnÙ sˆfe: %s\n", 
f’ame
);

174 
	`ex™
(1);

177 
off_t
 
size
 = 
sb
.
¡_size
;

178 ià(
size
 == 0) {

179 
	`´štf
("Em±y fe: %s\n", 
f’ame
);

180 
	`ex™
(1);

185 ià(
size
 >= 8) {

186 
sig
[5];

187 
has_´—mbË
 = 
	`ä—d
(
sig
,(sig),1,
å
) == 1 &&

188 
	`memcmp
(
sig
,"REDIS",(sig)) == 0;

189 
	`»wšd
(
å
);

190 ià(
has_´—mbË
) {

191 
	`´štf
("The AOF‡ppearso start with‡n RDB…reamble.\n"

193 ià(
	`»dis_check_rdb_maš
(
¬gc
,
¬gv
,
å
è=ğ
C_ERR
) {

194 
	`´štf
("RDB…reamble of AOF file is‚ot sane,‡borting.\n");

195 
	`ex™
(1);

197 
	`´štf
("RDB…reamble is OK,…roceeding with AOFail...\n");

202 
off_t
 
pos
 = 
	`´oûss
(
å
);

203 
off_t
 
diff
 = 
size
-
pos
;

204 
	`´štf
("AOF‡nalyzed: size=%lld, ok_up_to=%lld, diff=%lld\n",

205 (è
size
, (è
pos
, (è
diff
);

206 ià(
diff
 > 0) {

207 ià(
fix
) {

208 
buf
[2];

209 
	`´štf
("Thi wÈshrškhAOF from %Îd by‹s, w™h %Îd by‹s,Ø%Îd by‹s\n",()
size
,()
diff
,()
pos
);

210 
	`´štf
("Continue? [y/N]: ");

211 ià(
	`fg‘s
(
buf
,(buf),
¡dš
è=ğ
NULL
 ||

212 
	`¡ºÿ£cmp
(
buf
,"y",1) != 0) {

213 
	`´štf
("Aborting...\n");

214 
	`ex™
(1);

216 ià(
	`árunÿ‹
(
	`f’o
(
å
), 
pos
) == -1) {

217 
	`´štf
("Failedoruncate AOF\n");

218 
	`ex™
(1);

220 
	`´štf
("Successfullyruncated AOF\n");

223 
	`´štf
("AOF is‚ot valid. "

225 
	`ex™
(1);

228 
	`´štf
("AOF is valid\n");

231 
	`fşo£
(
å
);

232 
	`ex™
(0);

233 
	}
}

	@redis-check-rdb.c

30 
	~"£rv”.h
"

31 
	~"rdb.h
"

33 
	~<¡d¬g.h
>

35 
ü—‹Sh¬edObjeùs
();

36 
rdbLßdProg»ssC®lback
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
);

37 
rdbLßdMli£cÚdTime
(
rio
 *
rdb
);

38 
	grdbCheckMode
 = 0;

41 
rio
 *
	mrio
;

42 
robj
 *
	mkey
;

43 
	mkey_ty³
;

44 
	mkeys
;

45 
	mexpœes
;

46 
	m®»ady_expœed
;

47 
	mdošg
;

48 
	m”rÜ_£t
;

49 
	m”rÜ
[1024];

50 } 
	grdb¡©e
;

54 
	#RDB_CHECK_DOING_START
 0

	)

55 
	#RDB_CHECK_DOING_READ_TYPE
 1

	)

56 
	#RDB_CHECK_DOING_READ_EXPIRE
 2

	)

57 
	#RDB_CHECK_DOING_READ_KEY
 3

	)

58 
	#RDB_CHECK_DOING_READ_OBJECT_VALUE
 4

	)

59 
	#RDB_CHECK_DOING_CHECK_SUM
 5

	)

60 
	#RDB_CHECK_DOING_READ_LEN
 6

	)

61 
	#RDB_CHECK_DOING_READ_AUX
 7

	)

63 *
	grdb_check_došg_¡ršg
[] = {

74 *
	grdb_ty³_¡ršg
[] = {

92 
	$rdbShowG’”icInfo
() {

93 
	`´štf
("[šfo] %lu key »ad\n", 
rdb¡©e
.
keys
);

94 
	`´štf
("[šfo] %luƒxpœes\n", 
rdb¡©e
.
expœes
);

95 
	`´štf
("[šfo] %lu‡Ì—dyƒxpœed\n", 
rdb¡©e
.
®»ady_expœed
);

96 
	}
}

100 
	$rdbCheckE¼Ü
(cÚ¡ *
fmt
, ...) {

101 
msg
[1024];

102 
va_li¡
 
­
;

104 
	`va_¡¬t
(
­
, 
fmt
);

105 
	`v¢´štf
(
msg
, (msg), 
fmt
, 
­
);

106 
	`va_’d
(
­
);

108 
	`´štf
("--- RDB ERROR DETECTED ---\n");

109 
	`´štf
("[offset %llu] %s\n",

110 (è(
rdb¡©e
.
rio
 ?

111 
rdb¡©e
.
rio
->
´oûs£d_by‹s
 : 0), 
msg
);

112 
	`´štf
("[additional info] While doing: %s\n",

113 
rdb_check_došg_¡ršg
[
rdb¡©e
.
došg
]);

114 ià(
rdb¡©e
.
key
)

115 
	`´štf
("[additional info] Reading key '%s'\n",

116 (*)
rdb¡©e
.
key
->
±r
);

117 ià(
rdb¡©e
.
key_ty³
 != -1)

118 
	`´štf
("[additional info] Readingype %d (%s)\n",

119 
rdb¡©e
.
key_ty³
,

120 (()
rdb¡©e
.
key_ty³
 <

121 (
rdb_ty³_¡ršg
)/(*)) ?

122 
rdb_ty³_¡ršg
[
rdb¡©e
.
key_ty³
] : "unknown");

123 
	`rdbShowG’”icInfo
();

124 
	}
}

127 
	$rdbCheckInfo
(cÚ¡ *
fmt
, ...) {

128 
msg
[1024];

129 
va_li¡
 
­
;

131 
	`va_¡¬t
(
­
, 
fmt
);

132 
	`v¢´štf
(
msg
, (msg), 
fmt
, 
­
);

133 
	`va_’d
(
­
);

135 
	`´štf
("[offset %llu] %s\n",

136 (è(
rdb¡©e
.
rio
 ?

137 
rdb¡©e
.
rio
->
´oûs£d_by‹s
 : 0), 
msg
);

138 
	}
}

142 
	$rdbCheckS‘E¼Ü
(cÚ¡ *
fmt
, ...) {

143 
va_li¡
 
­
;

145 
	`va_¡¬t
(
­
, 
fmt
);

146 
	`v¢´štf
(
rdb¡©e
.
”rÜ
, Ôdb¡©e.”rÜ), 
fmt
, 
­
);

147 
	`va_’d
(
­
);

148 
rdb¡©e
.
”rÜ_£t
 = 1;

149 
	}
}

154 
	$rdbCheckHªdËC¿sh
(
sig
, 
sigšfo_t
 *
šfo
, *
£ü‘
) {

155 
	`UNUSED
(
sig
);

156 
	`UNUSED
(
šfo
);

157 
	`UNUSED
(
£ü‘
);

159 
	`rdbCheckE¼Ü
("Server crash checkinghe specified RDB file!");

160 
	`ex™
(1);

161 
	}
}

163 
	$rdbCheckS‘upSigÇls
() {

164 
sigaùiÚ
 
aù
;

166 
	`sigem±y£t
(&
aù
.
§_mask
);

167 
aù
.
§_æags
 = 
SA_NODEFER
 | 
SA_RESETHAND
 | 
SA_SIGINFO
;

168 
aù
.
§_sigaùiÚ
 = 
rdbCheckHªdËC¿sh
;

169 
	`sigaùiÚ
(
SIGSEGV
, &
aù
, 
NULL
);

170 
	`sigaùiÚ
(
SIGBUS
, &
aù
, 
NULL
);

171 
	`sigaùiÚ
(
SIGFPE
, &
aù
, 
NULL
);

172 
	`sigaùiÚ
(
SIGILL
, &
aù
, 
NULL
);

173 
	}
}

179 
	$»dis_check_rdb
(*
rdbf’ame
, 
FILE
 *
å
) {

180 
ušt64_t
 
dbid
;

181 
ty³
, 
rdbv”
;

182 
buf
[1024];

183 
expœ‘ime
, 
now
 = 
	`m¡ime
();

184 
rio
 
rdb
;

186 
şo£fe
 = (
å
 =ğ
NULL
);

187 ià(
å
 =ğ
NULL
 && (å = 
	`fİ’
(
rdbf’ame
,"r")) == NULL)  1;

189 
	`rioIn™W™hFe
(&
rdb
,
å
);

190 
rdb¡©e
.
rio
 = &
rdb
;

191 
rdb
.
upd©e_cksum
 = 
rdbLßdProg»ssC®lback
;

192 ià(
	`rioR—d
(&
rdb
,
buf
,9è=ğ0è
eoã¼
;

193 
buf
[9] = '\0';

194 ià(
	`memcmp
(
buf
,"REDIS",5) != 0) {

195 
	`rdbCheckE¼Ü
("Wrong signatureryingo†oad DB from file");

198 
rdbv”
 = 
	`©oi
(
buf
+5);

199 ià(
rdbv”
 < 1 ||„dbv” > 
RDB_VERSION
) {

200 
	`rdbCheckE¼Ü
("Cª'ˆhªdË RDB fÜm© v”siÚ %d",
rdbv”
);

204 
	`¡¬tLßdšg
(
å
);

206 
robj
 *
key
, *
v®
;

207 
expœ‘ime
 = -1;

210 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_READ_TYPE
;

211 ià((
ty³
 = 
	`rdbLßdTy³
(&
rdb
)è=ğ-1è
eoã¼
;

214 ià(
ty³
 =ğ
RDB_OPCODE_EXPIRETIME
) {

215 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_READ_EXPIRE
;

219 ià((
expœ‘ime
 = 
	`rdbLßdTime
(&
rdb
)è=ğ-1è
eoã¼
;

221 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_READ_TYPE
;

222 ià((
ty³
 = 
	`rdbLßdTy³
(&
rdb
)è=ğ-1è
eoã¼
;

225 
expœ‘ime
 *= 1000;

226 } ià(
ty³
 =ğ
RDB_OPCODE_EXPIRETIME_MS
) {

229 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_READ_EXPIRE
;

230 ià((
expœ‘ime
 = 
	`rdbLßdMli£cÚdTime
(&
rdb
)è=ğ-1è
eoã¼
;

232 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_READ_TYPE
;

233 ià((
ty³
 = 
	`rdbLßdTy³
(&
rdb
)è=ğ-1è
eoã¼
;

234 } ià(
ty³
 =ğ
RDB_OPCODE_EOF
) {

237 } ià(
ty³
 =ğ
RDB_OPCODE_SELECTDB
) {

239 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_READ_LEN
;

240 ià((
dbid
 = 
	`rdbLßdL’
(&
rdb
,
NULL
)è=ğ
RDB_LENERR
)

241 
eoã¼
;

242 
	`rdbCheckInfo
("S–eùšg DB ID %d", 
dbid
);

244 } ià(
ty³
 =ğ
RDB_OPCODE_RESIZEDB
) {

247 
ušt64_t
 
db_size
, 
expœes_size
;

248 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_READ_LEN
;

249 ià((
db_size
 = 
	`rdbLßdL’
(&
rdb
,
NULL
)è=ğ
RDB_LENERR
)

250 
eoã¼
;

251 ià((
expœes_size
 = 
	`rdbLßdL’
(&
rdb
,
NULL
)è=ğ
RDB_LENERR
)

252 
eoã¼
;

254 } ià(
ty³
 =ğ
RDB_OPCODE_AUX
) {

260 
robj
 *
auxkey
, *
auxv®
;

261 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_READ_AUX
;

262 ià((
auxkey
 = 
	`rdbLßdSŒšgObjeù
(&
rdb
)è=ğ
NULL
è
eoã¼
;

263 ià((
auxv®
 = 
	`rdbLßdSŒšgObjeù
(&
rdb
)è=ğ
NULL
è
eoã¼
;

265 
	`rdbCheckInfo
("AUX FIELD %s = '%s'",

266 (*)
auxkey
->
±r
, (*)
auxv®
->ptr);

267 
	`deüRefCouÁ
(
auxkey
);

268 
	`deüRefCouÁ
(
auxv®
);

271 ià(!
	`rdbIsObjeùTy³
(
ty³
)) {

272 
	`rdbCheckE¼Ü
("Inv®id objeùy³: %d", 
ty³
);

275 
rdb¡©e
.
key_ty³
 = 
ty³
;

279 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_READ_KEY
;

280 ià((
key
 = 
	`rdbLßdSŒšgObjeù
(&
rdb
)è=ğ
NULL
è
eoã¼
;

281 
rdb¡©e
.
key
 = key;

282 
rdb¡©e
.
keys
++;

284 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_READ_OBJECT_VALUE
;

285 ià((
v®
 = 
	`rdbLßdObjeù
(
ty³
,&
rdb
)è=ğ
NULL
è
eoã¼
;

291 ià(
£rv”
.
ma¡”ho¡
 =ğ
NULL
 && 
expœ‘ime
 !ğ-1 &&ƒxpœ‘im< 
now
)

292 
rdb¡©e
.
®»ady_expœed
++;

293 ià(
expœ‘ime
 !ğ-1è
rdb¡©e
.
expœes
++;

294 
rdb¡©e
.
key
 = 
NULL
;

295 
	`deüRefCouÁ
(
key
);

296 
	`deüRefCouÁ
(
v®
);

297 
rdb¡©e
.
key_ty³
 = -1;

300 ià(
rdbv”
 >ğ5 && 
£rv”
.
rdb_checksum
) {

301 
ušt64_t
 
cksum
, 
ex³ùed
 = 
rdb
.cksum;

303 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_CHECK_SUM
;

304 ià(
	`rioR—d
(&
rdb
,&
cksum
,8è=ğ0è
eoã¼
;

305 
	`mem»v64ifbe
(&
cksum
);

306 ià(
cksum
 == 0) {

307 
	`rdbCheckInfo
("RDB file was saved with checksum disabled:‚o check…erformed.");

308 } ià(
cksum
 !ğ
ex³ùed
) {

309 
	`rdbCheckE¼Ü
("RDB CRCƒrror");

311 
	`rdbCheckInfo
("Checksum OK");

315 ià(
şo£fe
è
	`fşo£
(
å
);

318 
eoã¼
:

319 ià(
rdb¡©e
.
”rÜ_£t
) {

320 
	`rdbCheckE¼Ü
(
rdb¡©e
.
”rÜ
);

322 
	`rdbCheckE¼Ü
("Unexpected EOF„eading RDB file");

325 
	}
}

339 
	$»dis_check_rdb_maš
(
¬gc
, **
¬gv
, 
FILE
 *
å
) {

340 ià(
¬gc
 !ğ2 && 
å
 =ğ
NULL
) {

341 
	`årštf
(
¡d”r
, "U§ge: % <rdb-fe-Çme>\n", 
¬gv
[0]);

342 
	`ex™
(1);

347 ià(
sh¬ed
.
š‹g”s
[0] =ğ
NULL
)

348 
	`ü—‹Sh¬edObjeùs
();

349 
£rv”
.
lßdšg_´oûss_ev’ts_š‹rv®_by‹s
 = 0;

350 
rdbCheckMode
 = 1;

351 
	`rdbCheckInfo
("Checkšg RDB f%s", 
¬gv
[1]);

352 
	`rdbCheckS‘upSigÇls
();

353 
»tv®
 = 
	`»dis_check_rdb
(
¬gv
[1],
å
);

354 ià(
»tv®
 == 0) {

355 
	`rdbCheckInfo
("\\o/ RDB†ooks OK! \\o/");

356 
	`rdbShowG’”icInfo
();

358 ià(
å
è (
»tv®
 =ğ0è? 
C_OK
 : 
C_ERR
;

359 
	`ex™
(
»tv®
);

360 
	}
}

	@redis-cli.c

31 
	~"fmaüos.h
"

32 
	~"v”siÚ.h
"

34 
	~<¡dio.h
>

35 
	~<¡ršg.h
>

36 
	~<¡dlib.h
>

37 
	~<sigÇl.h
>

38 
	~<uni¡d.h
>

39 
	~<time.h
>

40 
	~<ùy³.h
>

41 
	~<”ºo.h
>

42 
	~<sys/¡©.h
>

43 
	~<sys/time.h
>

44 
	~<as£¹.h
>

45 
	~<fú.h
>

46 
	~<lim™s.h
>

47 
	~<m©h.h
>

49 
	~<hœedis.h
>

50 
	~<sds.h
>

51 
	~"zm®loc.h
"

52 
	~"lš’oi£.h
"

53 
	~"h–p.h
"

54 
	~"ª‘.h
"

55 
	~"«.h
"

57 
	#UNUSED
(
V
è((èV)

	)

59 
	#OUTPUT_STANDARD
 0

	)

60 
	#OUTPUT_RAW
 1

	)

61 
	#OUTPUT_CSV
 2

	)

62 
	#REDIS_CLI_KEEPALIVE_INTERVAL
 15

	)

63 
	#REDIS_CLI_DEFAULT_PIPE_TIMEOUT
 30

	)

64 
	#REDIS_CLI_HISTFILE_ENV
 "REDISCLI_HISTFILE"

	)

65 
	#REDIS_CLI_HISTFILE_DEFAULT
 ".»disşi_hi¡Üy"

	)

66 
	#REDIS_CLI_RCFILE_ENV
 "REDISCLI_RCFILE"

	)

67 
	#REDIS_CLI_RCFILE_DEFAULT
 ".»disşœc"

	)

70 
	g¥eùrum_·Ë‰e_cŞÜ_size
 = 19;

71 
	g¥eùrum_·Ë‰e_cŞÜ
[] = {0,233,234,235,237,239,241,243,245,247,144,143,142,184,226,214,208,202,196};

73 
	g¥eùrum_·Ë‰e_mÚo_size
 = 13;

74 
	g¥eùrum_·Ë‰e_mÚo
[] = {0,233,234,235,237,239,241,243,245,247,249,251,253};

77 *
	g¥eùrum_·Ë‰e
;

78 
	g¥eùrum_·Ë‰e_size
;

80 
»disCÚ‹xt
 *
	gcÚ‹xt
;

81 
	scÚfig
 {

82 *
	mho¡
;

83 
	mho¡pÜt
;

84 *
	mho¡sock‘
;

85 
	m»³©
;

86 
	mš‹rv®
;

87 
	mdbnum
;

88 
	mš‹¿ùive
;

89 
	mshutdown
;

90 
	mmÚ™Ü_mode
;

91 
	mpubsub_mode
;

92 
	mÏ‹ncy_mode
;

93 
	mÏ‹ncy_di¡_mode
;

94 
	mÏ‹ncy_hi¡Üy
;

95 
	mÌu_‹¡_mode
;

96 
	mÌu_‹¡_§m¶e_size
;

97 
	mşu¡”_mode
;

98 
	mşu¡”_»issue_commªd
;

99 
	m¦ave_mode
;

100 
	mpe_mode
;

101 
	mpe_timeout
;

102 
	mg‘rdb_mode
;

103 
	m¡©_mode
;

104 
	msÿn_mode
;

105 
	mšŒšsic_Ï‹ncy_mode
;

106 
	mšŒšsic_Ï‹ncy_du¿tiÚ
;

107 *
	m·‰”n
;

108 *
	mrdb_f’ame
;

109 
	mbigkeys
;

110 
	m¡dš¬g
;

111 *
	mauth
;

112 
	mouut
;

113 
sds
 
	mmb_d–im
;

114 
	m´om±
[128];

115 *
	mev®
;

116 
	mev®_ldb
;

117 
	mev®_ldb_sync
;

118 
	mev®_ldb_’d
;

119 
	m’abË_ldb_Ú_ev®
;

120 
	mÏ¡_cmd_ty³
;

121 } 
	gcÚfig
;

124 
	s´ef
 {

125 
	mhšts
;

126 } 
	g´ef
;

128 vŞ©
sig_©omic_t
 
	gfÜû_ÿnûl_loİ
 = 0;

129 
u§ge
();

130 
¦aveMode
();

131 *
»disG™SHA1
();

132 *
»disG™Dœty
();

133 
şiCÚÃù
(
fÜû
);

139 
	$u¡ime
() {

140 
timev®
 
tv
;

141 
u¡
;

143 
	`g‘timeofday
(&
tv
, 
NULL
);

144 
u¡
 = (()
tv
.
tv_£c
)*1000000;

145 
u¡
 +ğ
tv
.
tv_u£c
;

146  
u¡
;

147 
	}
}

149 
	$m¡ime
() {

150  
	`u¡ime
()/1000;

151 
	}
}

153 
	$şiReäeshProm±
() {

154 
Ën
;

156 ià(
cÚfig
.
ev®_ldb
) ;

157 ià(
cÚfig
.
ho¡sock‘
 !ğ
NULL
)

158 
Ën
 = 
	`¢´štf
(
cÚfig
.
´om±
,(config.prompt),"redis %s",

159 
cÚfig
.
ho¡sock‘
);

161 
Ën
 = 
	`ª‘FÜm©Addr
(
cÚfig
.
´om±
, (config.prompt),

162 
cÚfig
.
ho¡
, cÚfig.
ho¡pÜt
);

164 ià(
cÚfig
.
dbnum
 != 0)

165 
Ën
 +ğ
	`¢´štf
(
cÚfig
.
´om±
+len,(config.prompt)-len,"[%d]",

166 
cÚfig
.
dbnum
);

167 
	`¢´štf
(
cÚfig
.
´om±
+
Ën
,(config.prompt)-len,"> ");

168 
	}
}

178 
sds
 
	$g‘DÙfeP©h
(*
’vov”ride
, *
dÙf’ame
) {

179 *
·th
 = 
NULL
;

180 
sds
 
dÙP©h
 = 
NULL
;

183 
·th
 = 
	`g‘’v
(
’vov”ride
);

184 ià(
·th
 !ğ
NULL
 && *path != '\0') {

185 ià(!
	`¡rcmp
("/dev/nuÎ", 
·th
)) {

186  
NULL
;

190 
dÙP©h
 = 
	`sd¢ew
(
·th
);

192 *
home
 = 
	`g‘’v
("HOME");

193 ià(
home
 !ğ
NULL
 && *home != '\0') {

195 
dÙP©h
 = 
	`sdsÿrštf
(
	`sd£m±y
(), "%s/%s", 
home
, 
dÙf’ame
);

198  
dÙP©h
;

199 
	}
}

205 
	#CLI_HELP_COMMAND
 1

	)

206 
	#CLI_HELP_GROUP
 2

	)

209 
	mty³
;

210 
	m¬gc
;

211 
sds
 *
	m¬gv
;

212 
sds
 
	mfuÎ
;

215 
commªdH–p
 *
	mÜg
;

216 } 
	th–pEÁry
;

218 
h–pEÁry
 *
	gh–pEÁr›s
;

219 
	gh–pEÁr›sL’
;

221 
sds
 
	$şiV”siÚ
() {

222 
sds
 
v”siÚ
;

223 
v”siÚ
 = 
	`sdsÿrštf
(
	`sd£m±y
(), "%s", 
REDIS_VERSION
);

226 ià(
	`¡¹Şl
(
	`»disG™SHA1
(),
NULL
,16)) {

227 
v”siÚ
 = 
	`sdsÿrštf
(v”siÚ, " (g™:%s", 
	`»disG™SHA1
());

228 ià(
	`¡¹Şl
(
	`»disG™Dœty
(),
NULL
,10))

229 
v”siÚ
 = 
	`sdsÿrštf
(version, "-dirty");

230 
v”siÚ
 = 
	`sdsÿt
(version, ")");

232  
v”siÚ
;

233 
	}
}

235 
	$şiIn™H–p
() {

236 
commªd¦’
 = (
commªdH–p
)/(commandHelp);

237 
group¦’
 = (
commªdGroups
)/(*);

238 
i
, 
Ën
, 
pos
 = 0;

239 
h–pEÁry
 
tmp
;

241 
h–pEÁr›sL’
 = 
Ën
 = 
commªd¦’
+
group¦’
;

242 
h–pEÁr›s
 = 
	`zm®loc
((
h–pEÁry
)*
Ën
);

244 
i
 = 0; i < 
group¦’
; i++) {

245 
tmp
.
¬gc
 = 1;

246 
tmp
.
¬gv
 = 
	`zm®loc
((
sds
));

247 
tmp
.
¬gv
[0] = 
	`sdsÿrštf
(
	`sd£m±y
(),"@%s",
commªdGroups
[
i
]);

248 
tmp
.
fuÎ
 =mp.
¬gv
[0];

249 
tmp
.
ty³
 = 
CLI_HELP_GROUP
;

250 
tmp
.
Üg
 = 
NULL
;

251 
h–pEÁr›s
[
pos
++] = 
tmp
;

254 
i
 = 0; i < 
commªd¦’
; i++) {

255 
tmp
.
¬gv
 = 
	`sds¥l™¬gs
(
commªdH–p
[
i
].
Çme
,&tmp.
¬gc
);

256 
tmp
.
fuÎ
 = 
	`sd¢ew
(
commªdH–p
[
i
].
Çme
);

257 
tmp
.
ty³
 = 
CLI_HELP_COMMAND
;

258 
tmp
.
Üg
 = &
commªdH–p
[
i
];

259 
h–pEÁr›s
[
pos
++] = 
tmp
;

261 
	}
}

268 
	$şiIÁeg¿‹H–p
() {

269 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
) ;

271 
»disR•ly
 *
»¶y
 = 
	`»disCommªd
(
cÚ‹xt
, "COMMAND");

272 if(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_ARRAY
) ;

276 
size_t
 
j
 = 0; j < 
»¶y
->
–em’ts
; j++) {

277 
»disR•ly
 *
’Œy
 = 
»¶y
->
–em’t
[
j
];

278 ià(
’Œy
->
ty³
 !ğ
REDIS_REPLY_ARRAY
 ||ƒÁry->
–em’ts
 < 4 ||

279 
’Œy
->
–em’t
[0]->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

280 
’Œy
->
–em’t
[1]->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

281 
’Œy
->
–em’t
[3]->
ty³
 !ğ
REDIS_REPLY_INTEGER
) ;

282 *
cmdÇme
 = 
’Œy
->
–em’t
[0]->
¡r
;

283 
i
;

285 
i
 = 0; i < 
h–pEÁr›sL’
; i++) {

286 
h–pEÁry
 *
he
 = 
h–pEÁr›s
+
i
;

287 ià(!
	`¡rÿ£cmp
(
he
->
¬gv
[0],
cmdÇme
))

290 ià(
i
 !ğ
h–pEÁr›sL’
) ;

292 
h–pEÁr›sL’
++;

293 
h–pEÁr›s
 = 
	`z»®loc
(h–pEÁr›s,(
h–pEÁry
)*
h–pEÁr›sL’
);

294 
h–pEÁry
 *
Ãw
 = 
h–pEÁr›s
+(
h–pEÁr›sL’
-1);

296 
Ãw
->
¬gc
 = 1;

297 
Ãw
->
¬gv
 = 
	`zm®loc
((
sds
));

298 
Ãw
->
¬gv
[0] = 
	`sd¢ew
(
cmdÇme
);

299 
Ãw
->
fuÎ
 =‚ew->
¬gv
[0];

300 
Ãw
->
ty³
 = 
CLI_HELP_COMMAND
;

301 
	`sd¡ouµ”
(
Ãw
->
¬gv
[0]);

303 
commªdH–p
 *
ch
 = 
	`zm®loc
((*ch));

304 
ch
->
Çme
 = 
Ãw
->
¬gv
[0];

305 
ch
->
·¿ms
 = 
	`sd£m±y
();

306 
¬gs
 = 
	`Îabs
(
’Œy
->
–em’t
[1]->
š‹g”
);

307 ià(
’Œy
->
–em’t
[3]->
š‹g”
 == 1) {

308 
ch
->
·¿ms
 = 
	`sdsÿt
(ch->params,"key ");

309 
¬gs
--;

311 
¬gs
--è
ch
->
·¿ms
 = 
	`sdsÿt
(ch->params,"arg ");

312 ià(
’Œy
->
–em’t
[1]->
š‹g”
 < 0)

313 
ch
->
·¿ms
 = 
	`sdsÿt
(ch->params,"...options...");

314 
ch
->
summ¬y
 = "Help‚ot‡vailable";

315 
ch
->
group
 = 0;

316 
ch
->
sšû
 = "not known";

317 
Ãw
->
Üg
 = 
ch
;

319 
	`ä“R•lyObjeù
(
»¶y
);

320 
	}
}

323 
	$şiOuutCommªdH–p
(
commªdH–p
 *
h–p
, 
group
) {

324 
	`´štf
("\r\À \x1b[1m%s\x1b[0m \x1b[90m%s\x1b[0m\r\n", 
h–p
->
Çme
, h–p->
·¿ms
);

325 
	`´štf
(" \x1b[33msumm¬y:\x1b[0m %s\r\n", 
h–p
->
summ¬y
);

326 
	`´štf
(" \x1b[33msšû:\x1b[0m %s\r\n", 
h–p
->
sšû
);

327 ià(
group
) {

328 
	`´štf
(" \x1b[33mgroup:\x1b[0m %s\r\n", 
commªdGroups
[
h–p
->
group
]);

330 
	}
}

333 
	$şiOuutG’”icH–p
() {

334 
sds
 
v”siÚ
 = 
	`şiV”siÚ
();

335 
	`´štf
(

347 
v”siÚ


349 
	`sdsä“
(
v”siÚ
);

350 
	}
}

353 
	$şiOuutH–p
(
¬gc
, **
¬gv
) {

354 
i
, 
j
, 
Ën
;

355 
group
 = -1;

356 
h–pEÁry
 *
’Œy
;

357 
commªdH–p
 *
h–p
;

359 ià(
¬gc
 == 0) {

360 
	`şiOuutG’”icH–p
();

362 } ià(
¬gc
 > 0 && 
¬gv
[0][0] == '@') {

363 
Ën
 = (
commªdGroups
)/(*);

364 
i
 = 0; i < 
Ën
; i++) {

365 ià(
	`¡rÿ£cmp
(
¬gv
[0]+1,
commªdGroups
[
i
]) == 0) {

366 
group
 = 
i
;

372 
	`as£¹
(
¬gc
 > 0);

373 
i
 = 0; i < 
h–pEÁr›sL’
; i++) {

374 
’Œy
 = &
h–pEÁr›s
[
i
];

375 ià(
’Œy
->
ty³
 !ğ
CLI_HELP_COMMAND
) ;

377 
h–p
 = 
’Œy
->
Üg
;

378 ià(
group
 == -1) {

380 ià(
¬gc
 =ğ
’Œy
->argc) {

381 
j
 = 0; j < 
¬gc
; j++) {

382 ià(
	`¡rÿ£cmp
(
¬gv
[
j
],
’Œy
->argv[j]) != 0) ;

384 ià(
j
 =ğ
¬gc
) {

385 
	`şiOuutCommªdH–p
(
h–p
,1);

389 ià(
group
 =ğ
h–p
->group) {

390 
	`şiOuutCommªdH–p
(
h–p
,0);

394 
	`´štf
("\r\n");

395 
	}
}

398 
	$com¶‘iÚC®lback
(cÚ¡ *
buf
, 
lš’oi£Com¶‘iÚs
 *
lc
) {

399 
size_t
 
¡¬os
 = 0;

400 
mask
;

401 
i
;

402 
size_t
 
m©chËn
;

403 
sds
 
tmp
;

405 ià(
	`¡ºÿ£cmp
(
buf
,"help ",5) == 0) {

406 
¡¬os
 = 5;

407 
	`is¥aû
(
buf
[
¡¬os
])) startpos++;

408 
mask
 = 
CLI_HELP_COMMAND
 | 
CLI_HELP_GROUP
;

410 
mask
 = 
CLI_HELP_COMMAND
;

413 
i
 = 0; i < 
h–pEÁr›sL’
; i++) {

414 ià(!(
h–pEÁr›s
[
i
].
ty³
 & 
mask
)) ;

416 
m©chËn
 = 
	`¡¾’
(
buf
+
¡¬os
);

417 ià(
	`¡ºÿ£cmp
(
buf
+
¡¬os
,
h–pEÁr›s
[
i
].
fuÎ
,
m©chËn
) == 0) {

418 
tmp
 = 
	`sd¢ewËn
(
buf
,
¡¬os
);

419 
tmp
 = 
	`sdsÿt
Ñmp,
h–pEÁr›s
[
i
].
fuÎ
);

420 
	`lš’oi£AddCom¶‘iÚ
(
lc
,
tmp
);

421 
	`sdsä“
(
tmp
);

424 
	}
}

427 *
	$hštsC®lback
(cÚ¡ *
buf
, *
cŞÜ
, *
bŞd
) {

428 ià(!
´ef
.
hšts
è 
NULL
;

430 
i
, 
¬gc
, 
buæ’
 = 
	`¡¾’
(
buf
);

431 
sds
 *
¬gv
 = 
	`sds¥l™¬gs
(
buf
,&
¬gc
);

432 
’d¥aû
 = 
buæ’
 && 
	`is¥aû
(
buf
[buflen-1]);

435 ià(
¬gc
 == 0) {

436 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

437  
NULL
;

440 
i
 = 0; i < 
h–pEÁr›sL’
; i++) {

441 ià(!(
h–pEÁr›s
[
i
].
ty³
 & 
CLI_HELP_COMMAND
)) ;

443 ià(
	`¡rÿ£cmp
(
¬gv
[0],
h–pEÁr›s
[
i
].
fuÎ
) == 0)

445 *
cŞÜ
 = 90;

446 *
bŞd
 = 0;

447 
sds
 
hšt
 = 
	`sd¢ew
(
h–pEÁr›s
[
i
].
Üg
->
·¿ms
);

451 
tÜemove
 = 
¬gc
-1;

452 
tÜemove
 > 0 && 
	`sd¦’
(
hšt
)) {

453 ià(
hšt
[0] == '[') ;

454 ià(
hšt
[0] =ğ' 'è
tÜemove
--;

455 
	`sd¤ªge
(
hšt
,1,-1);

459 ià(!
’d¥aû
) {

460 
sds
 
Ãwhšt
 = 
	`sd¢ewËn
(" ",1);

461 
Ãwhšt
 = 
	`sdsÿtsds
Òewhšt,
hšt
);

462 
	`sdsä“
(
hšt
);

463 
hšt
 = 
Ãwhšt
;

466 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

467  
hšt
;

470 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

471  
NULL
;

472 
	}
}

474 
	$ä“HštsC®lback
(*
±r
) {

475 
	`sdsä“
(
±r
);

476 
	}
}

483 
	$şiAuth
() {

484 
»disR•ly
 *
»¶y
;

485 ià(
cÚfig
.
auth
 =ğ
NULL
è 
REDIS_OK
;

487 
»¶y
 = 
	`»disCommªd
(
cÚ‹xt
,"AUTH %s",
cÚfig
.
auth
);

488 ià(
»¶y
 !ğ
NULL
) {

489 
	`ä“R•lyObjeù
(
»¶y
);

490  
REDIS_OK
;

492  
REDIS_ERR
;

493 
	}
}

496 
	$şiS–eù
() {

497 
»disR•ly
 *
»¶y
;

498 ià(
cÚfig
.
dbnum
 =ğ0è 
REDIS_OK
;

500 
»¶y
 = 
	`»disCommªd
(
cÚ‹xt
,"SELECT %d",
cÚfig
.
dbnum
);

501 ià(
»¶y
 !ğ
NULL
) {

502 
»suÉ
 = 
REDIS_OK
;

503 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ERROR
è
»suÉ
 = 
REDIS_ERR
;

504 
	`ä“R•lyObjeù
(
»¶y
);

505  
»suÉ
;

507  
REDIS_ERR
;

508 
	}
}

512 
	$şiCÚÃù
(
fÜû
) {

513 ià(
cÚ‹xt
 =ğ
NULL
 || 
fÜû
) {

514 ià(
cÚ‹xt
 !ğ
NULL
) {

515 
	`»disF»e
(
cÚ‹xt
);

518 ià(
cÚfig
.
ho¡sock‘
 =ğ
NULL
) {

519 
cÚ‹xt
 = 
	`»disCÚÃù
(
cÚfig
.
ho¡
,cÚfig.
ho¡pÜt
);

521 
cÚ‹xt
 = 
	`»disCÚÃùUnix
(
cÚfig
.
ho¡sock‘
);

524 ià(
cÚ‹xt
->
”r
) {

525 
	`årštf
(
¡d”r
,"Could‚ot connecto Redis‡t ");

526 ià(
cÚfig
.
ho¡sock‘
 =ğ
NULL
)

527 
	`årštf
(
¡d”r
,"%s:%d: %s\n",
cÚfig
.
ho¡
,cÚfig.
ho¡pÜt
,
cÚ‹xt
->
”r¡r
);

529 
	`årštf
(
¡d”r
,"%s: %s\n",
cÚfig
.
ho¡sock‘
,
cÚ‹xt
->
”r¡r
);

530 
	`»disF»e
(
cÚ‹xt
);

531 
cÚ‹xt
 = 
NULL
;

532  
REDIS_ERR
;

539 
	`ª‘K“pAlive
(
NULL
, 
cÚ‹xt
->
fd
, 
REDIS_CLI_KEEPALIVE_INTERVAL
);

542 ià(
	`şiAuth
(è!ğ
REDIS_OK
)

543  
REDIS_ERR
;

544 ià(
	`şiS–eù
(è!ğ
REDIS_OK
)

545  
REDIS_ERR
;

547  
REDIS_OK
;

548 
	}
}

550 
	$şiPrštCÚ‹xtE¼Ü
() {

551 ià(
cÚ‹xt
 =ğ
NULL
) ;

552 
	`årštf
(
¡d”r
,"E¼Ü: %s\n",
cÚ‹xt
->
”r¡r
);

553 
	}
}

555 
sds
 
	$şiFÜm©R•lyTTY
(
»disR•ly
 *
r
, *
´efix
) {

556 
sds
 
out
 = 
	`sd£m±y
();

557 
r
->
ty³
) {

558 
REDIS_REPLY_ERROR
:

559 
out
 = 
	`sdsÿrštf
(out,"Ó¼Üè%s\n", 
r
->
¡r
);

561 
REDIS_REPLY_STATUS
:

562 
out
 = 
	`sdsÿt
(out,
r
->
¡r
);

563 
out
 = 
	`sdsÿt
(out,"\n");

565 
REDIS_REPLY_INTEGER
:

566 
out
 = 
	`sdsÿrštf
(out,"(š‹g”è%Îd\n",
r
->
š‹g”
);

568 
REDIS_REPLY_STRING
:

571 
out
 = 
	`sdsÿŒ•r
(out,
r
->
¡r
,r->
Ën
);

572 
out
 = 
	`sdsÿt
(out,"\n");

574 
REDIS_REPLY_NIL
:

575 
out
 = 
	`sdsÿt
(out,"(nil)\n");

577 
REDIS_REPLY_ARRAY
:

578 ià(
r
->
–em’ts
 == 0) {

579 
out
 = 
	`sdsÿt
(out,"(empty†ist or set)\n");

581 
i
, 
idxËn
 = 0;

582 
_´efixËn
[16];

583 
_´efixfmt
[16];

584 
sds
 
_´efix
;

585 
sds
 
tmp
;

588 
i
 = 
r
->
–em’ts
;

590 
idxËn
++;

591 
i
 /= 10;

592 } 
i
);

595 
	`mem£t
(
_´efixËn
,' ',
idxËn
+2);

596 
_´efixËn
[
idxËn
+2] = '\0';

597 
_´efix
 = 
	`sdsÿt
(
	`sd¢ew
(
´efix
),
_´efixËn
);

600 
	`¢´štf
(
_´efixfmt
,(_´efixfmt),"%%s%%%udè",
idxËn
);

602 
i
 = 0; i < 
r
->
–em’ts
; i++) {

605 
out
 = 
	`sdsÿrštf
(out,
_´efixfmt
,
i
 =ğ0 ? "" : 
´efix
,i+1);

608 
tmp
 = 
	`şiFÜm©R•lyTTY
(
r
->
–em’t
[
i
],
_´efix
);

609 
out
 = 
	`sdsÿ’
(out,
tmp
,
	`sd¦’
(tmp));

610 
	`sdsä“
(
tmp
);

612 
	`sdsä“
(
_´efix
);

616 
	`årštf
(
¡d”r
,"UnknowÀ»¶yy³: %d\n", 
r
->
ty³
);

617 
	`ex™
(1);

619  
out
;

620 
	}
}

622 
	$isCŞÜT”m
() {

623 *
t
 = 
	`g‘’v
("TERM");

624  
t
 !ğ
NULL
 && 
	`¡r¡r
(t,"xterm") != NULL;

625 
	}
}

629 
sds
 
	$sdsÿtcŞÜ
(
sds
 
o
, *
s
, 
size_t
 
Ën
, *
cŞÜ
) {

630 ià(!
	`isCŞÜT”m
()è 
	`sdsÿ’
(
o
,
s
,
Ën
);

632 
bŞd
 = 
	`¡r¡r
(
cŞÜ
,"bŞd"è!ğ
NULL
;

633 
ccode
 = 37;

634 ià(
	`¡r¡r
(
cŞÜ
,"»d")è
ccode
 = 31;

635 ià(
	`¡r¡r
(
cŞÜ
,"»d")è
ccode
 = 31;

636 ià(
	`¡r¡r
(
cŞÜ
,"g»’")è
ccode
 = 32;

637 ià(
	`¡r¡r
(
cŞÜ
,"y–low")è
ccode
 = 33;

638 ià(
	`¡r¡r
(
cŞÜ
,"blue")è
ccode
 = 34;

639 ià(
	`¡r¡r
(
cŞÜ
,"mag’")è
ccode
 = 35;

640 ià(
	`¡r¡r
(
cŞÜ
,"cyª")è
ccode
 = 36;

641 ià(
	`¡r¡r
(
cŞÜ
,"wh™e")è
ccode
 = 37;

643 
o
 = 
	`sdsÿtfmt
(o,"\033[%i;%i;49m",
bŞd
,
ccode
);

644 
o
 = 
	`sdsÿ’
(o,
s
,
Ën
);

645 
o
 = 
	`sdsÿt
(o,"\033[0m");

646  
o
;

647 
	}
}

651 
sds
 
	$sdsC©CŞÜizedLdbR•ly
(
sds
 
o
, *
s
, 
size_t
 
Ën
) {

652 *
cŞÜ
 = "white";

654 ià(
	`¡r¡r
(
s
,"<debug>")è
cŞÜ
 = "bold";

655 ià(
	`¡r¡r
(
s
,"<»dis>")è
cŞÜ
 = "green";

656 ià(
	`¡r¡r
(
s
,"<»¶y>")è
cŞÜ
 = "cyan";

657 ià(
	`¡r¡r
(
s
,"<”rÜ>")è
cŞÜ
 = "red";

658 ià(
	`¡r¡r
(
s
,"<hšt>")è
cŞÜ
 = "bold";

659 ià(
	`¡r¡r
(
s
,"<v®ue>"è|| sŒ¡r(s,"<»tv®>")è
cŞÜ
 = "magenta";

660 ià(
Ën
 > 4 && 
	`isdig™
(
s
[3])) {

661 ià(
s
[1] =ğ'>'è
cŞÜ
 = "yellow";

662 ià(
s
[2] =ğ'#'è
cŞÜ
 = "bold";

664  
	`sdsÿtcŞÜ
(
o
,
s
,
Ën
,
cŞÜ
);

665 
	}
}

667 
sds
 
	$şiFÜm©R•lyRaw
(
»disR•ly
 *
r
) {

668 
sds
 
out
 = 
	`sd£m±y
(), 
tmp
;

669 
size_t
 
i
;

671 
r
->
ty³
) {

672 
REDIS_REPLY_NIL
:

675 
REDIS_REPLY_ERROR
:

676 
out
 = 
	`sdsÿ’
(out,
r
->
¡r
,r->
Ën
);

677 
out
 = 
	`sdsÿ’
(out,"\n",1);

679 
REDIS_REPLY_STATUS
:

680 
REDIS_REPLY_STRING
:

681 ià(
r
->
ty³
 =ğ
REDIS_REPLY_STATUS
 && 
cÚfig
.
ev®_ldb
) {

687 ià(
	`¡r¡r
(
r
->
¡r
,"<endsession>") ==„->str) {

688 
cÚfig
.
’abË_ldb_Ú_ev®
 = 0;

689 
cÚfig
.
ev®_ldb
 = 0;

690 
cÚfig
.
ev®_ldb_’d
 = 1;

691 
cÚfig
.
ouut
 = 
OUTPUT_STANDARD
;

692 
	`şiReäeshProm±
();

694 
out
 = 
	`sdsC©CŞÜizedLdbR•ly
(out,
r
->
¡r
,r->
Ën
);

697 
out
 = 
	`sdsÿ’
(out,
r
->
¡r
,r->
Ën
);

700 
REDIS_REPLY_INTEGER
:

701 
out
 = 
	`sdsÿrštf
(out,"%Îd",
r
->
š‹g”
);

703 
REDIS_REPLY_ARRAY
:

704 
i
 = 0; i < 
r
->
–em’ts
; i++) {

705 ià(
i
 > 0è
out
 = 
	`sdsÿt
(out,
cÚfig
.
mb_d–im
);

706 
tmp
 = 
	`şiFÜm©R•lyRaw
(
r
->
–em’t
[
i
]);

707 
out
 = 
	`sdsÿ’
(out,
tmp
,
	`sd¦’
(tmp));

708 
	`sdsä“
(
tmp
);

712 
	`årštf
(
¡d”r
,"UnknowÀ»¶yy³: %d\n", 
r
->
ty³
);

713 
	`ex™
(1);

715  
out
;

716 
	}
}

718 
sds
 
	$şiFÜm©R•lyCSV
(
»disR•ly
 *
r
) {

719 
i
;

721 
sds
 
out
 = 
	`sd£m±y
();

722 
r
->
ty³
) {

723 
REDIS_REPLY_ERROR
:

724 
out
 = 
	`sdsÿt
(out,"ERROR,");

725 
out
 = 
	`sdsÿŒ•r
(out,
r
->
¡r
,
	`¡¾’
(r->str));

727 
REDIS_REPLY_STATUS
:

728 
out
 = 
	`sdsÿŒ•r
(out,
r
->
¡r
,r->
Ën
);

730 
REDIS_REPLY_INTEGER
:

731 
out
 = 
	`sdsÿrštf
(out,"%Îd",
r
->
š‹g”
);

733 
REDIS_REPLY_STRING
:

734 
out
 = 
	`sdsÿŒ•r
(out,
r
->
¡r
,r->
Ën
);

736 
REDIS_REPLY_NIL
:

737 
out
 = 
	`sdsÿt
(out,"NIL");

739 
REDIS_REPLY_ARRAY
:

740 
i
 = 0; i < 
r
->
–em’ts
; i++) {

741 
sds
 
tmp
 = 
	`şiFÜm©R•lyCSV
(
r
->
–em’t
[
i
]);

742 
out
 = 
	`sdsÿ’
(out,
tmp
,
	`sd¦’
(tmp));

743 ià(
i
 !ğ
r
->
–em’ts
-1è
out
 = 
	`sdsÿt
(out,",");

744 
	`sdsä“
(
tmp
);

748 
	`årštf
(
¡d”r
,"UnknowÀ»¶yy³: %d\n", 
r
->
ty³
);

749 
	`ex™
(1);

751  
out
;

752 
	}
}

754 
	$şiR—dR•ly
(
ouut_¿w_¡ršgs
) {

755 *
_»¶y
;

756 
»disR•ly
 *
»¶y
;

757 
sds
 
out
 = 
NULL
;

758 
ouut
 = 1;

760 ià(
	`»disG‘R•ly
(
cÚ‹xt
,&
_»¶y
è!ğ
REDIS_OK
) {

761 ià(
cÚfig
.
shutdown
) {

762 
	`»disF»e
(
cÚ‹xt
);

763 
cÚ‹xt
 = 
NULL
;

764  
REDIS_OK
;

766 ià(
cÚfig
.
š‹¿ùive
) {

768 ià(
cÚ‹xt
->
”r
 =ğ
REDIS_ERR_IO
 &&

769 (
”ºo
 =ğ
ECONNRESET
 ||ƒ¼nØ=ğ
EPIPE
))

770  
REDIS_ERR
;

771 ià(
cÚ‹xt
->
”r
 =ğ
REDIS_ERR_EOF
)

772  
REDIS_ERR
;

774 
	`şiPrštCÚ‹xtE¼Ü
();

775 
	`ex™
(1);

776  
REDIS_ERR
;

779 
»¶y
 = (
»disR•ly
*)
_»¶y
;

781 
cÚfig
.
Ï¡_cmd_ty³
 = 
»¶y
->
ty³
;

785 ià(
cÚfig
.
şu¡”_mode
 && 
»¶y
->
ty³
 =ğ
REDIS_REPLY_ERROR
 &&

786 (!
	`¡ºcmp
(
»¶y
->
¡r
,"MOVED",5è|| !
	`¡rcmp
(reply->str,"ASK")))

788 *
p
 = 
»¶y
->
¡r
, *
s
;

789 
¦Ù
;

791 
ouut
 = 0;

797 
s
 = 
	`¡rchr
(
p
,' ');

798 
p
 = 
	`¡rchr
(
s
+1,' ');

799 *
p
 = '\0';

800 
¦Ù
 = 
	`©oi
(
s
+1);

801 
s
 = 
	`¡¼chr
(
p
+1,':');

802 *
s
 = '\0';

803 
	`sdsä“
(
cÚfig
.
ho¡
);

804 
cÚfig
.
ho¡
 = 
	`sd¢ew
(
p
+1);

805 
cÚfig
.
ho¡pÜt
 = 
	`©oi
(
s
+1);

806 ià(
cÚfig
.
š‹¿ùive
)

807 
	`´štf
("-> Redirectedo slot [%d]†ocated‡t %s:%d\n",

808 
¦Ù
, 
cÚfig
.
ho¡
, cÚfig.
ho¡pÜt
);

809 
cÚfig
.
şu¡”_»issue_commªd
 = 1;

810 
	`şiReäeshProm±
();

813 ià(
ouut
) {

814 ià(
ouut_¿w_¡ršgs
) {

815 
out
 = 
	`şiFÜm©R•lyRaw
(
»¶y
);

817 ià(
cÚfig
.
ouut
 =ğ
OUTPUT_RAW
) {

818 
out
 = 
	`şiFÜm©R•lyRaw
(
»¶y
);

819 
out
 = 
	`sdsÿt
(out,"\n");

820 } ià(
cÚfig
.
ouut
 =ğ
OUTPUT_STANDARD
) {

821 
out
 = 
	`şiFÜm©R•lyTTY
(
»¶y
,"");

822 } ià(
cÚfig
.
ouut
 =ğ
OUTPUT_CSV
) {

823 
out
 = 
	`şiFÜm©R•lyCSV
(
»¶y
);

824 
out
 = 
	`sdsÿt
(out,"\n");

827 
	`fwr™e
(
out
,
	`sd¦’
(out),1,
¡dout
);

828 
	`sdsä“
(
out
);

830 
	`ä“R•lyObjeù
(
»¶y
);

831  
REDIS_OK
;

832 
	}
}

834 
	$şiS’dCommªd
(
¬gc
, **
¬gv
, 
»³©
) {

835 *
commªd
 = 
¬gv
[0];

836 
size_t
 *
¬gvËn
;

837 
j
, 
ouut_¿w
;

839 ià(!
cÚfig
.
ev®_ldb
 &&

840 (!
	`¡rÿ£cmp
(
commªd
,"help") || !strcasecmp(command,"?"))) {

841 
	`şiOuutH–p
(--
¬gc
, ++
¬gv
);

842  
REDIS_OK
;

845 ià(
cÚ‹xt
 =ğ
NULL
è 
REDIS_ERR
;

847 
ouut_¿w
 = 0;

848 ià(!
	`¡rÿ£cmp
(
commªd
,"info") ||

849 (
¬gc
 >ğ2 && !
	`¡rÿ£cmp
(
commªd
,"debug") &&

850 !
	`¡rÿ£cmp
(
¬gv
[1],"htstats")) ||

851 (
¬gc
 >ğ2 && !
	`¡rÿ£cmp
(
commªd
,"memory") &&

852 (!
	`¡rÿ£cmp
(
¬gv
[1],"malloc-stats") ||

853 !
	`¡rÿ£cmp
(
¬gv
[1],"doctor"))) ||

854 (
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(
commªd
,"cluster") &&

855 (!
	`¡rÿ£cmp
(
¬gv
[1],"nodes") ||

856 !
	`¡rÿ£cmp
(
¬gv
[1],"info"))) ||

857 (
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(
commªd
,"client") &&

858 !
	`¡rÿ£cmp
(
¬gv
[1],"list")) ||

859 (
¬gc
 =ğ3 && !
	`¡rÿ£cmp
(
commªd
,"latency") &&

860 !
	`¡rÿ£cmp
(
¬gv
[1],"graph")) ||

861 (
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(
commªd
,"latency") &&

862 !
	`¡rÿ£cmp
(
¬gv
[1],"doctor")))

864 
ouut_¿w
 = 1;

867 ià(!
	`¡rÿ£cmp
(
commªd
,"shutdown")è
cÚfig
.
shutdown
 = 1;

868 ià(!
	`¡rÿ£cmp
(
commªd
,"mÚ™Ü")è
cÚfig
.
mÚ™Ü_mode
 = 1;

869 ià(!
	`¡rÿ£cmp
(
commªd
,"subscribe") ||

870 !
	`¡rÿ£cmp
(
commªd
,"psubsüibe")è
cÚfig
.
pubsub_mode
 = 1;

871 ià(!
	`¡rÿ£cmp
(
commªd
,"sync") ||

872 !
	`¡rÿ£cmp
(
commªd
,"psync")è
cÚfig
.
¦ave_mode
 = 1;

876 ià(
¬gc
 =ğ3 && !
	`¡rÿ£cmp
(
¬gv
[0],"script") &&

877 !
	`¡rÿ£cmp
(
¬gv
[1],"debug"))

879 ià(!
	`¡rÿ£cmp
(
¬gv
[2],"yes") || !strcasecmp(argv[2],"sync")) {

880 
cÚfig
.
’abË_ldb_Ú_ev®
 = 1;

882 
cÚfig
.
’abË_ldb_Ú_ev®
 = 0;

887 ià(!
	`¡rÿ£cmp
(
commªd
,"ev®"è&& 
cÚfig
.
’abË_ldb_Ú_ev®
) {

888 
cÚfig
.
ev®_ldb
 = 1;

889 
cÚfig
.
ouut
 = 
OUTPUT_RAW
;

893 
¬gvËn
 = 
	`zm®loc
(
¬gc
*(
size_t
));

894 
j
 = 0; j < 
¬gc
; j++)

895 
¬gvËn
[
j
] = 
	`sd¦’
(
¬gv
[j]);

897 
»³©
--) {

898 
	`»disAµ’dCommªdArgv
(
cÚ‹xt
,
¬gc
,(cÚ¡ **)
¬gv
,
¬gvËn
);

899 
cÚfig
.
mÚ™Ü_mode
) {

900 ià(
	`şiR—dR•ly
(
ouut_¿w
è!ğ
REDIS_OK
è
	`ex™
(1);

901 
	`fæush
(
¡dout
);

904 ià(
cÚfig
.
pubsub_mode
) {

905 ià(
cÚfig
.
ouut
 !ğ
OUTPUT_RAW
)

906 
	`´štf
("Reading messages... (press Ctrl-Co quit)\n");

908 ià(
	`şiR—dR•ly
(
ouut_¿w
è!ğ
REDIS_OK
è
	`ex™
(1);

912 ià(
cÚfig
.
¦ave_mode
) {

913 
	`´štf
("Entering slave output mode... (press Ctrl-Co quit)\n");

914 
	`¦aveMode
();

915 
cÚfig
.
¦ave_mode
 = 0;

916 
	`zä“
(
¬gvËn
);

917  
REDIS_ERR
;

920 ià(
	`şiR—dR•ly
(
ouut_¿w
è!ğ
REDIS_OK
) {

921 
	`zä“
(
¬gvËn
);

922  
REDIS_ERR
;

925 ià(!
	`¡rÿ£cmp
(
commªd
,"£Ëù"è&& 
¬gc
 =ğ2 && 
cÚfig
.
Ï¡_cmd_ty³
 !ğ
REDIS_REPLY_ERROR
) {

926 
cÚfig
.
dbnum
 = 
	`©oi
(
¬gv
[1]);

927 
	`şiReäeshProm±
();

928 } ià(!
	`¡rÿ£cmp
(
commªd
,"auth"è&& 
¬gc
 == 2) {

929 
	`şiS–eù
();

932 ià(
cÚfig
.
š‹rv®
è
	`u¦“p
(config.interval);

933 
	`fæush
(
¡dout
);

936 
	`zä“
(
¬gvËn
);

937  
REDIS_OK
;

938 
	}
}

941 
»disR•ly
 *
	$»cÚÃùšgRedisCommªd
(
»disCÚ‹xt
 *
c
, cÚ¡ *
fmt
, ...) {

942 
»disR•ly
 *
»¶y
 = 
NULL
;

943 
Œ›s
 = 0;

944 
va_li¡
 
­
;

946 
	`as£¹
(!
c
->
”r
);

947 
»¶y
 =ğ
NULL
) {

948 
c
->
”r
 & (
REDIS_ERR_IO
 | 
REDIS_ERR_EOF
)) {

949 
	`´štf
("\r\x1b[0K");

950 
	`´štf
("RecÚÃùšg... %d\r", ++
Œ›s
);

951 
	`fæush
(
¡dout
);

953 
	`»disF»e
(
c
);

954 
c
 = 
	`»disCÚÃù
(
cÚfig
.
ho¡
,cÚfig.
ho¡pÜt
);

955 
	`u¦“p
(1000000);

958 
	`va_¡¬t
(
­
,
fmt
);

959 
»¶y
 = 
	`»disvCommªd
(
c
,
fmt
,
­
);

960 
	`va_’d
(
­
);

962 ià(
c
->
”r
 && !(c->”¸& (
REDIS_ERR_IO
 | 
REDIS_ERR_EOF
))) {

963 
	`årštf
(
¡d”r
, "E¼Ü: %s\n", 
c
->
”r¡r
);

964 
	`ex™
(1);

965 } ià(
Œ›s
 > 0) {

966 
	`´štf
("\r\x1b[0K");

970 
cÚ‹xt
 = 
c
;

971  
»¶y
;

972 
	}
}

978 
	$·r£O±iÚs
(
¬gc
, **
¬gv
) {

979 
i
;

981 
i
 = 1; i < 
¬gc
; i++) {

982 
Ï¡¬g
 = 
i
==
¬gc
-1;

984 ià(!
	`¡rcmp
(
¬gv
[
i
],"-h"è&& !
Ï¡¬g
) {

985 
	`sdsä“
(
cÚfig
.
ho¡
);

986 
cÚfig
.
ho¡
 = 
	`sd¢ew
(
¬gv
[++
i
]);

987 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-h"è&& 
Ï¡¬g
) {

988 
	`u§ge
();

989 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--help")) {

990 
	`u§ge
();

991 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-x")) {

992 
cÚfig
.
¡dš¬g
 = 1;

993 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-p"è&& !
Ï¡¬g
) {

994 
cÚfig
.
ho¡pÜt
 = 
	`©oi
(
¬gv
[++
i
]);

995 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-s"è&& !
Ï¡¬g
) {

996 
cÚfig
.
ho¡sock‘
 = 
¬gv
[++
i
];

997 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-r"è&& !
Ï¡¬g
) {

998 
cÚfig
.
»³©
 = 
	`¡¹Şl
(
¬gv
[++
i
],
NULL
,10);

999 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-i"è&& !
Ï¡¬g
) {

1000 
£cÚds
 = 
	`©of
(
¬gv
[++
i
]);

1001 
cÚfig
.
š‹rv®
 = 
£cÚds
*1000000;

1002 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-n"è&& !
Ï¡¬g
) {

1003 
cÚfig
.
dbnum
 = 
	`©oi
(
¬gv
[++
i
]);

1004 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-a"è&& !
Ï¡¬g
) {

1005 
cÚfig
.
auth
 = 
¬gv
[++
i
];

1006 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--raw")) {

1007 
cÚfig
.
ouut
 = 
OUTPUT_RAW
;

1008 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--no-raw")) {

1009 
cÚfig
.
ouut
 = 
OUTPUT_STANDARD
;

1010 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--csv")) {

1011 
cÚfig
.
ouut
 = 
OUTPUT_CSV
;

1012 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--latency")) {

1013 
cÚfig
.
Ï‹ncy_mode
 = 1;

1014 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--latency-dist")) {

1015 
cÚfig
.
Ï‹ncy_di¡_mode
 = 1;

1016 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--mono")) {

1017 
¥eùrum_·Ë‰e
 = 
¥eùrum_·Ë‰e_mÚo
;

1018 
¥eùrum_·Ë‰e_size
 = 
¥eùrum_·Ë‰e_mÚo_size
;

1019 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--latency-history")) {

1020 
cÚfig
.
Ï‹ncy_mode
 = 1;

1021 
cÚfig
.
Ï‹ncy_hi¡Üy
 = 1;

1022 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--Ìu-‹¡"è&& !
Ï¡¬g
) {

1023 
cÚfig
.
Ìu_‹¡_mode
 = 1;

1024 
cÚfig
.
Ìu_‹¡_§m¶e_size
 = 
	`¡¹Şl
(
¬gv
[++
i
],
NULL
,10);

1025 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--slave")) {

1026 
cÚfig
.
¦ave_mode
 = 1;

1027 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--stat")) {

1028 
cÚfig
.
¡©_mode
 = 1;

1029 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--scan")) {

1030 
cÚfig
.
sÿn_mode
 = 1;

1031 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--·‰”n"è&& !
Ï¡¬g
) {

1032 
cÚfig
.
·‰”n
 = 
¬gv
[++
i
];

1033 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--šŒšsic-Ï‹ncy"è&& !
Ï¡¬g
) {

1034 
cÚfig
.
šŒšsic_Ï‹ncy_mode
 = 1;

1035 
cÚfig
.
šŒšsic_Ï‹ncy_du¿tiÚ
 = 
	`©oi
(
¬gv
[++
i
]);

1036 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--rdb"è&& !
Ï¡¬g
) {

1037 
cÚfig
.
g‘rdb_mode
 = 1;

1038 
cÚfig
.
rdb_f’ame
 = 
¬gv
[++
i
];

1039 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--pipe")) {

1040 
cÚfig
.
pe_mode
 = 1;

1041 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--pe-timeout"è&& !
Ï¡¬g
) {

1042 
cÚfig
.
pe_timeout
 = 
	`©oi
(
¬gv
[++
i
]);

1043 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--bigkeys")) {

1044 
cÚfig
.
bigkeys
 = 1;

1045 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--ev®"è&& !
Ï¡¬g
) {

1046 
cÚfig
.
ev®
 = 
¬gv
[++
i
];

1047 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--ldb")) {

1048 
cÚfig
.
ev®_ldb
 = 1;

1049 
cÚfig
.
ouut
 = 
OUTPUT_RAW
;

1050 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--ldb-sync-mode")) {

1051 
cÚfig
.
ev®_ldb
 = 1;

1052 
cÚfig
.
ev®_ldb_sync
 = 1;

1053 
cÚfig
.
ouut
 = 
OUTPUT_RAW
;

1054 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-c")) {

1055 
cÚfig
.
şu¡”_mode
 = 1;

1056 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-d"è&& !
Ï¡¬g
) {

1057 
	`sdsä“
(
cÚfig
.
mb_d–im
);

1058 
cÚfig
.
mb_d–im
 = 
	`sd¢ew
(
¬gv
[++
i
]);

1059 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-v") || !strcmp(argv[i], "--version")) {

1060 
sds
 
v”siÚ
 = 
	`şiV”siÚ
();

1061 
	`´štf
("»dis-ş˜%s\n", 
v”siÚ
);

1062 
	`sdsä“
(
v”siÚ
);

1063 
	`ex™
(0);

1065 ià(
¬gv
[
i
][0] == '-') {

1066 
	`årštf
(
¡d”r
,

1068 
¬gv
[
i
]);

1069 
	`ex™
(1);

1078 ià(
cÚfig
.
ev®_ldb
 && cÚfig.
ev®
 =ğ
NULL
) {

1079 
	`årštf
(
¡d”r
,"Options --ldb‡nd --ldb-sync-mode„equire --eval.\n");

1080 
	`årštf
(
¡d”r
,"Try % --h–°fÜ mÜšfÜm©iÚ.\n", 
¬gv
[0]);

1081 
	`ex™
(1);

1083  
i
;

1084 
	}
}

1086 
sds
 
	$»adArgFromStdš
() {

1087 
buf
[1024];

1088 
sds
 
¬g
 = 
	`sd£m±y
();

1091 
Ä—d
 = 
	`»ad
(
	`f’o
(
¡dš
),
buf
,1024);

1093 ià(
Ä—d
 == 0) ;

1094 ià(
Ä—d
 == -1) {

1095 
	`³¼Ü
("Reading from standard input");

1096 
	`ex™
(1);

1098 
¬g
 = 
	`sdsÿ’
×rg,
buf
,
Ä—d
);

1100  
¬g
;

1101 
	}
}

1103 
	$u§ge
() {

1104 
sds
 
v”siÚ
 = 
	`şiV”siÚ
();

1105 
	`årštf
(
¡d”r
,

1170 
v”siÚ
, 
REDIS_CLI_DEFAULT_PIPE_TIMEOUT
);

1171 
	`sdsä“
(
v”siÚ
);

1172 
	`ex™
(1);

1173 
	}
}

1176 **
	$cÚv”tToSds
(
couÁ
, ** 
¬gs
) {

1177 
j
;

1178 **
sds
 = 
	`zm®loc
((*)*
couÁ
);

1180 
j
 = 0; j < 
couÁ
; j++)

1181 
sds
[
j
] = 
	`sd¢ew
(
¬gs
[j]);

1183  
sds
;

1184 
	}
}

1186 
	$issueCommªdR•—t
(
¬gc
, **
¬gv
, 
»³©
) {

1188 
cÚfig
.
şu¡”_»issue_commªd
 = 0;

1189 ià(
	`şiS’dCommªd
(
¬gc
,
¬gv
,
»³©
è!ğ
REDIS_OK
) {

1190 
	`şiCÚÃù
(1);

1194 ià(
	`şiS’dCommªd
(
¬gc
,
¬gv
,
»³©
è!ğ
REDIS_OK
) {

1195 
	`şiPrštCÚ‹xtE¼Ü
();

1196  
REDIS_ERR
;

1200 ià(
cÚfig
.
şu¡”_mode
 && cÚfig.
şu¡”_»issue_commªd
) {

1201 
	`şiCÚÃù
(1);

1206  
REDIS_OK
;

1207 
	}
}

1209 
	$issueCommªd
(
¬gc
, **
¬gv
) {

1210  
	`issueCommªdR•—t
(
¬gc
, 
¬gv
, 
cÚfig
.
»³©
);

1211 
	}
}

1219 
sds
 *
	$şiS¶™Args
(*
lše
, *
¬gc
) {

1220 ià(
cÚfig
.
ev®_ldb
 && (
	`¡r¡r
(
lše
,"eval ") ==†ine ||

1221 
	`¡r¡r
(
lše
,"e ") ==†ine))

1223 
sds
 *
¬gv
 = 
	`sds_m®loc
((sds)*2);

1224 *
¬gc
 = 2;

1225 
Ën
 = 
	`¡¾’
(
lše
);

1226 
–’
 = 
lše
[1] == ' ' ? 2 : 5;

1227 
¬gv
[0] = 
	`sd¢ewËn
(
lše
,
–’
-1);

1228 
¬gv
[1] = 
	`sd¢ewËn
(
lše
+
–’
,
Ën
-elen);

1229  
¬gv
;

1231  
	`sds¥l™¬gs
(
lše
,
¬gc
);

1233 
	}
}

1238 
	$şiS‘P»ã»nûs
(**
¬gv
, 
¬gc
, 
š‹¿ùive
) {

1239 ià(!
	`¡rÿ£cmp
(
¬gv
[0],":£t"è&& 
¬gc
 >= 2) {

1240 ià(!
	`¡rÿ£cmp
(
¬gv
[1],"hšts")è
´ef
.
hšts
 = 1;

1241 ià(!
	`¡rÿ£cmp
(
¬gv
[1],"nohšts")è
´ef
.
hšts
 = 0;

1243 
	`´štf
("%sunknown„edis-cli…reference '%s'\n",

1244 
š‹¿ùive
 ? "" : ".redisclirc: ",

1245 
¬gv
[1]);

1248 
	`´štf
("%sunknown„edis-cli internal command '%s'\n",

1249 
š‹¿ùive
 ? "" : ".redisclirc: ",

1250 
¬gv
[0]);

1252 
	}
}

1255 
	$şiLßdP»ã»nûs
() {

1256 
sds
 
rcfe
 = 
	`g‘DÙfeP©h
(
REDIS_CLI_RCFILE_ENV
,
REDIS_CLI_RCFILE_DEFAULT
);

1257 ià(
rcfe
 =ğ
NULL
) ;

1258 
FILE
 *
å
 = 
	`fİ’
(
rcfe
,"r");

1259 
buf
[1024];

1261 ià(
å
) {

1262 
	`fg‘s
(
buf
,(buf),
å
è!ğ
NULL
) {

1263 
sds
 *
¬gv
;

1264 
¬gc
;

1266 
¬gv
 = 
	`sds¥l™¬gs
(
buf
,&
¬gc
);

1267 ià(
¬gc
 > 0è
	`şiS‘P»ã»nûs
(
¬gv
,argc,0);

1268 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

1270 
	`fşo£
(
å
);

1272 
	`sdsä“
(
rcfe
);

1273 
	}
}

1275 
	$»¶
() {

1276 
sds
 
hi¡Üyfe
 = 
NULL
;

1277 
hi¡Üy
 = 0;

1278 *
lše
;

1279 
¬gc
;

1280 
sds
 *
¬gv
;

1284 
	`şiIn™H–p
();

1285 
	`şiIÁeg¿‹H–p
();

1287 
cÚfig
.
š‹¿ùive
 = 1;

1288 
	`lš’oi£S‘MuÉiLše
(1);

1289 
	`lš’oi£S‘Com¶‘iÚC®lback
(
com¶‘iÚC®lback
);

1290 
	`lš’oi£S‘HštsC®lback
(
hštsC®lback
);

1291 
	`lš’oi£S‘F»eHštsC®lback
(
ä“HštsC®lback
);

1294 ià(
	`i§‰y
(
	`f’o
(
¡dš
))) {

1295 
hi¡Üyfe
 = 
	`g‘DÙfeP©h
(
REDIS_CLI_HISTFILE_ENV
,
REDIS_CLI_HISTFILE_DEFAULT
);

1296 ià(
hi¡Üyfe
 !ğ
NULL
) {

1297 
hi¡Üy
 = 1;

1298 
	`lš’oi£Hi¡ÜyLßd
(
hi¡Üyfe
);

1300 
	`şiLßdP»ã»nûs
();

1303 
	`şiReäeshProm±
();

1304 (
lše
 = 
	`lš’oi£
(
cÚ‹xt
 ? 
cÚfig
.
´om±
 : "nÙ cÚÃùed> ")è!ğ
NULL
) {

1305 ià(
lše
[0] != '\0') {

1306 
¬gv
 = 
	`şiS¶™Args
(
lše
,&
¬gc
);

1307 ià(
hi¡Üy
è
	`lš’oi£Hi¡ÜyAdd
(
lše
);

1308 ià(
hi¡Üyfe
è
	`lš’oi£Hi¡ÜySave
(historyfile);

1310 ià(
¬gv
 =ğ
NULL
) {

1311 
	`´štf
("Invalid‡rgument(s)\n");

1312 
	`lš’oi£F»e
(
lše
);

1314 } ià(
¬gc
 > 0) {

1315 ià(
	`¡rÿ£cmp
(
¬gv
[0],"quit") == 0 ||

1316 
	`¡rÿ£cmp
(
¬gv
[0],"exit") == 0)

1318 
	`ex™
(0);

1319 } ià(
¬gv
[0][0] == ':') {

1320 
	`şiS‘P»ã»nûs
(
¬gv
,
¬gc
,1);

1322 } ià(
	`¡rÿ£cmp
(
¬gv
[0],"restart") == 0) {

1323 ià(
cÚfig
.
ev®
) {

1324 
cÚfig
.
ev®_ldb
 = 1;

1325 
cÚfig
.
ouut
 = 
OUTPUT_RAW
;

1328 
	`´štf
("Use 'restart' only in Lua debugging mode.");

1330 } ià(
¬gc
 =ğ3 && !
	`¡rÿ£cmp
(
¬gv
[0],"connect")) {

1331 
	`sdsä“
(
cÚfig
.
ho¡
);

1332 
cÚfig
.
ho¡
 = 
	`sd¢ew
(
¬gv
[1]);

1333 
cÚfig
.
ho¡pÜt
 = 
	`©oi
(
¬gv
[2]);

1334 
	`şiReäeshProm±
();

1335 
	`şiCÚÃù
(1);

1336 } ià(
¬gc
 =ğ1 && !
	`¡rÿ£cmp
(
¬gv
[0],"clear")) {

1337 
	`lš’oi£CË¬Sü“n
();

1339 
¡¬t_time
 = 
	`m¡ime
(), 
–­£d
;

1340 
»³©
, 
sk¬gs
 = 0;

1341 *
’d±r
;

1343 
»³©
 = 
	`¡¹Ş
(
¬gv
[0], &
’d±r
, 10);

1344 ià(
¬gc
 > 1 && *
’d±r
 =ğ'\0' && 
»³©
) {

1345 
sk¬gs
 = 1;

1347 
»³©
 = 1;

1350 
	`issueCommªdR•—t
(
¬gc
-
sk¬gs
, 
¬gv
+sk¬gs, 
»³©
);

1354 ià(
cÚfig
.
ev®_ldb_’d
) {

1355 
cÚfig
.
ev®_ldb_’d
 = 0;

1356 
	`şiR—dR•ly
(0);

1357 
	`´štf
("\n(Lua debugging sessionƒnded%s)\n\n",

1358 
cÚfig
.
ev®_ldb_sync
 ? "" :

1362 
–­£d
 = 
	`m¡ime
()-
¡¬t_time
;

1363 ià(
–­£d
 >= 500 &&

1364 
cÚfig
.
ouut
 =ğ
OUTPUT_STANDARD
)

1366 
	`´štf
("(%.2fs)\n",()
–­£d
/1000);

1371 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

1374 
	`lš’oi£F»e
(
lše
);

1376 
	`ex™
(0);

1377 
	}
}

1379 
	$nÚš‹¿ùive
(
¬gc
, **
¬gv
) {

1380 
»tv®
 = 0;

1381 ià(
cÚfig
.
¡dš¬g
) {

1382 
¬gv
 = 
	`z»®loc
×rgv, (
¬gc
+1)*(*));

1383 
¬gv
[
¬gc
] = 
	`»adArgFromStdš
();

1384 
»tv®
 = 
	`issueCommªd
(
¬gc
+1, 
¬gv
);

1386 
»tv®
 = 
	`issueCommªd
(
¬gc
, 
¬gv
);

1388  
»tv®
;

1389 
	}
}

1395 
	$ev®Mode
(
¬gc
, **
¬gv
) {

1396 
sds
 
süt
 = 
NULL
;

1397 
FILE
 *
å
;

1398 
buf
[1024];

1399 
size_t
 
Ä—d
;

1400 **
¬gv2
;

1401 
j
, 
gÙ_comma
, 
keys
;

1402 
»tv®
 = 
REDIS_OK
;

1405 ià(
cÚfig
.
ev®_ldb
) {

1406 
	`´štf
(

1414 
	`sdsä“
(
süt
);

1415 
süt
 = 
	`sd£m±y
();

1416 
gÙ_comma
 = 0;

1417 
keys
 = 0;

1420 
å
 = 
	`fİ’
(
cÚfig
.
ev®
,"r");

1421 ià(!
å
) {

1422 
	`årštf
(
¡d”r
,

1423 "Cª'ˆİ’ f'%s': %s\n", 
cÚfig
.
ev®
, 
	`¡»¼Ü
(
”ºo
));

1424 
	`ex™
(1);

1426 (
Ä—d
 = 
	`ä—d
(
buf
,1,(buf),
å
)) != 0) {

1427 
süt
 = 
	`sdsÿ’
(süt,
buf
,
Ä—d
);

1429 
	`fşo£
(
å
);

1432 ià(
cÚfig
.
ev®_ldb
) {

1433 
»disR•ly
 *
»¶y
 = 
	`»disCommªd
(
cÚ‹xt
,

1434 
cÚfig
.
ev®_ldb_sync
 ?

1436 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

1440 
¬gv2
 = 
	`zm®loc
((
sds
)*(
¬gc
+3));

1441 
¬gv2
[0] = 
	`sd¢ew
("EVAL");

1442 
¬gv2
[1] = 
süt
;

1443 
j
 = 0; j < 
¬gc
; j++) {

1444 ià(!
gÙ_comma
 && 
¬gv
[
j
][0] == ',' &&‡rgv[j][1] == 0) {

1445 
gÙ_comma
 = 1;

1448 
¬gv2
[
j
+3-
gÙ_comma
] = 
	`sd¢ew
(
¬gv
[j]);

1449 ià(!
gÙ_comma
è
keys
++;

1451 
¬gv2
[2] = 
	`sdsÿrštf
(
	`sd£m±y
(),"%d",
keys
);

1454 
ev®_ldb
 = 
cÚfig
.eval_ldb;

1455 
»tv®
 = 
	`issueCommªd
(
¬gc
+3-
gÙ_comma
, 
¬gv2
);

1456 ià(
ev®_ldb
) {

1457 ià(!
cÚfig
.
ev®_ldb
) {

1461 
	`´štf
("Eval debugging session can't start:\n");

1462 
	`şiR—dR•ly
(0);

1465 
	`¡ºıy
(
cÚfig
.
´om±
,"lua debugger> ",(config.prompt));

1466 
	`»¶
();

1468 
	`şiCÚÃù
(1);

1469 
	`´štf
("\n");

1475  
»tv®
;

1476 
	}
}

1482 
	$Ï‹ncyModePršt
(
mš
, 
max
, 
avg
, 
couÁ
) {

1483 ià(
cÚfig
.
ouut
 =ğ
OUTPUT_STANDARD
) {

1484 
	`´štf
("min: %lld, max: %lld,‡vg: %.2f (%lld samples)",

1485 
mš
, 
max
, 
avg
, 
couÁ
);

1486 
	`fæush
(
¡dout
);

1487 } ià(
cÚfig
.
ouut
 =ğ
OUTPUT_CSV
) {

1488 
	`´štf
("%Îd,%Îd,%.2f,%Îd\n", 
mš
, 
max
, 
avg
, 
couÁ
);

1489 } ià(
cÚfig
.
ouut
 =ğ
OUTPUT_RAW
) {

1490 
	`´štf
("%Îd %Îd %.2à%Îd\n", 
mš
, 
max
, 
avg
, 
couÁ
);

1492 
	}
}

1494 
	#LATENCY_SAMPLE_RATE
 10

	)

1495 
	#LATENCY_HISTORY_DEFAULT_INTERVAL
 15000

	)

1496 
	$Ï‹ncyMode
() {

1497 
»disR•ly
 *
»¶y
;

1498 
¡¬t
, 
Ï‹ncy
, 
mš
 = 0, 
max
 = 0, 
tÙ
 = 0, 
couÁ
 = 0;

1499 
hi¡Üy_š‹rv®
 =

1500 
cÚfig
.
š‹rv®
 ? config.interval/1000 :

1501 
LATENCY_HISTORY_DEFAULT_INTERVAL
;

1502 
avg
;

1503 
hi¡Üy_¡¬t
 = 
	`m¡ime
();

1507 ià(
cÚfig
.
š‹rv®
 == 0) {

1508 
cÚfig
.
š‹rv®
 = 1000;

1510 
cÚfig
.
š‹rv®
 /= 1000;

1513 ià(!
cÚ‹xt
è
	`ex™
(1);

1515 
¡¬t
 = 
	`m¡ime
();

1516 
»¶y
 = 
	`»cÚÃùšgRedisCommªd
(
cÚ‹xt
,"PING");

1517 ià(
»¶y
 =ğ
NULL
) {

1518 
	`årštf
(
¡d”r
,"\nI/Oƒrror\n");

1519 
	`ex™
(1);

1521 
Ï‹ncy
 = 
	`m¡ime
()-
¡¬t
;

1522 
	`ä“R•lyObjeù
(
»¶y
);

1523 
couÁ
++;

1524 ià(
couÁ
 == 1) {

1525 
mš
 = 
max
 = 
tÙ
 = 
Ï‹ncy
;

1526 
avg
 = (è
Ï‹ncy
;

1528 ià(
Ï‹ncy
 < 
mš
) min =†atency;

1529 ià(
Ï‹ncy
 > 
max
) max =†atency;

1530 
tÙ
 +ğ
Ï‹ncy
;

1531 
avg
 = (è
tÙ
/
couÁ
;

1534 ià(
cÚfig
.
ouut
 =ğ
OUTPUT_STANDARD
) {

1535 
	`´štf
("\x1b[0G\x1b[2K");

1536 
	`Ï‹ncyModePršt
(
mš
,
max
,
avg
,
couÁ
);

1538 ià(
cÚfig
.
Ï‹ncy_hi¡Üy
) {

1539 
	`Ï‹ncyModePršt
(
mš
,
max
,
avg
,
couÁ
);

1540 } ià(
	`m¡ime
()-
hi¡Üy_¡¬t
 > 
cÚfig
.
š‹rv®
) {

1541 
	`Ï‹ncyModePršt
(
mš
,
max
,
avg
,
couÁ
);

1542 
	`ex™
(0);

1546 ià(
cÚfig
.
Ï‹ncy_hi¡Üy
 && 
	`m¡ime
()-
hi¡Üy_¡¬t
 > 
hi¡Üy_š‹rv®
)

1548 
	`´štf
(" -- %.2à£cÚd ¿nge\n", ()(
	`m¡ime
()-
hi¡Üy_¡¬t
)/1000);

1549 
hi¡Üy_¡¬t
 = 
	`m¡ime
();

1550 
mš
 = 
max
 = 
tÙ
 = 
couÁ
 = 0;

1552 
	`u¦“p
(
LATENCY_SAMPLE_RATE
 * 1000);

1554 
	}
}

1560 
	#LATENCY_DIST_DEFAULT_INTERVAL
 1000

	)

1563 
	sdi¡§m¶es
 {

1564 
	mmax
;

1565 
	mcouÁ
;

1566 
	mch¬aù”
;

1580 
	$showL©’cyDi¡Sam¶es
(
di¡§m¶es
 *
§m¶es
, 
tÙ
) {

1581 
j
;

1588 
	`´štf
("\033[38;5;0m");

1589 
j
 = 0; ; j++) {

1590 
cŞÜidx
 =

1591 
	`û
((è
§m¶es
[
j
].
couÁ
 / 
tÙ
 * (
¥eùrum_·Ë‰e_size
-1));

1592 
cŞÜ
 = 
¥eùrum_·Ë‰e
[
cŞÜidx
];

1593 
	`´štf
("\033[48;5;%dm%c", ()
cŞÜ
, 
§m¶es
[
j
].
ch¬aù”
);

1594 
§m¶es
[
j
].
couÁ
 = 0;

1595 ià(
§m¶es
[
j
].
max
 == 0) ;

1597 
	`´štf
("\033[0m\n");

1598 
	`fæush
(
¡dout
);

1599 
	}
}

1603 
	$showL©’cyDi¡Leg’d
() {

1604 
j
;

1606 
	`´štf
("---------------------------------------------\n");

1607 
	`´štf
(". - * # .01 .125 .25 .5 milliseconds\n");

1608 
	`´štf
("1,2,3,...,9 from 1o 9 milliseconds\n");

1609 
	`´štf
("A,B,C,D,E 10,20,30,40,50 milliseconds\n");

1610 
	`´štf
("F,G,H,I,J .1,.2,.3,.4,.5 seconds\n");

1611 
	`´štf
("K,L,M,N,O,P,Q,? 1,2,4,8,16,30,60,>60 seconds\n");

1612 
	`´štf
("From 0o 100%%: ");

1613 
j
 = 0; j < 
¥eùrum_·Ë‰e_size
; j++) {

1614 
	`´štf
("\033[48;5;%dm ", 
¥eùrum_·Ë‰e
[
j
]);

1616 
	`´štf
("\033[0m\n");

1617 
	`´štf
("---------------------------------------------\n");

1618 
	}
}

1620 
	$Ï‹ncyDi¡Mode
() {

1621 
»disR•ly
 *
»¶y
;

1622 
¡¬t
, 
Ï‹ncy
, 
couÁ
 = 0;

1623 
hi¡Üy_š‹rv®
 =

1624 
cÚfig
.
š‹rv®
 ? config.interval/1000 :

1625 
LATENCY_DIST_DEFAULT_INTERVAL
;

1626 
hi¡Üy_¡¬t
 = 
	`u¡ime
();

1627 
j
, 
ouuts
 = 0;

1629 
di¡§m¶es
 
§m¶es
[] = {

1666 ià(!
cÚ‹xt
è
	`ex™
(1);

1668 
¡¬t
 = 
	`u¡ime
();

1669 
»¶y
 = 
	`»cÚÃùšgRedisCommªd
(
cÚ‹xt
,"PING");

1670 ià(
»¶y
 =ğ
NULL
) {

1671 
	`årštf
(
¡d”r
,"\nI/Oƒrror\n");

1672 
	`ex™
(1);

1674 
Ï‹ncy
 = 
	`u¡ime
()-
¡¬t
;

1675 
	`ä“R•lyObjeù
(
»¶y
);

1676 
couÁ
++;

1679 
j
 = 0; ; j++) {

1680 ià(
§m¶es
[
j
].
max
 =ğ0 || 
Ï‹ncy
 <= samples[j].max) {

1681 
§m¶es
[
j
].
couÁ
++;

1687 ià(
couÁ
 && (
	`u¡ime
()-
hi¡Üy_¡¬t
)/1000 > 
hi¡Üy_š‹rv®
) {

1688 ià((
ouuts
++ % 20) == 0)

1689 
	`showL©’cyDi¡Leg’d
();

1690 
	`showL©’cyDi¡Sam¶es
(
§m¶es
,
couÁ
);

1691 
hi¡Üy_¡¬t
 = 
	`u¡ime
();

1692 
couÁ
 = 0;

1694 
	`u¦“p
(
LATENCY_SAMPLE_RATE
 * 1000);

1696 
	}
}

1704 
	$£ndSync
(
fd
) {

1709 
buf
[4096], *
p
;

1710 
ssize_t
 
Ä—d
;

1713 ià(
	`wr™e
(
fd
,"SYNC\r\n",6) != 6) {

1714 
	`årštf
(
¡d”r
,"Error writingo master\n");

1715 
	`ex™
(1);

1719 
p
 = 
buf
;

1721 
Ä—d
 = 
	`»ad
(
fd
,
p
,1);

1722 ià(
Ä—d
 <= 0) {

1723 
	`årštf
(
¡d”r
,"Error„eading bulk†ength while SYNCing\n");

1724 
	`ex™
(1);

1726 ià(*
p
 =ğ'\n' &&… !ğ
buf
) ;

1727 ià(*
p
 != '\n')…++;

1729 *
p
 = '\0';

1730 ià(
buf
[0] == '-') {

1731 
	`´štf
("SYNC w™h ma¡” faed: %s\n", 
buf
);

1732 
	`ex™
(1);

1734  
	`¡¹ouÎ
(
buf
+1,
NULL
,10);

1735 
	}
}

1737 
	$¦aveMode
() {

1738 
fd
 = 
cÚ‹xt
->fd;

1739 
·ylßd
 = 
	`£ndSync
(
fd
);

1740 
buf
[1024];

1741 
Üigš®_ouut
 = 
cÚfig
.
ouut
;

1743 
	`årštf
(
¡d”r
,"SYNC with master, discarding %llu "

1744 "by‹ oàbulk¿nsãr...\n", 
·ylßd
);

1747 
·ylßd
) {

1748 
ssize_t
 
Ä—d
;

1750 
Ä—d
 = 
	`»ad
(
fd
,
buf
,(
·ylßd
 > (buf)) ? (buf) :…ayload);

1751 ià(
Ä—d
 <= 0) {

1752 
	`årštf
(
¡d”r
,"Error„eading RDB…ayload while SYNCing\n");

1753 
	`ex™
(1);

1755 
·ylßd
 -ğ
Ä—d
;

1757 
	`årštf
(
¡d”r
,"SYNC done. Logging commands from master.\n");

1760 
cÚfig
.
ouut
 = 
OUTPUT_CSV
;

1761 
	`şiR—dR•ly
(0è=ğ
REDIS_OK
);

1762 
cÚfig
.
ouut
 = 
Üigš®_ouut
;

1763 
	}
}

1771 
	$g‘RDB
() {

1772 
s
 = 
cÚ‹xt
->
fd
;

1773 
fd
;

1774 
·ylßd
 = 
	`£ndSync
(
s
);

1775 
buf
[4096];

1777 
	`årštf
(
¡d”r
,"SYNC sento master, writing %llu byteso '%s'\n",

1778 
·ylßd
, 
cÚfig
.
rdb_f’ame
);

1781 ià(!
	`¡rcmp
(
cÚfig
.
rdb_f’ame
,"-")) {

1782 
fd
 = 
STDOUT_FILENO
;

1784 
fd
 = 
	`İ’
(
cÚfig
.
rdb_f’ame
, 
O_CREAT
|
O_WRONLY
, 0644);

1785 ià(
fd
 == -1) {

1786 
	`årštf
(
¡d”r
, "E¼Ü o³nšg '%s': %s\n", 
cÚfig
.
rdb_f’ame
,

1787 
	`¡»¼Ü
(
”ºo
));

1788 
	`ex™
(1);

1792 
·ylßd
) {

1793 
ssize_t
 
Ä—d
, 
nwr™‹n
;

1795 
Ä—d
 = 
	`»ad
(
s
,
buf
,(
·ylßd
 > (buf)) ? (buf) :…ayload);

1796 ià(
Ä—d
 <= 0) {

1797 
	`årštf
(
¡d”r
,"I/O Error„eading RDB…ayload from socket\n");

1798 
	`ex™
(1);

1800 
nwr™‹n
 = 
	`wr™e
(
fd
, 
buf
, 
Ä—d
);

1801 ià(
nwr™‹n
 !ğ
Ä—d
) {

1802 
	`årštf
(
¡d”r
,"Error writing datao file: %s\n",

1803 
	`¡»¼Ü
(
”ºo
));

1804 
	`ex™
(1);

1806 
·ylßd
 -ğ
Ä—d
;

1808 
	`şo£
(
s
);

1809 
	`fsync
(
fd
);

1810 
	`årštf
(
¡d”r
,"Transfer finished with success.\n");

1811 
	`ex™
(0);

1812 
	}
}

1818 
	#PIPEMODE_WRITE_LOOP_MAX_BYTES
 (128*1024)

	)

1819 
	$peMode
() {

1820 
fd
 = 
cÚ‹xt
->fd;

1821 
”rÜs
 = 0, 
»¶›s
 = 0, 
obuf_Ën
 = 0, 
obuf_pos
 = 0;

1822 
ibuf
[1024*16], 
obuf
[1024*16];

1823 
ª‘”r
[
ANET_ERR_LEN
];

1824 
»disR—d”
 *
»ad”
 = 
	`»disR—d”C»©e
();

1825 
»disR•ly
 *
»¶y
;

1826 
eof
 = 0;

1827 
dÚe
 = 0;

1828 
magic
[20];

1829 
time_t
 
Ï¡_»ad_time
 = 
	`time
(
NULL
);

1831 
	`¤ªd
(
	`time
(
NULL
));

1834 ià(
	`ª‘NÚBlock
(
ª‘”r
,
fd
è=ğ
ANET_ERR
) {

1835 
	`årštf
(
¡d”r
, "Can't sethe socket in‚on blocking mode: %s\n",

1836 
ª‘”r
);

1837 
	`ex™
(1);

1842 !
dÚe
) {

1843 
mask
 = 
AE_READABLE
;

1845 ià(!
eof
 || 
obuf_Ën
 !ğ0è
mask
 |ğ
AE_WRITABLE
;

1846 
mask
 = 
	`«Wa™
(
fd
,mask,1000);

1849 ià(
mask
 & 
AE_READABLE
) {

1850 
ssize_t
 
Ä—d
;

1854 
Ä—d
 = 
	`»ad
(
fd
,
ibuf
,(ibuf));

1855 ià(
Ä—d
 =ğ-1 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
) {

1856 
	`årštf
(
¡d”r
, "Error„eading fromhe server: %s\n",

1857 
	`¡»¼Ü
(
”ºo
));

1858 
	`ex™
(1);

1860 ià(
Ä—d
 > 0) {

1861 
	`»disR—d”F“d
(
»ad”
,
ibuf
,
Ä—d
);

1862 
Ï¡_»ad_time
 = 
	`time
(
NULL
);

1864 } 
Ä—d
 > 0);

1868 ià(
	`»disR—d”G‘R•ly
(
»ad”
,(**)&
»¶y
è=ğ
REDIS_ERR
) {

1869 
	`årštf
(
¡d”r
, "Error„eading„eplies from server\n");

1870 
	`ex™
(1);

1872 ià(
»¶y
) {

1873 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

1874 
	`årštf
(
¡d”r
,"%s\n", 
»¶y
->
¡r
);

1875 
”rÜs
++;

1876 } ià(
eof
 && 
»¶y
->
ty³
 =ğ
REDIS_REPLY_STRING
 &&

1877 
»¶y
->
Ën
 == 20) {

1881 ià(
	`memcmp
(
»¶y
->
¡r
,
magic
,20) == 0) {

1882 
	`´štf
("Last„eply„eceived from server.\n");

1883 
dÚe
 = 1;

1884 
»¶›s
--;

1887 
»¶›s
++;

1888 
	`ä“R•lyObjeù
(
»¶y
);

1890 } 
»¶y
);

1894 ià(
mask
 & 
AE_WRITABLE
) {

1895 
ssize_t
 
loİ_nwr™‹n
 = 0;

1899 ià(
obuf_Ën
 != 0) {

1900 
ssize_t
 
nwr™‹n
 = 
	`wr™e
(
fd
,
obuf
+
obuf_pos
,
obuf_Ën
);

1902 ià(
nwr™‹n
 == -1) {

1903 ià(
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
) {

1904 
	`årštf
(
¡d”r
, "Error writingohe server: %s\n",

1905 
	`¡»¼Ü
(
”ºo
));

1906 
	`ex™
(1);

1908 
nwr™‹n
 = 0;

1911 
obuf_Ën
 -ğ
nwr™‹n
;

1912 
obuf_pos
 +ğ
nwr™‹n
;

1913 
loİ_nwr™‹n
 +ğ
nwr™‹n
;

1914 ià(
obuf_Ën
 != 0) ;

1917 ià(
obuf_Ën
 =ğ0 && !
eof
) {

1918 
ssize_t
 
Ä—d
 = 
	`»ad
(
STDIN_FILENO
,
obuf
,(obuf));

1920 ià(
Ä—d
 == 0) {

1925 
echo
[] =

1927 
j
;

1929 
eof
 = 1;

1933 
j
 = 0; j < 20; j++)

1934 
magic
[
j
] = 
	`¿nd
() & 0xff;

1935 
	`memıy
(
echo
+21,
magic
,20);

1936 
	`memıy
(
obuf
,
echo
,(echo)-1);

1937 
obuf_Ën
 = (
echo
)-1;

1938 
obuf_pos
 = 0;

1939 
	`´štf
("All dataransferred. Waiting forhe†ast„eply...\n");

1940 } ià(
Ä—d
 == -1) {

1941 
	`årštf
(
¡d”r
, "Error„eading from stdin: %s\n",

1942 
	`¡»¼Ü
(
”ºo
));

1943 
	`ex™
(1);

1945 
obuf_Ën
 = 
Ä—d
;

1946 
obuf_pos
 = 0;

1949 ià((
obuf_Ën
 =ğ0 && 
eof
) ||

1950 
loİ_nwr™‹n
 > 
PIPEMODE_WRITE_LOOP_MAX_BYTES
) ;

1957 ià(
eof
 && 
cÚfig
.
pe_timeout
 > 0 &&

1958 
	`time
(
NULL
)-
Ï¡_»ad_time
 > 
cÚfig
.
pe_timeout
)

1960 
	`årštf
(
¡d”r
,"No„eplies for %d seconds:ƒxiting.\n",

1961 
cÚfig
.
pe_timeout
);

1962 
”rÜs
++;

1966 
	`»disR—d”F»e
(
»ad”
);

1967 
	`´štf
("”rÜs: %Îd,„•l›s: %Îd\n", 
”rÜs
, 
»¶›s
);

1968 ià(
”rÜs
)

1969 
	`ex™
(1);

1971 
	`ex™
(0);

1972 
	}
}

1978 
	#TYPE_STRING
 0

	)

1979 
	#TYPE_LIST
 1

	)

1980 
	#TYPE_SET
 2

	)

1981 
	#TYPE_HASH
 3

	)

1982 
	#TYPE_ZSET
 4

	)

1983 
	#TYPE_NONE
 5

	)

1985 
»disR•ly
 *
	$£ndSÿn
(*
™
) {

1986 
»disR•ly
 *
»¶y
 = 
	`»disCommªd
(
cÚ‹xt
, "SCAN %Îu", *
™
);

1989 if(
»¶y
 =ğ
NULL
) {

1990 
	`årštf
(
¡d”r
, "\nI/Oƒrror\n");

1991 
	`ex™
(1);

1992 } if(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

1993 
	`årštf
(
¡d”r
, "SCANƒ¼Ü: %s\n", 
»¶y
->
¡r
);

1994 
	`ex™
(1);

1995 } if(
»¶y
->
ty³
 !ğ
REDIS_REPLY_ARRAY
) {

1996 
	`årštf
(
¡d”r
, "Non ARRAY„esponse from SCAN!\n");

1997 
	`ex™
(1);

1998 } if(
»¶y
->
–em’ts
 != 2) {

1999 
	`årštf
(
¡d”r
, "Invalidƒlement count from SCAN!\n");

2000 
	`ex™
(1);

2004 
	`as£¹
(
»¶y
->
–em’t
[0]->
ty³
 =ğ
REDIS_REPLY_STRING
);

2005 
	`as£¹
(
»¶y
->
–em’t
[1]->
ty³
 =ğ
REDIS_REPLY_ARRAY
);

2008 *
™
 = 
	`¡¹ouÎ
(
»¶y
->
–em’t
[0]->
¡r
, 
NULL
, 10);

2010  
»¶y
;

2011 
	}
}

2013 
	$g‘DbSize
() {

2014 
»disR•ly
 *
»¶y
;

2015 
size
;

2017 
»¶y
 = 
	`»disCommªd
(
cÚ‹xt
, "DBSIZE");

2019 if(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
) {

2020 
	`årštf
(
¡d”r
, "Couldn't determine DBSIZE!\n");

2021 
	`ex™
(1);

2025 
size
 = 
»¶y
->
š‹g”
;

2026 
	`ä“R•lyObjeù
(
»¶y
);

2028  
size
;

2029 
	}
}

2031 
	$toIÁTy³
(*
key
, *
ty³
) {

2032 if(!
	`¡rcmp
(
ty³
, "string")) {

2033  
TYPE_STRING
;

2034 } if(!
	`¡rcmp
(
ty³
, "list")) {

2035  
TYPE_LIST
;

2036 } if(!
	`¡rcmp
(
ty³
, "set")) {

2037  
TYPE_SET
;

2038 } if(!
	`¡rcmp
(
ty³
, "hash")) {

2039  
TYPE_HASH
;

2040 } if(!
	`¡rcmp
(
ty³
, "zset")) {

2041  
TYPE_ZSET
;

2042 } if(!
	`¡rcmp
(
ty³
, "none")) {

2043  
TYPE_NONE
;

2045 
	`årštf
(
¡d”r
, "UnknowÀty³ '%s' fÜ key '%s'\n", 
ty³
, 
key
);

2046 
	`ex™
(1);

2048 
	}
}

2050 
	$g‘KeyTy³s
(
»disR•ly
 *
keys
, *
ty³s
) {

2051 
»disR•ly
 *
»¶y
;

2052 
i
;

2055 
i
=0;i<
keys
->
–em’ts
;i++) {

2056 
	`»disAµ’dCommªd
(
cÚ‹xt
, "TYPE %s", 
keys
->
–em’t
[
i
]->
¡r
);

2060 
i
=0;i<
keys
->
–em’ts
;i++) {

2061 if(
	`»disG‘R•ly
(
cÚ‹xt
, (**)&
»¶y
)!=
REDIS_OK
) {

2062 
	`årštf
(
¡d”r
, "Error gettingype for key '%s' (%d: %s)\n",

2063 
keys
->
–em’t
[
i
]->
¡r
, 
cÚ‹xt
->
”r
, cÚ‹xt->
”r¡r
);

2064 
	`ex™
(1);

2065 } if(
»¶y
->
ty³
 !ğ
REDIS_REPLY_STATUS
) {

2066 if(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

2067 
	`årštf
(
¡d”r
, "TYPE„‘uºed‡À”rÜ: %s\n", 
»¶y
->
¡r
);

2069 
	`årštf
(
¡d”r
,

2071 
»¶y
->
ty³
, 
keys
->
–em’t
[
i
]->
¡r
);

2073 
	`ex™
(1);

2076 
ty³s
[
i
] = 
	`toIÁTy³
(
keys
->
–em’t
[i]->
¡r
, 
»¶y
->str);

2077 
	`ä“R•lyObjeù
(
»¶y
);

2079 
	}
}

2081 
	$g‘KeySizes
(
»disR•ly
 *
keys
, *
ty³s
,

2082 *
sizes
)

2084 
»disR•ly
 *
»¶y
;

2085 *
sizecmds
[] = {"STRLEN","LLEN","SCARD","HLEN","ZCARD"};

2086 
i
;

2089 
i
=0;i<
keys
->
–em’ts
;i++) {

2091 if(
ty³s
[
i
]==
TYPE_NONE
)

2094 
	`»disAµ’dCommªd
(
cÚ‹xt
, "% %s", 
sizecmds
[
ty³s
[
i
]],

2095 
keys
->
–em’t
[
i
]->
¡r
);

2099 
i
=0;i<
keys
->
–em’ts
;i++) {

2101 if(
ty³s
[
i
] =ğ
TYPE_NONE
) {

2102 
sizes
[
i
] = 0;

2107 if(
	`»disG‘R•ly
(
cÚ‹xt
, (**)&
»¶y
)!=
REDIS_OK
) {

2108 
	`årštf
(
¡d”r
, "Error getting size for key '%s' (%d: %s)\n",

2109 
keys
->
–em’t
[
i
]->
¡r
, 
cÚ‹xt
->
”r
, cÚ‹xt->
”r¡r
);

2110 
	`ex™
(1);

2111 } if(
»¶y
->
ty³
 !ğ
REDIS_REPLY_INTEGER
) {

2114 
	`årštf
(
¡d”r
,

2116 
sizecmds
[
ty³s
[
i
]], 
keys
->
–em’t
[i]->
¡r
);

2117 
sizes
[
i
] = 0;

2119 
sizes
[
i
] = 
»¶y
->
š‹g”
;

2122 
	`ä“R•lyObjeù
(
»¶y
);

2124 
	}
}

2126 
	$fšdBigKeys
() {

2127 
bigge¡
[5] = {0}, 
couÁs
[5] = {0}, 
tÙ®size
[5] = {0};

2128 
§m¶ed
 = 0, 
tÙ®_keys
, 
tÙËn
=0, *
sizes
=
NULL
, 
™
=0;

2129 
sds
 
maxkeys
[5] = {0};

2130 *
ty³Çme
[] = {"string","list","set","hash","zset"};

2131 *
ty³un™
[] = {"bytes","items","members","fields","members"};

2132 
»disR•ly
 *
»¶y
, *
keys
;

2133 
¬rsize
=0, 
i
;

2134 
ty³
, *
ty³s
=
NULL
;

2135 
pù
;

2138 
tÙ®_keys
 = 
	`g‘DbSize
();

2141 
	`´štf
("\n# Scanningheƒntire keyspaceo find biggest keys‡s well‡s\n");

2142 
	`´štf
("#‡verage sizes…er keyype. You can use -i 0.1o sleep 0.1 sec\n");

2143 
	`´štf
("#…er 100 SCAN commands (not usually‚eeded).\n\n");

2146 
i
=0;i<
TYPE_NONE
; i++) {

2147 
maxkeys
[
i
] = 
	`sd£m±y
();

2148 if(!
maxkeys
[
i
]) {

2149 
	`årštf
(
¡d”r
, "Failedo‡llocate memory for†argest key‚ames!\n");

2150 
	`ex™
(1);

2157 
pù
 = 100 * ()
§m¶ed
/
tÙ®_keys
;

2160 
»¶y
 = 
	`£ndSÿn
(&
™
);

2161 
keys
 = 
»¶y
->
–em’t
[1];

2164 if(
keys
->
–em’ts
 > 
¬rsize
) {

2165 
ty³s
 = 
	`z»®loc
Ñy³s, ()*
keys
->
–em’ts
);

2166 
sizes
 = 
	`z»®loc
(sizes, ()*
keys
->
–em’ts
);

2168 if(!
ty³s
 || !
sizes
) {

2169 
	`årštf
(
¡d”r
, "Failedo‡llocate storage for keys!\n");

2170 
	`ex™
(1);

2173 
¬rsize
 = 
keys
->
–em’ts
;

2177 
	`g‘KeyTy³s
(
keys
, 
ty³s
);

2178 
	`g‘KeySizes
(
keys
, 
ty³s
, 
sizes
);

2181 
i
=0;i<
keys
->
–em’ts
;i++) {

2182 if((
ty³
 = 
ty³s
[
i
]è=ğ
TYPE_NONE
)

2185 
tÙ®size
[
ty³
] +ğ
sizes
[
i
];

2186 
couÁs
[
ty³
]++;

2187 
tÙËn
 +ğ
keys
->
–em’t
[
i
]->
Ën
;

2188 
§m¶ed
++;

2190 if(
bigge¡
[
ty³
]<
sizes
[
i
]) {

2191 
	`´štf
(

2193 
pù
, 
ty³Çme
[
ty³
], 
keys
->
–em’t
[
i
]->
¡r
, 
sizes
[i],

2194 
ty³un™
[
ty³
]);

2197 
maxkeys
[
ty³
] = 
	`sdsıy
(maxkeys[ty³], 
keys
->
–em’t
[
i
]->
¡r
);

2198 if(!
maxkeys
[
ty³
]) {

2199 
	`årštf
(
¡d”r
, "Failedo‡llocate memory for key!\n");

2200 
	`ex™
(1);

2204 
bigge¡
[
ty³
] = 
sizes
[
i
];

2208 if(
§m¶ed
 % 1000000 == 0) {

2209 
	`´štf
("[%05.2f%%] Sam¶ed %Îu key sØçr\n", 
pù
, 
§m¶ed
);

2214 if(
§m¶ed
 && (§m¶ed %100è=ğ0 && 
cÚfig
.
š‹rv®
) {

2215 
	`u¦“p
(
cÚfig
.
š‹rv®
);

2218 
	`ä“R•lyObjeù
(
»¶y
);

2219 } 
™
 != 0);

2221 if(
ty³s
è
	`zä“
(types);

2222 if(
sizes
è
	`zä“
(sizes);

2225 
	`´štf
("\n-------- summary -------\n\n");

2227 
	`´štf
("Sam¶ed %Îu key šhkey¥aû!\n", 
§m¶ed
);

2228 
	`´štf
("Total key†ength in bytes is %llu (avg†en %.2f)\n\n",

2229 
tÙËn
,ÙËÀ? (éÙËn/
§m¶ed
 : 0);

2232 
i
=0;i<
TYPE_NONE
;i++) {

2233 if(
	`sd¦’
(
maxkeys
[
i
])>0) {

2234 
	`´štf
("Bigge¡ %6 found '%s' ha %Îu %s\n", 
ty³Çme
[
i
], 
maxkeys
[i],

2235 
bigge¡
[
i
], 
ty³un™
[i]);

2239 
	`´štf
("\n");

2241 
i
=0;i<
TYPE_NONE
;i++) {

2242 
	`´štf
("%llu %ss with %llu %s (%05.2f%% of keys,‡vg size %.2f)\n",

2243 
couÁs
[
i
], 
ty³Çme
[i], 
tÙ®size
[i], 
ty³un™
[i],

2244 
§m¶ed
 ? 100 * ()
couÁs
[
i
]/sampled : 0,

2245 
couÁs
[
i
] ? ()
tÙ®size
[i]/counts[i] : 0);

2249 
i
=0;i<
TYPE_NONE
;i++) {

2250 
	`sdsä“
(
maxkeys
[
i
]);

2254 
	`ex™
(0);

2255 
	}
}

2264 *
	$g‘InfoF›ld
(*
šfo
, *
f›ld
) {

2265 *
p
 = 
	`¡r¡r
(
šfo
,
f›ld
);

2266 *
n1
, *
n2
;

2267 *
»suÉ
;

2269 ià(!
p
è 
NULL
;

2270 
p
 +ğ
	`¡¾’
(
f›ld
)+1;

2271 
n1
 = 
	`¡rchr
(
p
,'\r');

2272 
n2
 = 
	`¡rchr
(
p
,',');

2273 ià(
n2
 &&‚2 < 
n1
)‚1 =‚2;

2274 
»suÉ
 = 
	`zm®loc
(()*(
n1
-
p
)+1);

2275 
	`memıy
(
»suÉ
,
p
,(
n1
-p));

2276 
»suÉ
[
n1
-
p
] = '\0';

2277  
»suÉ
;

2278 
	}
}

2282 
	$g‘LÚgInfoF›ld
(*
šfo
, *
f›ld
) {

2283 *
v®ue
 = 
	`g‘InfoF›ld
(
šfo
,
f›ld
);

2284 
l
;

2286 ià(!
v®ue
è 
LONG_MIN
;

2287 
l
 = 
	`¡¹Ş
(
v®ue
,
NULL
,10);

2288 
	`zä“
(
v®ue
);

2289  
l
;

2290 
	}
}

2294 
	$by‹sToHumª
(*
s
, 
n
) {

2295 
d
;

2297 ià(
n
 < 0) {

2298 *
s
 = '-';

2299 
s
++;

2300 
n
 = -n;

2302 ià(
n
 < 1024) {

2304 
	`¥rštf
(
s
,"%ÎdB",
n
);

2306 } ià(
n
 < (1024*1024)) {

2307 
d
 = ()
n
/(1024);

2308 
	`¥rštf
(
s
,"%.2fK",
d
);

2309 } ià(
n
 < (1024LL*1024*1024)) {

2310 
d
 = ()
n
/(1024*1024);

2311 
	`¥rštf
(
s
,"%.2fM",
d
);

2312 } ià(
n
 < (1024LL*1024*1024*1024)) {

2313 
d
 = ()
n
/(1024LL*1024*1024);

2314 
	`¥rštf
(
s
,"%.2fG",
d
);

2316 
	}
}

2318 
	$¡©Mode
() {

2319 
»disR•ly
 *
»¶y
;

2320 
aux
, 
»que¡s
 = 0;

2321 
i
 = 0;

2324 
buf
[64];

2325 
j
;

2327 
»¶y
 = 
	`»cÚÃùšgRedisCommªd
(
cÚ‹xt
,"INFO");

2328 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

2329 
	`´štf
("ERROR: %s\n", 
»¶y
->
¡r
);

2330 
	`ex™
(1);

2333 ià((
i
++ % 20) == 0) {

2334 
	`´štf
(

2340 
aux
 = 0;

2341 
j
 = 0; j < 20; j++) {

2342 
k
;

2344 
	`¥rštf
(
buf
,"db%d:keys",
j
);

2345 
k
 = 
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,
buf
);

2346 ià(
k
 =ğ
LONG_MIN
) ;

2347 
aux
 +ğ
k
;

2349 
	`¥rštf
(
buf
,"%ld",
aux
);

2350 
	`´štf
("%-11s",
buf
);

2353 
aux
 = 
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,"used_memory");

2354 
	`by‹sToHumª
(
buf
,
aux
);

2355 
	`´štf
("%-8s",
buf
);

2358 
aux
 = 
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,"connected_clients");

2359 
	`¥rštf
(
buf
,"%ld",
aux
);

2360 
	`´štf
(" %-8s",
buf
);

2363 
aux
 = 
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,"blocked_clients");

2364 
	`¥rštf
(
buf
,"%ld",
aux
);

2365 
	`´štf
("%-8s",
buf
);

2368 
aux
 = 
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,"total_commands_processed");

2369 
	`¥rštf
(
buf
,"%ld (+%ld)",
aux
,
»que¡s
 == 0 ? 0 :‡ux-requests);

2370 
	`´štf
("%-19s",
buf
);

2371 
»que¡s
 = 
aux
;

2374 
aux
 = 
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,"total_connections_received");

2375 
	`¥rštf
(
buf
,"%ld",
aux
);

2376 
	`´štf
(" %-12s",
buf
);

2379 
aux
 = 
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,"bgsave_in_progress");

2380 
aux
 |ğ
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,"aof_rewrite_in_progress") << 1;

2381 
aux
 |ğ
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,"loading") << 2;

2382 
aux
) {

2385 
	`´štf
("SAVE");

2388 
	`´štf
("AOF");

2391 
	`´štf
("SAVE+AOF");

2394 
	`´štf
("LOAD");

2398 
	`´štf
("\n");

2399 
	`ä“R•lyObjeù
(
»¶y
);

2400 
	`u¦“p
(
cÚfig
.
š‹rv®
);

2402 
	}
}

2408 
	$sÿnMode
() {

2409 
»disR•ly
 *
»¶y
;

2410 
cur
 = 0;

2413 ià(
cÚfig
.
·‰”n
)

2414 
»¶y
 = 
	`»disCommªd
(
cÚ‹xt
,"SCAN %llu MATCH %s",

2415 
cur
,
cÚfig
.
·‰”n
);

2417 
»¶y
 = 
	`»disCommªd
(
cÚ‹xt
,"SCAN %Îu",
cur
);

2418 ià(
»¶y
 =ğ
NULL
) {

2419 
	`´štf
("I/Oƒrror\n");

2420 
	`ex™
(1);

2421 } ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

2422 
	`´štf
("ERROR: %s\n", 
»¶y
->
¡r
);

2423 
	`ex™
(1);

2425 
j
;

2427 
cur
 = 
	`¡¹ouÎ
(
»¶y
->
–em’t
[0]->
¡r
,
NULL
,10);

2428 
j
 = 0; j < 
»¶y
->
–em’t
[1]->
–em’ts
; j++)

2429 
	`´štf
("%s\n", 
»¶y
->
–em’t
[1]->–em’t[
j
]->
¡r
);

2431 
	`ä“R•lyObjeù
(
»¶y
);

2432 } 
cur
 != 0);

2434 
	`ex™
(0);

2435 
	}
}

2447 
	$pow”LawRªd
(
mš
, 
max
, 
®pha
) {

2448 
¶
, 
r
;

2450 
max
 += 1;

2451 
r
 = (()
	`¿nd
()è/ 
RAND_MAX
;

2452 
¶
 = 
	`pow
(

2453 ((
	`pow
(
max
,
®pha
+1è-…ow(
mš
,®pha+1))*
r
 +…ow(min,alpha+1)),

2454 (1.0/(
®pha
+1)));

2455  (
max
-1-()
¶
)+
mš
;

2456 
	}
}

2460 
	$LRUTe¡G’Key
(*
buf
, 
size_t
 
buæ’
) {

2461 
	`¢´štf
(
buf
, 
buæ’
, "lru:%lld",

2462 
	`pow”LawRªd
(1, 
cÚfig
.
Ìu_‹¡_§m¶e_size
, 6.2));

2463 
	}
}

2465 
	#LRU_CYCLE_PERIOD
 1000

	)

2466 
	#LRU_CYCLE_PIPELINE_SIZE
 250

	)

2467 
	$LRUTe¡Mode
() {

2468 
»disR•ly
 *
»¶y
;

2469 
key
[128];

2470 
¡¬t_cyşe
;

2471 
j
;

2473 
	`¤ªd
(
	`time
(
NULL
)^
	`g‘pid
());

2478 
¡¬t_cyşe
 = 
	`m¡ime
();

2479 
h™s
 = 0, 
mis£s
 = 0;

2480 
	`m¡ime
(è- 
¡¬t_cyşe
 < 1000) {

2482 
j
 = 0; j < 
LRU_CYCLE_PIPELINE_SIZE
; j++) {

2483 
v®
[6];

2484 
v®
[5] = '\0';

2485 
i
 = 0; i < 5; i++è
v®
[i] = 'A'+
	`¿nd
()%('z'-'A');

2486 
	`LRUTe¡G’Key
(
key
,(key));

2487 
	`»disAµ’dCommªd
(
cÚ‹xt
, "SET % %s",
key
,
v®
);

2489 
j
 = 0; j < 
LRU_CYCLE_PIPELINE_SIZE
; j++)

2490 
	`»disG‘R•ly
(
cÚ‹xt
, (**)&
»¶y
);

2493 
j
 = 0; j < 
LRU_CYCLE_PIPELINE_SIZE
; j++) {

2494 
	`LRUTe¡G’Key
(
key
,(key));

2495 
	`»disAµ’dCommªd
(
cÚ‹xt
, "GET %s",
key
);

2497 
j
 = 0; j < 
LRU_CYCLE_PIPELINE_SIZE
; j++) {

2498 ià(
	`»disG‘R•ly
(
cÚ‹xt
, (**)&
»¶y
è=ğ
REDIS_OK
) {

2499 
»¶y
->
ty³
) {

2500 
REDIS_REPLY_ERROR
:

2501 
	`´štf
("%s\n", 
»¶y
->
¡r
);

2503 
REDIS_REPLY_NIL
:

2504 
mis£s
++;

2507 
h™s
++;

2513 ià(
cÚ‹xt
->
”r
) {

2514 
	`årštf
(
¡d”r
,"I/Oƒrror during LRUest\n");

2515 
	`ex™
(1);

2519 
	`´štf
(

2521 
h™s
+
mis£s
,

2522 
h™s
, ()h™s/(h™s+
mis£s
)*100,

2523 
mis£s
, ()mis£s/(
h™s
+misses)*100);

2525 
	`ex™
(0);

2526 
	}
}

2539 
	$compu‹_som‘hšg_ç¡
() {

2540 
s
[256], 
i
, 
j
, 
t
;

2541 
couÁ
 = 1000, 
k
;

2542 
ouut
 = 0;

2544 
k
 = 0; k < 256; k++è
s
[k] = k;

2546 
i
 = 0;

2547 
j
 = 0;

2548 
couÁ
--) {

2549 
i
++;

2550 
j
 = j + 
s
[
i
];

2551 
t
 = 
s
[
i
];

2552 
s
[
i
] = s[
j
];

2553 
s
[
j
] = 
t
;

2554 
ouut
 +ğ
s
[(s[
i
]+s[
j
])&255];

2556  
ouut
;

2557 
	}
}

2559 
	$šŒšsicL©’cyModeStİ
(
s
) {

2560 
	`UNUSED
(
s
);

2561 
fÜû_ÿnûl_loİ
 = 1;

2562 
	}
}

2564 
	$šŒšsicL©’cyMode
() {

2565 
‹¡_’d
, 
run_time
, 
max_Ï‹ncy
 = 0, 
runs
 = 0;

2567 
run_time
 = 
cÚfig
.
šŒšsic_Ï‹ncy_du¿tiÚ
*1000000;

2568 
‹¡_’d
 = 
	`u¡ime
(è+ 
run_time
;

2569 
	`sigÇl
(
SIGINT
, 
šŒšsicL©’cyModeStİ
);

2572 
¡¬t
, 
’d
, 
Ï‹ncy
;

2574 
¡¬t
 = 
	`u¡ime
();

2575 
	`compu‹_som‘hšg_ç¡
();

2576 
’d
 = 
	`u¡ime
();

2577 
Ï‹ncy
 = 
’d
-
¡¬t
;

2578 
runs
++;

2579 ià(
Ï‹ncy
 <= 0) ;

2582 ià(
Ï‹ncy
 > 
max_Ï‹ncy
) {

2583 
max_Ï‹ncy
 = 
Ï‹ncy
;

2584 
	`´štf
("Max†©’cy sØçr: %Îd miüo£cÚds.\n", 
max_Ï‹ncy
);

2587 
avg_us
 = ()
run_time
/
runs
;

2588 
avg_ns
 = 
avg_us
 * 1e3;

2589 ià(
fÜû_ÿnûl_loİ
 || 
’d
 > 
‹¡_’d
) {

2590 
	`´štf
("\n%lldotal„uns "

2593 
runs
, 
avg_us
, 
avg_ns
);

2594 
	`´štf
("Worst„unook %.0fx†ongerhanhe‡verage†atency.\n",

2595 
max_Ï‹ncy
 / 
avg_us
);

2596 
	`ex™
(0);

2599 
	}
}

2605 
	$maš
(
¬gc
, **
¬gv
) {

2606 
fœ¡¬g
;

2608 
cÚfig
.
ho¡
 = 
	`sd¢ew
("127.0.0.1");

2609 
cÚfig
.
ho¡pÜt
 = 6379;

2610 
cÚfig
.
ho¡sock‘
 = 
NULL
;

2611 
cÚfig
.
»³©
 = 1;

2612 
cÚfig
.
š‹rv®
 = 0;

2613 
cÚfig
.
dbnum
 = 0;

2614 
cÚfig
.
š‹¿ùive
 = 0;

2615 
cÚfig
.
shutdown
 = 0;

2616 
cÚfig
.
mÚ™Ü_mode
 = 0;

2617 
cÚfig
.
pubsub_mode
 = 0;

2618 
cÚfig
.
Ï‹ncy_mode
 = 0;

2619 
cÚfig
.
Ï‹ncy_di¡_mode
 = 0;

2620 
cÚfig
.
Ï‹ncy_hi¡Üy
 = 0;

2621 
cÚfig
.
Ìu_‹¡_mode
 = 0;

2622 
cÚfig
.
Ìu_‹¡_§m¶e_size
 = 0;

2623 
cÚfig
.
şu¡”_mode
 = 0;

2624 
cÚfig
.
¦ave_mode
 = 0;

2625 
cÚfig
.
g‘rdb_mode
 = 0;

2626 
cÚfig
.
¡©_mode
 = 0;

2627 
cÚfig
.
sÿn_mode
 = 0;

2628 
cÚfig
.
šŒšsic_Ï‹ncy_mode
 = 0;

2629 
cÚfig
.
·‰”n
 = 
NULL
;

2630 
cÚfig
.
rdb_f’ame
 = 
NULL
;

2631 
cÚfig
.
pe_mode
 = 0;

2632 
cÚfig
.
pe_timeout
 = 
REDIS_CLI_DEFAULT_PIPE_TIMEOUT
;

2633 
cÚfig
.
bigkeys
 = 0;

2634 
cÚfig
.
¡dš¬g
 = 0;

2635 
cÚfig
.
auth
 = 
NULL
;

2636 
cÚfig
.
ev®
 = 
NULL
;

2637 
cÚfig
.
ev®_ldb
 = 0;

2638 
cÚfig
.
ev®_ldb_’d
 = 0;

2639 
cÚfig
.
ev®_ldb_sync
 = 0;

2640 
cÚfig
.
’abË_ldb_Ú_ev®
 = 0;

2641 
cÚfig
.
Ï¡_cmd_ty³
 = -1;

2643 
´ef
.
hšts
 = 1;

2645 
¥eùrum_·Ë‰e
 = 
¥eùrum_·Ë‰e_cŞÜ
;

2646 
¥eùrum_·Ë‰e_size
 = 
¥eùrum_·Ë‰e_cŞÜ_size
;

2648 ià(!
	`i§‰y
(
	`f’o
(
¡dout
)è&& (
	`g‘’v
("FAKETTY"è=ğ
NULL
))

2649 
cÚfig
.
ouut
 = 
OUTPUT_RAW
;

2651 
cÚfig
.
ouut
 = 
OUTPUT_STANDARD
;

2652 
cÚfig
.
mb_d–im
 = 
	`sd¢ew
("\n");

2654 
fœ¡¬g
 = 
	`·r£O±iÚs
(
¬gc
,
¬gv
);

2655 
¬gc
 -ğ
fœ¡¬g
;

2656 
¬gv
 +ğ
fœ¡¬g
;

2659 ià(
cÚfig
.
Ï‹ncy_mode
) {

2660 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2661 
	`Ï‹ncyMode
();

2665 ià(
cÚfig
.
Ï‹ncy_di¡_mode
) {

2666 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2667 
	`Ï‹ncyDi¡Mode
();

2671 ià(
cÚfig
.
¦ave_mode
) {

2672 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2673 
	`¦aveMode
();

2677 ià(
cÚfig
.
g‘rdb_mode
) {

2678 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2679 
	`g‘RDB
();

2683 ià(
cÚfig
.
pe_mode
) {

2684 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2685 
	`peMode
();

2689 ià(
cÚfig
.
bigkeys
) {

2690 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2691 
	`fšdBigKeys
();

2695 ià(
cÚfig
.
¡©_mode
) {

2696 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2697 ià(
cÚfig
.
š‹rv®
 == 0) config.interval = 1000000;

2698 
	`¡©Mode
();

2702 ià(
cÚfig
.
sÿn_mode
) {

2703 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2704 
	`sÿnMode
();

2708 ià(
cÚfig
.
Ìu_‹¡_mode
) {

2709 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2710 
	`LRUTe¡Mode
();

2714 ià(
cÚfig
.
šŒšsic_Ï‹ncy_mode
è
	`šŒšsicL©’cyMode
();

2717 ià(
¬gc
 =ğ0 && !
cÚfig
.
ev®
) {

2719 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

2723 
	`şiCÚÃù
(0);

2724 
	`»¶
();

2728 ià(
	`şiCÚÃù
(0è!ğ
REDIS_OK
è
	`ex™
(1);

2729 ià(
cÚfig
.
ev®
) {

2730  
	`ev®Mode
(
¬gc
,
¬gv
);

2732  
	`nÚš‹¿ùive
(
¬gc
,
	`cÚv”tToSds
×rgc,
¬gv
));

2734 
	}
}

	@redisassert.h

38 #iâdeà
__REDIS_ASSERT_H__


39 
	#__REDIS_ASSERT_H__


	)

41 
	~<uni¡d.h
>

43 
	#as£¹
(
_e
è((_e)?()0 : (
	`_£rv”As£¹
(#_e,
__FILE__
,
__LINE__
),
	`_ex™
(1)))

	)

44 
	#·nic
(...è
	`_£rv”Pªic
(
__FILE__
,
__LINE__
,
__VA_ARGS__
),
	`_ex™
(1)

	)

46 
_£rv”As£¹
(*
e¡r
, *
fe
, 
lše
);

47 
_£rv”Pªic
(cÚ¡ *
fe
, 
lše
, cÚ¡ *
msg
, ...);

	@redismodule.h

1 #iâdeà
REDISMODULE_H


2 
	#REDISMODULE_H


	)

4 
	~<sys/ty³s.h
>

5 
	~<¡dšt.h
>

6 
	~<¡dio.h
>

11 
	#REDISMODULE_OK
 0

	)

12 
	#REDISMODULE_ERR
 1

	)

15 
	#REDISMODULE_APIVER_1
 1

	)

18 
	#REDISMODULE_READ
 (1<<0)

	)

19 
	#REDISMODULE_WRITE
 (1<<1)

	)

21 
	#REDISMODULE_LIST_HEAD
 0

	)

22 
	#REDISMODULE_LIST_TAIL
 1

	)

25 
	#REDISMODULE_KEYTYPE_EMPTY
 0

	)

26 
	#REDISMODULE_KEYTYPE_STRING
 1

	)

27 
	#REDISMODULE_KEYTYPE_LIST
 2

	)

28 
	#REDISMODULE_KEYTYPE_HASH
 3

	)

29 
	#REDISMODULE_KEYTYPE_SET
 4

	)

30 
	#REDISMODULE_KEYTYPE_ZSET
 5

	)

31 
	#REDISMODULE_KEYTYPE_MODULE
 6

	)

34 
	#REDISMODULE_REPLY_UNKNOWN
 -1

	)

35 
	#REDISMODULE_REPLY_STRING
 0

	)

36 
	#REDISMODULE_REPLY_ERROR
 1

	)

37 
	#REDISMODULE_REPLY_INTEGER
 2

	)

38 
	#REDISMODULE_REPLY_ARRAY
 3

	)

39 
	#REDISMODULE_REPLY_NULL
 4

	)

42 
	#REDISMODULE_POSTPONED_ARRAY_LEN
 -1

	)

45 
	#REDISMODULE_NO_EXPIRE
 -1

	)

48 
	#REDISMODULE_ZADD_XX
 (1<<0)

	)

49 
	#REDISMODULE_ZADD_NX
 (1<<1)

	)

50 
	#REDISMODULE_ZADD_ADDED
 (1<<2)

	)

51 
	#REDISMODULE_ZADD_UPDATED
 (1<<3)

	)

52 
	#REDISMODULE_ZADD_NOP
 (1<<4)

	)

55 
	#REDISMODULE_HASH_NONE
 0

	)

56 
	#REDISMODULE_HASH_NX
 (1<<0)

	)

57 
	#REDISMODULE_HASH_XX
 (1<<1)

	)

58 
	#REDISMODULE_HASH_CFIELDS
 (1<<2)

	)

59 
	#REDISMODULE_HASH_EXISTS
 (1<<3)

	)

63 
	#REDISMODULE_HASH_DELETE
 ((
RedisModuËSŒšg
*)()1)

	)

66 
	#REDISMODULE_ERRORMSG_WRONGTYPE
 "WRONGTYPE O³¿tiÚ‡gaš¡‡ key hŞdšghwrÚg kšd oàv®ue"

	)

68 
	#REDISMODULE_POSITIVE_INFINITE
 (1.0/0.0)

	)

69 
	#REDISMODULE_NEGATIVE_INFINITE
 (-1.0/0.0)

	)

71 
	#REDISMODULE_NOT_USED
(
V
è((èV)

	)

75 #iâdeà
REDISMODULE_CORE


77 
	tm¡ime_t
;

80 
RedisModuËCtx
 
	tRedisModuËCtx
;

81 
RedisModuËKey
 
	tRedisModuËKey
;

82 
RedisModuËSŒšg
 
	tRedisModuËSŒšg
;

83 
RedisModuËC®lR•ly
 
	tRedisModuËC®lR•ly
;

84 
RedisModuËIO
 
	tRedisModuËIO
;

85 
RedisModuËTy³
 
	tRedisModuËTy³
;

86 
RedisModuËDige¡
 
	tRedisModuËDige¡
;

87 
RedisModuËBlockedCl›Á
 
	tRedisModuËBlockedCl›Á
;

89 (*
	tRedisModuËCmdFunc
è(
	tRedisModuËCtx
 *
	tùx
, 
	tRedisModuËSŒšg
 **
	t¬gv
, 
	t¬gc
);

91 *(*
	tRedisModuËTy³LßdFunc
)(
	tRedisModuËIO
 *
	trdb
, 
	t’cv”
);

92 (*
	tRedisModuËTy³SaveFunc
)(
	tRedisModuËIO
 *
	trdb
, *
	tv®ue
);

93 (*
	tRedisModuËTy³Rewr™eFunc
)(
	tRedisModuËIO
 *
	taof
, 
	tRedisModuËSŒšg
 *
	tkey
, *
	tv®ue
);

94 
	$size_t
 (*
	tRedisModuËTy³MemU§geFunc
)(cÚ¡ *
	tv®ue
);

95 (*
	tRedisModuËTy³Dige¡Func
)(
	tRedisModuËDige¡
 *
	tdige¡
, *
	tv®ue
);

96 (*
	tRedisModuËTy³F»eFunc
)(*
	tv®ue
);

98 
	#REDISMODULE_TYPE_METHOD_VERSION
 1

	)

99 
	sRedisModuËTy³M‘hods
 {

100 
ušt64_t
 
v”siÚ
;

101 
RedisModuËTy³LßdFunc
 
rdb_lßd
;

102 
RedisModuËTy³SaveFunc
 
rdb_§ve
;

103 
RedisModuËTy³Rewr™eFunc
 
aof_»wr™e
;

104 
RedisModuËTy³MemU§geFunc
 
mem_u§ge
;

105 
RedisModuËTy³Dige¡Func
 
dige¡
;

106 
RedisModuËTy³F»eFunc
 
ä“
;

107 } 
	tRedisModuËTy³M‘hods
;

109 
	#REDISMODULE_GET_API
(
Çme
) \

110 
	`RedisModuË_G‘Api
("RedisModuË_" #Çme, ((**)&
RedisModuË_
 ## 
Çme
))

	)

112 
	#REDISMODULE_API_FUNC
(
x
è(*x)

	)

115 *
	$REDISMODULE_API_FUNC
(
RedisModuË_AÎoc
)(
size_t
 
by‹s
);

116 *
	$REDISMODULE_API_FUNC
(
RedisModuË_R—Îoc
)(*
±r
, 
size_t
 
by‹s
);

117 
	$REDISMODULE_API_FUNC
(
RedisModuË_F»e
)(*
±r
);

118 *
	$REDISMODULE_API_FUNC
(
RedisModuË_C®loc
)(
size_t
 
nmemb
, size_ˆ
size
);

119 *
	$REDISMODULE_API_FUNC
(
RedisModuË_SŒdup
)(cÚ¡ *
¡r
);

120 
	$REDISMODULE_API_FUNC
(
RedisModuË_G‘Api
)(const *, *);

121 
	$REDISMODULE_API_FUNC
(
RedisModuË_C»©eCommªd
)(
RedisModuËCtx
 *
ùx
, cÚ¡ *
Çme
, 
RedisModuËCmdFunc
 
cmdfunc
, cÚ¡ *
¡ræags
, 
fœ¡key
, 
Ï¡key
, 
key¡•
);

122 
	$REDISMODULE_API_FUNC
(
RedisModuË_S‘ModuËA‰ribs
)(
RedisModuËCtx
 *
ùx
, cÚ¡ *
Çme
, 
v”
, 
­iv”
);

123 
	$REDISMODULE_API_FUNC
(
RedisModuË_WrÚgAr™y
)(
RedisModuËCtx
 *
ùx
);

124 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•lyW™hLÚgLÚg
)(
RedisModuËCtx
 *
ùx
, 
Î
);

125 
	$REDISMODULE_API_FUNC
(
RedisModuË_G‘S–eùedDb
)(
RedisModuËCtx
 *
ùx
);

126 
	$REDISMODULE_API_FUNC
(
RedisModuË_S–eùDb
)(
RedisModuËCtx
 *
ùx
, 
Ãwid
);

127 *
	$REDISMODULE_API_FUNC
(
RedisModuË_O³nKey
)(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 *
keyÇme
, 
mode
);

128 
	$REDISMODULE_API_FUNC
(
RedisModuË_Clo£Key
)(
RedisModuËKey
 *
kp
);

129 
	$REDISMODULE_API_FUNC
(
RedisModuË_KeyTy³
)(
RedisModuËKey
 *
kp
);

130 
size_t
 
	$REDISMODULE_API_FUNC
(
RedisModuË_V®ueL’gth
)(
RedisModuËKey
 *
kp
);

131 
	$REDISMODULE_API_FUNC
(
RedisModuË_Li¡Push
)(
RedisModuËKey
 *
kp
, 
wh”e
, 
RedisModuËSŒšg
 *
–e
);

132 
RedisModuËSŒšg
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_Li¡Pİ
)(
RedisModuËKey
 *
key
, 
wh”e
);

133 
RedisModuËC®lR•ly
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_C®l
)(
RedisModuËCtx
 *
ùx
, cÚ¡ *
cmdÇme
, cÚ¡ *
fmt
, ...);

134 cÚ¡ *
	$REDISMODULE_API_FUNC
(
RedisModuË_C®lR•lyPrÙo
)(
RedisModuËC®lR•ly
 *
»¶y
, 
size_t
 *
Ën
);

135 
	$REDISMODULE_API_FUNC
(
RedisModuË_F»eC®lR•ly
)(
RedisModuËC®lR•ly
 *
»¶y
);

136 
	$REDISMODULE_API_FUNC
(
RedisModuË_C®lR•lyTy³
)(
RedisModuËC®lR•ly
 *
»¶y
);

137 
	$REDISMODULE_API_FUNC
(
RedisModuË_C®lR•lyIÁeg”
)(
RedisModuËC®lR•ly
 *
»¶y
);

138 
size_t
 
	$REDISMODULE_API_FUNC
(
RedisModuË_C®lR•lyL’gth
)(
RedisModuËC®lR•ly
 *
»¶y
);

139 
RedisModuËC®lR•ly
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_C®lR•lyA¼ayEËm’t
)(
RedisModuËC®lR•ly
 *
»¶y
, 
size_t
 
idx
);

140 
RedisModuËSŒšg
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_C»©eSŒšg
)(
RedisModuËCtx
 *
ùx
, cÚ¡ *
±r
, 
size_t
 
Ën
);

141 
RedisModuËSŒšg
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_C»©eSŒšgFromLÚgLÚg
)(
RedisModuËCtx
 *
ùx
, 
Î
);

142 
RedisModuËSŒšg
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_C»©eSŒšgFromSŒšg
)(
RedisModuËCtx
 *
ùx
, cÚ¡ 
RedisModuËSŒšg
 *
¡r
);

143 
RedisModuËSŒšg
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_C»©eSŒšgPrštf
)(
RedisModuËCtx
 *
ùx
, cÚ¡ *
fmt
, ...);

144 
	$REDISMODULE_API_FUNC
(
RedisModuË_F»eSŒšg
)(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 *
¡r
);

145 cÚ¡ *
	$REDISMODULE_API_FUNC
(
RedisModuË_SŒšgPŒL’
)(cÚ¡ 
RedisModuËSŒšg
 *
¡r
, 
size_t
 *
Ën
);

146 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•lyW™hE¼Ü
)(
RedisModuËCtx
 *
ùx
, cÚ¡ *
”r
);

147 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•lyW™hSim¶eSŒšg
)(
RedisModuËCtx
 *
ùx
, cÚ¡ *
msg
);

148 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•lyW™hA¼ay
)(
RedisModuËCtx
 *
ùx
, 
Ën
);

149 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•lyS‘A¼ayL’gth
)(
RedisModuËCtx
 *
ùx
, 
Ën
);

150 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•lyW™hSŒšgBufãr
)(
RedisModuËCtx
 *
ùx
, cÚ¡ *
buf
, 
size_t
 
Ën
);

151 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•lyW™hSŒšg
)(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 *
¡r
);

152 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•lyW™hNuÎ
)(
RedisModuËCtx
 *
ùx
);

153 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•lyW™hDoubË
)(
RedisModuËCtx
 *
ùx
, 
d
);

154 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•lyW™hC®lR•ly
)(
RedisModuËCtx
 *
ùx
, 
RedisModuËC®lR•ly
 *
»¶y
);

155 
	$REDISMODULE_API_FUNC
(
RedisModuË_SŒšgToLÚgLÚg
)(cÚ¡ 
RedisModuËSŒšg
 *
¡r
, *
Î
);

156 
	$REDISMODULE_API_FUNC
(
RedisModuË_SŒšgToDoubË
)(cÚ¡ 
RedisModuËSŒšg
 *
¡r
, *
d
);

157 
	$REDISMODULE_API_FUNC
(
RedisModuË_AutoMemÜy
)(
RedisModuËCtx
 *
ùx
);

158 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•liÿ‹
)(
RedisModuËCtx
 *
ùx
, cÚ¡ *
cmdÇme
, cÚ¡ *
fmt
, ...);

159 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•liÿ‹V”b©im
)(
RedisModuËCtx
 *
ùx
);

160 cÚ¡ *
	$REDISMODULE_API_FUNC
(
RedisModuË_C®lR•lySŒšgPŒ
)(
RedisModuËC®lR•ly
 *
»¶y
, 
size_t
 *
Ën
);

161 
RedisModuËSŒšg
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_C»©eSŒšgFromC®lR•ly
)(
RedisModuËC®lR•ly
 *
»¶y
);

162 
	$REDISMODULE_API_FUNC
(
RedisModuË_D–‘eKey
)(
RedisModuËKey
 *
key
);

163 
	$REDISMODULE_API_FUNC
(
RedisModuË_SŒšgS‘
)(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
¡r
);

164 *
	$REDISMODULE_API_FUNC
(
RedisModuË_SŒšgDMA
)(
RedisModuËKey
 *
key
, 
size_t
 *
Ën
, 
mode
);

165 
	$REDISMODULE_API_FUNC
(
RedisModuË_SŒšgTrunÿ‹
)(
RedisModuËKey
 *
key
, 
size_t
 
ÃwËn
);

166 
m¡ime_t
 
	$REDISMODULE_API_FUNC
(
RedisModuË_G‘Expœe
)(
RedisModuËKey
 *
key
);

167 
	$REDISMODULE_API_FUNC
(
RedisModuË_S‘Expœe
)(
RedisModuËKey
 *
key
, 
m¡ime_t
 
expœe
);

168 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tAdd
)(
RedisModuËKey
 *
key
, 
scÜe
, 
RedisModuËSŒšg
 *
–e
, *
æag¥Œ
);

169 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tInüby
)(
RedisModuËKey
 *
key
, 
scÜe
, 
RedisModuËSŒšg
 *
–e
, *
æag¥Œ
, *
ÃwscÜe
);

170 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tScÜe
)(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
–e
, *
scÜe
);

171 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tRem
)(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
–e
, *
d–‘ed
);

172 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tRªgeStİ
)(
RedisModuËKey
 *
key
);

173 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tFœ¡InScÜeRªge
)(
RedisModuËKey
 *
key
, 
mš
, 
max
, 
mšex
, 
maxex
);

174 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tLa¡InScÜeRªge
)(
RedisModuËKey
 *
key
, 
mš
, 
max
, 
mšex
, 
maxex
);

175 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tFœ¡InLexRªge
)(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
mš
, RedisModuËSŒšg *
max
);

176 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tLa¡InLexRªge
)(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
mš
, RedisModuËSŒšg *
max
);

177 
RedisModuËSŒšg
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tRªgeCu¼’tEËm’t
)(
RedisModuËKey
 *
key
, *
scÜe
);

178 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tRªgeNext
)(
RedisModuËKey
 *
key
);

179 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tRªgeP»v
)(
RedisModuËKey
 *
key
);

180 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tRªgeEndR—ched
)(
RedisModuËKey
 *
key
);

181 
	$REDISMODULE_API_FUNC
(
RedisModuË_HashS‘
)(
RedisModuËKey
 *
key
, 
æags
, ...);

182 
	$REDISMODULE_API_FUNC
(
RedisModuË_HashG‘
)(
RedisModuËKey
 *
key
, 
æags
, ...);

183 
	$REDISMODULE_API_FUNC
(
RedisModuË_IsKeysPos™iÚReque¡
)(
RedisModuËCtx
 *
ùx
);

184 
	$REDISMODULE_API_FUNC
(
RedisModuË_KeyAtPos
)(
RedisModuËCtx
 *
ùx
, 
pos
);

185 
	$REDISMODULE_API_FUNC
(
RedisModuË_G‘Cl›ÁId
)(
RedisModuËCtx
 *
ùx
);

186 *
	$REDISMODULE_API_FUNC
(
RedisModuË_PoŞAÎoc
)(
RedisModuËCtx
 *
ùx
, 
size_t
 
by‹s
);

187 
RedisModuËTy³
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_C»©eD©aTy³
)(
RedisModuËCtx
 *
ùx
, cÚ¡ *
Çme
, 
’cv”
, 
RedisModuËTy³M‘hods
 *
ty³m‘hods
);

188 
	$REDISMODULE_API_FUNC
(
RedisModuË_ModuËTy³S‘V®ue
)(
RedisModuËKey
 *
key
, 
RedisModuËTy³
 *
mt
, *
v®ue
);

189 
RedisModuËTy³
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_ModuËTy³G‘Ty³
)(
RedisModuËKey
 *
key
);

190 *
	$REDISMODULE_API_FUNC
(
RedisModuË_ModuËTy³G‘V®ue
)(
RedisModuËKey
 *
key
);

191 
	$REDISMODULE_API_FUNC
(
RedisModuË_SaveUnsigÃd
)(
RedisModuËIO
 *
io
, 
ušt64_t
 
v®ue
);

192 
ušt64_t
 
	$REDISMODULE_API_FUNC
(
RedisModuË_LßdUnsigÃd
)(
RedisModuËIO
 *
io
);

193 
	$REDISMODULE_API_FUNC
(
RedisModuË_SaveSigÃd
)(
RedisModuËIO
 *
io
, 
št64_t
 
v®ue
);

194 
št64_t
 
	$REDISMODULE_API_FUNC
(
RedisModuË_LßdSigÃd
)(
RedisModuËIO
 *
io
);

195 
	$REDISMODULE_API_FUNC
(
RedisModuË_Em™AOF
)(
RedisModuËIO
 *
io
, cÚ¡ *
cmdÇme
, cÚ¡ *
fmt
, ...);

196 
	$REDISMODULE_API_FUNC
(
RedisModuË_SaveSŒšg
)(
RedisModuËIO
 *
io
, 
RedisModuËSŒšg
 *
s
);

197 
	$REDISMODULE_API_FUNC
(
RedisModuË_SaveSŒšgBufãr
)(
RedisModuËIO
 *
io
, cÚ¡ *
¡r
, 
size_t
 
Ën
);

198 
RedisModuËSŒšg
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_LßdSŒšg
)(
RedisModuËIO
 *
io
);

199 *
	$REDISMODULE_API_FUNC
(
RedisModuË_LßdSŒšgBufãr
)(
RedisModuËIO
 *
io
, 
size_t
 *
ËÅŒ
);

200 
	$REDISMODULE_API_FUNC
(
RedisModuË_SaveDoubË
)(
RedisModuËIO
 *
io
, 
v®ue
);

201 
	$REDISMODULE_API_FUNC
(
RedisModuË_LßdDoubË
)(
RedisModuËIO
 *
io
);

202 
	$REDISMODULE_API_FUNC
(
RedisModuË_SaveFlßt
)(
RedisModuËIO
 *
io
, 
v®ue
);

203 
	$REDISMODULE_API_FUNC
(
RedisModuË_LßdFlßt
)(
RedisModuËIO
 *
io
);

204 
	$REDISMODULE_API_FUNC
(
RedisModuË_Log
)(
RedisModuËCtx
 *
ùx
, cÚ¡ *
Ëv–
, cÚ¡ *
fmt
, ...);

205 
	$REDISMODULE_API_FUNC
(
RedisModuË_LogIOE¼Ü
)(
RedisModuËIO
 *
io
, cÚ¡ *
Ëv–¡r
, cÚ¡ *
fmt
, ...);

206 
	$REDISMODULE_API_FUNC
(
RedisModuË_SŒšgAµ’dBufãr
)(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 *
¡r
, cÚ¡ *
buf
, 
size_t
 
Ën
);

207 
	$REDISMODULE_API_FUNC
(
RedisModuË_R‘ašSŒšg
)(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 *
¡r
);

208 
	$REDISMODULE_API_FUNC
(
RedisModuË_SŒšgCom·»
)(
RedisModuËSŒšg
 *
a
, RedisModuËSŒšg *
b
);

209 
RedisModuËCtx
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_G‘CÚ‹xtFromIO
)(
RedisModuËIO
 *
io
);

210 
	$REDISMODULE_API_FUNC
(
RedisModuË_Mli£cÚds
)();

211 
	$REDISMODULE_API_FUNC
(
RedisModuË_Dige¡AddSŒšgBufãr
)(
RedisModuËDige¡
 *
md
, *
–e
, 
size_t
 
Ën
);

212 
	$REDISMODULE_API_FUNC
(
RedisModuË_Dige¡AddLÚgLÚg
)(
RedisModuËDige¡
 *
md
, 
–e
);

213 
	$REDISMODULE_API_FUNC
(
RedisModuË_Dige¡EndSequ’û
)(
RedisModuËDige¡
 *
md
);

216 #ifdeà
REDISMODULE_EXPERIMENTAL_API


217 
RedisModuËBlockedCl›Á
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_BlockCl›Á
)(
RedisModuËCtx
 *
ùx
, 
RedisModuËCmdFunc
 
»¶y_ÿÎback
, RedisModuËCmdFunø
timeout_ÿÎback
, (*
ä“_´ivd©a
)(*), 
timeout_ms
);

218 
	$REDISMODULE_API_FUNC
(
RedisModuË_UnblockCl›Á
)(
RedisModuËBlockedCl›Á
 *
bc
, *
´ivd©a
);

219 
	$REDISMODULE_API_FUNC
(
RedisModuË_IsBlockedR•lyReque¡
)(
RedisModuËCtx
 *
ùx
);

220 
	$REDISMODULE_API_FUNC
(
RedisModuË_IsBlockedTimeoutReque¡
)(
RedisModuËCtx
 *
ùx
);

221 *
	$REDISMODULE_API_FUNC
(
RedisModuË_G‘BlockedCl›ÁPriv©eD©a
)(
RedisModuËCtx
 *
ùx
);

222 
	$REDISMODULE_API_FUNC
(
RedisModuË_AbÜtBlock
)(
RedisModuËBlockedCl›Á
 *
bc
);

223 
RedisModuËCtx
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_G‘Th»adSaãCÚ‹xt
)(
RedisModuËBlockedCl›Á
 *
bc
);

224 
	$REDISMODULE_API_FUNC
(
RedisModuË_F»eTh»adSaãCÚ‹xt
)(
RedisModuËCtx
 *
ùx
);

225 
	$REDISMODULE_API_FUNC
(
RedisModuË_Th»adSaãCÚ‹xtLock
)(
RedisModuËCtx
 *
ùx
);

226 
	$REDISMODULE_API_FUNC
(
RedisModuË_Th»adSaãCÚ‹xtUÆock
)(
RedisModuËCtx
 *
ùx
);

230 
	$RedisModuË_In™
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
Çme
, 
v”
, 
­iv”
è
	`__©Œibu‹__
((
unu£d
));

231 
	$RedisModuË_In™
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
Çme
, 
v”
, 
­iv”
) {

232 *
g‘­ifunıŒ
 = ((**)
ùx
)[0];

233 
RedisModuË_G‘Api
 = ((*)(cÚ¡ *, *)è()
g‘­ifunıŒ
;

234 
	`REDISMODULE_GET_API
(
AÎoc
);

235 
	`REDISMODULE_GET_API
(
C®loc
);

236 
	`REDISMODULE_GET_API
(
F»e
);

237 
	`REDISMODULE_GET_API
(
R—Îoc
);

238 
	`REDISMODULE_GET_API
(
SŒdup
);

239 
	`REDISMODULE_GET_API
(
C»©eCommªd
);

240 
	`REDISMODULE_GET_API
(
S‘ModuËA‰ribs
);

241 
	`REDISMODULE_GET_API
(
WrÚgAr™y
);

242 
	`REDISMODULE_GET_API
(
R•lyW™hLÚgLÚg
);

243 
	`REDISMODULE_GET_API
(
R•lyW™hE¼Ü
);

244 
	`REDISMODULE_GET_API
(
R•lyW™hSim¶eSŒšg
);

245 
	`REDISMODULE_GET_API
(
R•lyW™hA¼ay
);

246 
	`REDISMODULE_GET_API
(
R•lyS‘A¼ayL’gth
);

247 
	`REDISMODULE_GET_API
(
R•lyW™hSŒšgBufãr
);

248 
	`REDISMODULE_GET_API
(
R•lyW™hSŒšg
);

249 
	`REDISMODULE_GET_API
(
R•lyW™hNuÎ
);

250 
	`REDISMODULE_GET_API
(
R•lyW™hC®lR•ly
);

251 
	`REDISMODULE_GET_API
(
R•lyW™hDoubË
);

252 
	`REDISMODULE_GET_API
(
R•lyS‘A¼ayL’gth
);

253 
	`REDISMODULE_GET_API
(
G‘S–eùedDb
);

254 
	`REDISMODULE_GET_API
(
S–eùDb
);

255 
	`REDISMODULE_GET_API
(
O³nKey
);

256 
	`REDISMODULE_GET_API
(
Clo£Key
);

257 
	`REDISMODULE_GET_API
(
KeyTy³
);

258 
	`REDISMODULE_GET_API
(
V®ueL’gth
);

259 
	`REDISMODULE_GET_API
(
Li¡Push
);

260 
	`REDISMODULE_GET_API
(
Li¡Pİ
);

261 
	`REDISMODULE_GET_API
(
SŒšgToLÚgLÚg
);

262 
	`REDISMODULE_GET_API
(
SŒšgToDoubË
);

263 
	`REDISMODULE_GET_API
(
C®l
);

264 
	`REDISMODULE_GET_API
(
C®lR•lyPrÙo
);

265 
	`REDISMODULE_GET_API
(
F»eC®lR•ly
);

266 
	`REDISMODULE_GET_API
(
C®lR•lyIÁeg”
);

267 
	`REDISMODULE_GET_API
(
C®lR•lyTy³
);

268 
	`REDISMODULE_GET_API
(
C®lR•lyL’gth
);

269 
	`REDISMODULE_GET_API
(
C®lR•lyA¼ayEËm’t
);

270 
	`REDISMODULE_GET_API
(
C®lR•lySŒšgPŒ
);

271 
	`REDISMODULE_GET_API
(
C»©eSŒšgFromC®lR•ly
);

272 
	`REDISMODULE_GET_API
(
C»©eSŒšg
);

273 
	`REDISMODULE_GET_API
(
C»©eSŒšgFromLÚgLÚg
);

274 
	`REDISMODULE_GET_API
(
C»©eSŒšgFromSŒšg
);

275 
	`REDISMODULE_GET_API
(
C»©eSŒšgPrštf
);

276 
	`REDISMODULE_GET_API
(
F»eSŒšg
);

277 
	`REDISMODULE_GET_API
(
SŒšgPŒL’
);

278 
	`REDISMODULE_GET_API
(
AutoMemÜy
);

279 
	`REDISMODULE_GET_API
(
R•liÿ‹
);

280 
	`REDISMODULE_GET_API
(
R•liÿ‹V”b©im
);

281 
	`REDISMODULE_GET_API
(
D–‘eKey
);

282 
	`REDISMODULE_GET_API
(
SŒšgS‘
);

283 
	`REDISMODULE_GET_API
(
SŒšgDMA
);

284 
	`REDISMODULE_GET_API
(
SŒšgTrunÿ‹
);

285 
	`REDISMODULE_GET_API
(
G‘Expœe
);

286 
	`REDISMODULE_GET_API
(
S‘Expœe
);

287 
	`REDISMODULE_GET_API
(
Z£tAdd
);

288 
	`REDISMODULE_GET_API
(
Z£tInüby
);

289 
	`REDISMODULE_GET_API
(
Z£tScÜe
);

290 
	`REDISMODULE_GET_API
(
Z£tRem
);

291 
	`REDISMODULE_GET_API
(
Z£tRªgeStİ
);

292 
	`REDISMODULE_GET_API
(
Z£tFœ¡InScÜeRªge
);

293 
	`REDISMODULE_GET_API
(
Z£tLa¡InScÜeRªge
);

294 
	`REDISMODULE_GET_API
(
Z£tFœ¡InLexRªge
);

295 
	`REDISMODULE_GET_API
(
Z£tLa¡InLexRªge
);

296 
	`REDISMODULE_GET_API
(
Z£tRªgeCu¼’tEËm’t
);

297 
	`REDISMODULE_GET_API
(
Z£tRªgeNext
);

298 
	`REDISMODULE_GET_API
(
Z£tRªgeP»v
);

299 
	`REDISMODULE_GET_API
(
Z£tRªgeEndR—ched
);

300 
	`REDISMODULE_GET_API
(
HashS‘
);

301 
	`REDISMODULE_GET_API
(
HashG‘
);

302 
	`REDISMODULE_GET_API
(
IsKeysPos™iÚReque¡
);

303 
	`REDISMODULE_GET_API
(
KeyAtPos
);

304 
	`REDISMODULE_GET_API
(
G‘Cl›ÁId
);

305 
	`REDISMODULE_GET_API
(
PoŞAÎoc
);

306 
	`REDISMODULE_GET_API
(
C»©eD©aTy³
);

307 
	`REDISMODULE_GET_API
(
ModuËTy³S‘V®ue
);

308 
	`REDISMODULE_GET_API
(
ModuËTy³G‘Ty³
);

309 
	`REDISMODULE_GET_API
(
ModuËTy³G‘V®ue
);

310 
	`REDISMODULE_GET_API
(
SaveUnsigÃd
);

311 
	`REDISMODULE_GET_API
(
LßdUnsigÃd
);

312 
	`REDISMODULE_GET_API
(
SaveSigÃd
);

313 
	`REDISMODULE_GET_API
(
LßdSigÃd
);

314 
	`REDISMODULE_GET_API
(
SaveSŒšg
);

315 
	`REDISMODULE_GET_API
(
SaveSŒšgBufãr
);

316 
	`REDISMODULE_GET_API
(
LßdSŒšg
);

317 
	`REDISMODULE_GET_API
(
LßdSŒšgBufãr
);

318 
	`REDISMODULE_GET_API
(
SaveDoubË
);

319 
	`REDISMODULE_GET_API
(
LßdDoubË
);

320 
	`REDISMODULE_GET_API
(
SaveFlßt
);

321 
	`REDISMODULE_GET_API
(
LßdFlßt
);

322 
	`REDISMODULE_GET_API
(
Em™AOF
);

323 
	`REDISMODULE_GET_API
(
Log
);

324 
	`REDISMODULE_GET_API
(
LogIOE¼Ü
);

325 
	`REDISMODULE_GET_API
(
SŒšgAµ’dBufãr
);

326 
	`REDISMODULE_GET_API
(
R‘ašSŒšg
);

327 
	`REDISMODULE_GET_API
(
SŒšgCom·»
);

328 
	`REDISMODULE_GET_API
(
G‘CÚ‹xtFromIO
);

329 
	`REDISMODULE_GET_API
(
Mli£cÚds
);

330 
	`REDISMODULE_GET_API
(
Dige¡AddSŒšgBufãr
);

331 
	`REDISMODULE_GET_API
(
Dige¡AddLÚgLÚg
);

332 
	`REDISMODULE_GET_API
(
Dige¡EndSequ’û
);

334 #ifdeà
REDISMODULE_EXPERIMENTAL_API


335 
	`REDISMODULE_GET_API
(
G‘Th»adSaãCÚ‹xt
);

336 
	`REDISMODULE_GET_API
(
F»eTh»adSaãCÚ‹xt
);

337 
	`REDISMODULE_GET_API
(
Th»adSaãCÚ‹xtLock
);

338 
	`REDISMODULE_GET_API
(
Th»adSaãCÚ‹xtUÆock
);

339 
	`REDISMODULE_GET_API
(
BlockCl›Á
);

340 
	`REDISMODULE_GET_API
(
UnblockCl›Á
);

341 
	`REDISMODULE_GET_API
(
IsBlockedR•lyReque¡
);

342 
	`REDISMODULE_GET_API
(
IsBlockedTimeoutReque¡
);

343 
	`REDISMODULE_GET_API
(
G‘BlockedCl›ÁPriv©eD©a
);

344 
	`REDISMODULE_GET_API
(
AbÜtBlock
);

347 
	`RedisModuË_S‘ModuËA‰ribs
(
ùx
,
Çme
,
v”
,
­iv”
);

348  
REDISMODULE_OK
;

349 
	}
}

355 
	#RedisModuËSŒšg
 
robj


	)

	@release.c

34 
	~<¡ršg.h
>

36 
	~"»Ëa£.h
"

37 
	~"v”siÚ.h
"

38 
	~"üc64.h
"

40 *
	$»disG™SHA1
() {

41  
REDIS_GIT_SHA1
;

42 
	}
}

44 *
	$»disG™Dœty
() {

45  
REDIS_GIT_DIRTY
;

46 
	}
}

48 
ušt64_t
 
	$»disBudId
() {

49 *
budid
 = 
REDIS_VERSION
 
REDIS_BUILD_ID
 
REDIS_GIT_DIRTY
 
REDIS_GIT_SHA1
;

51  
	`üc64
(0,(*)
budid
,
	`¡¾’
(buildid));

52 
	}
}

	@replication.c

32 
	~"£rv”.h
"

34 
	~<sys/time.h
>

35 
	~<uni¡d.h
>

36 
	~<fú.h
>

37 
	~<sys/sock‘.h
>

38 
	~<sys/¡©.h
>

40 
»¶iÿtiÚDisÿrdCachedMa¡”
();

41 
»¶iÿtiÚResu¼eùCachedMa¡”
(
Ãwfd
);

42 
»¶iÿtiÚS’dAck
();

43 
putSÏveOÆše
(
ş›Á
 *
¦ave
);

44 
ÿnûlR•liÿtiÚHªdshake
();

52 *
	$»¶iÿtiÚG‘SÏveName
(
ş›Á
 *
c
) {

53 
buf
[
NET_PEER_ID_LEN
];

54 

[
NET_IP_STR_LEN
];

56 

[0] = '\0';

57 
buf
[0] = '\0';

58 ià(
c
->
¦ave_
[0] != '\0' ||

59 
	`ª‘P“rToSŒšg
(
c
->
fd
,

,(),
NULL
) != -1)

62 ià(
c
->
¦ave_
[0] !ğ'\0'è
	`memıy
(

,c->slave_ip,(c->slave_ip));

64 ià(
c
->
¦ave_li¡’šg_pÜt
)

65 
	`ª‘FÜm©Addr
(
buf
,(buf),

,
c
->
¦ave_li¡’šg_pÜt
);

67 
	`¢´štf
(
buf
,(buf),"%s:<unknown-¦ave-pÜt>",

);

69 
	`¢´štf
(
buf
,(buf),"client id #%llu",

70 (è
c
->
id
);

72  
buf
;

73 
	}
}

77 
	$ü—‹R•liÿtiÚBacklog
() {

78 
	`£rv”As£¹
(
£rv”
.
»¶_backlog
 =ğ
NULL
);

79 
£rv”
.
»¶_backlog
 = 
	`zm®loc
(£rv”.
»¶_backlog_size
);

80 
£rv”
.
»¶_backlog_hi¡Ën
 = 0;

81 
£rv”
.
»¶_backlog_idx
 = 0;

86 
£rv”
.
»¶_backlog_off
 = s”v”.
ma¡”_»¶_off£t
+1;

87 
	}
}

95 
	$»sizeR•liÿtiÚBacklog
(
Ãwsize
) {

96 ià(
Ãwsize
 < 
CONFIG_REPL_BACKLOG_MIN_SIZE
)

97 
Ãwsize
 = 
CONFIG_REPL_BACKLOG_MIN_SIZE
;

98 ià(
£rv”
.
»¶_backlog_size
 =ğ
Ãwsize
) ;

100 
£rv”
.
»¶_backlog_size
 = 
Ãwsize
;

101 ià(
£rv”
.
»¶_backlog
 !ğ
NULL
) {

107 
	`zä“
(
£rv”
.
»¶_backlog
);

108 
£rv”
.
»¶_backlog
 = 
	`zm®loc
(£rv”.
»¶_backlog_size
);

109 
£rv”
.
»¶_backlog_hi¡Ën
 = 0;

110 
£rv”
.
»¶_backlog_idx
 = 0;

112 
£rv”
.
»¶_backlog_off
 = s”v”.
ma¡”_»¶_off£t
+1;

114 
	}
}

116 
	$ä“R•liÿtiÚBacklog
() {

117 
	`£rv”As£¹
(
	`li¡L’gth
(
£rv”
.
¦aves
) == 0);

118 
	`zä“
(
£rv”
.
»¶_backlog
);

119 
£rv”
.
»¶_backlog
 = 
NULL
;

120 
	}
}

126 
	$ãedR•liÿtiÚBacklog
(*
±r
, 
size_t
 
Ën
) {

127 *
p
 = 
±r
;

129 
£rv”
.
ma¡”_»¶_off£t
 +ğ
Ën
;

133 
Ën
) {

134 
size_t
 
thi¦’
 = 
£rv”
.
»¶_backlog_size
 - s”v”.
»¶_backlog_idx
;

135 ià(
thi¦’
 > 
Ën
)hislen =†en;

136 
	`memıy
(
£rv”
.
»¶_backlog
+£rv”.
»¶_backlog_idx
,
p
,
thi¦’
);

137 
£rv”
.
»¶_backlog_idx
 +ğ
thi¦’
;

138 ià(
£rv”
.
»¶_backlog_idx
 =ğ£rv”.
»¶_backlog_size
)

139 
£rv”
.
»¶_backlog_idx
 = 0;

140 
Ën
 -ğ
thi¦’
;

141 
p
 +ğ
thi¦’
;

142 
£rv”
.
»¶_backlog_hi¡Ën
 +ğ
thi¦’
;

144 ià(
£rv”
.
»¶_backlog_hi¡Ën
 > s”v”.
»¶_backlog_size
)

145 
£rv”
.
»¶_backlog_hi¡Ën
 = s”v”.
»¶_backlog_size
;

147 
£rv”
.
»¶_backlog_off
 = s”v”.
ma¡”_»¶_off£t
 -

148 
£rv”
.
»¶_backlog_hi¡Ën
 + 1;

149 
	}
}

153 
	$ãedR•liÿtiÚBacklogW™hObjeù
(
robj
 *
o
) {

154 
Î¡r
[
LONG_STR_SIZE
];

155 *
p
;

156 
size_t
 
Ën
;

158 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

159 
Ën
 = 
	`Î2¡ršg
(
Î¡r
,Öl¡r),()
o
->
±r
);

160 
p
 = 
Î¡r
;

162 
Ën
 = 
	`sd¦’
(
o
->
±r
);

163 
p
 = 
o
->
±r
;

165 
	`ãedR•liÿtiÚBacklog
(
p
,
Ën
);

166 
	}
}

173 
	$»¶iÿtiÚF“dSÏves
(
li¡
 *
¦aves
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
) {

174 
li¡Node
 *
Ê
;

175 
li¡I‹r
 
li
;

176 
j
, 
Ën
;

177 
Î¡r
[
LONG_STR_SIZE
];

184 ià(
£rv”
.
ma¡”ho¡
 !ğ
NULL
) ;

188 ià(
£rv”
.
»¶_backlog
 =ğ
NULL
 && 
	`li¡L’gth
(
¦aves
) == 0) ;

191 
	`£rv”As£¹
(!(
	`li¡L’gth
(
¦aves
è!ğ0 && 
£rv”
.
»¶_backlog
 =ğ
NULL
));

194 ià(
£rv”
.
¦ave£ldb
 !ğ
diùid
) {

195 
robj
 *
£Ëùcmd
;

198 ià(
diùid
 >ğ0 && diùid < 
PROTO_SHARED_SELECT_CMDS
) {

199 
£Ëùcmd
 = 
sh¬ed
.
£Ëù
[
diùid
];

201 
diùid_Ën
;

203 
diùid_Ën
 = 
	`Î2¡ršg
(
Î¡r
,Öl¡r),
diùid
);

204 
£Ëùcmd
 = 
	`ü—‹Objeù
(
OBJ_STRING
,

205 
	`sdsÿrštf
(
	`sd£m±y
(),

207 
diùid_Ën
, 
Î¡r
));

211 ià(
£rv”
.
»¶_backlog
è
	`ãedR•liÿtiÚBacklogW™hObjeù
(
£Ëùcmd
);

214 
	`li¡Rewšd
(
¦aves
,&
li
);

215 (
Ê
 = 
	`li¡Next
(&
li
))) {

216 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

217 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_START
) ;

218 
	`addR•ly
(
¦ave
,
£Ëùcmd
);

221 ià(
diùid
 < 0 || diùid >ğ
PROTO_SHARED_SELECT_CMDS
)

222 
	`deüRefCouÁ
(
£Ëùcmd
);

224 
£rv”
.
¦ave£ldb
 = 
diùid
;

227 ià(
£rv”
.
»¶_backlog
) {

228 
aux
[
LONG_STR_SIZE
+3];

231 
aux
[0] = '*';

232 
Ën
 = 
	`Î2¡ršg
(
aux
+1,×ux)-1,
¬gc
);

233 
aux
[
Ën
+1] = '\r';

234 
aux
[
Ën
+2] = '\n';

235 
	`ãedR•liÿtiÚBacklog
(
aux
,
Ën
+3);

237 
j
 = 0; j < 
¬gc
; j++) {

238 
objËn
 = 
	`¡ršgObjeùL’
(
¬gv
[
j
]);

243 
aux
[0] = '$';

244 
Ën
 = 
	`Î2¡ršg
(
aux
+1,×ux)-1,
objËn
);

245 
aux
[
Ën
+1] = '\r';

246 
aux
[
Ën
+2] = '\n';

247 
	`ãedR•liÿtiÚBacklog
(
aux
,
Ën
+3);

248 
	`ãedR•liÿtiÚBacklogW™hObjeù
(
¬gv
[
j
]);

249 
	`ãedR•liÿtiÚBacklog
(
aux
+
Ën
+1,2);

254 
	`li¡Rewšd
(
¦aves
,&
li
);

255 (
Ê
 = 
	`li¡Next
(&
li
))) {

256 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

259 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_START
) ;

266 
	`addR•lyMuÉiBulkL’
(
¦ave
,
¬gc
);

270 
j
 = 0; j < 
¬gc
; j++)

271 
	`addR•lyBulk
(
¦ave
,
¬gv
[
j
]);

273 
	}
}

277 
	~<ùy³.h
>

278 
	$»¶iÿtiÚF“dSÏvesFromMa¡”SŒ—m
(
li¡
 *
¦aves
, *
buf
, 
size_t
 
buæ’
) {

279 
li¡Node
 *
Ê
;

280 
li¡I‹r
 
li
;

285 
	`´štf
("%zu:",
buæ’
);

286 
size_t
 
j
 = 0; j < 
buæ’
; j++) {

287 
	`´štf
("%c", 
	`i¥ršt
(
buf
[
j
]) ? buf[j] : '.');

289 
	`´štf
("\n");

292 ià(
£rv”
.
»¶_backlog
è
	`ãedR•liÿtiÚBacklog
(
buf
,
buæ’
);

293 
	`li¡Rewšd
(
¦aves
,&
li
);

294 (
Ê
 = 
	`li¡Next
(&
li
))) {

295 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

298 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_START
) ;

299 
	`addR•lySŒšg
(
¦ave
,
buf
,
buæ’
);

301 
	}
}

303 
	$»¶iÿtiÚF“dMÚ™Üs
(
ş›Á
 *
c
, 
li¡
 *
mÚ™Üs
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
) {

304 
li¡Node
 *
Ê
;

305 
li¡I‹r
 
li
;

306 
j
;

307 
sds
 
cmd»´
 = 
	`sd¢ew
("+");

308 
robj
 *
cmdobj
;

309 
timev®
 
tv
;

311 
	`g‘timeofday
(&
tv
,
NULL
);

312 
cmd»´
 = 
	`sdsÿrštf
(cmd»´,"%ld.%06ld ",()
tv
.
tv_£c
,(év.
tv_u£c
);

313 ià(
c
->
æags
 & 
CLIENT_LUA
) {

314 
cmd»´
 = 
	`sdsÿrštf
(cmd»´,"[%d†ua] ",
diùid
);

315 } ià(
c
->
æags
 & 
CLIENT_UNIX_SOCKET
) {

316 
cmd»´
 = 
	`sdsÿrštf
(cmd»´,"[%d unix:%s] ",
diùid
,
£rv”
.
unixsock‘
);

318 
cmd»´
 = 
	`sdsÿrštf
(cmd»´,"[%d %s] ",
diùid
,
	`g‘Cl›ÁP“rId
(
c
));

321 
j
 = 0; j < 
¬gc
; j++) {

322 ià(
¬gv
[
j
]->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

323 
cmd»´
 = 
	`sdsÿrštf
(cmd»´, "\"%ld\"", ()
¬gv
[
j
]->
±r
);

325 
cmd»´
 = 
	`sdsÿŒ•r
(cmd»´,(*)
¬gv
[
j
]->
±r
,

326 
	`sd¦’
(
¬gv
[
j
]->
±r
));

328 ià(
j
 !ğ
¬gc
-1)

329 
cmd»´
 = 
	`sdsÿ’
(cmdrepr," ",1);

331 
cmd»´
 = 
	`sdsÿ’
(cmdrepr,"\r\n",2);

332 
cmdobj
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
cmd»´
);

334 
	`li¡Rewšd
(
mÚ™Üs
,&
li
);

335 (
Ê
 = 
	`li¡Next
(&
li
))) {

336 
ş›Á
 *
mÚ™Ü
 = 
Ê
->
v®ue
;

337 
	`addR•ly
(
mÚ™Ü
,
cmdobj
);

339 
	`deüRefCouÁ
(
cmdobj
);

340 
	}
}

344 
	$addR•lyR•liÿtiÚBacklog
(
ş›Á
 *
c
, 
off£t
) {

345 
j
, 
sk
, 
Ën
;

347 
	`£rv”Log
(
LL_DEBUG
, "[PSYNC] SÏv»que¡ off£t: %Îd", 
off£t
);

349 ià(
£rv”
.
»¶_backlog_hi¡Ën
 == 0) {

350 
	`£rv”Log
(
LL_DEBUG
, "[PSYNC] Backlog history†en is zero");

354 
	`£rv”Log
(
LL_DEBUG
, "[PSYNC] Backlog size: %lld",

355 
£rv”
.
»¶_backlog_size
);

356 
	`£rv”Log
(
LL_DEBUG
, "[PSYNC] First byte: %lld",

357 
£rv”
.
»¶_backlog_off
);

358 
	`£rv”Log
(
LL_DEBUG
, "[PSYNC] History†en: %lld",

359 
£rv”
.
»¶_backlog_hi¡Ën
);

360 
	`£rv”Log
(
LL_DEBUG
, "[PSYNC] Current index: %lld",

361 
£rv”
.
»¶_backlog_idx
);

364 
sk
 = 
off£t
 - 
£rv”
.
»¶_backlog_off
;

365 
	`£rv”Log
(
LL_DEBUG
, "[PSYNC] Skpšg: %Îd", 
sk
);

369 
j
 = (
£rv”
.
»¶_backlog_idx
 +

370 (
£rv”
.
»¶_backlog_size
-£rv”.
»¶_backlog_hi¡Ën
)) %

371 
£rv”
.
»¶_backlog_size
;

372 
	`£rv”Log
(
LL_DEBUG
, "[PSYNC] Index oàfœ¡ by‹: %Îd", 
j
);

375 
j
 = (j + 
sk
è% 
£rv”
.
»¶_backlog_size
;

379 
Ën
 = 
£rv”
.
»¶_backlog_hi¡Ën
 - 
sk
;

380 
	`£rv”Log
(
LL_DEBUG
, "[PSYNC] R•lyÙ®†’gth: %Îd", 
Ën
);

381 
Ën
) {

382 
thi¦’
 =

383 ((
£rv”
.
»¶_backlog_size
 - 
j
è< 
Ën
) ?

384 (
£rv”
.
»¶_backlog_size
 - 
j
è: 
Ën
;

386 
	`£rv”Log
(
LL_DEBUG
, "[PSYNC]‡ddR•ly(èËngth: %Îd", 
thi¦’
);

387 
	`addR•lySds
(
c
,
	`sd¢ewËn
(
£rv”
.
»¶_backlog
 + 
j
, 
thi¦’
));

388 
Ën
 -ğ
thi¦’
;

389 
j
 = 0;

391  
£rv”
.
»¶_backlog_hi¡Ën
 - 
sk
;

392 
	}
}

398 
	$g‘PsyncIn™ŸlOff£t
() {

399  
£rv”
.
ma¡”_»¶_off£t
;

400 
	}
}

418 
	$»¶iÿtiÚS‘upSÏveFÜFuÎResync
(
ş›Á
 *
¦ave
, 
off£t
) {

419 
buf
[128];

420 
buæ’
;

422 
¦ave
->
psync_š™Ÿl_off£t
 = 
off£t
;

423 
¦ave
->
»¶¡©e
 = 
SLAVE_STATE_WAIT_BGSAVE_END
;

427 
£rv”
.
¦ave£ldb
 = -1;

431 ià(!(
¦ave
->
æags
 & 
CLIENT_PRE_PSYNC
)) {

432 
buæ’
 = 
	`¢´štf
(
buf
,(buf),"+FULLRESYNC %s %lld\r\n",

433 
£rv”
.
»¶id
,
off£t
);

434 ià(
	`wr™e
(
¦ave
->
fd
,
buf
,
buæ’
) != buflen) {

435 
	`ä“Cl›ÁAsync
(
¦ave
);

436  
C_ERR
;

439  
C_OK
;

440 
	}
}

447 
	$ma¡”TryP¬tŸlResynchrÚiz©iÚ
(
ş›Á
 *
c
) {

448 
psync_off£t
, 
psync_Ën
;

449 *
ma¡”_»¶id
 = 
c
->
¬gv
[1]->
±r
;

450 
buf
[128];

451 
buæ’
;

456 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
psync_off£t
,
NULL
) !=

457 
C_OK
è
Ãed_fuÎ_»sync
;

465 ià(
	`¡rÿ£cmp
(
ma¡”_»¶id
, 
£rv”
.
»¶id
) &&

466 (
	`¡rÿ£cmp
(
ma¡”_»¶id
, 
£rv”
.
»¶id2
) ||

467 
psync_off£t
 > 
£rv”
.
£cÚd_»¶id_off£t
))

470 ià(
ma¡”_»¶id
[0] != '?') {

471 ià(
	`¡rÿ£cmp
(
ma¡”_»¶id
, 
£rv”
.
»¶id
) &&

472 
	`¡rÿ£cmp
(
ma¡”_»¶id
, 
£rv”
.
»¶id2
))

474 
	`£rv”Log
(
LL_NOTICE
,"Partial„esynchronization‚ot‡ccepted: "

477 
ma¡”_»¶id
, 
£rv”
.
»¶id
, s”v”.
»¶id2
);

479 
	`£rv”Log
(
LL_NOTICE
,"Partial„esynchronization‚ot‡ccepted: "

481 "u°tØ%Îd", 
psync_off£t
, 
£rv”
.
£cÚd_»¶id_off£t
);

484 
	`£rv”Log
(
LL_NOTICE
,"Full„esync„equested by slave %s",

485 
	`»¶iÿtiÚG‘SÏveName
(
c
));

487 
Ãed_fuÎ_»sync
;

491 ià(!
£rv”
.
»¶_backlog
 ||

492 
psync_off£t
 < 
£rv”
.
»¶_backlog_off
 ||

493 
psync_off£t
 > (
£rv”
.
»¶_backlog_off
 + s”v”.
»¶_backlog_hi¡Ën
))

495 
	`£rv”Log
(
LL_NOTICE
,

496 "UÇbËØ·¹ŸÈ»synøw™h sÏv% fÜ†ack oàbacklog (SÏv»que¡ was: %Îd).", 
	`»¶iÿtiÚG‘SÏveName
(
c
), 
psync_off£t
);

497 ià(
psync_off£t
 > 
£rv”
.
ma¡”_»¶_off£t
) {

498 
	`£rv”Log
(
LL_WARNING
,

499 "W¬nšg: sÏv% Œ›dØPSYNC w™h‡Àoff£ˆth© i g»©”hªhma¡”„•liÿtiÚ off£t.", 
	`»¶iÿtiÚG‘SÏveName
(
c
));

501 
Ãed_fuÎ_»sync
;

508 
c
->
æags
 |ğ
CLIENT_SLAVE
;

509 
c
->
»¶¡©e
 = 
SLAVE_STATE_ONLINE
;

510 
c
->
»¶_ack_time
 = 
£rv”
.
unixtime
;

511 
c
->
»¶_put_Úlše_Ú_ack
 = 0;

512 
	`li¡AddNodeTa
(
£rv”
.
¦aves
,
c
);

516 ià(
c
->
¦ave_ÿ·
 & 
SLAVE_CAPA_PSYNC2
) {

517 
buæ’
 = 
	`¢´štf
(
buf
,(buf),"+CONTINUE %s\r\n", 
£rv”
.
»¶id
);

519 
buæ’
 = 
	`¢´štf
(
buf
,(buf),"+CONTINUE\r\n");

521 ià(
	`wr™e
(
c
->
fd
,
buf
,
buæ’
) != buflen) {

522 
	`ä“Cl›ÁAsync
(
c
);

523  
C_OK
;

525 
psync_Ën
 = 
	`addR•lyR•liÿtiÚBacklog
(
c
,
psync_off£t
);

526 
	`£rv”Log
(
LL_NOTICE
,

528 
	`»¶iÿtiÚG‘SÏveName
(
c
),

529 
psync_Ën
, 
psync_off£t
);

534 
	`»äeshGoodSÏvesCouÁ
();

535  
C_OK
;

537 
Ãed_fuÎ_»sync
:

542  
C_ERR
;

543 
	}
}

563 
	$¡¬tBg§veFÜR•liÿtiÚ
(
mšÿ·
) {

564 
»tv®
;

565 
sock‘_rg‘
 = 
£rv”
.
»¶_diskËss_sync
 && (
mšÿ·
 & 
SLAVE_CAPA_EOF
);

566 
li¡I‹r
 
li
;

567 
li¡Node
 *
Ê
;

569 
	`£rv”Log
(
LL_NOTICE
,"Starting BGSAVE for SYNC witharget: %s",

570 
sock‘_rg‘
 ? "slaves sockets" : "disk");

572 
rdbSaveInfo
 
rsi
 = 
RDB_SAVE_INFO_INIT
;

578 ià(
£rv”
.
ma¡”
è
rsi
.
»¶_¡»am_db
 = s”v”.ma¡”->
db
->
id
;

580 ià(
sock‘_rg‘
)

581 
»tv®
 = 
	`rdbSaveToSÏvesSock‘s
(&
rsi
);

583 
»tv®
 = 
	`rdbSaveBackground
(
£rv”
.
rdb_f’ame
,&
rsi
);

588 ià(
»tv®
 =ğ
C_ERR
) {

589 
	`£rv”Log
(
LL_WARNING
,"BGSAVE for„eplication failed");

590 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

591 (
Ê
 = 
	`li¡Next
(&
li
))) {

592 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

594 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_START
) {

595 
¦ave
->
æags
 &ğ~
CLIENT_SLAVE
;

596 
	`li¡D–Node
(
£rv”
.
¦aves
,
Ê
);

597 
	`addR•lyE¼Ü
(
¦ave
,

599 
¦ave
->
æags
 |ğ
CLIENT_CLOSE_AFTER_REPLY
;

602  
»tv®
;

607 ià(!
sock‘_rg‘
) {

608 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

609 (
Ê
 = 
	`li¡Next
(&
li
))) {

610 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

612 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_START
) {

613 
	`»¶iÿtiÚS‘upSÏveFÜFuÎResync
(
¦ave
,

614 
	`g‘PsyncIn™ŸlOff£t
());

621 ià(
»tv®
 =ğ
C_OK
è
	`»¶iÿtiÚSütCacheFlush
();

622  
»tv®
;

623 
	}
}

626 
	$syncCommªd
(
ş›Á
 *
c
) {

628 ià(
c
->
æags
 & 
CLIENT_SLAVE
) ;

632 ià(
£rv”
.
ma¡”ho¡
 && s”v”.
»¶_¡©e
 !ğ
REPL_STATE_CONNECTED
) {

633 
	`addR•lySds
(
c
,
	`sd¢ew
("-NOMASTERLINK Can't SYNC while‚ot connected with my master\r\n"));

641 ià(
	`ş›ÁHasP’dšgR•l›s
(
c
)) {

642 
	`addR•lyE¼Ü
(
c
,"SYNC‡nd PSYNC‡re invalid with…ending output");

646 
	`£rv”Log
(
LL_NOTICE
,"Slave %s‡sks for synchronization",

647 
	`»¶iÿtiÚG‘SÏveName
(
c
));

658 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[0]->
±r
,"psync")) {

659 ià(
	`ma¡”TryP¬tŸlResynchrÚiz©iÚ
(
c
è=ğ
C_OK
) {

660 
£rv”
.
¡©_sync_·¹Ÿl_ok
++;

663 *
ma¡”_»¶id
 = 
c
->
¬gv
[1]->
±r
;

669 ià(
ma¡”_»¶id
[0] !ğ'?'è
£rv”
.
¡©_sync_·¹Ÿl_”r
++;

675 
c
->
æags
 |ğ
CLIENT_PRE_PSYNC
;

679 
£rv”
.
¡©_sync_fuÎ
++;

683 
c
->
»¶¡©e
 = 
SLAVE_STATE_WAIT_BGSAVE_START
;

684 ià(
£rv”
.
»¶_di§bË_tı_nod–ay
)

685 
	`ª‘Di§bËTıNoD–ay
(
NULL
, 
c
->
fd
);

686 
c
->
»¶dbfd
 = -1;

687 
c
->
æags
 |ğ
CLIENT_SLAVE
;

688 
	`li¡AddNodeTa
(
£rv”
.
¦aves
,
c
);

691 ià(
	`li¡L’gth
(
£rv”
.
¦aves
è=ğ1 && s”v”.
»¶_backlog
 =ğ
NULL
) {

695 
	`chªgeR•liÿtiÚId
();

696 
	`ş—rR•liÿtiÚId2
();

697 
	`ü—‹R•liÿtiÚBacklog
();

701 ià(
£rv”
.
rdb_chd_pid
 != -1 &&

702 
£rv”
.
rdb_chd_ty³
 =ğ
RDB_CHILD_TYPE_DISK
)

707 
ş›Á
 *
¦ave
;

708 
li¡Node
 *
Ê
;

709 
li¡I‹r
 
li
;

711 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

712 (
Ê
 = 
	`li¡Next
(&
li
))) {

713 
¦ave
 = 
Ê
->
v®ue
;

714 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_END
) ;

718 ià(
Ê
 && ((
c
->
¦ave_ÿ·
 & 
¦ave
->slave_capa) == slave->slave_capa)) {

721 
	`cİyCl›ÁOuutBufãr
(
c
,
¦ave
);

722 
	`»¶iÿtiÚS‘upSÏveFÜFuÎResync
(
c
,
¦ave
->
psync_š™Ÿl_off£t
);

723 
	`£rv”Log
(
LL_NOTICE
,"Waiting forƒnd of BGSAVE for SYNC");

727 
	`£rv”Log
(
LL_NOTICE
,"Can't‡ttachhe slaveohe current BGSAVE. Waiting for‚ext BGSAVE for SYNC");

731 } ià(
£rv”
.
rdb_chd_pid
 != -1 &&

732 
£rv”
.
rdb_chd_ty³
 =ğ
RDB_CHILD_TYPE_SOCKET
)

737 
	`£rv”Log
(
LL_NOTICE
,"Current BGSAVE has socketarget. Waiting for‚ext BGSAVE for SYNC");

741 ià(
£rv”
.
»¶_diskËss_sync
 && (
c
->
¦ave_ÿ·
 & 
SLAVE_CAPA_EOF
)) {

745 ià(
£rv”
.
»¶_diskËss_sync_d–ay
)

746 
	`£rv”Log
(
LL_NOTICE
,"Delay‚ext BGSAVE for diskless SYNC");

751 ià(
£rv”
.
aof_chd_pid
 == -1) {

752 
	`¡¬tBg§veFÜR•liÿtiÚ
(
c
->
¦ave_ÿ·
);

754 
	`£rv”Log
(
LL_NOTICE
,

761 
	}
}

775 
	$»¶cÚfCommªd
(
ş›Á
 *
c
) {

776 
j
;

778 ià((
c
->
¬gc
 % 2) == 0) {

781 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

786 
j
 = 1; j < 
c
->
¬gc
; j+=2) {

787 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"listening-port")) {

788 
pÜt
;

790 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[
j
+1],

791 &
pÜt
,
NULL
è!ğ
C_OK
))

793 
c
->
¦ave_li¡’šg_pÜt
 = 
pÜt
;

794 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"ip-address")) {

795 
sds
 

 = 
c
->
¬gv
[
j
+1]->
±r
;

796 ià(
	`sd¦’
(

è< (
c
->
¦ave_
)) {

797 
	`memıy
(
c
->
¦ave_
,

,
	`sd¦’
(ip)+1);

799 
	`addR•lyE¼ÜFÜm©
(
c
,"REPLCONF ip-address…rovided by "

800 "¦avš¡ªû i toØlÚg: %zd by‹s", 
	`sd¦’
(

));

803 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"capa")) {

805 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
+1]->
±r
,"eof"))

806 
c
->
¦ave_ÿ·
 |ğ
SLAVE_CAPA_EOF
;

807 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
+1]->
±r
,"psync2"))

808 
c
->
¦ave_ÿ·
 |ğ
SLAVE_CAPA_PSYNC2
;

809 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"ack")) {

813 
off£t
;

815 ià(!(
c
->
æags
 & 
CLIENT_SLAVE
)) ;

816 ià((
	`g‘LÚgLÚgFromObjeù
(
c
->
¬gv
[
j
+1], &
off£t
è!ğ
C_OK
))

818 ià(
off£t
 > 
c
->
»¶_ack_off
)

819 
c
->
»¶_ack_off
 = 
off£t
;

820 
c
->
»¶_ack_time
 = 
£rv”
.
unixtime
;

824 ià(
c
->
»¶_put_Úlše_Ú_ack
 && c->
»¶¡©e
 =ğ
SLAVE_STATE_ONLINE
)

825 
	`putSÏveOÆše
(
c
);

828 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"getack")) {

831 ià(
£rv”
.
ma¡”ho¡
 && s”v”.
ma¡”
è
	`»¶iÿtiÚS’dAck
();

834 
	`addR•lyE¼ÜFÜm©
(
c
,"Unrecognized REPLCONF option: %s",

835 (*)
c
->
¬gv
[
j
]->
±r
);

839 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

840 
	}
}

854 
	$putSÏveOÆše
(
ş›Á
 *
¦ave
) {

855 
¦ave
->
»¶¡©e
 = 
SLAVE_STATE_ONLINE
;

856 
¦ave
->
»¶_put_Úlše_Ú_ack
 = 0;

857 
¦ave
->
»¶_ack_time
 = 
£rv”
.
unixtime
;

858 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
, 
¦ave
->
fd
, 
AE_WRITABLE
,

859 
£ndR•lyToCl›Á
, 
¦ave
è=ğ
AE_ERR
) {

860 
	`£rv”Log
(
LL_WARNING
,"UÇbËØ»gi¡” wr™abËƒv’ˆfÜ sÏvbulk¿nsãr: %s", 
	`¡»¼Ü
(
”ºo
));

861 
	`ä“Cl›Á
(
¦ave
);

864 
	`»äeshGoodSÏvesCouÁ
();

865 
	`£rv”Log
(
LL_NOTICE
,"Synchronization with slave %s succeeded",

866 
	`»¶iÿtiÚG‘SÏveName
(
¦ave
));

867 
	}
}

869 
	$£ndBulkToSÏve
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

870 
ş›Á
 *
¦ave
 = 
´ivd©a
;

871 
	`UNUSED
(
–
);

872 
	`UNUSED
(
mask
);

873 
buf
[
PROTO_IOBUF_LEN
];

874 
ssize_t
 
nwr™‹n
, 
buæ’
;

879 ià(
¦ave
->
»¶´—mbË
) {

880 
nwr™‹n
 = 
	`wr™e
(
fd
,
¦ave
->
»¶´—mbË
,
	`sd¦’
(slave->replpreamble));

881 ià(
nwr™‹n
 == -1) {

882 
	`£rv”Log
(
LL_VERBOSE
,"Writeƒrror sending RDB…reambleo slave: %s",

883 
	`¡»¼Ü
(
”ºo
));

884 
	`ä“Cl›Á
(
¦ave
);

887 
£rv”
.
¡©_Ãt_ouut_by‹s
 +ğ
nwr™‹n
;

888 
	`sd¤ªge
(
¦ave
->
»¶´—mbË
,
nwr™‹n
,-1);

889 ià(
	`sd¦’
(
¦ave
->
»¶´—mbË
) == 0) {

890 
	`sdsä“
(
¦ave
->
»¶´—mbË
);

891 
¦ave
->
»¶´—mbË
 = 
NULL
;

899 
	`l£ek
(
¦ave
->
»¶dbfd
,¦ave->
»¶dboff
,
SEEK_SET
);

900 
buæ’
 = 
	`»ad
(
¦ave
->
»¶dbfd
,
buf
,
PROTO_IOBUF_LEN
);

901 ià(
buæ’
 <= 0) {

902 
	`£rv”Log
(
LL_WARNING
,"Readƒrror sending DBo slave: %s",

903 (
buæ’
 =ğ0è? "´em©u» EOF" : 
	`¡»¼Ü
(
”ºo
));

904 
	`ä“Cl›Á
(
¦ave
);

907 ià((
nwr™‹n
 = 
	`wr™e
(
fd
,
buf
,
buæ’
)) == -1) {

908 ià(
”ºo
 !ğ
EAGAIN
) {

909 
	`£rv”Log
(
LL_WARNING
,"Writeƒrror sending DBo slave: %s",

910 
	`¡»¼Ü
(
”ºo
));

911 
	`ä“Cl›Á
(
¦ave
);

915 
¦ave
->
»¶dboff
 +ğ
nwr™‹n
;

916 
£rv”
.
¡©_Ãt_ouut_by‹s
 +ğ
nwr™‹n
;

917 ià(
¦ave
->
»¶dboff
 =ğ¦ave->
»¶dbsize
) {

918 
	`şo£
(
¦ave
->
»¶dbfd
);

919 
¦ave
->
»¶dbfd
 = -1;

920 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
¦ave
->
fd
,
AE_WRITABLE
);

921 
	`putSÏveOÆše
(
¦ave
);

923 
	}
}

939 
	$upd©eSÏvesWa™šgBg§ve
(
bg§v“¼
, 
ty³
) {

940 
li¡Node
 *
Ê
;

941 
¡¬tbg§ve
 = 0;

942 
mšÿ·
 = -1;

943 
li¡I‹r
 
li
;

945 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

946 (
Ê
 = 
	`li¡Next
(&
li
))) {

947 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

949 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_START
) {

950 
¡¬tbg§ve
 = 1;

951 
mšÿ·
 = (mšÿ· =ğ-1è? 
¦ave
->
¦ave_ÿ·
 :

952 (
mšÿ·
 & 
¦ave
->
¦ave_ÿ·
);

953 } ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_END
) {

954 
»dis_¡©
 
buf
;

961 ià(
ty³
 =ğ
RDB_CHILD_TYPE_SOCKET
) {

962 
	`£rv”Log
(
LL_NOTICE
,

964 
	`»¶iÿtiÚG‘SÏveName
(
¦ave
));

970 
¦ave
->
»¶¡©e
 = 
SLAVE_STATE_ONLINE
;

971 
¦ave
->
»¶_put_Úlše_Ú_ack
 = 1;

972 
¦ave
->
»¶_ack_time
 = 
£rv”
.
unixtime
;

974 ià(
bg§v“¼
 !ğ
C_OK
) {

975 
	`ä“Cl›Á
(
¦ave
);

976 
	`£rv”Log
(
LL_WARNING
,"SYNC failed. BGSAVE child„eturned‡nƒrror");

979 ià((
¦ave
->
»¶dbfd
 = 
	`İ’
(
£rv”
.
rdb_f’ame
,
O_RDONLY
)) == -1 ||

980 
	`»dis_f¡©
(
¦ave
->
»¶dbfd
,&
buf
) == -1) {

981 
	`ä“Cl›Á
(
¦ave
);

982 
	`£rv”Log
(
LL_WARNING
,"SYNC faed. Cª'ˆİ’/¡© DB‡á” BGSAVE: %s", 
	`¡»¼Ü
(
”ºo
));

985 
¦ave
->
»¶dboff
 = 0;

986 
¦ave
->
»¶dbsize
 = 
buf
.
¡_size
;

987 
¦ave
->
»¶¡©e
 = 
SLAVE_STATE_SEND_BULK
;

988 
¦ave
->
»¶´—mbË
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"$%lld\r\n",

989 (è
¦ave
->
»¶dbsize
);

991 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
¦ave
->
fd
,
AE_WRITABLE
);

992 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
, 
¦ave
->
fd
, 
AE_WRITABLE
, 
£ndBulkToSÏve
, sÏveè=ğ
AE_ERR
) {

993 
	`ä“Cl›Á
(
¦ave
);

999 ià(
¡¬tbg§ve
è
	`¡¬tBg§veFÜR•liÿtiÚ
(
mšÿ·
);

1000 
	}
}

1006 
	$chªgeR•liÿtiÚId
() {

1007 
	`g‘RªdomHexCh¬s
(
£rv”
.
»¶id
,
CONFIG_RUN_ID_SIZE
);

1008 
£rv”
.
»¶id
[
CONFIG_RUN_ID_SIZE
] = '\0';

1009 
	}
}

1014 
	$ş—rR•liÿtiÚId2
() {

1015 
	`mem£t
(
£rv”
.
»¶id2
,'0',(£rv”.
»¶id
));

1016 
£rv”
.
»¶id2
[
CONFIG_RUN_ID_SIZE
] = '\0';

1017 
£rv”
.
£cÚd_»¶id_off£t
 = -1;

1018 
	}
}

1025 
	$shiáR•liÿtiÚId
() {

1026 
	`memıy
(
£rv”
.
»¶id2
,£rv”.
»¶id
,(server.replid));

1034 
£rv”
.
£cÚd_»¶id_off£t
 = s”v”.
ma¡”_»¶_off£t
+1;

1035 
	`chªgeR•liÿtiÚId
();

1036 
	`£rv”Log
(
LL_WARNING
,"S‘tšg secÚd¬y„•liÿtiÚ IDØ%s, v®id u°tØoff£t: %Îd. New„•liÿtiÚ ID i %s", 
£rv”
.
»¶id2
, s”v”.
£cÚd_»¶id_off£t
, s”v”.
»¶id
);

1037 
	}
}

1043 
	$¦aveIsInHªdshakeS‹
() {

1044  
£rv”
.
»¶_¡©e
 >ğ
REPL_STATE_RECEIVE_PONG
 &&

1045 
£rv”
.
»¶_¡©e
 <ğ
REPL_STATE_RECEIVE_PSYNC
;

1046 
	}
}

1056 
	$»¶iÿtiÚS’dNewlšeToMa¡”
() {

1057 
time_t
 
Ãwlše_£Á
;

1058 ià(
	`time
(
NULL
è!ğ
Ãwlše_£Á
) {

1059 
Ãwlše_£Á
 = 
	`time
(
NULL
);

1060 ià(
	`wr™e
(
£rv”
.
»¶_Œªsãr_s
,"\n",1) == -1) {

1064 
	}
}

1068 
	$»¶iÿtiÚEm±yDbC®lback
(*
´ivd©a
) {

1069 
	`UNUSED
(
´ivd©a
);

1070 
	`»¶iÿtiÚS’dNewlšeToMa¡”
();

1071 
	}
}

1076 
	$»¶iÿtiÚC»©eMa¡”Cl›Á
(
fd
, 
dbid
) {

1077 
£rv”
.
ma¡”
 = 
	`ü—‹Cl›Á
(
fd
);

1078 
£rv”
.
ma¡”
->
æags
 |ğ
CLIENT_MASTER
;

1079 
£rv”
.
ma¡”
->
auth’tiÿ‹d
 = 1;

1080 
£rv”
.
ma¡”
->
»¶off
 = s”v”.
ma¡”_š™Ÿl_off£t
;

1081 
£rv”
.
ma¡”
->
»ad_»¶off
 = s”v”.ma¡”->
»¶off
;

1082 
	`memıy
(
£rv”
.
ma¡”
->
»¶id
, s”v”.
ma¡”_»¶id
,

1083 (
£rv”
.
ma¡”_»¶id
));

1086 ià(
£rv”
.
ma¡”
->
»¶off
 == -1)

1087 
£rv”
.
ma¡”
->
æags
 |ğ
CLIENT_PRE_PSYNC
;

1088 ià(
dbid
 !ğ-1è
	`£ËùDb
(
£rv”
.
ma¡”
,dbid);

1089 
	}
}

1091 
	$»¡¬tAOF
() {

1092 
»Œy
 = 10;

1093 
»Œy
-- && 
	`¡¬tAµ’dOÆy
(è=ğ
C_ERR
) {

1094 
	`£rv”Log
(
LL_WARNING
,"Failedƒnablinghe AOF‡fter successful master synchronization! Trying it‡gain in one second.");

1095 
	`¦“p
(1);

1097 ià(!
»Œy
) {

1098 
	`£rv”Log
(
LL_WARNING
,"FATAL:his slave instance finishedhe synchronization with its master, buthe AOF can't beurned on. Exiting‚ow.");

1099 
	`ex™
(1);

1101 
	}
}

1104 
	#REPL_MAX_WRITTEN_BEFORE_FSYNC
 (1024*1024*8è

	)

1105 
	$»adSyncBulkPaylßd
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

1106 
buf
[4096];

1107 
ssize_t
 
Ä—d
, 
»adËn
;

1108 
off_t
 
Ëá
;

1109 
	`UNUSED
(
–
);

1110 
	`UNUSED
(
´ivd©a
);

1111 
	`UNUSED
(
mask
);

1115 
eofm¬k
[
CONFIG_RUN_ID_SIZE
];

1116 
Ï¡by‹s
[
CONFIG_RUN_ID_SIZE
];

1117 
u£m¬k
 = 0;

1121 ià(
£rv”
.
»¶_Œªsãr_size
 == -1) {

1122 ià(
	`syncR—dLše
(
fd
,
buf
,1024,
£rv”
.
»¶_syncio_timeout
*1000) == -1) {

1123 
	`£rv”Log
(
LL_WARNING
,

1125 
	`¡»¼Ü
(
”ºo
));

1126 
”rÜ
;

1129 ià(
buf
[0] == '-') {

1130 
	`£rv”Log
(
LL_WARNING
,

1132 
buf
+1);

1133 
”rÜ
;

1134 } ià(
buf
[0] == '\0') {

1138 
£rv”
.
»¶_Œªsãr_Ï¡io
 = s”v”.
unixtime
;

1140 } ià(
buf
[0] != '$') {

1141 
	`£rv”Log
(
LL_WARNING
,"Bad…rÙocŞ from MASTER,hfœ¡ by‹ i nÙ '$' (w»ûived '%s'),‡» you su»hho¡‡nd…Üˆ¬right?", 
buf
);

1142 
”rÜ
;

1155 ià(
	`¡ºcmp
(
buf
+1,"EOF:",4è=ğ0 && 
	`¡¾’
(buf+5è>ğ
CONFIG_RUN_ID_SIZE
) {

1156 
u£m¬k
 = 1;

1157 
	`memıy
(
eofm¬k
,
buf
+5,
CONFIG_RUN_ID_SIZE
);

1158 
	`mem£t
(
Ï¡by‹s
,0,
CONFIG_RUN_ID_SIZE
);

1161 
£rv”
.
»¶_Œªsãr_size
 = 0;

1162 
	`£rv”Log
(
LL_NOTICE
,

1165 
u£m¬k
 = 0;

1166 
£rv”
.
»¶_Œªsãr_size
 = 
	`¡¹Ş
(
buf
+1,
NULL
,10);

1167 
	`£rv”Log
(
LL_NOTICE
,

1169 (è
£rv”
.
»¶_Œªsãr_size
);

1175 ià(
u£m¬k
) {

1176 
»adËn
 = (
buf
);

1178 
Ëá
 = 
£rv”
.
»¶_Œªsãr_size
 - s”v”.
»¶_Œªsãr_»ad
;

1179 
»adËn
 = (
Ëá
 < (sigÃd)(
buf
)) ?†eft : (signed)(buf);

1182 
Ä—d
 = 
	`»ad
(
fd
,
buf
,
»adËn
);

1183 ià(
Ä—d
 <= 0) {

1184 
	`£rv”Log
(
LL_WARNING
,"I/Oƒrrorryingo sync with MASTER: %s",

1185 (
Ä—d
 =ğ-1è? 
	`¡»¼Ü
(
”ºo
) : "connection†ost");

1186 
	`ÿnûlR•liÿtiÚHªdshake
();

1189 
£rv”
.
¡©_Ãt_šput_by‹s
 +ğ
Ä—d
;

1193 
eof_»ached
 = 0;

1195 ià(
u£m¬k
) {

1197 ià(
Ä—d
 >ğ
CONFIG_RUN_ID_SIZE
) {

1198 
	`memıy
(
Ï¡by‹s
,
buf
+
Ä—d
-
CONFIG_RUN_ID_SIZE
,CONFIG_RUN_ID_SIZE);

1200 
»m
 = 
CONFIG_RUN_ID_SIZE
-
Ä—d
;

1201 
	`memmove
(
Ï¡by‹s
,Ï¡by‹s+
Ä—d
,
»m
);

1202 
	`memıy
(
Ï¡by‹s
+
»m
,
buf
,
Ä—d
);

1204 ià(
	`memcmp
(
Ï¡by‹s
,
eofm¬k
,
CONFIG_RUN_ID_SIZE
è=ğ0è
eof_»ached
 = 1;

1207 
£rv”
.
»¶_Œªsãr_Ï¡io
 = s”v”.
unixtime
;

1208 ià(
	`wr™e
(
£rv”
.
»¶_Œªsãr_fd
,
buf
,
Ä—d
) !=‚read) {

1209 
	`£rv”Log
(
LL_WARNING
,"Wr™”rÜ o¸shÜˆwr™wr™šgØthDB dum°fÃeded fÜ MASTER <-> SLAVE synchrÚiz©iÚ: %s", 
	`¡»¼Ü
(
”ºo
));

1210 
”rÜ
;

1212 
£rv”
.
»¶_Œªsãr_»ad
 +ğ
Ä—d
;

1215 ià(
u£m¬k
 && 
eof_»ached
) {

1216 ià(
	`árunÿ‹
(
£rv”
.
»¶_Œªsãr_fd
,

1217 
£rv”
.
»¶_Œªsãr_»ad
 - 
CONFIG_RUN_ID_SIZE
) == -1)

1219 
	`£rv”Log
(
LL_WARNING
,"E¼ÜrunÿtšghRDB f»ûived fromhma¡” fÜ SYNC: %s", 
	`¡»¼Ü
(
”ºo
));

1220 
”rÜ
;

1227 ià(
£rv”
.
»¶_Œªsãr_»ad
 >=

1228 
£rv”
.
»¶_Œªsãr_Ï¡_fsync_off
 + 
REPL_MAX_WRITTEN_BEFORE_FSYNC
)

1230 
off_t
 
sync_size
 = 
£rv”
.
»¶_Œªsãr_»ad
 -

1231 
£rv”
.
»¶_Œªsãr_Ï¡_fsync_off
;

1232 
	`rdb_fsync_¿nge
(
£rv”
.
»¶_Œªsãr_fd
,

1233 
£rv”
.
»¶_Œªsãr_Ï¡_fsync_off
, 
sync_size
);

1234 
£rv”
.
»¶_Œªsãr_Ï¡_fsync_off
 +ğ
sync_size
;

1238 ià(!
u£m¬k
) {

1239 ià(
£rv”
.
»¶_Œªsãr_»ad
 =ğ£rv”.
»¶_Œªsãr_size
)

1240 
eof_»ached
 = 1;

1243 ià(
eof_»ached
) {

1244 
aof_is_’abËd
 = 
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
;

1246 ià(
	`»Çme
(
£rv”
.
»¶_Œªsãr_tmpfe
,£rv”.
rdb_f’ame
) == -1) {

1247 
	`£rv”Log
(
LL_WARNING
,"FaedryšgØ»Çmth‹m°DB iÁØdump.rdb iÀMASTER <-> SLAVE synchrÚiz©iÚ: %s", 
	`¡»¼Ü
(
”ºo
));

1248 
	`ÿnûlR•liÿtiÚHªdshake
();

1251 
	`£rv”Log
(
LL_NOTICE
, "MASTER <-> SLAVE sync: Flushing old data");

1254 if(
aof_is_’abËd
è
	`¡İAµ’dOÆy
();

1255 
	`sigÇlFlushedDb
(-1);

1256 
	`em±yDb
(

1258 
£rv”
.
»¶_¦ave_Ïzy_æush
 ? 
EMPTYDB_ASYNC
 : 
EMPTYDB_NO_FLAGS
,

1259 
»¶iÿtiÚEm±yDbC®lback
);

1264 
	`«D–‘eFeEv’t
(
£rv”
.
–
,£rv”.
»¶_Œªsãr_s
,
AE_READABLE
);

1265 
	`£rv”Log
(
LL_NOTICE
, "MASTER <-> SLAVE sync: Loading DB in memory");

1266 
rdbSaveInfo
 
rsi
 = 
RDB_SAVE_INFO_INIT
;

1267 ià(
	`rdbLßd
(
£rv”
.
rdb_f’ame
,&
rsi
è!ğ
C_OK
) {

1268 
	`£rv”Log
(
LL_WARNING
,"Failedryingo†oadhe MASTER synchronization DB from disk");

1269 
	`ÿnûlR•liÿtiÚHªdshake
();

1272 ià(
aof_is_’abËd
è
	`»¡¬tAOF
();

1276 
	`zä“
(
£rv”
.
»¶_Œªsãr_tmpfe
);

1277 
	`şo£
(
£rv”
.
»¶_Œªsãr_fd
);

1278 
	`»¶iÿtiÚC»©eMa¡”Cl›Á
(
£rv”
.
»¶_Œªsãr_s
,
rsi
.
»¶_¡»am_db
);

1279 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_CONNECTED
;

1283 
	`memıy
(
£rv”
.
»¶id
,£rv”.
ma¡”
->replid,(server.replid));

1284 
£rv”
.
ma¡”_»¶_off£t
 = s”v”.
ma¡”
->
»¶off
;

1285 
	`ş—rR•liÿtiÚId2
();

1290 ià(
£rv”
.
»¶_backlog
 =ğ
NULL
è
	`ü—‹R•liÿtiÚBacklog
();

1292 
	`£rv”Log
(
LL_NOTICE
, "MASTER <-> SLAVE sync: Finished with success");

1296 ià(
aof_is_’abËd
è
	`»¡¬tAOF
();

1300 
”rÜ
:

1301 
	`ÿnûlR•liÿtiÚHªdshake
();

1303 
	}
}

1311 
	#SYNC_CMD_READ
 (1<<0)

	)

1312 
	#SYNC_CMD_WRITE
 (1<<1)

	)

1313 
	#SYNC_CMD_FULL
 (
SYNC_CMD_READ
|
SYNC_CMD_WRITE
)

	)

1314 *
	$£ndSynchrÚousCommªd
(
æags
, 
fd
, ...) {

1318 ià(
æags
 & 
SYNC_CMD_WRITE
) {

1319 *
¬g
;

1320 
va_li¡
 
­
;

1321 
sds
 
cmd
 = 
	`sd£m±y
();

1322 
	`va_¡¬t
(
­
,
fd
);

1325 
¬g
 = 
	`va_¬g
(
­
, *);

1326 ià(
¬g
 =ğ
NULL
) ;

1328 ià(
	`sd¦’
(
cmd
è!ğ0ècmd = 
	`sdsÿ’
(cmd," ",1);

1329 
cmd
 = 
	`sdsÿt
(cmd,
¬g
);

1331 
cmd
 = 
	`sdsÿ’
(cmd,"\r\n",2);

1334 ià(
	`syncWr™e
(
fd
,
cmd
,
	`sd¦’
(cmd),
£rv”
.
»¶_syncio_timeout
*1000)

1337 
	`sdsä“
(
cmd
);

1338  
	`sdsÿrštf
(
	`sd£m±y
(),"-Writingo master: %s",

1339 
	`¡»¼Ü
(
”ºo
));

1341 
	`sdsä“
(
cmd
);

1342 
	`va_’d
(
­
);

1346 ià(
æags
 & 
SYNC_CMD_READ
) {

1347 
buf
[256];

1349 ià(
	`syncR—dLše
(
fd
,
buf
,(buf),
£rv”
.
»¶_syncio_timeout
*1000)

1352  
	`sdsÿrštf
(
	`sd£m±y
(),"-Reading from master: %s",

1353 
	`¡»¼Ü
(
”ºo
));

1355 
£rv”
.
»¶_Œªsãr_Ï¡io
 = s”v”.
unixtime
;

1356  
	`sd¢ew
(
buf
);

1358  
NULL
;

1359 
	}
}

1409 
	#PSYNC_WRITE_ERROR
 0

	)

1410 
	#PSYNC_WAIT_REPLY
 1

	)

1411 
	#PSYNC_CONTINUE
 2

	)

1412 
	#PSYNC_FULLRESYNC
 3

	)

1413 
	#PSYNC_NOT_SUPPORTED
 4

	)

1414 
	#PSYNC_TRY_LATER
 5

	)

1415 
	$¦aveTryP¬tŸlResynchrÚiz©iÚ
(
fd
, 
»ad_»¶y
) {

1416 *
psync_»¶id
;

1417 
psync_off£t
[32];

1418 
sds
 
»¶y
;

1421 ià(!
»ad_»¶y
) {

1427 
£rv”
.
ma¡”_š™Ÿl_off£t
 = -1;

1429 ià(
£rv”
.
ÿched_ma¡”
) {

1430 
psync_»¶id
 = 
£rv”
.
ÿched_ma¡”
->
»¶id
;

1431 
	`¢´štf
(
psync_off£t
,Õsync_off£t),"%Îd", 
£rv”
.
ÿched_ma¡”
->
»¶off
+1);

1432 
	`£rv”Log
(
LL_NOTICE
,"Tryšg‡…¬tŸÈ»synchrÚiz©iÚ (»que¡ %s:%s).", 
psync_»¶id
, 
psync_off£t
);

1434 
	`£rv”Log
(
LL_NOTICE
,"Partial„esynchronization‚ot…ossible (no cached master)");

1435 
psync_»¶id
 = "?";

1436 
	`memıy
(
psync_off£t
,"-1",3);

1440 
»¶y
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_WRITE
,
fd
,"PSYNC",
psync_»¶id
,
psync_off£t
,
NULL
);

1441 ià(
»¶y
 !ğ
NULL
) {

1442 
	`£rv”Log
(
LL_WARNING
,"UÇbËØ£nd PSYNCØma¡”: %s",
»¶y
);

1443 
	`sdsä“
(
»¶y
);

1444 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
fd
,
AE_READABLE
);

1445  
PSYNC_WRITE_ERROR
;

1447  
PSYNC_WAIT_REPLY
;

1451 
»¶y
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_READ
,
fd
,
NULL
);

1452 ià(
	`sd¦’
(
»¶y
) == 0) {

1455 
	`sdsä“
(
»¶y
);

1456  
PSYNC_WAIT_REPLY
;

1459 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
fd
,
AE_READABLE
);

1461 ià(!
	`¡ºcmp
(
»¶y
,"+FULLRESYNC",11)) {

1462 *
»¶id
 = 
NULL
, *
off£t
 = NULL;

1466 
»¶id
 = 
	`¡rchr
(
»¶y
,' ');

1467 ià(
»¶id
) {

1468 
»¶id
++;

1469 
off£t
 = 
	`¡rchr
(
»¶id
,' ');

1470 ià(
off£t
) offset++;

1472 ià(!
»¶id
 || !
off£t
 || (off£t-»¶id-1è!ğ
CONFIG_RUN_ID_SIZE
) {

1473 
	`£rv”Log
(
LL_WARNING
,

1479 
	`mem£t
(
£rv”
.
ma¡”_»¶id
,0,
CONFIG_RUN_ID_SIZE
+1);

1481 
	`memıy
(
£rv”
.
ma¡”_»¶id
, 
»¶id
, 
off£t
-replid-1);

1482 
£rv”
.
ma¡”_»¶id
[
CONFIG_RUN_ID_SIZE
] = '\0';

1483 
£rv”
.
ma¡”_š™Ÿl_off£t
 = 
	`¡¹Şl
(
off£t
,
NULL
,10);

1484 
	`£rv”Log
(
LL_NOTICE
,"Full„esync from master: %s:%lld",

1485 
£rv”
.
ma¡”_»¶id
,

1486 
£rv”
.
ma¡”_š™Ÿl_off£t
);

1489 
	`»¶iÿtiÚDisÿrdCachedMa¡”
();

1490 
	`sdsä“
(
»¶y
);

1491  
PSYNC_FULLRESYNC
;

1494 ià(!
	`¡ºcmp
(
»¶y
,"+CONTINUE",9)) {

1496 
	`£rv”Log
(
LL_NOTICE
,

1504 *
¡¬t
 = 
»¶y
+10;

1505 *
’d
 = 
»¶y
+9;

1506 
’d
[0] != '\r' &&ƒnd[0] != '\n' &&ƒnd[0] != '\0')ƒnd++;

1507 ià(
’d
-
¡¬t
 =ğ
CONFIG_RUN_ID_SIZE
) {

1508 
Ãw
[
CONFIG_RUN_ID_SIZE
+1];

1509 
	`memıy
(
Ãw
,
¡¬t
,
CONFIG_RUN_ID_SIZE
);

1510 
Ãw
[
CONFIG_RUN_ID_SIZE
] = '\0';

1512 ià(
	`¡rcmp
(
Ãw
,
£rv”
.
ÿched_ma¡”
->
»¶id
)) {

1514 
	`£rv”Log
(
LL_WARNING
,"Ma¡”„•liÿtiÚ ID chªgedØ%s",
Ãw
);

1517 
	`memıy
(
£rv”
.
»¶id2
,£rv”.
ÿched_ma¡”
->
»¶id
,

1518 (
£rv”
.
»¶id2
));

1519 
£rv”
.
£cÚd_»¶id_off£t
 = s”v”.
ma¡”_»¶_off£t
+1;

1523 
	`memıy
(
£rv”
.
»¶id
,
Ãw
,(server.replid));

1524 
	`memıy
(
£rv”
.
ÿched_ma¡”
->
»¶id
,
Ãw
,(server.replid));

1527 
	`discÚÃùSÏves
();

1532 
	`sdsä“
(
»¶y
);

1533 
	`»¶iÿtiÚResu¼eùCachedMa¡”
(
fd
);

1534  
PSYNC_CONTINUE
;

1544 ià(!
	`¡ºcmp
(
»¶y
,"-NOMASTERLINK",13) ||

1545 !
	`¡ºcmp
(
»¶y
,"-LOADING",8))

1547 
	`£rv”Log
(
LL_NOTICE
,

1549 "buˆshould bšhfutu»: %s", 
»¶y
);

1550 
	`sdsä“
(
»¶y
);

1551  
PSYNC_TRY_LATER
;

1554 ià(
	`¡ºcmp
(
»¶y
,"-ERR",4)) {

1556 
	`£rv”Log
(
LL_WARNING
,

1557 "UÃx³ùed„•lyØPSYNC from ma¡”: %s", 
»¶y
);

1559 
	`£rv”Log
(
LL_NOTICE
,

1561 "”rÜ s‹ (»¶y: %s)", 
»¶y
);

1563 
	`sdsä“
(
»¶y
);

1564 
	`»¶iÿtiÚDisÿrdCachedMa¡”
();

1565  
PSYNC_NOT_SUPPORTED
;

1566 
	}
}

1570 
	$syncW™hMa¡”
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

1571 
tmpfe
[256], *
”r
 = 
NULL
;

1572 
dfd
 = -1, 
maxŒ›s
 = 5;

1573 
sock”r
 = 0, 
psync_»suÉ
;

1574 
sockËn_t
 
”¾’
 = (
sock”r
);

1575 
	`UNUSED
(
–
);

1576 
	`UNUSED
(
´ivd©a
);

1577 
	`UNUSED
(
mask
);

1581 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_NONE
) {

1582 
	`şo£
(
fd
);

1588 ià(
	`g‘sockİt
(
fd
, 
SOL_SOCKET
, 
SO_ERROR
, &
sock”r
, &
”¾’
) == -1)

1589 
sock”r
 = 
”ºo
;

1590 ià(
sock”r
) {

1591 
	`£rv”Log
(
LL_WARNING
,"Error condition on socket for SYNC: %s",

1592 
	`¡»¼Ü
(
sock”r
));

1593 
”rÜ
;

1597 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_CONNECTING
) {

1598 
	`£rv”Log
(
LL_NOTICE
,"Non blocking connect for SYNC firedheƒvent.");

1601 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
fd
,
AE_WRITABLE
);

1602 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_RECEIVE_PONG
;

1605 
”r
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_WRITE
,
fd
,"PING",
NULL
);

1606 ià(
”r
è
wr™e_”rÜ
;

1611 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_RECEIVE_PONG
) {

1612 
”r
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_READ
,
fd
,
NULL
);

1619 ià(
”r
[0] != '+' &&

1620 
	`¡ºcmp
(
”r
,"-NOAUTH",7) != 0 &&

1621 
	`¡ºcmp
(
”r
,"-ERR operation‚ot…ermitted",28) != 0)

1623 
	`£rv”Log
(
LL_WARNING
,"E¼Ü„•lyØPING from ma¡”: '%s'",
”r
);

1624 
	`sdsä“
(
”r
);

1625 
”rÜ
;

1627 
	`£rv”Log
(
LL_NOTICE
,

1630 
	`sdsä“
(
”r
);

1631 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_SEND_AUTH
;

1635 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_SEND_AUTH
) {

1636 ià(
£rv”
.
ma¡”auth
) {

1637 
”r
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_WRITE
,
fd
,"AUTH",
£rv”
.
ma¡”auth
,
NULL
);

1638 ià(
”r
è
wr™e_”rÜ
;

1639 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_RECEIVE_AUTH
;

1642 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_SEND_PORT
;

1647 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_RECEIVE_AUTH
) {

1648 
”r
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_READ
,
fd
,
NULL
);

1649 ià(
”r
[0] == '-') {

1650 
	`£rv”Log
(
LL_WARNING
,"UÇbËØAUTHØMASTER: %s",
”r
);

1651 
	`sdsä“
(
”r
);

1652 
”rÜ
;

1654 
	`sdsä“
(
”r
);

1655 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_SEND_PORT
;

1660 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_SEND_PORT
) {

1661 
sds
 
pÜt
 = 
	`sdsäomlÚglÚg
(
£rv”
.
¦ave_ªnounû_pÜt
 ?

1662 
£rv”
.
¦ave_ªnounû_pÜt
 : s”v”.
pÜt
);

1663 
”r
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_WRITE
,
fd
,"REPLCONF",

1664 "li¡’šg-pÜt",
pÜt
, 
NULL
);

1665 
	`sdsä“
(
pÜt
);

1666 ià(
”r
è
wr™e_”rÜ
;

1667 
	`sdsä“
(
”r
);

1668 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_RECEIVE_PORT
;

1673 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_RECEIVE_PORT
) {

1674 
”r
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_READ
,
fd
,
NULL
);

1677 ià(
”r
[0] == '-') {

1678 
	`£rv”Log
(
LL_NOTICE
,"(Non critical) Master does‚ot understand "

1679 "REPLCONF†i¡’šg-pÜt: %s", 
”r
);

1681 
	`sdsä“
(
”r
);

1682 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_SEND_IP
;

1686 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_SEND_IP
 &&

1687 
£rv”
.
¦ave_ªnounû_
 =ğ
NULL
)

1689 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_SEND_CAPA
;

1694 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_SEND_IP
) {

1695 
”r
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_WRITE
,
fd
,"REPLCONF",

1696 "-add»ss",
£rv”
.
¦ave_ªnounû_
, 
NULL
);

1697 ià(
”r
è
wr™e_”rÜ
;

1698 
	`sdsä“
(
”r
);

1699 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_RECEIVE_IP
;

1704 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_RECEIVE_IP
) {

1705 
”r
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_READ
,
fd
,
NULL
);

1708 ià(
”r
[0] == '-') {

1709 
	`£rv”Log
(
LL_NOTICE
,"(Non critical) Master does‚ot understand "

1710 "REPLCONF ip-add»ss: %s", 
”r
);

1712 
	`sdsä“
(
”r
);

1713 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_SEND_CAPA
;

1722 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_SEND_CAPA
) {

1723 
”r
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_WRITE
,
fd
,"REPLCONF",

1724 "ÿ·","eof","ÿ·","psync2",
NULL
);

1725 ià(
”r
è
wr™e_”rÜ
;

1726 
	`sdsä“
(
”r
);

1727 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_RECEIVE_CAPA
;

1732 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_RECEIVE_CAPA
) {

1733 
”r
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_READ
,
fd
,
NULL
);

1736 ià(
”r
[0] == '-') {

1737 
	`£rv”Log
(
LL_NOTICE
,"(Non critical) Master does‚ot understand "

1738 "REPLCONF c­a: %s", 
”r
);

1740 
	`sdsä“
(
”r
);

1741 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_SEND_PSYNC
;

1749 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_SEND_PSYNC
) {

1750 ià(
	`¦aveTryP¬tŸlResynchrÚiz©iÚ
(
fd
,0è=ğ
PSYNC_WRITE_ERROR
) {

1751 
”r
 = 
	`sd¢ew
("Writeƒrror sendinghe PSYNC command.");

1752 
wr™e_”rÜ
;

1754 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_RECEIVE_PSYNC
;

1759 ià(
£rv”
.
»¶_¡©e
 !ğ
REPL_STATE_RECEIVE_PSYNC
) {

1760 
	`£rv”Log
(
LL_WARNING
,"syncWithMaster(): state machineƒrror, "

1762 
£rv”
.
»¶_¡©e
);

1763 
”rÜ
;

1766 
psync_»suÉ
 = 
	`¦aveTryP¬tŸlResynchrÚiz©iÚ
(
fd
,1);

1767 ià(
psync_»suÉ
 =ğ
PSYNC_WAIT_REPLY
) ;

1773 ià(
psync_»suÉ
 =ğ
PSYNC_TRY_LATER
è
”rÜ
;

1778 ià(
psync_»suÉ
 =ğ
PSYNC_CONTINUE
) {

1779 
	`£rv”Log
(
LL_NOTICE
, "MASTER <-> SLAVE sync: Master‡ccepted‡ Partial Resynchronization.");

1787 
	`discÚÃùSÏves
();

1788 
	`ä“R•liÿtiÚBacklog
();

1793 ià(
psync_»suÉ
 =ğ
PSYNC_NOT_SUPPORTED
) {

1794 
	`£rv”Log
(
LL_NOTICE
,"Retrying with SYNC...");

1795 ià(
	`syncWr™e
(
fd
,"SYNC\r\n",6,
£rv”
.
»¶_syncio_timeout
*1000) == -1) {

1796 
	`£rv”Log
(
LL_WARNING
,"I/Oƒrror writingo MASTER: %s",

1797 
	`¡»¼Ü
(
”ºo
));

1798 
”rÜ
;

1803 
maxŒ›s
--) {

1804 
	`¢´štf
(
tmpfe
,256,

1805 "‹mp-%d.%ld.rdb",()
£rv”
.
unixtime
,()
	`g‘pid
());

1806 
dfd
 = 
	`İ’
(
tmpfe
,
O_CREAT
|
O_WRONLY
|
O_EXCL
,0644);

1807 ià(
dfd
 != -1) ;

1808 
	`¦“p
(1);

1810 ià(
dfd
 == -1) {

1811 
	`£rv”Log
(
LL_WARNING
,"O³nšgh‹m°fÃeded fÜ MASTER <-> SLAVE synchrÚiz©iÚ: %s",
	`¡»¼Ü
(
”ºo
));

1812 
”rÜ
;

1816 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
,
fd
, 
AE_READABLE
,
»adSyncBulkPaylßd
,
NULL
)

1817 =ğ
AE_ERR
)

1819 
	`£rv”Log
(
LL_WARNING
,

1821 
	`¡»¼Ü
(
”ºo
),
fd
);

1822 
”rÜ
;

1825 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_TRANSFER
;

1826 
£rv”
.
»¶_Œªsãr_size
 = -1;

1827 
£rv”
.
»¶_Œªsãr_»ad
 = 0;

1828 
£rv”
.
»¶_Œªsãr_Ï¡_fsync_off
 = 0;

1829 
£rv”
.
»¶_Œªsãr_fd
 = 
dfd
;

1830 
£rv”
.
»¶_Œªsãr_Ï¡io
 = s”v”.
unixtime
;

1831 
£rv”
.
»¶_Œªsãr_tmpfe
 = 
	`z¡rdup
(
tmpfe
);

1834 
”rÜ
:

1835 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
fd
,
AE_READABLE
|
AE_WRITABLE
);

1836 ià(
dfd
 !ğ-1è
	`şo£
(dfd);

1837 
	`şo£
(
fd
);

1838 
£rv”
.
»¶_Œªsãr_s
 = -1;

1839 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_CONNECT
;

1842 
wr™e_”rÜ
:

1843 
	`£rv”Log
(
LL_WARNING
,"S’dšg commªdØma¡” iÀ»¶iÿtiÚ hªdshake: %s", 
”r
);

1844 
	`sdsä“
(
”r
);

1845 
”rÜ
;

1846 
	}
}

1848 
	$cÚÃùW™hMa¡”
() {

1849 
fd
;

1851 
fd
 = 
	`ª‘TıNÚBlockBe¡EffÜtBšdCÚÃù
(
NULL
,

1852 
£rv”
.
ma¡”ho¡
,£rv”.
ma¡”pÜt
,
NET_FIRST_BIND_ADDR
);

1853 ià(
fd
 == -1) {

1854 
	`£rv”Log
(
LL_WARNING
,"Unableo connecto MASTER: %s",

1855 
	`¡»¼Ü
(
”ºo
));

1856  
C_ERR
;

1859 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
,
fd
,
AE_READABLE
|
AE_WRITABLE
,
syncW™hMa¡”
,
NULL
) ==

1860 
AE_ERR
)

1862 
	`şo£
(
fd
);

1863 
	`£rv”Log
(
LL_WARNING
,"Can't create„eadableƒvent for SYNC");

1864  
C_ERR
;

1867 
£rv”
.
»¶_Œªsãr_Ï¡io
 = s”v”.
unixtime
;

1868 
£rv”
.
»¶_Œªsãr_s
 = 
fd
;

1869 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_CONNECTING
;

1870  
C_OK
;

1871 
	}
}

1877 
	$undoCÚÃùW™hMa¡”
() {

1878 
fd
 = 
£rv”
.
»¶_Œªsãr_s
;

1880 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
fd
,
AE_READABLE
|
AE_WRITABLE
);

1881 
	`şo£
(
fd
);

1882 
£rv”
.
»¶_Œªsãr_s
 = -1;

1883 
	}
}

1888 
	$»¶iÿtiÚAbÜtSyncT¿nsãr
() {

1889 
	`£rv”As£¹
(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_TRANSFER
);

1890 
	`undoCÚÃùW™hMa¡”
();

1891 
	`şo£
(
£rv”
.
»¶_Œªsãr_fd
);

1892 
	`uÆšk
(
£rv”
.
»¶_Œªsãr_tmpfe
);

1893 
	`zä“
(
£rv”
.
»¶_Œªsãr_tmpfe
);

1894 
	}
}

1904 
	$ÿnûlR•liÿtiÚHªdshake
() {

1905 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_TRANSFER
) {

1906 
	`»¶iÿtiÚAbÜtSyncT¿nsãr
();

1907 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_CONNECT
;

1908 } ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_CONNECTING
 ||

1909 
	`¦aveIsInHªdshakeS‹
())

1911 
	`undoCÚÃùW™hMa¡”
();

1912 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_CONNECT
;

1917 
	}
}

1920 
	$»¶iÿtiÚS‘Ma¡”
(*

, 
pÜt
) {

1921 
was_ma¡”
 = 
£rv”
.
ma¡”ho¡
 =ğ
NULL
;

1923 
	`sdsä“
(
£rv”
.
ma¡”ho¡
);

1924 
£rv”
.
ma¡”ho¡
 = 
	`sd¢ew
(

);

1925 
£rv”
.
ma¡”pÜt
 = 
pÜt
;

1926 ià(
£rv”
.
ma¡”
) {

1927 
	`ä“Cl›Á
(
£rv”
.
ma¡”
);

1929 
	`discÚÃùAÎBlockedCl›Ás
();

1933 
	`discÚÃùSÏves
();

1934 
	`ÿnûlR•liÿtiÚHªdshake
();

1937 ià(
was_ma¡”
è
	`»¶iÿtiÚCacheMa¡”UsšgMy£lf
();

1938 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_CONNECT
;

1939 
£rv”
.
»¶_down_sšû
 = 0;

1940 
	}
}

1943 
	$»¶iÿtiÚUn£tMa¡”
() {

1944 ià(
£rv”
.
ma¡”ho¡
 =ğ
NULL
) ;

1945 
	`sdsä“
(
£rv”
.
ma¡”ho¡
);

1946 
£rv”
.
ma¡”ho¡
 = 
NULL
;

1951 
	`shiáR•liÿtiÚId
();

1952 ià(
£rv”
.
ma¡”
è
	`ä“Cl›Á
(server.master);

1953 
	`»¶iÿtiÚDisÿrdCachedMa¡”
();

1954 
	`ÿnûlR•liÿtiÚHªdshake
();

1959 
	`discÚÃùSÏves
();

1960 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_NONE
;

1966 
£rv”
.
¦ave£ldb
 = -1;

1967 
	}
}

1971 
	$»¶iÿtiÚHªdËMa¡”DiscÚÃùiÚ
() {

1972 
£rv”
.
ma¡”
 = 
NULL
;

1973 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_CONNECT
;

1974 
£rv”
.
»¶_down_sšû
 = s”v”.
unixtime
;

1978 
	}
}

1980 
	$¦aveofCommªd
(
ş›Á
 *
c
) {

1983 ià(
£rv”
.
şu¡”_’abËd
) {

1984 
	`addR•lyE¼Ü
(
c
,"SLAVEOF‚ot‡llowed in cluster mode.");

1990 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"no") &&

1991 !
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"one")) {

1992 ià(
£rv”
.
ma¡”ho¡
) {

1993 
	`»¶iÿtiÚUn£tMa¡”
();

1994 
sds
 
ş›Á
 = 
	`ÿtCl›ÁInfoSŒšg
(
	`sd£m±y
(),
c
);

1995 
	`£rv”Log
(
LL_NOTICE
,"MASTER MODEƒnabled (user„equest from '%s')",

1996 
ş›Á
);

1997 
	`sdsä“
(
ş›Á
);

2000 
pÜt
;

2002 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
pÜt
, 
NULL
è!ğ
C_OK
))

2006 ià(
£rv”
.
ma¡”ho¡
 && !
	`¡rÿ£cmp
(£rv”.ma¡”ho¡,
c
->
¬gv
[1]->
±r
)

2007 && 
£rv”
.
ma¡”pÜt
 =ğ
pÜt
) {

2008 
	`£rv”Log
(
LL_NOTICE
,"SLAVE OF would„esult into synchronization withhe master we‡re‡lready connected with. No operation…erformed.");

2009 
	`addR•lySds
(
c
,
	`sd¢ew
("+OK Already connectedo specified master\r\n"));

2014 
	`»¶iÿtiÚS‘Ma¡”
(
c
->
¬gv
[1]->
±r
, 
pÜt
);

2015 
sds
 
ş›Á
 = 
	`ÿtCl›ÁInfoSŒšg
(
	`sd£m±y
(),
c
);

2016 
	`£rv”Log
(
LL_NOTICE
,"SLAVE OF %s:%dƒnabled (user„equest from '%s')",

2017 
£rv”
.
ma¡”ho¡
, s”v”.
ma¡”pÜt
, 
ş›Á
);

2018 
	`sdsä“
(
ş›Á
);

2020 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

2021 
	}
}

2026 
	$rŞeCommªd
(
ş›Á
 *
c
) {

2027 ià(
£rv”
.
ma¡”ho¡
 =ğ
NULL
) {

2028 
li¡I‹r
 
li
;

2029 
li¡Node
 *
Ê
;

2030 *
mbcouÁ
;

2031 
¦aves
 = 0;

2033 
	`addR•lyMuÉiBulkL’
(
c
,3);

2034 
	`addR•lyBulkCBufãr
(
c
,"master",6);

2035 
	`addR•lyLÚgLÚg
(
c
,
£rv”
.
ma¡”_»¶_off£t
);

2036 
mbcouÁ
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2037 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

2038 (
Ê
 = 
	`li¡Next
(&
li
))) {

2039 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

2040 

[
NET_IP_STR_LEN
], *
¦ave
 = 
¦ave
->
¦ave_
;

2042 ià(
¦ave
[0] == '\0') {

2043 ià(
	`ª‘P“rToSŒšg
(
¦ave
->
fd
,

,(),
NULL
) == -1)

2045 
¦ave
 = 

;

2047 ià(
¦ave
->
»¶¡©e
 !ğ
SLAVE_STATE_ONLINE
) ;

2048 
	`addR•lyMuÉiBulkL’
(
c
,3);

2049 
	`addR•lyBulkCSŒšg
(
c
,
¦ave
);

2050 
	`addR•lyBulkLÚgLÚg
(
c
,
¦ave
->
¦ave_li¡’šg_pÜt
);

2051 
	`addR•lyBulkLÚgLÚg
(
c
,
¦ave
->
»¶_ack_off
);

2052 
¦aves
++;

2054 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
mbcouÁ
,
¦aves
);

2056 *
¦ave¡©e
 = 
NULL
;

2058 
	`addR•lyMuÉiBulkL’
(
c
,5);

2059 
	`addR•lyBulkCBufãr
(
c
,"slave",5);

2060 
	`addR•lyBulkCSŒšg
(
c
,
£rv”
.
ma¡”ho¡
);

2061 
	`addR•lyLÚgLÚg
(
c
,
£rv”
.
ma¡”pÜt
);

2062 ià(
	`¦aveIsInHªdshakeS‹
()) {

2063 
¦ave¡©e
 = "handshake";

2065 
£rv”
.
»¶_¡©e
) {

2066 
REPL_STATE_NONE
: 
¦ave¡©e
 = "none"; ;

2067 
REPL_STATE_CONNECT
: 
¦ave¡©e
 = "connect"; ;

2068 
REPL_STATE_CONNECTING
: 
¦ave¡©e
 = "connecting"; ;

2069 
REPL_STATE_TRANSFER
: 
¦ave¡©e
 = "sync"; ;

2070 
REPL_STATE_CONNECTED
: 
¦ave¡©e
 = "connected"; ;

2071 : 
¦ave¡©e
 = "unknown"; ;

2074 
	`addR•lyBulkCSŒšg
(
c
,
¦ave¡©e
);

2075 
	`addR•lyLÚgLÚg
(
c
,
£rv”
.
ma¡”
 ? s”v”.ma¡”->
»¶off
 : -1);

2077 
	}
}

2082 
	$»¶iÿtiÚS’dAck
() {

2083 
ş›Á
 *
c
 = 
£rv”
.
ma¡”
;

2085 ià(
c
 !ğ
NULL
) {

2086 
c
->
æags
 |ğ
CLIENT_MASTER_FORCE_REPLY
;

2087 
	`addR•lyMuÉiBulkL’
(
c
,3);

2088 
	`addR•lyBulkCSŒšg
(
c
,"REPLCONF");

2089 
	`addR•lyBulkCSŒšg
(
c
,"ACK");

2090 
	`addR•lyBulkLÚgLÚg
(
c
,c->
»¶off
);

2091 
c
->
æags
 &ğ~
CLIENT_MASTER_FORCE_REPLY
;

2093 
	}
}

2115 
	$»¶iÿtiÚCacheMa¡”
(
ş›Á
 *
c
) {

2116 
	`£rv”As£¹
(
£rv”
.
ma¡”
 !ğ
NULL
 && s”v”.
ÿched_ma¡”
 == NULL);

2117 
	`£rv”Log
(
LL_NOTICE
,"Cachinghe disconnected master state.");

2120 
	`uÆškCl›Á
(
c
);

2126 
	`sdsş—r
(
£rv”
.
ma¡”
->
qu”ybuf
);

2127 
	`sdsş—r
(
£rv”
.
ma¡”
->
³ndšg_qu”ybuf
);

2128 
£rv”
.
ma¡”
->
»ad_»¶off
 = s”v”.ma¡”->
»¶off
;

2129 ià(
c
->
æags
 & 
CLIENT_MULTI
è
	`disÿrdT¿n§ùiÚ
(c);

2130 
	`li¡Em±y
(
c
->
»¶y
);

2131 
c
->
buåos
 = 0;

2132 
	`»£tCl›Á
(
c
);

2136 
£rv”
.
ÿched_ma¡”
 = s”v”.
ma¡”
;

2139 ià(
c
->
³”id
) {

2140 
	`sdsä“
(
c
->
³”id
);

2141 
c
->
³”id
 = 
NULL
;

2147 
	`»¶iÿtiÚHªdËMa¡”DiscÚÃùiÚ
();

2148 
	}
}

2159 
	$»¶iÿtiÚCacheMa¡”UsšgMy£lf
() {

2162 
£rv”
.
ma¡”_š™Ÿl_off£t
 = s”v”.
ma¡”_»¶_off£t
;

2163 
	`»¶iÿtiÚC»©eMa¡”Cl›Á
(-1,-1);

2166 
	`memıy
(
£rv”
.
ma¡”
->
»¶id
, server.replid, (server.replid));

2169 
	`uÆškCl›Á
(
£rv”
.
ma¡”
);

2170 
£rv”
.
ÿched_ma¡”
 = s”v”.
ma¡”
;

2171 
£rv”
.
ma¡”
 = 
NULL
;

2172 
	`£rv”Log
(
LL_NOTICE
,"Beforeurning into‡ slave, using my master…arameterso synthesize‡ cached master: I may be‡bleo synchronize withhe‚ew master with just‡…artialransfer.");

2173 
	}
}

2177 
	$»¶iÿtiÚDisÿrdCachedMa¡”
() {

2178 ià(
£rv”
.
ÿched_ma¡”
 =ğ
NULL
) ;

2180 
	`£rv”Log
(
LL_NOTICE
,"Discarding…reviously cached master state.");

2181 
£rv”
.
ÿched_ma¡”
->
æags
 &ğ~
CLIENT_MASTER
;

2182 
	`ä“Cl›Á
(
£rv”
.
ÿched_ma¡”
);

2183 
£rv”
.
ÿched_ma¡”
 = 
NULL
;

2184 
	}
}

2192 
	$»¶iÿtiÚResu¼eùCachedMa¡”
(
Ãwfd
) {

2193 
£rv”
.
ma¡”
 = s”v”.
ÿched_ma¡”
;

2194 
£rv”
.
ÿched_ma¡”
 = 
NULL
;

2195 
£rv”
.
ma¡”
->
fd
 = 
Ãwfd
;

2196 
£rv”
.
ma¡”
->
æags
 &ğ~(
CLIENT_CLOSE_AFTER_REPLY
|
CLIENT_CLOSE_ASAP
);

2197 
£rv”
.
ma¡”
->
auth’tiÿ‹d
 = 1;

2198 
£rv”
.
ma¡”
->
Ï¡š‹¿ùiÚ
 = s”v”.
unixtime
;

2199 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_CONNECTED
;

2202 
	`li¡AddNodeTa
(
£rv”
.
ş›Ás
,£rv”.
ma¡”
);

2203 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
, 
Ãwfd
, 
AE_READABLE
,

2204 
»adQu”yFromCl›Á
, 
£rv”
.
ma¡”
)) {

2205 
	`£rv”Log
(
LL_WARNING
,"E¼Ü„esu¼eùšghÿched ma¡”, impossibËØaddh»adabË hªdËr: %s", 
	`¡»¼Ü
(
”ºo
));

2206 
	`ä“Cl›ÁAsync
(
£rv”
.
ma¡”
);

2211 ià(
	`ş›ÁHasP’dšgR•l›s
(
£rv”
.
ma¡”
)) {

2212 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
, 
Ãwfd
, 
AE_WRITABLE
,

2213 
£ndR•lyToCl›Á
, 
£rv”
.
ma¡”
)) {

2214 
	`£rv”Log
(
LL_WARNING
,"E¼Ü„esu¼eùšghÿched ma¡”, impossibËØaddhwr™abË hªdËr: %s", 
	`¡»¼Ü
(
”ºo
));

2215 
	`ä“Cl›ÁAsync
(
£rv”
.
ma¡”
);

2218 
	}
}

2225 
	$»äeshGoodSÏvesCouÁ
() {

2226 
li¡I‹r
 
li
;

2227 
li¡Node
 *
Ê
;

2228 
good
 = 0;

2230 ià(!
£rv”
.
»¶_mš_¦aves_to_wr™e
 ||

2231 !
£rv”
.
»¶_mš_¦aves_max_Ïg
) ;

2233 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

2234 (
Ê
 = 
	`li¡Next
(&
li
))) {

2235 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

2236 
time_t
 
Ïg
 = 
£rv”
.
unixtime
 - 
¦ave
->
»¶_ack_time
;

2238 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_ONLINE
 &&

2239 
Ïg
 <ğ
£rv”
.
»¶_mš_¦aves_max_Ïg
è
good
++;

2241 
£rv”
.
»¶_good_¦aves_couÁ
 = 
good
;

2242 
	}
}

2276 
	$»¶iÿtiÚSütCacheIn™
() {

2277 
£rv”
.
»¶_sütÿche_size
 = 10000;

2278 
£rv”
.
»¶_sütÿche_diù
 = 
	`diùC»©e
(&
»¶SütCacheDiùTy³
,
NULL
);

2279 
£rv”
.
»¶_sütÿche_fifo
 = 
	`li¡C»©e
();

2280 
	}
}

2293 
	$»¶iÿtiÚSütCacheFlush
() {

2294 
	`diùEm±y
(
£rv”
.
»¶_sütÿche_diù
,
NULL
);

2295 
	`li¡R–—£
(
£rv”
.
»¶_sütÿche_fifo
);

2296 
£rv”
.
»¶_sütÿche_fifo
 = 
	`li¡C»©e
();

2297 
	}
}

2301 
	$»¶iÿtiÚSütCacheAdd
(
sds
 
sha1
) {

2302 
»tv®
;

2303 
sds
 
key
 = 
	`sdsdup
(
sha1
);

2306 ià(
	`li¡L’gth
(
£rv”
.
»¶_sütÿche_fifo
è=ğ£rv”.
»¶_sütÿche_size
)

2308 
li¡Node
 *
Ê
 = 
	`li¡La¡
(
£rv”
.
»¶_sütÿche_fifo
);

2309 
sds
 
Şde¡
 = 
	`li¡NodeV®ue
(
Ê
);

2311 
»tv®
 = 
	`diùD–‘e
(
£rv”
.
»¶_sütÿche_diù
,
Şde¡
);

2312 
	`£rv”As£¹
(
»tv®
 =ğ
DICT_OK
);

2313 
	`li¡D–Node
(
£rv”
.
»¶_sütÿche_fifo
,
Ê
);

2317 
»tv®
 = 
	`diùAdd
(
£rv”
.
»¶_sütÿche_diù
,
key
,
NULL
);

2318 
	`li¡AddNodeH—d
(
£rv”
.
»¶_sütÿche_fifo
,
key
);

2319 
	`£rv”As£¹
(
»tv®
 =ğ
DICT_OK
);

2320 
	}
}

2324 
	$»¶iÿtiÚSütCacheExi¡s
(
sds
 
sha1
) {

2325  
	`diùFšd
(
£rv”
.
»¶_sütÿche_diù
,
sha1
è!ğ
NULL
;

2326 
	}
}

2358 
	$»¶iÿtiÚReque¡AckFromSÏves
() {

2359 
£rv”
.
g‘_ack_äom_¦aves
 = 1;

2360 
	}
}

2364 
	$»¶iÿtiÚCouÁAcksByOff£t
(
off£t
) {

2365 
li¡I‹r
 
li
;

2366 
li¡Node
 *
Ê
;

2367 
couÁ
 = 0;

2369 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

2370 (
Ê
 = 
	`li¡Next
(&
li
))) {

2371 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

2373 ià(
¦ave
->
»¶¡©e
 !ğ
SLAVE_STATE_ONLINE
) ;

2374 ià(
¦ave
->
»¶_ack_off
 >ğ
off£t
è
couÁ
++;

2376  
couÁ
;

2377 
	}
}

2381 
	$wa™Commªd
(
ş›Á
 *
c
) {

2382 
m¡ime_t
 
timeout
;

2383 
num»¶iÿs
, 
ack»¶iÿs
;

2384 
off£t
 = 
c
->
woff
;

2386 ià(
£rv”
.
ma¡”ho¡
) {

2387 
	`addR•lyE¼Ü
(
c
,"WAIT cannot be used with slave instances. Please‡lso‚otehat since Redis 4.0 if‡ slave is configuredo be writable (which is‚othe default) writeso slaves‡re just†ocal‡nd‡re‚ot…ropagated.");

2392 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[1],&
num»¶iÿs
,
NULL
è!ğ
C_OK
)

2394 ià(
	`g‘TimeoutFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
timeout
,
UNIT_MILLISECONDS
)

2395 !ğ
C_OK
) ;

2398 
ack»¶iÿs
 = 
	`»¶iÿtiÚCouÁAcksByOff£t
(
c
->
woff
);

2399 ià(
ack»¶iÿs
 >ğ
num»¶iÿs
 || 
c
->
æags
 & 
CLIENT_MULTI
) {

2400 
	`addR•lyLÚgLÚg
(
c
,
ack»¶iÿs
);

2406 
c
->
bpİ
.
timeout
 =imeout;

2407 
c
->
bpİ
.
»¶off£t
 = 
off£t
;

2408 
c
->
bpİ
.
num»¶iÿs
 =‚umreplicas;

2409 
	`li¡AddNodeTa
(
£rv”
.
ş›Ás_wa™šg_acks
,
c
);

2410 
	`blockCl›Á
(
c
,
BLOCKED_WAIT
);

2414 
	`»¶iÿtiÚReque¡AckFromSÏves
();

2415 
	}
}

2421 
	$unblockCl›ÁWa™šgR•liÿs
(
ş›Á
 *
c
) {

2422 
li¡Node
 *
Ê
 = 
	`li¡S—rchKey
(
£rv”
.
ş›Ás_wa™šg_acks
,
c
);

2423 
	`£rv”As£¹
(
Ê
 !ğ
NULL
);

2424 
	`li¡D–Node
(
£rv”
.
ş›Ás_wa™šg_acks
,
Ê
);

2425 
	}
}

2429 
	$´oûssCl›ÁsWa™šgR•liÿs
() {

2430 
Ï¡_off£t
 = 0;

2431 
Ï¡_num»¶iÿs
 = 0;

2433 
li¡I‹r
 
li
;

2434 
li¡Node
 *
Ê
;

2436 
	`li¡Rewšd
(
£rv”
.
ş›Ás_wa™šg_acks
,&
li
);

2437 (
Ê
 = 
	`li¡Next
(&
li
))) {

2438 
ş›Á
 *
c
 = 
Ê
->
v®ue
;

2444 ià(
Ï¡_off£t
 &&†a¡_off£ˆ> 
c
->
bpİ
.
»¶off£t
 &&

2445 
Ï¡_num»¶iÿs
 > 
c
->
bpİ
.
num»¶iÿs
)

2447 
	`unblockCl›Á
(
c
);

2448 
	`addR•lyLÚgLÚg
(
c
,
Ï¡_num»¶iÿs
);

2450 
num»¶iÿs
 = 
	`»¶iÿtiÚCouÁAcksByOff£t
(
c
->
bpİ
.
»¶off£t
);

2452 ià(
num»¶iÿs
 >ğ
c
->
bpİ
.numreplicas) {

2453 
Ï¡_off£t
 = 
c
->
bpİ
.
»¶off£t
;

2454 
Ï¡_num»¶iÿs
 = 
num»¶iÿs
;

2455 
	`unblockCl›Á
(
c
);

2456 
	`addR•lyLÚgLÚg
(
c
,
num»¶iÿs
);

2460 
	}
}

2464 
	$»¶iÿtiÚG‘SÏveOff£t
() {

2465 
off£t
 = 0;

2467 ià(
£rv”
.
ma¡”ho¡
 !ğ
NULL
) {

2468 ià(
£rv”
.
ma¡”
) {

2469 
off£t
 = 
£rv”
.
ma¡”
->
»¶off
;

2470 } ià(
£rv”
.
ÿched_ma¡”
) {

2471 
off£t
 = 
£rv”
.
ÿched_ma¡”
->
»¶off
;

2478 ià(
off£t
 < 0) offset = 0;

2479  
off£t
;

2480 
	}
}

2485 
	$»¶iÿtiÚCrÚ
() {

2486 
»¶iÿtiÚ_üÚ_loİs
 = 0;

2489 ià(
£rv”
.
ma¡”ho¡
 &&

2490 (
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_CONNECTING
 ||

2491 
	`¦aveIsInHªdshakeS‹
()) &&

2492 (
	`time
(
NULL
)-
£rv”
.
»¶_Œªsãr_Ï¡io
è> s”v”.
»¶_timeout
)

2494 
	`£rv”Log
(
LL_WARNING
,"Timeout connectingohe MASTER...");

2495 
	`ÿnûlR•liÿtiÚHªdshake
();

2499 ià(
£rv”
.
ma¡”ho¡
 && s”v”.
»¶_¡©e
 =ğ
REPL_STATE_TRANSFER
 &&

2500 (
	`time
(
NULL
)-
£rv”
.
»¶_Œªsãr_Ï¡io
è> s”v”.
»¶_timeout
)

2502 
	`£rv”Log
(
LL_WARNING
,"Timeout„eceiving bulk data from MASTER... Ifhe…roblem…ersistsryo sethe 'repl-timeout'…arameter in„edis.confo‡†arger value.");

2503 
	`ÿnûlR•liÿtiÚHªdshake
();

2507 ià(
£rv”
.
ma¡”ho¡
 && s”v”.
»¶_¡©e
 =ğ
REPL_STATE_CONNECTED
 &&

2508 (
	`time
(
NULL
)-
£rv”
.
ma¡”
->
Ï¡š‹¿ùiÚ
è> s”v”.
»¶_timeout
)

2510 
	`£rv”Log
(
LL_WARNING
,"MASTERimeout:‚o data‚or PING„eceived...");

2511 
	`ä“Cl›Á
(
£rv”
.
ma¡”
);

2515 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_CONNECT
) {

2516 
	`£rv”Log
(
LL_NOTICE
,"Connectingo MASTER %s:%d",

2517 
£rv”
.
ma¡”ho¡
, s”v”.
ma¡”pÜt
);

2518 ià(
	`cÚÃùW™hMa¡”
(è=ğ
C_OK
) {

2519 
	`£rv”Log
(
LL_NOTICE
,"MASTER <-> SLAVE sync started");

2526 ià(
£rv”
.
ma¡”ho¡
 && s”v”.
ma¡”
 &&

2527 !(
£rv”
.
ma¡”
->
æags
 & 
CLIENT_PRE_PSYNC
))

2528 
	`»¶iÿtiÚS’dAck
();

2534 
li¡I‹r
 
li
;

2535 
li¡Node
 *
Ê
;

2536 
robj
 *
pšg_¬gv
[1];

2539 ià((
»¶iÿtiÚ_üÚ_loİs
 % 
£rv”
.
»¶_pšg_¦ave_³riod
) == 0 &&

2540 
	`li¡L’gth
(
£rv”
.
¦aves
))

2542 
pšg_¬gv
[0] = 
	`ü—‹SŒšgObjeù
("PING",4);

2543 
	`»¶iÿtiÚF“dSÏves
(
£rv”
.
¦aves
, s”v”.
¦ave£ldb
,

2544 
pšg_¬gv
, 1);

2545 
	`deüRefCouÁ
(
pšg_¬gv
[0]);

2562 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

2563 (
Ê
 = 
	`li¡Next
(&
li
))) {

2564 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

2566 
is_´esync
 =

2567 (
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_START
 ||

2568 (
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_END
 &&

2569 
£rv”
.
rdb_chd_ty³
 !ğ
RDB_CHILD_TYPE_SOCKET
));

2571 ià(
is_´esync
) {

2572 ià(
	`wr™e
(
¦ave
->
fd
, "\n", 1) == -1) {

2579 ià(
	`li¡L’gth
(
£rv”
.
¦aves
)) {

2580 
li¡I‹r
 
li
;

2581 
li¡Node
 *
Ê
;

2583 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

2584 (
Ê
 = 
	`li¡Next
(&
li
))) {

2585 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

2587 ià(
¦ave
->
»¶¡©e
 !ğ
SLAVE_STATE_ONLINE
) ;

2588 ià(
¦ave
->
æags
 & 
CLIENT_PRE_PSYNC
) ;

2589 ià((
£rv”
.
unixtime
 - 
¦ave
->
»¶_ack_time
è> s”v”.
»¶_timeout
)

2591 
	`£rv”Log
(
LL_WARNING
, "Disconnectingimedout slave: %s",

2592 
	`»¶iÿtiÚG‘SÏveName
(
¦ave
));

2593 
	`ä“Cl›Á
(
¦ave
);

2604 ià(
	`li¡L’gth
(
£rv”
.
¦aves
è=ğ0 && s”v”.
»¶_backlog_time_lim™
 &&

2605 
£rv”
.
»¶_backlog
 && s”v”.
ma¡”ho¡
 =ğ
NULL
)

2607 
time_t
 
idË
 = 
£rv”
.
unixtime
 - s”v”.
»¶_no_¦aves_sšû
;

2609 ià(
idË
 > 
£rv”
.
»¶_backlog_time_lim™
) {

2610 
	`ä“R•liÿtiÚBacklog
();

2611 
	`£rv”Log
(
LL_NOTICE
,

2614 (è
£rv”
.
»¶_backlog_time_lim™
);

2621 ià(
	`li¡L’gth
(
£rv”
.
¦aves
) == 0 &&

2622 
£rv”
.
aof_¡©e
 =ğ
AOF_OFF
 &&

2623 
	`li¡L’gth
(
£rv”
.
»¶_sütÿche_fifo
) != 0)

2625 
	`»¶iÿtiÚSütCacheFlush
();

2634 ià(
£rv”
.
rdb_chd_pid
 =ğ-1 && s”v”.
aof_chd_pid
 == -1) {

2635 
time_t
 
idË
, 
max_idË
 = 0;

2636 
¦aves_wa™šg
 = 0;

2637 
mšÿ·
 = -1;

2638 
li¡Node
 *
Ê
;

2639 
li¡I‹r
 
li
;

2641 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

2642 (
Ê
 = 
	`li¡Next
(&
li
))) {

2643 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

2644 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_START
) {

2645 
idË
 = 
£rv”
.
unixtime
 - 
¦ave
->
Ï¡š‹¿ùiÚ
;

2646 ià(
idË
 > 
max_idË
) max_idle = idle;

2647 
¦aves_wa™šg
++;

2648 
mšÿ·
 = (mšÿ· =ğ-1è? 
¦ave
->
¦ave_ÿ·
 :

2649 (
mšÿ·
 & 
¦ave
->
¦ave_ÿ·
);

2653 ià(
¦aves_wa™šg
 &&

2654 (!
£rv”
.
»¶_diskËss_sync
 ||

2655 
max_idË
 > 
£rv”
.
»¶_diskËss_sync_d–ay
))

2660 
	`¡¬tBg§veFÜR•liÿtiÚ
(
mšÿ·
);

2665 
	`»äeshGoodSÏvesCouÁ
();

2666 
»¶iÿtiÚ_üÚ_loİs
++;

2667 
	}
}

	@rio.c

48 
	~"fmaüos.h
"

49 
	~<¡ršg.h
>

50 
	~<¡dio.h
>

51 
	~<uni¡d.h
>

52 
	~"rio.h
"

53 
	~"ut.h
"

54 
	~"üc64.h
"

55 
	~"cÚfig.h
"

56 
	~"£rv”.h
"

61 
size_t
 
	$rioBufãrWr™e
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

62 
r
->
io
.
bufãr
.
±r
 = 
	`sdsÿ’
Ô->io.bufãr.±r,(*)
buf
,
Ën
);

63 
r
->
io
.
bufãr
.
pos
 +ğ
Ën
;

65 
	}
}

68 
size_t
 
	$rioBufãrR—d
(
rio
 *
r
, *
buf
, 
size_t
 
Ën
) {

69 ià(
	`sd¦’
(
r
->
io
.
bufãr
.
±r
)-r->io.bufãr.
pos
 < 
Ën
)

71 
	`memıy
(
buf
,
r
->
io
.
bufãr
.
±r
+r->io.bufãr.
pos
,
Ën
);

72 
r
->
io
.
bufãr
.
pos
 +ğ
Ën
;

74 
	}
}

77 
off_t
 
	$rioBufãrT–l
(
rio
 *
r
) {

78  
r
->
io
.
bufãr
.
pos
;

79 
	}
}

83 
	$rioBufãrFlush
(
rio
 *
r
) {

84 
	`UNUSED
(
r
);

86 
	}
}

88 cÚ¡ 
rio
 
	grioBufãrIO
 = {

89 
rioBufãrR—d
,

90 
rioBufãrWr™e
,

91 
rioBufãrT–l
,

92 
rioBufãrFlush
,

93 
NULL
,

97 { { 
NULL
, 0 } }

100 
	$rioIn™W™hBufãr
(
rio
 *
r
, 
sds
 
s
) {

101 *
r
 = 
rioBufãrIO
;

102 
r
->
io
.
bufãr
.
±r
 = 
s
;

103 
r
->
io
.
bufãr
.
pos
 = 0;

104 
	}
}

109 
size_t
 
	$rioFeWr™e
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

110 
size_t
 
»tv®
;

112 
»tv®
 = 
	`fwr™e
(
buf
,
Ën
,1,
r
->
io
.
fe
.
å
);

113 
r
->
io
.
fe
.
bufã»d
 +ğ
Ën
;

115 ià(
r
->
io
.
fe
.
autosync
 &&

116 
r
->
io
.
fe
.
bufã»d
 >ğr->io.fe.
autosync
)

118 
	`fæush
(
r
->
io
.
fe
.
å
);

119 
	`aof_fsync
(
	`f’o
(
r
->
io
.
fe
.
å
));

120 
r
->
io
.
fe
.
bufã»d
 = 0;

122  
»tv®
;

123 
	}
}

126 
size_t
 
	$rioFeR—d
(
rio
 *
r
, *
buf
, 
size_t
 
Ën
) {

127  
	`ä—d
(
buf
,
Ën
,1,
r
->
io
.
fe
.
å
);

128 
	}
}

131 
off_t
 
	$rioFeT–l
(
rio
 *
r
) {

132  
	`á–lo
(
r
->
io
.
fe
.
å
);

133 
	}
}

137 
	$rioFeFlush
(
rio
 *
r
) {

138  (
	`fæush
(
r
->
io
.
fe
.
å
) == 0) ? 1 : 0;

139 
	}
}

141 cÚ¡ 
rio
 
	grioFeIO
 = {

142 
rioFeR—d
,

143 
rioFeWr™e
,

144 
rioFeT–l
,

145 
rioFeFlush
,

146 
NULL
,

150 { { 
NULL
, 0 } }

153 
	$rioIn™W™hFe
(
rio
 *
r
, 
FILE
 *
å
) {

154 *
r
 = 
rioFeIO
;

155 
r
->
io
.
fe
.
å
 = fp;

156 
r
->
io
.
fe
.
bufã»d
 = 0;

157 
r
->
io
.
fe
.
autosync
 = 0;

158 
	}
}

169 
size_t
 
	$rioFd£tWr™e
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

170 
ssize_t
 
»tv®
;

171 
j
;

172 *
p
 = (*è
buf
;

173 
doæush
 = (
buf
 =ğ
NULL
 && 
Ën
 == 0);

177 ià(
Ën
) {

178 
r
->
io
.
fd£t
.
buf
 = 
	`sdsÿ’
Ô->io.fd£t.buf,buf,
Ën
);

179 
Ën
 = 0;

180 ià(
	`sd¦’
(
r
->
io
.
fd£t
.
buf
è> 
PROTO_IOBUF_LEN
è
doæush
 = 1;

183 ià(
doæush
) {

184 
p
 = (*è
r
->
io
.
fd£t
.
buf
;

185 
Ën
 = 
	`sd¦’
(
r
->
io
.
fd£t
.
buf
);

191 
Ën
) {

192 
size_t
 
couÁ
 = 
Ën
 < 1024 ?†en : 1024;

193 
brok’
 = 0;

194 
j
 = 0; j < 
r
->
io
.
fd£t
.
numfds
; j++) {

195 ià(
r
->
io
.
fd£t
.
¡©e
[
j
] != 0) {

197 
brok’
++;

203 
size_t
 
nwr™‹n
 = 0;

204 
nwr™‹n
 !ğ
couÁ
) {

205 
»tv®
 = 
	`wr™e
(
r
->
io
.
fd£t
.
fds
[
j
],
p
+
nwr™‹n
,
couÁ
-nwritten);

206 ià(
»tv®
 <= 0) {

211 ià(
»tv®
 =ğ-1 && 
”ºo
 =ğ
EWOULDBLOCK
è”ºØğ
ETIMEDOUT
;

214 
nwr™‹n
 +ğ
»tv®
;

217 ià(
nwr™‹n
 !ğ
couÁ
) {

219 
r
->
io
.
fd£t
.
¡©e
[
j
] = 
”ºo
;

220 ià(
r
->
io
.
fd£t
.
¡©e
[
j
] =ğ0èr->io.fd£t.¡©e[j] = 
EIO
;

223 ià(
brok’
 =ğ
r
->
io
.
fd£t
.
numfds
)  0;

224 
p
 +ğ
couÁ
;

225 
Ën
 -ğ
couÁ
;

226 
r
->
io
.
fd£t
.
pos
 +ğ
couÁ
;

229 ià(
doæush
è
	`sdsş—r
(
r
->
io
.
fd£t
.
buf
);

231 
	}
}

234 
size_t
 
	$rioFd£tR—d
(
rio
 *
r
, *
buf
, 
size_t
 
Ën
) {

235 
	`UNUSED
(
r
);

236 
	`UNUSED
(
buf
);

237 
	`UNUSED
(
Ën
);

239 
	}
}

242 
off_t
 
	$rioFd£tT–l
(
rio
 *
r
) {

243  
r
->
io
.
fd£t
.
pos
;

244 
	}
}

248 
	$rioFd£tFlush
(
rio
 *
r
) {

251  
	`rioFd£tWr™e
(
r
,
NULL
,0);

252 
	}
}

254 cÚ¡ 
rio
 
	grioFd£tIO
 = {

255 
rioFd£tR—d
,

256 
rioFd£tWr™e
,

257 
rioFd£tT–l
,

258 
rioFd£tFlush
,

259 
NULL
,

263 { { 
NULL
, 0 } }

266 
	$rioIn™W™hFd£t
(
rio
 *
r
, *
fds
, 
numfds
) {

267 
j
;

269 *
r
 = 
rioFd£tIO
;

270 
r
->
io
.
fd£t
.
fds
 = 
	`zm®loc
(()*
numfds
);

271 
r
->
io
.
fd£t
.
¡©e
 = 
	`zm®loc
(()*
numfds
);

272 
	`memıy
(
r
->
io
.
fd£t
.
fds
,fds,()*
numfds
);

273 
j
 = 0; j < 
numfds
; j++è
r
->
io
.
fd£t
.
¡©e
[j] = 0;

274 
r
->
io
.
fd£t
.
numfds
 =‚umfds;

275 
r
->
io
.
fd£t
.
pos
 = 0;

276 
r
->
io
.
fd£t
.
buf
 = 
	`sd£m±y
();

277 
	}
}

280 
	$rioF»eFd£t
(
rio
 *
r
) {

281 
	`zä“
(
r
->
io
.
fd£t
.
fds
);

282 
	`zä“
(
r
->
io
.
fd£t
.
¡©e
);

283 
	`sdsä“
(
r
->
io
.
fd£t
.
buf
);

284 
	}
}

290 
	$rioG’”icUpd©eChecksum
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

291 
r
->
cksum
 = 
	`üc64
Ô->cksum,
buf
,
Ën
);

292 
	}
}

302 
	$rioS‘AutoSync
(
rio
 *
r
, 
off_t
 
by‹s
) {

303 
	`£rv”As£¹
(
r
->
»ad
 =ğ
rioFeIO
.read);

304 
r
->
io
.
fe
.
autosync
 = 
by‹s
;

305 
	}
}

313 
size_t
 
	$rioWr™eBulkCouÁ
(
rio
 *
r
, 
´efix
, 
couÁ
) {

314 
cbuf
[128];

315 
ş’
;

317 
cbuf
[0] = 
´efix
;

318 
ş’
 = 1+
	`Î2¡ršg
(
cbuf
+1,(cbuf)-1,
couÁ
);

319 
cbuf
[
ş’
++] = '\r';

320 
cbuf
[
ş’
++] = '\n';

321 ià(
	`rioWr™e
(
r
,
cbuf
,
ş’
) == 0)  0;

322  
ş’
;

323 
	}
}

326 
size_t
 
	$rioWr™eBulkSŒšg
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

327 
size_t
 
nwr™‹n
;

329 ià((
nwr™‹n
 = 
	`rioWr™eBulkCouÁ
(
r
,'$',
Ën
)) == 0)  0;

330 ià(
Ën
 > 0 && 
	`rioWr™e
(
r
,
buf
,len) == 0)  0;

331 ià(
	`rioWr™e
(
r
,"\r\n",2) == 0)  0;

332  
nwr™‹n
+
Ën
+2;

333 
	}
}

336 
size_t
 
	$rioWr™eBulkLÚgLÚg
(
rio
 *
r
, 
l
) {

337 
lbuf
[32];

338 
Î’
;

340 
Î’
 = 
	`Î2¡ršg
(
lbuf
,Öbuf),
l
);

341  
	`rioWr™eBulkSŒšg
(
r
,
lbuf
,
Î’
);

342 
	}
}

345 
size_t
 
	$rioWr™eBulkDoubË
(
rio
 *
r
, 
d
) {

346 
dbuf
[128];

347 
dËn
;

349 
dËn
 = 
	`¢´štf
(
dbuf
,(dbuf),"%.17g",
d
);

350  
	`rioWr™eBulkSŒšg
(
r
,
dbuf
,
dËn
);

351 
	}
}

	@rio.h

32 #iâdeà
__REDIS_RIO_H


33 
	#__REDIS_RIO_H


	)

35 
	~<¡dio.h
>

36 
	~<¡dšt.h
>

37 
	~"sds.h
"

39 
	s_rio
 {

43 
size_t
 (*
»ad
)(
	m_rio
 *, *
	mbuf
, size_ˆ
	mËn
);

44 
size_t
 (*
wr™e
)(
	m_rio
 *, cÚ¡ *
	mbuf
, size_ˆ
	mËn
);

45 
off_t
 (*
‹Î
)(
	m_rio
 *);

46 (*
	mæush
)(
	m_rio
 *);

52 (*
	mupd©e_cksum
)(
	m_rio
 *, cÚ¡ *
	mbuf
, 
size_t
 
	mËn
);

55 
ušt64_t
 
	mcksum
;

58 
size_t
 
	m´oûs£d_by‹s
;

61 
size_t
 
	mmax_´oûssšg_chunk
;

67 
sds
 
	m±r
;

68 
off_t
 
	mpos
;

69 } 
	mbufãr
;

72 
FILE
 *
	må
;

73 
off_t
 
	mbufã»d
;

74 
off_t
 
	mautosync
;

75 } 
	mfe
;

78 *
	mfds
;

79 *
	m¡©e
;

80 
	mnumfds
;

81 
off_t
 
	mpos
;

82 
sds
 
	mbuf
;

83 } 
	mfd£t
;

84 } 
	mio
;

87 
_rio
 
	trio
;

93 
šlše
 
size_t
 
	$rioWr™e
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

94 
Ën
) {

95 
size_t
 
by‹s_to_wr™e
 = (
r
->
max_´oûssšg_chunk
 &&„->max_´oûssšg_chunk < 
Ën
) ?„->max_processing_chunk :†en;

96 ià(
r
->
upd©e_cksum
èr->
	`upd©e_cksum
Ô,
buf
,
by‹s_to_wr™e
);

97 ià(
r
->
	`wr™e
Ô,
buf
,
by‹s_to_wr™e
) == 0)

99 
buf
 = (*)buà+ 
by‹s_to_wr™e
;

100 
Ën
 -ğ
by‹s_to_wr™e
;

101 
r
->
´oûs£d_by‹s
 +ğ
by‹s_to_wr™e
;

104 
	}
}

106 
šlše
 
size_t
 
	$rioR—d
(
rio
 *
r
, *
buf
, 
size_t
 
Ën
) {

107 
Ën
) {

108 
size_t
 
by‹s_to_»ad
 = (
r
->
max_´oûssšg_chunk
 &&„->max_´oûssšg_chunk < 
Ën
) ?„->max_processing_chunk :†en;

109 ià(
r
->
	`»ad
Ô,
buf
,
by‹s_to_»ad
) == 0)

111 ià(
r
->
upd©e_cksum
èr->
	`upd©e_cksum
Ô,
buf
,
by‹s_to_»ad
);

112 
buf
 = (*)buà+ 
by‹s_to_»ad
;

113 
Ën
 -ğ
by‹s_to_»ad
;

114 
r
->
´oûs£d_by‹s
 +ğ
by‹s_to_»ad
;

117 
	}
}

119 
šlše
 
off_t
 
	$rioT–l
(
rio
 *
r
) {

120  
r
->
	`‹Î
(r);

121 
	}
}

123 
šlše
 
	$rioFlush
(
rio
 *
r
) {

124  
r
->
	`æush
(r);

125 
	}
}

127 
rioIn™W™hFe
(
rio
 *
r
, 
FILE
 *
å
);

128 
rioIn™W™hBufãr
(
rio
 *
r
, 
sds
 
s
);

129 
rioIn™W™hFd£t
(
rio
 *
r
, *
fds
, 
numfds
);

131 
rioF»eFd£t
(
rio
 *
r
);

133 
size_t
 
rioWr™eBulkCouÁ
(
rio
 *
r
, 
´efix
, 
couÁ
);

134 
size_t
 
rioWr™eBulkSŒšg
(
rio
 *
r
, cÚ¡ *
buf
, size_ˆ
Ën
);

135 
size_t
 
rioWr™eBulkLÚgLÚg
(
rio
 *
r
, 
l
);

136 
size_t
 
rioWr™eBulkDoubË
(
rio
 *
r
, 
d
);

138 
	g»disObjeù
;

139 
rioWr™eBulkObjeù
(
rio
 *
r
, 
»disObjeù
 *
obj
);

141 
rioG’”icUpd©eChecksum
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
);

142 
rioS‘AutoSync
(
rio
 *
r
, 
off_t
 
by‹s
);

	@scripting.c

30 
	~"£rv”.h
"

31 
	~"sha1.h
"

32 
	~"¿nd.h
"

33 
	~"şu¡”.h
"

35 
	~<lua.h
>

36 
	~<Ïuxlib.h
>

37 
	~<lu®ib.h
>

38 
	~<ùy³.h
>

39 
	~<m©h.h
>

41 *
»disPrÙocŞToLuaTy³_IÁ
(
lua_S‹
 *
lua
, *
»¶y
);

42 *
»disPrÙocŞToLuaTy³_Bulk
(
lua_S‹
 *
lua
, *
»¶y
);

43 *
»disPrÙocŞToLuaTy³_Stus
(
lua_S‹
 *
lua
, *
»¶y
);

44 *
»disPrÙocŞToLuaTy³_E¼Ü
(
lua_S‹
 *
lua
, *
»¶y
);

45 *
»disPrÙocŞToLuaTy³_MuÉiBulk
(
lua_S‹
 *
lua
, *
»¶y
);

46 
»dis_m©h_¿ndom
 (
lua_S‹
 *
L
);

47 
»dis_m©h_¿ndom£ed
 (
lua_S‹
 *
L
);

48 
ldbIn™
();

49 
ldbDi§bË
(
ş›Á
 *
c
);

50 
ldbEÇbË
(
ş›Á
 *
c
);

51 
ev®G’”icCommªdW™hDebuggšg
(
ş›Á
 *
c
, 
ev®sha
);

52 
luaLdbLšeHook
(
lua_S‹
 *
lua
, 
lua_Debug
 *
¬
);

53 
ldbLog
(
sds
 
’Œy
);

54 
ldbLogRedisR•ly
(*
»¶y
);

55 
sds
 
ldbC©SckV®ue
(sd 
s
, 
lua_S‹
 *
lua
, 
idx
);

58 
	#LDB_BREAKPOINTS_MAX
 64

	)

59 
	#LDB_MAX_LEN_DEFAULT
 256

	)

60 
	sldbS‹
 {

61 
	mfd
;

62 
	maùive
;

63 
	mfÜked
;

64 
li¡
 *
	mlogs
;

65 
li¡
 *
	mŒaûs
;

66 
li¡
 *
	mchd»n
;

67 
	mbp
[
LDB_BREAKPOINTS_MAX
];

68 
	mbpcouÁ
;

69 
	m¡•
;

70 
	mluabp
;

71 
sds
 *
	m¤c
;

72 
	mlšes
;

73 
	mcu¼’še
;

74 
sds
 
	mcbuf
;

75 
size_t
 
	mmaxËn
;

76 
	mmaxËn_hšt_£Á
;

77 } 
	gldb
;

89 
	$sha1hex
(*
dige¡
, *
süt
, 
size_t
 
Ën
) {

90 
SHA1_CTX
 
ùx
;

91 
hash
[20];

92 *
c£t
 = "0123456789abcdef";

93 
j
;

95 
	`SHA1In™
(&
ùx
);

96 
	`SHA1Upd©e
(&
ùx
,(*)
süt
,
Ën
);

97 
	`SHA1Fš®
(
hash
,&
ùx
);

99 
j
 = 0; j < 20; j++) {

100 
dige¡
[
j
*2] = 
c£t
[((
hash
[j]&0xF0)>>4)];

101 
dige¡
[
j
*2+1] = 
c£t
[(
hash
[j]&0xF)];

103 
dige¡
[40] = '\0';

104 
	}
}

127 *
	$»disPrÙocŞToLuaTy³
(
lua_S‹
 *
lua
, * 
»¶y
) {

128 *
p
 = 
»¶y
;

130 *
p
) {

131 ':': 
p
 = 
	`»disPrÙocŞToLuaTy³_IÁ
(
lua
,
»¶y
); ;

132 '$': 
p
 = 
	`»disPrÙocŞToLuaTy³_Bulk
(
lua
,
»¶y
); ;

133 '+': 
p
 = 
	`»disPrÙocŞToLuaTy³_Stus
(
lua
,
»¶y
); ;

134 '-': 
p
 = 
	`»disPrÙocŞToLuaTy³_E¼Ü
(
lua
,
»¶y
); ;

135 '*': 
p
 = 
	`»disPrÙocŞToLuaTy³_MuÉiBulk
(
lua
,
»¶y
); ;

137  
p
;

138 
	}
}

140 *
	$»disPrÙocŞToLuaTy³_IÁ
(
lua_S‹
 *
lua
, *
»¶y
) {

141 *
p
 = 
	`¡rchr
(
»¶y
+1,'\r');

142 
v®ue
;

144 
	`¡ršg2Î
(
»¶y
+1,
p
-»¶y-1,&
v®ue
);

145 
	`lua_pushnumb”
(
lua
,(
lua_Numb”
)
v®ue
);

146  
p
+2;

147 
	}
}

149 *
	$»disPrÙocŞToLuaTy³_Bulk
(
lua_S‹
 *
lua
, *
»¶y
) {

150 *
p
 = 
	`¡rchr
(
»¶y
+1,'\r');

151 
bulkËn
;

153 
	`¡ršg2Î
(
»¶y
+1,
p
-»¶y-1,&
bulkËn
);

154 ià(
bulkËn
 == -1) {

155 
	`lua_pushboŞ—n
(
lua
,0);

156  
p
+2;

158 
	`lua_pushl¡ršg
(
lua
,
p
+2,
bulkËn
);

159  
p
+2+
bulkËn
+2;

161 
	}
}

163 *
	$»disPrÙocŞToLuaTy³_Stus
(
lua_S‹
 *
lua
, *
»¶y
) {

164 *
p
 = 
	`¡rchr
(
»¶y
+1,'\r');

166 
	`lua_ÃwbË
(
lua
);

167 
	`lua_push¡ršg
(
lua
,"ok");

168 
	`lua_pushl¡ršg
(
lua
,
»¶y
+1,
p
-reply-1);

169 
	`lua_£‰abË
(
lua
,-3);

170  
p
+2;

171 
	}
}

173 *
	$»disPrÙocŞToLuaTy³_E¼Ü
(
lua_S‹
 *
lua
, *
»¶y
) {

174 *
p
 = 
	`¡rchr
(
»¶y
+1,'\r');

176 
	`lua_ÃwbË
(
lua
);

177 
	`lua_push¡ršg
(
lua
,"err");

178 
	`lua_pushl¡ršg
(
lua
,
»¶y
+1,
p
-reply-1);

179 
	`lua_£‰abË
(
lua
,-3);

180  
p
+2;

181 
	}
}

183 *
	$»disPrÙocŞToLuaTy³_MuÉiBulk
(
lua_S‹
 *
lua
, *
»¶y
) {

184 *
p
 = 
	`¡rchr
(
»¶y
+1,'\r');

185 
mbulkËn
;

186 
j
 = 0;

188 
	`¡ršg2Î
(
»¶y
+1,
p
-»¶y-1,&
mbulkËn
);

189 
p
 += 2;

190 ià(
mbulkËn
 == -1) {

191 
	`lua_pushboŞ—n
(
lua
,0);

192  
p
;

194 
	`lua_ÃwbË
(
lua
);

195 
j
 = 0; j < 
mbulkËn
; j++) {

196 
	`lua_pushnumb”
(
lua
,
j
+1);

197 
p
 = 
	`»disPrÙocŞToLuaTy³
(
lua
,p);

198 
	`lua_£‰abË
(
lua
,-3);

200  
p
;

201 
	}
}

208 
	$luaPushE¼Ü
(
lua_S‹
 *
lua
, *
”rÜ
) {

209 
lua_Debug
 
dbg
;

213 ià(
ldb
.
aùive
 &&†db.
¡•
) {

214 
	`ldbLog
(
	`sdsÿrštf
(
	`sd£m±y
(),"<”rÜ> %s",
”rÜ
));

217 
	`lua_ÃwbË
(
lua
);

218 
	`lua_push¡ršg
(
lua
,"err");

221 if(
	`lua_g‘¡ack
(
lua
, 1, &
dbg
è&& 
	`lua_g‘šfo
(lua, "nSl", &dbg)) {

222 
sds
 
msg
 = 
	`sdsÿrštf
(
	`sd£m±y
(), "%s: %d: %s",

223 
dbg
.
sourû
, dbg.
cu¼’še
, 
”rÜ
);

224 
	`lua_push¡ršg
(
lua
, 
msg
);

225 
	`sdsä“
(
msg
);

227 
	`lua_push¡ršg
(
lua
, 
”rÜ
);

229 
	`lua_£‰abË
(
lua
,-3);

230 
	}
}

236 
	$luaRai£E¼Ü
(
lua_S‹
 *
lua
) {

237 
	`lua_push¡ršg
(
lua
,"err");

238 
	`lua_g‘bË
(
lua
,-2);

239  
	`lua_”rÜ
(
lua
);

240 
	}
}

248 
	$luaSÜtA¼ay
(
lua_S‹
 *
lua
) {

250 
	`lua_g‘glob®
(
lua
,"table");

251 
	`lua_push¡ršg
(
lua
,"sort");

252 
	`lua_g‘bË
(
lua
,-2);

253 
	`lua_pushv®ue
(
lua
,-3);

254 ià(
	`lua_pÿÎ
(
lua
,1,0,0)) {

261 
	`lua_pİ
(
lua
,1);

262 
	`lua_push¡ršg
(
lua
,"sort");

263 
	`lua_g‘bË
(
lua
,-2);

264 
	`lua_pushv®ue
(
lua
,-3);

265 
	`lua_g‘glob®
(
lua
,"__redis__compare_helper");

267 
	`lua_ÿÎ
(
lua
,2,0);

270 
	`lua_pİ
(
lua
,1);

271 
	}
}

277 
	$luaR•lyToRedisR•ly
(
ş›Á
 *
c
, 
lua_S‹
 *
lua
) {

278 
t
 = 
	`lua_ty³
(
lua
,-1);

280 
t
) {

281 
LUA_TSTRING
:

282 
	`addR•lyBulkCBufãr
(
c
,(*)
	`lua_to¡ršg
(
lua
,-1),
	`lua_¡¾’
(lua,-1));

284 
LUA_TBOOLEAN
:

285 
	`addR•ly
(
c
,
	`lua_toboŞ—n
(
lua
,-1è? 
sh¬ed
.
cÚe
 : sh¬ed.
nuÎbulk
);

287 
LUA_TNUMBER
:

288 
	`addR•lyLÚgLÚg
(
c
,()
	`lua_tÚumb”
(
lua
,-1));

290 
LUA_TTABLE
:

295 
	`lua_push¡ršg
(
lua
,"err");

296 
	`lua_g‘bË
(
lua
,-2);

297 
t
 = 
	`lua_ty³
(
lua
,-1);

298 ià(
t
 =ğ
LUA_TSTRING
) {

299 
sds
 
”r
 = 
	`sd¢ew
(
	`lua_to¡ršg
(
lua
,-1));

300 
	`sdsm­ch¬s
(
”r
,"\r\n"," ",2);

301 
	`addR•lySds
(
c
,
	`sdsÿrštf
(
	`sd£m±y
(),"-%s\r\n",
”r
));

302 
	`sdsä“
(
”r
);

303 
	`lua_pİ
(
lua
,2);

307 
	`lua_pİ
(
lua
,1);

308 
	`lua_push¡ršg
(
lua
,"ok");

309 
	`lua_g‘bË
(
lua
,-2);

310 
t
 = 
	`lua_ty³
(
lua
,-1);

311 ià(
t
 =ğ
LUA_TSTRING
) {

312 
sds
 
ok
 = 
	`sd¢ew
(
	`lua_to¡ršg
(
lua
,-1));

313 
	`sdsm­ch¬s
(
ok
,"\r\n"," ",2);

314 
	`addR•lySds
(
c
,
	`sdsÿrštf
(
	`sd£m±y
(),"+%s\r\n",
ok
));

315 
	`sdsä“
(
ok
);

316 
	`lua_pİ
(
lua
,1);

318 *
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

319 
j
 = 1, 
mbulkËn
 = 0;

321 
	`lua_pİ
(
lua
,1);

323 
	`lua_pushnumb”
(
lua
,
j
++);

324 
	`lua_g‘bË
(
lua
,-2);

325 
t
 = 
	`lua_ty³
(
lua
,-1);

326 ià(
t
 =ğ
LUA_TNIL
) {

327 
	`lua_pİ
(
lua
,1);

330 
	`luaR•lyToRedisR•ly
(
c
, 
lua
);

331 
mbulkËn
++;

333 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn
,
mbulkËn
);

337 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

339 
	`lua_pİ
(
lua
,1);

340 
	}
}

346 
	#LUA_CMD_OBJCACHE_SIZE
 32

	)

347 
	#LUA_CMD_OBJCACHE_MAX_LEN
 64

	)

348 
	$luaRedisG’”icCommªd
(
lua_S‹
 *
lua
, 
¿i£_”rÜ
) {

349 
j
, 
¬gc
 = 
	`lua_g‘tİ
(
lua
);

350 
»disCommªd
 *
cmd
;

351 
ş›Á
 *
c
 = 
£rv”
.
lua_ş›Á
;

352 
sds
 
»¶y
;

355 
robj
 **
¬gv
 = 
NULL
;

356 
¬gv_size
 = 0;

357 
robj
 *
ÿched_objeùs
[
LUA_CMD_OBJCACHE_SIZE
];

358 
size_t
 
ÿched_objeùs_Ën
[
LUA_CMD_OBJCACHE_SIZE
];

359 
šu£
 = 0;

365 ià(
šu£
) {

366 *
»cursiÚ_w¬nšg
 =

369 
	`£rv”Log
(
LL_WARNING
,"%s",
»cursiÚ_w¬nšg
);

370 
	`luaPushE¼Ü
(
lua
,
»cursiÚ_w¬nšg
);

373 
šu£
++;

376 ià(
¬gc
 == 0) {

377 
	`luaPushE¼Ü
(
lua
,

379 
šu£
--;

380  
¿i£_”rÜ
 ? 
	`luaRai£E¼Ü
(
lua
) : 1;

384 ià(
¬gv_size
 < 
¬gc
) {

385 
¬gv
 = 
	`z»®loc
×rgv,(
robj
*)*
¬gc
);

386 
¬gv_size
 = 
¬gc
;

389 
j
 = 0; j < 
¬gc
; j++) {

390 *
obj_s
;

391 
size_t
 
obj_Ën
;

392 
dbuf
[64];

394 ià(
	`lua_ty³
(
lua
,
j
+1è=ğ
LUA_TNUMBER
) {

397 
lua_Numb”
 
num
 = 
	`lua_tÚumb”
(
lua
,
j
+1);

399 
obj_Ën
 = 
	`¢´štf
(
dbuf
,(dbuf),"%.17g",()
num
);

400 
obj_s
 = 
dbuf
;

402 
obj_s
 = (*)
	`lua_tŞ¡ršg
(
lua
,
j
+1,&
obj_Ën
);

403 ià(
obj_s
 =ğ
NULL
) ;

407 ià(
j
 < 
LUA_CMD_OBJCACHE_SIZE
 && 
ÿched_objeùs
[j] &&

408 
ÿched_objeùs_Ën
[
j
] >ğ
obj_Ën
)

410 
sds
 
s
 = 
ÿched_objeùs
[
j
]->
±r
;

411 
¬gv
[
j
] = 
ÿched_objeùs
[j];

412 
ÿched_objeùs
[
j
] = 
NULL
;

413 
	`memıy
(
s
,
obj_s
,
obj_Ën
+1);

414 
	`sds£’
(
s
, 
obj_Ën
);

416 
¬gv
[
j
] = 
	`ü—‹SŒšgObjeù
(
obj_s
, 
obj_Ën
);

423 ià(
j
 !ğ
¬gc
) {

424 
j
--;

425 
j
 >= 0) {

426 
	`deüRefCouÁ
(
¬gv
[
j
]);

427 
j
--;

429 
	`luaPushE¼Ü
(
lua
,

431 
šu£
--;

432  
¿i£_”rÜ
 ? 
	`luaRai£E¼Ü
(
lua
) : 1;

436 
c
->
¬gv
 =‡rgv;

437 
c
->
¬gc
 =‡rgc;

440 ià(
ldb
.
aùive
 &&†db.
¡•
) {

441 
sds
 
cmdlog
 = 
	`sd¢ew
("<redis>");

442 
j
 = 0; j < 
c
->
¬gc
; j++) {

443 ià(
j
 == 10) {

444 
cmdlog
 = 
	`sdsÿrštf
(cmdlog," ... (%d more)",

445 
c
->
¬gc
-
j
-1);

448 
cmdlog
 = 
	`sdsÿ’
(cmdlog," ",1);

449 
cmdlog
 = 
	`sdsÿtsds
(cmdlog,
c
->
¬gv
[
j
]->
±r
);

452 
	`ldbLog
(
cmdlog
);

456 
cmd
 = 
	`lookupCommªd
(
¬gv
[0]->
±r
);

457 ià(!
cmd
 || ((cmd->
¬™y
 > 0 && cmd->¬™y !ğ
¬gc
) ||

458 (
¬gc
 < -
cmd
->
¬™y
)))

460 ià(
cmd
)

461 
	`luaPushE¼Ü
(
lua
,

464 
	`luaPushE¼Ü
(
lua
,"Unknown Redis command called from Lua script");

465 
ş—nup
;

467 
c
->
cmd
 = c->
Ï¡cmd
 = cmd;

470 ià(
cmd
->
æags
 & 
CMD_NOSCRIPT
) {

471 
	`luaPushE¼Ü
(
lua
, "This Redis command is‚ot‡llowed from scripts");

472 
ş—nup
;

478 ià(
cmd
->
æags
 & 
CMD_WRITE
) {

479 ià(
£rv”
.
lua_¿ndom_dœty
 && !£rv”.
lua_»¶iÿ‹_commªds
) {

480 
	`luaPushE¼Ü
(
lua
,

482 
ş—nup
;

483 } ià(
£rv”
.
ma¡”ho¡
 && s”v”.
»¶_¦ave_ro
 &&

484 !
£rv”
.
lßdšg
 &&

485 !(
£rv”
.
lua_ÿÎ”
->
æags
 & 
CLIENT_MASTER
))

487 
	`luaPushE¼Ü
(
lua
, 
sh¬ed
.
ro¦av“¼
->
±r
);

488 
ş—nup
;

489 } ià(
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
 &&

490 
£rv”
.
§v•¬am¦’
 > 0 &&

491 
£rv”
.
Ï¡bg§ve_¡©us
 =ğ
C_ERR
)

493 
	`luaPushE¼Ü
(
lua
, 
sh¬ed
.
bg§v“¼
->
±r
);

494 
ş—nup
;

502 ià(
£rv”
.
maxmemÜy
 && s”v”.
lua_wr™e_dœty
 == 0 &&

503 (
cmd
->
æags
 & 
CMD_DENYOOM
))

505 ià(
	`ä“MemÜyIfN“ded
(è=ğ
C_ERR
) {

506 
	`luaPushE¼Ü
(
lua
, 
sh¬ed
.
oom”r
->
±r
);

507 
ş—nup
;

511 ià(
cmd
->
æags
 & 
CMD_RANDOM
è
£rv”
.
lua_¿ndom_dœty
 = 1;

512 ià(
cmd
->
æags
 & 
CMD_WRITE
è
£rv”
.
lua_wr™e_dœty
 = 1;

517 ià(
£rv”
.
şu¡”_’abËd
 && !£rv”.
lßdšg
 &&

518 !(
£rv”
.
lua_ÿÎ”
->
æags
 & 
CLIENT_MASTER
))

521 
c
->
æags
 &ğ~(
CLIENT_READONLY
|
CLIENT_ASKING
);

522 
c
->
æags
 |ğ
£rv”
.
lua_ÿÎ”
->æag & (
CLIENT_READONLY
|
CLIENT_ASKING
);

523 ià(
	`g‘NodeByQu”y
(
c
,c->
cmd
,c->
¬gv
,c->
¬gc
,
NULL
,NULL) !=

524 
£rv”
.
şu¡”
->
my£lf
)

526 
	`luaPushE¼Ü
(
lua
,

529 
ş—nup
;

536 ià(
£rv”
.
lua_»¶iÿ‹_commªds
 &&

537 !
£rv”
.
lua_muÉi_em™‹d
 &&

538 
£rv”
.
lua_wr™e_dœty
 &&

539 
£rv”
.
lua_»¶
 !ğ
PROPAGATE_NONE
)

541 
	`execCommªdPrİag©eMuÉi
(
£rv”
.
lua_ÿÎ”
);

542 
£rv”
.
lua_muÉi_em™‹d
 = 1;

546 
ÿÎ_æags
 = 
CMD_CALL_SLOWLOG
 | 
CMD_CALL_STATS
;

547 ià(
£rv”
.
lua_»¶iÿ‹_commªds
) {

549 ià(
£rv”
.
lua_»¶
 & 
PROPAGATE_AOF
)

550 
ÿÎ_æags
 |ğ
CMD_CALL_PROPAGATE_AOF
;

551 ià(
£rv”
.
lua_»¶
 & 
PROPAGATE_REPL
)

552 
ÿÎ_æags
 |ğ
CMD_CALL_PROPAGATE_REPL
;

554 
	`ÿÎ
(
c
,
ÿÎ_æags
);

559 ià(
	`li¡L’gth
(
c
->
»¶y
è=ğ0 && c->
buåos
 < 
PROTO_REPLY_CHUNK_BYTES
) {

563 
c
->
buf
[c->
buåos
] = '\0';

564 
»¶y
 = 
c
->
buf
;

565 
c
->
buåos
 = 0;

567 
»¶y
 = 
	`sd¢ewËn
(
c
->
buf
,c->
buåos
);

568 
c
->
buåos
 = 0;

569 
	`li¡L’gth
(
c
->
»¶y
)) {

570 
sds
 
o
 = 
	`li¡NodeV®ue
(
	`li¡Fœ¡
(
c
->
»¶y
));

572 
»¶y
 = 
	`sdsÿtsds
Ô•ly,
o
);

573 
	`li¡D–Node
(
c
->
»¶y
,
	`li¡Fœ¡
(c->reply));

576 ià(
¿i£_”rÜ
 && 
»¶y
[0] != '-')„aise_error = 0;

577 
	`»disPrÙocŞToLuaTy³
(
lua
,
»¶y
);

580 ià(
ldb
.
aùive
 &&†db.
¡•
)

581 
	`ldbLogRedisR•ly
(
»¶y
);

585 ià((
cmd
->
æags
 & 
CMD_SORT_FOR_SCRIPT
) &&

586 (
£rv”
.
lua_»¶iÿ‹_commªds
 == 0) &&

587 (
»¶y
[0] == '*' &&„eply[1] != '-')) {

588 
	`luaSÜtA¼ay
(
lua
);

590 ià(
»¶y
 !ğ
c
->
buf
è
	`sdsä“
(reply);

591 
c
->
»¶y_by‹s
 = 0;

593 
ş—nup
:

596 
j
 = 0; j < 
c
->
¬gc
; j++) {

597 
robj
 *
o
 = 
c
->
¬gv
[
j
];

602 ià(
j
 < 
LUA_CMD_OBJCACHE_SIZE
 &&

603 
o
->
»fcouÁ
 == 1 &&

604 (
o
->
’codšg
 =ğ
OBJ_ENCODING_RAW
 ||

605 
o
->
’codšg
 =ğ
OBJ_ENCODING_EMBSTR
) &&

606 
	`sd¦’
(
o
->
±r
è<ğ
LUA_CMD_OBJCACHE_MAX_LEN
)

608 
sds
 
s
 = 
o
->
±r
;

609 ià(
ÿched_objeùs
[
j
]è
	`deüRefCouÁ
(cached_objects[j]);

610 
ÿched_objeùs
[
j
] = 
o
;

611 
ÿched_objeùs_Ën
[
j
] = 
	`sd§Îoc
(
s
);

613 
	`deüRefCouÁ
(
o
);

617 ià(
c
->
¬gv
 !=‡rgv) {

618 
	`zä“
(
c
->
¬gv
);

619 
¬gv
 = 
NULL
;

620 
¬gv_size
 = 0;

623 ià(
¿i£_”rÜ
) {

627 
šu£
--;

628  
	`luaRai£E¼Ü
(
lua
);

630 
šu£
--;

632 
	}
}

635 
	$luaRedisC®lCommªd
(
lua_S‹
 *
lua
) {

636  
	`luaRedisG’”icCommªd
(
lua
,1);

637 
	}
}

640 
	$luaRedisPC®lCommªd
(
lua_S‹
 *
lua
) {

641  
	`luaRedisG’”icCommªd
(
lua
,0);

642 
	}
}

646 
	$luaRedisSha1hexCommªd
(
lua_S‹
 *
lua
) {

647 
¬gc
 = 
	`lua_g‘tİ
(
lua
);

648 
dige¡
[41];

649 
size_t
 
Ën
;

650 *
s
;

652 ià(
¬gc
 != 1) {

653 
	`lua_push¡ršg
(
lua
, "wrong‚umber of‡rguments");

654  
	`lua_”rÜ
(
lua
);

657 
s
 = (*)
	`lua_tŞ¡ršg
(
lua
,1,&
Ën
);

658 
	`sha1hex
(
dige¡
,
s
,
Ën
);

659 
	`lua_push¡ršg
(
lua
,
dige¡
);

661 
	}
}

670 
	$luaRedisR‘uºSšgËF›ldTabË
(
lua_S‹
 *
lua
, *
f›ld
) {

671 ià(
	`lua_g‘tİ
(
lua
è!ğ1 || 
	`lua_ty³
Öua,-1è!ğ
LUA_TSTRING
) {

672 
	`luaPushE¼Ü
(
lua
, "wrong‚umber orype of‡rguments");

676 
	`lua_ÃwbË
(
lua
);

677 
	`lua_push¡ršg
(
lua
, 
f›ld
);

678 
	`lua_pushv®ue
(
lua
, -3);

679 
	`lua_£‰abË
(
lua
, -3);

681 
	}
}

684 
	$luaRedisE¼ÜR•lyCommªd
(
lua_S‹
 *
lua
) {

685  
	`luaRedisR‘uºSšgËF›ldTabË
(
lua
,"err");

686 
	}
}

689 
	$luaRedisStusR•lyCommªd
(
lua_S‹
 *
lua
) {

690  
	`luaRedisR‘uºSšgËF›ldTabË
(
lua
,"ok");

691 
	}
}

699 
	$luaRedisR•liÿ‹CommªdsCommªd
(
lua_S‹
 *
lua
) {

700 ià(
£rv”
.
lua_wr™e_dœty
) {

701 
	`lua_pushboŞ—n
(
lua
,0);

703 
£rv”
.
lua_»¶iÿ‹_commªds
 = 1;

707 
	`»disS¿nd48
(
	`¿nd
());

708 
	`lua_pushboŞ—n
(
lua
,1);

711 
	}
}

718 
	$luaRedisB»akpoštCommªd
(
lua_S‹
 *
lua
) {

719 ià(
ldb
.
aùive
) {

720 
ldb
.
luabp
 = 1;

721 
	`lua_pushboŞ—n
(
lua
,1);

723 
	`lua_pushboŞ—n
(
lua
,0);

726 
	}
}

733 
	$luaRedisDebugCommªd
(
lua_S‹
 *
lua
) {

734 ià(!
ldb
.
aùive
)  0;

735 
¬gc
 = 
	`lua_g‘tİ
(
lua
);

736 
sds
 
log
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"<debug>†š%d: ", 
ldb
.
cu¼’še
);

737 
¬gc
--) {

738 
log
 = 
	`ldbC©SckV®ue
Öog,
lua
,-1 - 
¬gc
);

739 ià(
¬gc
 !ğ0è
log
 = 
	`sdsÿ’
(log,", ",2);

741 
	`ldbLog
(
log
);

743 
	}
}

749 
	$luaRedisS‘R•lCommªd
(
lua_S‹
 *
lua
) {

750 
¬gc
 = 
	`lua_g‘tİ
(
lua
);

751 
æags
;

753 ià(
£rv”
.
lua_»¶iÿ‹_commªds
 == 0) {

754 
	`lua_push¡ršg
(
lua
, "You can sethe„eplication behavior only‡fterurning on single commands„eplication with„edis.replicate_commands().");

755  
	`lua_”rÜ
(
lua
);

756 } ià(
¬gc
 != 1) {

757 
	`lua_push¡ršg
(
lua
, "redis.set_repl()„equireswo‡rguments.");

758  
	`lua_”rÜ
(
lua
);

761 
æags
 = 
	`lua_tÚumb”
(
lua
,-1);

762 ià((
æags
 & ~(
PROPAGATE_AOF
|
PROPAGATE_REPL
)) != 0) {

763 
	`lua_push¡ršg
(
lua
, "Invalid„eplication flags. Use REPL_AOF, REPL_SLAVE, REPL_ALL or REPL_NONE.");

764  
	`lua_”rÜ
(
lua
);

766 
£rv”
.
lua_»¶
 = 
æags
;

768 
	}
}

771 
	$luaLogCommªd
(
lua_S‹
 *
lua
) {

772 
j
, 
¬gc
 = 
	`lua_g‘tİ
(
lua
);

773 
Ëv–
;

774 
sds
 
log
;

776 ià(
¬gc
 < 2) {

777 
	`lua_push¡ršg
(
lua
, "redis.log()„equireswo‡rguments or more.");

778  
	`lua_”rÜ
(
lua
);

779 } ià(!
	`lua_i¢umb”
(
lua
,-
¬gc
)) {

780 
	`lua_push¡ršg
(
lua
, "First‡rgument must be‡‚umber (log†evel).");

781  
	`lua_”rÜ
(
lua
);

783 
Ëv–
 = 
	`lua_tÚumb”
(
lua
,-
¬gc
);

784 ià(
Ëv–
 < 
LL_DEBUG
 ||†ev– > 
LL_WARNING
) {

785 
	`lua_push¡ršg
(
lua
, "Invalid debug†evel.");

786  
	`lua_”rÜ
(
lua
);

790 
log
 = 
	`sd£m±y
();

791 
j
 = 1; j < 
¬gc
; j++) {

792 
size_t
 
Ën
;

793 *
s
;

795 
s
 = (*)
	`lua_tŞ¡ršg
(
lua
,(-
¬gc
)+
j
,&
Ën
);

796 ià(
s
) {

797 ià(
j
 !ğ1è
log
 = 
	`sdsÿ’
(log," ",1);

798 
log
 = 
	`sdsÿ’
Öog,
s
,
Ën
);

801 
	`£rv”LogRaw
(
Ëv–
,
log
);

802 
	`sdsä“
(
log
);

804 
	}
}

810 
	$luaLßdLib
(
lua_S‹
 *
lua
, cÚ¡ *
libÇme
, 
lua_CFunùiÚ
 
luafunc
) {

811 
	`lua_pushcfunùiÚ
(
lua
, 
luafunc
);

812 
	`lua_push¡ršg
(
lua
, 
libÇme
);

813 
	`lua_ÿÎ
(
lua
, 1, 0);

814 
	}
}

816 
LUALIB_API
 (
luaİ’_cjsÚ
è(
lua_S‹
 *
L
);

817 
LUALIB_API
 (
luaİ’_¡ruù
è(
lua_S‹
 *
L
);

818 
LUALIB_API
 (
luaİ’_cmsg·ck
è(
lua_S‹
 *
L
);

819 
LUALIB_API
 (
luaİ’_b™
è(
lua_S‹
 *
L
);

821 
	$luaLßdLib¿r›s
(
lua_S‹
 *
lua
) {

822 
	`luaLßdLib
(
lua
, "", 
luaİ’_ba£
);

823 
	`luaLßdLib
(
lua
, 
LUA_TABLIBNAME
, 
luaİ’_bË
);

824 
	`luaLßdLib
(
lua
, 
LUA_STRLIBNAME
, 
luaİ’_¡ršg
);

825 
	`luaLßdLib
(
lua
, 
LUA_MATHLIBNAME
, 
luaİ’_m©h
);

826 
	`luaLßdLib
(
lua
, 
LUA_DBLIBNAME
, 
luaİ’_debug
);

827 
	`luaLßdLib
(
lua
, "cjsÚ", 
luaİ’_cjsÚ
);

828 
	`luaLßdLib
(
lua
, "¡ruù", 
luaİ’_¡ruù
);

829 
	`luaLßdLib
(
lua
, "cmsg·ck", 
luaİ’_cmsg·ck
);

830 
	`luaLßdLib
(
lua
, "b™", 
luaİ’_b™
);

833 
	`luaLßdLib
(
lua
, 
LUA_LOADLIBNAME
, 
luaİ’_·ckage
);

834 
	`luaLßdLib
(
lua
, 
LUA_OSLIBNAME
, 
luaİ’_os
);

836 
	}
}

840 
	$luaRemoveUnsuµÜ‹dFunùiÚs
(
lua_S‹
 *
lua
) {

841 
	`lua_pushn
(
lua
);

842 
	`lua_£tglob®
(
lua
,"loadfile");

843 
	`lua_pushn
(
lua
);

844 
	`lua_£tglob®
(
lua
,"dofile");

845 
	}
}

852 
	$sütšgEÇbËGlob®sPrÙeùiÚ
(
lua_S‹
 *
lua
) {

853 *
s
[32];

854 
sds
 
code
 = 
	`sd£m±y
();

855 
j
 = 0;

859 
s
[
j
++]="local dbg=debug\n";

860 
s
[
j
++]="local mt = {}\n";

861 
s
[
j
++]="setmetatable(_G, mt)\n";

862 
s
[
j
++]="mt.__newindex = function (t,‚, v)\n";

863 
s
[
j
++]=" if dbg.getinfo(2)hen\n";

864 
s
[
j
++]="†ocal w = dbg.getinfo(2, \"S\").what\n";

865 
s
[
j
++]=" if w ~= \"main\"‡nd w ~= \"C\"hen\n";

866 
s
[
j
++]="ƒrror(\"Script‡ttemptedo create global variable '\"..tostring(n)..\"'\", 2)\n";

867 
s
[
j
++]="ƒnd\n";

868 
s
[
j
++]="ƒnd\n";

869 
s
[
j
++]="„awset(t,‚, v)\n";

870 
s
[
j
++]="end\n";

871 
s
[
j
++]="mt.__index = function (t,‚)\n";

872 
s
[
j
++]=" if dbg.getinfo(2)‡nd dbg.getinfo(2, \"S\").what ~= \"C\"hen\n";

873 
s
[
j
++]="ƒrror(\"Script‡ttemptedo‡ccess‚onexistent global variable '\"..tostring(n)..\"'\", 2)\n";

874 
s
[
j
++]="ƒnd\n";

875 
s
[
j
++]="„eturn„awget(t,‚)\n";

876 
s
[
j
++]="end\n";

877 
s
[
j
++]="debug =‚il\n";

878 
s
[
j
++]=
NULL
;

880 
j
 = 0; 
s
[j] !ğ
NULL
; j++è
code
 = 
	`sdsÿ’
(code,s[j],
	`¡¾’
(s[j]));

881 
	`luaL_lßdbufãr
(
lua
,
code
,
	`sd¦’
(code),"@enable_strict_lua");

882 
	`lua_pÿÎ
(
lua
,0,0,0);

883 
	`sdsä“
(
code
);

884 
	}
}

896 
	$sütšgIn™
(
£tup
) {

897 
lua_S‹
 *
lua
 = 
	`lua_İ’
();

899 ià(
£tup
) {

900 
£rv”
.
lua_ş›Á
 = 
NULL
;

901 
£rv”
.
lua_ÿÎ”
 = 
NULL
;

902 
£rv”
.
lua_timedout
 = 0;

903 
£rv”
.
lua_®ways_»¶iÿ‹_commªds
 = 0;

904 
	`ldbIn™
();

907 
	`luaLßdLib¿r›s
(
lua
);

908 
	`luaRemoveUnsuµÜ‹dFunùiÚs
(
lua
);

913 
£rv”
.
lua_süts
 = 
	`diùC»©e
(&
shaSütObjeùDiùTy³
,
NULL
);

916 
	`lua_ÃwbË
(
lua
);

919 
	`lua_push¡ršg
(
lua
,"call");

920 
	`lua_pushcfunùiÚ
(
lua
,
luaRedisC®lCommªd
);

921 
	`lua_£‰abË
(
lua
,-3);

924 
	`lua_push¡ršg
(
lua
,"pcall");

925 
	`lua_pushcfunùiÚ
(
lua
,
luaRedisPC®lCommªd
);

926 
	`lua_£‰abË
(
lua
,-3);

929 
	`lua_push¡ršg
(
lua
,"log");

930 
	`lua_pushcfunùiÚ
(
lua
,
luaLogCommªd
);

931 
	`lua_£‰abË
(
lua
,-3);

933 
	`lua_push¡ršg
(
lua
,"LOG_DEBUG");

934 
	`lua_pushnumb”
(
lua
,
LL_DEBUG
);

935 
	`lua_£‰abË
(
lua
,-3);

937 
	`lua_push¡ršg
(
lua
,"LOG_VERBOSE");

938 
	`lua_pushnumb”
(
lua
,
LL_VERBOSE
);

939 
	`lua_£‰abË
(
lua
,-3);

941 
	`lua_push¡ršg
(
lua
,"LOG_NOTICE");

942 
	`lua_pushnumb”
(
lua
,
LL_NOTICE
);

943 
	`lua_£‰abË
(
lua
,-3);

945 
	`lua_push¡ršg
(
lua
,"LOG_WARNING");

946 
	`lua_pushnumb”
(
lua
,
LL_WARNING
);

947 
	`lua_£‰abË
(
lua
,-3);

950 
	`lua_push¡ršg
(
lua
, "sha1hex");

951 
	`lua_pushcfunùiÚ
(
lua
, 
luaRedisSha1hexCommªd
);

952 
	`lua_£‰abË
(
lua
, -3);

955 
	`lua_push¡ršg
(
lua
, "error_reply");

956 
	`lua_pushcfunùiÚ
(
lua
, 
luaRedisE¼ÜR•lyCommªd
);

957 
	`lua_£‰abË
(
lua
, -3);

958 
	`lua_push¡ršg
(
lua
, "status_reply");

959 
	`lua_pushcfunùiÚ
(
lua
, 
luaRedisStusR•lyCommªd
);

960 
	`lua_£‰abË
(
lua
, -3);

963 
	`lua_push¡ršg
(
lua
, "replicate_commands");

964 
	`lua_pushcfunùiÚ
(
lua
, 
luaRedisR•liÿ‹CommªdsCommªd
);

965 
	`lua_£‰abË
(
lua
, -3);

968 
	`lua_push¡ršg
(
lua
,"set_repl");

969 
	`lua_pushcfunùiÚ
(
lua
,
luaRedisS‘R•lCommªd
);

970 
	`lua_£‰abË
(
lua
,-3);

972 
	`lua_push¡ršg
(
lua
,"REPL_NONE");

973 
	`lua_pushnumb”
(
lua
,
PROPAGATE_NONE
);

974 
	`lua_£‰abË
(
lua
,-3);

976 
	`lua_push¡ršg
(
lua
,"REPL_AOF");

977 
	`lua_pushnumb”
(
lua
,
PROPAGATE_AOF
);

978 
	`lua_£‰abË
(
lua
,-3);

980 
	`lua_push¡ršg
(
lua
,"REPL_SLAVE");

981 
	`lua_pushnumb”
(
lua
,
PROPAGATE_REPL
);

982 
	`lua_£‰abË
(
lua
,-3);

984 
	`lua_push¡ršg
(
lua
,"REPL_ALL");

985 
	`lua_pushnumb”
(
lua
,
PROPAGATE_AOF
|
PROPAGATE_REPL
);

986 
	`lua_£‰abË
(
lua
,-3);

989 
	`lua_push¡ršg
(
lua
,"breakpoint");

990 
	`lua_pushcfunùiÚ
(
lua
,
luaRedisB»akpoštCommªd
);

991 
	`lua_£‰abË
(
lua
,-3);

994 
	`lua_push¡ršg
(
lua
,"debug");

995 
	`lua_pushcfunùiÚ
(
lua
,
luaRedisDebugCommªd
);

996 
	`lua_£‰abË
(
lua
,-3);

999 
	`lua_£tglob®
(
lua
,"redis");

1002 
	`lua_g‘glob®
(
lua
,"math");

1004 
	`lua_push¡ršg
(
lua
,"random");

1005 
	`lua_pushcfunùiÚ
(
lua
,
»dis_m©h_¿ndom
);

1006 
	`lua_£‰abË
(
lua
,-3);

1008 
	`lua_push¡ršg
(
lua
,"randomseed");

1009 
	`lua_pushcfunùiÚ
(
lua
,
»dis_m©h_¿ndom£ed
);

1010 
	`lua_£‰abË
(
lua
,-3);

1012 
	`lua_£tglob®
(
lua
,"math");

1017 *
com·»_func
 = "function __redis__compare_helper(a,b)\n"

1022 
	`luaL_lßdbufãr
(
lua
,
com·»_func
,
	`¡¾’
(compare_func),"@cmp_func_def");

1023 
	`lua_pÿÎ
(
lua
,0,0,0);

1031 *
”rh_func
 = "local dbg = debug\n"

1043 
	`luaL_lßdbufãr
(
lua
,
”rh_func
,
	`¡¾’
(errh_func),"@err_handler_def");

1044 
	`lua_pÿÎ
(
lua
,0,0,0);

1051 ià(
£rv”
.
lua_ş›Á
 =ğ
NULL
) {

1052 
£rv”
.
lua_ş›Á
 = 
	`ü—‹Cl›Á
(-1);

1053 
£rv”
.
lua_ş›Á
->
æags
 |ğ
CLIENT_LUA
;

1059 
	`sütšgEÇbËGlob®sPrÙeùiÚ
(
lua
);

1061 
£rv”
.
lua
 =†ua;

1062 
	}
}

1066 
	$sütšgR–—£
() {

1067 
	`diùR–—£
(
£rv”
.
lua_süts
);

1068 
	`lua_şo£
(
£rv”
.
lua
);

1069 
	}
}

1071 
	$sütšgRe£t
() {

1072 
	`sütšgR–—£
();

1073 
	`sütšgIn™
(0);

1074 
	}
}

1078 
	$luaS‘Glob®A¼ay
(
lua_S‹
 *
lua
, *
v¬
, 
robj
 **
–ev
, 
–ec
) {

1079 
j
;

1081 
	`lua_ÃwbË
(
lua
);

1082 
j
 = 0; j < 
–ec
; j++) {

1083 
	`lua_pushl¡ršg
(
lua
,(*)
–ev
[
j
]->
±r
,
	`sd¦’
(elev[j]->ptr));

1084 
	`lua_¿w£ti
(
lua
,-2,
j
+1);

1086 
	`lua_£tglob®
(
lua
,
v¬
);

1087 
	}
}

1099 
	$»dis_m©h_¿ndom
 (
lua_S‹
 *
L
) {

1102 
lua_Numb”
 
r
 = (lua_Numb”)(
	`»disL¿nd48
()%
REDIS_LRAND48_MAX
) /

1103 (
lua_Numb”
)
REDIS_LRAND48_MAX
;

1104 
	`lua_g‘tİ
(
L
)) {

1106 
	`lua_pushnumb”
(
L
, 
r
);

1110 
u
 = 
	`luaL_checkšt
(
L
, 1);

1111 
	`luaL_¬gcheck
(
L
, 1<=
u
, 1, "interval isƒmpty");

1112 
	`lua_pushnumb”
(
L
, 
	`æoÜ
(
r
*
u
)+1);

1116 
l
 = 
	`luaL_checkšt
(
L
, 1);

1117 
u
 = 
	`luaL_checkšt
(
L
, 2);

1118 
	`luaL_¬gcheck
(
L
, 
l
<=
u
, 2, "interval isƒmpty");

1119 
	`lua_pushnumb”
(
L
, 
	`æoÜ
(
r
*(
u
-
l
+1))+l);

1122 :  
	`luaL_”rÜ
(
L
, "wrong‚umber of‡rguments");

1125 
	}
}

1127 
	$»dis_m©h_¿ndom£ed
 (
lua_S‹
 *
L
) {

1128 
	`»disS¿nd48
(
	`luaL_checkšt
(
L
, 1));

1130 
	}
}

1145 
	$luaC»©eFunùiÚ
(
ş›Á
 *
c
, 
lua_S‹
 *
lua
, *
funúame
, 
robj
 *
body
) {

1146 
sds
 
funcdef
 = 
	`sd£m±y
();

1148 
funcdef
 = 
	`sdsÿt
(funcdef,"function ");

1149 
funcdef
 = 
	`sdsÿ’
(funcdef,
funúame
,42);

1150 
funcdef
 = 
	`sdsÿ’
(funcdef,"() ",3);

1151 
funcdef
 = 
	`sdsÿ’
(funcdef,
body
->
±r
,
	`sd¦’
(body->ptr));

1152 
funcdef
 = 
	`sdsÿ’
(funcdef,"\nend",4);

1154 ià(
	`luaL_lßdbufãr
(
lua
,
funcdef
,
	`sd¦’
(funcdef),"@user_script")) {

1155 
	`addR•lyE¼ÜFÜm©
(
c
,"Error compiling script (new function): %s\n",

1156 
	`lua_to¡ršg
(
lua
,-1));

1157 
	`lua_pİ
(
lua
,1);

1158 
	`sdsä“
(
funcdef
);

1159  
C_ERR
;

1161 
	`sdsä“
(
funcdef
);

1162 ià(
	`lua_pÿÎ
(
lua
,0,0,0)) {

1163 
	`addR•lyE¼ÜFÜm©
(
c
,"Error„unning script (new function): %s\n",

1164 
	`lua_to¡ršg
(
lua
,-1));

1165 
	`lua_pİ
(
lua
,1);

1166  
C_ERR
;

1173 
»tv®
 = 
	`diùAdd
(
£rv”
.
lua_süts
,

1174 
	`sd¢ewËn
(
funúame
+2,40),
body
);

1175 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
»tv®
 =ğ
DICT_OK
);

1176 
	`šüRefCouÁ
(
body
);

1178  
C_OK
;

1179 
	}
}

1182 
	$luaMaskCouÁHook
(
lua_S‹
 *
lua
, 
lua_Debug
 *
¬
) {

1183 
–­£d
;

1184 
	`UNUSED
(
¬
);

1185 
	`UNUSED
(
lua
);

1187 
–­£d
 = 
	`m¡ime
(è- 
£rv”
.
lua_time_¡¬t
;

1188 ià(
–­£d
 >ğ
£rv”
.
lua_time_lim™
 && s”v”.
lua_timedout
 == 0) {

1189 
	`£rv”Log
(
LL_WARNING
,"Lu¨¦ow süˆd‘eùed: stÈšƒxecutiÚ‡á” %Îd mli£cÚds. You cªry klšghsüˆusšghSCRIPT KILL commªd.",
–­£d
);

1190 
£rv”
.
lua_timedout
 = 1;

1196 
	`«D–‘eFeEv’t
(
£rv”
.
–
, s”v”.
lua_ÿÎ”
->
fd
, 
AE_READABLE
);

1198 ià(
£rv”
.
lua_timedout
è
	`´oûssEv’tsWheBlocked
();

1199 ià(
£rv”
.
lua_kl
) {

1200 
	`£rv”Log
(
LL_WARNING
,"Lua script killed by user with SCRIPT KILL.");

1201 
	`lua_push¡ršg
(
lua
,"Script killed by user with SCRIPT KILL...");

1202 
	`lua_”rÜ
(
lua
);

1204 
	}
}

1206 
	$ev®G’”icCommªd
(
ş›Á
 *
c
, 
ev®sha
) {

1207 
lua_S‹
 *
lua
 = 
£rv”
.lua;

1208 
funúame
[43];

1209 
numkeys
;

1210 
d–hook
 = 0, 
”r
;

1214 
	`»disS¿nd48
(0);

1224 
£rv”
.
lua_¿ndom_dœty
 = 0;

1225 
£rv”
.
lua_wr™e_dœty
 = 0;

1226 
£rv”
.
lua_»¶iÿ‹_commªds
 = s”v”.
lua_®ways_»¶iÿ‹_commªds
;

1227 
£rv”
.
lua_muÉi_em™‹d
 = 0;

1228 
£rv”
.
lua_»¶
 = 
PROPAGATE_AOF
|
PROPAGATE_REPL
;

1231 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
numkeys
,
NULL
è!ğ
C_OK
)

1233 ià(
numkeys
 > (
c
->
¬gc
 - 3)) {

1234 
	`addR•lyE¼Ü
(
c
,"Number of keys can't be greaterhan‚umber of‡rgs");

1236 } ià(
numkeys
 < 0) {

1237 
	`addR•lyE¼Ü
(
c
,"Number of keys can't be‚egative");

1243 
funúame
[0] = 'f';

1244 
funúame
[1] = '_';

1245 ià(!
ev®sha
) {

1247 
	`sha1hex
(
funúame
+2,
c
->
¬gv
[1]->
±r
,
	`sd¦’
(c->argv[1]->ptr));

1250 
j
;

1251 *
sha
 = 
c
->
¬gv
[1]->
±r
;

1256 
j
 = 0; j < 40; j++)

1257 
funúame
[
j
+2] = (
sha
[j] >= 'A' && sha[j] <= 'Z') ?

1258 
sha
[
j
]+('a'-'A') : sha[j];

1259 
funúame
[42] = '\0';

1263 
	`lua_g‘glob®
(
lua
, "__redis__err__handler");

1266 
	`lua_g‘glob®
(
lua
, 
funúame
);

1267 ià(
	`lua_i¢
(
lua
,-1)) {

1268 
	`lua_pİ
(
lua
,1);

1272 ià(
ev®sha
) {

1273 
	`lua_pİ
(
lua
,1);

1274 
	`addR•ly
(
c
, 
sh¬ed
.
nosü‹¼
);

1277 ià(
	`luaC»©eFunùiÚ
(
c
,
lua
,
funúame
,c->
¬gv
[1]è=ğ
C_ERR
) {

1278 
	`lua_pİ
(
lua
,1);

1284 
	`lua_g‘glob®
(
lua
, 
funúame
);

1285 
	`£rv”As£¹
(!
	`lua_i¢
(
lua
,-1));

1290 
	`luaS‘Glob®A¼ay
(
lua
,"KEYS",
c
->
¬gv
+3,
numkeys
);

1291 
	`luaS‘Glob®A¼ay
(
lua
,"ARGV",
c
->
¬gv
+3+
numkeys
,c->
¬gc
-3-numkeys);

1294 
	`£ËùDb
(
£rv”
.
lua_ş›Á
,
c
->
db
->
id
);

1303 
£rv”
.
lua_ÿÎ”
 = 
c
;

1304 
£rv”
.
lua_time_¡¬t
 = 
	`m¡ime
();

1305 
£rv”
.
lua_kl
 = 0;

1306 ià(
£rv”
.
lua_time_lim™
 > 0 && s”v”.
ma¡”ho¡
 =ğ
NULL
 &&

1307 
ldb
.
aùive
 == 0)

1309 
	`lua_£thook
(
lua
,
luaMaskCouÁHook
,
LUA_MASKCOUNT
,100000);

1310 
d–hook
 = 1;

1311 } ià(
ldb
.
aùive
) {

1312 
	`lua_£thook
(
£rv”
.
lua
,
luaLdbLšeHook
,
LUA_MASKLINE
|
LUA_MASKCOUNT
,100000);

1313 
d–hook
 = 1;

1319 
”r
 = 
	`lua_pÿÎ
(
lua
,0,1,-2);

1322 ià(
d–hook
è
	`lua_£thook
(
lua
,
NULL
,0,0);

1323 ià(
£rv”
.
lua_timedout
) {

1324 
£rv”
.
lua_timedout
 = 0;

1327 
	`«C»©eFeEv’t
(
£rv”
.
–
,
c
->
fd
,
AE_READABLE
,

1328 
»adQu”yFromCl›Á
,
c
);

1330 
£rv”
.
lua_ÿÎ”
 = 
NULL
;

1338 
	#LUA_GC_CYCLE_PERIOD
 50

	)

1340 
gc_couÁ
 = 0;

1342 
gc_couÁ
++;

1343 ià(
gc_couÁ
 =ğ
LUA_GC_CYCLE_PERIOD
) {

1344 
	`lua_gc
(
lua
,
LUA_GCSTEP
,
LUA_GC_CYCLE_PERIOD
);

1345 
gc_couÁ
 = 0;

1349 ià(
”r
) {

1350 
	`addR•lyE¼ÜFÜm©
(
c
,"Error„unning script (callo %s): %s\n",

1351 
funúame
, 
	`lua_to¡ršg
(
lua
,-1));

1352 
	`lua_pİ
(
lua
,2);

1356 
	`luaR•lyToRedisR•ly
(
c
,
lua
);

1357 
	`lua_pİ
(
lua
,1);

1362 ià(
£rv”
.
lua_»¶iÿ‹_commªds
) {

1363 
	`´ev’tCommªdPrİag©iÚ
(
c
);

1364 ià(
£rv”
.
lua_muÉi_em™‹d
) {

1365 
robj
 *
´İ¬gv
[1];

1366 
´İ¬gv
[0] = 
	`ü—‹SŒšgObjeù
("EXEC",4);

1367 
	`®soPrİag©e
(
£rv”
.
execCommªd
,
c
->
db
->
id
,
´İ¬gv
,1,

1368 
PROPAGATE_AOF
|
PROPAGATE_REPL
);

1369 
	`deüRefCouÁ
(
´İ¬gv
[0]);

1383 ià(
ev®sha
 && !
£rv”
.
lua_»¶iÿ‹_commªds
) {

1384 ià(!
	`»¶iÿtiÚSütCacheExi¡s
(
c
->
¬gv
[1]->
±r
)) {

1388 
robj
 *
süt
 = 
	`diùF‘chV®ue
(
£rv”
.
lua_süts
,
c
->
¬gv
[1]->
±r
);

1390 
	`»¶iÿtiÚSütCacheAdd
(
c
->
¬gv
[1]->
±r
);

1391 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
süt
 != NULL);

1392 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,0,

1393 
	`»£tRefCouÁ
(
	`ü—‹SŒšgObjeù
("EVAL",4)));

1394 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,1,
süt
);

1395 
	`fÜûCommªdPrİag©iÚ
(
c
,
PROPAGATE_REPL
|
PROPAGATE_AOF
);

1398 
	}
}

1400 
	$ev®Commªd
(
ş›Á
 *
c
) {

1401 ià(!(
c
->
æags
 & 
CLIENT_LUA_DEBUG
))

1402 
	`ev®G’”icCommªd
(
c
,0);

1404 
	`ev®G’”icCommªdW™hDebuggšg
(
c
,0);

1405 
	}
}

1407 
	$ev®ShaCommªd
(
ş›Á
 *
c
) {

1408 ià(
	`sd¦’
(
c
->
¬gv
[1]->
±r
) != 40) {

1413 
	`addR•ly
(
c
, 
sh¬ed
.
nosü‹¼
);

1416 ià(!(
c
->
æags
 & 
CLIENT_LUA_DEBUG
))

1417 
	`ev®G’”icCommªd
(
c
,1);

1419 
	`addR•lyE¼Ü
(
c
,"Please use EVAL instead of EVALSHA for debugging");

1422 
	}
}

1424 
	$sütCommªd
(
ş›Á
 *
c
) {

1425 ià(
c
->
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"flush")) {

1426 
	`sütšgRe£t
();

1427 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1428 
	`»¶iÿtiÚSütCacheFlush
();

1429 
£rv”
.
dœty
++;

1430 } ià(
c
->
¬gc
 >ğ2 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"exists")) {

1431 
j
;

1433 
	`addR•lyMuÉiBulkL’
(
c
, c->
¬gc
-2);

1434 
j
 = 2; j < 
c
->
¬gc
; j++) {

1435 ià(
	`diùFšd
(
£rv”
.
lua_süts
,
c
->
¬gv
[
j
]->
±r
))

1436 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

1438 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1440 } ià(
c
->
¬gc
 =ğ3 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"load")) {

1441 
funúame
[43];

1442 
sds
 
sha
;

1444 
funúame
[0] = 'f';

1445 
funúame
[1] = '_';

1446 
	`sha1hex
(
funúame
+2,
c
->
¬gv
[2]->
±r
,
	`sd¦’
(c->argv[2]->ptr));

1447 
sha
 = 
	`sd¢ewËn
(
funúame
+2,40);

1448 ià(
	`diùFšd
(
£rv”
.
lua_süts
,
sha
è=ğ
NULL
) {

1449 ià(
	`luaC»©eFunùiÚ
(
c
,
£rv”
.
lua
,
funúame
,c->
¬gv
[2])

1450 =ğ
C_ERR
) {

1451 
	`sdsä“
(
sha
);

1455 
	`addR•lyBulkCBufãr
(
c
,
funúame
+2,40);

1456 
	`sdsä“
(
sha
);

1457 
	`fÜûCommªdPrİag©iÚ
(
c
,
PROPAGATE_REPL
|
PROPAGATE_AOF
);

1458 } ià(
c
->
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"kill")) {

1459 ià(
£rv”
.
lua_ÿÎ”
 =ğ
NULL
) {

1460 
	`addR•lySds
(
c
,
	`sd¢ew
("-NOTBUSY No scripts inƒxecution„ight‚ow.\r\n"));

1461 } ià(
£rv”
.
lua_wr™e_dœty
) {

1462 
	`addR•lySds
(
c
,
	`sd¢ew
("-UNKILLABLE Sorryhe script‡lreadyƒxecuted write commands‡gainsthe dataset. You canƒither waithe scriptermination or killhe server in‡ hard way usinghe SHUTDOWN NOSAVE command.\r\n"));

1464 
£rv”
.
lua_kl
 = 1;

1465 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1467 } ià(
c
->
¬gc
 =ğ3 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"debug")) {

1468 ià(
	`ş›ÁHasP’dšgR•l›s
(
c
)) {

1469 
	`addR•lyE¼Ü
(
c
,"SCRIPT DEBUG must be called outside‡…ipeline");

1472 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"no")) {

1473 
	`ldbDi§bË
(
c
);

1474 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1475 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"yes")) {

1476 
	`ldbEÇbË
(
c
);

1477 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1478 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"sync")) {

1479 
	`ldbEÇbË
(
c
);

1480 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1481 
c
->
æags
 |ğ
CLIENT_LUA_DEBUG_SYNC
;

1483 
	`addR•lyE¼Ü
(
c
,"Use SCRIPT DEBUG yes/sync/no");

1486 
	`addR•lyE¼Ü
(
c
, "Unknown SCRIPT subcommand or wrong # of‡rgs.");

1488 
	}
}

1495 
	$ldbIn™
() {

1496 
ldb
.
fd
 = -1;

1497 
ldb
.
aùive
 = 0;

1498 
ldb
.
logs
 = 
	`li¡C»©e
();

1499 
	`li¡S‘F»eM‘hod
(
ldb
.
logs
,((*)(*))
sdsä“
);

1500 
ldb
.
chd»n
 = 
	`li¡C»©e
();

1501 
ldb
.
¤c
 = 
NULL
;

1502 
ldb
.
lšes
 = 0;

1503 
ldb
.
cbuf
 = 
	`sd£m±y
();

1504 
	}
}

1507 
	$ldbFlushLog
(
li¡
 *
log
) {

1508 
li¡Node
 *
Ê
;

1510 (
Ê
 = 
	`li¡Fœ¡
(
log
)è!ğ
NULL
)

1511 
	`li¡D–Node
(
log
,
Ê
);

1512 
	}
}

1515 
	$ldbEÇbË
(
ş›Á
 *
c
) {

1516 
c
->
æags
 |ğ
CLIENT_LUA_DEBUG
;

1517 
	`ldbFlushLog
(
ldb
.
logs
);

1518 
ldb
.
fd
 = 
c
->fd;

1519 
ldb
.
¡•
 = 1;

1520 
ldb
.
bpcouÁ
 = 0;

1521 
ldb
.
luabp
 = 0;

1522 
	`sdsä“
(
ldb
.
cbuf
);

1523 
ldb
.
cbuf
 = 
	`sd£m±y
();

1524 
ldb
.
maxËn
 = 
LDB_MAX_LEN_DEFAULT
;

1525 
ldb
.
maxËn_hšt_£Á
 = 0;

1526 
	}
}

1531 
	$ldbDi§bË
(
ş›Á
 *
c
) {

1532 
c
->
æags
 &ğ~(
CLIENT_LUA_DEBUG
|
CLIENT_LUA_DEBUG_SYNC
);

1533 
	}
}

1536 
	$ldbLog
(
sds
 
’Œy
) {

1537 
	`li¡AddNodeTa
(
ldb
.
logs
,
’Œy
);

1538 
	}
}

1544 
	$ldbLogW™hMaxL’
(
sds
 
’Œy
) {

1545 
Œimmed
 = 0;

1546 ià(
ldb
.
maxËn
 && 
	`sd¦’
(
’Œy
) >†db.maxlen) {

1547 
	`sd¤ªge
(
’Œy
,0,
ldb
.
maxËn
-1);

1548 
’Œy
 = 
	`sdsÿ’
(entry," ...",4);

1549 
Œimmed
 = 1;

1551 
	`ldbLog
(
’Œy
);

1552 ià(
Œimmed
 && 
ldb
.
maxËn_hšt_£Á
 == 0) {

1553 
ldb
.
maxËn_hšt_£Á
 = 1;

1554 
	`ldbLog
(
	`sd¢ew
(

1557 
	}
}

1562 
	$ldbS’dLogs
() {

1563 
sds
 
´Ùo
 = 
	`sd£m±y
();

1564 
´Ùo
 = 
	`sdsÿtfmt
ÕrÙo,"*%i\r\n", ()
	`li¡L’gth
(
ldb
.
logs
));

1565 
	`li¡L’gth
(
ldb
.
logs
)) {

1566 
li¡Node
 *
Ê
 = 
	`li¡Fœ¡
(
ldb
.
logs
);

1567 
´Ùo
 = 
	`sdsÿ’
(proto,"+",1);

1568 
	`sdsm­ch¬s
(
Ê
->
v®ue
,"\r\n"," ",2);

1569 
´Ùo
 = 
	`sdsÿtsds
ÕrÙo,
Ê
->
v®ue
);

1570 
´Ùo
 = 
	`sdsÿ’
(proto,"\r\n",2);

1571 
	`li¡D–Node
(
ldb
.
logs
,
Ê
);

1573 ià(
	`wr™e
(
ldb
.
fd
,
´Ùo
,
	`sd¦’
(proto)) == -1) {

1578 
	`sdsä“
(
´Ùo
);

1579 
	}
}

1593 
	$ldbS¹SessiÚ
(
ş›Á
 *
c
) {

1594 
ldb
.
fÜked
 = (
c
->
æags
 & 
CLIENT_LUA_DEBUG_SYNC
) == 0;

1595 ià(
ldb
.
fÜked
) {

1596 
pid_t
 
ı
 = 
	`fÜk
();

1597 ià(
ı
 == -1) {

1598 
	`addR•lyE¼Ü
(
c
,"Fork() failed: can't„un EVAL in debugging mode.");

1600 } ià(
ı
 == 0) {

1602 
sigaùiÚ
 
aù
;

1603 
	`sigem±y£t
(&
aù
.
§_mask
);

1604 
aù
.
§_æags
 = 0;

1605 
aù
.
§_hªdËr
 = 
SIG_IGN
;

1606 
	`sigaùiÚ
(
SIGTERM
, &
aù
, 
NULL
);

1607 
	`sigaùiÚ
(
SIGINT
, &
aù
, 
NULL
);

1612 
	`£rv”Log
(
LL_WARNING
,"Redis forked for debuggingƒval");

1613 
	`şo£Li¡’šgSock‘s
(0);

1616 
	`li¡AddNodeTa
(
ldb
.
chd»n
,(*)()
ı
);

1617 
	`ä“Cl›ÁAsync
(
c
);

1621 
	`£rv”Log
(
LL_WARNING
,

1626 
	`ª‘Block
(
NULL
,
ldb
.
fd
);

1627 
	`ª‘S’dTimeout
(
NULL
,
ldb
.
fd
,5000);

1628 
ldb
.
aùive
 = 1;

1632 
sds
 
¤c¡ršg
 = 
	`sdsdup
(
c
->
¬gv
[1]->
±r
);

1633 
size_t
 
¤ş’
 = 
	`sd¦’
(
¤c¡ršg
);

1634 
¤ş’
 && (
¤c¡ršg
[srclen-1] == '\n' ||

1635 
¤c¡ršg
[
¤ş’
-1] == '\r'))

1637 
¤c¡ršg
[--
¤ş’
] = '\0';

1639 
	`sds£’
(
¤c¡ršg
,
¤ş’
);

1640 
ldb
.
¤c
 = 
	`sds¥l™Ën
(
¤c¡ršg
,
	`sd¦’
(¤c¡ršg),"\n",1,&ldb.
lšes
);

1641 
	`sdsä“
(
¤c¡ršg
);

1643 
	}
}

1647 
	$ldbEndSessiÚ
(
ş›Á
 *
c
) {

1649 
	`ldbLog
(
	`sd¢ew
("<endsession>"));

1650 
	`ldbS’dLogs
();

1653 ià(
ldb
.
fÜked
) {

1654 
	`wr™eToCl›Á
(
c
->
fd
, c, 0);

1655 
	`£rv”Log
(
LL_WARNING
,"Lua debugging session childƒxiting");

1656 
	`ex™FromChd
(0);

1658 
	`£rv”Log
(
LL_WARNING
,

1663 
	`ª‘NÚBlock
(
NULL
,
ldb
.
fd
);

1664 
	`ª‘S’dTimeout
(
NULL
,
ldb
.
fd
,0);

1668 
c
->
æags
 |ğ
CLIENT_CLOSE_AFTER_REPLY
;

1671 
	`sdsä“¥l™»s
(
ldb
.
¤c
,ldb.
lšes
);

1672 
ldb
.
lšes
 = 0;

1673 
ldb
.
aùive
 = 0;

1674 
	}
}

1679 
	$ldbRemoveChd
(
pid_t
 
pid
) {

1680 
li¡Node
 *
Ê
 = 
	`li¡S—rchKey
(
ldb
.
chd»n
,(*)()
pid
);

1681 ià(
Ê
) {

1682 
	`li¡D–Node
(
ldb
.
chd»n
,
Ê
);

1686 
	}
}

1690 
	$ldbP’dšgChd»n
() {

1691  
	`li¡L’gth
(
ldb
.
chd»n
);

1692 
	}
}

1695 
	$ldbKlFÜkedSessiÚs
() {

1696 
li¡I‹r
 
li
;

1697 
li¡Node
 *
Ê
;

1699 
	`li¡Rewšd
(
ldb
.
chd»n
,&
li
);

1700 (
Ê
 = 
	`li¡Next
(&
li
))) {

1701 
pid_t
 
pid
 = (è
Ê
->
v®ue
;

1702 
	`£rv”Log
(
LL_WARNING
,"Klšg debuggšg sessiÚ %ld",()
pid
);

1703 
	`kl
(
pid
,
SIGKILL
);

1705 
	`li¡R–—£
(
ldb
.
chd»n
);

1706 
ldb
.
chd»n
 = 
	`li¡C»©e
();

1707 
	}
}

1711 
	$ev®G’”icCommªdW™hDebuggšg
(
ş›Á
 *
c
, 
ev®sha
) {

1712 ià(
	`ldbS¹SessiÚ
(
c
)) {

1713 
	`ev®G’”icCommªd
(
c
,
ev®sha
);

1714 
	`ldbEndSessiÚ
(
c
);

1716 
	`ldbDi§bË
(
c
);

1718 
	}
}

1722 *
	$ldbG‘SourûLše
(
lše
) {

1723 
idx
 = 
lše
-1;

1724 ià(
idx
 < 0 || idx >ğ
ldb
.
lšes
)  "<out of„ange source code†ine>";

1725  
ldb
.
¤c
[
idx
];

1726 
	}
}

1729 
	$ldbIsB»akpošt
(
lše
) {

1730 
j
;

1732 
j
 = 0; j < 
ldb
.
bpcouÁ
; j++)

1733 ià(
ldb
.
bp
[
j
] =ğ
lše
)  1;

1735 
	}
}

1740 
	$ldbAddB»akpošt
(
lše
) {

1741 ià(
lše
 <ğ0 ||†š> 
ldb
.
lšes
)  0;

1742 ià(!
	`ldbIsB»akpošt
(
lše
è&& 
ldb
.
bpcouÁ
 !ğ
LDB_BREAKPOINTS_MAX
) {

1743 
ldb
.
bp
[ldb.
bpcouÁ
++] = 
lše
;

1747 
	}
}

1751 
	$ldbD–B»akpošt
(
lše
) {

1752 
j
;

1754 
j
 = 0; j < 
ldb
.
bpcouÁ
; j++) {

1755 ià(
ldb
.
bp
[
j
] =ğ
lše
) {

1756 
ldb
.
bpcouÁ
--;

1757 
	`memmove
(
ldb
.
bp
+
j
,ldb.bp+j+1,ldb.
bpcouÁ
-j);

1762 
	}
}

1767 
sds
 *
	$ldbR•lP¬£Commªd
(*
¬gı
) {

1768 
sds
 *
¬gv
 = 
NULL
;

1769 
¬gc
 = 0;

1770 ià(
	`sd¦’
(
ldb
.
cbuf
è=ğ0è 
NULL
;

1774 
sds
 
cİy
 = 
	`sdsdup
(
ldb
.
cbuf
);

1775 *
p
 = 
cİy
;

1782 
p
 = 
	`¡rchr
Õ,'*'); ià(!pè
´ÙÛ¼
;

1783 *
¶’
 = 
p
+1;

1784 
p
 = 
	`¡r¡r
Õ,"\r\n"); ià(!pè
´ÙÛ¼
;

1785 *
p
 = '\0';… += 2;

1786 *
¬gı
 = 
	`©oi
(
¶’
);

1787 ià(*
¬gı
 <ğ0 || *¬gı > 1024è
´ÙÛ¼
;

1790 
¬gv
 = 
	`zm®loc
((
sds
)*(*
¬gı
));

1791 
¬gc
 = 0;

1792 
¬gc
 < *
¬gı
) {

1793 ià(*
p
 !ğ'$'è
´ÙÛ¼
;

1794 
¶’
 = 
p
+1;

1795 
p
 = 
	`¡r¡r
Õ,"\r\n"); ià(!pè
´ÙÛ¼
;

1796 *
p
 = '\0';… += 2;

1797 
¦’
 = 
	`©oi
(
¶’
);

1798 ià(
¦’
 <ğ0 || sËÀ> 1024è
´ÙÛ¼
;

1799 
¬gv
[
¬gc
++] = 
	`sd¢ewËn
(
p
,
¦’
);

1800 
p
 +ğ
¦’
;

1801 ià(
p
[0] !ğ'\r' ||…[1] !ğ'\n'è
´ÙÛ¼
;

1802 
p
 += 2;

1804 
	`sdsä“
(
cİy
);

1805  
¬gv
;

1807 
´ÙÛ¼
:

1808 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

1809 
	`sdsä“
(
cİy
);

1810  
NULL
;

1811 
	}
}

1814 
	$ldbLogSourûLše
(
Êum
) {

1815 *
lše
 = 
	`ldbG‘SourûLše
(
Êum
);

1816 *
´efix
;

1817 
bp
 = 
	`ldbIsB»akpošt
(
Êum
);

1818 
cu¼’t
 = 
ldb
.
cu¼’še
 =ğ
Êum
;

1820 ià(
cu¼’t
 && 
bp
)

1821 
´efix
 = "->#";

1822 ià(
cu¼’t
)

1823 
´efix
 = "-> ";

1824 ià(
bp
)

1825 
´efix
 = " #";

1827 
´efix
 = " ";

1828 
sds
 
thi¦še
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"%s%-3d %s", 
´efix
, 
Êum
, 
lše
);

1829 
	`ldbLog
(
thi¦še
);

1830 
	}
}

1837 
	$ldbLi¡
(
¬ound
, 
cÚ‹xt
) {

1838 
j
;

1840 
j
 = 1; j <ğ
ldb
.
lšes
; j++) {

1841 ià(
¬ound
 !ğ0 && 
	`abs
×round-
j
è> 
cÚ‹xt
) ;

1842 
	`ldbLogSourûLše
(
j
);

1844 
	}
}

1853 
	#LDB_MAX_VALUES_DEPTH
 (
LUA_MINSTACK
/2)

	)

1854 
sds
 
	$ldbC©SckV®ueRec
(
sds
 
s
, 
lua_S‹
 *
lua
, 
idx
, 
Ëv–
) {

1855 
t
 = 
	`lua_ty³
(
lua
,
idx
);

1857 ià(
Ëv–
++ =ğ
LDB_MAX_VALUES_DEPTH
)

1858  
	`sdsÿt
(
s
,"<max„ecursion†evel„eached! Nestedable?>");

1860 
t
) {

1861 
LUA_TSTRING
:

1863 
size_t
 
¡¾
;

1864 *
¡½
 = (*)
	`lua_tŞ¡ršg
(
lua
,
idx
,&
¡¾
);

1865 
s
 = 
	`sdsÿŒ•r
(s,
¡½
,
¡¾
);

1868 
LUA_TBOOLEAN
:

1869 
s
 = 
	`sdsÿt
(s,
	`lua_toboŞ—n
(
lua
,
idx
) ? "true" : "false");

1871 
LUA_TNUMBER
:

1872 
s
 = 
	`sdsÿrštf
(s,"%g",()
	`lua_tÚumb”
(
lua
,
idx
));

1874 
LUA_TNIL
:

1875 
s
 = 
	`sdsÿ’
(s,"nil",3);

1877 
LUA_TTABLE
:

1879 
ex³ùed_šdex
 = 1;

1880 
is_¬¿y
 = 1;

1884 
sds
 
»´1
 = 
	`sd£m±y
();

1885 
sds
 
»´2
 = 
	`sd£m±y
();

1886 
	`lua_pushn
(
lua
);

1887 
	`lua_Ãxt
(
lua
,
idx
-1)) {

1889 ià(
is_¬¿y
 &&

1890 (
	`lua_ty³
(
lua
,-2è!ğ
LUA_TNUMBER
 ||

1891 
	`lua_tÚumb”
(
lua
,-2è!ğ
ex³ùed_šdex
)è
is_¬¿y
 = 0;

1894 
»´1
 = 
	`ldbC©SckV®ueRec
Ô•r1,
lua
,-1,
Ëv–
);

1895 
»´1
 = 
	`sdsÿ’
(repr1,"; ",2);

1897 
»´2
 = 
	`sdsÿ’
(repr2,"[",1);

1898 
»´2
 = 
	`ldbC©SckV®ueRec
Ô•r2,
lua
,-2,
Ëv–
);

1899 
»´2
 = 
	`sdsÿ’
(repr2,"]=",2);

1900 
»´2
 = 
	`ldbC©SckV®ueRec
Ô•r2,
lua
,-1,
Ëv–
);

1901 
»´2
 = 
	`sdsÿ’
(repr2,"; ",2);

1902 
	`lua_pİ
(
lua
,1);

1903 
ex³ùed_šdex
++;

1906 ià(
	`sd¦’
(
»´1
)è
	`sd¤ªge
(repr1,0,-3);

1907 ià(
	`sd¦’
(
»´2
)è
	`sd¤ªge
(repr2,0,-3);

1909 
s
 = 
	`sdsÿ’
(s,"{",1);

1910 
s
 = 
	`sdsÿtsds
(s,
is_¬¿y
 ? 
»´1
 : 
»´2
);

1911 
s
 = 
	`sdsÿ’
(s,"}",1);

1912 
	`sdsä“
(
»´1
);

1913 
	`sdsä“
(
»´2
);

1916 
LUA_TFUNCTION
:

1917 
LUA_TUSERDATA
:

1918 
LUA_TTHREAD
:

1919 
LUA_TLIGHTUSERDATA
:

1921 cÚ¡ *
p
 = 
	`lua_tİoš‹r
(
lua
,
idx
);

1922 *
ty³Çme
 = "unknown";

1923 ià(
t
 =ğ
LUA_TFUNCTION
è
ty³Çme
 = "function";

1924 ià(
t
 =ğ
LUA_TUSERDATA
è
ty³Çme
 = "userdata";

1925 ià(
t
 =ğ
LUA_TTHREAD
è
ty³Çme
 = "thread";

1926 ià(
t
 =ğ
LUA_TLIGHTUSERDATA
è
ty³Çme
 = "light-userdata";

1927 
s
 = 
	`sdsÿrštf
(s,"\"%s@%p\"",
ty³Çme
,
p
);

1931 
s
 = 
	`sdsÿt
(s,"\"<unknown-lua-type>\"");

1934  
s
;

1935 
	}
}

1939 
sds
 
	$ldbC©SckV®ue
(
sds
 
s
, 
lua_S‹
 *
lua
, 
idx
) {

1940  
	`ldbC©SckV®ueRec
(
s
,
lua
,
idx
,0);

1941 
	}
}

1946 
	$ldbLogSckV®ue
(
lua_S‹
 *
lua
, *
´efix
) {

1947 
sds
 
s
 = 
	`sd¢ew
(
´efix
);

1948 
s
 = 
	`ldbC©SckV®ue
(s,
lua
,-1);

1949 
	`ldbLogW™hMaxL’
(
s
);

1950 
	}
}

1952 *
ldbRedisPrÙocŞToHumª_IÁ
(
sds
 *
o
, *
»¶y
);

1953 *
ldbRedisPrÙocŞToHumª_Bulk
(
sds
 *
o
, *
»¶y
);

1954 *
ldbRedisPrÙocŞToHumª_Stus
(
sds
 *
o
, *
»¶y
);

1955 *
ldbRedisPrÙocŞToHumª_MuÉiBulk
(
sds
 *
o
, *
»¶y
);

1962 *
	$ldbRedisPrÙocŞToHumª
(
sds
 *
o
, *
»¶y
) {

1963 *
p
 = 
»¶y
;

1964 *
p
) {

1965 ':': 
p
 = 
	`ldbRedisPrÙocŞToHumª_IÁ
(
o
,
»¶y
); ;

1966 '$': 
p
 = 
	`ldbRedisPrÙocŞToHumª_Bulk
(
o
,
»¶y
); ;

1967 '+': 
p
 = 
	`ldbRedisPrÙocŞToHumª_Stus
(
o
,
»¶y
); ;

1968 '-': 
p
 = 
	`ldbRedisPrÙocŞToHumª_Stus
(
o
,
»¶y
); ;

1969 '*': 
p
 = 
	`ldbRedisPrÙocŞToHumª_MuÉiBulk
(
o
,
»¶y
); ;

1971  
p
;

1972 
	}
}

1977 *
	$ldbRedisPrÙocŞToHumª_IÁ
(
sds
 *
o
, *
»¶y
) {

1978 *
p
 = 
	`¡rchr
(
»¶y
+1,'\r');

1979 *
o
 = 
	`sdsÿ’
(*o,
»¶y
+1,
p
-reply-1);

1980  
p
+2;

1981 
	}
}

1983 *
	$ldbRedisPrÙocŞToHumª_Bulk
(
sds
 *
o
, *
»¶y
) {

1984 *
p
 = 
	`¡rchr
(
»¶y
+1,'\r');

1985 
bulkËn
;

1987 
	`¡ršg2Î
(
»¶y
+1,
p
-»¶y-1,&
bulkËn
);

1988 ià(
bulkËn
 == -1) {

1989 *
o
 = 
	`sdsÿ’
(*o,"NULL",4);

1990  
p
+2;

1992 *
o
 = 
	`sdsÿŒ•r
(*o,
p
+2,
bulkËn
);

1993  
p
+2+
bulkËn
+2;

1995 
	}
}

1997 *
	$ldbRedisPrÙocŞToHumª_Stus
(
sds
 *
o
, *
»¶y
) {

1998 *
p
 = 
	`¡rchr
(
»¶y
+1,'\r');

2000 *
o
 = 
	`sdsÿŒ•r
(*o,
»¶y
,
p
-reply);

2001  
p
+2;

2002 
	}
}

2004 *
	$ldbRedisPrÙocŞToHumª_MuÉiBulk
(
sds
 *
o
, *
»¶y
) {

2005 *
p
 = 
	`¡rchr
(
»¶y
+1,'\r');

2006 
mbulkËn
;

2007 
j
 = 0;

2009 
	`¡ršg2Î
(
»¶y
+1,
p
-»¶y-1,&
mbulkËn
);

2010 
p
 += 2;

2011 ià(
mbulkËn
 == -1) {

2012 *
o
 = 
	`sdsÿ’
(*o,"NULL",4);

2013  
p
;

2015 *
o
 = 
	`sdsÿ’
(*o,"[",1);

2016 
j
 = 0; j < 
mbulkËn
; j++) {

2017 
p
 = 
	`ldbRedisPrÙocŞToHumª
(
o
,p);

2018 ià(
j
 !ğ
mbulkËn
-1è*
o
 = 
	`sdsÿ’
(*o,",",1);

2020 *
o
 = 
	`sdsÿ’
(*o,"]",1);

2021  
p
;

2022 
	}
}

2027 
	$ldbLogRedisR•ly
(*
»¶y
) {

2028 
sds
 
log
 = 
	`sd¢ew
("<reply> ");

2029 
	`ldbRedisPrÙocŞToHumª
(&
log
,
»¶y
);

2030 
	`ldbLogW™hMaxL’
(
log
);

2031 
	}
}

2036 
	$ldbPršt
(
lua_S‹
 *
lua
, *
v¬Çme
) {

2037 
lua_Debug
 
¬
;

2039 
l
 = 0;

2040 
	`lua_g‘¡ack
(
lua
,
l
,&
¬
) != 0) {

2041 
l
++;

2042 cÚ¡ *
Çme
;

2043 
i
 = 1;

2044 (
Çme
 = 
	`lua_g‘loÿl
(
lua
,&
¬
,
i
)è!ğ
NULL
) {

2045 
i
++;

2046 ià(
	`¡rcmp
(
v¬Çme
,
Çme
) == 0) {

2047 
	`ldbLogSckV®ue
(
lua
,"<value> ");

2048 
	`lua_pİ
(
lua
,1);

2051 
	`lua_pİ
(
lua
,1);

2057 ià(!
	`¡rcmp
(
v¬Çme
,"ARGV") || !strcmp(varname,"KEYS")) {

2058 
	`lua_g‘glob®
(
lua
, 
v¬Çme
);

2059 
	`ldbLogSckV®ue
(
lua
,"<value> ");

2060 
	`lua_pİ
(
lua
,1);

2062 
	`ldbLog
(
	`sd¢ew
("No such variable."));

2064 
	}
}

2068 
	$ldbPrštAÎ
(
lua_S‹
 *
lua
) {

2069 
lua_Debug
 
¬
;

2070 
v¬s
 = 0;

2072 ià(
	`lua_g‘¡ack
(
lua
,0,&
¬
) != 0) {

2073 cÚ¡ *
Çme
;

2074 
i
 = 1;

2075 (
Çme
 = 
	`lua_g‘loÿl
(
lua
,&
¬
,
i
)è!ğ
NULL
) {

2076 
i
++;

2077 ià(!
	`¡r¡r
(
Çme
,"(*temporary)")) {

2078 
sds
 
´efix
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"<v®ue> % ğ",
Çme
);

2079 
	`ldbLogSckV®ue
(
lua
,
´efix
);

2080 
	`sdsä“
(
´efix
);

2081 
v¬s
++;

2083 
	`lua_pİ
(
lua
,1);

2087 ià(
v¬s
 == 0) {

2088 
	`ldbLog
(
	`sd¢ew
("No†ocal variables inhe current context."));

2090 
	}
}

2093 
	$ldbB»ak
(
sds
 *
¬gv
, 
¬gc
) {

2094 ià(
¬gc
 == 1) {

2095 ià(
ldb
.
bpcouÁ
 == 0) {

2096 
	`ldbLog
(
	`sd¢ew
("No breakpoints set. Use 'b <line>'o‡dd one."));

2099 
	`ldbLog
(
	`sdsÿtfmt
(
	`sd£m±y
(),"%˜b»akpošt £t:",
ldb
.
bpcouÁ
));

2100 
j
;

2101 
j
 = 0; j < 
ldb
.
bpcouÁ
; j++)

2102 
	`ldbLogSourûLše
(
ldb
.
bp
[
j
]);

2105 
j
;

2106 
j
 = 1; j < 
¬gc
; j++) {

2107 *
¬g
 = 
¬gv
[
j
];

2108 
lše
;

2109 ià(!
	`¡ršg2l
(
¬g
,
	`sd¦’
×rg),&
lše
)) {

2110 
	`ldbLog
(
	`sdsÿtfmt
(
	`sd£m±y
(),"Inv®id‡rgum’t:'%s'",
¬g
));

2112 ià(
lše
 == 0) {

2113 
ldb
.
bpcouÁ
 = 0;

2114 
	`ldbLog
(
	`sd¢ew
("All breakpoints„emoved."));

2115 } ià(
lše
 > 0) {

2116 ià(
ldb
.
bpcouÁ
 =ğ
LDB_BREAKPOINTS_MAX
) {

2117 
	`ldbLog
(
	`sd¢ew
("Too many breakpoints set."));

2118 } ià(
	`ldbAddB»akpošt
(
lše
)) {

2119 
	`ldbLi¡
(
lše
,1);

2121 
	`ldbLog
(
	`sd¢ew
("Wrong†ine‚umber."));

2123 } ià(
lše
 < 0) {

2124 ià(
	`ldbD–B»akpošt
(-
lše
))

2125 
	`ldbLog
(
	`sd¢ew
("Breakpoint„emoved."));

2127 
	`ldbLog
(
	`sd¢ew
("No breakpoint inhe specified†ine."));

2132 
	}
}

2137 
	$ldbEv®
(
lua_S‹
 *
lua
, 
sds
 *
¬gv
, 
¬gc
) {

2139 
sds
 
code
 = 
	`sdsjošsds
(
¬gv
+1,
¬gc
-1," ",1);

2140 
sds
 
ex´
 = 
	`sdsÿtsds
(
	`sd¢ew
("»tuº "),
code
);

2143 ià(
	`luaL_lßdbufãr
(
lua
,
ex´
,
	`sd¦’
(expr),"@ldb_eval")) {

2144 
	`lua_pİ
(
lua
,1);

2146 ià(
	`luaL_lßdbufãr
(
lua
,
code
,
	`sd¦’
(code),"@ldb_eval")) {

2147 
	`ldbLog
(
	`sdsÿtfmt
(
	`sd£m±y
(),"<”rÜ> %s",
	`lua_to¡ršg
(
lua
,-1)));

2148 
	`lua_pİ
(
lua
,1);

2149 
	`sdsä“
(
code
);

2155 
	`sdsä“
(
code
);

2156 
	`sdsä“
(
ex´
);

2157 ià(
	`lua_pÿÎ
(
lua
,0,1,0)) {

2158 
	`ldbLog
(
	`sdsÿtfmt
(
	`sd£m±y
(),"<”rÜ> %s",
	`lua_to¡ršg
(
lua
,-1)));

2159 
	`lua_pİ
(
lua
,1);

2162 
	`ldbLogSckV®ue
(
lua
,"<retval> ");

2163 
	`lua_pİ
(
lua
,1);

2164 
	}
}

2170 
	$ldbRedis
(
lua_S‹
 *
lua
, 
sds
 *
¬gv
, 
¬gc
) {

2171 
j
, 
§ved_rc
 = 
£rv”
.
lua_»¶iÿ‹_commªds
;

2173 
	`lua_g‘glob®
(
lua
,"redis");

2174 
	`lua_push¡ršg
(
lua
,"call");

2175 
	`lua_g‘bË
(
lua
,-2);

2176 
j
 = 1; j < 
¬gc
; j++)

2177 
	`lua_pushl¡ršg
(
lua
,
¬gv
[
j
],
	`sd¦’
(argv[j]));

2178 
ldb
.
¡•
 = 1;

2179 
£rv”
.
lua_»¶iÿ‹_commªds
 = 1;

2180 
	`lua_pÿÎ
(
lua
,
¬gc
-1,1,0);

2181 
ldb
.
¡•
 = 0;

2182 
£rv”
.
lua_»¶iÿ‹_commªds
 = 
§ved_rc
;

2183 
	`lua_pİ
(
lua
,2);

2184 
	}
}

2188 
	$ldbT¿û
(
lua_S‹
 *
lua
) {

2189 
lua_Debug
 
¬
;

2190 
Ëv–
 = 0;

2192 
	`lua_g‘¡ack
(
lua
,
Ëv–
,&
¬
)) {

2193 
	`lua_g‘šfo
(
lua
,"SÆ",&
¬
);

2194 if(
	`¡r¡r
(
¬
.
shÜt_¤c
,"u£r_süt"è!ğ
NULL
) {

2195 
	`ldbLog
(
	`sdsÿrštf
(
	`sd£m±y
(),"%s %s:",

2196 (
Ëv–
 == 0) ? "In" : "From",

2197 
¬
.
Çme
 ?‡r.name : "top†evel"));

2198 
	`ldbLogSourûLše
(
¬
.
cu¼’še
);

2200 
Ëv–
++;

2202 ià(
Ëv–
 == 0) {

2203 
	`ldbLog
(
	`sd¢ew
("<error> Can't„etrieve Lua stack."));

2205 
	}
}

2209 
	$ldbMaxËn
(
sds
 *
¬gv
, 
¬gc
) {

2210 ià(
¬gc
 == 2) {

2211 
Ãwv®
 = 
	`©oi
(
¬gv
[1]);

2212 
ldb
.
maxËn_hšt_£Á
 = 1;

2213 ià(
Ãwv®
 != 0 &&‚ewval <= 60)‚ewval = 60;

2214 
ldb
.
maxËn
 = 
Ãwv®
;

2216 ià(
ldb
.
maxËn
) {

2217 
	`ldbLog
(
	`sdsÿrštf
(
	`sd£m±y
(),"<v®ue>„•l› ¬Œunÿ‹d‡ˆ%d by‹s.",()
ldb
.
maxËn
));

2219 
	`ldbLog
(
	`sdsÿrštf
(
	`sd£m±y
(),"<value>„eplies‡re unlimited."));

2221 
	}
}

2226 
	$ldbR•l
(
lua_S‹
 *
lua
) {

2227 
sds
 *
¬gv
;

2228 
¬gc
;

2233 (
¬gv
 = 
	`ldbR•lP¬£Commªd
(&
¬gc
)è=ğ
NULL
) {

2234 
buf
[1024];

2235 
Ä—d
 = 
	`»ad
(
ldb
.
fd
,
buf
,(buf));

2236 ià(
Ä—d
 <= 0) {

2239 
ldb
.
¡•
 = 0;

2240 
ldb
.
bpcouÁ
 = 0;

2241  
C_ERR
;

2243 
ldb
.
cbuf
 = 
	`sdsÿ’
Ödb.cbuf,
buf
,
Ä—d
);

2247 
	`sdsä“
(
ldb
.
cbuf
);

2248 
ldb
.
cbuf
 = 
	`sd£m±y
();

2251 ià(!
	`¡rÿ£cmp
(
¬gv
[0],"h") || !strcasecmp(argv[0],"help")) {

2252 
	`ldbLog
(
	`sd¢ew
("Redis Lua debugger help:"));

2253 
	`ldbLog
(
	`sd¢ew
("[h]elp Showhis help."));

2254 
	`ldbLog
(
	`sd¢ew
("[s]tep Run current†ine‡nd stop‡gain."));

2255 
	`ldbLog
(
	`sd¢ew
("[n]ext Alias for step."));

2256 
	`ldbLog
(
	`sd¢ew
("[c]continue Runill‚ext breakpoint."));

2257 
	`ldbLog
(
	`sd¢ew
("[l]list List source code‡round current†ine."));

2258 
	`ldbLog
(
	`sd¢ew
("[l]list [line] List source code‡round [line]."));

2259 
	`ldbLog
(
	`sd¢ew
("†ine = 0 means: current…osition."));

2260 
	`ldbLog
(
	`sd¢ew
("[l]list [line] [ctx] Inhis form [ctx] specifies how many†ines"));

2261 
	`ldbLog
(
	`sd¢ew
("o show before/after [line]."));

2262 
	`ldbLog
(
	`sd¢ew
("[w]hole List‡ll source code. Alias for 'list 1 1000000'."));

2263 
	`ldbLog
(
	`sd¢ew
("[p]rint Show‡llhe†ocal variables."));

2264 
	`ldbLog
(
	`sd¢ew
("[p]rint <var> Showhe value ofhe specified variable."));

2265 
	`ldbLog
(
	`sd¢ew
(" Can‡lso show global vars KEYS‡nd ARGV."));

2266 
	`ldbLog
(
	`sd¢ew
("[b]reak Show‡ll breakpoints."));

2267 
	`ldbLog
(
	`sd¢ew
("[b]reak <line> Add‡ breakpointohe specified†ine."));

2268 
	`ldbLog
(
	`sd¢ew
("[b]reak -<line> Remove breakpoint fromhe specified†ine."));

2269 
	`ldbLog
(
	`sd¢ew
("[b]reak 0 Remove‡ll breakpoints."));

2270 
	`ldbLog
(
	`sd¢ew
("[t]race Show‡ backtrace."));

2271 
	`ldbLog
(
	`sd¢ew
("[e]eval <code> Execute some Lua code (in‡ different callframe)."));

2272 
	`ldbLog
(
	`sd¢ew
("[r]edis <cmd> Execute‡ Redis command."));

2273 
	`ldbLog
(
	`sd¢ew
("[m]axlen [len] Trim†ogged Redis„eplies‡nd Lua var dumpso†en."));

2274 
	`ldbLog
(
	`sd¢ew
(" Specifying zero‡s <len> means unlimited."));

2275 
	`ldbLog
(
	`sd¢ew
("[a]bort Stopheƒxecution ofhe script. In sync"));

2276 
	`ldbLog
(
	`sd¢ew
(" mode dataset changes will be„etained."));

2277 
	`ldbLog
(
	`sd¢ew
(""));

2278 
	`ldbLog
(
	`sd¢ew
("Debugger functions you can call from Lua scripts:"));

2279 
	`ldbLog
(
	`sd¢ew
("redis.debug() Produce†ogs inhe debugger console."));

2280 
	`ldbLog
(
	`sd¢ew
("redis.breakpoint() Stopƒxecution†ike ifhere was‡ breakpoing."));

2281 
	`ldbLog
(
	`sd¢ew
(" inhe‚ext†ine of code."));

2282 
	`ldbS’dLogs
();

2283 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"s") || !strcasecmp(argv[0],"step") ||

2284 !
	`¡rÿ£cmp
(
¬gv
[0],"n") || !strcasecmp(argv[0],"next")) {

2285 
ldb
.
¡•
 = 1;

2287 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"c") || !strcasecmp(argv[0],"continue")){

2289 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"t") || !strcasecmp(argv[0],"trace")) {

2290 
	`ldbT¿û
(
lua
);

2291 
	`ldbS’dLogs
();

2292 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"m") || !strcasecmp(argv[0],"maxlen")) {

2293 
	`ldbMaxËn
(
¬gv
,
¬gc
);

2294 
	`ldbS’dLogs
();

2295 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"b") || !strcasecmp(argv[0],"break")) {

2296 
	`ldbB»ak
(
¬gv
,
¬gc
);

2297 
	`ldbS’dLogs
();

2298 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"e") || !strcasecmp(argv[0],"eval")) {

2299 
	`ldbEv®
(
lua
,
¬gv
,
¬gc
);

2300 
	`ldbS’dLogs
();

2301 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"a") || !strcasecmp(argv[0],"abort")) {

2302 
	`lua_push¡ršg
(
lua
, "script‡borted for user„equest");

2303 
	`lua_”rÜ
(
lua
);

2304 } ià(
¬gc
 > 1 &&

2305 (!
	`¡rÿ£cmp
(
¬gv
[0],"r") || !strcasecmp(argv[0],"redis"))) {

2306 
	`ldbRedis
(
lua
,
¬gv
,
¬gc
);

2307 
	`ldbS’dLogs
();

2308 } ià((!
	`¡rÿ£cmp
(
¬gv
[0],"p") || !strcasecmp(argv[0],"print"))) {

2309 ià(
¬gc
 == 2)

2310 
	`ldbPršt
(
lua
,
¬gv
[1]);

2312 
	`ldbPrštAÎ
(
lua
);

2313 
	`ldbS’dLogs
();

2314 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"l") || !strcasecmp(argv[0],"list")){

2315 
¬ound
 = 
ldb
.
cu¼’še
, 
ùx
 = 5;

2316 ià(
¬gc
 > 1) {

2317 
num
 = 
	`©oi
(
¬gv
[1]);

2318 ià(
num
 > 0è
¬ound
 =‚um;

2320 ià(
¬gc
 > 2è
ùx
 = 
	`©oi
(
¬gv
[2]);

2321 
	`ldbLi¡
(
¬ound
,
ùx
);

2322 
	`ldbS’dLogs
();

2323 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"w") || !strcasecmp(argv[0],"whole")){

2324 
	`ldbLi¡
(1,1000000);

2325 
	`ldbS’dLogs
();

2327 
	`ldbLog
(
	`sd¢ew
("<error> Unknown Redis Lua debugger command or "

2329 
	`ldbS’dLogs
();

2333 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

2337 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

2338  
C_OK
;

2339 
	}
}

2343 
	$luaLdbLšeHook
(
lua_S‹
 *
lua
, 
lua_Debug
 *
¬
) {

2344 
	`lua_g‘¡ack
(
lua
,0,
¬
);

2345 
	`lua_g‘šfo
(
lua
,"Sl",
¬
);

2346 
ldb
.
cu¼’še
 = 
¬
->currentline;

2348 
bp
 = 
	`ldbIsB»akpošt
(
ldb
.
cu¼’še
è||†db.
luabp
;

2349 
timeout
 = 0;

2352 if(
	`¡r¡r
(
¬
->
shÜt_¤c
,"u£r_süt"è=ğ
NULL
) ;

2355 ià(
¬
->
ev’t
 =ğ
LUA_HOOKCOUNT
 && 
ldb
.
¡•
 =ğ0 && 
bp
 == 0) {

2356 
m¡ime_t
 
–­£d
 = 
	`m¡ime
(è- 
£rv”
.
lua_time_¡¬t
;

2357 
m¡ime_t
 
tim–im™
 = 
£rv”
.
lua_time_lim™
 ?

2358 
£rv”
.
lua_time_lim™
 : 5000;

2359 ià(
–­£d
 >ğ
tim–im™
) {

2360 
timeout
 = 1;

2361 
ldb
.
¡•
 = 1;

2367 ià(
ldb
.
¡•
 || 
bp
) {

2368 *
»asÚ
 = "step over";

2369 ià(
bp
è
»asÚ
 = 
ldb
.
luabp
 ? "redis.breakpoint() called" :

2371 ià(
timeout
è
»asÚ
 = "timeout„eached, infinite†oop?";

2372 
ldb
.
¡•
 = 0;

2373 
ldb
.
luabp
 = 0;

2374 
	`ldbLog
(
	`sdsÿrštf
(
	`sd£m±y
(),

2376 
ldb
.
cu¼’še
, 
»asÚ
));

2377 
	`ldbLogSourûLše
(
ldb
.
cu¼’še
);

2378 
	`ldbS’dLogs
();

2379 ià(
	`ldbR•l
(
lua
è=ğ
C_ERR
 && 
timeout
) {

2383 
	`lua_push¡ršg
(
lua
, "timeout during Lua debugging with client closing connection");

2384 
	`lua_”rÜ
(
lua
);

2386 
£rv”
.
lua_time_¡¬t
 = 
	`m¡ime
();

2388 
	}
}

	@sds.c

33 
	~<¡dio.h
>

34 
	~<¡dlib.h
>

35 
	~<¡ršg.h
>

36 
	~<ùy³.h
>

37 
	~<as£¹.h
>

38 
	~<lim™s.h
>

39 
	~"sds.h
"

40 
	~"sd§Îoc.h
"

42 
šlše
 
	$sdsHdrSize
(
ty³
) {

43 
ty³
&
SDS_TYPE_MASK
) {

44 
SDS_TYPE_5
:

45  (
sdshdr5
);

46 
SDS_TYPE_8
:

47  (
sdshdr8
);

48 
SDS_TYPE_16
:

49  (
sdshdr16
);

50 
SDS_TYPE_32
:

51  (
sdshdr32
);

52 
SDS_TYPE_64
:

53  (
sdshdr64
);

56 
	}
}

58 
šlše
 
	$sdsReqTy³
(
size_t
 
¡ršg_size
) {

59 ià(
¡ršg_size
 < 1<<5)

60  
SDS_TYPE_5
;

61 ià(
¡ršg_size
 < 1<<8)

62  
SDS_TYPE_8
;

63 ià(
¡ršg_size
 < 1<<16)

64  
SDS_TYPE_16
;

65 #ià(
LONG_MAX
 =ğ
LLONG_MAX
)

66 ià(
¡ršg_size
 < 1ll<<32)

67  
SDS_TYPE_32
;

69  
SDS_TYPE_64
;

70 
	}
}

84 
sds
 
	$sd¢ewËn
(cÚ¡ *
š™
, 
size_t
 
š™Ën
) {

85 *
sh
;

86 
sds
 
s
;

87 
ty³
 = 
	`sdsReqTy³
(
š™Ën
);

90 ià(
ty³
 =ğ
SDS_TYPE_5
 && 
š™Ën
 =ğ0èty³ = 
SDS_TYPE_8
;

91 
hd¾’
 = 
	`sdsHdrSize
(
ty³
);

92 *
å
;

94 
sh
 = 
	`s_m®loc
(
hd¾’
+
š™Ën
+1);

95 ià(!
š™
)

96 
	`mem£t
(
sh
, 0, 
hd¾’
+
š™Ën
+1);

97 ià(
sh
 =ğ
NULL
)  NULL;

98 
s
 = (*)
sh
+
hd¾’
;

99 
å
 = ((*)
s
)-1;

100 
ty³
) {

101 
SDS_TYPE_5
: {

102 *
å
 = 
ty³
 | (
š™Ën
 << 
SDS_TYPE_BITS
);

105 
SDS_TYPE_8
: {

106 
	`SDS_HDR_VAR
(8,
s
);

107 
sh
->
Ën
 = 
š™Ën
;

108 
sh
->
®loc
 = 
š™Ën
;

109 *
å
 = 
ty³
;

112 
SDS_TYPE_16
: {

113 
	`SDS_HDR_VAR
(16,
s
);

114 
sh
->
Ën
 = 
š™Ën
;

115 
sh
->
®loc
 = 
š™Ën
;

116 *
å
 = 
ty³
;

119 
SDS_TYPE_32
: {

120 
	`SDS_HDR_VAR
(32,
s
);

121 
sh
->
Ën
 = 
š™Ën
;

122 
sh
->
®loc
 = 
š™Ën
;

123 *
å
 = 
ty³
;

126 
SDS_TYPE_64
: {

127 
	`SDS_HDR_VAR
(64,
s
);

128 
sh
->
Ën
 = 
š™Ën
;

129 
sh
->
®loc
 = 
š™Ën
;

130 *
å
 = 
ty³
;

134 ià(
š™Ën
 && 
š™
)

135 
	`memıy
(
s
, 
š™
, 
š™Ën
);

136 
s
[
š™Ën
] = '\0';

137  
s
;

138 
	}
}

142 
sds
 
	$sd£m±y
() {

143  
	`sd¢ewËn
("",0);

144 
	}
}

147 
sds
 
	$sd¢ew
(cÚ¡ *
š™
) {

148 
size_t
 
š™Ën
 = (
š™
 =ğ
NULL
è? 0 : 
	`¡¾’
(init);

149  
	`sd¢ewËn
(
š™
, 
š™Ën
);

150 
	}
}

153 
sds
 
	$sdsdup
(cÚ¡ 
sds
 
s
) {

154  
	`sd¢ewËn
(
s
, 
	`sd¦’
(s));

155 
	}
}

158 
	$sdsä“
(
sds
 
s
) {

159 ià(
s
 =ğ
NULL
) ;

160 
	`s_ä“
((*)
s
-
	`sdsHdrSize
(s[-1]));

161 
	}
}

177 
	$sdsupd©–’
(
sds
 
s
) {

178 
»®Ën
 = 
	`¡¾’
(
s
);

179 
	`sds£’
(
s
, 
»®Ën
);

180 
	}
}

186 
	$sdsş—r
(
sds
 
s
) {

187 
	`sds£’
(
s
, 0);

188 
s
[0] = '\0';

189 
	}
}

197 
sds
 
	$sdsMakeRoomFÜ
(
sds
 
s
, 
size_t
 
addËn
) {

198 *
sh
, *
Ãwsh
;

199 
size_t
 
ava
 = 
	`sd§va
(
s
);

200 
size_t
 
Ën
, 
ÃwËn
;

201 
ty³
, 
Şdty³
 = 
s
[-1] & 
SDS_TYPE_MASK
;

202 
hd¾’
;

205 ià(
ava
 >ğ
addËn
è 
s
;

207 
Ën
 = 
	`sd¦’
(
s
);

208 
sh
 = (*)
s
-
	`sdsHdrSize
(
Şdty³
);

209 
ÃwËn
 = (
Ën
+
addËn
);

210 ià(
ÃwËn
 < 
SDS_MAX_PREALLOC
)

211 
ÃwËn
 *= 2;

213 
ÃwËn
 +ğ
SDS_MAX_PREALLOC
;

215 
ty³
 = 
	`sdsReqTy³
(
ÃwËn
);

220 ià(
ty³
 =ğ
SDS_TYPE_5
èty³ = 
SDS_TYPE_8
;

222 
hd¾’
 = 
	`sdsHdrSize
(
ty³
);

223 ià(
Şdty³
==
ty³
) {

224 
Ãwsh
 = 
	`s_»®loc
(
sh
, 
hd¾’
+
ÃwËn
+1);

225 ià(
Ãwsh
 =ğ
NULL
)  NULL;

226 
s
 = (*)
Ãwsh
+
hd¾’
;

230 
Ãwsh
 = 
	`s_m®loc
(
hd¾’
+
ÃwËn
+1);

231 ià(
Ãwsh
 =ğ
NULL
)  NULL;

232 
	`memıy
((*)
Ãwsh
+
hd¾’
, 
s
, 
Ën
+1);

233 
	`s_ä“
(
sh
);

234 
s
 = (*)
Ãwsh
+
hd¾’
;

235 
s
[-1] = 
ty³
;

236 
	`sds£’
(
s
, 
Ën
);

238 
	`sds£Îoc
(
s
, 
ÃwËn
);

239  
s
;

240 
	}
}

248 
sds
 
	$sdsRemoveF»eS·û
(
sds
 
s
) {

249 *
sh
, *
Ãwsh
;

250 
ty³
, 
Şdty³
 = 
s
[-1] & 
SDS_TYPE_MASK
;

251 
hd¾’
;

252 
size_t
 
Ën
 = 
	`sd¦’
(
s
);

253 
sh
 = (*)
s
-
	`sdsHdrSize
(
Şdty³
);

255 
ty³
 = 
	`sdsReqTy³
(
Ën
);

256 
hd¾’
 = 
	`sdsHdrSize
(
ty³
);

257 ià(
Şdty³
==
ty³
) {

258 
Ãwsh
 = 
	`s_»®loc
(
sh
, 
hd¾’
+
Ën
+1);

259 ià(
Ãwsh
 =ğ
NULL
)  NULL;

260 
s
 = (*)
Ãwsh
+
hd¾’
;

262 
Ãwsh
 = 
	`s_m®loc
(
hd¾’
+
Ën
+1);

263 ià(
Ãwsh
 =ğ
NULL
)  NULL;

264 
	`memıy
((*)
Ãwsh
+
hd¾’
, 
s
, 
Ën
+1);

265 
	`s_ä“
(
sh
);

266 
s
 = (*)
Ãwsh
+
hd¾’
;

267 
s
[-1] = 
ty³
;

268 
	`sds£’
(
s
, 
Ën
);

270 
	`sds£Îoc
(
s
, 
Ën
);

271  
s
;

272 
	}
}

281 
size_t
 
	$sdsAÎocSize
(
sds
 
s
) {

282 
size_t
 
®loc
 = 
	`sd§Îoc
(
s
);

283  
	`sdsHdrSize
(
s
[-1])+
®loc
+1;

284 
	}
}

288 *
	$sdsAÎocPŒ
(
sds
 
s
) {

289  (*è(
s
-
	`sdsHdrSize
(s[-1]));

290 
	}
}

315 
	$sdsInüL’
(
sds
 
s
, 
šü
) {

316 
æags
 = 
s
[-1];

317 
size_t
 
Ën
;

318 
æags
&
SDS_TYPE_MASK
) {

319 
SDS_TYPE_5
: {

320 *
å
 = ((*)
s
)-1;

321 
ŞdËn
 = 
	`SDS_TYPE_5_LEN
(
æags
);

322 
	`as£¹
((
šü
 > 0 && 
ŞdËn
+incr < 32) || (incr < 0 && oldlen >= ()(-incr)));

323 *
å
 = 
SDS_TYPE_5
 | ((
ŞdËn
+
šü
è<< 
SDS_TYPE_BITS
);

324 
Ën
 = 
ŞdËn
+
šü
;

327 
SDS_TYPE_8
: {

328 
	`SDS_HDR_VAR
(8,
s
);

329 
	`as£¹
((
šü
 >ğ0 && 
sh
->
®loc
-sh->
Ën
 >= incr) || (incr < 0 && sh->len >= ()(-incr)));

330 
Ën
 = (
sh
->ËÀ+ğ
šü
);

333 
SDS_TYPE_16
: {

334 
	`SDS_HDR_VAR
(16,
s
);

335 
	`as£¹
((
šü
 >ğ0 && 
sh
->
®loc
-sh->
Ën
 >= incr) || (incr < 0 && sh->len >= ()(-incr)));

336 
Ën
 = (
sh
->ËÀ+ğ
šü
);

339 
SDS_TYPE_32
: {

340 
	`SDS_HDR_VAR
(32,
s
);

341 
	`as£¹
((
šü
 >ğ0 && 
sh
->
®loc
-sh->
Ën
 >= ()incr) || (incr < 0 && sh->len >= ()(-incr)));

342 
Ën
 = (
sh
->ËÀ+ğ
šü
);

345 
SDS_TYPE_64
: {

346 
	`SDS_HDR_VAR
(64,
s
);

347 
	`as£¹
((
šü
 >ğ0 && 
sh
->
®loc
-sh->
Ën
 >ğ(
ušt64_t
)incr) || (incr < 0 && sh->len >= (uint64_t)(-incr)));

348 
Ën
 = (
sh
->ËÀ+ğ
šü
);

351 : 
Ën
 = 0;

353 
s
[
Ën
] = '\0';

354 
	}
}

361 
sds
 
	$sdsgrowz”o
(
sds
 
s
, 
size_t
 
Ën
) {

362 
size_t
 
cu¾’
 = 
	`sd¦’
(
s
);

364 ià(
Ën
 <ğ
cu¾’
è 
s
;

365 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
-
cu¾’
);

366 ià(
s
 =ğ
NULL
)  NULL;

369 
	`mem£t
(
s
+
cu¾’
,0,(
Ën
-curlen+1));

370 
	`sds£’
(
s
, 
Ën
);

371  
s
;

372 
	}
}

379 
sds
 
	$sdsÿ’
(
sds
 
s
, cÚ¡ *
t
, 
size_t
 
Ën
) {

380 
size_t
 
cu¾’
 = 
	`sd¦’
(
s
);

382 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
);

383 ià(
s
 =ğ
NULL
)  NULL;

384 
	`memıy
(
s
+
cu¾’
, 
t
, 
Ën
);

385 
	`sds£’
(
s
, 
cu¾’
+
Ën
);

386 
s
[
cu¾’
+
Ën
] = '\0';

387  
s
;

388 
	}
}

394 
sds
 
	$sdsÿt
(
sds
 
s
, cÚ¡ *
t
) {

395  
	`sdsÿ’
(
s
, 
t
, 
	`¡¾’
(t));

396 
	}
}

402 
sds
 
	$sdsÿtsds
(
sds
 
s
, cÚ¡ sd 
t
) {

403  
	`sdsÿ’
(
s
, 
t
, 
	`sd¦’
(t));

404 
	}
}

408 
sds
 
	$sdsıyËn
(
sds
 
s
, cÚ¡ *
t
, 
size_t
 
Ën
) {

409 ià(
	`sd§Îoc
(
s
è< 
Ën
) {

410 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
-
	`sd¦’
(s));

411 ià(
s
 =ğ
NULL
)  NULL;

413 
	`memıy
(
s
, 
t
, 
Ën
);

414 
s
[
Ën
] = '\0';

415 
	`sds£’
(
s
, 
Ën
);

416  
s
;

417 
	}
}

421 
sds
 
	$sdsıy
(
sds
 
s
, cÚ¡ *
t
) {

422  
	`sdsıyËn
(
s
, 
t
, 
	`¡¾’
(t));

423 
	}
}

431 
	#SDS_LLSTR_SIZE
 21

	)

432 
	$sd¦l2¡r
(*
s
, 
v®ue
) {

433 *
p
, 
aux
;

434 
v
;

435 
size_t
 
l
;

439 
v
 = (
v®ue
 < 0) ? -value : value;

440 
p
 = 
s
;

442 *
p
++ = '0'+(
v
%10);

443 
v
 /= 10;

444 } 
v
);

445 ià(
v®ue
 < 0è*
p
++ = '-';

448 
l
 = 
p
-
s
;

449 *
p
 = '\0';

452 
p
--;

453 
s
 < 
p
) {

454 
aux
 = *
s
;

455 *
s
 = *
p
;

456 *
p
 = 
aux
;

457 
s
++;

458 
p
--;

460  
l
;

461 
	}
}

464 
	$sdsuÎ2¡r
(*
s
, 
v
) {

465 *
p
, 
aux
;

466 
size_t
 
l
;

470 
p
 = 
s
;

472 *
p
++ = '0'+(
v
%10);

473 
v
 /= 10;

474 } 
v
);

477 
l
 = 
p
-
s
;

478 *
p
 = '\0';

481 
p
--;

482 
s
 < 
p
) {

483 
aux
 = *
s
;

484 *
s
 = *
p
;

485 *
p
 = 
aux
;

486 
s
++;

487 
p
--;

489  
l
;

490 
	}
}

496 
sds
 
	$sdsäomlÚglÚg
(
v®ue
) {

497 
buf
[
SDS_LLSTR_SIZE
];

498 
Ën
 = 
	`sd¦l2¡r
(
buf
,
v®ue
);

500  
	`sd¢ewËn
(
buf
,
Ën
);

501 
	}
}

504 
sds
 
	$sdsÿtv´štf
(
sds
 
s
, cÚ¡ *
fmt
, 
va_li¡
 
­
) {

505 
va_li¡
 
ıy
;

506 
¡©icbuf
[1024], *
buf
 = sticbuf, *
t
;

507 
size_t
 
buæ’
 = 
	`¡¾’
(
fmt
)*2;

511 ià(
buæ’
 > (
¡©icbuf
)) {

512 
buf
 = 
	`s_m®loc
(
buæ’
);

513 ià(
buf
 =ğ
NULL
)  NULL;

515 
buæ’
 = (
¡©icbuf
);

521 
buf
[
buæ’
-2] = '\0';

522 
	`va_cİy
(
ıy
,
­
);

523 
	`v¢´štf
(
buf
, 
buæ’
, 
fmt
, 
ıy
);

524 
	`va_’d
(
ıy
);

525 ià(
buf
[
buæ’
-2] != '\0') {

526 ià(
buf
 !ğ
¡©icbuf
è
	`s_ä“
(buf);

527 
buæ’
 *= 2;

528 
buf
 = 
	`s_m®loc
(
buæ’
);

529 ià(
buf
 =ğ
NULL
)  NULL;

536 
t
 = 
	`sdsÿt
(
s
, 
buf
);

537 ià(
buf
 !ğ
¡©icbuf
è
	`s_ä“
(buf);

538  
t
;

539 
	}
}

557 
sds
 
	$sdsÿrštf
(
sds
 
s
, cÚ¡ *
fmt
, ...) {

558 
va_li¡
 
­
;

559 *
t
;

560 
	`va_¡¬t
(
­
, 
fmt
);

561 
t
 = 
	`sdsÿtv´štf
(
s
,
fmt
,
­
);

562 
	`va_’d
(
­
);

563  
t
;

564 
	}
}

582 
sds
 
	$sdsÿtfmt
(
sds
 
s
, cÚ¡ *
fmt
, ...) {

583 
size_t
 
š™Ën
 = 
	`sd¦’
(
s
);

584 cÚ¡ *
f
 = 
fmt
;

585 
i
;

586 
va_li¡
 
­
;

588 
	`va_¡¬t
(
­
,
fmt
);

589 
f
 = 
fmt
;

590 
i
 = 
š™Ën
;

591 *
f
) {

592 
Ãxt
, *
¡r
;

593 
size_t
 
l
;

594 
num
;

595 
unum
;

598 ià(
	`sd§va
(
s
)==0) {

599 
s
 = 
	`sdsMakeRoomFÜ
(s,1);

602 *
f
) {

604 
Ãxt
 = *(
f
+1);

605 
f
++;

606 
Ãxt
) {

609 
¡r
 = 
	`va_¬g
(
­
,*);

610 
l
 = (
Ãxt
 =ğ's'è? 
	`¡¾’
(
¡r
è: 
	`sd¦’
(str);

611 ià(
	`sd§va
(
s
è< 
l
) {

612 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

614 
	`memıy
(
s
+
i
,
¡r
,
l
);

615 
	`sdsšş’
(
s
,
l
);

616 
i
 +ğ
l
;

620 ià(
Ãxt
 == 'i')

621 
num
 = 
	`va_¬g
(
­
,);

623 
num
 = 
	`va_¬g
(
­
,);

625 
buf
[
SDS_LLSTR_SIZE
];

626 
l
 = 
	`sd¦l2¡r
(
buf
,
num
);

627 ià(
	`sd§va
(
s
è< 
l
) {

628 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

630 
	`memıy
(
s
+
i
,
buf
,
l
);

631 
	`sdsšş’
(
s
,
l
);

632 
i
 +ğ
l
;

637 ià(
Ãxt
 == 'u')

638 
unum
 = 
	`va_¬g
(
­
,);

640 
unum
 = 
	`va_¬g
(
­
,);

642 
buf
[
SDS_LLSTR_SIZE
];

643 
l
 = 
	`sdsuÎ2¡r
(
buf
,
unum
);

644 ià(
	`sd§va
(
s
è< 
l
) {

645 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

647 
	`memıy
(
s
+
i
,
buf
,
l
);

648 
	`sdsšş’
(
s
,
l
);

649 
i
 +ğ
l
;

653 
s
[
i
++] = 
Ãxt
;

654 
	`sdsšş’
(
s
,1);

659 
s
[
i
++] = *
f
;

660 
	`sdsšş’
(
s
,1);

663 
f
++;

665 
	`va_’d
(
­
);

668 
s
[
i
] = '\0';

669  
s
;

670 
	}
}

686 
sds
 
	$sd¡rim
(
sds
 
s
, cÚ¡ *
c£t
) {

687 *
¡¬t
, *
’d
, *
¥
, *
•
;

688 
size_t
 
Ën
;

690 
¥
 = 
¡¬t
 = 
s
;

691 
•
 = 
’d
 = 
s
+
	`sd¦’
(s)-1;

692 
¥
 <ğ
’d
 && 
	`¡rchr
(
c£t
, *sp)) sp++;

693 
•
 > 
¥
 && 
	`¡rchr
(
c£t
, *ep))ƒp--;

694 
Ën
 = (
¥
 > 
•
) ? 0 : ((ep-sp)+1);

695 ià(
s
 !ğ
¥
è
	`memmove
(s, sp, 
Ën
);

696 
s
[
Ën
] = '\0';

697 
	`sds£’
(
s
,
Ën
);

698  
s
;

699 
	}
}

717 
	$sd¤ªge
(
sds
 
s
, 
¡¬t
, 
’d
) {

718 
size_t
 
ÃwËn
, 
Ën
 = 
	`sd¦’
(
s
);

720 ià(
Ën
 == 0) ;

721 ià(
¡¬t
 < 0) {

722 
¡¬t
 = 
Ën
+start;

723 ià(
¡¬t
 < 0) start = 0;

725 ià(
’d
 < 0) {

726 
’d
 = 
Ën
+end;

727 ià(
’d
 < 0)ƒnd = 0;

729 
ÃwËn
 = (
¡¬t
 > 
’d
) ? 0 : (end-start)+1;

730 ià(
ÃwËn
 != 0) {

731 ià(
¡¬t
 >ğ(sigÃd)
Ën
) {

732 
ÃwËn
 = 0;

733 } ià(
’d
 >ğ(sigÃd)
Ën
) {

734 
’d
 = 
Ën
-1;

735 
ÃwËn
 = (
¡¬t
 > 
’d
) ? 0 : (end-start)+1;

738 
¡¬t
 = 0;

740 ià(
¡¬t
 && 
ÃwËn
è
	`memmove
(
s
, s+start,‚ewlen);

741 
s
[
ÃwËn
] = 0;

742 
	`sds£’
(
s
,
ÃwËn
);

743 
	}
}

746 
	$sd¡Şow”
(
sds
 
s
) {

747 
Ën
 = 
	`sd¦’
(
s
), 
j
;

749 
j
 = 0; j < 
Ën
; j++è
s
[j] = 
	`tŞow”
(s[j]);

750 
	}
}

753 
	$sd¡ouµ”
(
sds
 
s
) {

754 
Ën
 = 
	`sd¦’
(
s
), 
j
;

756 
j
 = 0; j < 
Ën
; j++è
s
[j] = 
	`touµ”
(s[j]);

757 
	}
}

770 
	$sdscmp
(cÚ¡ 
sds
 
s1
, cÚ¡ sd 
s2
) {

771 
size_t
 
l1
, 
l2
, 
mšËn
;

772 
cmp
;

774 
l1
 = 
	`sd¦’
(
s1
);

775 
l2
 = 
	`sd¦’
(
s2
);

776 
mšËn
 = (
l1
 < 
l2
) ?†1 :†2;

777 
cmp
 = 
	`memcmp
(
s1
,
s2
,
mšËn
);

778 ià(
cmp
 =ğ0è 
l1
-
l2
;

779  
cmp
;

780 
	}
}

798 
sds
 *
	$sds¥l™Ën
(cÚ¡ *
s
, 
Ën
, cÚ¡ *
£p
, 
£¶’
, *
couÁ
) {

799 
–em’ts
 = 0, 
¦Ùs
 = 5, 
¡¬t
 = 0, 
j
;

800 
sds
 *
tok’s
;

802 ià(
£¶’
 < 1 || 
Ën
 < 0è 
NULL
;

804 
tok’s
 = 
	`s_m®loc
((
sds
)*
¦Ùs
);

805 ià(
tok’s
 =ğ
NULL
)  NULL;

807 ià(
Ën
 == 0) {

808 *
couÁ
 = 0;

809  
tok’s
;

811 
j
 = 0; j < (
Ën
-(
£¶’
-1)); j++) {

813 ià(
¦Ùs
 < 
–em’ts
+2) {

814 
sds
 *
Ãwtok’s
;

816 
¦Ùs
 *= 2;

817 
Ãwtok’s
 = 
	`s_»®loc
(
tok’s
,(
sds
)*
¦Ùs
);

818 ià(
Ãwtok’s
 =ğ
NULL
è
ş—nup
;

819 
tok’s
 = 
Ãwtok’s
;

822 ià((
£¶’
 =ğ1 && *(
s
+
j
è=ğ
£p
[0]è|| (
	`memcmp
(s+j,sep,seplen) == 0)) {

823 
tok’s
[
–em’ts
] = 
	`sd¢ewËn
(
s
+
¡¬t
,
j
-start);

824 ià(
tok’s
[
–em’ts
] =ğ
NULL
è
ş—nup
;

825 
–em’ts
++;

826 
¡¬t
 = 
j
+
£¶’
;

827 
j
 = j+
£¶’
-1;

831 
tok’s
[
–em’ts
] = 
	`sd¢ewËn
(
s
+
¡¬t
,
Ën
-start);

832 ià(
tok’s
[
–em’ts
] =ğ
NULL
è
ş—nup
;

833 
–em’ts
++;

834 *
couÁ
 = 
–em’ts
;

835  
tok’s
;

837 
ş—nup
:

839 
i
;

840 
i
 = 0; i < 
–em’ts
; i++è
	`sdsä“
(
tok’s
[i]);

841 
	`s_ä“
(
tok’s
);

842 *
couÁ
 = 0;

843  
NULL
;

845 
	}
}

848 
	$sdsä“¥l™»s
(
sds
 *
tok’s
, 
couÁ
) {

849 ià(!
tok’s
) ;

850 
couÁ
--)

851 
	`sdsä“
(
tok’s
[
couÁ
]);

852 
	`s_ä“
(
tok’s
);

853 
	}
}

861 
sds
 
	$sdsÿŒ•r
(
sds
 
s
, cÚ¡ *
p
, 
size_t
 
Ën
) {

862 
s
 = 
	`sdsÿ’
(s,"\"",1);

863 
Ën
--) {

864 *
p
) {

867 
s
 = 
	`sdsÿrštf
(s,"\\%c",*
p
);

869 '\n': 
s
 = 
	`sdsÿ’
(s,"\\n",2); ;

870 '\r': 
s
 = 
	`sdsÿ’
(s,"\\r",2); ;

871 '\t': 
s
 = 
	`sdsÿ’
(s,"\\t",2); ;

872 '\a': 
s
 = 
	`sdsÿ’
(s,"\\a",2); ;

873 '\b': 
s
 = 
	`sdsÿ’
(s,"\\b",2); ;

875 ià(
	`i¥ršt
(*
p
))

876 
s
 = 
	`sdsÿrštf
(s,"%c",*
p
);

878 
s
 = 
	`sdsÿrštf
(s,"\\x%02x",()*
p
);

881 
p
++;

883  
	`sdsÿ’
(
s
,"\"",1);

884 
	}
}

888 
	$is_hex_dig™
(
c
) {

889  (
c
 >= '0' && c <= '9') || (c >= 'a' && c <= 'f') ||

890 (
c
 >= 'A' && c <= 'F');

891 
	}
}

895 
	$hex_dig™_to_št
(
c
) {

896 
c
) {

915 
	}
}

936 
sds
 *
	$sds¥l™¬gs
(cÚ¡ *
lše
, *
¬gc
) {

937 cÚ¡ *
p
 = 
lše
;

938 *
cu¼’t
 = 
NULL
;

939 **
veùÜ
 = 
NULL
;

941 *
¬gc
 = 0;

944 *
p
 && 
	`is¥aû
(*p))…++;

945 ià(*
p
) {

947 
šq
=0;

948 
šsq
=0;

949 
dÚe
=0;

951 ià(
cu¼’t
 =ğ
NULL
ècu¼’ˆğ
	`sd£m±y
();

952 !
dÚe
) {

953 ià(
šq
) {

954 ià(*
p
 == '\\' && *(p+1) == 'x' &&

955 
	`is_hex_dig™
(*(
p
+2)) &&

956 
	`is_hex_dig™
(*(
p
+3)))

958 
by‹
;

960 
by‹
 = (
	`hex_dig™_to_št
(*(
p
+2))*16)+

961 
	`hex_dig™_to_št
(*(
p
+3));

962 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,(*)&
by‹
,1);

963 
p
 += 3;

964 } ià(*
p
 == '\\' && *(p+1)) {

965 
c
;

967 
p
++;

968 *
p
) {

969 'n': 
c
 = '\n'; ;

970 'r': 
c
 = '\r'; ;

971 't': 
c
 = '\t'; ;

972 'b': 
c
 = '\b'; ;

973 'a': 
c
 = '\a'; ;

974 : 
c
 = *
p
; ;

976 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,&
c
,1);

977 } ià(*
p
 == '"') {

980 ià(*(
p
+1è&& !
	`is¥aû
(*Õ+1))è
”r
;

981 
dÚe
=1;

982 } ià(!*
p
) {

984 
”r
;

986 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

988 } ià(
šsq
) {

989 ià(*
p
 == '\\' && *(p+1) == '\'') {

990 
p
++;

991 
cu¼’t
 = 
	`sdsÿ’
(current,"'",1);

992 } ià(*
p
 == '\'') {

995 ià(*(
p
+1è&& !
	`is¥aû
(*Õ+1))è
”r
;

996 
dÚe
=1;

997 } ià(!*
p
) {

999 
”r
;

1001 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

1004 *
p
) {

1010 
dÚe
=1;

1013 
šq
=1;

1016 
šsq
=1;

1019 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

1023 ià(*
p
)…++;

1026 
veùÜ
 = 
	`s_»®loc
(veùÜ,((*
¬gc
)+1)*(*));

1027 
veùÜ
[*
¬gc
] = 
cu¼’t
;

1028 (*
¬gc
)++;

1029 
cu¼’t
 = 
NULL
;

1032 ià(
veùÜ
 =ğ
NULL
èveùÜ = 
	`s_m®loc
((*));

1033  
veùÜ
;

1037 
”r
:

1038 (*
¬gc
)--)

1039 
	`sdsä“
(
veùÜ
[*
¬gc
]);

1040 
	`s_ä“
(
veùÜ
);

1041 ià(
cu¼’t
è
	`sdsä“
(current);

1042 *
¬gc
 = 0;

1043  
NULL
;

1044 
	}
}

1055 
sds
 
	$sdsm­ch¬s
(
sds
 
s
, cÚ¡ *
äom
, cÚ¡ *
to
, 
size_t
 
£’
) {

1056 
size_t
 
j
, 
i
, 
l
 = 
	`sd¦’
(
s
);

1058 
j
 = 0; j < 
l
; j++) {

1059 
i
 = 0; i < 
£’
; i++) {

1060 ià(
s
[
j
] =ğ
äom
[
i
]) {

1061 
s
[
j
] = 
to
[
i
];

1066  
s
;

1067 
	}
}

1071 
sds
 
	$sdsjoš
(**
¬gv
, 
¬gc
, *
£p
) {

1072 
sds
 
još
 = 
	`sd£m±y
();

1073 
j
;

1075 
j
 = 0; j < 
¬gc
; j++) {

1076 
još
 = 
	`sdsÿt
(još, 
¬gv
[
j
]);

1077 ià(
j
 !ğ
¬gc
-1è
još
 = 
	`sdsÿt
(još,
£p
);

1079  
još
;

1080 
	}
}

1083 
sds
 
	$sdsjošsds
(
sds
 *
¬gv
, 
¬gc
, cÚ¡ *
£p
, 
size_t
 
£¶’
) {

1084 
sds
 
još
 = 
	`sd£m±y
();

1085 
j
;

1087 
j
 = 0; j < 
¬gc
; j++) {

1088 
još
 = 
	`sdsÿtsds
(još, 
¬gv
[
j
]);

1089 ià(
j
 !ğ
¬gc
-1è
još
 = 
	`sdsÿ’
(još,
£p
,
£¶’
);

1091  
još
;

1092 
	}
}

1099 *
	$sds_m®loc
(
size_t
 
size
è{  
	`s_m®loc
(size); 
	}
}

1100 *
	$sds_»®loc
(*
±r
, 
size_t
 
size
è{  
	`s_»®loc
ÕŒ,size); 
	}
}

1101 
	$sds_ä“
(*
±r
è{ 
	`s_ä“
ÕŒ); 
	}
}

1103 #ià
defšed
(
SDS_TEST_MAIN
)

1104 
	~<¡dio.h
>

1105 
	~"‹¡h–p.h
"

1106 
	~"lim™s.h
"

1108 
	#UNUSED
(
x
è()(x)

	)

1109 
	$sdsTe¡
() {

1111 
sds
 
x
 = 
	`sd¢ew
("foo"), 
y
;

1113 
	`‹¡_cÚd
("Create‡ string‡nd obtainhe†ength",

1114 
	`sd¦’
(
x
è=ğ3 && 
	`memcmp
(x,"foo\0",4) == 0)

1116 
	`sdsä“
(
x
);

1117 
x
 = 
	`sd¢ewËn
("foo",2);

1118 
	`‹¡_cÚd
("Create‡ string with specified†ength",

1119 
	`sd¦’
(
x
è=ğ2 && 
	`memcmp
(x,"fo\0",3) == 0)

1121 
x
 = 
	`sdsÿt
(x,"bar");

1122 
	`‹¡_cÚd
("Strings concatenation",

1123 
	`sd¦’
(
x
è=ğ5 && 
	`memcmp
(x,"fobar\0",6) == 0);

1125 
x
 = 
	`sdsıy
(x,"a");

1126 
	`‹¡_cÚd
("sdscpy()‡gainst‡n originally†onger string",

1127 
	`sd¦’
(
x
è=ğ1 && 
	`memcmp
(x,"a\0",2) == 0)

1129 
x
 = 
	`sdsıy
(x,"xyzxxxxxxxxxxyyyyyyyyyykkkkkkkkkk");

1130 
	`‹¡_cÚd
("sdscpy()‡gainst‡n originally shorter string",

1131 
	`sd¦’
(
x
) == 33 &&

1132 
	`memcmp
(
x
,"xyzxxxxxxxxxxyyyyyyyyyykkkkkkkkkk\0",33) == 0)

1134 
	`sdsä“
(
x
);

1135 
x
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"%d",123);

1136 
	`‹¡_cÚd
("sdscatprintf() seems working inhe base case",

1137 
	`sd¦’
(
x
è=ğ3 && 
	`memcmp
(x,"123\0",4) == 0)

1139 
	`sdsä“
(
x
);

1140 
x
 = 
	`sd¢ew
("--");

1141 
x
 = 
	`sdsÿtfmt
(x, "H–lØ% WÜld %I,%I--", "Hi!", 
LLONG_MIN
,
LLONG_MAX
);

1142 
	`‹¡_cÚd
("sdscatfmt() seems working inhe base case",

1143 
	`sd¦’
(
x
) == 60 &&

1144 
	`memcmp
(
x
,"--Hello Hi! World -9223372036854775808,"

1146 
	`´štf
("[%s]\n",
x
);

1148 
	`sdsä“
(
x
);

1149 
x
 = 
	`sd¢ew
("--");

1150 
x
 = 
	`sdsÿtfmt
(x, "%u,%U--", 
UINT_MAX
, 
ULLONG_MAX
);

1151 
	`‹¡_cÚd
("sdscatfmt() seems working with unsigned‚umbers",

1152 
	`sd¦’
(
x
) == 35 &&

1153 
	`memcmp
(
x
,"--4294967295,18446744073709551615--",35) == 0)

1155 
	`sdsä“
(
x
);

1156 
x
 = 
	`sd¢ew
(" x ");

1157 
	`sd¡rim
(
x
," x");

1158 
	`‹¡_cÚd
("sdstrim() works when‡ll chars match",

1159 
	`sd¦’
(
x
) == 0)

1161 
	`sdsä“
(
x
);

1162 
x
 = 
	`sd¢ew
(" x ");

1163 
	`sd¡rim
(
x
," ");

1164 
	`‹¡_cÚd
("sdstrim() works when‡ single char„emains",

1165 
	`sd¦’
(
x
) == 1 && x[0] == 'x')

1167 
	`sdsä“
(
x
);

1168 
x
 = 
	`sd¢ew
("xxciaoyyy");

1169 
	`sd¡rim
(
x
,"xy");

1170 
	`‹¡_cÚd
("sdstrim() correctlyrims characters",

1171 
	`sd¦’
(
x
è=ğ4 && 
	`memcmp
(x,"ciao\0",5) == 0)

1173 
y
 = 
	`sdsdup
(
x
);

1174 
	`sd¤ªge
(
y
,1,1);

1175 
	`‹¡_cÚd
("sdsrange(...,1,1)",

1176 
	`sd¦’
(
y
è=ğ1 && 
	`memcmp
(y,"i\0",2) == 0)

1178 
	`sdsä“
(
y
);

1179 
y
 = 
	`sdsdup
(
x
);

1180 
	`sd¤ªge
(
y
,1,-1);

1181 
	`‹¡_cÚd
("sdsrange(...,1,-1)",

1182 
	`sd¦’
(
y
è=ğ3 && 
	`memcmp
(y,"iao\0",4) == 0)

1184 
	`sdsä“
(
y
);

1185 
y
 = 
	`sdsdup
(
x
);

1186 
	`sd¤ªge
(
y
,-2,-1);

1187 
	`‹¡_cÚd
("sdsrange(...,-2,-1)",

1188 
	`sd¦’
(
y
è=ğ2 && 
	`memcmp
(y,"ao\0",3) == 0)

1190 
	`sdsä“
(
y
);

1191 
y
 = 
	`sdsdup
(
x
);

1192 
	`sd¤ªge
(
y
,2,1);

1193 
	`‹¡_cÚd
("sdsrange(...,2,1)",

1194 
	`sd¦’
(
y
è=ğ0 && 
	`memcmp
(y,"\0",1) == 0)

1196 
	`sdsä“
(
y
);

1197 
y
 = 
	`sdsdup
(
x
);

1198 
	`sd¤ªge
(
y
,1,100);

1199 
	`‹¡_cÚd
("sdsrange(...,1,100)",

1200 
	`sd¦’
(
y
è=ğ3 && 
	`memcmp
(y,"iao\0",4) == 0)

1202 
	`sdsä“
(
y
);

1203 
y
 = 
	`sdsdup
(
x
);

1204 
	`sd¤ªge
(
y
,100,100);

1205 
	`‹¡_cÚd
("sdsrange(...,100,100)",

1206 
	`sd¦’
(
y
è=ğ0 && 
	`memcmp
(y,"\0",1) == 0)

1208 
	`sdsä“
(
y
);

1209 
	`sdsä“
(
x
);

1210 
x
 = 
	`sd¢ew
("foo");

1211 
y
 = 
	`sd¢ew
("foa");

1212 
	`‹¡_cÚd
("sdscmp(foo,fß)", 
	`sdscmp
(
x
,
y
) > 0)

1214 
	`sdsä“
(
y
);

1215 
	`sdsä“
(
x
);

1216 
x
 = 
	`sd¢ew
("bar");

1217 
y
 = 
	`sd¢ew
("bar");

1218 
	`‹¡_cÚd
("sdscmp(b¬,b¬)", 
	`sdscmp
(
x
,
y
) == 0)

1220 
	`sdsä“
(
y
);

1221 
	`sdsä“
(
x
);

1222 
x
 = 
	`sd¢ew
("aar");

1223 
y
 = 
	`sd¢ew
("bar");

1224 
	`‹¡_cÚd
("sdscmp(b¬,b¬)", 
	`sdscmp
(
x
,
y
) < 0)

1226 
	`sdsä“
(
y
);

1227 
	`sdsä“
(
x
);

1228 
x
 = 
	`sd¢ewËn
("\a\n\0foo\r",7);

1229 
y
 = 
	`sdsÿŒ•r
(
	`sd£m±y
(),
x
,
	`sd¦’
(x));

1230 
	`‹¡_cÚd
("sdscatrepr(...data...)",

1231 
	`memcmp
(
y
,"\"\\a\\n\\x00foo\\r\"",15) == 0)

1234 
Şdä“
;

1235 *
p
;

1236 
¡•
 = 10, 
j
, 
i
;

1238 
	`sdsä“
(
x
);

1239 
	`sdsä“
(
y
);

1240 
x
 = 
	`sd¢ew
("0");

1241 
	`‹¡_cÚd
("sd¢ew(èä“/ËÀbufãrs", 
	`sd¦’
(
x
è=ğ1 && 
	`sd§va
(x) == 0);

1245 
i
 = 0; i < 10; i++) {

1246 
ŞdËn
 = 
	`sd¦’
(
x
);

1247 
x
 = 
	`sdsMakeRoomFÜ
(x,
¡•
);

1248 
ty³
 = 
x
[-1]&
SDS_TYPE_MASK
;

1250 
	`‹¡_cÚd
("sdsMakeRoomFÜ(èËn", 
	`sd¦’
(
x
è=ğ
ŞdËn
);

1251 ià(
ty³
 !ğ
SDS_TYPE_5
) {

1252 
	`‹¡_cÚd
("sdsMakeRoomFÜ(èä“", 
	`sd§va
(
x
è>ğ
¡•
);

1253 
Şdä“
 = 
	`sd§va
(
x
);

1255 
p
 = 
x
+
ŞdËn
;

1256 
j
 = 0; j < 
¡•
; j++) {

1257 
p
[
j
] = 'A'+j;

1259 
	`sdsInüL’
(
x
,
¡•
);

1261 
	`‹¡_cÚd
("sdsMakeRoomFor() content",

1262 
	`memcmp
("0ABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJ",
x
,101) == 0);

1263 
	`‹¡_cÚd
("sdsMakeRoomFÜ(èfš®†’gth",
	`sd¦’
(
x
)==101);

1265 
	`sdsä“
(
x
);

1268 
	`‹¡_»pÜt
()

1270 
	}
}

1273 #ifdeà
SDS_TEST_MAIN


1274 
	$maš
() {

1275  
	`sdsTe¡
();

1276 
	}
}

	@sds.h

33 #iâdeà
__SDS_H


34 
	#__SDS_H


	)

36 
	#SDS_MAX_PREALLOC
 (1024*1024)

	)

38 
	~<sys/ty³s.h
>

39 
	~<¡d¬g.h
>

40 
	~<¡dšt.h
>

42 *
	tsds
;

46 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr5
 {

47 
	gæags
;

48 
	gbuf
[];

50 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr8
 {

51 
ušt8_t
 
	gËn
;

52 
ušt8_t
 
	g®loc
;

53 
	gæags
;

54 
	gbuf
[];

56 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr16
 {

57 
ušt16_t
 
	gËn
;

58 
ušt16_t
 
	g®loc
;

59 
	gæags
;

60 
	gbuf
[];

62 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr32
 {

63 
ušt32_t
 
	gËn
;

64 
ušt32_t
 
	g®loc
;

65 
	gæags
;

66 
	gbuf
[];

68 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr64
 {

69 
ušt64_t
 
	gËn
;

70 
ušt64_t
 
	g®loc
;

71 
	gæags
;

72 
	gbuf
[];

75 
	#SDS_TYPE_5
 0

	)

76 
	#SDS_TYPE_8
 1

	)

77 
	#SDS_TYPE_16
 2

	)

78 
	#SDS_TYPE_32
 3

	)

79 
	#SDS_TYPE_64
 4

	)

80 
	#SDS_TYPE_MASK
 7

	)

81 
	#SDS_TYPE_BITS
 3

	)

82 
	#SDS_HDR_VAR
(
T
,
s
è
sdshdr
##T *
sh
 = (*)((s)-((sdshdr##T)));

	)

83 
	#SDS_HDR
(
T
,
s
è((
sdshdr
##T *)((s)-((sdshdr##T))))

	)

84 
	#SDS_TYPE_5_LEN
(
f
è((f)>>
SDS_TYPE_BITS
)

	)

86 
šlše
 
size_t
 
	$sd¦’
(cÚ¡ 
sds
 
s
) {

87 
æags
 = 
s
[-1];

88 
æags
&
SDS_TYPE_MASK
) {

89 
SDS_TYPE_5
:

90  
	`SDS_TYPE_5_LEN
(
æags
);

91 
SDS_TYPE_8
:

92  
	`SDS_HDR
(8,
s
)->
Ën
;

93 
SDS_TYPE_16
:

94  
	`SDS_HDR
(16,
s
)->
Ën
;

95 
SDS_TYPE_32
:

96  
	`SDS_HDR
(32,
s
)->
Ën
;

97 
SDS_TYPE_64
:

98  
	`SDS_HDR
(64,
s
)->
Ën
;

101 
	}
}

103 
šlše
 
size_t
 
	$sd§va
(cÚ¡ 
sds
 
s
) {

104 
æags
 = 
s
[-1];

105 
æags
&
SDS_TYPE_MASK
) {

106 
SDS_TYPE_5
: {

109 
SDS_TYPE_8
: {

110 
	`SDS_HDR_VAR
(8,
s
);

111  
sh
->
®loc
 - sh->
Ën
;

113 
SDS_TYPE_16
: {

114 
	`SDS_HDR_VAR
(16,
s
);

115  
sh
->
®loc
 - sh->
Ën
;

117 
SDS_TYPE_32
: {

118 
	`SDS_HDR_VAR
(32,
s
);

119  
sh
->
®loc
 - sh->
Ën
;

121 
SDS_TYPE_64
: {

122 
	`SDS_HDR_VAR
(64,
s
);

123  
sh
->
®loc
 - sh->
Ën
;

127 
	}
}

129 
šlše
 
	$sds£’
(
sds
 
s
, 
size_t
 
ÃwËn
) {

130 
æags
 = 
s
[-1];

131 
æags
&
SDS_TYPE_MASK
) {

132 
SDS_TYPE_5
:

134 *
å
 = ((*)
s
)-1;

135 *
å
 = 
SDS_TYPE_5
 | (
ÃwËn
 << 
SDS_TYPE_BITS
);

138 
SDS_TYPE_8
:

139 
	`SDS_HDR
(8,
s
)->
Ën
 = 
ÃwËn
;

141 
SDS_TYPE_16
:

142 
	`SDS_HDR
(16,
s
)->
Ën
 = 
ÃwËn
;

144 
SDS_TYPE_32
:

145 
	`SDS_HDR
(32,
s
)->
Ën
 = 
ÃwËn
;

147 
SDS_TYPE_64
:

148 
	`SDS_HDR
(64,
s
)->
Ën
 = 
ÃwËn
;

151 
	}
}

153 
šlše
 
	$sdsšş’
(
sds
 
s
, 
size_t
 
šc
) {

154 
æags
 = 
s
[-1];

155 
æags
&
SDS_TYPE_MASK
) {

156 
SDS_TYPE_5
:

158 *
å
 = ((*)
s
)-1;

159 
ÃwËn
 = 
	`SDS_TYPE_5_LEN
(
æags
)+
šc
;

160 *
å
 = 
SDS_TYPE_5
 | (
ÃwËn
 << 
SDS_TYPE_BITS
);

163 
SDS_TYPE_8
:

164 
	`SDS_HDR
(8,
s
)->
Ën
 +ğ
šc
;

166 
SDS_TYPE_16
:

167 
	`SDS_HDR
(16,
s
)->
Ën
 +ğ
šc
;

169 
SDS_TYPE_32
:

170 
	`SDS_HDR
(32,
s
)->
Ën
 +ğ
šc
;

172 
SDS_TYPE_64
:

173 
	`SDS_HDR
(64,
s
)->
Ën
 +ğ
šc
;

176 
	}
}

179 
šlše
 
size_t
 
	$sd§Îoc
(cÚ¡ 
sds
 
s
) {

180 
æags
 = 
s
[-1];

181 
æags
&
SDS_TYPE_MASK
) {

182 
SDS_TYPE_5
:

183  
	`SDS_TYPE_5_LEN
(
æags
);

184 
SDS_TYPE_8
:

185  
	`SDS_HDR
(8,
s
)->
®loc
;

186 
SDS_TYPE_16
:

187  
	`SDS_HDR
(16,
s
)->
®loc
;

188 
SDS_TYPE_32
:

189  
	`SDS_HDR
(32,
s
)->
®loc
;

190 
SDS_TYPE_64
:

191  
	`SDS_HDR
(64,
s
)->
®loc
;

194 
	}
}

196 
šlše
 
	$sds£Îoc
(
sds
 
s
, 
size_t
 
ÃwËn
) {

197 
æags
 = 
s
[-1];

198 
æags
&
SDS_TYPE_MASK
) {

199 
SDS_TYPE_5
:

202 
SDS_TYPE_8
:

203 
	`SDS_HDR
(8,
s
)->
®loc
 = 
ÃwËn
;

205 
SDS_TYPE_16
:

206 
	`SDS_HDR
(16,
s
)->
®loc
 = 
ÃwËn
;

208 
SDS_TYPE_32
:

209 
	`SDS_HDR
(32,
s
)->
®loc
 = 
ÃwËn
;

211 
SDS_TYPE_64
:

212 
	`SDS_HDR
(64,
s
)->
®loc
 = 
ÃwËn
;

215 
	}
}

217 
sds
 
sd¢ewËn
(cÚ¡ *
š™
, 
size_t
 
š™Ën
);

218 
sds
 
sd¢ew
(cÚ¡ *
š™
);

219 
sds
 
sd£m±y
();

220 
sds
 
sdsdup
(cÚ¡ sd 
s
);

221 
sdsä“
(
sds
 
s
);

222 
sds
 
sdsgrowz”o
(sd 
s
, 
size_t
 
Ën
);

223 
sds
 
sdsÿ’
(sd 
s
, cÚ¡ *
t
, 
size_t
 
Ën
);

224 
sds
 
sdsÿt
(sd 
s
, cÚ¡ *
t
);

225 
sds
 
sdsÿtsds
(sd 
s
, cÚ¡ sd 
t
);

226 
sds
 
sdsıyËn
(sd 
s
, cÚ¡ *
t
, 
size_t
 
Ën
);

227 
sds
 
sdsıy
(sd 
s
, cÚ¡ *
t
);

229 
sds
 
sdsÿtv´štf
(sd 
s
, cÚ¡ *
fmt
, 
va_li¡
 
­
);

230 #ifdeà
__GNUC__


231 
sds
 
	$sdsÿrštf
(
sds
 
s
, cÚ¡ *
fmt
, ...)

232 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 2, 3)));

234 
sds
 
	`sdsÿrštf
(sd 
s
, cÚ¡ *
fmt
, ...);

237 
sds
 
	`sdsÿtfmt
(sd 
s
, cÚ¡ *
fmt
, ...);

238 
sds
 
	`sd¡rim
(sd 
s
, cÚ¡ *
c£t
);

239 
	`sd¤ªge
(
sds
 
s
, 
¡¬t
, 
’d
);

240 
	`sdsupd©–’
(
sds
 
s
);

241 
	`sdsş—r
(
sds
 
s
);

242 
	`sdscmp
(cÚ¡ 
sds
 
s1
, cÚ¡ sd 
s2
);

243 
sds
 *
	`sds¥l™Ën
(cÚ¡ *
s
, 
Ën
, cÚ¡ *
£p
, 
£¶’
, *
couÁ
);

244 
	`sdsä“¥l™»s
(
sds
 *
tok’s
, 
couÁ
);

245 
	`sd¡Şow”
(
sds
 
s
);

246 
	`sd¡ouµ”
(
sds
 
s
);

247 
sds
 
	`sdsäomlÚglÚg
(
v®ue
);

248 
sds
 
	`sdsÿŒ•r
(sd 
s
, cÚ¡ *
p
, 
size_t
 
Ën
);

249 
sds
 *
	`sds¥l™¬gs
(cÚ¡ *
lše
, *
¬gc
);

250 
sds
 
	`sdsm­ch¬s
(sd 
s
, cÚ¡ *
äom
, cÚ¡ *
to
, 
size_t
 
£’
);

251 
sds
 
	`sdsjoš
(**
¬gv
, 
¬gc
, *
£p
);

252 
sds
 
	`sdsjošsds
(sd *
¬gv
, 
¬gc
, cÚ¡ *
£p
, 
size_t
 
£¶’
);

255 
sds
 
	`sdsMakeRoomFÜ
(sd 
s
, 
size_t
 
addËn
);

256 
	`sdsInüL’
(
sds
 
s
, 
šü
);

257 
sds
 
	`sdsRemoveF»eS·û
(sd 
s
);

258 
size_t
 
	`sdsAÎocSize
(
sds
 
s
);

259 *
	`sdsAÎocPŒ
(
sds
 
s
);

265 *
	`sds_m®loc
(
size_t
 
size
);

266 *
	`sds_»®loc
(*
±r
, 
size_t
 
size
);

267 
	`sds_ä“
(*
±r
);

269 #ifdeà
REDIS_TEST


270 
	`sdsTe¡
(
¬gc
, *
¬gv
[]);

	@sdsalloc.h

39 
	~"zm®loc.h
"

40 
	#s_m®loc
 
zm®loc


	)

41 
	#s_»®loc
 
z»®loc


	)

42 
	#s_ä“
 
zä“


	)

	@sentinel.c

31 
	~"£rv”.h
"

32 
	~"hœedis.h
"

33 
	~"async.h
"

35 
	~<ùy³.h
>

36 
	~<¬·/š‘.h
>

37 
	~<sys/sock‘.h
>

38 
	~<sys/wa™.h
>

39 
	~<fú.h
>

41 **
’vœÚ
;

43 
	#REDIS_SENTINEL_PORT
 26379

	)

48 
	s£Áš–Addr
 {

49 *
	m
;

50 
	mpÜt
;

51 } 
	t£Áš–Addr
;

54 
	#SRI_MASTER
 (1<<0)

	)

55 
	#SRI_SLAVE
 (1<<1)

	)

56 
	#SRI_SENTINEL
 (1<<2)

	)

57 
	#SRI_S_DOWN
 (1<<3è

	)

58 
	#SRI_O_DOWN
 (1<<4è

	)

59 
	#SRI_MASTER_DOWN
 (1<<5è

	)

61 
	#SRI_FAILOVER_IN_PROGRESS
 (1<<6è

	)

63 
	#SRI_PROMOTED
 (1<<7è

	)

64 
	#SRI_RECONF_SENT
 (1<<8è

	)

65 
	#SRI_RECONF_INPROG
 (1<<9è

	)

66 
	#SRI_RECONF_DONE
 (1<<10è

	)

67 
	#SRI_FORCE_FAILOVER
 (1<<11è

	)

68 
	#SRI_SCRIPT_KILL_SENT
 (1<<12è

	)

71 
	#SENTINEL_INFO_PERIOD
 10000

	)

72 
	#SENTINEL_PING_PERIOD
 1000

	)

73 
	#SENTINEL_ASK_PERIOD
 1000

	)

74 
	#SENTINEL_PUBLISH_PERIOD
 2000

	)

75 
	#SENTINEL_DEFAULT_DOWN_AFTER
 30000

	)

76 
	#SENTINEL_HELLO_CHANNEL
 "__£Áš–__:h–lo"

	)

77 
	#SENTINEL_TILT_TRIGGER
 2000

	)

78 
	#SENTINEL_TILT_PERIOD
 (
SENTINEL_PING_PERIOD
*30)

	)

79 
	#SENTINEL_DEFAULT_SLAVE_PRIORITY
 100

	)

80 
	#SENTINEL_SLAVE_RECONF_TIMEOUT
 10000

	)

81 
	#SENTINEL_DEFAULT_PARALLEL_SYNCS
 1

	)

82 
	#SENTINEL_MIN_LINK_RECONNECT_PERIOD
 15000

	)

83 
	#SENTINEL_DEFAULT_FAILOVER_TIMEOUT
 (60*3*1000)

	)

84 
	#SENTINEL_MAX_PENDING_COMMANDS
 100

	)

85 
	#SENTINEL_ELECTION_TIMEOUT
 10000

	)

86 
	#SENTINEL_MAX_DESYNC
 1000

	)

89 
	#SENTINEL_FAILOVER_STATE_NONE
 0

	)

90 
	#SENTINEL_FAILOVER_STATE_WAIT_START
 1

	)

91 
	#SENTINEL_FAILOVER_STATE_SELECT_SLAVE
 2

	)

92 
	#SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE
 3

	)

93 
	#SENTINEL_FAILOVER_STATE_WAIT_PROMOTION
 4

	)

94 
	#SENTINEL_FAILOVER_STATE_RECONF_SLAVES
 5

	)

95 
	#SENTINEL_FAILOVER_STATE_UPDATE_CONFIG
 6

	)

97 
	#SENTINEL_MASTER_LINK_STATUS_UP
 0

	)

98 
	#SENTINEL_MASTER_LINK_STATUS_DOWN
 1

	)

103 
	#SENTINEL_NO_FLAGS
 0

	)

104 
	#SENTINEL_GENERATE_EVENT
 (1<<16)

	)

105 
	#SENTINEL_LEADER
 (1<<17)

	)

106 
	#SENTINEL_OBSERVER
 (1<<18)

	)

109 
	#SENTINEL_SCRIPT_NONE
 0

	)

110 
	#SENTINEL_SCRIPT_RUNNING
 1

	)

111 
	#SENTINEL_SCRIPT_MAX_QUEUE
 256

	)

112 
	#SENTINEL_SCRIPT_MAX_RUNNING
 16

	)

113 
	#SENTINEL_SCRIPT_MAX_RUNTIME
 60000

	)

114 
	#SENTINEL_SCRIPT_MAX_RETRY
 10

	)

115 
	#SENTINEL_SCRIPT_RETRY_DELAY
 30000

	)

118 
	#SENTINEL_SIMFAILURE_NONE
 0

	)

119 
	#SENTINEL_SIMFAILURE_CRASH_AFTER_ELECTION
 (1<<0)

	)

120 
	#SENTINEL_SIMFAILURE_CRASH_AFTER_PROMOTION
 (1<<1)

	)

136 
	sš¡ªûLšk
 {

137 
	m»fcouÁ
;

138 
	mdiscÚÃùed
;

139 
	m³ndšg_commªds
;

140 
»disAsyncCÚ‹xt
 *
	mcc
;

141 
»disAsyncCÚ‹xt
 *
	mpc
;

142 
m¡ime_t
 
	mcc_cÚn_time
;

143 
m¡ime_t
 
	mpc_cÚn_time
;

144 
m¡ime_t
 
	mpc_Ï¡_aùiv™y
;

145 
m¡ime_t
 
	mÏ¡_ava_time
;

147 
m¡ime_t
 
	maù_pšg_time
;

152 
m¡ime_t
 
	mÏ¡_pšg_time
;

156 
m¡ime_t
 
	mÏ¡_pÚg_time
;

159 
m¡ime_t
 
	mÏ¡_»cÚn_time
;

161 } 
	tš¡ªûLšk
;

163 
	s£Áš–RedisIn¡ªû
 {

164 
	mæags
;

165 *
	mÇme
;

166 *
	mrunid
;

167 
ušt64_t
 
	mcÚfig_•och
;

168 
£Áš–Addr
 *
	maddr
;

169 
š¡ªûLšk
 *
	mlšk
;

170 
m¡ime_t
 
	mÏ¡_pub_time
;

171 
m¡ime_t
 
	mÏ¡_h–lo_time
;

174 
m¡ime_t
 
	mÏ¡_ma¡”_down_»¶y_time
;

176 
m¡ime_t
 
	ms_down_sšû_time
;

177 
m¡ime_t
 
	mo_down_sšû_time
;

178 
m¡ime_t
 
	mdown_aá”_³riod
;

179 
m¡ime_t
 
	mšfo_»äesh
;

186 
	mrŞe_»pÜ‹d
;

187 
m¡ime_t
 
	mrŞe_»pÜ‹d_time
;

188 
m¡ime_t
 
	m¦ave_cÚf_chªge_time
;

191 
diù
 *
	m£Áš–s
;

192 
diù
 *
	m¦aves
;

193 
	mquÜum
;

194 
	m·¿Î–_syncs
;

195 *
	mauth_·ss
;

198 
m¡ime_t
 
	mma¡”_lšk_down_time
;

199 
	m¦ave_´iÜ™y
;

200 
m¡ime_t
 
	m¦ave_»cÚf_£Á_time
;

201 
£Áš–RedisIn¡ªû
 *
	mma¡”
;

202 *
	m¦ave_ma¡”_ho¡
;

203 
	m¦ave_ma¡”_pÜt
;

204 
	m¦ave_ma¡”_lšk_¡©us
;

205 
	m¦ave_»¶_off£t
;

207 *
	mËad”
;

211 
ušt64_t
 
	mËad”_•och
;

212 
ušt64_t
 
	mçov”_•och
;

213 
	mçov”_¡©e
;

214 
m¡ime_t
 
	mçov”_¡©e_chªge_time
;

215 
m¡ime_t
 
	mçov”_¡¬t_time
;

216 
m¡ime_t
 
	mçov”_timeout
;

217 
m¡ime_t
 
	mçov”_d–ay_logged
;

219 
£Áš–RedisIn¡ªû
 *
	m´omÙed_¦ave
;

222 *
	mnÙifiÿtiÚ_süt
;

223 *
	mş›Á_»cÚfig_süt
;

224 
sds
 
	mšfo
;

225 } 
	t£Áš–RedisIn¡ªû
;

228 
	s£Áš–S‹
 {

229 
	mmyid
[
CONFIG_RUN_ID_SIZE
+1];

230 
ušt64_t
 
	mcu¼’t_•och
;

231 
diù
 *
	mma¡”s
;

234 
	mtt
;

235 
	mruÂšg_süts
;

236 
m¡ime_t
 
	mtt_¡¬t_time
;

237 
m¡ime_t
 
	m´evious_time
;

238 
li¡
 *
	msüts_queue
;

239 *
	mªnounû_
;

241 
	mªnounû_pÜt
;

243 
	msimçu»_æags
;

244 } 
	g£Áš–
;

247 
	s£Áš–SütJob
 {

248 
	mæags
;

249 
	m»Œy_num
;

250 **
	m¬gv
;

251 
m¡ime_t
 
	m¡¬t_time
;

256 
pid_t
 
	mpid
;

257 } 
	t£Áš–SütJob
;

264 
	s»disAeEv’ts
 {

265 
»disAsyncCÚ‹xt
 *
	mcÚ‹xt
;

266 
«Ev’tLoİ
 *
	mloİ
;

267 
	mfd
;

268 
	m»adšg
, 
	mwr™šg
;

269 } 
	t»disAeEv’ts
;

271 
	$»disAeR—dEv’t
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

272 (()
–
); (()
fd
); (()
mask
);

274 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

275 
	`»disAsyncHªdËR—d
(
e
->
cÚ‹xt
);

276 
	}
}

278 
	$»disAeWr™eEv’t
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

279 (()
–
); (()
fd
); (()
mask
);

281 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

282 
	`»disAsyncHªdËWr™e
(
e
->
cÚ‹xt
);

283 
	}
}

285 
	$»disAeAddR—d
(*
´ivd©a
) {

286 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

287 
«Ev’tLoİ
 *
loİ
 = 
e
->loop;

288 ià(!
e
->
»adšg
) {

289 
e
->
»adšg
 = 1;

290 
	`«C»©eFeEv’t
(
loİ
,
e
->
fd
,
AE_READABLE
,
»disAeR—dEv’t
,e);

292 
	}
}

294 
	$»disAeD–R—d
(*
´ivd©a
) {

295 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

296 
«Ev’tLoİ
 *
loİ
 = 
e
->loop;

297 ià(
e
->
»adšg
) {

298 
e
->
»adšg
 = 0;

299 
	`«D–‘eFeEv’t
(
loİ
,
e
->
fd
,
AE_READABLE
);

301 
	}
}

303 
	$»disAeAddWr™e
(*
´ivd©a
) {

304 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

305 
«Ev’tLoİ
 *
loİ
 = 
e
->loop;

306 ià(!
e
->
wr™šg
) {

307 
e
->
wr™šg
 = 1;

308 
	`«C»©eFeEv’t
(
loİ
,
e
->
fd
,
AE_WRITABLE
,
»disAeWr™eEv’t
,e);

310 
	}
}

312 
	$»disAeD–Wr™e
(*
´ivd©a
) {

313 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

314 
«Ev’tLoİ
 *
loİ
 = 
e
->loop;

315 ià(
e
->
wr™šg
) {

316 
e
->
wr™šg
 = 0;

317 
	`«D–‘eFeEv’t
(
loİ
,
e
->
fd
,
AE_WRITABLE
);

319 
	}
}

321 
	$»disAeCËªup
(*
´ivd©a
) {

322 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

323 
	`»disAeD–R—d
(
´ivd©a
);

324 
	`»disAeD–Wr™e
(
´ivd©a
);

325 
	`zä“
(
e
);

326 
	}
}

328 
	$»disAeA‰ach
(
«Ev’tLoİ
 *
loİ
, 
»disAsyncCÚ‹xt
 *
ac
) {

329 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

330 
»disAeEv’ts
 *
e
;

333 ià(
ac
->
ev
.
d©a
 !ğ
NULL
)

334  
C_ERR
;

337 
e
 = (
»disAeEv’ts
*)
	`zm®loc
((*e));

338 
e
->
cÚ‹xt
 = 
ac
;

339 
e
->
loİ
 =†oop;

340 
e
->
fd
 = 
c
->fd;

341 
e
->
»adšg
 =ƒ->
wr™šg
 = 0;

344 
ac
->
ev
.
addR—d
 = 
»disAeAddR—d
;

345 
ac
->
ev
.
d–R—d
 = 
»disAeD–R—d
;

346 
ac
->
ev
.
addWr™e
 = 
»disAeAddWr™e
;

347 
ac
->
ev
.
d–Wr™e
 = 
»disAeD–Wr™e
;

348 
ac
->
ev
.
ş—nup
 = 
»disAeCËªup
;

349 
ac
->
ev
.
d©a
 = 
e
;

351  
C_OK
;

352 
	}
}

356 
£Áš–LškE¡ablishedC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
);

357 
£Áš–DiscÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
);

358 
£Áš–ReûiveH–loMes§ges
(
»disAsyncCÚ‹xt
 *
c
, *
»¶y
, *
´ivd©a
);

359 
£Áš–RedisIn¡ªû
 *
£Áš–G‘Ma¡”ByName
(*
Çme
);

360 *
£Áš–G‘SubjeùiveL—d”
(
£Áš–RedisIn¡ªû
 *
ma¡”
);

361 *
£Áš–G‘ObjeùiveL—d”
(
£Áš–RedisIn¡ªû
 *
ma¡”
);

362 
ye¢Ùoi
(*
s
);

363 
š¡ªûLškCÚÃùiÚE¼Ü
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
);

364 cÚ¡ *
£Áš–RedisIn¡ªûTy³SŒ
(
£Áš–RedisIn¡ªû
 *
ri
);

365 
£Áš–AbÜtFaov”
(
£Áš–RedisIn¡ªû
 *
ri
);

366 
£Áš–Ev’t
(
Ëv–
, *
ty³
, 
£Áš–RedisIn¡ªû
 *
ri
, cÚ¡ *
fmt
, ...);

367 
£Áš–RedisIn¡ªû
 *
£Áš–S–eùSÏve
(£Áš–RedisIn¡ªû *
ma¡”
);

368 
£Áš–ScheduËSütExecutiÚ
(*
·th
, ...);

369 
£Áš–S¹Faov”
(
£Áš–RedisIn¡ªû
 *
ma¡”
);

370 
£Áš–DisÿrdR•lyC®lback
(
»disAsyncCÚ‹xt
 *
c
, *
»¶y
, *
´ivd©a
);

371 
£Áš–S’dSÏveOf
(
£Áš–RedisIn¡ªû
 *
ri
, *
ho¡
, 
pÜt
);

372 *
£Áš–VÙeL—d”
(
£Áš–RedisIn¡ªû
 *
ma¡”
, 
ušt64_t
 
»q_•och
, *
»q_runid
, ušt64_ˆ*
Ëad”_•och
);

373 
£Áš–FlushCÚfig
();

374 
£Áš–G’”©eIn™ŸlMÚ™ÜEv’ts
();

375 
£Áš–S’dPšg
(
£Áš–RedisIn¡ªû
 *
ri
);

376 
£Áš–FÜûH–loUpd©eFÜMa¡”
(
£Áš–RedisIn¡ªû
 *
ma¡”
);

377 
£Áš–RedisIn¡ªû
 *
g‘S’tš–RedisIn¡ªûByAddrAndRunID
(
diù
 *
š¡ªûs
, *

, 
pÜt
, *
runid
);

378 
£Áš–SimFau»C¿sh
();

382 
ušt64_t
 
diùSdsHash
(cÚ¡ *
key
);

383 
diùSdsKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
);

384 
»Ëa£S’tš–RedisIn¡ªû
(
£Áš–RedisIn¡ªû
 *
ri
);

386 
	$diùIn¡ªûsV®De¡ruùÜ
 (*
´ivd©a
, *
obj
) {

387 
	`UNUSED
(
´ivd©a
);

388 
	`»Ëa£S’tš–RedisIn¡ªû
(
obj
);

389 
	}
}

395 
diùTy³
 
	gš¡ªûsDiùTy³
 = {

396 
diùSdsHash
,

397 
NULL
,

398 
NULL
,

399 
diùSdsKeyCom·»
,

400 
NULL
,

401 
diùIn¡ªûsV®De¡ruùÜ


408 
diùTy³
 
	gËad”VÙesDiùTy³
 = {

409 
diùSdsHash
,

410 
NULL
,

411 
NULL
,

412 
diùSdsKeyCom·»
,

413 
NULL
,

414 
NULL


419 
£Áš–Commªd
(
ş›Á
 *
c
);

420 
£Áš–InfoCommªd
(
ş›Á
 *
c
);

421 
£Áš–S‘Commªd
(
ş›Á
 *
c
);

422 
£Áš–PublishCommªd
(
ş›Á
 *
c
);

423 
£Áš–RŞeCommªd
(
ş›Á
 *
c
);

425 
»disCommªd
 
	g£Áš–cmds
[] = {

426 {"pšg",
pšgCommªd
,1,"",0,
NULL
,0,0,0,0,0},

427 {"£Áš–",
£Áš–Commªd
,-2,"",0,
NULL
,0,0,0,0,0},

428 {"subsüibe",
subsüibeCommªd
,-2,"",0,
NULL
,0,0,0,0,0},

429 {"unsubsüibe",
unsubsüibeCommªd
,-1,"",0,
NULL
,0,0,0,0,0},

430 {"psubsüibe",
psubsüibeCommªd
,-2,"",0,
NULL
,0,0,0,0,0},

431 {"punsubsüibe",
punsubsüibeCommªd
,-1,"",0,
NULL
,0,0,0,0,0},

432 {"publish",
£Áš–PublishCommªd
,3,"",0,
NULL
,0,0,0,0,0},

433 {"šfo",
£Áš–InfoCommªd
,-1,"",0,
NULL
,0,0,0,0,0},

434 {"rŞe",
£Áš–RŞeCommªd
,1,"l",0,
NULL
,0,0,0,0,0},

435 {"ş›Á",
ş›ÁCommªd
,-2,"rs",0,
NULL
,0,0,0,0,0},

436 {"shutdown",
shutdownCommªd
,-1,"",0,
NULL
,0,0,0,0,0}

441 
	$š™S’tš–CÚfig
() {

442 
£rv”
.
pÜt
 = 
REDIS_SENTINEL_PORT
;

443 
	}
}

446 
	$š™S’tš–
() {

447 
j
;

451 
	`diùEm±y
(
£rv”
.
commªds
,
NULL
);

452 
j
 = 0; j < (
£Áš–cmds
)/(sentinelcmds[0]); j++) {

453 
»tv®
;

454 
»disCommªd
 *
cmd
 = 
£Áš–cmds
+
j
;

456 
»tv®
 = 
	`diùAdd
(
£rv”
.
commªds
, 
	`sd¢ew
(
cmd
->
Çme
), cmd);

457 
	`£rv”As£¹
(
»tv®
 =ğ
DICT_OK
);

461 
£Áš–
.
cu¼’t_•och
 = 0;

462 
£Áš–
.
ma¡”s
 = 
	`diùC»©e
(&
š¡ªûsDiùTy³
,
NULL
);

463 
£Áš–
.
tt
 = 0;

464 
£Áš–
.
tt_¡¬t_time
 = 0;

465 
£Áš–
.
´evious_time
 = 
	`m¡ime
();

466 
£Áš–
.
ruÂšg_süts
 = 0;

467 
£Áš–
.
süts_queue
 = 
	`li¡C»©e
();

468 
£Áš–
.
ªnounû_
 = 
NULL
;

469 
£Áš–
.
ªnounû_pÜt
 = 0;

470 
£Áš–
.
simçu»_æags
 = 
SENTINEL_SIMFAILURE_NONE
;

471 
	`mem£t
(
£Áš–
.
myid
,0,(sentinel.myid));

472 
	}
}

476 
	$£Áš–IsRuÂšg
() {

477 
j
;

479 ià(
£rv”
.
cÚfigfe
 =ğ
NULL
) {

480 
	`£rv”Log
(
LL_WARNING
,

482 
	`ex™
(1);

483 } ià(
	`acûss
(
£rv”
.
cÚfigfe
,
W_OK
) == -1) {

484 
	`£rv”Log
(
LL_WARNING
,

486 
£rv”
.
cÚfigfe
,
	`¡»¼Ü
(
”ºo
));

487 
	`ex™
(1);

493 
j
 = 0; j < 
CONFIG_RUN_ID_SIZE
; j++)

494 ià(
£Áš–
.
myid
[
j
] != 0) ;

496 ià(
j
 =ğ
CONFIG_RUN_ID_SIZE
) {

498 
	`g‘RªdomHexCh¬s
(
£Áš–
.
myid
,
CONFIG_RUN_ID_SIZE
);

499 
	`£Áš–FlushCÚfig
();

503 
	`£rv”Log
(
LL_WARNING
,"S’tš– ID i %s", 
£Áš–
.
myid
);

507 
	`£Áš–G’”©eIn™ŸlMÚ™ÜEv’ts
();

508 
	}
}

517 
£Áš–Addr
 *
	$ü—‹S’tš–Addr
(*
ho¡Çme
, 
pÜt
) {

518 

[
NET_IP_STR_LEN
];

519 
£Áš–Addr
 *
§
;

521 ià(
pÜt
 < 0 ||…ort > 65535) {

522 
”ºo
 = 
EINVAL
;

523  
NULL
;

525 ià(
	`ª‘ResŞve
(
NULL
,
ho¡Çme
,

,()è=ğ
ANET_ERR
) {

526 
”ºo
 = 
ENOENT
;

527  
NULL
;

529 
§
 = 
	`zm®loc
((*sa));

530 
§
->

 = 
	`sd¢ew
(ip);

531 
§
->
pÜt
 =…ort;

532  
§
;

533 
	}
}

536 
£Áš–Addr
 *
	$dupS’tš–Addr
(
£Áš–Addr
 *
¤c
) {

537 
£Áš–Addr
 *
§
;

539 
§
 = 
	`zm®loc
((*sa));

540 
§
->

 = 
	`sd¢ew
(
¤c
->ip);

541 
§
->
pÜt
 = 
¤c
->port;

542  
§
;

543 
	}
}

546 
	$»Ëa£S’tš–Addr
(
£Áš–Addr
 *
§
) {

547 
	`sdsä“
(
§
->

);

548 
	`zä“
(
§
);

549 
	}
}

552 
	$£Áš–AddrIsEqu®
(
£Áš–Addr
 *
a
, s’tš–Add¸*
b
) {

553  
a
->
pÜt
 =ğ
b
->pÜˆ&& !
	`¡rÿ£cmp
×->

,b->ip);

554 
	}
}

582 
	$£Áš–Ev’t
(
Ëv–
, *
ty³
, 
£Áš–RedisIn¡ªû
 *
ri
,

583 cÚ¡ *
fmt
, ...) {

584 
va_li¡
 
­
;

585 
msg
[
LOG_MAX_LEN
];

586 
robj
 *
chªÃl
, *
·ylßd
;

589 ià(
fmt
[0] == '%' && fmt[1] == '@') {

590 
£Áš–RedisIn¡ªû
 *
ma¡”
 = (
ri
->
æags
 & 
SRI_MASTER
) ?

591 
NULL
 : 
ri
->
ma¡”
;

593 ià(
ma¡”
) {

594 
	`¢´štf
(
msg
, (msg), "%s %s %s %d @ %s %s %d",

595 
	`£Áš–RedisIn¡ªûTy³SŒ
(
ri
),

596 
ri
->
Çme
,„i->
addr
->

,„i->addr->
pÜt
,

597 
ma¡”
->
Çme
, ma¡”->
addr
->

, ma¡”->addr->
pÜt
);

599 
	`¢´štf
(
msg
, (msg), "%s %s %s %d",

600 
	`£Áš–RedisIn¡ªûTy³SŒ
(
ri
),

601 
ri
->
Çme
,„i->
addr
->

,„i->addr->
pÜt
);

603 
fmt
 += 2;

605 
msg
[0] = '\0';

609 ià(
fmt
[0] != '\0') {

610 
	`va_¡¬t
(
­
, 
fmt
);

611 
	`v¢´štf
(
msg
+
	`¡¾’
(msg), (msg)-¡¾’(msg), 
fmt
, 
­
);

612 
	`va_’d
(
­
);

616 ià(
Ëv–
 >ğ
£rv”
.
v”bos™y
)

617 
	`£rv”Log
(
Ëv–
,"% %s",
ty³
,
msg
);

620 ià(
Ëv–
 !ğ
LL_DEBUG
) {

621 
chªÃl
 = 
	`ü—‹SŒšgObjeù
(
ty³
,
	`¡¾’
(type));

622 
·ylßd
 = 
	`ü—‹SŒšgObjeù
(
msg
,
	`¡¾’
(msg));

623 
	`pubsubPublishMes§ge
(
chªÃl
,
·ylßd
);

624 
	`deüRefCouÁ
(
chªÃl
);

625 
	`deüRefCouÁ
(
·ylßd
);

629 ià(
Ëv–
 =ğ
LL_WARNING
 && 
ri
 !ğ
NULL
) {

630 
£Áš–RedisIn¡ªû
 *
ma¡”
 = (
ri
->
æags
 & 
SRI_MASTER
) ?

631 
ri
 :„i->
ma¡”
;

632 ià(
ma¡”
 && ma¡”->
nÙifiÿtiÚ_süt
) {

633 
	`£Áš–ScheduËSütExecutiÚ
(
ma¡”
->
nÙifiÿtiÚ_süt
,

634 
ty³
,
msg
,
NULL
);

637 
	}
}

643 
	$£Áš–G’”©eIn™ŸlMÚ™ÜEv’ts
() {

644 
diùI‹¿tÜ
 *
di
;

645 
diùEÁry
 *
de
;

647 
di
 = 
	`diùG‘I‹¿tÜ
(
£Áš–
.
ma¡”s
);

648 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

649 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

650 
	`£Áš–Ev’t
(
LL_WARNING
,"+mÚ™Ü",
ri
,"%@ quÜum %d",ri->
quÜum
);

652 
	`diùR–—£I‹¿tÜ
(
di
);

653 
	}
}

658 
	$£Áš–R–—£SütJob
(
£Áš–SütJob
 *
sj
) {

659 
j
 = 0;

661 
sj
->
¬gv
[
j
]è
	`sdsä“
(sj->argv[j++]);

662 
	`zä“
(
sj
->
¬gv
);

663 
	`zä“
(
sj
);

664 
	}
}

666 
	#SENTINEL_SCRIPT_MAX_ARGS
 16

	)

667 
	$£Áš–ScheduËSütExecutiÚ
(*
·th
, ...) {

668 
va_li¡
 
­
;

669 *
¬gv
[
SENTINEL_SCRIPT_MAX_ARGS
+1];

670 
¬gc
 = 1;

671 
£Áš–SütJob
 *
sj
;

673 
	`va_¡¬t
(
­
, 
·th
);

674 
¬gc
 < 
SENTINEL_SCRIPT_MAX_ARGS
) {

675 
¬gv
[
¬gc
] = 
	`va_¬g
(
­
,*);

676 ià(!
¬gv
[
¬gc
]) ;

677 
¬gv
[
¬gc
] = 
	`sd¢ew
(argv[argc]);

678 
¬gc
++;

680 
	`va_’d
(
­
);

681 
¬gv
[0] = 
	`sd¢ew
(
·th
);

683 
sj
 = 
	`zm®loc
((*sj));

684 
sj
->
æags
 = 
SENTINEL_SCRIPT_NONE
;

685 
sj
->
»Œy_num
 = 0;

686 
sj
->
¬gv
 = 
	`zm®loc
((*)*(
¬gc
+1));

687 
sj
->
¡¬t_time
 = 0;

688 
sj
->
pid
 = 0;

689 
	`memıy
(
sj
->
¬gv
,¬gv,(*)*(
¬gc
+1));

691 
	`li¡AddNodeTa
(
£Áš–
.
süts_queue
,
sj
);

694 ià(
	`li¡L’gth
(
£Áš–
.
süts_queue
è> 
SENTINEL_SCRIPT_MAX_QUEUE
) {

695 
li¡Node
 *
Ê
;

696 
li¡I‹r
 
li
;

698 
	`li¡Rewšd
(
£Áš–
.
süts_queue
,&
li
);

699 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

700 
sj
 = 
Ê
->
v®ue
;

702 ià(
sj
->
æags
 & 
SENTINEL_SCRIPT_RUNNING
) ;

704 
	`li¡D–Node
(
£Áš–
.
süts_queue
,
Ê
);

705 
	`£Áš–R–—£SütJob
(
sj
);

708 
	`£rv”As£¹
(
	`li¡L’gth
(
£Áš–
.
süts_queue
) <=

709 
SENTINEL_SCRIPT_MAX_QUEUE
);

711 
	}
}

715 
li¡Node
 *
	$£Áš–G‘SütLi¡NodeByPid
(
pid_t
 
pid
) {

716 
li¡Node
 *
Ê
;

717 
li¡I‹r
 
li
;

719 
	`li¡Rewšd
(
£Áš–
.
süts_queue
,&
li
);

720 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

721 
£Áš–SütJob
 *
sj
 = 
Ê
->
v®ue
;

723 ià((
sj
->
æags
 & 
SENTINEL_SCRIPT_RUNNING
è&& sj->
pid
 ==…id)

724  
Ê
;

726  
NULL
;

727 
	}
}

731 
	$£Áš–RunP’dšgSüts
() {

732 
li¡Node
 *
Ê
;

733 
li¡I‹r
 
li
;

734 
m¡ime_t
 
now
 = 
	`m¡ime
();

738 
	`li¡Rewšd
(
£Áš–
.
süts_queue
,&
li
);

739 
£Áš–
.
ruÂšg_süts
 < 
SENTINEL_SCRIPT_MAX_RUNNING
 &&

740 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
)

742 
£Áš–SütJob
 *
sj
 = 
Ê
->
v®ue
;

743 
pid_t
 
pid
;

746 ià(
sj
->
æags
 & 
SENTINEL_SCRIPT_RUNNING
) ;

749 ià(
sj
->
¡¬t_time
 && sj->¡¬t_tim> 
now
) ;

751 
sj
->
æags
 |ğ
SENTINEL_SCRIPT_RUNNING
;

752 
sj
->
¡¬t_time
 = 
	`m¡ime
();

753 
sj
->
»Œy_num
++;

754 
pid
 = 
	`fÜk
();

756 ià(
pid
 == -1) {

760 
	`£Áš–Ev’t
(
LL_WARNING
,"-süt-”rÜ",
NULL
,

761 "% %d %d", 
sj
->
¬gv
[0], 99, 0);

762 
sj
->
æags
 &ğ~
SENTINEL_SCRIPT_RUNNING
;

763 
sj
->
pid
 = 0;

764 } ià(
pid
 == 0) {

766 
	`execve
(
sj
->
¬gv
[0],sj->¬gv,
’vœÚ
);

768 
	`_ex™
(2);

770 
£Áš–
.
ruÂšg_süts
++;

771 
sj
->
pid
 =…id;

772 
	`£Áš–Ev’t
(
LL_DEBUG
,"+süt-chd",
NULL
,"%ld",()
pid
);

775 
	}
}

784 
m¡ime_t
 
	$£Áš–SütR‘ryD–ay
(
»Œy_num
) {

785 
m¡ime_t
 
d–ay
 = 
SENTINEL_SCRIPT_RETRY_DELAY
;

787 
»Œy_num
-- > 1è
d–ay
 *= 2;

788  
d–ay
;

789 
	}
}

795 
	$£Áš–CŞËùT”mš©edSüts
() {

796 
¡©loc
;

797 
pid_t
 
pid
;

799 (
pid
 = 
	`wa™3
(&
¡©loc
,
WNOHANG
,
NULL
)) > 0) {

800 
ex™code
 = 
	`WEXITSTATUS
(
¡©loc
);

801 
bysigÇl
 = 0;

802 
li¡Node
 *
Ê
;

803 
£Áš–SütJob
 *
sj
;

805 ià(
	`WIFSIGNALED
(
¡©loc
)è
bysigÇl
 = 
	`WTERMSIG
(statloc);

806 
	`£Áš–Ev’t
(
LL_DEBUG
,"-süt-chd",
NULL
,"%ld %d %d",

807 ()
pid
, 
ex™code
, 
bysigÇl
);

809 
Ê
 = 
	`£Áš–G‘SütLi¡NodeByPid
(
pid
);

810 ià(
Ê
 =ğ
NULL
) {

811 
	`£rv”Log
(
LL_WARNING
,"wa™3(è»tuºed‡…id (%ldèwÿn'ˆfšd iÀou¸süt executiÚ queue!", ()
pid
);

814 
sj
 = 
Ê
->
v®ue
;

819 ià((
bysigÇl
 || 
ex™code
 == 1) &&

820 
sj
->
»Œy_num
 !ğ
SENTINEL_SCRIPT_MAX_RETRY
)

822 
sj
->
æags
 &ğ~
SENTINEL_SCRIPT_RUNNING
;

823 
sj
->
pid
 = 0;

824 
sj
->
¡¬t_time
 = 
	`m¡ime
() +

825 
	`£Áš–SütR‘ryD–ay
(
sj
->
»Œy_num
);

829 ià(
bysigÇl
 || 
ex™code
 != 0) {

830 
	`£Áš–Ev’t
(
LL_WARNING
,"-süt-”rÜ",
NULL
,

831 "% %d %d", 
sj
->
¬gv
[0], 
bysigÇl
, 
ex™code
);

833 
	`li¡D–Node
(
£Áš–
.
süts_queue
,
Ê
);

834 
	`£Áš–R–—£SütJob
(
sj
);

835 
£Áš–
.
ruÂšg_süts
--;

838 
	}
}

842 
	$£Áš–KlTimedoutSüts
() {

843 
li¡Node
 *
Ê
;

844 
li¡I‹r
 
li
;

845 
m¡ime_t
 
now
 = 
	`m¡ime
();

847 
	`li¡Rewšd
(
£Áš–
.
süts_queue
,&
li
);

848 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

849 
£Áš–SütJob
 *
sj
 = 
Ê
->
v®ue
;

851 ià(
sj
->
æags
 & 
SENTINEL_SCRIPT_RUNNING
 &&

852 (
now
 - 
sj
->
¡¬t_time
è> 
SENTINEL_SCRIPT_MAX_RUNTIME
)

854 
	`£Áš–Ev’t
(
LL_WARNING
,"-süt-timeout",
NULL
,"%s %ld",

855 
sj
->
¬gv
[0], ()sj->
pid
);

856 
	`kl
(
sj
->
pid
,
SIGKILL
);

859 
	}
}

862 
	$£Áš–P’dšgSütsCommªd
(
ş›Á
 *
c
) {

863 
li¡Node
 *
Ê
;

864 
li¡I‹r
 
li
;

866 
	`addR•lyMuÉiBulkL’
(
c
,
	`li¡L’gth
(
£Áš–
.
süts_queue
));

867 
	`li¡Rewšd
(
£Áš–
.
süts_queue
,&
li
);

868 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

869 
£Áš–SütJob
 *
sj
 = 
Ê
->
v®ue
;

870 
j
 = 0;

872 
	`addR•lyMuÉiBulkL’
(
c
,10);

874 
	`addR•lyBulkCSŒšg
(
c
,"argv");

875 
sj
->
¬gv
[
j
]) j++;

876 
	`addR•lyMuÉiBulkL’
(
c
,
j
);

877 
j
 = 0;

878 
sj
->
¬gv
[
j
]è
	`addR•lyBulkCSŒšg
(
c
,sj->argv[j++]);

880 
	`addR•lyBulkCSŒšg
(
c
,"flags");

881 
	`addR•lyBulkCSŒšg
(
c
,

882 (
sj
->
æags
 & 
SENTINEL_SCRIPT_RUNNING
) ? "running" : "scheduled");

884 
	`addR•lyBulkCSŒšg
(
c
,"pid");

885 
	`addR•lyBulkLÚgLÚg
(
c
,
sj
->
pid
);

887 ià(
sj
->
æags
 & 
SENTINEL_SCRIPT_RUNNING
) {

888 
	`addR•lyBulkCSŒšg
(
c
,"run-time");

889 
	`addR•lyBulkLÚgLÚg
(
c
,
	`m¡ime
(è- 
sj
->
¡¬t_time
);

891 
m¡ime_t
 
d–ay
 = 
sj
->
¡¬t_time
 ? (sj->¡¬t_time-
	`m¡ime
()) : 0;

892 ià(
d–ay
 < 0) delay = 0;

893 
	`addR•lyBulkCSŒšg
(
c
,"run-delay");

894 
	`addR•lyBulkLÚgLÚg
(
c
,
d–ay
);

897 
	`addR•lyBulkCSŒšg
(
c
,"retry-num");

898 
	`addR•lyBulkLÚgLÚg
(
c
,
sj
->
»Œy_num
);

900 
	}
}

914 
	$£Áš–C®lCl›ÁRecÚfSüt
(
£Áš–RedisIn¡ªû
 *
ma¡”
, 
rŞe
, *
¡©e
, 
£Áš–Addr
 *
äom
, s’tš–Add¸*
to
) {

915 
äompÜt
[32], 
tİÜt
[32];

917 ià(
ma¡”
->
ş›Á_»cÚfig_süt
 =ğ
NULL
) ;

918 
	`Î2¡ršg
(
äompÜt
,(äompÜt),
äom
->
pÜt
);

919 
	`Î2¡ršg
(
tİÜt
,ÑİÜt),
to
->
pÜt
);

920 
	`£Áš–ScheduËSütExecutiÚ
(
ma¡”
->
ş›Á_»cÚfig_süt
,

921 
ma¡”
->
Çme
,

922 (
rŞe
 =ğ
SENTINEL_LEADER
) ? "leader" : "observer",

923 
¡©e
, 
äom
->

, 
äompÜt
, 
to
->, 
tİÜt
, 
NULL
);

924 
	}
}

929 
š¡ªûLšk
 *
	$ü—‹In¡ªûLšk
() {

930 
š¡ªûLšk
 *
lšk
 = 
	`zm®loc
((*link));

932 
lšk
->
»fcouÁ
 = 1;

933 
lšk
->
discÚÃùed
 = 1;

934 
lšk
->
³ndšg_commªds
 = 0;

935 
lšk
->
cc
 = 
NULL
;

936 
lšk
->
pc
 = 
NULL
;

937 
lšk
->
cc_cÚn_time
 = 0;

938 
lšk
->
pc_cÚn_time
 = 0;

939 
lšk
->
Ï¡_»cÚn_time
 = 0;

940 
lšk
->
pc_Ï¡_aùiv™y
 = 0;

945 
lšk
->
aù_pšg_time
 = 
	`m¡ime
();

946 
lšk
->
Ï¡_pšg_time
 = 0;

947 
lšk
->
Ï¡_ava_time
 = 
	`m¡ime
();

948 
lšk
->
Ï¡_pÚg_time
 = 
	`m¡ime
();

949  
lšk
;

950 
	}
}

953 
	$š¡ªûLškClo£CÚÃùiÚ
(
š¡ªûLšk
 *
lšk
, 
»disAsyncCÚ‹xt
 *
c
) {

954 ià(
c
 =ğ
NULL
) ;

956 ià(
lšk
->
cc
 =ğ
c
) {

957 
lšk
->
cc
 = 
NULL
;

958 
lšk
->
³ndšg_commªds
 = 0;

960 ià(
lšk
->
pc
 =ğ
c
èlšk->pøğ
NULL
;

961 
c
->
d©a
 = 
NULL
;

962 
lšk
->
discÚÃùed
 = 1;

963 
	`»disAsyncF»e
(
c
);

964 
	}
}

974 
š¡ªûLšk
 *
	$»Ëa£In¡ªûLšk
(
š¡ªûLšk
 *
lšk
, 
£Áš–RedisIn¡ªû
 *
ri
)

976 
	`£rv”As£¹
(
lšk
->
»fcouÁ
 > 0);

977 
lšk
->
»fcouÁ
--;

978 ià(
lšk
->
»fcouÁ
 != 0) {

979 ià(
ri
 &&„i->
lšk
->
cc
) {

985 
»disC®lback
 *
cb
;

986 
»disC®lbackLi¡
 *
ÿÎbacks
 = &
lšk
->
cc
->
»¶›s
;

988 
cb
 = 
ÿÎbacks
->
h—d
;

989 
cb
) {

990 ià(
cb
->
´ivd©a
 =ğ
ri
) {

991 
cb
->
â
 = 
£Áš–DisÿrdR•lyC®lback
;

992 
cb
->
´ivd©a
 = 
NULL
;

994 
cb
 = cb->
Ãxt
;

997  
lšk
;

1000 
	`š¡ªûLškClo£CÚÃùiÚ
(
lšk
,lšk->
cc
);

1001 
	`š¡ªûLškClo£CÚÃùiÚ
(
lšk
,lšk->
pc
);

1002 
	`zä“
(
lšk
);

1003  
NULL
;

1004 
	}
}

1018 
	$£Áš–TryCÚÃùiÚSh¬šg
(
£Áš–RedisIn¡ªû
 *
ri
) {

1019 
	`£rv”As£¹
(
ri
->
æags
 & 
SRI_SENTINEL
);

1020 
diùI‹¿tÜ
 *
di
;

1021 
diùEÁry
 *
de
;

1023 ià(
ri
->
runid
 =ğ
NULL
è 
C_ERR
;

1024 ià(
ri
->
lšk
->
»fcouÁ
 > 1è 
C_ERR
;

1026 
di
 = 
	`diùG‘I‹¿tÜ
(
£Áš–
.
ma¡”s
);

1027 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1028 
£Áš–RedisIn¡ªû
 *
ma¡”
 = 
	`diùG‘V®
(
de
), *
m©ch
;

1031 ià(
ma¡”
 =ğ
ri
->master) ;

1032 
m©ch
 = 
	`g‘S’tš–RedisIn¡ªûByAddrAndRunID
(
ma¡”
->
£Áš–s
,

1033 
NULL
,0,
ri
->
runid
);

1034 ià(
m©ch
 =ğ
NULL
) ;

1035 ià(
m©ch
 =ğ
ri
) ;

1039 
	`»Ëa£In¡ªûLšk
(
ri
->
lšk
,
NULL
);

1040 
ri
->
lšk
 = 
m©ch
->link;

1041 
m©ch
->
lšk
->
»fcouÁ
++;

1042  
C_OK
;

1044 
	`diùR–—£I‹¿tÜ
(
di
);

1045  
C_ERR
;

1046 
	}
}

1054 
	$£Áš–Upd©eS’tš–Add»ssInAÎMa¡”s
(
£Áš–RedisIn¡ªû
 *
ri
) {

1055 
	`£rv”As£¹
(
ri
->
æags
 & 
SRI_SENTINEL
);

1056 
diùI‹¿tÜ
 *
di
;

1057 
diùEÁry
 *
de
;

1058 
»cÚfigu»d
 = 0;

1060 
di
 = 
	`diùG‘I‹¿tÜ
(
£Áš–
.
ma¡”s
);

1061 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1062 
£Áš–RedisIn¡ªû
 *
ma¡”
 = 
	`diùG‘V®
(
de
), *
m©ch
;

1063 
m©ch
 = 
	`g‘S’tš–RedisIn¡ªûByAddrAndRunID
(
ma¡”
->
£Áš–s
,

1064 
NULL
,0,
ri
->
runid
);

1067 ià(
m©ch
 =ğ
NULL
) ;

1070 ià(
m©ch
->
lšk
->
cc
 !ğ
NULL
)

1071 
	`š¡ªûLškClo£CÚÃùiÚ
(
m©ch
->
lšk
,m©ch->lšk->
cc
);

1072 ià(
m©ch
->
lšk
->
pc
 !ğ
NULL
)

1073 
	`š¡ªûLškClo£CÚÃùiÚ
(
m©ch
->
lšk
,m©ch->lšk->
pc
);

1075 ià(
m©ch
 =ğ
ri
) ;

1079 
	`»Ëa£S’tš–Addr
(
m©ch
->
addr
);

1080 
m©ch
->
addr
 = 
	`dupS’tš–Addr
(
ri
->addr);

1081 
»cÚfigu»d
++;

1083 
	`diùR–—£I‹¿tÜ
(
di
);

1084 ià(
»cÚfigu»d
)

1085 
	`£Áš–Ev’t
(
LL_NOTICE
,"+£Áš–-add»ss-upd©e", 
ri
,

1086 "%@ %d‡dd™iÚ® m©chšg in¡ªûs", 
»cÚfigu»d
);

1087  
»cÚfigu»d
;

1088 
	}
}

1096 
	$š¡ªûLškCÚÃùiÚE¼Ü
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
) {

1097 
š¡ªûLšk
 *
lšk
 = 
c
->
d©a
;

1098 
pubsub
;

1100 ià(!
lšk
) ;

1102 
pubsub
 = (
lšk
->
pc
 =ğ
c
);

1103 ià(
pubsub
)

1104 
lšk
->
pc
 = 
NULL
;

1106 
lšk
->
cc
 = 
NULL
;

1107 
lšk
->
discÚÃùed
 = 1;

1108 
	}
}

1112 
	$£Áš–LškE¡ablishedC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

1113 ià(
¡©us
 !ğ
C_OK
è
	`š¡ªûLškCÚÃùiÚE¼Ü
(
c
);

1114 
	}
}

1116 
	$£Áš–DiscÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

1117 
	`UNUSED
(
¡©us
);

1118 
	`š¡ªûLškCÚÃùiÚE¼Ü
(
c
);

1119 
	}
}

1145 
£Áš–RedisIn¡ªû
 *
	$ü—‹S’tš–RedisIn¡ªû
(*
Çme
, 
æags
, *
ho¡Çme
, 
pÜt
, 
quÜum
, 
£Áš–RedisIn¡ªû
 *
ma¡”
) {

1146 
£Áš–RedisIn¡ªû
 *
ri
;

1147 
£Áš–Addr
 *
addr
;

1148 
diù
 *
bË
 = 
NULL
;

1149 
¦av’ame
[
NET_PEER_ID_LEN
], *
sd¢ame
;

1151 
	`£rv”As£¹
(
æags
 & (
SRI_MASTER
|
SRI_SLAVE
|
SRI_SENTINEL
));

1152 
	`£rv”As£¹
((
æags
 & 
SRI_MASTER
è|| 
ma¡”
 !ğ
NULL
);

1155 
addr
 = 
	`ü—‹S’tš–Addr
(
ho¡Çme
,
pÜt
);

1156 ià(
addr
 =ğ
NULL
)  NULL;

1159 ià(
æags
 & 
SRI_SLAVE
) {

1160 
	`ª‘FÜm©Addr
(
¦av’ame
, (¦av’ame), 
ho¡Çme
, 
pÜt
);

1161 
Çme
 = 
¦av’ame
;

1168 ià(
æags
 & 
SRI_MASTER
è
bË
 = 
£Áš–
.
ma¡”s
;

1169 ià(
æags
 & 
SRI_SLAVE
è
bË
 = 
ma¡”
->
¦aves
;

1170 ià(
æags
 & 
SRI_SENTINEL
è
bË
 = 
ma¡”
->
£Áš–s
;

1171 
sd¢ame
 = 
	`sd¢ew
(
Çme
);

1172 ià(
	`diùFšd
(
bË
,
sd¢ame
)) {

1173 
	`»Ëa£S’tš–Addr
(
addr
);

1174 
	`sdsä“
(
sd¢ame
);

1175 
”ºo
 = 
EBUSY
;

1176  
NULL
;

1180 
ri
 = 
	`zm®loc
((*ri));

1183 
ri
->
æags
 = flags;

1184 
ri
->
Çme
 = 
sd¢ame
;

1185 
ri
->
runid
 = 
NULL
;

1186 
ri
->
cÚfig_•och
 = 0;

1187 
ri
->
addr
 =‡ddr;

1188 
ri
->
lšk
 = 
	`ü—‹In¡ªûLšk
();

1189 
ri
->
Ï¡_pub_time
 = 
	`m¡ime
();

1190 
ri
->
Ï¡_h–lo_time
 = 
	`m¡ime
();

1191 
ri
->
Ï¡_ma¡”_down_»¶y_time
 = 
	`m¡ime
();

1192 
ri
->
s_down_sšû_time
 = 0;

1193 
ri
->
o_down_sšû_time
 = 0;

1194 
ri
->
down_aá”_³riod
 = 
ma¡”
 ? master->down_after_period :

1195 
SENTINEL_DEFAULT_DOWN_AFTER
;

1196 
ri
->
ma¡”_lšk_down_time
 = 0;

1197 
ri
->
auth_·ss
 = 
NULL
;

1198 
ri
->
¦ave_´iÜ™y
 = 
SENTINEL_DEFAULT_SLAVE_PRIORITY
;

1199 
ri
->
¦ave_»cÚf_£Á_time
 = 0;

1200 
ri
->
¦ave_ma¡”_ho¡
 = 
NULL
;

1201 
ri
->
¦ave_ma¡”_pÜt
 = 0;

1202 
ri
->
¦ave_ma¡”_lšk_¡©us
 = 
SENTINEL_MASTER_LINK_STATUS_DOWN
;

1203 
ri
->
¦ave_»¶_off£t
 = 0;

1204 
ri
->
£Áš–s
 = 
	`diùC»©e
(&
š¡ªûsDiùTy³
,
NULL
);

1205 
ri
->
quÜum
 = quorum;

1206 
ri
->
·¿Î–_syncs
 = 
SENTINEL_DEFAULT_PARALLEL_SYNCS
;

1207 
ri
->
ma¡”
 = master;

1208 
ri
->
¦aves
 = 
	`diùC»©e
(&
š¡ªûsDiùTy³
,
NULL
);

1209 
ri
->
šfo_»äesh
 = 0;

1212 
ri
->
Ëad”
 = 
NULL
;

1213 
ri
->
Ëad”_•och
 = 0;

1214 
ri
->
çov”_•och
 = 0;

1215 
ri
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_NONE
;

1216 
ri
->
çov”_¡©e_chªge_time
 = 0;

1217 
ri
->
çov”_¡¬t_time
 = 0;

1218 
ri
->
çov”_timeout
 = 
SENTINEL_DEFAULT_FAILOVER_TIMEOUT
;

1219 
ri
->
çov”_d–ay_logged
 = 0;

1220 
ri
->
´omÙed_¦ave
 = 
NULL
;

1221 
ri
->
nÙifiÿtiÚ_süt
 = 
NULL
;

1222 
ri
->
ş›Á_»cÚfig_süt
 = 
NULL
;

1223 
ri
->
šfo
 = 
NULL
;

1226 
ri
->
rŞe_»pÜ‹d
 =„i->
æags
 & (
SRI_MASTER
|
SRI_SLAVE
);

1227 
ri
->
rŞe_»pÜ‹d_time
 = 
	`m¡ime
();

1228 
ri
->
¦ave_cÚf_chªge_time
 = 
	`m¡ime
();

1231 
	`diùAdd
(
bË
, 
ri
->
Çme
,„i);

1232  
ri
;

1233 
	}
}

1239 
	$»Ëa£S’tš–RedisIn¡ªû
(
£Áš–RedisIn¡ªû
 *
ri
) {

1241 
	`diùR–—£
(
ri
->
£Áš–s
);

1242 
	`diùR–—£
(
ri
->
¦aves
);

1245 
	`»Ëa£In¡ªûLšk
(
ri
->
lšk
,ri);

1248 
	`sdsä“
(
ri
->
Çme
);

1249 
	`sdsä“
(
ri
->
runid
);

1250 
	`sdsä“
(
ri
->
nÙifiÿtiÚ_süt
);

1251 
	`sdsä“
(
ri
->
ş›Á_»cÚfig_süt
);

1252 
	`sdsä“
(
ri
->
¦ave_ma¡”_ho¡
);

1253 
	`sdsä“
(
ri
->
Ëad”
);

1254 
	`sdsä“
(
ri
->
auth_·ss
);

1255 
	`sdsä“
(
ri
->
šfo
);

1256 
	`»Ëa£S’tš–Addr
(
ri
->
addr
);

1259 ià((
ri
->
æags
 & 
SRI_SLAVE
è&& (ri->æag & 
SRI_PROMOTED
è&&„i->
ma¡”
)

1260 
ri
->
ma¡”
->
´omÙed_¦ave
 = 
NULL
;

1262 
	`zä“
(
ri
);

1263 
	}
}

1266 
£Áš–RedisIn¡ªû
 *
	$£Áš–RedisIn¡ªûLookupSÏve
(

1267 
£Áš–RedisIn¡ªû
 *
ri
, *

, 
pÜt
)

1269 
sds
 
key
;

1270 
£Áš–RedisIn¡ªû
 *
¦ave
;

1271 
buf
[
NET_PEER_ID_LEN
];

1273 
	`£rv”As£¹
(
ri
->
æags
 & 
SRI_MASTER
);

1274 
	`ª‘FÜm©Addr
(
buf
,(buf),

,
pÜt
);

1275 
key
 = 
	`sd¢ew
(
buf
);

1276 
¦ave
 = 
	`diùF‘chV®ue
(
ri
->
¦aves
,
key
);

1277 
	`sdsä“
(
key
);

1278  
¦ave
;

1279 
	}
}

1282 cÚ¡ *
	$£Áš–RedisIn¡ªûTy³SŒ
(
£Áš–RedisIn¡ªû
 *
ri
) {

1283 ià(
ri
->
æags
 & 
SRI_MASTER
)  "master";

1284 ià(
ri
->
æags
 & 
SRI_SLAVE
)  "slave";

1285 ià(
ri
->
æags
 & 
SRI_SENTINEL
)  "sentinel";

1287 
	}
}

1300 
	$»moveM©chšgS’tš–FromMa¡”
(
£Áš–RedisIn¡ªû
 *
ma¡”
, *
runid
) {

1301 
diùI‹¿tÜ
 *
di
;

1302 
diùEÁry
 *
de
;

1303 
»moved
 = 0;

1305 ià(
runid
 =ğ
NULL
)  0;

1307 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
ma¡”
->
£Áš–s
);

1308 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1309 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

1311 ià(
ri
->
runid
 && 
	`¡rcmp
(ri->runid,runid) == 0) {

1312 
	`diùD–‘e
(
ma¡”
->
£Áš–s
,
ri
->
Çme
);

1313 
»moved
++;

1316 
	`diùR–—£I‹¿tÜ
(
di
);

1317  
»moved
;

1318 
	}
}

1326 
£Áš–RedisIn¡ªû
 *
	$g‘S’tš–RedisIn¡ªûByAddrAndRunID
(
diù
 *
š¡ªûs
, *

, 
pÜt
, *
runid
) {

1327 
diùI‹¿tÜ
 *
di
;

1328 
diùEÁry
 *
de
;

1329 
£Áš–RedisIn¡ªû
 *
š¡ªû
 = 
NULL
;

1331 
	`£rv”As£¹
(

 || 
runid
);

1332 
di
 = 
	`diùG‘I‹¿tÜ
(
š¡ªûs
);

1333 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1334 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

1336 ià(
runid
 && !
ri
->runid) ;

1337 ià((
runid
 =ğ
NULL
 || 
	`¡rcmp
(
ri
->runid,„unid) == 0) &&

1338 (

 =ğ
NULL
 || (
	`¡rcmp
(
ri
->
addr
->ip, ip) == 0 &&

1339 
ri
->
addr
->
pÜt
 ==…ort)))

1341 
š¡ªû
 = 
ri
;

1345 
	`diùR–—£I‹¿tÜ
(
di
);

1346  
š¡ªû
;

1347 
	}
}

1350 
£Áš–RedisIn¡ªû
 *
	$£Áš–G‘Ma¡”ByName
(*
Çme
) {

1351 
£Áš–RedisIn¡ªû
 *
ri
;

1352 
sds
 
sd¢ame
 = 
	`sd¢ew
(
Çme
);

1354 
ri
 = 
	`diùF‘chV®ue
(
£Áš–
.
ma¡”s
,
sd¢ame
);

1355 
	`sdsä“
(
sd¢ame
);

1356  
ri
;

1357 
	}
}

1360 
	$£Áš–AddFÏgsToDiùOfRedisIn¡ªûs
(
diù
 *
š¡ªûs
, 
æags
) {

1361 
diùI‹¿tÜ
 *
di
;

1362 
diùEÁry
 *
de
;

1364 
di
 = 
	`diùG‘I‹¿tÜ
(
š¡ªûs
);

1365 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1366 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

1367 
ri
->
æags
 |= flags;

1369 
	`diùR–—£I‹¿tÜ
(
di
);

1370 
	}
}

1374 
	$£Áš–D–FÏgsToDiùOfRedisIn¡ªûs
(
diù
 *
š¡ªûs
, 
æags
) {

1375 
diùI‹¿tÜ
 *
di
;

1376 
diùEÁry
 *
de
;

1378 
di
 = 
	`diùG‘I‹¿tÜ
(
š¡ªûs
);

1379 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1380 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

1381 
ri
->
æags
 &= ~flags;

1383 
	`diùR–—£I‹¿tÜ
(
di
);

1384 
	}
}

1397 
	#SENTINEL_RESET_NO_SENTINELS
 (1<<0)

	)

1398 
	$£Áš–Re£tMa¡”
(
£Áš–RedisIn¡ªû
 *
ri
, 
æags
) {

1399 
	`£rv”As£¹
(
ri
->
æags
 & 
SRI_MASTER
);

1400 
	`diùR–—£
(
ri
->
¦aves
);

1401 
ri
->
¦aves
 = 
	`diùC»©e
(&
š¡ªûsDiùTy³
,
NULL
);

1402 ià(!(
æags
 & 
SENTINEL_RESET_NO_SENTINELS
)) {

1403 
	`diùR–—£
(
ri
->
£Áš–s
);

1404 
ri
->
£Áš–s
 = 
	`diùC»©e
(&
š¡ªûsDiùTy³
,
NULL
);

1406 
	`š¡ªûLškClo£CÚÃùiÚ
(
ri
->
lšk
,ri->lšk->
cc
);

1407 
	`š¡ªûLškClo£CÚÃùiÚ
(
ri
->
lšk
,ri->lšk->
pc
);

1408 
ri
->
æags
 &ğ
SRI_MASTER
;

1409 ià(
ri
->
Ëad”
) {

1410 
	`sdsä“
(
ri
->
Ëad”
);

1411 
ri
->
Ëad”
 = 
NULL
;

1413 
ri
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_NONE
;

1414 
ri
->
çov”_¡©e_chªge_time
 = 0;

1415 
ri
->
çov”_¡¬t_time
 = 0;

1416 
ri
->
´omÙed_¦ave
 = 
NULL
;

1417 
	`sdsä“
(
ri
->
runid
);

1418 
	`sdsä“
(
ri
->
¦ave_ma¡”_ho¡
);

1419 
ri
->
runid
 = 
NULL
;

1420 
ri
->
¦ave_ma¡”_ho¡
 = 
NULL
;

1421 
ri
->
lšk
->
aù_pšg_time
 = 
	`m¡ime
();

1422 
ri
->
lšk
->
Ï¡_pšg_time
 = 0;

1423 
ri
->
lšk
->
Ï¡_ava_time
 = 
	`m¡ime
();

1424 
ri
->
lšk
->
Ï¡_pÚg_time
 = 
	`m¡ime
();

1425 
ri
->
rŞe_»pÜ‹d_time
 = 
	`m¡ime
();

1426 
ri
->
rŞe_»pÜ‹d
 = 
SRI_MASTER
;

1427 ià(
æags
 & 
SENTINEL_GENERATE_EVENT
)

1428 
	`£Áš–Ev’t
(
LL_WARNING
,"+»£t-ma¡”",
ri
,"%@");

1429 
	}
}

1433 
	$£Áš–Re£tMa¡”sByP©‹º
(*
·‰”n
, 
æags
) {

1434 
diùI‹¿tÜ
 *
di
;

1435 
diùEÁry
 *
de
;

1436 
»£t
 = 0;

1438 
di
 = 
	`diùG‘I‹¿tÜ
(
£Áš–
.
ma¡”s
);

1439 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1440 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

1442 ià(
ri
->
Çme
) {

1443 ià(
	`¡ršgm©ch
(
·‰”n
,
ri
->
Çme
,0)) {

1444 
	`£Áš–Re£tMa¡”
(
ri
,
æags
);

1445 
»£t
++;

1449 
	`diùR–—£I‹¿tÜ
(
di
);

1450  
»£t
;

1451 
	}
}

1460 
	$£Áš–Re£tMa¡”AndChªgeAdd»ss
(
£Áš–RedisIn¡ªû
 *
ma¡”
, *

, 
pÜt
) {

1461 
£Áš–Addr
 *
Şdaddr
, *
Ãwaddr
;

1462 
£Áš–Addr
 **
¦aves
 = 
NULL
;

1463 
num¦aves
 = 0, 
j
;

1464 
diùI‹¿tÜ
 *
di
;

1465 
diùEÁry
 *
de
;

1467 
Ãwaddr
 = 
	`ü—‹S’tš–Addr
(

,
pÜt
);

1468 ià(
Ãwaddr
 =ğ
NULL
è 
C_ERR
;

1472 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
¦aves
);

1473 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1474 
£Áš–RedisIn¡ªû
 *
¦ave
 = 
	`diùG‘V®
(
de
);

1476 ià(
	`£Áš–AddrIsEqu®
(
¦ave
->
addr
,
Ãwaddr
)) ;

1477 
¦aves
 = 
	`z»®loc
(¦aves,(
£Áš–Addr
*)*(
num¦aves
+1));

1478 
¦aves
[
num¦aves
++] = 
	`ü—‹S’tš–Addr
(
¦ave
->
addr
->

,

1479 
¦ave
->
addr
->
pÜt
);

1481 
	`diùR–—£I‹¿tÜ
(
di
);

1486 ià(!
	`£Áš–AddrIsEqu®
(
Ãwaddr
,
ma¡”
->
addr
)) {

1487 
¦aves
 = 
	`z»®loc
(¦aves,(
£Áš–Addr
*)*(
num¦aves
+1));

1488 
¦aves
[
num¦aves
++] = 
	`ü—‹S’tš–Addr
(
ma¡”
->
addr
->

,

1489 
ma¡”
->
addr
->
pÜt
);

1493 
	`£Áš–Re£tMa¡”
(
ma¡”
,
SENTINEL_RESET_NO_SENTINELS
);

1494 
Şdaddr
 = 
ma¡”
->
addr
;

1495 
ma¡”
->
addr
 = 
Ãwaddr
;

1496 
ma¡”
->
o_down_sšû_time
 = 0;

1497 
ma¡”
->
s_down_sšû_time
 = 0;

1500 
j
 = 0; j < 
num¦aves
; j++) {

1501 
£Áš–RedisIn¡ªû
 *
¦ave
;

1503 
¦ave
 = 
	`ü—‹S’tš–RedisIn¡ªû
(
NULL
,
SRI_SLAVE
,
¦aves
[
j
]->

,

1504 
¦aves
[
j
]->
pÜt
, 
ma¡”
->
quÜum
, master);

1505 
	`»Ëa£S’tš–Addr
(
¦aves
[
j
]);

1506 ià(
¦ave
è
	`£Áš–Ev’t
(
LL_NOTICE
,"+slave",slave,"%@");

1508 
	`zä“
(
¦aves
);

1512 
	`»Ëa£S’tš–Addr
(
Şdaddr
);

1513 
	`£Áš–FlushCÚfig
();

1514  
C_OK
;

1515 
	}
}

1519 
	$£Áš–RedisIn¡ªûNoDownFÜ
(
£Áš–RedisIn¡ªû
 *
ri
, 
m¡ime_t
 
ms
) {

1520 
m¡ime_t
 
mo¡_»ûÁ
;

1522 
mo¡_»ûÁ
 = 
ri
->
s_down_sšû_time
;

1523 ià(
ri
->
o_down_sšû_time
 > 
mo¡_»ûÁ
)

1524 
mo¡_»ûÁ
 = 
ri
->
o_down_sšû_time
;

1525  
mo¡_»ûÁ
 =ğ0 || (
	`m¡ime
(è- mo¡_»ûÁè> 
ms
;

1526 
	}
}

1530 
£Áš–Addr
 *
	$£Áš–G‘Cu¼’tMa¡”Add»ss
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

1536 ià((
ma¡”
->
æags
 & 
SRI_FAILOVER_IN_PROGRESS
) &&

1537 
ma¡”
->
´omÙed_¦ave
 &&

1538 
ma¡”
->
çov”_¡©e
 >ğ
SENTINEL_FAILOVER_STATE_RECONF_SLAVES
)

1540  
ma¡”
->
´omÙed_¦ave
->
addr
;

1542  
ma¡”
->
addr
;

1544 
	}
}

1548 
	$£Áš–Prİag©eDownAá”P”iod
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

1549 
diùI‹¿tÜ
 *
di
;

1550 
diùEÁry
 *
de
;

1551 
j
;

1552 
diù
 *
d
[] = {
ma¡”
->
¦aves
, ma¡”->
£Áš–s
, 
NULL
};

1554 
j
 = 0; 
d
[j]; j++) {

1555 
di
 = 
	`diùG‘I‹¿tÜ
(
d
[
j
]);

1556 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1557 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

1558 
ri
->
down_aá”_³riod
 = 
ma¡”
->down_after_period;

1560 
	`diùR–—£I‹¿tÜ
(
di
);

1562 
	}
}

1564 *
	$£Áš–G‘In¡ªûTy³SŒšg
(
£Áš–RedisIn¡ªû
 *
ri
) {

1565 ià(
ri
->
æags
 & 
SRI_MASTER
)  "master";

1566 ià(
ri
->
æags
 & 
SRI_SLAVE
)  "slave";

1567 ià(
ri
->
æags
 & 
SRI_SENTINEL
)  "sentinel";

1569 
	}
}

1572 *
	$£Áš–HªdËCÚfigu¿tiÚ
(**
¬gv
, 
¬gc
) {

1573 
£Áš–RedisIn¡ªû
 *
ri
;

1575 ià(!
	`¡rÿ£cmp
(
¬gv
[0],"mÚ™Ü"è&& 
¬gc
 == 5) {

1577 
quÜum
 = 
	`©oi
(
¬gv
[4]);

1579 ià(
quÜum
 <= 0)  "Quorum must be 1 or greater.";

1580 ià(
	`ü—‹S’tš–RedisIn¡ªû
(
¬gv
[1],
SRI_MASTER
,argv[2],

1581 
	`©oi
(
¬gv
[3]),
quÜum
,
NULL
) == NULL)

1583 
”ºo
) {

1584 
EBUSY
:  "Duplicated master‚ame.";

1585 
ENOENT
:  "Can't„esolve master instance hostname.";

1586 
EINVAL
:  "Invalid…ort‚umber";

1589 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"down-aá”-mli£cÚds"è&& 
¬gc
 == 3) {

1591 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1592 ià(!
ri
)  "No such master with specified‚ame.";

1593 
ri
->
down_aá”_³riod
 = 
	`©oi
(
¬gv
[2]);

1594 ià(
ri
->
down_aá”_³riod
 <= 0)

1596 
	`£Áš–Prİag©eDownAá”P”iod
(
ri
);

1597 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"çov”-timeout"è&& 
¬gc
 == 3) {

1599 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1600 ià(!
ri
)  "No such master with specified‚ame.";

1601 
ri
->
çov”_timeout
 = 
	`©oi
(
¬gv
[2]);

1602 ià(
ri
->
çov”_timeout
 <= 0)

1604 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"·¿Î–-syncs"è&& 
¬gc
 == 3) {

1606 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1607 ià(!
ri
)  "No such master with specified‚ame.";

1608 
ri
->
·¿Î–_syncs
 = 
	`©oi
(
¬gv
[2]);

1609 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"nÙifiÿtiÚ-süt"è&& 
¬gc
 == 3) {

1611 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1612 ià(!
ri
)  "No such master with specified‚ame.";

1613 ià(
	`acûss
(
¬gv
[2],
X_OK
) == -1)

1615 
ri
->
nÙifiÿtiÚ_süt
 = 
	`sd¢ew
(
¬gv
[2]);

1616 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"ş›Á-»cÚfig-süt"è&& 
¬gc
 == 3) {

1618 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1619 ià(!
ri
)  "No such master with specified‚ame.";

1620 ià(
	`acûss
(
¬gv
[2],
X_OK
) == -1)

1623 
ri
->
ş›Á_»cÚfig_süt
 = 
	`sd¢ew
(
¬gv
[2]);

1624 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"auth-·ss"è&& 
¬gc
 == 3) {

1626 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1627 ià(!
ri
)  "No such master with specified‚ame.";

1628 
ri
->
auth_·ss
 = 
	`sd¢ew
(
¬gv
[2]);

1629 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"cu¼’t-•och"è&& 
¬gc
 == 2) {

1631 
cu¼’t_•och
 = 
	`¡¹ouÎ
(
¬gv
[1],
NULL
,10);

1632 ià(
cu¼’t_•och
 > 
£Áš–
.current_epoch)

1633 
£Áš–
.
cu¼’t_•och
 = current_epoch;

1634 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"myid"è&& 
¬gc
 == 2) {

1635 ià(
	`¡¾’
(
¬gv
[1]è!ğ
CONFIG_RUN_ID_SIZE
)

1637 
	`memıy
(
£Áš–
.
myid
,
¬gv
[1],
CONFIG_RUN_ID_SIZE
);

1638 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"cÚfig-•och"è&& 
¬gc
 == 3) {

1640 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1641 ià(!
ri
)  "No such master with specified‚ame.";

1642 
ri
->
cÚfig_•och
 = 
	`¡¹ouÎ
(
¬gv
[2],
NULL
,10);

1646 ià(
ri
->
cÚfig_•och
 > 
£Áš–
.
cu¼’t_•och
)

1647 
£Áš–
.
cu¼’t_•och
 = 
ri
->
cÚfig_•och
;

1648 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"Ëad”-•och"è&& 
¬gc
 == 3) {

1650 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1651 ià(!
ri
)  "No such master with specified‚ame.";

1652 
ri
->
Ëad”_•och
 = 
	`¡¹ouÎ
(
¬gv
[2],
NULL
,10);

1653 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"known-¦ave"è&& 
¬gc
 == 4) {

1654 
£Áš–RedisIn¡ªû
 *
¦ave
;

1657 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1658 ià(!
ri
)  "No such master with specified‚ame.";

1659 ià((
¦ave
 = 
	`ü—‹S’tš–RedisIn¡ªû
(
NULL
,
SRI_SLAVE
,
¬gv
[2],

1660 
	`©oi
(
¬gv
[3]), 
ri
->
quÜum
,„i)è=ğ
NULL
)

1664 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"known-sentinel") &&

1665 (
¬gc
 == 4 ||‡rgc == 5)) {

1666 
£Áš–RedisIn¡ªû
 *
si
;

1668 ià(
¬gc
 == 5) {

1670 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1671 ià(!
ri
)  "No such master with specified‚ame.";

1672 ià((
si
 = 
	`ü—‹S’tš–RedisIn¡ªû
(
¬gv
[4],
SRI_SENTINEL
,argv[2],

1673 
	`©oi
(
¬gv
[3]), 
ri
->
quÜum
,„i)è=ğ
NULL
)

1677 
si
->
runid
 = 
	`sd¢ew
(
¬gv
[4]);

1678 
	`£Áš–TryCÚÃùiÚSh¬šg
(
si
);

1680 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"ªnounû-"è&& 
¬gc
 == 2) {

1682 ià(
	`¡¾’
(
¬gv
[1]))

1683 
£Áš–
.
ªnounû_
 = 
	`sd¢ew
(
¬gv
[1]);

1684 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"ªnounû-pÜt"è&& 
¬gc
 == 2) {

1686 
£Áš–
.
ªnounû_pÜt
 = 
	`©oi
(
¬gv
[1]);

1690  
NULL
;

1691 
	}
}

1698 
	$»wr™eCÚfigS’tš–O±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1699 
diùI‹¿tÜ
 *
di
, *
di2
;

1700 
diùEÁry
 *
de
;

1701 
sds
 
lše
;

1704 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(), "£Áš– myid %s", 
£Áš–
.
myid
);

1705 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1708 
di
 = 
	`diùG‘I‹¿tÜ
(
£Áš–
.
ma¡”s
);

1709 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1710 
£Áš–RedisIn¡ªû
 *
ma¡”
, *
ri
;

1711 
£Áš–Addr
 *
ma¡”_addr
;

1714 
ma¡”
 = 
	`diùG‘V®
(
de
);

1715 
ma¡”_addr
 = 
	`£Áš–G‘Cu¼’tMa¡”Add»ss
(
ma¡”
);

1716 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"sentinel monitor %s %s %d %d",

1717 
ma¡”
->
Çme
, 
ma¡”_addr
->

, ma¡”_addr->
pÜt
,

1718 
ma¡”
->
quÜum
);

1719 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1722 ià(
ma¡”
->
down_aá”_³riod
 !ğ
SENTINEL_DEFAULT_DOWN_AFTER
) {

1723 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1725 
ma¡”
->
Çme
, (èma¡”->
down_aá”_³riod
);

1726 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1730 ià(
ma¡”
->
çov”_timeout
 !ğ
SENTINEL_DEFAULT_FAILOVER_TIMEOUT
) {

1731 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1733 
ma¡”
->
Çme
, (èma¡”->
çov”_timeout
);

1734 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1738 ià(
ma¡”
->
·¿Î–_syncs
 !ğ
SENTINEL_DEFAULT_PARALLEL_SYNCS
) {

1739 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1741 
ma¡”
->
Çme
, ma¡”->
·¿Î–_syncs
);

1742 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1746 ià(
ma¡”
->
nÙifiÿtiÚ_süt
) {

1747 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1749 
ma¡”
->
Çme
, ma¡”->
nÙifiÿtiÚ_süt
);

1750 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1754 ià(
ma¡”
->
ş›Á_»cÚfig_süt
) {

1755 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1757 
ma¡”
->
Çme
, ma¡”->
ş›Á_»cÚfig_süt
);

1758 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1762 ià(
ma¡”
->
auth_·ss
) {

1763 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1765 
ma¡”
->
Çme
, ma¡”->
auth_·ss
);

1766 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1770 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1772 
ma¡”
->
Çme
, (èma¡”->
cÚfig_•och
);

1773 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1776 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1778 
ma¡”
->
Çme
, (èma¡”->
Ëad”_•och
);

1779 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1782 
di2
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
¦aves
);

1783 (
de
 = 
	`diùNext
(
di2
)è!ğ
NULL
) {

1784 
£Áš–Addr
 *
¦ave_addr
;

1786 
ri
 = 
	`diùG‘V®
(
de
);

1787 
¦ave_addr
 = 
ri
->
addr
;

1794 ià(
	`£Áš–AddrIsEqu®
(
¦ave_addr
,
ma¡”_addr
))

1795 
¦ave_addr
 = 
ma¡”
->
addr
;

1796 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1798 
ma¡”
->
Çme
, 
¦ave_addr
->

, sÏve_addr->
pÜt
);

1799 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1801 
	`diùR–—£I‹¿tÜ
(
di2
);

1804 
di2
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
£Áš–s
);

1805 (
de
 = 
	`diùNext
(
di2
)è!ğ
NULL
) {

1806 
ri
 = 
	`diùG‘V®
(
de
);

1807 ià(
ri
->
runid
 =ğ
NULL
) ;

1808 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1810 
ma¡”
->
Çme
, 
ri
->
addr
->

,„i->addr->
pÜt
,„i->
runid
);

1811 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1813 
	`diùR–—£I‹¿tÜ
(
di2
);

1817 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1818 "£Áš– cu¼’t-•och %Îu", (è
£Áš–
.
cu¼’t_•och
);

1819 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1822 ià(
£Áš–
.
ªnounû_
) {

1823 
lše
 = 
	`sd¢ew
("sentinel‡nnounce-ip ");

1824 
lše
 = 
	`sdsÿŒ•r
Öše, 
£Áš–
.
ªnounû_
, 
	`sd¦’
(sentinel.announce_ip));

1825 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1829 ià(
£Áš–
.
ªnounû_pÜt
) {

1830 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"sentinel‡nnounce-port %d",

1831 
£Áš–
.
ªnounû_pÜt
);

1832 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1835 
	`diùR–—£I‹¿tÜ
(
di
);

1836 
	}
}

1845 
	$£Áš–FlushCÚfig
() {

1846 
fd
 = -1;

1847 
§ved_hz
 = 
£rv”
.
hz
;

1848 
»wr™e_¡©us
;

1850 
£rv”
.
hz
 = 
CONFIG_DEFAULT_HZ
;

1851 
»wr™e_¡©us
 = 
	`»wr™eCÚfig
(
£rv”
.
cÚfigfe
);

1852 
£rv”
.
hz
 = 
§ved_hz
;

1854 ià(
»wr™e_¡©us
 =ğ-1è
w”r
;

1855 ià((
fd
 = 
	`İ’
(
£rv”
.
cÚfigfe
,
O_RDONLY
)è=ğ-1è
w”r
;

1856 ià(
	`fsync
(
fd
è=ğ-1è
w”r
;

1857 ià(
	`şo£
(
fd
è=ğ
EOF
è
w”r
;

1860 
w”r
:

1861 ià(
fd
 !ğ-1è
	`şo£
(fd);

1862 
	`£rv”Log
(
LL_WARNING
,"WARNING: S’tš– wa nÙ‡bËØ§vthÃw cÚfigu¿tiÚ oÀdisk!!!: %s", 
	`¡»¼Ü
(
”ºo
));

1863 
	}
}

1873 
	$£Áš–S’dAuthIfN“ded
(
£Áš–RedisIn¡ªû
 *
ri
, 
»disAsyncCÚ‹xt
 *
c
) {

1874 *
auth_·ss
 = (
ri
->
æags
 & 
SRI_MASTER
) ?„i->auth_pass :

1875 
ri
->
ma¡”
->
auth_·ss
;

1877 ià(
auth_·ss
) {

1878 ià(
	`»disAsyncCommªd
(
c
, 
£Áš–DisÿrdR•lyC®lback
, 
ri
, "AUTH %s",

1879 
auth_·ss
è=ğ
C_OK
è
ri
->
lšk
->
³ndšg_commªds
++;

1881 
	}
}

1889 
	$£Áš–S‘Cl›ÁName
(
£Áš–RedisIn¡ªû
 *
ri
, 
»disAsyncCÚ‹xt
 *
c
, *
ty³
) {

1890 
Çme
[64];

1892 
	`¢´štf
(
Çme
,Òame),"£Áš–-%.8s-%s",
£Áš–
.
myid
,
ty³
);

1893 ià(
	`»disAsyncCommªd
(
c
, 
£Áš–DisÿrdR•lyC®lback
, 
ri
,

1894 "CLIENT SETNAME %s", 
Çme
è=ğ
C_OK
)

1896 
ri
->
lšk
->
³ndšg_commªds
++;

1898 
	}
}

1903 
	$£Áš–RecÚÃùIn¡ªû
(
£Áš–RedisIn¡ªû
 *
ri
) {

1904 ià(
ri
->
lšk
->
discÚÃùed
 == 0) ;

1905 ià(
ri
->
addr
->
pÜt
 == 0) ;

1906 
š¡ªûLšk
 *
lšk
 = 
ri
->link;

1907 
m¡ime_t
 
now
 = 
	`m¡ime
();

1909 ià(
now
 - 
ri
->
lšk
->
Ï¡_»cÚn_time
 < 
SENTINEL_PING_PERIOD
) ;

1910 
ri
->
lšk
->
Ï¡_»cÚn_time
 = 
now
;

1913 ià(
lšk
->
cc
 =ğ
NULL
) {

1914 
lšk
->
cc
 = 
	`»disAsyncCÚÃùBšd
(
ri
->
addr
->

,ri->addr->
pÜt
,
NET_FIRST_BIND_ADDR
);

1915 ià(
lšk
->
cc
->
”r
) {

1916 
	`£Áš–Ev’t
(
LL_DEBUG
,"-cmd-lšk-»cÚÃùiÚ",
ri
,"%@ #%s",

1917 
lšk
->
cc
->
”r¡r
);

1918 
	`š¡ªûLškClo£CÚÃùiÚ
(
lšk
,lšk->
cc
);

1920 
lšk
->
³ndšg_commªds
 = 0;

1921 
lšk
->
cc_cÚn_time
 = 
	`m¡ime
();

1922 
lšk
->
cc
->
d©a
 =†ink;

1923 
	`»disAeA‰ach
(
£rv”
.
–
,
lšk
->
cc
);

1924 
	`»disAsyncS‘CÚÃùC®lback
(
lšk
->
cc
,

1925 
£Áš–LškE¡ablishedC®lback
);

1926 
	`»disAsyncS‘DiscÚÃùC®lback
(
lšk
->
cc
,

1927 
£Áš–DiscÚÃùC®lback
);

1928 
	`£Áš–S’dAuthIfN“ded
(
ri
,
lšk
->
cc
);

1929 
	`£Áš–S‘Cl›ÁName
(
ri
,
lšk
->
cc
,"cmd");

1932 
	`£Áš–S’dPšg
(
ri
);

1936 ià((
ri
->
æags
 & (
SRI_MASTER
|
SRI_SLAVE
)è&& 
lšk
->
pc
 =ğ
NULL
) {

1937 
lšk
->
pc
 = 
	`»disAsyncCÚÃùBšd
(
ri
->
addr
->

,ri->addr->
pÜt
,
NET_FIRST_BIND_ADDR
);

1938 ià(
lšk
->
pc
->
”r
) {

1939 
	`£Áš–Ev’t
(
LL_DEBUG
,"-pubsub-lšk-»cÚÃùiÚ",
ri
,"%@ #%s",

1940 
lšk
->
pc
->
”r¡r
);

1941 
	`š¡ªûLškClo£CÚÃùiÚ
(
lšk
,lšk->
pc
);

1943 
»tv®
;

1945 
lšk
->
pc_cÚn_time
 = 
	`m¡ime
();

1946 
lšk
->
pc
->
d©a
 =†ink;

1947 
	`»disAeA‰ach
(
£rv”
.
–
,
lšk
->
pc
);

1948 
	`»disAsyncS‘CÚÃùC®lback
(
lšk
->
pc
,

1949 
£Áš–LškE¡ablishedC®lback
);

1950 
	`»disAsyncS‘DiscÚÃùC®lback
(
lšk
->
pc
,

1951 
£Áš–DiscÚÃùC®lback
);

1952 
	`£Áš–S’dAuthIfN“ded
(
ri
,
lšk
->
pc
);

1953 
	`£Áš–S‘Cl›ÁName
(
ri
,
lšk
->
pc
,"pubsub");

1955 
»tv®
 = 
	`»disAsyncCommªd
(
lšk
->
pc
,

1956 
£Áš–ReûiveH–loMes§ges
, 
ri
, "SUBSCRIBE %s",

1957 
SENTINEL_HELLO_CHANNEL
);

1958 ià(
»tv®
 !ğ
C_OK
) {

1961 
	`š¡ªûLškClo£CÚÃùiÚ
(
lšk
,lšk->
pc
);

1968 ià(
lšk
->
cc
 && (
ri
->
æags
 & 
SRI_SENTINEL
 ||†šk->
pc
))

1969 
lšk
->
discÚÃùed
 = 0;

1970 
	}
}

1979 
	$£Áš–Ma¡”LooksSªe
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

1981 
ma¡”
->
æags
 & 
SRI_MASTER
 &&

1982 
ma¡”
->
rŞe_»pÜ‹d
 =ğ
SRI_MASTER
 &&

1983 (
ma¡”
->
æags
 & (
SRI_S_DOWN
|
SRI_O_DOWN
)) == 0 &&

1984 (
	`m¡ime
(è- 
ma¡”
->
šfo_»äesh
è< 
SENTINEL_INFO_PERIOD
*2;

1985 
	}
}

1988 
	$£Áš–ReäeshIn¡ªûInfo
(
£Áš–RedisIn¡ªû
 *
ri
, cÚ¡ *
šfo
) {

1989 
sds
 *
lšes
;

1990 
numlšes
, 
j
;

1991 
rŞe
 = 0;

1994 
	`sdsä“
(
ri
->
šfo
);

1995 
ri
->
šfo
 = 
	`sd¢ew
(info);

1999 
ri
->
ma¡”_lšk_down_time
 = 0;

2002 
lšes
 = 
	`sds¥l™Ën
(
šfo
,
	`¡¾’
(šfo),"\r\n",2,&
numlšes
);

2003 
j
 = 0; j < 
numlšes
; j++) {

2004 
£Áš–RedisIn¡ªû
 *
¦ave
;

2005 
sds
 
l
 = 
lšes
[
j
];

2008 ià(
	`sd¦’
(
l
è>ğ47 && !
	`memcmp
(l,"run_id:",7)) {

2009 ià(
ri
->
runid
 =ğ
NULL
) {

2010 
ri
->
runid
 = 
	`sd¢ewËn
(
l
+7,40);

2012 ià(
	`¡ºcmp
(
ri
->
runid
,
l
+7,40) != 0) {

2013 
	`£Áš–Ev’t
(
LL_NOTICE
,"+»boÙ",
ri
,"%@");

2014 
	`sdsä“
(
ri
->
runid
);

2015 
ri
->
runid
 = 
	`sd¢ewËn
(
l
+7,40);

2022 ià((
ri
->
æags
 & 
SRI_MASTER
) &&

2023 
	`sd¦’
(
l
) >= 7 &&

2024 !
	`memcmp
(
l
,"¦ave",5è&& 
	`isdig™
(l[5]))

2026 *

, *
pÜt
, *
’d
;

2028 ià(
	`¡r¡r
(
l
,"="è=ğ
NULL
) {

2030 

 = 
	`¡rchr
(
l
,':'); if (!ip) ;

2031 

++;

2032 
pÜt
 = 
	`¡rchr
(

,','); if (!port) ;

2033 *
pÜt
 = '\0';

2034 
pÜt
++;

2035 
’d
 = 
	`¡rchr
(
pÜt
,','); if (!end) ;

2036 *
’d
 = '\0';

2039 

 = 
	`¡r¡r
(
l
,"ip="); if (!ip) ;

2040 

 += 3;

2041 
pÜt
 = 
	`¡r¡r
(
l
,"port="); if (!port) ;

2042 
pÜt
 += 5;

2044 
’d
 = 
	`¡rchr
(

,','); if (end) *end = '\0';

2045 
’d
 = 
	`¡rchr
(
pÜt
,','); if (end) *end = '\0';

2050 ià(
	`£Áš–RedisIn¡ªûLookupSÏve
(
ri
,

,
	`©oi
(
pÜt
)è=ğ
NULL
) {

2051 ià((
¦ave
 = 
	`ü—‹S’tš–RedisIn¡ªû
(
NULL
,
SRI_SLAVE
,

,

2052 
	`©oi
(
pÜt
), 
ri
->
quÜum
,„i)è!ğ
NULL
)

2054 
	`£Áš–Ev’t
(
LL_NOTICE
,"+¦ave",
¦ave
,"%@");

2055 
	`£Áš–FlushCÚfig
();

2061 ià(
	`sd¦’
(
l
) >= 32 &&

2062 !
	`memcmp
(
l
,"master_link_down_since_seconds",30))

2064 
ri
->
ma¡”_lšk_down_time
 = 
	`¡¹Şl
(
l
+31,
NULL
,10)*1000;

2068 ià(!
	`memcmp
(
l
,"rŞe:ma¡”",11)è
rŞe
 = 
SRI_MASTER
;

2069 ià(!
	`memcmp
(
l
,"rŞe:¦ave",10)è
rŞe
 = 
SRI_SLAVE
;

2071 ià(
rŞe
 =ğ
SRI_SLAVE
) {

2073 ià(
	`sd¦’
(
l
è>ğ12 && !
	`memcmp
(l,"master_host:",12)) {

2074 ià(
ri
->
¦ave_ma¡”_ho¡
 =ğ
NULL
 ||

2075 
	`¡rÿ£cmp
(
l
+12,
ri
->
¦ave_ma¡”_ho¡
))

2077 
	`sdsä“
(
ri
->
¦ave_ma¡”_ho¡
);

2078 
ri
->
¦ave_ma¡”_ho¡
 = 
	`sd¢ew
(
l
+12);

2079 
ri
->
¦ave_cÚf_chªge_time
 = 
	`m¡ime
();

2084 ià(
	`sd¦’
(
l
è>ğ12 && !
	`memcmp
(l,"master_port:",12)) {

2085 
¦ave_ma¡”_pÜt
 = 
	`©oi
(
l
+12);

2087 ià(
ri
->
¦ave_ma¡”_pÜt
 != slave_master_port) {

2088 
ri
->
¦ave_ma¡”_pÜt
 = slave_master_port;

2089 
ri
->
¦ave_cÚf_chªge_time
 = 
	`m¡ime
();

2094 ià(
	`sd¦’
(
l
è>ğ19 && !
	`memcmp
(l,"master_link_status:",19)) {

2095 
ri
->
¦ave_ma¡”_lšk_¡©us
 =

2096 (
	`¡rÿ£cmp
(
l
+19,"up") == 0) ?

2097 
SENTINEL_MASTER_LINK_STATUS_UP
 :

2098 
SENTINEL_MASTER_LINK_STATUS_DOWN
;

2102 ià(
	`sd¦’
(
l
è>ğ15 && !
	`memcmp
(l,"slave_priority:",15))

2103 
ri
->
¦ave_´iÜ™y
 = 
	`©oi
(
l
+15);

2106 ià(
	`sd¦’
(
l
è>ğ18 && !
	`memcmp
(l,"slave_repl_offset:",18))

2107 
ri
->
¦ave_»¶_off£t
 = 
	`¡¹ouÎ
(
l
+18,
NULL
,10);

2110 
ri
->
šfo_»äesh
 = 
	`m¡ime
();

2111 
	`sdsä“¥l™»s
(
lšes
,
numlšes
);

2118 ià(
rŞe
 !ğ
ri
->
rŞe_»pÜ‹d
) {

2119 
ri
->
rŞe_»pÜ‹d_time
 = 
	`m¡ime
();

2120 
ri
->
rŞe_»pÜ‹d
 = 
rŞe
;

2121 ià(
rŞe
 =ğ
SRI_SLAVE
è
ri
->
¦ave_cÚf_chªge_time
 = 
	`m¡ime
();

2124 
	`£Áš–Ev’t
(
LL_VERBOSE
,

2125 ((
ri
->
æags
 & (
SRI_MASTER
|
SRI_SLAVE
)è=ğ
rŞe
) ?

2127 
ri
, "%@‚ew„eported„ole is %s",

2128 
rŞe
 =ğ
SRI_MASTER
 ? "master" : "slave",

2129 
ri
->
æags
 & 
SRI_MASTER
 ? "master" : "slave");

2134 ià(
£Áš–
.
tt
) ;

2137 ià((
ri
->
æags
 & 
SRI_MASTER
è&& 
rŞe
 =ğ
SRI_SLAVE
) {

2144 ià((
ri
->
æags
 & 
SRI_SLAVE
è&& 
rŞe
 =ğ
SRI_MASTER
) {

2147 ià((
ri
->
æags
 & 
SRI_PROMOTED
) &&

2148 (
ri
->
ma¡”
->
æags
 & 
SRI_FAILOVER_IN_PROGRESS
) &&

2149 (
ri
->
ma¡”
->
çov”_¡©e
 ==

2150 
SENTINEL_FAILOVER_STATE_WAIT_PROMOTION
))

2157 
ri
->
ma¡”
->
cÚfig_•och
 =„i->ma¡”->
çov”_•och
;

2158 
ri
->
ma¡”
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_RECONF_SLAVES
;

2159 
ri
->
ma¡”
->
çov”_¡©e_chªge_time
 = 
	`m¡ime
();

2160 
	`£Áš–FlushCÚfig
();

2161 
	`£Áš–Ev’t
(
LL_WARNING
,"+´omÙed-¦ave",
ri
,"%@");

2162 ià(
£Áš–
.
simçu»_æags
 &

2163 
SENTINEL_SIMFAILURE_CRASH_AFTER_PROMOTION
)

2164 
	`£Áš–SimFau»C¿sh
();

2165 
	`£Áš–Ev’t
(
LL_WARNING
,"+failover-state-reconf-slaves",

2166 
ri
->
ma¡”
,"%@");

2167 
	`£Áš–C®lCl›ÁRecÚfSüt
(
ri
->
ma¡”
,
SENTINEL_LEADER
,

2168 "¡¬t",
ri
->
ma¡”
->
addr
,ri->addr);

2169 
	`£Áš–FÜûH–loUpd©eFÜMa¡”
(
ri
->
ma¡”
);

2174 
m¡ime_t
 
wa™_time
 = 
SENTINEL_PUBLISH_PERIOD
*4;

2176 ià(!(
ri
->
æags
 & 
SRI_PROMOTED
) &&

2177 
	`£Áš–Ma¡”LooksSªe
(
ri
->
ma¡”
) &&

2178 
	`£Áš–RedisIn¡ªûNoDownFÜ
(
ri
,
wa™_time
) &&

2179 
	`m¡ime
(è- 
ri
->
rŞe_»pÜ‹d_time
 > 
wa™_time
)

2181 
»tv®
 = 
	`£Áš–S’dSÏveOf
(
ri
,

2182 
ri
->
ma¡”
->
addr
->

,

2183 
ri
->
ma¡”
->
addr
->
pÜt
);

2184 ià(
»tv®
 =ğ
C_OK
)

2185 
	`£Áš–Ev’t
(
LL_NOTICE
,"+cÚv”t-to-¦ave",
ri
,"%@");

2191 ià((
ri
->
æags
 & 
SRI_SLAVE
) &&

2192 
rŞe
 =ğ
SRI_SLAVE
 &&

2193 (
ri
->
¦ave_ma¡”_pÜt
 !ğri->
ma¡”
->
addr
->
pÜt
 ||

2194 
	`¡rÿ£cmp
(
ri
->
¦ave_ma¡”_ho¡
,ri->
ma¡”
->
addr
->

)))

2196 
m¡ime_t
 
wa™_time
 = 
ri
->
ma¡”
->
çov”_timeout
;

2200 ià(
	`£Áš–Ma¡”LooksSªe
(
ri
->
ma¡”
) &&

2201 
	`£Áš–RedisIn¡ªûNoDownFÜ
(
ri
,
wa™_time
) &&

2202 
	`m¡ime
(è- 
ri
->
¦ave_cÚf_chªge_time
 > 
wa™_time
)

2204 
»tv®
 = 
	`£Áš–S’dSÏveOf
(
ri
,

2205 
ri
->
ma¡”
->
addr
->

,

2206 
ri
->
ma¡”
->
addr
->
pÜt
);

2207 ià(
»tv®
 =ğ
C_OK
)

2208 
	`£Áš–Ev’t
(
LL_NOTICE
,"+fix-¦ave-cÚfig",
ri
,"%@");

2214 ià((
ri
->
æags
 & 
SRI_SLAVE
è&& 
rŞe
 == SRI_SLAVE &&

2215 (
ri
->
æags
 & (
SRI_RECONF_SENT
|
SRI_RECONF_INPROG
)))

2218 ià((
ri
->
æags
 & 
SRI_RECONF_SENT
) &&

2219 
ri
->
¦ave_ma¡”_ho¡
 &&

2220 
	`¡rcmp
(
ri
->
¦ave_ma¡”_ho¡
,

2221 
ri
->
ma¡”
->
´omÙed_¦ave
->
addr
->

) == 0 &&

2222 
ri
->
¦ave_ma¡”_pÜt
 =ğri->
ma¡”
->
´omÙed_¦ave
->
addr
->
pÜt
)

2224 
ri
->
æags
 &ğ~
SRI_RECONF_SENT
;

2225 
ri
->
æags
 |ğ
SRI_RECONF_INPROG
;

2226 
	`£Áš–Ev’t
(
LL_NOTICE
,"+¦ave-»cÚf-š´og",
ri
,"%@");

2230 ià((
ri
->
æags
 & 
SRI_RECONF_INPROG
) &&

2231 
ri
->
¦ave_ma¡”_lšk_¡©us
 =ğ
SENTINEL_MASTER_LINK_STATUS_UP
)

2233 
ri
->
æags
 &ğ~
SRI_RECONF_INPROG
;

2234 
ri
->
æags
 |ğ
SRI_RECONF_DONE
;

2235 
	`£Áš–Ev’t
(
LL_NOTICE
,"+¦ave-»cÚf-dÚe",
ri
,"%@");

2238 
	}
}

2240 
	$£Áš–InfoR•lyC®lback
(
»disAsyncCÚ‹xt
 *
c
, *
»¶y
, *
´ivd©a
) {

2241 
£Áš–RedisIn¡ªû
 *
ri
 = 
´ivd©a
;

2242 
š¡ªûLšk
 *
lšk
 = 
c
->
d©a
;

2243 
»disR•ly
 *
r
;

2245 ià(!
»¶y
 || !
lšk
) ;

2246 
lšk
->
³ndšg_commªds
--;

2247 
r
 = 
»¶y
;

2249 ià(
r
->
ty³
 =ğ
REDIS_REPLY_STRING
)

2250 
	`£Áš–ReäeshIn¡ªûInfo
(
ri
,
r
->
¡r
);

2251 
	}
}

2255 
	$£Áš–DisÿrdR•lyC®lback
(
»disAsyncCÚ‹xt
 *
c
, *
»¶y
, *
´ivd©a
) {

2256 
š¡ªûLšk
 *
lšk
 = 
c
->
d©a
;

2257 
	`UNUSED
(
»¶y
);

2258 
	`UNUSED
(
´ivd©a
);

2260 ià(
lšk
èlšk->
³ndšg_commªds
--;

2261 
	}
}

2263 
	$£Áš–PšgR•lyC®lback
(
»disAsyncCÚ‹xt
 *
c
, *
»¶y
, *
´ivd©a
) {

2264 
£Áš–RedisIn¡ªû
 *
ri
 = 
´ivd©a
;

2265 
š¡ªûLšk
 *
lšk
 = 
c
->
d©a
;

2266 
»disR•ly
 *
r
;

2268 ià(!
»¶y
 || !
lšk
) ;

2269 
lšk
->
³ndšg_commªds
--;

2270 
r
 = 
»¶y
;

2272 ià(
r
->
ty³
 =ğ
REDIS_REPLY_STATUS
 ||

2273 
r
->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

2276 ià(
	`¡ºcmp
(
r
->
¡r
,"PONG",4) == 0 ||

2277 
	`¡ºcmp
(
r
->
¡r
,"LOADING",7) == 0 ||

2278 
	`¡ºcmp
(
r
->
¡r
,"MASTERDOWN",10) == 0)

2280 
lšk
->
Ï¡_ava_time
 = 
	`m¡ime
();

2281 
lšk
->
aù_pšg_time
 = 0;

2285 ià(
	`¡ºcmp
(
r
->
¡r
,"BUSY",4) == 0 &&

2286 (
ri
->
æags
 & 
SRI_S_DOWN
) &&

2287 !(
ri
->
æags
 & 
SRI_SCRIPT_KILL_SENT
))

2289 ià(
	`»disAsyncCommªd
(
ri
->
lšk
->
cc
,

2290 
£Áš–DisÿrdR•lyC®lback
, 
ri
,

2291 "SCRIPT KILL"è=ğ
C_OK
)

2292 
ri
->
lšk
->
³ndšg_commªds
++;

2293 
ri
->
æags
 |ğ
SRI_SCRIPT_KILL_SENT
;

2297 
lšk
->
Ï¡_pÚg_time
 = 
	`m¡ime
();

2298 
	}
}

2302 
	$£Áš–PublishR•lyC®lback
(
»disAsyncCÚ‹xt
 *
c
, *
»¶y
, *
´ivd©a
) {

2303 
£Áš–RedisIn¡ªû
 *
ri
 = 
´ivd©a
;

2304 
š¡ªûLšk
 *
lšk
 = 
c
->
d©a
;

2305 
»disR•ly
 *
r
;

2307 ià(!
»¶y
 || !
lšk
) ;

2308 
lšk
->
³ndšg_commªds
--;

2309 
r
 = 
»¶y
;

2313 ià(
r
->
ty³
 !ğ
REDIS_REPLY_ERROR
)

2314 
ri
->
Ï¡_pub_time
 = 
	`m¡ime
();

2315 
	}
}

2322 
	$£Áš–ProûssH–loMes§ge
(*
h–lo
, 
h–lo_Ën
) {

2326 
numtok’s
, 
pÜt
, 
»moved
, 
ma¡”_pÜt
;

2327 
ušt64_t
 
cu¼’t_•och
, 
ma¡”_cÚfig_•och
;

2328 **
tok’
 = 
	`sds¥l™Ën
(
h–lo
, 
h–lo_Ën
, ",", 1, &
numtok’s
);

2329 
£Áš–RedisIn¡ªû
 *
si
, *
ma¡”
;

2331 ià(
numtok’s
 == 8) {

2333 
ma¡”
 = 
	`£Áš–G‘Ma¡”ByName
(
tok’
[4]);

2334 ià(!
ma¡”
è
ş—nup
;

2337 
pÜt
 = 
	`©oi
(
tok’
[1]);

2338 
ma¡”_pÜt
 = 
	`©oi
(
tok’
[6]);

2339 
si
 = 
	`g‘S’tš–RedisIn¡ªûByAddrAndRunID
(

2340 
ma¡”
->
£Áš–s
,
tok’
[0],
pÜt
,token[2]);

2341 
cu¼’t_•och
 = 
	`¡¹ouÎ
(
tok’
[3],
NULL
,10);

2342 
ma¡”_cÚfig_•och
 = 
	`¡¹ouÎ
(
tok’
[7],
NULL
,10);

2344 ià(!
si
) {

2348 
»moved
 = 
	`»moveM©chšgS’tš–FromMa¡”
(
ma¡”
,
tok’
[2]);

2349 ià(
»moved
) {

2350 
	`£Áš–Ev’t
(
LL_NOTICE
,"+£Áš–-add»ss-sw™ch",
ma¡”
,

2351 "%@ i°% pÜˆ%d fÜ %s", 
tok’
[0],
pÜt
,token[2]);

2357 
£Áš–RedisIn¡ªû
 *
Ùh”
 =

2358 
	`g‘S’tš–RedisIn¡ªûByAddrAndRunID
(

2359 
ma¡”
->
£Áš–s
, 
tok’
[0],
pÜt
,
NULL
);

2360 ià(
Ùh”
) {

2361 
	`£Áš–Ev’t
(
LL_NOTICE
,"+£Áš–-šv®id-addr",
Ùh”
,"%@");

2362 
Ùh”
->
addr
->
pÜt
 = 0;

2363 
	`£Áš–Upd©eS’tš–Add»ssInAÎMa¡”s
(
Ùh”
);

2368 
si
 = 
	`ü—‹S’tš–RedisIn¡ªû
(
tok’
[2],
SRI_SENTINEL
,

2369 
tok’
[0],
pÜt
,
ma¡”
->
quÜum
,master);

2371 ià(
si
) {

2372 ià(!
»moved
è
	`£Áš–Ev’t
(
LL_NOTICE
,"+£Áš–",
si
,"%@");

2376 
si
->
runid
 = 
	`sd¢ew
(
tok’
[2]);

2377 
	`£Áš–TryCÚÃùiÚSh¬šg
(
si
);

2378 ià(
»moved
è
	`£Áš–Upd©eS’tš–Add»ssInAÎMa¡”s
(
si
);

2379 
	`£Áš–FlushCÚfig
();

2384 ià(
cu¼’t_•och
 > 
£Áš–
.current_epoch) {

2385 
£Áš–
.
cu¼’t_•och
 = current_epoch;

2386 
	`£Áš–FlushCÚfig
();

2387 
	`£Áš–Ev’t
(
LL_WARNING
,"+Ãw-•och",
ma¡”
,"%llu",

2388 (è
£Áš–
.
cu¼’t_•och
);

2392 ià(
si
 && 
ma¡”
->
cÚfig_•och
 < 
ma¡”_cÚfig_•och
) {

2393 
ma¡”
->
cÚfig_•och
 = 
ma¡”_cÚfig_•och
;

2394 ià(
ma¡”_pÜt
 !ğ
ma¡”
->
addr
->
pÜt
 ||

2395 
	`¡rcmp
(
ma¡”
->
addr
->

, 
tok’
[5]))

2397 
£Áš–Addr
 *
Şd_addr
;

2399 
	`£Áš–Ev’t
(
LL_WARNING
,"+cÚfig-upd©e-äom",
si
,"%@");

2400 
	`£Áš–Ev’t
(
LL_WARNING
,"+switch-master",

2401 
ma¡”
,"%s %s %d %s %d",

2402 
ma¡”
->
Çme
,

2403 
ma¡”
->
addr
->

, ma¡”->addr->
pÜt
,

2404 
tok’
[5], 
ma¡”_pÜt
);

2406 
Şd_addr
 = 
	`dupS’tš–Addr
(
ma¡”
->
addr
);

2407 
	`£Áš–Re£tMa¡”AndChªgeAdd»ss
(
ma¡”
, 
tok’
[5], 
ma¡”_pÜt
);

2408 
	`£Áš–C®lCl›ÁRecÚfSüt
(
ma¡”
,

2409 
SENTINEL_OBSERVER
,"start",

2410 
Şd_addr
,
ma¡”
->
addr
);

2411 
	`»Ëa£S’tš–Addr
(
Şd_addr
);

2416 ià(
si
èsi->
Ï¡_h–lo_time
 = 
	`m¡ime
();

2419 
ş—nup
:

2420 
	`sdsä“¥l™»s
(
tok’
,
numtok’s
);

2421 
	}
}

2426 
	$£Áš–ReûiveH–loMes§ges
(
»disAsyncCÚ‹xt
 *
c
, *
»¶y
, *
´ivd©a
) {

2427 
£Áš–RedisIn¡ªû
 *
ri
 = 
´ivd©a
;

2428 
»disR•ly
 *
r
;

2429 
	`UNUSED
(
c
);

2431 ià(!
»¶y
 || !
ri
) ;

2432 
r
 = 
»¶y
;

2437 
ri
->
lšk
->
pc_Ï¡_aùiv™y
 = 
	`m¡ime
();

2441 ià(
r
->
ty³
 !ğ
REDIS_REPLY_ARRAY
 ||

2442 
r
->
–em’ts
 != 3 ||

2443 
r
->
–em’t
[0]->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

2444 
r
->
–em’t
[1]->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

2445 
r
->
–em’t
[2]->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

2446 
	`¡rcmp
(
r
->
–em’t
[0]->
¡r
,"message") != 0) ;

2449 ià(
	`¡r¡r
(
r
->
–em’t
[2]->
¡r
,
£Áš–
.
myid
è!ğ
NULL
) ;

2451 
	`£Áš–ProûssH–loMes§ge
(
r
->
–em’t
[2]->
¡r
,„->–em’t[2]->
Ën
);

2452 
	}
}

2465 
	$£Áš–S’dH–lo
(
£Áš–RedisIn¡ªû
 *
ri
) {

2466 

[
NET_IP_STR_LEN
];

2467 
·ylßd
[
NET_IP_STR_LEN
+1024];

2468 
»tv®
;

2469 *
ªnounû_
;

2470 
ªnounû_pÜt
;

2471 
£Áš–RedisIn¡ªû
 *
ma¡”
 = (
ri
->
æags
 & 
SRI_MASTER
) ?„i :„i->master;

2472 
£Áš–Addr
 *
ma¡”_addr
 = 
	`£Áš–G‘Cu¼’tMa¡”Add»ss
(
ma¡”
);

2474 ià(
ri
->
lšk
->
discÚÃùed
è 
C_ERR
;

2478 ià(
£Áš–
.
ªnounû_
) {

2479 
ªnounû_
 = 
£Áš–
.announce_ip;

2481 ià(
	`ª‘SockName
(
ri
->
lšk
->
cc
->
c
.
fd
,

,(),
NULL
) == -1)

2482  
C_ERR
;

2483 
ªnounû_
 = 

;

2485 
ªnounû_pÜt
 = 
£Áš–
.announce_port ?

2486 
£Áš–
.
ªnounû_pÜt
 : 
£rv”
.
pÜt
;

2489 
	`¢´štf
(
·ylßd
,(payload),

2492 
ªnounû_
, 
ªnounû_pÜt
, 
£Áš–
.
myid
,

2493 (è
£Áš–
.
cu¼’t_•och
,

2495 
ma¡”
->
Çme
,
ma¡”_addr
->

,ma¡”_addr->
pÜt
,

2496 (è
ma¡”
->
cÚfig_•och
);

2497 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
lšk
->
cc
,

2498 
£Áš–PublishR•lyC®lback
, 
ri
, "PUBLISH %s %s",

2499 
SENTINEL_HELLO_CHANNEL
,
·ylßd
);

2500 ià(
»tv®
 !ğ
C_OK
è 
C_ERR
;

2501 
ri
->
lšk
->
³ndšg_commªds
++;

2502  
C_OK
;

2503 
	}
}

2507 
	$£Áš–FÜûH–loUpd©eDiùOfRedisIn¡ªûs
(
diù
 *
š¡ªûs
) {

2508 
diùI‹¿tÜ
 *
di
;

2509 
diùEÁry
 *
de
;

2511 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
š¡ªûs
);

2512 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2513 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

2514 ià(
ri
->
Ï¡_pub_time
 >ğ(
SENTINEL_PUBLISH_PERIOD
+1))

2515 
ri
->
Ï¡_pub_time
 -ğ(
SENTINEL_PUBLISH_PERIOD
+1);

2517 
	`diùR–—£I‹¿tÜ
(
di
);

2518 
	}
}

2528 
	$£Áš–FÜûH–loUpd©eFÜMa¡”
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

2529 ià(!(
ma¡”
->
æags
 & 
SRI_MASTER
)è 
C_ERR
;

2530 ià(
ma¡”
->
Ï¡_pub_time
 >ğ(
SENTINEL_PUBLISH_PERIOD
+1))

2531 
ma¡”
->
Ï¡_pub_time
 -ğ(
SENTINEL_PUBLISH_PERIOD
+1);

2532 
	`£Áš–FÜûH–loUpd©eDiùOfRedisIn¡ªûs
(
ma¡”
->
£Áš–s
);

2533 
	`£Áš–FÜûH–loUpd©eDiùOfRedisIn¡ªûs
(
ma¡”
->
¦aves
);

2534  
C_OK
;

2535 
	}
}

2542 
	$£Áš–S’dPšg
(
£Áš–RedisIn¡ªû
 *
ri
) {

2543 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
lšk
->
cc
,

2544 
£Áš–PšgR•lyC®lback
, 
ri
, "PING");

2545 ià(
»tv®
 =ğ
C_OK
) {

2546 
ri
->
lšk
->
³ndšg_commªds
++;

2547 
ri
->
lšk
->
Ï¡_pšg_time
 = 
	`m¡ime
();

2551 ià(
ri
->
lšk
->
aù_pšg_time
 == 0)

2552 
ri
->
lšk
->
aù_pšg_time
 =„i->lšk->
Ï¡_pšg_time
;

2557 
	}
}

2561 
	$£Áš–S’dP”iodicCommªds
(
£Áš–RedisIn¡ªû
 *
ri
) {

2562 
m¡ime_t
 
now
 = 
	`m¡ime
();

2563 
m¡ime_t
 
šfo_³riod
, 
pšg_³riod
;

2564 
»tv®
;

2568 ià(
ri
->
lšk
->
discÚÃùed
) ;

2576 ià(
ri
->
lšk
->
³ndšg_commªds
 >=

2577 
SENTINEL_MAX_PENDING_COMMANDS
 * 
ri
->
lšk
->
»fcouÁ
) ;

2587 ià((
ri
->
æags
 & 
SRI_SLAVE
) &&

2588 ((
ri
->
ma¡”
->
æags
 & (
SRI_O_DOWN
|
SRI_FAILOVER_IN_PROGRESS
)) ||

2589 (
ri
->
ma¡”_lšk_down_time
 != 0)))

2591 
šfo_³riod
 = 1000;

2593 
šfo_³riod
 = 
SENTINEL_INFO_PERIOD
;

2599 
pšg_³riod
 = 
ri
->
down_aá”_³riod
;

2600 ià(
pšg_³riod
 > 
SENTINEL_PING_PERIOD
)…ing_period = SENTINEL_PING_PERIOD;

2602 ià((
ri
->
æags
 & 
SRI_SENTINEL
) == 0 &&

2603 (
ri
->
šfo_»äesh
 == 0 ||

2604 (
now
 - 
ri
->
šfo_»äesh
è> 
šfo_³riod
))

2607 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
lšk
->
cc
,

2608 
£Áš–InfoR•lyC®lback
, 
ri
, "INFO");

2609 ià(
»tv®
 =ğ
C_OK
è
ri
->
lšk
->
³ndšg_commªds
++;

2610 } ià((
now
 - 
ri
->
lšk
->
Ï¡_pÚg_time
è> 
pšg_³riod
 &&

2611 (
now
 - 
ri
->
lšk
->
Ï¡_pšg_time
è> 
pšg_³riod
/2) {

2613 
	`£Áš–S’dPšg
(
ri
);

2614 } ià((
now
 - 
ri
->
Ï¡_pub_time
è> 
SENTINEL_PUBLISH_PERIOD
) {

2616 
	`£Áš–S’dH–lo
(
ri
);

2618 
	}
}

2622 cÚ¡ *
	$£Áš–Faov”S‹SŒ
(
¡©e
) {

2623 
¡©e
) {

2624 
SENTINEL_FAILOVER_STATE_NONE
:  "none";

2625 
SENTINEL_FAILOVER_STATE_WAIT_START
:  "wait_start";

2626 
SENTINEL_FAILOVER_STATE_SELECT_SLAVE
:  "select_slave";

2627 
SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE
:  "send_slaveof_noone";

2628 
SENTINEL_FAILOVER_STATE_WAIT_PROMOTION
:  "wait_promotion";

2629 
SENTINEL_FAILOVER_STATE_RECONF_SLAVES
:  "reconf_slaves";

2630 
SENTINEL_FAILOVER_STATE_UPDATE_CONFIG
:  "update_config";

2633 
	}
}

2636 
	$addR•lyS’tš–RedisIn¡ªû
(
ş›Á
 *
c
, 
£Áš–RedisIn¡ªû
 *
ri
) {

2637 *
æags
 = 
	`sd£m±y
();

2638 *
mbl
;

2639 
f›lds
 = 0;

2641 
mbl
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2643 
	`addR•lyBulkCSŒšg
(
c
,"name");

2644 
	`addR•lyBulkCSŒšg
(
c
,
ri
->
Çme
);

2645 
f›lds
++;

2647 
	`addR•lyBulkCSŒšg
(
c
,"ip");

2648 
	`addR•lyBulkCSŒšg
(
c
,
ri
->
addr
->

);

2649 
f›lds
++;

2651 
	`addR•lyBulkCSŒšg
(
c
,"port");

2652 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
addr
->
pÜt
);

2653 
f›lds
++;

2655 
	`addR•lyBulkCSŒšg
(
c
,"runid");

2656 
	`addR•lyBulkCSŒšg
(
c
,
ri
->
runid
 ?„i->runid : "");

2657 
f›lds
++;

2659 
	`addR•lyBulkCSŒšg
(
c
,"flags");

2660 ià(
ri
->
æags
 & 
SRI_S_DOWN
èæag ğ
	`sdsÿt
(flags,"s_down,");

2661 ià(
ri
->
æags
 & 
SRI_O_DOWN
èæag ğ
	`sdsÿt
(flags,"o_down,");

2662 ià(
ri
->
æags
 & 
SRI_MASTER
èæag ğ
	`sdsÿt
(flags,"master,");

2663 ià(
ri
->
æags
 & 
SRI_SLAVE
èæag ğ
	`sdsÿt
(flags,"slave,");

2664 ià(
ri
->
æags
 & 
SRI_SENTINEL
èæag ğ
	`sdsÿt
(flags,"sentinel,");

2665 ià(
ri
->
lšk
->
discÚÃùed
è
æags
 = 
	`sdsÿt
(flags,"disconnected,");

2666 ià(
ri
->
æags
 & 
SRI_MASTER_DOWN
èæag ğ
	`sdsÿt
(flags,"master_down,");

2667 ià(
ri
->
æags
 & 
SRI_FAILOVER_IN_PROGRESS
)

2668 
æags
 = 
	`sdsÿt
(flags,"failover_in_progress,");

2669 ià(
ri
->
æags
 & 
SRI_PROMOTED
èæag ğ
	`sdsÿt
(flags,"promoted,");

2670 ià(
ri
->
æags
 & 
SRI_RECONF_SENT
èæag ğ
	`sdsÿt
(flags,"reconf_sent,");

2671 ià(
ri
->
æags
 & 
SRI_RECONF_INPROG
èæag ğ
	`sdsÿt
(flags,"reconf_inprog,");

2672 ià(
ri
->
æags
 & 
SRI_RECONF_DONE
èæag ğ
	`sdsÿt
(flags,"reconf_done,");

2674 ià(
	`sd¦’
(
æags
è!ğ0è
	`sd¤ªge
(flags,0,-2);

2675 
	`addR•lyBulkCSŒšg
(
c
,
æags
);

2676 
	`sdsä“
(
æags
);

2677 
f›lds
++;

2679 
	`addR•lyBulkCSŒšg
(
c
,"link-pending-commands");

2680 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
lšk
->
³ndšg_commªds
);

2681 
f›lds
++;

2683 
	`addR•lyBulkCSŒšg
(
c
,"link-refcount");

2684 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
lšk
->
»fcouÁ
);

2685 
f›lds
++;

2687 ià(
ri
->
æags
 & 
SRI_FAILOVER_IN_PROGRESS
) {

2688 
	`addR•lyBulkCSŒšg
(
c
,"failover-state");

2689 
	`addR•lyBulkCSŒšg
(
c
,(*)
	`£Áš–Faov”S‹SŒ
(
ri
->
çov”_¡©e
));

2690 
f›lds
++;

2693 
	`addR•lyBulkCSŒšg
(
c
,"last-ping-sent");

2694 
	`addR•lyBulkLÚgLÚg
(
c
,

2695 
ri
->
lšk
->
aù_pšg_time
 ? (
	`m¡ime
() -„i->link->act_ping_time) : 0);

2696 
f›lds
++;

2698 
	`addR•lyBulkCSŒšg
(
c
,"last-ok-ping-reply");

2699 
	`addR•lyBulkLÚgLÚg
(
c
,
	`m¡ime
(è- 
ri
->
lšk
->
Ï¡_ava_time
);

2700 
f›lds
++;

2702 
	`addR•lyBulkCSŒšg
(
c
,"last-ping-reply");

2703 
	`addR•lyBulkLÚgLÚg
(
c
,
	`m¡ime
(è- 
ri
->
lšk
->
Ï¡_pÚg_time
);

2704 
f›lds
++;

2706 ià(
ri
->
æags
 & 
SRI_S_DOWN
) {

2707 
	`addR•lyBulkCSŒšg
(
c
,"s-down-time");

2708 
	`addR•lyBulkLÚgLÚg
(
c
,
	`m¡ime
()-
ri
->
s_down_sšû_time
);

2709 
f›lds
++;

2712 ià(
ri
->
æags
 & 
SRI_O_DOWN
) {

2713 
	`addR•lyBulkCSŒšg
(
c
,"o-down-time");

2714 
	`addR•lyBulkLÚgLÚg
(
c
,
	`m¡ime
()-
ri
->
o_down_sšû_time
);

2715 
f›lds
++;

2718 
	`addR•lyBulkCSŒšg
(
c
,"down-after-milliseconds");

2719 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
down_aá”_³riod
);

2720 
f›lds
++;

2723 ià(
ri
->
æags
 & (
SRI_MASTER
|
SRI_SLAVE
)) {

2724 
	`addR•lyBulkCSŒšg
(
c
,"info-refresh");

2725 
	`addR•lyBulkLÚgLÚg
(
c
,
	`m¡ime
(è- 
ri
->
šfo_»äesh
);

2726 
f›lds
++;

2728 
	`addR•lyBulkCSŒšg
(
c
,"role-reported");

2729 
	`addR•lyBulkCSŒšg
(
c
, (
ri
->
rŞe_»pÜ‹d
 =ğ
SRI_MASTER
) ? "master" :

2731 
f›lds
++;

2733 
	`addR•lyBulkCSŒšg
(
c
,"role-reported-time");

2734 
	`addR•lyBulkLÚgLÚg
(
c
,
	`m¡ime
(è- 
ri
->
rŞe_»pÜ‹d_time
);

2735 
f›lds
++;

2739 ià(
ri
->
æags
 & 
SRI_MASTER
) {

2740 
	`addR•lyBulkCSŒšg
(
c
,"config-epoch");

2741 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
cÚfig_•och
);

2742 
f›lds
++;

2744 
	`addR•lyBulkCSŒšg
(
c
,"num-slaves");

2745 
	`addR•lyBulkLÚgLÚg
(
c
,
	`diùSize
(
ri
->
¦aves
));

2746 
f›lds
++;

2748 
	`addR•lyBulkCSŒšg
(
c
,"num-other-sentinels");

2749 
	`addR•lyBulkLÚgLÚg
(
c
,
	`diùSize
(
ri
->
£Áš–s
));

2750 
f›lds
++;

2752 
	`addR•lyBulkCSŒšg
(
c
,"quorum");

2753 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
quÜum
);

2754 
f›lds
++;

2756 
	`addR•lyBulkCSŒšg
(
c
,"failover-timeout");

2757 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
çov”_timeout
);

2758 
f›lds
++;

2760 
	`addR•lyBulkCSŒšg
(
c
,"parallel-syncs");

2761 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
·¿Î–_syncs
);

2762 
f›lds
++;

2764 ià(
ri
->
nÙifiÿtiÚ_süt
) {

2765 
	`addR•lyBulkCSŒšg
(
c
,"notification-script");

2766 
	`addR•lyBulkCSŒšg
(
c
,
ri
->
nÙifiÿtiÚ_süt
);

2767 
f›lds
++;

2770 ià(
ri
->
ş›Á_»cÚfig_süt
) {

2771 
	`addR•lyBulkCSŒšg
(
c
,"client-reconfig-script");

2772 
	`addR•lyBulkCSŒšg
(
c
,
ri
->
ş›Á_»cÚfig_süt
);

2773 
f›lds
++;

2778 ià(
ri
->
æags
 & 
SRI_SLAVE
) {

2779 
	`addR•lyBulkCSŒšg
(
c
,"master-link-down-time");

2780 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
ma¡”_lšk_down_time
);

2781 
f›lds
++;

2783 
	`addR•lyBulkCSŒšg
(
c
,"master-link-status");

2784 
	`addR•lyBulkCSŒšg
(
c
,

2785 (
ri
->
¦ave_ma¡”_lšk_¡©us
 =ğ
SENTINEL_MASTER_LINK_STATUS_UP
) ?

2787 
f›lds
++;

2789 
	`addR•lyBulkCSŒšg
(
c
,"master-host");

2790 
	`addR•lyBulkCSŒšg
(
c
,

2791 
ri
->
¦ave_ma¡”_ho¡
 ?„i->slave_master_host : "?");

2792 
f›lds
++;

2794 
	`addR•lyBulkCSŒšg
(
c
,"master-port");

2795 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
¦ave_ma¡”_pÜt
);

2796 
f›lds
++;

2798 
	`addR•lyBulkCSŒšg
(
c
,"slave-priority");

2799 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
¦ave_´iÜ™y
);

2800 
f›lds
++;

2802 
	`addR•lyBulkCSŒšg
(
c
,"slave-repl-offset");

2803 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
¦ave_»¶_off£t
);

2804 
f›lds
++;

2808 ià(
ri
->
æags
 & 
SRI_SENTINEL
) {

2809 
	`addR•lyBulkCSŒšg
(
c
,"last-hello-message");

2810 
	`addR•lyBulkLÚgLÚg
(
c
,
	`m¡ime
(è- 
ri
->
Ï¡_h–lo_time
);

2811 
f›lds
++;

2813 
	`addR•lyBulkCSŒšg
(
c
,"voted-leader");

2814 
	`addR•lyBulkCSŒšg
(
c
,
ri
->
Ëad”
 ?„i->leader : "?");

2815 
f›lds
++;

2817 
	`addR•lyBulkCSŒšg
(
c
,"voted-leader-epoch");

2818 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
Ëad”_•och
);

2819 
f›lds
++;

2822 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
mbl
,
f›lds
*2);

2823 
	}
}

2827 
	$addR•lyDiùOfRedisIn¡ªûs
(
ş›Á
 *
c
, 
diù
 *
š¡ªûs
) {

2828 
diùI‹¿tÜ
 *
di
;

2829 
diùEÁry
 *
de
;

2831 
di
 = 
	`diùG‘I‹¿tÜ
(
š¡ªûs
);

2832 
	`addR•lyMuÉiBulkL’
(
c
,
	`diùSize
(
š¡ªûs
));

2833 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2834 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

2836 
	`addR•lyS’tš–RedisIn¡ªû
(
c
,
ri
);

2838 
	`diùR–—£I‹¿tÜ
(
di
);

2839 
	}
}

2844 
£Áš–RedisIn¡ªû
 *
	$£Áš–G‘Ma¡”ByNameOrR•lyE¼Ü
(
ş›Á
 *
c
,

2845 
robj
 *
Çme
)

2847 
£Áš–RedisIn¡ªû
 *
ri
;

2849 
ri
 = 
	`diùF‘chV®ue
(
£Áš–
.
ma¡”s
,
Çme
->
±r
);

2850 ià(!
ri
) {

2851 
	`addR•lyE¼Ü
(
c
,"No such master withhat‚ame");

2852  
NULL
;

2854  
ri
;

2855 
	}
}

2857 
	#SENTINEL_ISQR_OK
 0

	)

2858 
	#SENTINEL_ISQR_NOQUORUM
 (1<<0)

	)

2859 
	#SENTINEL_ISQR_NOAUTH
 (1<<1)

	)

2860 
	$£Áš–IsQuÜumR—chabË
(
£Áš–RedisIn¡ªû
 *
ma¡”
, *
u§bË±r
) {

2861 
diùI‹¿tÜ
 *
di
;

2862 
diùEÁry
 *
de
;

2863 
u§bË
 = 1;

2864 
»suÉ
 = 
SENTINEL_ISQR_OK
;

2865 
vÙ”s
 = 
	`diùSize
(
ma¡”
->
£Áš–s
)+1;

2867 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
£Áš–s
);

2868 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2869 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

2871 ià(
ri
->
æags
 & (
SRI_S_DOWN
|
SRI_O_DOWN
)) ;

2872 
u§bË
++;

2874 
	`diùR–—£I‹¿tÜ
(
di
);

2876 ià(
u§bË
 < ()
ma¡”
->
quÜum
è
»suÉ
 |ğ
SENTINEL_ISQR_NOQUORUM
;

2877 ià(
u§bË
 < 
vÙ”s
/2+1è
»suÉ
 |ğ
SENTINEL_ISQR_NOAUTH
;

2878 ià(
u§bË±r
è*u§bË±¸ğ
u§bË
;

2879  
»suÉ
;

2880 
	}
}

2882 
	$£Áš–Commªd
(
ş›Á
 *
c
) {

2883 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"masters")) {

2885 ià(
c
->
¬gc
 !ğ2è
num¬g£¼
;

2886 
	`addR•lyDiùOfRedisIn¡ªûs
(
c
,
£Áš–
.
ma¡”s
);

2887 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"master")) {

2889 
£Áš–RedisIn¡ªû
 *
ri
;

2891 ià(
c
->
¬gc
 !ğ3è
num¬g£¼
;

2892 ià((
ri
 = 
	`£Áš–G‘Ma¡”ByNameOrR•lyE¼Ü
(
c
,c->
¬gv
[2]))

2893 =ğ
NULL
) ;

2894 
	`addR•lyS’tš–RedisIn¡ªû
(
c
,
ri
);

2895 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"slaves")) {

2897 
£Áš–RedisIn¡ªû
 *
ri
;

2899 ià(
c
->
¬gc
 !ğ3è
num¬g£¼
;

2900 ià((
ri
 = 
	`£Áš–G‘Ma¡”ByNameOrR•lyE¼Ü
(
c
,c->
¬gv
[2])è=ğ
NULL
)

2902 
	`addR•lyDiùOfRedisIn¡ªûs
(
c
,
ri
->
¦aves
);

2903 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"sentinels")) {

2905 
£Áš–RedisIn¡ªû
 *
ri
;

2907 ià(
c
->
¬gc
 !ğ3è
num¬g£¼
;

2908 ià((
ri
 = 
	`£Áš–G‘Ma¡”ByNameOrR•lyE¼Ü
(
c
,c->
¬gv
[2])è=ğ
NULL
)

2910 
	`addR•lyDiùOfRedisIn¡ªûs
(
c
,
ri
->
£Áš–s
);

2911 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"is-master-down-by-addr")) {

2929 
£Áš–RedisIn¡ªû
 *
ri
;

2930 
»q_•och
;

2931 
ušt64_t
 
Ëad”_•och
 = 0;

2932 *
Ëad”
 = 
NULL
;

2933 
pÜt
;

2934 
isdown
 = 0;

2936 ià(
c
->
¬gc
 !ğ6è
num¬g£¼
;

2937 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
pÜt
,
NULL
è!ğ
C_OK
 ||

2938 
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[4],&
»q_•och
,
NULL
)

2939 !ğ
C_OK
)

2941 
ri
 = 
	`g‘S’tš–RedisIn¡ªûByAddrAndRunID
(
£Áš–
.
ma¡”s
,

2942 
c
->
¬gv
[2]->
±r
,
pÜt
,
NULL
);

2946 ià(!
£Áš–
.
tt
 && 
ri
 && (ri->
æags
 & 
SRI_S_DOWN
) &&

2947 (
ri
->
æags
 & 
SRI_MASTER
))

2948 
isdown
 = 1;

2952 ià(
ri
 &&„i->
æags
 & 
SRI_MASTER
 && 
	`¡rÿ£cmp
(
c
->
¬gv
[5]->
±r
,"*")) {

2953 
Ëad”
 = 
	`£Áš–VÙeL—d”
(
ri
,(
ušt64_t
)
»q_•och
,

2954 
c
->
¬gv
[5]->
±r
,

2955 &
Ëad”_•och
);

2960 
	`addR•lyMuÉiBulkL’
(
c
,3);

2961 
	`addR•ly
(
c
, 
isdown
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

2962 
	`addR•lyBulkCSŒšg
(
c
, 
Ëad”
 ?†eader : "*");

2963 
	`addR•lyLÚgLÚg
(
c
, ()
Ëad”_•och
);

2964 ià(
Ëad”
è
	`sdsä“
(leader);

2965 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"reset")) {

2967 ià(
c
->
¬gc
 !ğ3è
num¬g£¼
;

2968 
	`addR•lyLÚgLÚg
(
c
,
	`£Áš–Re£tMa¡”sByP©‹º
(c->
¬gv
[2]->
±r
,
SENTINEL_GENERATE_EVENT
));

2969 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"get-master-addr-by-name")) {

2971 
£Áš–RedisIn¡ªû
 *
ri
;

2973 ià(
c
->
¬gc
 !ğ3è
num¬g£¼
;

2974 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
c
->
¬gv
[2]->
±r
);

2975 ià(
ri
 =ğ
NULL
) {

2976 
	`addR•ly
(
c
,
sh¬ed
.
nuÎmuÉibulk
);

2978 
£Áš–Addr
 *
addr
 = 
	`£Áš–G‘Cu¼’tMa¡”Add»ss
(
ri
);

2980 
	`addR•lyMuÉiBulkL’
(
c
,2);

2981 
	`addR•lyBulkCSŒšg
(
c
,
addr
->

);

2982 
	`addR•lyBulkLÚgLÚg
(
c
,
addr
->
pÜt
);

2984 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"failover")) {

2986 
£Áš–RedisIn¡ªû
 *
ri
;

2988 ià(
c
->
¬gc
 !ğ3è
num¬g£¼
;

2989 ià((
ri
 = 
	`£Áš–G‘Ma¡”ByNameOrR•lyE¼Ü
(
c
,c->
¬gv
[2])è=ğ
NULL
)

2991 ià(
ri
->
æags
 & 
SRI_FAILOVER_IN_PROGRESS
) {

2992 
	`addR•lySds
(
c
,
	`sd¢ew
("-INPROG Failover‡lready in…rogress\r\n"));

2995 ià(
	`£Áš–S–eùSÏve
(
ri
è=ğ
NULL
) {

2996 
	`addR•lySds
(
c
,
	`sd¢ew
("-NOGOODSLAVE No suitable slaveo…romote\r\n"));

2999 
	`£rv”Log
(
LL_WARNING
,"Executing user„equested FAILOVER of '%s'",

3000 
ri
->
Çme
);

3001 
	`£Áš–S¹Faov”
(
ri
);

3002 
ri
->
æags
 |ğ
SRI_FORCE_FAILOVER
;

3003 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

3004 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"pending-scripts")) {

3007 ià(
c
->
¬gc
 !ğ2è
num¬g£¼
;

3008 
	`£Áš–P’dšgSütsCommªd
(
c
);

3009 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"monitor")) {

3011 
£Áš–RedisIn¡ªû
 *
ri
;

3012 
quÜum
, 
pÜt
;

3013 

[
NET_IP_STR_LEN
];

3015 ià(
c
->
¬gc
 !ğ6è
num¬g£¼
;

3016 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[5],&
quÜum
,"Invalid quorum")

3017 !ğ
C_OK
) ;

3018 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[4],&
pÜt
,"Invalid…ort")

3019 !ğ
C_OK
) ;

3021 ià(
quÜum
 <= 0) {

3022 
	`addR•lyE¼Ü
(
c
, "Quorum must be 1 or greater.");

3029 ià(
	`ª‘ResŞveIP
(
NULL
,
c
->
¬gv
[3]->
±r
,

,()è=ğ
ANET_ERR
) {

3030 
	`addR•lyE¼Ü
(
c
,"Invalid IP‡ddress specified");

3035 
ri
 = 
	`ü—‹S’tš–RedisIn¡ªû
(
c
->
¬gv
[2]->
±r
,
SRI_MASTER
,

3036 
c
->
¬gv
[3]->
±r
,
pÜt
,
quÜum
,
NULL
);

3037 ià(
ri
 =ğ
NULL
) {

3038 
”ºo
) {

3039 
EBUSY
:

3040 
	`addR•lyE¼Ü
(
c
,"Duplicated master‚ame");

3042 
EINVAL
:

3043 
	`addR•lyE¼Ü
(
c
,"Invalid…ort‚umber");

3046 
	`addR•lyE¼Ü
(
c
,"Unspecifiedƒrror‡ddinghe instance");

3050 
	`£Áš–FlushCÚfig
();

3051 
	`£Áš–Ev’t
(
LL_WARNING
,"+mÚ™Ü",
ri
,"%@ quÜum %d",ri->
quÜum
);

3052 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

3054 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"flushconfig")) {

3055 ià(
c
->
¬gc
 !ğ2è
num¬g£¼
;

3056 
	`£Áš–FlushCÚfig
();

3057 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

3059 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"remove")) {

3061 
£Áš–RedisIn¡ªû
 *
ri
;

3063 ià(
c
->
¬gc
 !ğ3è
num¬g£¼
;

3064 ià((
ri
 = 
	`£Áš–G‘Ma¡”ByNameOrR•lyE¼Ü
(
c
,c->
¬gv
[2]))

3065 =ğ
NULL
) ;

3066 
	`£Áš–Ev’t
(
LL_WARNING
,"-mÚ™Ü",
ri
,"%@");

3067 
	`diùD–‘e
(
£Áš–
.
ma¡”s
,
c
->
¬gv
[2]->
±r
);

3068 
	`£Áš–FlushCÚfig
();

3069 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

3070 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"ckquorum")) {

3072 
£Áš–RedisIn¡ªû
 *
ri
;

3073 
u§bË
;

3075 ià(
c
->
¬gc
 !ğ3è
num¬g£¼
;

3076 ià((
ri
 = 
	`£Áš–G‘Ma¡”ByNameOrR•lyE¼Ü
(
c
,c->
¬gv
[2]))

3077 =ğ
NULL
) ;

3078 
»suÉ
 = 
	`£Áš–IsQuÜumR—chabË
(
ri
,&
u§bË
);

3079 ià(
»suÉ
 =ğ
SENTINEL_ISQR_OK
) {

3080 
	`addR•lySds
(
c
, 
	`sdsÿtfmt
(
	`sd£m±y
(),

3082 "ÿÀb»ached\r\n",
u§bË
));

3084 
sds
 
e
 = 
	`sdsÿtfmt
(
	`sd£m±y
(),

3085 "-NOQUORUM %˜u§bË S’tš–s. ",
u§bË
);

3086 ià(
»suÉ
 & 
SENTINEL_ISQR_NOQUORUM
)

3087 
e
 = 
	`sdsÿt
(e,"Notƒnough‡vailable Sentinelso„eachhe"

3089 ià(
»suÉ
 & 
SENTINEL_ISQR_NOAUTH
) {

3090 ià(
»suÉ
 & 
SENTINEL_ISQR_NOQUORUM
è
e
 = 
	`sdsÿt
(e,". ");

3091 
e
 = 
	`sdsÿt
(e, "Notƒnough‡vailable Sentinelso„eachhe"

3094 
e
 = 
	`sdsÿt
(e,"\r\n");

3095 
	`addR•lySds
(
c
,
e
);

3097 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"set")) {

3098 ià(
c
->
¬gc
 < 3 || c->¬gø% 2 =ğ0è
num¬g£¼
;

3099 
	`£Áš–S‘Commªd
(
c
);

3100 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"info-cache")) {

3102 ià(
c
->
¬gc
 < 2è
num¬g£¼
;

3103 
m¡ime_t
 
now
 = 
	`m¡ime
();

3108 
diùTy³
 
cİy_k“³r
 = 
š¡ªûsDiùTy³
;

3109 
cİy_k“³r
.
v®De¡ruùÜ
 = 
NULL
;

3110 
diù
 *
ma¡”s_loÿl
 = 
£Áš–
.
ma¡”s
;

3111 ià(
c
->
¬gc
 > 2) {

3112 
ma¡”s_loÿl
 = 
	`diùC»©e
(&
cİy_k“³r
, 
NULL
);

3114 
i
 = 2; i < 
c
->
¬gc
; i++) {

3115 
£Áš–RedisIn¡ªû
 *
ri
;

3116 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
c
->
¬gv
[
i
]->
±r
);

3117 ià(!
ri
) ;

3118 
	`diùAdd
(
ma¡”s_loÿl
, 
ri
->
Çme
,„i);

3130 
	`addR•lyMuÉiBulkL’
(
c
,
	`diùSize
(
ma¡”s_loÿl
) * 2);

3132 
diùI‹¿tÜ
 *
di
;

3133 
diùEÁry
 *
de
;

3134 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”s_loÿl
);

3135 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3136 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

3137 
	`addR•lyBulkCBufãr
(
c
,
ri
->
Çme
,
	`¡¾’
(ri->name));

3138 
	`addR•lyMuÉiBulkL’
(
c
,
	`diùSize
(
ri
->
¦aves
) + 1);

3139 
	`addR•lyMuÉiBulkL’
(
c
,2);

3140 
	`addR•lyLÚgLÚg
(
c
, 
now
 - 
ri
->
šfo_»äesh
);

3141 ià(
ri
->
šfo
)

3142 
	`addR•lyBulkCBufãr
(
c
,
ri
->
šfo
,
	`sd¦’
(ri->info));

3144 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

3146 
diùI‹¿tÜ
 *
sdi
;

3147 
diùEÁry
 *
sde
;

3148 
sdi
 = 
	`diùG‘I‹¿tÜ
(
ri
->
¦aves
);

3149 (
sde
 = 
	`diùNext
(
sdi
)è!ğ
NULL
) {

3150 
£Áš–RedisIn¡ªû
 *
¤i
 = 
	`diùG‘V®
(
sde
);

3151 
	`addR•lyMuÉiBulkL’
(
c
,2);

3152 
	`addR•lyLÚgLÚg
(
c
, 
now
 - 
¤i
->
šfo_»äesh
);

3153 ià(
¤i
->
šfo
)

3154 
	`addR•lyBulkCBufãr
(
c
,
¤i
->
šfo
,
	`sd¦’
(sri->info));

3156 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

3158 
	`diùR–—£I‹¿tÜ
(
sdi
);

3160 
	`diùR–—£I‹¿tÜ
(
di
);

3161 ià(
ma¡”s_loÿl
 !ğ
£Áš–
.
ma¡”s
è
	`diùR–—£
(masters_local);

3162 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"simulate-failure")) {

3164 
j
;

3166 
£Áš–
.
simçu»_æags
 = 
SENTINEL_SIMFAILURE_NONE
;

3167 
j
 = 2; j < 
c
->
¬gc
; j++) {

3168 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"crash-after-election")) {

3169 
£Áš–
.
simçu»_æags
 |=

3170 
SENTINEL_SIMFAILURE_CRASH_AFTER_ELECTION
;

3171 
	`£rv”Log
(
LL_WARNING
,"Failure simulation:his Sentinel "

3174 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"crash-after-promotion")) {

3175 
£Áš–
.
simçu»_æags
 |=

3176 
SENTINEL_SIMFAILURE_CRASH_AFTER_PROMOTION
;

3177 
	`£rv”Log
(
LL_WARNING
,"Failure simulation:his Sentinel "

3179 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"help")) {

3180 
	`addR•lyMuÉiBulkL’
(
c
,2);

3181 
	`addR•lyBulkCSŒšg
(
c
,"crash-after-election");

3182 
	`addR•lyBulkCSŒšg
(
c
,"crash-after-promotion");

3184 
	`addR•lyE¼Ü
(
c
,"Unknown failure simulation specified");

3188 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

3190 
	`addR•lyE¼ÜFÜm©
(
c
,"Unknown sentinel subcommand '%s'",

3191 (*)
c
->
¬gv
[1]->
±r
);

3195 
num¬g£¼
:

3196 
	`addR•lyE¼ÜFÜm©
(
c
,"Wrong‚umber of‡rguments for 'sentinel %s'",

3197 (*)
c
->
¬gv
[1]->
±r
);

3198 
	}
}

3200 
	#šfo_£ùiÚ_äom_»dis
(
£ùiÚ_Çme
) do { \

3201 ià(
def£ùiÚs
 || 
®l£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,
£ùiÚ_Çme
)) { \

3202 
sds
 
»dis£ùiÚ
; \

3203 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n"); \

3204 
»dis£ùiÚ
 = 
	`g’RedisInfoSŒšg
(
£ùiÚ_Çme
); \

3205 
šfo
 = 
	`sdsÿ’
(šfo,
»dis£ùiÚ
,
	`sd¦’
(redissection)); \

3206 
	`sdsä“
(
»dis£ùiÚ
); \

3208 } 0)

	)

3211 
	$£Áš–InfoCommªd
(
ş›Á
 *
c
) {

3212 ià(
c
->
¬gc
 > 2) {

3213 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

3217 
def£ùiÚs
 = 0, 
®l£ùiÚs
 = 0;

3218 *
£ùiÚ
 = 
c
->
¬gc
 =ğ2 ? c->
¬gv
[1]->
±r
 : 
NULL
;

3219 ià(
£ùiÚ
) {

3220 
®l£ùiÚs
 = !
	`¡rÿ£cmp
(
£ùiÚ
,"all");

3221 
def£ùiÚs
 = !
	`¡rÿ£cmp
(
£ùiÚ
,"default");

3223 
def£ùiÚs
 = 1;

3226 
£ùiÚs
 = 0;

3227 
sds
 
šfo
 = 
	`sd£m±y
();

3229 
	`šfo_£ùiÚ_äom_»dis
("server");

3230 
	`šfo_£ùiÚ_äom_»dis
("clients");

3231 
	`šfo_£ùiÚ_äom_»dis
("cpu");

3232 
	`šfo_£ùiÚ_äom_»dis
("stats");

3234 ià(
def£ùiÚs
 || 
®l£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"sentinel")) {

3235 
diùI‹¿tÜ
 *
di
;

3236 
diùEÁry
 *
de
;

3237 
ma¡”_id
 = 0;

3239 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

3240 
šfo
 = 
	`sdsÿrštf
(info,

3247 
	`diùSize
(
£Áš–
.
ma¡”s
),

3248 
£Áš–
.
tt
,

3249 
£Áš–
.
ruÂšg_süts
,

3250 
	`li¡L’gth
(
£Áš–
.
süts_queue
),

3251 
£Áš–
.
simçu»_æags
);

3253 
di
 = 
	`diùG‘I‹¿tÜ
(
£Áš–
.
ma¡”s
);

3254 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3255 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

3256 *
¡©us
 = "ok";

3258 ià(
ri
->
æags
 & 
SRI_O_DOWN
è
¡©us
 = "odown";

3259 ià(
ri
->
æags
 & 
SRI_S_DOWN
è
¡©us
 = "sdown";

3260 
šfo
 = 
	`sdsÿrštf
(info,

3263 
ma¡”_id
++, 
ri
->
Çme
, 
¡©us
,

3264 
ri
->
addr
->

,„i->addr->
pÜt
,

3265 
	`diùSize
(
ri
->
¦aves
),

3266 
	`diùSize
(
ri
->
£Áš–s
)+1);

3268 
	`diùR–—£I‹¿tÜ
(
di
);

3271 
	`addR•lyBulkSds
(
c
, 
šfo
);

3272 
	}
}

3276 
	$£Áš–RŞeCommªd
(
ş›Á
 *
c
) {

3277 
diùI‹¿tÜ
 *
di
;

3278 
diùEÁry
 *
de
;

3280 
	`addR•lyMuÉiBulkL’
(
c
,2);

3281 
	`addR•lyBulkCBufãr
(
c
,"sentinel",8);

3282 
	`addR•lyMuÉiBulkL’
(
c
,
	`diùSize
(
£Áš–
.
ma¡”s
));

3284 
di
 = 
	`diùG‘I‹¿tÜ
(
£Áš–
.
ma¡”s
);

3285 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3286 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

3288 
	`addR•lyBulkCSŒšg
(
c
,
ri
->
Çme
);

3290 
	`diùR–—£I‹¿tÜ
(
di
);

3291 
	}
}

3294 
	$£Áš–S‘Commªd
(
ş›Á
 *
c
) {

3295 
£Áš–RedisIn¡ªû
 *
ri
;

3296 
j
, 
chªges
 = 0;

3297 *
İtiÚ
, *
v®ue
;

3299 ià((
ri
 = 
	`£Áš–G‘Ma¡”ByNameOrR•lyE¼Ü
(
c
,c->
¬gv
[2]))

3300 =ğ
NULL
) ;

3303 
j
 = 3; j < 
c
->
¬gc
; j += 2) {

3304 
İtiÚ
 = 
c
->
¬gv
[
j
]->
±r
;

3305 
v®ue
 = 
c
->
¬gv
[
j
+1]->
±r
;

3306 
robj
 *
o
 = 
c
->
¬gv
[
j
+1];

3307 
Î
;

3309 ià(!
	`¡rÿ£cmp
(
İtiÚ
,"down-after-milliseconds")) {

3311 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
C_ERR
 ||†l <= 0)

3312 
badfmt
;

3313 
ri
->
down_aá”_³riod
 = 
Î
;

3314 
	`£Áš–Prİag©eDownAá”P”iod
(
ri
);

3315 
chªges
++;

3316 } ià(!
	`¡rÿ£cmp
(
İtiÚ
,"failover-timeout")) {

3318 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
C_ERR
 ||†l <= 0)

3319 
badfmt
;

3320 
ri
->
çov”_timeout
 = 
Î
;

3321 
chªges
++;

3322 } ià(!
	`¡rÿ£cmp
(
İtiÚ
,"parallel-syncs")) {

3324 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
C_ERR
 ||†l <= 0)

3325 
badfmt
;

3326 
ri
->
·¿Î–_syncs
 = 
Î
;

3327 
chªges
++;

3328 } ià(!
	`¡rÿ£cmp
(
İtiÚ
,"notification-script")) {

3330 ià(
	`¡¾’
(
v®ue
è&& 
	`acûss
(v®ue,
X_OK
) == -1) {

3331 
	`addR•lyE¼Ü
(
c
,

3333 ià(
chªges
è
	`£Áš–FlushCÚfig
();

3336 
	`sdsä“
(
ri
->
nÙifiÿtiÚ_süt
);

3337 
ri
->
nÙifiÿtiÚ_süt
 = 
	`¡¾’
(
v®ue
è? 
	`sd¢ew
(v®ueè: 
NULL
;

3338 
chªges
++;

3339 } ià(!
	`¡rÿ£cmp
(
İtiÚ
,"client-reconfig-script")) {

3341 ià(
	`¡¾’
(
v®ue
è&& 
	`acûss
(v®ue,
X_OK
) == -1) {

3342 
	`addR•lyE¼Ü
(
c
,

3345 ià(
chªges
è
	`£Áš–FlushCÚfig
();

3348 
	`sdsä“
(
ri
->
ş›Á_»cÚfig_süt
);

3349 
ri
->
ş›Á_»cÚfig_süt
 = 
	`¡¾’
(
v®ue
è? 
	`sd¢ew
(v®ueè: 
NULL
;

3350 
chªges
++;

3351 } ià(!
	`¡rÿ£cmp
(
İtiÚ
,"auth-pass")) {

3353 
	`sdsä“
(
ri
->
auth_·ss
);

3354 
ri
->
auth_·ss
 = 
	`¡¾’
(
v®ue
è? 
	`sd¢ew
(v®ueè: 
NULL
;

3355 
chªges
++;

3356 } ià(!
	`¡rÿ£cmp
(
İtiÚ
,"quorum")) {

3358 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
C_ERR
 ||†l <= 0)

3359 
badfmt
;

3360 
ri
->
quÜum
 = 
Î
;

3361 
chªges
++;

3363 
	`addR•lyE¼ÜFÜm©
(
c
,"Unknown option '%s' for SENTINEL SET",

3364 
İtiÚ
);

3365 ià(
chªges
è
	`£Áš–FlushCÚfig
();

3368 
	`£Áš–Ev’t
(
LL_WARNING
,"+£t",
ri
,"%@ % %s",
İtiÚ
,
v®ue
);

3371 ià(
chªges
è
	`£Áš–FlushCÚfig
();

3372 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

3375 
badfmt
:

3376 ià(
chªges
è
	`£Áš–FlushCÚfig
();

3377 
	`addR•lyE¼ÜFÜm©
(
c
,"Invalid‡rgument '%s' for SENTINEL SET '%s'",

3378 
v®ue
, 
İtiÚ
);

3379 
	}
}

3387 
	$£Áš–PublishCommªd
(
ş›Á
 *
c
) {

3388 ià(
	`¡rcmp
(
c
->
¬gv
[1]->
±r
,
SENTINEL_HELLO_CHANNEL
)) {

3389 
	`addR•lyE¼Ü
(
c
, "Only HELLO messages‡re‡ccepted by Sentinel instances.");

3392 
	`£Áš–ProûssH–loMes§ge
(
c
->
¬gv
[2]->
±r
,
	`sd¦’
(c->argv[2]->ptr));

3393 
	`addR•lyLÚgLÚg
(
c
,1);

3394 
	}
}

3399 
	$£Áš–CheckSubjeùiv–yDown
(
£Áš–RedisIn¡ªû
 *
ri
) {

3400 
m¡ime_t
 
–­£d
 = 0;

3402 ià(
ri
->
lšk
->
aù_pšg_time
)

3403 
–­£d
 = 
	`m¡ime
(è- 
ri
->
lšk
->
aù_pšg_time
;

3404 ià(
ri
->
lšk
->
discÚÃùed
)

3405 
–­£d
 = 
	`m¡ime
(è- 
ri
->
lšk
->
Ï¡_ava_time
;

3413 ià(
ri
->
lšk
->
cc
 &&

3414 (
	`m¡ime
(è- 
ri
->
lšk
->
cc_cÚn_time
) >

3415 
SENTINEL_MIN_LINK_RECONNECT_PERIOD
 &&

3416 
ri
->
lšk
->
aù_pšg_time
 != 0 &&

3419 (
	`m¡ime
(è- 
ri
->
lšk
->
aù_pšg_time
è> (ri->
down_aá”_³riod
/2) &&

3420 (
	`m¡ime
(è- 
ri
->
lšk
->
Ï¡_pÚg_time
è> (ri->
down_aá”_³riod
/2))

3422 
	`š¡ªûLškClo£CÚÃùiÚ
(
ri
->
lšk
,ri->lšk->
cc
);

3430 ià(
ri
->
lšk
->
pc
 &&

3431 (
	`m¡ime
(è- 
ri
->
lšk
->
pc_cÚn_time
) >

3432 
SENTINEL_MIN_LINK_RECONNECT_PERIOD
 &&

3433 (
	`m¡ime
(è- 
ri
->
lšk
->
pc_Ï¡_aùiv™y
è> (
SENTINEL_PUBLISH_PERIOD
*3))

3435 
	`š¡ªûLškClo£CÚÃùiÚ
(
ri
->
lšk
,ri->lšk->
pc
);

3444 ià(
–­£d
 > 
ri
->
down_aá”_³riod
 ||

3445 (
ri
->
æags
 & 
SRI_MASTER
 &&

3446 
ri
->
rŞe_»pÜ‹d
 =ğ
SRI_SLAVE
 &&

3447 
	`m¡ime
(è- 
ri
->
rŞe_»pÜ‹d_time
 >

3448 (
ri
->
down_aá”_³riod
+
SENTINEL_INFO_PERIOD
*2)))

3451 ià((
ri
->
æags
 & 
SRI_S_DOWN
) == 0) {

3452 
	`£Áš–Ev’t
(
LL_WARNING
,"+sdown",
ri
,"%@");

3453 
ri
->
s_down_sšû_time
 = 
	`m¡ime
();

3454 
ri
->
æags
 |ğ
SRI_S_DOWN
;

3458 ià(
ri
->
æags
 & 
SRI_S_DOWN
) {

3459 
	`£Áš–Ev’t
(
LL_WARNING
,"-sdown",
ri
,"%@");

3460 
ri
->
æags
 &ğ~(
SRI_S_DOWN
|
SRI_SCRIPT_KILL_SENT
);

3463 
	}
}

3471 
	$£Áš–CheckObjeùiv–yDown
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

3472 
diùI‹¿tÜ
 *
di
;

3473 
diùEÁry
 *
de
;

3474 
quÜum
 = 0, 
odown
 = 0;

3476 ià(
ma¡”
->
æags
 & 
SRI_S_DOWN
) {

3478 
quÜum
 = 1;

3480 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
£Áš–s
);

3481 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3482 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

3484 ià(
ri
->
æags
 & 
SRI_MASTER_DOWN
è
quÜum
++;

3486 
	`diùR–—£I‹¿tÜ
(
di
);

3487 ià(
quÜum
 >ğ
ma¡”
->quÜumè
odown
 = 1;

3491 ià(
odown
) {

3492 ià((
ma¡”
->
æags
 & 
SRI_O_DOWN
) == 0) {

3493 
	`£Áš–Ev’t
(
LL_WARNING
,"+odown",
ma¡”
,"%@ #quorum %d/%d",

3494 
quÜum
, 
ma¡”
->quorum);

3495 
ma¡”
->
æags
 |ğ
SRI_O_DOWN
;

3496 
ma¡”
->
o_down_sšû_time
 = 
	`m¡ime
();

3499 ià(
ma¡”
->
æags
 & 
SRI_O_DOWN
) {

3500 
	`£Áš–Ev’t
(
LL_WARNING
,"-odown",
ma¡”
,"%@");

3501 
ma¡”
->
æags
 &ğ~
SRI_O_DOWN
;

3504 
	}
}

3508 
	$£Áš–ReûiveIsMa¡”DownR•ly
(
»disAsyncCÚ‹xt
 *
c
, *
»¶y
, *
´ivd©a
) {

3509 
£Áš–RedisIn¡ªû
 *
ri
 = 
´ivd©a
;

3510 
š¡ªûLšk
 *
lšk
 = 
c
->
d©a
;

3511 
»disR•ly
 *
r
;

3513 ià(!
»¶y
 || !
lšk
) ;

3514 
lšk
->
³ndšg_commªds
--;

3515 
r
 = 
»¶y
;

3520 ià(
r
->
ty³
 =ğ
REDIS_REPLY_ARRAY
 &&„->
–em’ts
 == 3 &&

3521 
r
->
–em’t
[0]->
ty³
 =ğ
REDIS_REPLY_INTEGER
 &&

3522 
r
->
–em’t
[1]->
ty³
 =ğ
REDIS_REPLY_STRING
 &&

3523 
r
->
–em’t
[2]->
ty³
 =ğ
REDIS_REPLY_INTEGER
)

3525 
ri
->
Ï¡_ma¡”_down_»¶y_time
 = 
	`m¡ime
();

3526 ià(
r
->
–em’t
[0]->
š‹g”
 == 1) {

3527 
ri
->
æags
 |ğ
SRI_MASTER_DOWN
;

3529 
ri
->
æags
 &ğ~
SRI_MASTER_DOWN
;

3531 ià(
	`¡rcmp
(
r
->
–em’t
[1]->
¡r
,"*")) {

3534 
	`sdsä“
(
ri
->
Ëad”
);

3535 ià(()
ri
->
Ëad”_•och
 !ğ
r
->
–em’t
[2]->
š‹g”
)

3536 
	`£rv”Log
(
LL_WARNING
,

3537 "% vÙed fÜ % %Îu", 
ri
->
Çme
,

3538 
r
->
–em’t
[1]->
¡r
,

3539 (è
r
->
–em’t
[2]->
š‹g”
);

3540 
ri
->
Ëad”
 = 
	`sd¢ew
(
r
->
–em’t
[1]->
¡r
);

3541 
ri
->
Ëad”_•och
 = 
r
->
–em’t
[2]->
š‹g”
;

3544 
	}
}

3550 
	#SENTINEL_ASK_FORCED
 (1<<0)

	)

3551 
	$£Áš–AskMa¡”S‹ToOth”S’tš–s
(
£Áš–RedisIn¡ªû
 *
ma¡”
, 
æags
) {

3552 
diùI‹¿tÜ
 *
di
;

3553 
diùEÁry
 *
de
;

3555 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
£Áš–s
);

3556 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3557 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

3558 
m¡ime_t
 
–­£d
 = 
	`m¡ime
(è- 
ri
->
Ï¡_ma¡”_down_»¶y_time
;

3559 
pÜt
[32];

3560 
»tv®
;

3563 ià(
–­£d
 > 
SENTINEL_ASK_PERIOD
*5) {

3564 
ri
->
æags
 &ğ~
SRI_MASTER_DOWN
;

3565 
	`sdsä“
(
ri
->
Ëad”
);

3566 
ri
->
Ëad”
 = 
NULL
;

3574 ià((
ma¡”
->
æags
 & 
SRI_S_DOWN
) == 0) ;

3575 ià(
ri
->
lšk
->
discÚÃùed
) ;

3576 ià(!(
æags
 & 
SENTINEL_ASK_FORCED
) &&

3577 
	`m¡ime
(è- 
ri
->
Ï¡_ma¡”_down_»¶y_time
 < 
SENTINEL_ASK_PERIOD
)

3581 
	`Î2¡ršg
(
pÜt
,ÕÜt),
ma¡”
->
addr
->port);

3582 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
lšk
->
cc
,

3583 
£Áš–ReûiveIsMa¡”DownR•ly
, 
ri
,

3585 
ma¡”
->
addr
->

, 
pÜt
,

3586 
£Áš–
.
cu¼’t_•och
,

3587 (
ma¡”
->
çov”_¡©e
 > 
SENTINEL_FAILOVER_STATE_NONE
) ?

3588 
£Áš–
.
myid
 : "*");

3589 ià(
»tv®
 =ğ
C_OK
è
ri
->
lšk
->
³ndšg_commªds
++;

3591 
	`diùR–—£I‹¿tÜ
(
di
);

3592 
	}
}

3597 
	$£Áš–SimFau»C¿sh
() {

3598 
	`£rv”Log
(
LL_WARNING
,

3600 
	`ex™
(99);

3601 
	}
}

3608 *
	$£Áš–VÙeL—d”
(
£Áš–RedisIn¡ªû
 *
ma¡”
, 
ušt64_t
 
»q_•och
, *
»q_runid
, ušt64_ˆ*
Ëad”_•och
) {

3609 ià(
»q_•och
 > 
£Áš–
.
cu¼’t_•och
) {

3610 
£Áš–
.
cu¼’t_•och
 = 
»q_•och
;

3611 
	`£Áš–FlushCÚfig
();

3612 
	`£Áš–Ev’t
(
LL_WARNING
,"+Ãw-•och",
ma¡”
,"%llu",

3613 (è
£Áš–
.
cu¼’t_•och
);

3616 ià(
ma¡”
->
Ëad”_•och
 < 
»q_•och
 && 
£Áš–
.
cu¼’t_•och
 <=„eq_epoch)

3618 
	`sdsä“
(
ma¡”
->
Ëad”
);

3619 
ma¡”
->
Ëad”
 = 
	`sd¢ew
(
»q_runid
);

3620 
ma¡”
->
Ëad”_•och
 = 
£Áš–
.
cu¼’t_•och
;

3621 
	`£Áš–FlushCÚfig
();

3622 
	`£Áš–Ev’t
(
LL_WARNING
,"+vÙe-fÜ-Ëad”",
ma¡”
,"%s %llu",

3623 
ma¡”
->
Ëad”
, (èma¡”->
Ëad”_•och
);

3627 ià(
	`¡rÿ£cmp
(
ma¡”
->
Ëad”
,
£Áš–
.
myid
))

3628 
ma¡”
->
çov”_¡¬t_time
 = 
	`m¡ime
()+
	`¿nd
()%
SENTINEL_MAX_DESYNC
;

3631 *
Ëad”_•och
 = 
ma¡”
->leader_epoch;

3632  
ma¡”
->
Ëad”
 ? 
	`sd¢ew
(ma¡”->Ëad”è: 
NULL
;

3633 
	}
}

3635 
	s£Áš–L—d”
 {

3636 *
	mrunid
;

3637 
	mvÙes
;

3642 
	$£Áš–L—d”Inü
(
diù
 *
couÁ”s
, *
runid
) {

3643 
diùEÁry
 *
exi¡šg
, *
de
;

3644 
ušt64_t
 
Şdv®
;

3646 
de
 = 
	`diùAddRaw
(
couÁ”s
,
runid
,&
exi¡šg
);

3647 ià(
exi¡šg
) {

3648 
Şdv®
 = 
	`diùG‘UnsigÃdIÁeg”V®
(
exi¡šg
);

3649 
	`diùS‘UnsigÃdIÁeg”V®
(
exi¡šg
,
Şdv®
+1);

3650  
Şdv®
+1;

3652 
	`£rv”As£¹
(
de
 !ğ
NULL
);

3653 
	`diùS‘UnsigÃdIÁeg”V®
(
de
,1);

3656 
	}
}

3664 *
	$£Áš–G‘L—d”
(
£Áš–RedisIn¡ªû
 *
ma¡”
, 
ušt64_t
 
•och
) {

3665 
diù
 *
couÁ”s
;

3666 
diùI‹¿tÜ
 *
di
;

3667 
diùEÁry
 *
de
;

3668 
vÙ”s
 = 0, 
vÙ”s_quÜum
;

3669 *
myvÙe
;

3670 *
wšÃr
 = 
NULL
;

3671 
ušt64_t
 
Ëad”_•och
;

3672 
ušt64_t
 
max_vÙes
 = 0;

3674 
	`£rv”As£¹
(
ma¡”
->
æags
 & (
SRI_O_DOWN
|
SRI_FAILOVER_IN_PROGRESS
));

3675 
couÁ”s
 = 
	`diùC»©e
(&
Ëad”VÙesDiùTy³
,
NULL
);

3677 
vÙ”s
 = 
	`diùSize
(
ma¡”
->
£Áš–s
)+1;

3680 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
£Áš–s
);

3681 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3682 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

3683 ià(
ri
->
Ëad”
 !ğ
NULL
 &&„i->
Ëad”_•och
 =ğ
£Áš–
.
cu¼’t_•och
)

3684 
	`£Áš–L—d”Inü
(
couÁ”s
,
ri
->
Ëad”
);

3686 
	`diùR–—£I‹¿tÜ
(
di
);

3691 
di
 = 
	`diùG‘I‹¿tÜ
(
couÁ”s
);

3692 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3693 
ušt64_t
 
vÙes
 = 
	`diùG‘UnsigÃdIÁeg”V®
(
de
);

3695 ià(
vÙes
 > 
max_vÙes
) {

3696 
max_vÙes
 = 
vÙes
;

3697 
wšÃr
 = 
	`diùG‘Key
(
de
);

3700 
	`diùR–—£I‹¿tÜ
(
di
);

3705 ià(
wšÃr
)

3706 
myvÙe
 = 
	`£Áš–VÙeL—d”
(
ma¡”
,
•och
,
wšÃr
,&
Ëad”_•och
);

3708 
myvÙe
 = 
	`£Áš–VÙeL—d”
(
ma¡”
,
•och
,
£Áš–
.
myid
,&
Ëad”_•och
);

3710 ià(
myvÙe
 && 
Ëad”_•och
 =ğ
•och
) {

3711 
ušt64_t
 
vÙes
 = 
	`£Áš–L—d”Inü
(
couÁ”s
,
myvÙe
);

3713 ià(
vÙes
 > 
max_vÙes
) {

3714 
max_vÙes
 = 
vÙes
;

3715 
wšÃr
 = 
myvÙe
;

3719 
vÙ”s_quÜum
 = 
vÙ”s
/2+1;

3720 ià(
wšÃr
 && (
max_vÙes
 < 
vÙ”s_quÜum
 || max_vÙe < 
ma¡”
->
quÜum
))

3721 
wšÃr
 = 
NULL
;

3723 
wšÃr
 = wšÃ¸? 
	`sd¢ew
(wšÃrè: 
NULL
;

3724 
	`sdsä“
(
myvÙe
);

3725 
	`diùR–—£
(
couÁ”s
);

3726  
wšÃr
;

3727 
	}
}

3739 
	$£Áš–S’dSÏveOf
(
£Áš–RedisIn¡ªû
 *
ri
, *
ho¡
, 
pÜt
) {

3740 
pÜt¡r
[32];

3741 
»tv®
;

3743 
	`Î2¡ršg
(
pÜt¡r
,ÕÜt¡r),
pÜt
);

3747 ià(
ho¡
 =ğ
NULL
) {

3748 
ho¡
 = "NO";

3749 
	`memıy
(
pÜt¡r
,"ONE",4);

3762 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
lšk
->
cc
,

3763 
£Áš–DisÿrdR•lyC®lback
, 
ri
, "MULTI");

3764 ià(
»tv®
 =ğ
C_ERR
) „etval;

3765 
ri
->
lšk
->
³ndšg_commªds
++;

3767 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
lšk
->
cc
,

3768 
£Áš–DisÿrdR•lyC®lback
, 
ri
, "SLAVEOF % %s", 
ho¡
, 
pÜt¡r
);

3769 ià(
»tv®
 =ğ
C_ERR
) „etval;

3770 
ri
->
lšk
->
³ndšg_commªds
++;

3772 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
lšk
->
cc
,

3773 
£Áš–DisÿrdR•lyC®lback
, 
ri
, "CONFIG REWRITE");

3774 ià(
»tv®
 =ğ
C_ERR
) „etval;

3775 
ri
->
lšk
->
³ndšg_commªds
++;

3782 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
lšk
->
cc
,

3783 
£Áš–DisÿrdR•lyC®lback
, 
ri
, "CLIENT KILL TYPE‚ormal");

3784 ià(
»tv®
 =ğ
C_ERR
) „etval;

3785 
ri
->
lšk
->
³ndšg_commªds
++;

3787 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
lšk
->
cc
,

3788 
£Áš–DisÿrdR•lyC®lback
, 
ri
, "EXEC");

3789 ià(
»tv®
 =ğ
C_ERR
) „etval;

3790 
ri
->
lšk
->
³ndšg_commªds
++;

3792  
C_OK
;

3793 
	}
}

3796 
	$£Áš–S¹Faov”
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

3797 
	`£rv”As£¹
(
ma¡”
->
æags
 & 
SRI_MASTER
);

3799 
ma¡”
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_WAIT_START
;

3800 
ma¡”
->
æags
 |ğ
SRI_FAILOVER_IN_PROGRESS
;

3801 
ma¡”
->
çov”_•och
 = ++
£Áš–
.
cu¼’t_•och
;

3802 
	`£Áš–Ev’t
(
LL_WARNING
,"+Ãw-•och",
ma¡”
,"%llu",

3803 (è
£Áš–
.
cu¼’t_•och
);

3804 
	`£Áš–Ev’t
(
LL_WARNING
,"+Œy-çov”",
ma¡”
,"%@");

3805 
ma¡”
->
çov”_¡¬t_time
 = 
	`m¡ime
()+
	`¿nd
()%
SENTINEL_MAX_DESYNC
;

3806 
ma¡”
->
çov”_¡©e_chªge_time
 = 
	`m¡ime
();

3807 
	}
}

3820 
	$£Áš–S¹Faov”IfN“ded
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

3822 ià(!(
ma¡”
->
æags
 & 
SRI_O_DOWN
))  0;

3825 ià(
ma¡”
->
æags
 & 
SRI_FAILOVER_IN_PROGRESS
)  0;

3828 ià(
	`m¡ime
(è- 
ma¡”
->
çov”_¡¬t_time
 <

3829 
ma¡”
->
çov”_timeout
*2)

3831 ià(
ma¡”
->
çov”_d–ay_logged
 !ğma¡”->
çov”_¡¬t_time
) {

3832 
time_t
 
şock
 = (
ma¡”
->
çov”_¡¬t_time
 +

3833 
ma¡”
->
çov”_timeout
*2) / 1000;

3834 
ùimebuf
[26];

3836 
	`ùime_r
(&
şock
,
ùimebuf
);

3837 
ùimebuf
[24] = '\0';

3838 
ma¡”
->
çov”_d–ay_logged
 = ma¡”->
çov”_¡¬t_time
;

3839 
	`£rv”Log
(
LL_WARNING
,

3841 
ùimebuf
);

3846 
	`£Áš–S¹Faov”
(
ma¡”
);

3848 
	}
}

3882 
	$com·»SÏvesFÜPromÙiÚ
(cÚ¡ *
a
, cÚ¡ *
b
) {

3883 
£Áš–RedisIn¡ªû
 **
§
 = (£Áš–RedisIn¡ªû **)
a
,

3884 **
sb
 = (
£Áš–RedisIn¡ªû
 **)
b
;

3885 *
§_runid
, *
sb_runid
;

3887 ià((*
§
)->
¦ave_´iÜ™y
 !ğ(*
sb
)->slave_priority)

3888  (*
§
)->
¦ave_´iÜ™y
 - (*
sb
)->slave_priority;

3892 ià((*
§
)->
¦ave_»¶_off£t
 > (*
sb
)->slave_repl_offset) {

3894 } ià((*
§
)->
¦ave_»¶_off£t
 < (*
sb
)->slave_repl_offset) {

3902 
§_runid
 = (*
§
)->
runid
;

3903 
sb_runid
 = (*
sb
)->
runid
;

3904 ià(
§_runid
 =ğ
NULL
 && 
sb_runid
 == NULL)  0;

3905 ià(
§_runid
 =ğ
NULL
)  1;

3906 ià(
sb_runid
 =ğ
NULL
)  -1;

3907  
	`¡rÿ£cmp
(
§_runid
, 
sb_runid
);

3908 
	}
}

3910 
£Áš–RedisIn¡ªû
 *
	$£Áš–S–eùSÏve
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

3911 
£Áš–RedisIn¡ªû
 **
š¡ªû
 =

3912 
	`zm®loc
((
š¡ªû
[0])*
	`diùSize
(
ma¡”
->
¦aves
));

3913 
£Áš–RedisIn¡ªû
 *
£Ëùed
 = 
NULL
;

3914 
š¡ªûs
 = 0;

3915 
diùI‹¿tÜ
 *
di
;

3916 
diùEÁry
 *
de
;

3917 
m¡ime_t
 
max_ma¡”_down_time
 = 0;

3919 ià(
ma¡”
->
æags
 & 
SRI_S_DOWN
)

3920 
max_ma¡”_down_time
 +ğ
	`m¡ime
(è- 
ma¡”
->
s_down_sšû_time
;

3921 
max_ma¡”_down_time
 +ğ
ma¡”
->
down_aá”_³riod
 * 10;

3923 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
¦aves
);

3924 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3925 
£Áš–RedisIn¡ªû
 *
¦ave
 = 
	`diùG‘V®
(
de
);

3926 
m¡ime_t
 
šfo_v®id™y_time
;

3928 ià(
¦ave
->
æags
 & (
SRI_S_DOWN
|
SRI_O_DOWN
)) ;

3929 ià(
¦ave
->
lšk
->
discÚÃùed
) ;

3930 ià(
	`m¡ime
(è- 
¦ave
->
lšk
->
Ï¡_ava_time
 > 
SENTINEL_PING_PERIOD
*5) ;

3931 ià(
¦ave
->
¦ave_´iÜ™y
 == 0) ;

3936 ià(
ma¡”
->
æags
 & 
SRI_S_DOWN
)

3937 
šfo_v®id™y_time
 = 
SENTINEL_PING_PERIOD
*5;

3939 
šfo_v®id™y_time
 = 
SENTINEL_INFO_PERIOD
*3;

3940 ià(
	`m¡ime
(è- 
¦ave
->
šfo_»äesh
 > 
šfo_v®id™y_time
) ;

3941 ià(
¦ave
->
ma¡”_lšk_down_time
 > 
max_ma¡”_down_time
) ;

3942 
š¡ªû
[
š¡ªûs
++] = 
¦ave
;

3944 
	`diùR–—£I‹¿tÜ
(
di
);

3945 ià(
š¡ªûs
) {

3946 
	`qsÜt
(
š¡ªû
,
š¡ªûs
,(
£Áš–RedisIn¡ªû
*),

3947 
com·»SÏvesFÜPromÙiÚ
);

3948 
£Ëùed
 = 
š¡ªû
[0];

3950 
	`zä“
(
š¡ªû
);

3951  
£Ëùed
;

3952 
	}
}

3955 
	$£Áš–Faov”Wa™S¹
(
£Áš–RedisIn¡ªû
 *
ri
) {

3956 *
Ëad”
;

3957 
i¦—d”
;

3960 
Ëad”
 = 
	`£Áš–G‘L—d”
(
ri
,„i->
çov”_•och
);

3961 
i¦—d”
 = 
Ëad”
 && 
	`¡rÿ£cmp
Ö—d”,
£Áš–
.
myid
) == 0;

3962 
	`sdsä“
(
Ëad”
);

3966 ià(!
i¦—d”
 && !(
ri
->
æags
 & 
SRI_FORCE_FAILOVER
)) {

3967 
–eùiÚ_timeout
 = 
SENTINEL_ELECTION_TIMEOUT
;

3971 ià(
–eùiÚ_timeout
 > 
ri
->
çov”_timeout
)

3972 
–eùiÚ_timeout
 = 
ri
->
çov”_timeout
;

3974 ià(
	`m¡ime
(è- 
ri
->
çov”_¡¬t_time
 > 
–eùiÚ_timeout
) {

3975 
	`£Áš–Ev’t
(
LL_WARNING
,"-çov”-abÜt-nÙ-–eùed",
ri
,"%@");

3976 
	`£Áš–AbÜtFaov”
(
ri
);

3980 
	`£Áš–Ev’t
(
LL_WARNING
,"+–eùed-Ëad”",
ri
,"%@");

3981 ià(
£Áš–
.
simçu»_æags
 & 
SENTINEL_SIMFAILURE_CRASH_AFTER_ELECTION
)

3982 
	`£Áš–SimFau»C¿sh
();

3983 
ri
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_SELECT_SLAVE
;

3984 
ri
->
çov”_¡©e_chªge_time
 = 
	`m¡ime
();

3985 
	`£Áš–Ev’t
(
LL_WARNING
,"+çov”-¡©e-£Ëù-¦ave",
ri
,"%@");

3986 
	}
}

3988 
	$£Áš–Faov”S–eùSÏve
(
£Áš–RedisIn¡ªû
 *
ri
) {

3989 
£Áš–RedisIn¡ªû
 *
¦ave
 = 
	`£Áš–S–eùSÏve
(
ri
);

3993 ià(
¦ave
 =ğ
NULL
) {

3994 
	`£Áš–Ev’t
(
LL_WARNING
,"-çov”-abÜt-no-good-¦ave",
ri
,"%@");

3995 
	`£Áš–AbÜtFaov”
(
ri
);

3997 
	`£Áš–Ev’t
(
LL_WARNING
,"+£Ëùed-¦ave",
¦ave
,"%@");

3998 
¦ave
->
æags
 |ğ
SRI_PROMOTED
;

3999 
ri
->
´omÙed_¦ave
 = 
¦ave
;

4000 
ri
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE
;

4001 
ri
->
çov”_¡©e_chªge_time
 = 
	`m¡ime
();

4002 
	`£Áš–Ev’t
(
LL_NOTICE
,"+failover-state-send-slaveof-noone",

4003 
¦ave
, "%@");

4005 
	}
}

4007 
	$£Áš–Faov”S’dSÏveOfNoOÃ
(
£Áš–RedisIn¡ªû
 *
ri
) {

4008 
»tv®
;

4013 ià(
ri
->
´omÙed_¦ave
->
lšk
->
discÚÃùed
) {

4014 ià(
	`m¡ime
(è- 
ri
->
çov”_¡©e_chªge_time
 >„i->
çov”_timeout
) {

4015 
	`£Áš–Ev’t
(
LL_WARNING
,"-çov”-abÜt-¦ave-timeout",
ri
,"%@");

4016 
	`£Áš–AbÜtFaov”
(
ri
);

4025 
»tv®
 = 
	`£Áš–S’dSÏveOf
(
ri
->
´omÙed_¦ave
,
NULL
,0);

4026 ià(
»tv®
 !ğ
C_OK
) ;

4027 
	`£Áš–Ev’t
(
LL_NOTICE
, "+failover-state-wait-promotion",

4028 
ri
->
´omÙed_¦ave
,"%@");

4029 
ri
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_WAIT_PROMOTION
;

4030 
ri
->
çov”_¡©e_chªge_time
 = 
	`m¡ime
();

4031 
	}
}

4035 
	$£Áš–Faov”Wa™PromÙiÚ
(
£Áš–RedisIn¡ªû
 *
ri
) {

4038 ià(
	`m¡ime
(è- 
ri
->
çov”_¡©e_chªge_time
 >„i->
çov”_timeout
) {

4039 
	`£Áš–Ev’t
(
LL_WARNING
,"-çov”-abÜt-¦ave-timeout",
ri
,"%@");

4040 
	`£Áš–AbÜtFaov”
(
ri
);

4042 
	}
}

4044 
	$£Áš–Faov”D‘eùEnd
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

4045 
nÙ_»cÚfigu»d
 = 0, 
timeout
 = 0;

4046 
diùI‹¿tÜ
 *
di
;

4047 
diùEÁry
 *
de
;

4048 
m¡ime_t
 
–­£d
 = 
	`m¡ime
(è- 
ma¡”
->
çov”_¡©e_chªge_time
;

4052 ià(
ma¡”
->
´omÙed_¦ave
 =ğ
NULL
 ||

4053 
ma¡”
->
´omÙed_¦ave
->
æags
 & 
SRI_S_DOWN
) ;

4057 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
¦aves
);

4058 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

4059 
£Áš–RedisIn¡ªû
 *
¦ave
 = 
	`diùG‘V®
(
de
);

4061 ià(
¦ave
->
æags
 & (
SRI_PROMOTED
|
SRI_RECONF_DONE
)) ;

4062 ià(
¦ave
->
æags
 & 
SRI_S_DOWN
) ;

4063 
nÙ_»cÚfigu»d
++;

4065 
	`diùR–—£I‹¿tÜ
(
di
);

4068 ià(
–­£d
 > 
ma¡”
->
çov”_timeout
) {

4069 
nÙ_»cÚfigu»d
 = 0;

4070 
timeout
 = 1;

4071 
	`£Áš–Ev’t
(
LL_WARNING
,"+çov”-’d-fÜ-timeout",
ma¡”
,"%@");

4074 ià(
nÙ_»cÚfigu»d
 == 0) {

4075 
	`£Áš–Ev’t
(
LL_WARNING
,"+çov”-’d",
ma¡”
,"%@");

4076 
ma¡”
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_UPDATE_CONFIG
;

4077 
ma¡”
->
çov”_¡©e_chªge_time
 = 
	`m¡ime
();

4083 ià(
timeout
) {

4084 
diùI‹¿tÜ
 *
di
;

4085 
diùEÁry
 *
de
;

4087 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
¦aves
);

4088 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

4089 
£Áš–RedisIn¡ªû
 *
¦ave
 = 
	`diùG‘V®
(
de
);

4090 
»tv®
;

4092 ià(
¦ave
->
æags
 & (
SRI_RECONF_DONE
|
SRI_RECONF_SENT
)) ;

4093 ià(
¦ave
->
lšk
->
discÚÃùed
) ;

4095 
»tv®
 = 
	`£Áš–S’dSÏveOf
(
¦ave
,

4096 
ma¡”
->
´omÙed_¦ave
->
addr
->

,

4097 
ma¡”
->
´omÙed_¦ave
->
addr
->
pÜt
);

4098 ià(
»tv®
 =ğ
C_OK
) {

4099 
	`£Áš–Ev’t
(
LL_NOTICE
,"+¦ave-»cÚf-£Á-be",
¦ave
,"%@");

4100 
¦ave
->
æags
 |ğ
SRI_RECONF_SENT
;

4103 
	`diùR–—£I‹¿tÜ
(
di
);

4105 
	}
}

4109 
	$£Áš–Faov”RecÚfNextSÏve
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

4110 
diùI‹¿tÜ
 *
di
;

4111 
diùEÁry
 *
de
;

4112 
š_´og»ss
 = 0;

4114 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
¦aves
);

4115 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

4116 
£Áš–RedisIn¡ªû
 *
¦ave
 = 
	`diùG‘V®
(
de
);

4118 ià(
¦ave
->
æags
 & (
SRI_RECONF_SENT
|
SRI_RECONF_INPROG
))

4119 
š_´og»ss
++;

4121 
	`diùR–—£I‹¿tÜ
(
di
);

4123 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
¦aves
);

4124 
š_´og»ss
 < 
ma¡”
->
·¿Î–_syncs
 &&

4125 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
)

4127 
£Áš–RedisIn¡ªû
 *
¦ave
 = 
	`diùG‘V®
(
de
);

4128 
»tv®
;

4131 ià(
¦ave
->
æags
 & (
SRI_PROMOTED
|
SRI_RECONF_DONE
)) ;

4137 ià((
¦ave
->
æags
 & 
SRI_RECONF_SENT
) &&

4138 (
	`m¡ime
(è- 
¦ave
->
¦ave_»cÚf_£Á_time
) >

4139 
SENTINEL_SLAVE_RECONF_TIMEOUT
)

4141 
	`£Áš–Ev’t
(
LL_NOTICE
,"-¦ave-»cÚf-£Á-timeout",
¦ave
,"%@");

4142 
¦ave
->
æags
 &ğ~
SRI_RECONF_SENT
;

4143 
¦ave
->
æags
 |ğ
SRI_RECONF_DONE
;

4148 ià(
¦ave
->
æags
 & (
SRI_RECONF_SENT
|
SRI_RECONF_INPROG
)) ;

4149 ià(
¦ave
->
lšk
->
discÚÃùed
) ;

4152 
»tv®
 = 
	`£Áš–S’dSÏveOf
(
¦ave
,

4153 
ma¡”
->
´omÙed_¦ave
->
addr
->

,

4154 
ma¡”
->
´omÙed_¦ave
->
addr
->
pÜt
);

4155 ià(
»tv®
 =ğ
C_OK
) {

4156 
¦ave
->
æags
 |ğ
SRI_RECONF_SENT
;

4157 
¦ave
->
¦ave_»cÚf_£Á_time
 = 
	`m¡ime
();

4158 
	`£Áš–Ev’t
(
LL_NOTICE
,"+¦ave-»cÚf-£Á",
¦ave
,"%@");

4159 
š_´og»ss
++;

4162 
	`diùR–—£I‹¿tÜ
(
di
);

4165 
	`£Áš–Faov”D‘eùEnd
(
ma¡”
);

4166 
	}
}

4171 
	$£Áš–Faov”Sw™chToPromÙedSÏve
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

4172 
£Áš–RedisIn¡ªû
 *
»f
 = 
ma¡”
->
´omÙed_¦ave
 ?

4173 
ma¡”
->
´omÙed_¦ave
 : master;

4175 
	`£Áš–Ev’t
(
LL_WARNING
,"+sw™ch-ma¡”",
ma¡”
,"%s %s %d %s %d",

4176 
ma¡”
->
Çme
, ma¡”->
addr
->

, ma¡”->addr->
pÜt
,

4177 
»f
->
addr
->

,„ef->addr->
pÜt
);

4179 
	`£Áš–Re£tMa¡”AndChªgeAdd»ss
(
ma¡”
,
»f
->
addr
->

,»f->addr->
pÜt
);

4180 
	}
}

4182 
	$£Áš–Faov”S‹Machše
(
£Áš–RedisIn¡ªû
 *
ri
) {

4183 
	`£rv”As£¹
(
ri
->
æags
 & 
SRI_MASTER
);

4185 ià(!(
ri
->
æags
 & 
SRI_FAILOVER_IN_PROGRESS
)) ;

4187 
ri
->
çov”_¡©e
) {

4188 
SENTINEL_FAILOVER_STATE_WAIT_START
:

4189 
	`£Áš–Faov”Wa™S¹
(
ri
);

4191 
SENTINEL_FAILOVER_STATE_SELECT_SLAVE
:

4192 
	`£Áš–Faov”S–eùSÏve
(
ri
);

4194 
SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE
:

4195 
	`£Áš–Faov”S’dSÏveOfNoOÃ
(
ri
);

4197 
SENTINEL_FAILOVER_STATE_WAIT_PROMOTION
:

4198 
	`£Áš–Faov”Wa™PromÙiÚ
(
ri
);

4200 
SENTINEL_FAILOVER_STATE_RECONF_SLAVES
:

4201 
	`£Áš–Faov”RecÚfNextSÏve
(
ri
);

4204 
	}
}

4211 
	$£Áš–AbÜtFaov”
(
£Áš–RedisIn¡ªû
 *
ri
) {

4212 
	`£rv”As£¹
(
ri
->
æags
 & 
SRI_FAILOVER_IN_PROGRESS
);

4213 
	`£rv”As£¹
(
ri
->
çov”_¡©e
 <ğ
SENTINEL_FAILOVER_STATE_WAIT_PROMOTION
);

4215 
ri
->
æags
 &ğ~(
SRI_FAILOVER_IN_PROGRESS
|
SRI_FORCE_FAILOVER
);

4216 
ri
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_NONE
;

4217 
ri
->
çov”_¡©e_chªge_time
 = 
	`m¡ime
();

4218 ià(
ri
->
´omÙed_¦ave
) {

4219 
ri
->
´omÙed_¦ave
->
æags
 &ğ~
SRI_PROMOTED
;

4220 
ri
->
´omÙed_¦ave
 = 
NULL
;

4222 
	}
}

4230 
	$£Áš–HªdËRedisIn¡ªû
(
£Áš–RedisIn¡ªû
 *
ri
) {

4233 
	`£Áš–RecÚÃùIn¡ªû
(
ri
);

4234 
	`£Áš–S’dP”iodicCommªds
(
ri
);

4240 ià(
£Áš–
.
tt
) {

4241 ià(
	`m¡ime
()-
£Áš–
.
tt_¡¬t_time
 < 
SENTINEL_TILT_PERIOD
) ;

4242 
£Áš–
.
tt
 = 0;

4243 
	`£Áš–Ev’t
(
LL_WARNING
,"-tt",
NULL
,"#tilt modeƒxited");

4247 
	`£Áš–CheckSubjeùiv–yDown
(
ri
);

4250 ià(
ri
->
æags
 & (
SRI_MASTER
|
SRI_SLAVE
)) {

4255 ià(
ri
->
æags
 & 
SRI_MASTER
) {

4256 
	`£Áš–CheckObjeùiv–yDown
(
ri
);

4257 ià(
	`£Áš–S¹Faov”IfN“ded
(
ri
))

4258 
	`£Áš–AskMa¡”S‹ToOth”S’tš–s
(
ri
,
SENTINEL_ASK_FORCED
);

4259 
	`£Áš–Faov”S‹Machše
(
ri
);

4260 
	`£Áš–AskMa¡”S‹ToOth”S’tš–s
(
ri
,
SENTINEL_NO_FLAGS
);

4262 
	}
}

4266 
	$£Áš–HªdËDiùOfRedisIn¡ªûs
(
diù
 *
š¡ªûs
) {

4267 
diùI‹¿tÜ
 *
di
;

4268 
diùEÁry
 *
de
;

4269 
£Áš–RedisIn¡ªû
 *
sw™ch_to_´omÙed
 = 
NULL
;

4272 
di
 = 
	`diùG‘I‹¿tÜ
(
š¡ªûs
);

4273 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

4274 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

4276 
	`£Áš–HªdËRedisIn¡ªû
(
ri
);

4277 ià(
ri
->
æags
 & 
SRI_MASTER
) {

4278 
	`£Áš–HªdËDiùOfRedisIn¡ªûs
(
ri
->
¦aves
);

4279 
	`£Áš–HªdËDiùOfRedisIn¡ªûs
(
ri
->
£Áš–s
);

4280 ià(
ri
->
çov”_¡©e
 =ğ
SENTINEL_FAILOVER_STATE_UPDATE_CONFIG
) {

4281 
sw™ch_to_´omÙed
 = 
ri
;

4285 ià(
sw™ch_to_´omÙed
)

4286 
	`£Áš–Faov”Sw™chToPromÙedSÏve
(
sw™ch_to_´omÙed
);

4287 
	`diùR–—£I‹¿tÜ
(
di
);

4288 
	}
}

4309 
	$£Áš–CheckTtCÚd™iÚ
() {

4310 
m¡ime_t
 
now
 = 
	`m¡ime
();

4311 
m¡ime_t
 
d–
 = 
now
 - 
£Áš–
.
´evious_time
;

4313 ià(
d–
 < 0 || d– > 
SENTINEL_TILT_TRIGGER
) {

4314 
£Áš–
.
tt
 = 1;

4315 
£Áš–
.
tt_¡¬t_time
 = 
	`m¡ime
();

4316 
	`£Áš–Ev’t
(
LL_WARNING
,"+tt",
NULL
,"#tilt modeƒntered");

4318 
£Áš–
.
´evious_time
 = 
	`m¡ime
();

4319 
	}
}

4321 
	$£Áš–Tim”
() {

4322 
	`£Áš–CheckTtCÚd™iÚ
();

4323 
	`£Áš–HªdËDiùOfRedisIn¡ªûs
(
£Áš–
.
ma¡”s
);

4324 
	`£Áš–RunP’dšgSüts
();

4325 
	`£Áš–CŞËùT”mš©edSüts
();

4326 
	`£Áš–KlTimedoutSüts
();

4334 
£rv”
.
hz
 = 
CONFIG_DEFAULT_HZ
 + 
	`¿nd
() % CONFIG_DEFAULT_HZ;

4335 
	}
}

	@server.c

30 
	~"£rv”.h
"

31 
	~"şu¡”.h
"

32 
	~"¦owlog.h
"

33 
	~"bio.h
"

34 
	~"Ï‹ncy.h
"

35 
	~"©omicv¬.h
"

37 
	~<time.h
>

38 
	~<sigÇl.h
>

39 
	~<sys/wa™.h
>

40 
	~<”ºo.h
>

41 
	~<as£¹.h
>

42 
	~<ùy³.h
>

43 
	~<¡d¬g.h
>

44 
	~<¬·/š‘.h
>

45 
	~<sys/¡©.h
>

46 
	~<fú.h
>

47 
	~<sys/time.h
>

48 
	~<sys/»sourû.h
>

49 
	~<sys/uio.h
>

50 
	~<sys/un.h
>

51 
	~<lim™s.h
>

52 
	~<æßt.h
>

53 
	~<m©h.h
>

54 
	~<sys/»sourû.h
>

55 
	~<sys/ut¢ame.h
>

56 
	~<loÿË.h
>

57 
	~<sys/sock‘.h
>

61 
sh¬edObjeùsSŒuù
 
	gsh¬ed
;

67 
	gR_Z”o
, 
	gR_PosInf
, 
	gR_NegInf
, 
	gR_Nª
;

72 
»disS”v”
 
	g£rv”
;

73 vŞ©
	gÌu_şock
;

127 
»disCommªd
 
	g»disCommªdTabË
[] = {

128 {"moduË",
moduËCommªd
,-2,"as",0,
NULL
,1,1,1,0,0},

129 {"g‘",
g‘Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

130 {"£t",
£tCommªd
,-3,"wm",0,
NULL
,1,1,1,0,0},

131 {"£Šx",
£ŠxCommªd
,3,"wmF",0,
NULL
,1,1,1,0,0},

132 {"£‹x",
£‹xCommªd
,4,"wm",0,
NULL
,1,1,1,0,0},

133 {"p£‹x",
p£‹xCommªd
,4,"wm",0,
NULL
,1,1,1,0,0},

134 {"­³nd",
­³ndCommªd
,3,"wm",0,
NULL
,1,1,1,0,0},

135 {"¡¾’",
¡¾’Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

136 {"d–",
d–Commªd
,-2,"w",0,
NULL
,1,-1,1,0,0},

137 {"uÆšk",
uÆškCommªd
,-2,"wF",0,
NULL
,1,-1,1,0,0},

138 {"exi¡s",
exi¡sCommªd
,-2,"rF",0,
NULL
,1,-1,1,0,0},

139 {"£tb™",
£tb™Commªd
,4,"wm",0,
NULL
,1,1,1,0,0},

140 {"g‘b™",
g‘b™Commªd
,3,"rF",0,
NULL
,1,1,1,0,0},

141 {"b™f›ld",
b™f›ldCommªd
,-2,"wm",0,
NULL
,1,1,1,0,0},

142 {"£Œªge",
£ŒªgeCommªd
,4,"wm",0,
NULL
,1,1,1,0,0},

143 {"g‘¿nge",
g‘¿ngeCommªd
,4,"r",0,
NULL
,1,1,1,0,0},

144 {"sub¡r",
g‘¿ngeCommªd
,4,"r",0,
NULL
,1,1,1,0,0},

145 {"šü",
šüCommªd
,2,"wmF",0,
NULL
,1,1,1,0,0},

146 {"deü",
deüCommªd
,2,"wmF",0,
NULL
,1,1,1,0,0},

147 {"mg‘",
mg‘Commªd
,-2,"rF",0,
NULL
,1,-1,1,0,0},

148 {"½ush",
½ushCommªd
,-3,"wmF",0,
NULL
,1,1,1,0,0},

149 {"Íush",
ÍushCommªd
,-3,"wmF",0,
NULL
,1,1,1,0,0},

150 {"½ushx",
½ushxCommªd
,-3,"wmF",0,
NULL
,1,1,1,0,0},

151 {"Íushx",
ÍushxCommªd
,-3,"wmF",0,
NULL
,1,1,1,0,0},

152 {"lš£¹",
lš£¹Commªd
,5,"wm",0,
NULL
,1,1,1,0,0},

153 {"½İ",
½İCommªd
,2,"wF",0,
NULL
,1,1,1,0,0},

154 {"Íİ",
ÍİCommªd
,2,"wF",0,
NULL
,1,1,1,0,0},

155 {"b½İ",
b½İCommªd
,-3,"ws",0,
NULL
,1,-2,1,0,0},

156 {"b½İÍush",
b½İÍushCommªd
,4,"wms",0,
NULL
,1,2,1,0,0},

157 {"bÍİ",
bÍİCommªd
,-3,"ws",0,
NULL
,1,-2,1,0,0},

158 {"Î’",
Î’Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

159 {"lšdex",
lšdexCommªd
,3,"r",0,
NULL
,1,1,1,0,0},

160 {"l£t",
l£tCommªd
,4,"wm",0,
NULL
,1,1,1,0,0},

161 {"Ìªge",
ÌªgeCommªd
,4,"r",0,
NULL
,1,1,1,0,0},

162 {"Érim",
ÉrimCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

163 {"Ìem",
ÌemCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

164 {"½İÍush",
½İÍushCommªd
,3,"wm",0,
NULL
,1,2,1,0,0},

165 {"§dd",
§ddCommªd
,-3,"wmF",0,
NULL
,1,1,1,0,0},

166 {"¤em",
¤emCommªd
,-3,"wF",0,
NULL
,1,1,1,0,0},

167 {"smove",
smoveCommªd
,4,"wF",0,
NULL
,1,2,1,0,0},

168 {"sismemb”",
sismemb”Commªd
,3,"rF",0,
NULL
,1,1,1,0,0},

169 {"sÿrd",
sÿrdCommªd
,2,"rF",0,
NULL
,1,1,1,0,0},

170 {"¥İ",
¥İCommªd
,-2,"wRF",0,
NULL
,1,1,1,0,0},

171 {"¤ªdmemb”",
¤ªdmemb”Commªd
,-2,"rR",0,
NULL
,1,1,1,0,0},

172 {"sš‹r",
sš‹rCommªd
,-2,"rS",0,
NULL
,1,-1,1,0,0},

173 {"sš‹r¡Üe",
sš‹r¡ÜeCommªd
,-3,"wm",0,
NULL
,1,-1,1,0,0},

174 {"suniÚ",
suniÚCommªd
,-2,"rS",0,
NULL
,1,-1,1,0,0},

175 {"suniÚ¡Üe",
suniÚ¡ÜeCommªd
,-3,"wm",0,
NULL
,1,-1,1,0,0},

176 {"sdiff",
sdiffCommªd
,-2,"rS",0,
NULL
,1,-1,1,0,0},

177 {"sdiff¡Üe",
sdiff¡ÜeCommªd
,-3,"wm",0,
NULL
,1,-1,1,0,0},

178 {"smemb”s",
sš‹rCommªd
,2,"rS",0,
NULL
,1,1,1,0,0},

179 {"ssÿn",
ssÿnCommªd
,-3,"rR",0,
NULL
,1,1,1,0,0},

180 {"zadd",
zaddCommªd
,-4,"wmF",0,
NULL
,1,1,1,0,0},

181 {"zšüby",
zšübyCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

182 {"z»m",
z»mCommªd
,-3,"wF",0,
NULL
,1,1,1,0,0},

183 {"z»m¿ngebyscÜe",
z»m¿ngebyscÜeCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

184 {"z»m¿ngeby¿nk",
z»m¿ngeby¿nkCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

185 {"z»m¿ngebyËx",
z»m¿ngebyËxCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

186 {"zuniÚ¡Üe",
zuniÚ¡ÜeCommªd
,-4,"wm",0,
zuniÚIÁ”G‘Keys
,0,0,0,0,0},

187 {"zš‹r¡Üe",
zš‹r¡ÜeCommªd
,-4,"wm",0,
zuniÚIÁ”G‘Keys
,0,0,0,0,0},

188 {"z¿nge",
z¿ngeCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

189 {"z¿ngebyscÜe",
z¿ngebyscÜeCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

190 {"z»v¿ngebyscÜe",
z»v¿ngebyscÜeCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

191 {"z¿ngebyËx",
z¿ngebyËxCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

192 {"z»v¿ngebyËx",
z»v¿ngebyËxCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

193 {"zcouÁ",
zcouÁCommªd
,4,"rF",0,
NULL
,1,1,1,0,0},

194 {"zËxcouÁ",
zËxcouÁCommªd
,4,"rF",0,
NULL
,1,1,1,0,0},

195 {"z»v¿nge",
z»v¿ngeCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

196 {"zÿrd",
zÿrdCommªd
,2,"rF",0,
NULL
,1,1,1,0,0},

197 {"zscÜe",
zscÜeCommªd
,3,"rF",0,
NULL
,1,1,1,0,0},

198 {"z¿nk",
z¿nkCommªd
,3,"rF",0,
NULL
,1,1,1,0,0},

199 {"z»v¿nk",
z»v¿nkCommªd
,3,"rF",0,
NULL
,1,1,1,0,0},

200 {"zsÿn",
zsÿnCommªd
,-3,"rR",0,
NULL
,1,1,1,0,0},

201 {"h£t",
h£tCommªd
,-4,"wmF",0,
NULL
,1,1,1,0,0},

202 {"h£Šx",
h£ŠxCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

203 {"hg‘",
hg‘Commªd
,3,"rF",0,
NULL
,1,1,1,0,0},

204 {"hm£t",
h£tCommªd
,-4,"wmF",0,
NULL
,1,1,1,0,0},

205 {"hmg‘",
hmg‘Commªd
,-3,"rF",0,
NULL
,1,1,1,0,0},

206 {"hšüby",
hšübyCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

207 {"hšübyæßt",
hšübyæßtCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

208 {"hd–",
hd–Commªd
,-3,"wF",0,
NULL
,1,1,1,0,0},

209 {"hËn",
hËnCommªd
,2,"rF",0,
NULL
,1,1,1,0,0},

210 {"h¡¾’",
h¡¾’Commªd
,3,"rF",0,
NULL
,1,1,1,0,0},

211 {"hkeys",
hkeysCommªd
,2,"rS",0,
NULL
,1,1,1,0,0},

212 {"hv®s",
hv®sCommªd
,2,"rS",0,
NULL
,1,1,1,0,0},

213 {"hg‘®l",
hg‘®lCommªd
,2,"r",0,
NULL
,1,1,1,0,0},

214 {"hexi¡s",
hexi¡sCommªd
,3,"rF",0,
NULL
,1,1,1,0,0},

215 {"hsÿn",
hsÿnCommªd
,-3,"rR",0,
NULL
,1,1,1,0,0},

216 {"šüby",
šübyCommªd
,3,"wmF",0,
NULL
,1,1,1,0,0},

217 {"deüby",
deübyCommªd
,3,"wmF",0,
NULL
,1,1,1,0,0},

218 {"šübyæßt",
šübyæßtCommªd
,3,"wmF",0,
NULL
,1,1,1,0,0},

219 {"g‘£t",
g‘£tCommªd
,3,"wm",0,
NULL
,1,1,1,0,0},

220 {"m£t",
m£tCommªd
,-3,"wm",0,
NULL
,1,-1,2,0,0},

221 {"m£Šx",
m£ŠxCommªd
,-3,"wm",0,
NULL
,1,-1,2,0,0},

222 {"¿ndomkey",
¿ndomkeyCommªd
,1,"rR",0,
NULL
,0,0,0,0,0},

223 {"£Ëù",
£ËùCommªd
,2,"lF",0,
NULL
,0,0,0,0,0},

224 {"sw­db",
sw­dbCommªd
,3,"wF",0,
NULL
,0,0,0,0,0},

225 {"move",
moveCommªd
,3,"wF",0,
NULL
,1,1,1,0,0},

226 {"»Çme",
»ÇmeCommªd
,3,"w",0,
NULL
,1,2,1,0,0},

227 {"»Çm’x",
»Çm’xCommªd
,3,"wF",0,
NULL
,1,2,1,0,0},

228 {"expœe",
expœeCommªd
,3,"wF",0,
NULL
,1,1,1,0,0},

229 {"expœ—t",
expœ—tCommªd
,3,"wF",0,
NULL
,1,1,1,0,0},

230 {"³xpœe",
³xpœeCommªd
,3,"wF",0,
NULL
,1,1,1,0,0},

231 {"³xpœ—t",
³xpœ—tCommªd
,3,"wF",0,
NULL
,1,1,1,0,0},

232 {"keys",
keysCommªd
,2,"rS",0,
NULL
,0,0,0,0,0},

233 {"sÿn",
sÿnCommªd
,-2,"rR",0,
NULL
,0,0,0,0,0},

234 {"dbsize",
dbsizeCommªd
,1,"rF",0,
NULL
,0,0,0,0,0},

235 {"auth",
authCommªd
,2,"¦tF",0,
NULL
,0,0,0,0,0},

236 {"pšg",
pšgCommªd
,-1,"tF",0,
NULL
,0,0,0,0,0},

237 {"echo",
echoCommªd
,2,"F",0,
NULL
,0,0,0,0,0},

238 {"§ve",
§veCommªd
,1,"as",0,
NULL
,0,0,0,0,0},

239 {"bg§ve",
bg§veCommªd
,-1,"a",0,
NULL
,0,0,0,0,0},

240 {"bg»wr™—of",
bg»wr™—ofCommªd
,1,"a",0,
NULL
,0,0,0,0,0},

241 {"shutdown",
shutdownCommªd
,-1,"®t",0,
NULL
,0,0,0,0,0},

242 {"Ï¡§ve",
Ï¡§veCommªd
,1,"RF",0,
NULL
,0,0,0,0,0},

243 {"ty³",
ty³Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

244 {"muÉi",
muÉiCommªd
,1,"sF",0,
NULL
,0,0,0,0,0},

245 {"exec",
execCommªd
,1,"sM",0,
NULL
,0,0,0,0,0},

246 {"disÿrd",
disÿrdCommªd
,1,"sF",0,
NULL
,0,0,0,0,0},

247 {"sync",
syncCommªd
,1,"¬s",0,
NULL
,0,0,0,0,0},

248 {"psync",
syncCommªd
,3,"¬s",0,
NULL
,0,0,0,0,0},

249 {"»¶cÚf",
»¶cÚfCommªd
,-1,"a¦t",0,
NULL
,0,0,0,0,0},

250 {"æushdb",
æushdbCommªd
,-1,"w",0,
NULL
,0,0,0,0,0},

251 {"æush®l",
æush®lCommªd
,-1,"w",0,
NULL
,0,0,0,0,0},

252 {"sÜt",
sÜtCommªd
,-2,"wm",0,
sÜtG‘Keys
,1,1,1,0,0},

253 {"šfo",
šfoCommªd
,-1,"É",0,
NULL
,0,0,0,0,0},

254 {"mÚ™Ü",
mÚ™ÜCommªd
,1,"as",0,
NULL
,0,0,0,0,0},

255 {"‰l",
‰lCommªd
,2,"rF",0,
NULL
,1,1,1,0,0},

256 {"touch",
touchCommªd
,-2,"rF",0,
NULL
,1,1,1,0,0},

257 {"±",
±Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

258 {"³rsi¡",
³rsi¡Commªd
,2,"wF",0,
NULL
,1,1,1,0,0},

259 {"¦aveof",
¦aveofCommªd
,3,"a¡",0,
NULL
,0,0,0,0,0},

260 {"rŞe",
rŞeCommªd
,1,"l¡",0,
NULL
,0,0,0,0,0},

261 {"debug",
debugCommªd
,-1,"as",0,
NULL
,0,0,0,0,0},

262 {"cÚfig",
cÚfigCommªd
,-2,"Ït",0,
NULL
,0,0,0,0,0},

263 {"subsüibe",
subsüibeCommªd
,-2,"p¦t",0,
NULL
,0,0,0,0,0},

264 {"unsubsüibe",
unsubsüibeCommªd
,-1,"p¦t",0,
NULL
,0,0,0,0,0},

265 {"psubsüibe",
psubsüibeCommªd
,-2,"p¦t",0,
NULL
,0,0,0,0,0},

266 {"punsubsüibe",
punsubsüibeCommªd
,-1,"p¦t",0,
NULL
,0,0,0,0,0},

267 {"publish",
publishCommªd
,3,"¶tF",0,
NULL
,0,0,0,0,0},

268 {"pubsub",
pubsubCommªd
,-2,"¶tR",0,
NULL
,0,0,0,0,0},

269 {"w©ch",
w©chCommªd
,-2,"sF",0,
NULL
,1,-1,1,0,0},

270 {"unw©ch",
unw©chCommªd
,1,"sF",0,
NULL
,0,0,0,0,0},

271 {"şu¡”",
şu¡”Commªd
,-2,"a",0,
NULL
,0,0,0,0,0},

272 {"»¡Üe",
»¡ÜeCommªd
,-4,"wm",0,
NULL
,1,1,1,0,0},

273 {"»¡Üe-askšg",
»¡ÜeCommªd
,-4,"wmk",0,
NULL
,1,1,1,0,0},

274 {"mig¿‹",
mig¿‹Commªd
,-6,"w",0,
mig¿‹G‘Keys
,0,0,0,0,0},

275 {"askšg",
askšgCommªd
,1,"F",0,
NULL
,0,0,0,0,0},

276 {"»adÚly",
»adÚlyCommªd
,1,"F",0,
NULL
,0,0,0,0,0},

277 {"»adwr™e",
»adwr™eCommªd
,1,"F",0,
NULL
,0,0,0,0,0},

278 {"dump",
dumpCommªd
,2,"r",0,
NULL
,1,1,1,0,0},

279 {"objeù",
objeùCommªd
,3,"r",0,
NULL
,2,2,2,0,0},

280 {"memÜy",
memÜyCommªd
,-2,"r",0,
NULL
,0,0,0,0,0},

281 {"ş›Á",
ş›ÁCommªd
,-2,"as",0,
NULL
,0,0,0,0,0},

282 {"ev®",
ev®Commªd
,-3,"s",0,
ev®G‘Keys
,0,0,0,0,0},

283 {"ev®sha",
ev®ShaCommªd
,-3,"s",0,
ev®G‘Keys
,0,0,0,0,0},

284 {"¦owlog",
¦owlogCommªd
,-2,"a",0,
NULL
,0,0,0,0,0},

285 {"süt",
sütCommªd
,-2,"s",0,
NULL
,0,0,0,0,0},

286 {"time",
timeCommªd
,1,"RF",0,
NULL
,0,0,0,0,0},

287 {"b™İ",
b™İCommªd
,-4,"wm",0,
NULL
,2,-1,1,0,0},

288 {"b™couÁ",
b™couÁCommªd
,-2,"r",0,
NULL
,1,1,1,0,0},

289 {"b™pos",
b™posCommªd
,-3,"r",0,
NULL
,1,1,1,0,0},

290 {"wa™",
wa™Commªd
,3,"s",0,
NULL
,0,0,0,0,0},

291 {"commªd",
commªdCommªd
,0,"É",0,
NULL
,0,0,0,0,0},

292 {"geßdd",
geßddCommªd
,-5,"wm",0,
NULL
,1,1,1,0,0},

293 {"geÜadius",
geÜadiusCommªd
,-6,"w",0,
geÜadiusG‘Keys
,1,1,1,0,0},

294 {"geÜadius_ro",
geÜadiu¤oCommªd
,-6,"r",0,
geÜadiusG‘Keys
,1,1,1,0,0},

295 {"geÜadiusbymemb”",
geÜadiusbymemb”Commªd
,-5,"w",0,
geÜadiusG‘Keys
,1,1,1,0,0},

296 {"geÜadiusbymemb”_ro",
geÜadiusbymemb”roCommªd
,-5,"r",0,
geÜadiusG‘Keys
,1,1,1,0,0},

297 {"geohash",
geohashCommªd
,-2,"r",0,
NULL
,1,1,1,0,0},

298 {"geİos",
geİosCommªd
,-2,"r",0,
NULL
,1,1,1,0,0},

299 {"geodi¡",
geodi¡Commªd
,-4,"r",0,
NULL
,1,1,1,0,0},

300 {"pf£láe¡",
pf£láe¡Commªd
,1,"a",0,
NULL
,0,0,0,0,0},

301 {"pçdd",
pçddCommªd
,-2,"wmF",0,
NULL
,1,1,1,0,0},

302 {"pfcouÁ",
pfcouÁCommªd
,-2,"r",0,
NULL
,1,-1,1,0,0},

303 {"pfm”ge",
pfm”geCommªd
,-2,"wm",0,
NULL
,1,-1,1,0,0},

304 {"pfdebug",
pfdebugCommªd
,-3,"w",0,
NULL
,0,0,0,0,0},

305 {"po¡",
£cur™yW¬nšgCommªd
,-1,"É",0,
NULL
,0,0,0,0,0},

306 {"ho¡:",
£cur™yW¬nšgCommªd
,-1,"É",0,
NULL
,0,0,0,0,0},

307 {"Ï‹ncy",
Ï‹ncyCommªd
,-2,"a¦t",0,
NULL
,0,0,0,0,0}

314 
	$£rv”LogRaw
(
Ëv–
, cÚ¡ *
msg
) {

315 cÚ¡ 
sy¦ogLev–M­
[] = { 
LOG_DEBUG
, 
LOG_INFO
, 
LOG_NOTICE
, 
LOG_WARNING
 };

316 cÚ¡ *
c
 = ".-*#";

317 
FILE
 *
å
;

318 
buf
[64];

319 
¿wmode
 = (
Ëv–
 & 
LL_RAW
);

320 
log_to_¡dout
 = 
£rv”
.
logfe
[0] == '\0';

322 
Ëv–
 &= 0xff;

323 ià(
Ëv–
 < 
£rv”
.
v”bos™y
) ;

325 
å
 = 
log_to_¡dout
 ? 
¡dout
 : 
	`fİ’
(
£rv”
.
logfe
,"a");

326 ià(!
å
) ;

328 ià(
¿wmode
) {

329 
	`årštf
(
å
,"%s",
msg
);

331 
off
;

332 
timev®
 
tv
;

333 
rŞe_ch¬
;

334 
pid_t
 
pid
 = 
	`g‘pid
();

336 
	`g‘timeofday
(&
tv
,
NULL
);

337 
off
 = 
	`¡ráime
(
buf
,(buf),"%d %b %H:%M:%S.",
	`loÿÉime
(&
tv
.
tv_£c
));

338 
	`¢´štf
(
buf
+
off
,(buf)-off,"%03d",()
tv
.
tv_u£c
/1000);

339 ià(
£rv”
.
£Áš–_mode
) {

340 
rŞe_ch¬
 = 'X';

341 } ià(
pid
 !ğ
£rv”
.pid) {

342 
rŞe_ch¬
 = 'C';

344 
rŞe_ch¬
 = (
£rv”
.
ma¡”ho¡
 ? 'S':'M');

346 
	`årštf
(
å
,"%d:%c %s %c %s\n",

347 ()
	`g‘pid
(),
rŞe_ch¬
, 
buf
,
c
[
Ëv–
],
msg
);

349 
	`fæush
(
å
);

351 ià(!
log_to_¡dout
è
	`fşo£
(
å
);

352 ià(
£rv”
.
sy¦og_’abËd
è
	`sy¦og
(
sy¦ogLev–M­
[
Ëv–
], "%s", 
msg
);

353 
	}
}

358 
	$£rv”Log
(
Ëv–
, cÚ¡ *
fmt
, ...) {

359 
va_li¡
 
­
;

360 
msg
[
LOG_MAX_LEN
];

362 ià((
Ëv–
&0xffè< 
£rv”
.
v”bos™y
) ;

364 
	`va_¡¬t
(
­
, 
fmt
);

365 
	`v¢´štf
(
msg
, (msg), 
fmt
, 
­
);

366 
	`va_’d
(
­
);

368 
	`£rv”LogRaw
(
Ëv–
,
msg
);

369 
	}
}

377 
	$£rv”LogFromHªdËr
(
Ëv–
, cÚ¡ *
msg
) {

378 
fd
;

379 
log_to_¡dout
 = 
£rv”
.
logfe
[0] == '\0';

380 
buf
[64];

382 ià((
Ëv–
&0xffè< 
£rv”
.
v”bos™y
 || (
log_to_¡dout
 && s”v”.
d«mÚize
))

384 
fd
 = 
log_to_¡dout
 ? 
STDOUT_FILENO
 :

385 
	`İ’
(
£rv”
.
logfe
, 
O_APPEND
|
O_CREAT
|
O_WRONLY
, 0644);

386 ià(
fd
 == -1) ;

387 
	`Î2¡ršg
(
buf
,(buf),
	`g‘pid
());

388 ià(
	`wr™e
(
fd
,
buf
,
	`¡¾’
(buf)è=ğ-1è
”r
;

389 ià(
	`wr™e
(
fd
,":sigÇl-hªdË¸(",17è=ğ-1è
”r
;

390 
	`Î2¡ršg
(
buf
,(buf),
	`time
(
NULL
));

391 ià(
	`wr™e
(
fd
,
buf
,
	`¡¾’
(buf)è=ğ-1è
”r
;

392 ià(
	`wr™e
(
fd
,"è",2è=ğ-1è
”r
;

393 ià(
	`wr™e
(
fd
,
msg
,
	`¡¾’
(msg)è=ğ-1è
”r
;

394 ià(
	`wr™e
(
fd
,"\n",1è=ğ-1è
”r
;

395 
”r
:

396 ià(!
log_to_¡dout
è
	`şo£
(
fd
);

397 
	}
}

400 
	$u¡ime
() {

401 
timev®
 
tv
;

402 
u¡
;

404 
	`g‘timeofday
(&
tv
, 
NULL
);

405 
u¡
 = (()
tv
.
tv_£c
)*1000000;

406 
u¡
 +ğ
tv
.
tv_u£c
;

407  
u¡
;

408 
	}
}

411 
m¡ime_t
 
	$m¡ime
() {

412  
	`u¡ime
()/1000;

413 
	}
}

419 
	$ex™FromChd
(
»tcode
) {

420 #ifdeà
COVERAGE_TEST


421 
	`ex™
(
»tcode
);

423 
	`_ex™
(
»tcode
);

425 
	}
}

433 
	$diùVªÏF»e
(*
´ivd©a
, *
v®
)

435 
	`DICT_NOTUSED
(
´ivd©a
);

436 
	`zä“
(
v®
);

437 
	}
}

439 
	$diùLi¡De¡ruùÜ
(*
´ivd©a
, *
v®
)

441 
	`DICT_NOTUSED
(
´ivd©a
);

442 
	`li¡R–—£
((
li¡
*)
v®
);

443 
	}
}

445 
	$diùSdsKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
,

446 cÚ¡ *
key2
)

448 
l1
,
l2
;

449 
	`DICT_NOTUSED
(
´ivd©a
);

451 
l1
 = 
	`sd¦’
((
sds
)
key1
);

452 
l2
 = 
	`sd¦’
((
sds
)
key2
);

453 ià(
l1
 !ğ
l2
)  0;

454  
	`memcmp
(
key1
, 
key2
, 
l1
) == 0;

455 
	}
}

459 
	$diùSdsKeyCa£Com·»
(*
´ivd©a
, cÚ¡ *
key1
,

460 cÚ¡ *
key2
)

462 
	`DICT_NOTUSED
(
´ivd©a
);

464  
	`¡rÿ£cmp
(
key1
, 
key2
) == 0;

465 
	}
}

467 
	$diùObjeùDe¡ruùÜ
(*
´ivd©a
, *
v®
)

469 
	`DICT_NOTUSED
(
´ivd©a
);

471 ià(
v®
 =ğ
NULL
) ;

472 
	`deüRefCouÁ
(
v®
);

473 
	}
}

475 
	$diùSdsDe¡ruùÜ
(*
´ivd©a
, *
v®
)

477 
	`DICT_NOTUSED
(
´ivd©a
);

479 
	`sdsä“
(
v®
);

480 
	}
}

482 
	$diùObjKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
,

483 cÚ¡ *
key2
)

485 cÚ¡ 
robj
 *
o1
 = 
key1
, *
o2
 = 
key2
;

486  
	`diùSdsKeyCom·»
(
´ivd©a
,
o1
->
±r
,
o2
->ptr);

487 
	}
}

489 
ušt64_t
 
	$diùObjHash
(cÚ¡ *
key
) {

490 cÚ¡ 
robj
 *
o
 = 
key
;

491  
	`diùG’HashFunùiÚ
(
o
->
±r
, 
	`sd¦’
((
sds
)o->ptr));

492 
	}
}

494 
ušt64_t
 
	$diùSdsHash
(cÚ¡ *
key
) {

495  
	`diùG’HashFunùiÚ
((*)
key
, 
	`sd¦’
((*)key));

496 
	}
}

498 
ušt64_t
 
	$diùSdsCa£Hash
(cÚ¡ *
key
) {

499  
	`diùG’Ca£HashFunùiÚ
((*)
key
, 
	`sd¦’
((*)key));

500 
	}
}

502 
	$diùEncObjKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
,

503 cÚ¡ *
key2
)

505 
robj
 *
o1
 = (robj*è
key1
, *
o2
 = (robj*è
key2
;

506 
cmp
;

508 ià(
o1
->
’codšg
 =ğ
OBJ_ENCODING_INT
 &&

509 
o2
->
’codšg
 =ğ
OBJ_ENCODING_INT
)

510  
o1
->
±r
 =ğ
o2
->ptr;

512 
o1
 = 
	`g‘DecodedObjeù
(o1);

513 
o2
 = 
	`g‘DecodedObjeù
(o2);

514 
cmp
 = 
	`diùSdsKeyCom·»
(
´ivd©a
,
o1
->
±r
,
o2
->ptr);

515 
	`deüRefCouÁ
(
o1
);

516 
	`deüRefCouÁ
(
o2
);

517  
cmp
;

518 
	}
}

520 
ušt64_t
 
	$diùEncObjHash
(cÚ¡ *
key
) {

521 
robj
 *
o
 = (robj*è
key
;

523 ià(
	`sdsEncodedObjeù
(
o
)) {

524  
	`diùG’HashFunùiÚ
(
o
->
±r
, 
	`sd¦’
((
sds
)o->ptr));

526 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

527 
buf
[32];

528 
Ën
;

530 
Ën
 = 
	`Î2¡ršg
(
buf
,32,()
o
->
±r
);

531  
	`diùG’HashFunùiÚ
((*)
buf
, 
Ën
);

533 
ušt64_t
 
hash
;

535 
o
 = 
	`g‘DecodedObjeù
(o);

536 
hash
 = 
	`diùG’HashFunùiÚ
(
o
->
±r
, 
	`sd¦’
((
sds
)o->ptr));

537 
	`deüRefCouÁ
(
o
);

538  
hash
;

541 
	}
}

545 
diùTy³
 
	gobjeùKeyPoš‹rV®ueDiùTy³
 = {

546 
diùEncObjHash
,

547 
NULL
,

548 
NULL
,

549 
diùEncObjKeyCom·»
,

550 
diùObjeùDe¡ruùÜ
,

551 
NULL


555 
diùTy³
 
	g£tDiùTy³
 = {

556 
diùSdsHash
,

557 
NULL
,

558 
NULL
,

559 
diùSdsKeyCom·»
,

560 
diùSdsDe¡ruùÜ
,

561 
NULL


565 
diùTy³
 
	gz£tDiùTy³
 = {

566 
diùSdsHash
,

567 
NULL
,

568 
NULL
,

569 
diùSdsKeyCom·»
,

570 
NULL
,

571 
NULL


575 
diùTy³
 
	gdbDiùTy³
 = {

576 
diùSdsHash
,

577 
NULL
,

578 
NULL
,

579 
diùSdsKeyCom·»
,

580 
diùSdsDe¡ruùÜ
,

581 
diùObjeùDe¡ruùÜ


585 
diùTy³
 
	gshaSütObjeùDiùTy³
 = {

586 
diùSdsCa£Hash
,

587 
NULL
,

588 
NULL
,

589 
diùSdsKeyCa£Com·»
,

590 
diùSdsDe¡ruùÜ
,

591 
diùObjeùDe¡ruùÜ


595 
diùTy³
 
	gkey±rDiùTy³
 = {

596 
diùSdsHash
,

597 
NULL
,

598 
NULL
,

599 
diùSdsKeyCom·»
,

600 
NULL
,

601 
NULL


605 
diùTy³
 
	gcommªdTabËDiùTy³
 = {

606 
diùSdsCa£Hash
,

607 
NULL
,

608 
NULL
,

609 
diùSdsKeyCa£Com·»
,

610 
diùSdsDe¡ruùÜ
,

611 
NULL


615 
diùTy³
 
	ghashDiùTy³
 = {

616 
diùSdsHash
,

617 
NULL
,

618 
NULL
,

619 
diùSdsKeyCom·»
,

620 
diùSdsDe¡ruùÜ
,

621 
diùSdsDe¡ruùÜ


627 
diùTy³
 
	gkeyli¡DiùTy³
 = {

628 
diùObjHash
,

629 
NULL
,

630 
NULL
,

631 
diùObjKeyCom·»
,

632 
diùObjeùDe¡ruùÜ
,

633 
diùLi¡De¡ruùÜ


638 
diùTy³
 
	gşu¡”NodesDiùTy³
 = {

639 
diùSdsHash
,

640 
NULL
,

641 
NULL
,

642 
diùSdsKeyCom·»
,

643 
diùSdsDe¡ruùÜ
,

644 
NULL


650 
diùTy³
 
	gşu¡”NodesBÏckLi¡DiùTy³
 = {

651 
diùSdsCa£Hash
,

652 
NULL
,

653 
NULL
,

654 
diùSdsKeyCa£Com·»
,

655 
diùSdsDe¡ruùÜ
,

656 
NULL


662 
diùTy³
 
	gmoduËsDiùTy³
 = {

663 
diùSdsCa£Hash
,

664 
NULL
,

665 
NULL
,

666 
diùSdsKeyCa£Com·»
,

667 
diùSdsDe¡ruùÜ
,

668 
NULL


672 
diùTy³
 
	gmig¿‹CacheDiùTy³
 = {

673 
diùSdsHash
,

674 
NULL
,

675 
NULL
,

676 
diùSdsKeyCom·»
,

677 
diùSdsDe¡ruùÜ
,

678 
NULL


684 
diùTy³
 
	g»¶SütCacheDiùTy³
 = {

685 
diùSdsCa£Hash
,

686 
NULL
,

687 
NULL
,

688 
diùSdsKeyCa£Com·»
,

689 
diùSdsDe¡ruùÜ
,

690 
NULL


693 
	$htN“dsResize
(
diù
 *dict) {

694 
size
, 
u£d
;

696 
size
 = 
	`diùSlÙs
(
diù
);

697 
u£d
 = 
	`diùSize
(
diù
);

698  (
size
 > 
DICT_HT_INITIAL_SIZE
 &&

699 (
u£d
*100/
size
 < 
HASHTABLE_MIN_FILL
));

700 
	}
}

704 
	$ŒyResizeHashTabËs
(
dbid
) {

705 ià(
	`htN“dsResize
(
£rv”
.
db
[
dbid
].
diù
))

706 
	`diùResize
(
£rv”
.
db
[
dbid
].
diù
);

707 ià(
	`htN“dsResize
(
£rv”
.
db
[
dbid
].
expœes
))

708 
	`diùResize
(
£rv”
.
db
[
dbid
].
expœes
);

709 
	}
}

718 
	$šüem’ÎyRehash
(
dbid
) {

720 ià(
	`diùIsRehashšg
(
£rv”
.
db
[
dbid
].
diù
)) {

721 
	`diùRehashMli£cÚds
(
£rv”
.
db
[
dbid
].
diù
,1);

725 ià(
	`diùIsRehashšg
(
£rv”
.
db
[
dbid
].
expœes
)) {

726 
	`diùRehashMli£cÚds
(
£rv”
.
db
[
dbid
].
expœes
,1);

730 
	}
}

738 
	$upd©eDiùResizePŞicy
() {

739 ià(
£rv”
.
rdb_chd_pid
 =ğ-1 && s”v”.
aof_chd_pid
 == -1)

740 
	`diùEÇbËResize
();

742 
	`diùDi§bËResize
();

743 
	}
}

748 
	$ŒackIn¡ªÃousM‘ric
(
m‘ric
, 
cu¼’t_»adšg
) {

749 
t
 = 
	`m¡ime
(è- 
£rv”
.
š¡_m‘ric
[
m‘ric
].
Ï¡_§m¶e_time
;

750 
İs
 = 
cu¼’t_»adšg
 -

751 
£rv”
.
š¡_m‘ric
[
m‘ric
].
Ï¡_§m¶e_couÁ
;

752 
İs_£c
;

754 
İs_£c
 = 
t
 > 0 ? (
İs
*1000/t) : 0;

756 
£rv”
.
š¡_m‘ric
[
m‘ric
].
§m¶es
[£rv”.š¡_m‘ric[m‘ric].
idx
] =

757 
İs_£c
;

758 
£rv”
.
š¡_m‘ric
[
m‘ric
].
idx
++;

759 
£rv”
.
š¡_m‘ric
[
m‘ric
].
idx
 %ğ
STATS_METRIC_SAMPLES
;

760 
£rv”
.
š¡_m‘ric
[
m‘ric
].
Ï¡_§m¶e_time
 = 
	`m¡ime
();

761 
£rv”
.
š¡_m‘ric
[
m‘ric
].
Ï¡_§m¶e_couÁ
 = 
cu¼’t_»adšg
;

762 
	}
}

765 
	$g‘In¡ªÃousM‘ric
(
m‘ric
) {

766 
j
;

767 
sum
 = 0;

769 
j
 = 0; j < 
STATS_METRIC_SAMPLES
; j++)

770 
sum
 +ğ
£rv”
.
š¡_m‘ric
[
m‘ric
].
§m¶es
[
j
];

771  
sum
 / 
STATS_METRIC_SAMPLES
;

772 
	}
}

778 
	$ş›ÁsCrÚHªdËTimeout
(
ş›Á
 *
c
, 
m¡ime_t
 
now_ms
) {

779 
time_t
 
now
 = 
now_ms
/1000;

781 ià(
£rv”
.
maxidËtime
 &&

782 !(
c
->
æags
 & 
CLIENT_SLAVE
) &&

783 !(
c
->
æags
 & 
CLIENT_MASTER
) &&

784 !(
c
->
æags
 & 
CLIENT_BLOCKED
) &&

785 !(
c
->
æags
 & 
CLIENT_PUBSUB
) &&

786 (
now
 - 
c
->
Ï¡š‹¿ùiÚ
 > 
£rv”
.
maxidËtime
))

788 
	`£rv”Log
(
LL_VERBOSE
,"Closing idle client");

789 
	`ä“Cl›Á
(
c
);

791 } ià(
c
->
æags
 & 
CLIENT_BLOCKED
) {

796 ià(
c
->
bpİ
.
timeout
 !ğ0 && c->bpİ.timeouˆ< 
now_ms
) {

798 
	`»¶yToBlockedCl›ÁTimedOut
(
c
);

799 
	`unblockCl›Á
(
c
);

800 } ià(
£rv”
.
şu¡”_’abËd
) {

803 ià(
	`şu¡”RedœeùBlockedCl›ÁIfN“ded
(
c
))

804 
	`unblockCl›Á
(
c
);

808 
	}
}

814 
	$ş›ÁsCrÚResizeQu”yBufãr
(
ş›Á
 *
c
) {

815 
size_t
 
qu”ybuf_size
 = 
	`sdsAÎocSize
(
c
->
qu”ybuf
);

816 
time_t
 
idËtime
 = 
£rv”
.
unixtime
 - 
c
->
Ï¡š‹¿ùiÚ
;

821 ià(((
qu”ybuf_size
 > 
PROTO_MBULK_BIG_ARG
) &&

822 (
qu”ybuf_size
/(
c
->
qu”ybuf_³ak
+1)) > 2) ||

823 (
qu”ybuf_size
 > 1024 && 
idËtime
 > 2))

826 ià(
	`sd§va
(
c
->
qu”ybuf
) > 1024) {

827 
c
->
qu”ybuf
 = 
	`sdsRemoveF»eS·û
(c->querybuf);

832 
c
->
qu”ybuf_³ak
 = 0;

834 
	}
}

836 
	#CLIENTS_CRON_MIN_ITERATIONS
 5

	)

837 
	$ş›ÁsCrÚ
() {

842 
numş›Ás
 = 
	`li¡L’gth
(
£rv”
.
ş›Ás
);

843 
™”©iÚs
 = 
numş›Ás
/
£rv”
.
hz
;

844 
m¡ime_t
 
now
 = 
	`m¡ime
();

849 ià(
™”©iÚs
 < 
CLIENTS_CRON_MIN_ITERATIONS
)

850 
™”©iÚs
 = (
numş›Ás
 < 
CLIENTS_CRON_MIN_ITERATIONS
) ?

851 
numş›Ás
 : 
CLIENTS_CRON_MIN_ITERATIONS
;

853 
	`li¡L’gth
(
£rv”
.
ş›Ás
è&& 
™”©iÚs
--) {

854 
ş›Á
 *
c
;

855 
li¡Node
 *
h—d
;

860 
	`li¡RÙ©e
(
£rv”
.
ş›Ás
);

861 
h—d
 = 
	`li¡Fœ¡
(
£rv”
.
ş›Ás
);

862 
c
 = 
	`li¡NodeV®ue
(
h—d
);

866 ià(
	`ş›ÁsCrÚHªdËTimeout
(
c
,
now
)) ;

867 ià(
	`ş›ÁsCrÚResizeQu”yBufãr
(
c
)) ;

869 
	}
}

874 
	$d©aba£sCrÚ
() {

877 ià(
£rv”
.
aùive_expœe_’abËd
 && s”v”.
ma¡”ho¡
 =ğ
NULL
) {

878 
	`aùiveExpœeCyşe
(
ACTIVE_EXPIRE_CYCLE_SLOW
);

879 } ià(
£rv”
.
ma¡”ho¡
 !ğ
NULL
) {

880 
	`expœeSÏveKeys
();

884 ià(
£rv”
.
aùive_deäag_’abËd
)

885 
	`aùiveDeäagCyşe
();

890 ià(
£rv”
.
rdb_chd_pid
 =ğ-1 && s”v”.
aof_chd_pid
 == -1) {

894 
»size_db
 = 0;

895 
»hash_db
 = 0;

896 
dbs_³r_ÿÎ
 = 
CRON_DBS_PER_CALL
;

897 
j
;

900 ià(
dbs_³r_ÿÎ
 > 
£rv”
.
dbnum
) dbs_per_call = server.dbnum;

903 
j
 = 0; j < 
dbs_³r_ÿÎ
; j++) {

904 
	`ŒyResizeHashTabËs
(
»size_db
 % 
£rv”
.
dbnum
);

905 
»size_db
++;

909 ià(
£rv”
.
aùiv”ehashšg
) {

910 
j
 = 0; j < 
dbs_³r_ÿÎ
; j++) {

911 
wÜk_dÚe
 = 
	`šüem’ÎyRehash
(
»hash_db
 % 
£rv”
.
dbnum
);

912 
»hash_db
++;

913 ià(
wÜk_dÚe
) {

921 
	}
}

927 
	$upd©eCachedTime
() {

928 
time_t
 
unixtime
 = 
	`time
(
NULL
);

929 
	`©omicS‘
(
£rv”
.
unixtime
,unixtime);

930 
£rv”
.
m¡ime
 = 
	`m¡ime
();

931 
	}
}

952 
	$£rv”CrÚ
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
) {

953 
j
;

954 
	`UNUSED
(
ev’tLoİ
);

955 
	`UNUSED
(
id
);

956 
	`UNUSED
(
ş›ÁD©a
);

960 ià(
£rv”
.
w©chdog_³riod
è
	`w©chdogScheduËSigÇl
(server.watchdog_period);

963 
	`upd©eCachedTime
();

965 
	`run_w™h_³riod
(100) {

966 
	`ŒackIn¡ªÃousM‘ric
(
STATS_METRIC_COMMAND
,
£rv”
.
¡©_numcommªds
);

967 
	`ŒackIn¡ªÃousM‘ric
(
STATS_METRIC_NET_INPUT
,

968 
£rv”
.
¡©_Ãt_šput_by‹s
);

969 
	`ŒackIn¡ªÃousM‘ric
(
STATS_METRIC_NET_OUTPUT
,

970 
£rv”
.
¡©_Ãt_ouut_by‹s
);

984 
Ìuşock
 = 
	`g‘LRUClock
();

985 
	`©omicS‘
(
£rv”
.
Ìuşock
,lruclock);

988 ià(
	`zm®loc_u£d_memÜy
(è> 
£rv”
.
¡©_³ak_memÜy
)

989 
£rv”
.
¡©_³ak_memÜy
 = 
	`zm®loc_u£d_memÜy
();

992 
£rv”
.
»sid’t_£t_size
 = 
	`zm®loc_g‘_rss
();

996 ià(
£rv”
.
shutdown_a§p
) {

997 ià(
	`´•¬eFÜShutdown
(
SHUTDOWN_NOFLAGS
è=ğ
C_OK
è
	`ex™
(0);

998 
	`£rv”Log
(
LL_WARNING
,"SIGTERM„eceived butƒrrorsryingo shut downhe server, checkhe†ogs for more information");

999 
£rv”
.
shutdown_a§p
 = 0;

1003 
	`run_w™h_³riod
(5000) {

1004 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

1005 
size
, 
u£d
, 
vkeys
;

1007 
size
 = 
	`diùSlÙs
(
£rv”
.
db
[
j
].
diù
);

1008 
u£d
 = 
	`diùSize
(
£rv”
.
db
[
j
].
diù
);

1009 
vkeys
 = 
	`diùSize
(
£rv”
.
db
[
j
].
expœes
);

1010 ià(
u£d
 || 
vkeys
) {

1011 
	`£rv”Log
(
LL_VERBOSE
,"DB %d: %Îd key (%Îd vŞ©eèš %Îd slÙ HT.",
j
,
u£d
,
vkeys
,
size
);

1018 ià(!
£rv”
.
£Áš–_mode
) {

1019 
	`run_w™h_³riod
(5000) {

1020 
	`£rv”Log
(
LL_VERBOSE
,

1022 
	`li¡L’gth
(
£rv”
.
ş›Ás
)-li¡L’gth(£rv”.
¦aves
),

1023 
	`li¡L’gth
(
£rv”
.
¦aves
),

1024 
	`zm®loc_u£d_memÜy
());

1029 
	`ş›ÁsCrÚ
();

1032 
	`d©aba£sCrÚ
();

1036 ià(
£rv”
.
rdb_chd_pid
 =ğ-1 && s”v”.
aof_chd_pid
 == -1 &&

1037 
£rv”
.
aof_»wr™e_scheduËd
)

1039 
	`»wr™eAµ’dOÆyFeBackground
();

1043 ià(
£rv”
.
rdb_chd_pid
 !ğ-1 || s”v”.
aof_chd_pid
 != -1 ||

1044 
	`ldbP’dšgChd»n
())

1046 
¡©loc
;

1047 
pid_t
 
pid
;

1049 ià((
pid
 = 
	`wa™3
(&
¡©loc
,
WNOHANG
,
NULL
)) != 0) {

1050 
ex™code
 = 
	`WEXITSTATUS
(
¡©loc
);

1051 
bysigÇl
 = 0;

1053 ià(
	`WIFSIGNALED
(
¡©loc
)è
bysigÇl
 = 
	`WTERMSIG
(statloc);

1055 ià(
pid
 == -1) {

1056 
	`£rv”Log
(
LL_WARNING
,"wait3()„eturned‡nƒrror: %s. "

1058 
	`¡»¼Ü
(
”ºo
),

1059 (è
£rv”
.
rdb_chd_pid
,

1060 (è
£rv”
.
aof_chd_pid
);

1061 } ià(
pid
 =ğ
£rv”
.
rdb_chd_pid
) {

1062 
	`backgroundSaveDÚeHªdËr
(
ex™code
,
bysigÇl
);

1063 ià(!
bysigÇl
 && 
ex™code
 =ğ0è
	`»ûiveChdInfo
();

1064 } ià(
pid
 =ğ
£rv”
.
aof_chd_pid
) {

1065 
	`backgroundRewr™eDÚeHªdËr
(
ex™code
,
bysigÇl
);

1066 ià(!
bysigÇl
 && 
ex™code
 =ğ0è
	`»ûiveChdInfo
();

1068 ià(!
	`ldbRemoveChd
(
pid
)) {

1069 
	`£rv”Log
(
LL_WARNING
,

1071 ()
pid
);

1074 
	`upd©eDiùResizePŞicy
();

1075 
	`şo£ChdInfoPe
();

1080 
j
 = 0; j < 
£rv”
.
§v•¬am¦’
; j++) {

1081 
§v•¬am
 *
¥
 = 
£rv”
.
§v•¬ams
+
j
;

1087 ià(
£rv”
.
dœty
 >ğ
¥
->
chªges
 &&

1088 
£rv”
.
unixtime
-£rv”.
Ï¡§ve
 > 
¥
->
£cÚds
 &&

1089 (
£rv”
.
unixtime
-£rv”.
Ï¡bg§ve_Œy
 >

1090 
CONFIG_BGSAVE_RETRY_DELAY
 ||

1091 
£rv”
.
Ï¡bg§ve_¡©us
 =ğ
C_OK
))

1093 
	`£rv”Log
(
LL_NOTICE
,"%d changes in %d seconds. Saving...",

1094 
¥
->
chªges
, ()¥->
£cÚds
);

1095 
	`rdbSaveBackground
(
£rv”
.
rdb_f’ame
,
NULL
);

1101 ià(
£rv”
.
rdb_chd_pid
 == -1 &&

1102 
£rv”
.
aof_chd_pid
 == -1 &&

1103 
£rv”
.
aof_»wr™e_³rc
 &&

1104 
£rv”
.
aof_cu¼’t_size
 > s”v”.
aof_»wr™e_mš_size
)

1106 
ba£
 = 
£rv”
.
aof_»wr™e_ba£_size
 ?

1107 
£rv”
.
aof_»wr™e_ba£_size
 : 1;

1108 
growth
 = (
£rv”
.
aof_cu¼’t_size
*100/
ba£
) - 100;

1109 ià(
growth
 >ğ
£rv”
.
aof_»wr™e_³rc
) {

1110 
	`£rv”Log
(
LL_NOTICE
,"S¹šg‡utom©iø»wr™šg oàAOF oÀ%Îd%% growth",
growth
);

1111 
	`»wr™eAµ’dOÆyFeBackground
();

1119 ià(
£rv”
.
aof_æush_po¡pÚed_¡¬t
è
	`æushAµ’dOÆyFe
(0);

1125 
	`run_w™h_³riod
(1000) {

1126 ià(
£rv”
.
aof_Ï¡_wr™e_¡©us
 =ğ
C_ERR
)

1127 
	`æushAµ’dOÆyFe
(0);

1131 
	`ä“Cl›ÁsInAsyncF»eQueue
();

1134 
	`ş›ÁsA»Pau£d
();

1138 
	`run_w™h_³riod
(1000è
	`»¶iÿtiÚCrÚ
();

1141 
	`run_w™h_³riod
(100) {

1142 ià(
£rv”
.
şu¡”_’abËd
è
	`şu¡”CrÚ
();

1146 
	`run_w™h_³riod
(100) {

1147 ià(
£rv”
.
£Áš–_mode
è
	`£Áš–Tim”
();

1151 
	`run_w™h_³riod
(1000) {

1152 
	`mig¿‹Clo£TimedoutSock‘s
();

1162 ià(
£rv”
.
rdb_chd_pid
 =ğ-1 && s”v”.
aof_chd_pid
 == -1 &&

1163 
£rv”
.
rdb_bg§ve_scheduËd
 &&

1164 (
£rv”
.
unixtime
-£rv”.
Ï¡bg§ve_Œy
 > 
CONFIG_BGSAVE_RETRY_DELAY
 ||

1165 
£rv”
.
Ï¡bg§ve_¡©us
 =ğ
C_OK
))

1167 ià(
	`rdbSaveBackground
(
£rv”
.
rdb_f’ame
,
NULL
è=ğ
C_OK
)

1168 
£rv”
.
rdb_bg§ve_scheduËd
 = 0;

1171 
£rv”
.
üÚloİs
++;

1172  1000/
£rv”
.
hz
;

1173 
	}
}

1178 
	$befÜeSË•
(
«Ev’tLoİ
 *
ev’tLoİ
) {

1179 
	`UNUSED
(
ev’tLoİ
);

1185 ià(
£rv”
.
şu¡”_’abËd
è
	`şu¡”BefÜeSË•
();

1189 ià(
£rv”
.
aùive_expœe_’abËd
 && s”v”.
ma¡”ho¡
 =ğ
NULL
)

1190 
	`aùiveExpœeCyşe
(
ACTIVE_EXPIRE_CYCLE_FAST
);

1194 ià(
£rv”
.
g‘_ack_äom_¦aves
) {

1195 
robj
 *
¬gv
[3];

1197 
¬gv
[0] = 
	`ü—‹SŒšgObjeù
("REPLCONF",8);

1198 
¬gv
[1] = 
	`ü—‹SŒšgObjeù
("GETACK",6);

1199 
¬gv
[2] = 
	`ü—‹SŒšgObjeù
("*",1);

1200 
	`»¶iÿtiÚF“dSÏves
(
£rv”
.
¦aves
, s”v”.
¦ave£ldb
, 
¬gv
, 3);

1201 
	`deüRefCouÁ
(
¬gv
[0]);

1202 
	`deüRefCouÁ
(
¬gv
[1]);

1203 
	`deüRefCouÁ
(
¬gv
[2]);

1204 
£rv”
.
g‘_ack_äom_¦aves
 = 0;

1209 ià(
	`li¡L’gth
(
£rv”
.
ş›Ás_wa™šg_acks
))

1210 
	`´oûssCl›ÁsWa™šgR•liÿs
();

1214 
	`moduËHªdËBlockedCl›Ás
();

1217 ià(
	`li¡L’gth
(
£rv”
.
unblocked_ş›Ás
))

1218 
	`´oûssUnblockedCl›Ás
();

1221 
	`æushAµ’dOÆyFe
(0);

1224 
	`hªdËCl›ÁsW™hP’dšgWr™es
();

1229 ià(
	`moduËCouÁ
()è
	`moduËR–—£GIL
();

1230 
	}
}

1235 
	$aá”SË•
(
«Ev’tLoİ
 *
ev’tLoİ
) {

1236 
	`UNUSED
(
ev’tLoİ
);

1237 ià(
	`moduËCouÁ
()è
	`moduËAcquœeGIL
();

1238 
	}
}

1242 
	$ü—‹Sh¬edObjeùs
() {

1243 
j
;

1245 
sh¬ed
.
ülf
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("\r\n"));

1246 
sh¬ed
.
ok
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("+OK\r\n"));

1247 
sh¬ed
.
”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("-ERR\r\n"));

1248 
sh¬ed
.
em±ybulk
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("$0\r\n\r\n"));

1249 
sh¬ed
.
cz”o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(":0\r\n"));

1250 
sh¬ed
.
cÚe
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(":1\r\n"));

1251 
sh¬ed
.
úegÚe
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(":-1\r\n"));

1252 
sh¬ed
.
nuÎbulk
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("$-1\r\n"));

1253 
sh¬ed
.
nuÎmuÉibulk
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("*-1\r\n"));

1254 
sh¬ed
.
em±ymuÉibulk
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("*0\r\n"));

1255 
sh¬ed
.
pÚg
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("+PONG\r\n"));

1256 
sh¬ed
.
queued
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("+QUEUED\r\n"));

1257 
sh¬ed
.
em±ysÿn
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("*2\r\n$1\r\n0\r\n*0\r\n"));

1258 
sh¬ed
.
wrÚgty³”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1260 
sh¬ed
.
nokey”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1262 
sh¬ed
.
syÁax”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1264 
sh¬ed
.
§meobjeù”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1266 
sh¬ed
.
outoäªg“¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1268 
sh¬ed
.
nosü‹¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1270 
sh¬ed
.
lßdšg”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1272 
sh¬ed
.
¦owsü‹¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1274 
sh¬ed
.
ma¡”dowÃ¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1276 
sh¬ed
.
bg§v“¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1278 
sh¬ed
.
ro¦av“¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1280 
sh¬ed
.
nßuth”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1282 
sh¬ed
.
oom”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1284 
sh¬ed
.
exeÿbÜ‹¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1286 
sh¬ed
.
nÜ•liÿ£¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1288 
sh¬ed
.
busykey”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1290 
sh¬ed
.
¥aû
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(" "));

1291 
sh¬ed
.
cŞÚ
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(":"));

1292 
sh¬ed
.
¶us
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("+"));

1294 
j
 = 0; j < 
PROTO_SHARED_SELECT_CMDS
; j++) {

1295 
diùid_¡r
[64];

1296 
diùid_Ën
;

1298 
diùid_Ën
 = 
	`Î2¡ršg
(
diùid_¡r
,(diùid_¡r),
j
);

1299 
sh¬ed
.
£Ëù
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,

1300 
	`sdsÿrštf
(
	`sd£m±y
(),

1302 
diùid_Ën
, 
diùid_¡r
));

1304 
sh¬ed
.
mes§gebulk
 = 
	`ü—‹SŒšgObjeù
("$7\r\nmessage\r\n",13);

1305 
sh¬ed
.
pmes§gebulk
 = 
	`ü—‹SŒšgObjeù
("$8\r\npmessage\r\n",14);

1306 
sh¬ed
.
subsüibebulk
 = 
	`ü—‹SŒšgObjeù
("$9\r\nsubscribe\r\n",15);

1307 
sh¬ed
.
unsubsüibebulk
 = 
	`ü—‹SŒšgObjeù
("$11\r\nunsubscribe\r\n",18);

1308 
sh¬ed
.
psubsüibebulk
 = 
	`ü—‹SŒšgObjeù
("$10\r\npsubscribe\r\n",17);

1309 
sh¬ed
.
punsubsüibebulk
 = 
	`ü—‹SŒšgObjeù
("$12\r\npunsubscribe\r\n",19);

1310 
sh¬ed
.
d–
 = 
	`ü—‹SŒšgObjeù
("DEL",3);

1311 
sh¬ed
.
uÆšk
 = 
	`ü—‹SŒšgObjeù
("UNLINK",6);

1312 
sh¬ed
.
½İ
 = 
	`ü—‹SŒšgObjeù
("RPOP",4);

1313 
sh¬ed
.
Íİ
 = 
	`ü—‹SŒšgObjeù
("LPOP",4);

1314 
sh¬ed
.
Íush
 = 
	`ü—‹SŒšgObjeù
("LPUSH",5);

1315 
j
 = 0; j < 
OBJ_SHARED_INTEGERS
; j++) {

1316 
sh¬ed
.
š‹g”s
[
j
] =

1317 
	`makeObjeùSh¬ed
(
	`ü—‹Objeù
(
OBJ_STRING
,(*)()
j
));

1318 
sh¬ed
.
š‹g”s
[
j
]->
’codšg
 = 
OBJ_ENCODING_INT
;

1320 
j
 = 0; j < 
OBJ_SHARED_BULKHDR_LEN
; j++) {

1321 
sh¬ed
.
mbulkhdr
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,

1322 
	`sdsÿrštf
(
	`sd£m±y
(),"*%d\r\n",
j
));

1323 
sh¬ed
.
bulkhdr
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,

1324 
	`sdsÿrštf
(
	`sd£m±y
(),"$%d\r\n",
j
));

1330 
sh¬ed
.
mš¡ršg
 = 
	`sd¢ew
("minstring");

1331 
sh¬ed
.
max¡ršg
 = 
	`sd¢ew
("maxstring");

1332 
	}
}

1334 
	$š™S”v”CÚfig
() {

1335 
j
;

1337 
	`±h»ad_mu‹x_š™
(&
£rv”
.
Ãxt_ş›Á_id_mu‹x
,
NULL
);

1338 
	`±h»ad_mu‹x_š™
(&
£rv”
.
Ìuşock_mu‹x
,
NULL
);

1339 
	`±h»ad_mu‹x_š™
(&
£rv”
.
unixtime_mu‹x
,
NULL
);

1341 
	`g‘RªdomHexCh¬s
(
£rv”
.
runid
,
CONFIG_RUN_ID_SIZE
);

1342 
£rv”
.
runid
[
CONFIG_RUN_ID_SIZE
] = '\0';

1343 
	`chªgeR•liÿtiÚId
();

1344 
	`ş—rR•liÿtiÚId2
();

1345 
£rv”
.
cÚfigfe
 = 
NULL
;

1346 
£rv”
.
execubË
 = 
NULL
;

1347 
£rv”
.
hz
 = 
CONFIG_DEFAULT_HZ
;

1348 
£rv”
.
¬ch_b™s
 = (() == 8) ? 64 : 32;

1349 
£rv”
.
pÜt
 = 
CONFIG_DEFAULT_SERVER_PORT
;

1350 
£rv”
.
tı_backlog
 = 
CONFIG_DEFAULT_TCP_BACKLOG
;

1351 
£rv”
.
bšdaddr_couÁ
 = 0;

1352 
£rv”
.
unixsock‘
 = 
NULL
;

1353 
£rv”
.
unixsock‘³rm
 = 
CONFIG_DEFAULT_UNIX_SOCKET_PERM
;

1354 
£rv”
.
fd_couÁ
 = 0;

1355 
£rv”
.
sofd
 = -1;

1356 
£rv”
.
´Ùeùed_mode
 = 
CONFIG_DEFAULT_PROTECTED_MODE
;

1357 
£rv”
.
dbnum
 = 
CONFIG_DEFAULT_DBNUM
;

1358 
£rv”
.
v”bos™y
 = 
CONFIG_DEFAULT_VERBOSITY
;

1359 
£rv”
.
maxidËtime
 = 
CONFIG_DEFAULT_CLIENT_TIMEOUT
;

1360 
£rv”
.
tık“·live
 = 
CONFIG_DEFAULT_TCP_KEEPALIVE
;

1361 
£rv”
.
aùive_expœe_’abËd
 = 1;

1362 
£rv”
.
aùive_deäag_’abËd
 = 
CONFIG_DEFAULT_ACTIVE_DEFRAG
;

1363 
£rv”
.
aùive_deäag_ignÜe_by‹s
 = 
CONFIG_DEFAULT_DEFRAG_IGNORE_BYTES
;

1364 
£rv”
.
aùive_deäag_th»shŞd_low”
 = 
CONFIG_DEFAULT_DEFRAG_THRESHOLD_LOWER
;

1365 
£rv”
.
aùive_deäag_th»shŞd_uµ”
 = 
CONFIG_DEFAULT_DEFRAG_THRESHOLD_UPPER
;

1366 
£rv”
.
aùive_deäag_cyşe_mš
 = 
CONFIG_DEFAULT_DEFRAG_CYCLE_MIN
;

1367 
£rv”
.
aùive_deäag_cyşe_max
 = 
CONFIG_DEFAULT_DEFRAG_CYCLE_MAX
;

1368 
£rv”
.
ş›Á_max_qu”ybuf_Ën
 = 
PROTO_MAX_QUERYBUF_LEN
;

1369 
£rv”
.
§v•¬ams
 = 
NULL
;

1370 
£rv”
.
lßdšg
 = 0;

1371 
£rv”
.
logfe
 = 
	`z¡rdup
(
CONFIG_DEFAULT_LOGFILE
);

1372 
£rv”
.
sy¦og_’abËd
 = 
CONFIG_DEFAULT_SYSLOG_ENABLED
;

1373 
£rv”
.
sy¦og_id’t
 = 
	`z¡rdup
(
CONFIG_DEFAULT_SYSLOG_IDENT
);

1374 
£rv”
.
sy¦og_çc™y
 = 
LOG_LOCAL0
;

1375 
£rv”
.
d«mÚize
 = 
CONFIG_DEFAULT_DAEMONIZE
;

1376 
£rv”
.
su³rvi£d
 = 0;

1377 
£rv”
.
su³rvi£d_mode
 = 
SUPERVISED_NONE
;

1378 
£rv”
.
aof_¡©e
 = 
AOF_OFF
;

1379 
£rv”
.
aof_fsync
 = 
CONFIG_DEFAULT_AOF_FSYNC
;

1380 
£rv”
.
aof_no_fsync_Ú_»wr™e
 = 
CONFIG_DEFAULT_AOF_NO_FSYNC_ON_REWRITE
;

1381 
£rv”
.
aof_»wr™e_³rc
 = 
AOF_REWRITE_PERC
;

1382 
£rv”
.
aof_»wr™e_mš_size
 = 
AOF_REWRITE_MIN_SIZE
;

1383 
£rv”
.
aof_»wr™e_ba£_size
 = 0;

1384 
£rv”
.
aof_»wr™e_scheduËd
 = 0;

1385 
£rv”
.
aof_Ï¡_fsync
 = 
	`time
(
NULL
);

1386 
£rv”
.
aof_»wr™e_time_Ï¡
 = -1;

1387 
£rv”
.
aof_»wr™e_time_¡¬t
 = -1;

1388 
£rv”
.
aof_Ï¡bg»wr™e_¡©us
 = 
C_OK
;

1389 
£rv”
.
aof_d–ayed_fsync
 = 0;

1390 
£rv”
.
aof_fd
 = -1;

1391 
£rv”
.
aof_£Ëùed_db
 = -1;

1392 
£rv”
.
aof_æush_po¡pÚed_¡¬t
 = 0;

1393 
£rv”
.
aof_»wr™e_šüem’l_fsync
 = 
CONFIG_DEFAULT_AOF_REWRITE_INCREMENTAL_FSYNC
;

1394 
£rv”
.
aof_lßd_Œunÿ‹d
 = 
CONFIG_DEFAULT_AOF_LOAD_TRUNCATED
;

1395 
£rv”
.
aof_u£_rdb_´—mbË
 = 
CONFIG_DEFAULT_AOF_USE_RDB_PREAMBLE
;

1396 
£rv”
.
pidfe
 = 
NULL
;

1397 
£rv”
.
rdb_f’ame
 = 
	`z¡rdup
(
CONFIG_DEFAULT_RDB_FILENAME
);

1398 
£rv”
.
aof_f’ame
 = 
	`z¡rdup
(
CONFIG_DEFAULT_AOF_FILENAME
);

1399 
£rv”
.
»quœ•ass
 = 
NULL
;

1400 
£rv”
.
rdb_com´essiÚ
 = 
CONFIG_DEFAULT_RDB_COMPRESSION
;

1401 
£rv”
.
rdb_checksum
 = 
CONFIG_DEFAULT_RDB_CHECKSUM
;

1402 
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
 = 
CONFIG_DEFAULT_STOP_WRITES_ON_BGSAVE_ERROR
;

1403 
£rv”
.
aùiv”ehashšg
 = 
CONFIG_DEFAULT_ACTIVE_REHASHING
;

1404 
£rv”
.
aùive_deäag_ruÂšg
 = 0;

1405 
£rv”
.
nÙify_key¥aû_ev’ts
 = 0;

1406 
£rv”
.
maxş›Ás
 = 
CONFIG_DEFAULT_MAX_CLIENTS
;

1407 
£rv”
.
bpİ_blocked_ş›Ás
 = 0;

1408 
£rv”
.
maxmemÜy
 = 
CONFIG_DEFAULT_MAXMEMORY
;

1409 
£rv”
.
maxmemÜy_pŞicy
 = 
CONFIG_DEFAULT_MAXMEMORY_POLICY
;

1410 
£rv”
.
maxmemÜy_§m¶es
 = 
CONFIG_DEFAULT_MAXMEMORY_SAMPLES
;

1411 
£rv”
.
lfu_log_çùÜ
 = 
CONFIG_DEFAULT_LFU_LOG_FACTOR
;

1412 
£rv”
.
lfu_deÿy_time
 = 
CONFIG_DEFAULT_LFU_DECAY_TIME
;

1413 
£rv”
.
hash_max_zli¡_’Œ›s
 = 
OBJ_HASH_MAX_ZIPLIST_ENTRIES
;

1414 
£rv”
.
hash_max_zli¡_v®ue
 = 
OBJ_HASH_MAX_ZIPLIST_VALUE
;

1415 
£rv”
.
li¡_max_zli¡_size
 = 
OBJ_LIST_MAX_ZIPLIST_SIZE
;

1416 
£rv”
.
li¡_com´ess_d•th
 = 
OBJ_LIST_COMPRESS_DEPTH
;

1417 
£rv”
.
£t_max_št£t_’Œ›s
 = 
OBJ_SET_MAX_INTSET_ENTRIES
;

1418 
£rv”
.
z£t_max_zli¡_’Œ›s
 = 
OBJ_ZSET_MAX_ZIPLIST_ENTRIES
;

1419 
£rv”
.
z£t_max_zli¡_v®ue
 = 
OBJ_ZSET_MAX_ZIPLIST_VALUE
;

1420 
£rv”
.
hÎ_¥¬£_max_by‹s
 = 
CONFIG_DEFAULT_HLL_SPARSE_MAX_BYTES
;

1421 
£rv”
.
shutdown_a§p
 = 0;

1422 
£rv”
.
şu¡”_’abËd
 = 0;

1423 
£rv”
.
şu¡”_node_timeout
 = 
CLUSTER_DEFAULT_NODE_TIMEOUT
;

1424 
£rv”
.
şu¡”_mig¿tiÚ_b¬r›r
 = 
CLUSTER_DEFAULT_MIGRATION_BARRIER
;

1425 
£rv”
.
şu¡”_¦ave_v®id™y_çùÜ
 = 
CLUSTER_DEFAULT_SLAVE_VALIDITY
;

1426 
£rv”
.
şu¡”_»quœe_fuÎ_cov”age
 = 
CLUSTER_DEFAULT_REQUIRE_FULL_COVERAGE
;

1427 
£rv”
.
şu¡”_cÚfigfe
 = 
	`z¡rdup
(
CONFIG_DEFAULT_CLUSTER_CONFIG_FILE
);

1428 
£rv”
.
şu¡”_ªnounû_
 = 
CONFIG_DEFAULT_CLUSTER_ANNOUNCE_IP
;

1429 
£rv”
.
şu¡”_ªnounû_pÜt
 = 
CONFIG_DEFAULT_CLUSTER_ANNOUNCE_PORT
;

1430 
£rv”
.
şu¡”_ªnounû_bus_pÜt
 = 
CONFIG_DEFAULT_CLUSTER_ANNOUNCE_BUS_PORT
;

1431 
£rv”
.
mig¿‹_ÿched_sock‘s
 = 
	`diùC»©e
(&
mig¿‹CacheDiùTy³
,
NULL
);

1432 
£rv”
.
Ãxt_ş›Á_id
 = 1;

1433 
£rv”
.
lßdšg_´oûss_ev’ts_š‹rv®_by‹s
 = (1024*1024*2);

1434 
£rv”
.
Ïzyä“_Ïzy_eviùiÚ
 = 
CONFIG_DEFAULT_LAZYFREE_LAZY_EVICTION
;

1435 
£rv”
.
Ïzyä“_Ïzy_expœe
 = 
CONFIG_DEFAULT_LAZYFREE_LAZY_EXPIRE
;

1436 
£rv”
.
Ïzyä“_Ïzy_£rv”_d–
 = 
CONFIG_DEFAULT_LAZYFREE_LAZY_SERVER_DEL
;

1437 
£rv”
.
®ways_show_logo
 = 
CONFIG_DEFAULT_ALWAYS_SHOW_LOGO
;

1438 
£rv”
.
lua_time_lim™
 = 
LUA_SCRIPT_TIME_LIMIT
;

1440 
Ìuşock
 = 
	`g‘LRUClock
();

1441 
	`©omicS‘
(
£rv”
.
Ìuşock
,lruclock);

1442 
	`»£tS”v”SaveP¬ams
();

1444 
	`­³ndS”v”SaveP¬ams
(60*60,1);

1445 
	`­³ndS”v”SaveP¬ams
(300,100);

1446 
	`­³ndS”v”SaveP¬ams
(60,10000);

1449 
£rv”
.
ma¡”auth
 = 
NULL
;

1450 
£rv”
.
ma¡”ho¡
 = 
NULL
;

1451 
£rv”
.
ma¡”pÜt
 = 6379;

1452 
£rv”
.
ma¡”
 = 
NULL
;

1453 
£rv”
.
ÿched_ma¡”
 = 
NULL
;

1454 
£rv”
.
ma¡”_š™Ÿl_off£t
 = -1;

1455 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_NONE
;

1456 
£rv”
.
»¶_syncio_timeout
 = 
CONFIG_REPL_SYNCIO_TIMEOUT
;

1457 
£rv”
.
»¶_£rve_¡®e_d©a
 = 
CONFIG_DEFAULT_SLAVE_SERVE_STALE_DATA
;

1458 
£rv”
.
»¶_¦ave_ro
 = 
CONFIG_DEFAULT_SLAVE_READ_ONLY
;

1459 
£rv”
.
»¶_¦ave_Ïzy_æush
 = 
CONFIG_DEFAULT_SLAVE_LAZY_FLUSH
;

1460 
£rv”
.
»¶_down_sšû
 = 0;

1461 
£rv”
.
»¶_di§bË_tı_nod–ay
 = 
CONFIG_DEFAULT_REPL_DISABLE_TCP_NODELAY
;

1462 
£rv”
.
»¶_diskËss_sync
 = 
CONFIG_DEFAULT_REPL_DISKLESS_SYNC
;

1463 
£rv”
.
»¶_diskËss_sync_d–ay
 = 
CONFIG_DEFAULT_REPL_DISKLESS_SYNC_DELAY
;

1464 
£rv”
.
»¶_pšg_¦ave_³riod
 = 
CONFIG_DEFAULT_REPL_PING_SLAVE_PERIOD
;

1465 
£rv”
.
»¶_timeout
 = 
CONFIG_DEFAULT_REPL_TIMEOUT
;

1466 
£rv”
.
»¶_mš_¦aves_to_wr™e
 = 
CONFIG_DEFAULT_MIN_SLAVES_TO_WRITE
;

1467 
£rv”
.
»¶_mš_¦aves_max_Ïg
 = 
CONFIG_DEFAULT_MIN_SLAVES_MAX_LAG
;

1468 
£rv”
.
¦ave_´iÜ™y
 = 
CONFIG_DEFAULT_SLAVE_PRIORITY
;

1469 
£rv”
.
¦ave_ªnounû_
 = 
CONFIG_DEFAULT_SLAVE_ANNOUNCE_IP
;

1470 
£rv”
.
¦ave_ªnounû_pÜt
 = 
CONFIG_DEFAULT_SLAVE_ANNOUNCE_PORT
;

1471 
£rv”
.
ma¡”_»¶_off£t
 = 0;

1474 
£rv”
.
»¶_backlog
 = 
NULL
;

1475 
£rv”
.
»¶_backlog_size
 = 
CONFIG_DEFAULT_REPL_BACKLOG_SIZE
;

1476 
£rv”
.
»¶_backlog_hi¡Ën
 = 0;

1477 
£rv”
.
»¶_backlog_idx
 = 0;

1478 
£rv”
.
»¶_backlog_off
 = 0;

1479 
£rv”
.
»¶_backlog_time_lim™
 = 
CONFIG_DEFAULT_REPL_BACKLOG_TIME_LIMIT
;

1480 
£rv”
.
»¶_no_¦aves_sšû
 = 
	`time
(
NULL
);

1483 
j
 = 0; j < 
CLIENT_TYPE_OBUF_COUNT
; j++)

1484 
£rv”
.
ş›Á_obuf_lim™s
[
j
] = 
ş›ÁBufãrLim™sDeçuÉs
[j];

1487 
R_Z”o
 = 0.0;

1488 
R_PosInf
 = 1.0/
R_Z”o
;

1489 
R_NegInf
 = -1.0/
R_Z”o
;

1490 
R_Nª
 = 
R_Z”o
/R_Zero;

1495 
£rv”
.
commªds
 = 
	`diùC»©e
(&
commªdTabËDiùTy³
,
NULL
);

1496 
£rv”
.
Üig_commªds
 = 
	`diùC»©e
(&
commªdTabËDiùTy³
,
NULL
);

1497 
	`pİuÏ‹CommªdTabË
();

1498 
£rv”
.
d–Commªd
 = 
	`lookupCommªdByCSŒšg
("del");

1499 
£rv”
.
muÉiCommªd
 = 
	`lookupCommªdByCSŒšg
("multi");

1500 
£rv”
.
ÍushCommªd
 = 
	`lookupCommªdByCSŒšg
("lpush");

1501 
£rv”
.
ÍİCommªd
 = 
	`lookupCommªdByCSŒšg
("lpop");

1502 
£rv”
.
½İCommªd
 = 
	`lookupCommªdByCSŒšg
("rpop");

1503 
£rv”
.
¤emCommªd
 = 
	`lookupCommªdByCSŒšg
("srem");

1504 
£rv”
.
execCommªd
 = 
	`lookupCommªdByCSŒšg
("exec");

1505 
£rv”
.
expœeCommªd
 = 
	`lookupCommªdByCSŒšg
("expire");

1506 
£rv”
.
³xpœeCommªd
 = 
	`lookupCommªdByCSŒšg
("pexpire");

1509 
£rv”
.
¦owlog_log_¦ow”_thª
 = 
CONFIG_DEFAULT_SLOWLOG_LOG_SLOWER_THAN
;

1510 
£rv”
.
¦owlog_max_Ën
 = 
CONFIG_DEFAULT_SLOWLOG_MAX_LEN
;

1513 
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
 = 
CONFIG_DEFAULT_LATENCY_MONITOR_THRESHOLD
;

1516 
£rv”
.
as£¹_çed
 = "<no‡ssertion failed>";

1517 
£rv”
.
as£¹_fe
 = "<no file>";

1518 
£rv”
.
as£¹_lše
 = 0;

1519 
£rv”
.
bug_»pÜt_¡¬t
 = 0;

1520 
£rv”
.
w©chdog_³riod
 = 0;

1521 
	}
}

1523 **
’vœÚ
;

1540 
	$»¡¬tS”v”
(
æags
, 
m¡ime_t
 
d–ay
) {

1541 
j
;

1545 ià(
	`acûss
(
£rv”
.
execubË
,
X_OK
è=ğ-1è 
C_ERR
;

1548 ià(
æags
 & 
RESTART_SERVER_CONFIG_REWRITE
 &&

1549 
£rv”
.
cÚfigfe
 &&

1550 
	`»wr™eCÚfig
(
£rv”
.
cÚfigfe
è=ğ-1è 
C_ERR
;

1553 ià(
æags
 & 
RESTART_SERVER_GRACEFULLY
 &&

1554 
	`´•¬eFÜShutdown
(
SHUTDOWN_NOFLAGS
è!ğ
C_OK
è 
C_ERR
;

1558 
j
 = 3; j < ()
£rv”
.
maxş›Ás
 + 1024; j++) {

1561 ià(
	`fú
(
j
,
F_GETFD
è!ğ-1è
	`şo£
(j);

1565 ià(
d–ay
è
	`u¦“p
(delay*1000);

1566 
	`execve
(
£rv”
.
execubË
,£rv”.
exec_¬gv
,
’vœÚ
);

1569 
	`_ex™
(1);

1571  
C_ERR
;

1572 
	}
}

1582 
	$adju¡O³nFesLim™
() {

1583 
¾im_t
 
maxfes
 = 
£rv”
.
maxş›Ás
+
CONFIG_MIN_RESERVED_FDS
;

1584 
¾im™
 
lim™
;

1586 ià(
	`g‘¾im™
(
RLIMIT_NOFILE
,&
lim™
) == -1) {

1587 
	`£rv”Log
(
LL_WARNING
,"Unableo obtainhe current NOFILE†imit (%s),‡ssuming 1024‡nd settinghe max clients configuration‡ccordingly.",

1588 
	`¡»¼Ü
(
”ºo
));

1589 
£rv”
.
maxş›Ás
 = 1024-
CONFIG_MIN_RESERVED_FDS
;

1591 
¾im_t
 
Şdlim™
 = 
lim™
.
¾im_cur
;

1595 ià(
Şdlim™
 < 
maxfes
) {

1596 
¾im_t
 
be¡lim™
;

1597 
£Œlim™_”rÜ
 = 0;

1601 
be¡lim™
 = 
maxfes
;

1602 
be¡lim™
 > 
Şdlim™
) {

1603 
¾im_t
 
deü_¡•
 = 16;

1605 
lim™
.
¾im_cur
 = 
be¡lim™
;

1606 
lim™
.
¾im_max
 = 
be¡lim™
;

1607 ià(
	`£Œlim™
(
RLIMIT_NOFILE
,&
lim™
) != -1) ;

1608 
£Œlim™_”rÜ
 = 
”ºo
;

1612 ià(
be¡lim™
 < 
deü_¡•
) ;

1613 
be¡lim™
 -ğ
deü_¡•
;

1618 ià(
be¡lim™
 < 
Şdlim™
) bestlimit = oldlimit;

1620 ià(
be¡lim™
 < 
maxfes
) {

1621 
Şd_maxş›Ás
 = 
£rv”
.
maxş›Ás
;

1622 
£rv”
.
maxş›Ás
 = 
be¡lim™
-
CONFIG_MIN_RESERVED_FDS
;

1626 ià(
be¡lim™
 <ğ
CONFIG_MIN_RESERVED_FDS
) {

1627 
	`£rv”Log
(
LL_WARNING
,"Your current 'ulimit -n' "

1631 (è
Şdlim™
,

1632 (è
maxfes
);

1633 
	`ex™
(1);

1635 
	`£rv”Log
(
LL_WARNING
,"You„equested maxclients of %d "

1637 
Şd_maxş›Ás
,

1638 (è
maxfes
);

1639 
	`£rv”Log
(
LL_WARNING
,"Server can't set maximum open files "

1641 (è
maxfes
, 
	`¡»¼Ü
(
£Œlim™_”rÜ
));

1642 
	`£rv”Log
(
LL_WARNING
,"Current maximum open files is %llu. "

1646 (è
be¡lim™
, 
£rv”
.
maxş›Ás
);

1648 
	`£rv”Log
(
LL_NOTICE
,"Increased maximum‚umber of open files "

1650 (è
maxfes
,

1651 (è
Şdlim™
);

1655 
	}
}

1659 
	$checkTıBacklogS‘tšgs
() {

1660 #ifdeà
HAVE_PROC_SOMAXCONN


1661 
FILE
 *
å
 = 
	`fİ’
("/proc/sys/net/core/somaxconn","r");

1662 
buf
[1024];

1663 ià(!
å
) ;

1664 ià(
	`fg‘s
(
buf
,(buf),
å
è!ğ
NULL
) {

1665 
somaxcÚn
 = 
	`©oi
(
buf
);

1666 ià(
somaxcÚn
 > 0 && somaxcÚÀ< 
£rv”
.
tı_backlog
) {

1667 
	`£rv”Log
(
LL_WARNING
,"WARNING: ThTCP backlog s‘tšg oà%d cªnÙ b’fÜûd beÿu£ /´oc/sys/Ãt/cÜe/somaxcÚÀi £ˆtØthlow” v®uoà%d.", 
£rv”
.
tı_backlog
, 
somaxcÚn
);

1670 
	`fşo£
(
å
);

1672 
	}
}

1692 
	$li¡’ToPÜt
(
pÜt
, *
fds
, *
couÁ
) {

1693 
j
;

1697 ià(
£rv”
.
bšdaddr_couÁ
 =ğ0è£rv”.
bšdaddr
[0] = 
NULL
;

1698 
j
 = 0; j < 
£rv”
.
bšdaddr_couÁ
 || j == 0; j++) {

1699 ià(
£rv”
.
bšdaddr
[
j
] =ğ
NULL
) {

1700 
unsuµÜ‹d
 = 0;

1703 
fds
[*
couÁ
] = 
	`ª‘Tı6S”v”
(
£rv”
.
Ã‹¼
,
pÜt
,
NULL
,

1704 
£rv”
.
tı_backlog
);

1705 ià(
fds
[*
couÁ
] !ğ
ANET_ERR
) {

1706 
	`ª‘NÚBlock
(
NULL
,
fds
[*
couÁ
]);

1707 (*
couÁ
)++;

1708 } ià(
”ºo
 =ğ
EAFNOSUPPORT
) {

1709 
unsuµÜ‹d
++;

1710 
	`£rv”Log
(
LL_WARNING
,"Not†isteningo IPv6: unsupproted");

1713 ià(*
couÁ
 =ğ1 || 
unsuµÜ‹d
) {

1715 
fds
[*
couÁ
] = 
	`ª‘TıS”v”
(
£rv”
.
Ã‹¼
,
pÜt
,
NULL
,

1716 
£rv”
.
tı_backlog
);

1717 ià(
fds
[*
couÁ
] !ğ
ANET_ERR
) {

1718 
	`ª‘NÚBlock
(
NULL
,
fds
[*
couÁ
]);

1719 (*
couÁ
)++;

1720 } ià(
”ºo
 =ğ
EAFNOSUPPORT
) {

1721 
unsuµÜ‹d
++;

1722 
	`£rv”Log
(
LL_WARNING
,"Not†isteningo IPv4: unsupproted");

1728 ià(*
couÁ
 + 
unsuµÜ‹d
 == 2) ;

1729 } ià(
	`¡rchr
(
£rv”
.
bšdaddr
[
j
],':')) {

1731 
fds
[*
couÁ
] = 
	`ª‘Tı6S”v”
(
£rv”
.
Ã‹¼
,
pÜt
,£rv”.
bšdaddr
[
j
],

1732 
£rv”
.
tı_backlog
);

1735 
fds
[*
couÁ
] = 
	`ª‘TıS”v”
(
£rv”
.
Ã‹¼
,
pÜt
,£rv”.
bšdaddr
[
j
],

1736 
£rv”
.
tı_backlog
);

1738 ià(
fds
[*
couÁ
] =ğ
ANET_ERR
) {

1739 
	`£rv”Log
(
LL_WARNING
,

1741 
£rv”
.
bšdaddr
[
j
] ? server.bindaddr[j] : "*",

1742 
pÜt
, 
£rv”
.
Ã‹¼
);

1743  
C_ERR
;

1745 
	`ª‘NÚBlock
(
NULL
,
fds
[*
couÁ
]);

1746 (*
couÁ
)++;

1748  
C_OK
;

1749 
	}
}

1754 
	$»£tS”v”Sts
() {

1755 
j
;

1757 
£rv”
.
¡©_numcommªds
 = 0;

1758 
£rv”
.
¡©_numcÚÃùiÚs
 = 0;

1759 
£rv”
.
¡©_expœedkeys
 = 0;

1760 
£rv”
.
¡©_eviùedkeys
 = 0;

1761 
£rv”
.
¡©_key¥aû_mis£s
 = 0;

1762 
£rv”
.
¡©_key¥aû_h™s
 = 0;

1763 
£rv”
.
¡©_aùive_deäag_h™s
 = 0;

1764 
£rv”
.
¡©_aùive_deäag_mis£s
 = 0;

1765 
£rv”
.
¡©_aùive_deäag_key_h™s
 = 0;

1766 
£rv”
.
¡©_aùive_deäag_key_mis£s
 = 0;

1767 
£rv”
.
¡©_fÜk_time
 = 0;

1768 
£rv”
.
¡©_fÜk_¿‹
 = 0;

1769 
£rv”
.
¡©_»jeùed_cÚn
 = 0;

1770 
£rv”
.
¡©_sync_fuÎ
 = 0;

1771 
£rv”
.
¡©_sync_·¹Ÿl_ok
 = 0;

1772 
£rv”
.
¡©_sync_·¹Ÿl_”r
 = 0;

1773 
j
 = 0; j < 
STATS_METRIC_COUNT
; j++) {

1774 
£rv”
.
š¡_m‘ric
[
j
].
idx
 = 0;

1775 
£rv”
.
š¡_m‘ric
[
j
].
Ï¡_§m¶e_time
 = 
	`m¡ime
();

1776 
£rv”
.
š¡_m‘ric
[
j
].
Ï¡_§m¶e_couÁ
 = 0;

1777 
	`mem£t
(
£rv”
.
š¡_m‘ric
[
j
].
§m¶es
,0,

1778 (
£rv”
.
š¡_m‘ric
[
j
].
§m¶es
));

1780 
£rv”
.
¡©_Ãt_šput_by‹s
 = 0;

1781 
£rv”
.
¡©_Ãt_ouut_by‹s
 = 0;

1782 
£rv”
.
aof_d–ayed_fsync
 = 0;

1783 
	}
}

1785 
	$š™S”v”
() {

1786 
j
;

1788 
	`sigÇl
(
SIGHUP
, 
SIG_IGN
);

1789 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

1790 
	`£tupSigÇlHªdËrs
();

1792 ià(
£rv”
.
sy¦og_’abËd
) {

1793 
	`İ’log
(
£rv”
.
sy¦og_id’t
, 
LOG_PID
 | 
LOG_NDELAY
 | 
LOG_NOWAIT
,

1794 
£rv”
.
sy¦og_çc™y
);

1797 
£rv”
.
pid
 = 
	`g‘pid
();

1798 
£rv”
.
cu¼’t_ş›Á
 = 
NULL
;

1799 
£rv”
.
ş›Ás
 = 
	`li¡C»©e
();

1800 
£rv”
.
ş›Ás_to_şo£
 = 
	`li¡C»©e
();

1801 
£rv”
.
¦aves
 = 
	`li¡C»©e
();

1802 
£rv”
.
mÚ™Üs
 = 
	`li¡C»©e
();

1803 
£rv”
.
ş›Ás_³ndšg_wr™e
 = 
	`li¡C»©e
();

1804 
£rv”
.
¦ave£ldb
 = -1;

1805 
£rv”
.
unblocked_ş›Ás
 = 
	`li¡C»©e
();

1806 
£rv”
.
»ady_keys
 = 
	`li¡C»©e
();

1807 
£rv”
.
ş›Ás_wa™šg_acks
 = 
	`li¡C»©e
();

1808 
£rv”
.
g‘_ack_äom_¦aves
 = 0;

1809 
£rv”
.
ş›Ás_·u£d
 = 0;

1810 
£rv”
.
sy¡em_memÜy_size
 = 
	`zm®loc_g‘_memÜy_size
();

1812 
	`ü—‹Sh¬edObjeùs
();

1813 
	`adju¡O³nFesLim™
();

1814 
£rv”
.
–
 = 
	`«C»©eEv’tLoİ
(£rv”.
maxş›Ás
+
CONFIG_FDSET_INCR
);

1815 ià(
£rv”
.
–
 =ğ
NULL
) {

1816 
	`£rv”Log
(
LL_WARNING
,

1818 
	`¡»¼Ü
(
”ºo
));

1819 
	`ex™
(1);

1821 
£rv”
.
db
 = 
	`zm®loc
((
»disDb
)*£rv”.
dbnum
);

1824 ià(
£rv”
.
pÜt
 != 0 &&

1825 
	`li¡’ToPÜt
(
£rv”
.
pÜt
,£rv”.
fd
,&£rv”.
fd_couÁ
è=ğ
C_ERR
)

1826 
	`ex™
(1);

1829 ià(
£rv”
.
unixsock‘
 !ğ
NULL
) {

1830 
	`uÆšk
(
£rv”
.
unixsock‘
);

1831 
£rv”
.
sofd
 = 
	`ª‘UnixS”v”
(£rv”.
Ã‹¼
,£rv”.
unixsock‘
,

1832 
£rv”
.
unixsock‘³rm
, s”v”.
tı_backlog
);

1833 ià(
£rv”
.
sofd
 =ğ
ANET_ERR
) {

1834 
	`£rv”Log
(
LL_WARNING
, "O³nšg Unix sock‘: %s", 
£rv”
.
Ã‹¼
);

1835 
	`ex™
(1);

1837 
	`ª‘NÚBlock
(
NULL
,
£rv”
.
sofd
);

1841 ià(
£rv”
.
fd_couÁ
 =ğ0 && s”v”.
sofd
 < 0) {

1842 
	`£rv”Log
(
LL_WARNING
, "Configuredo‚ot†isten‡nywhere,ƒxiting.");

1843 
	`ex™
(1);

1847 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

1848 
£rv”
.
db
[
j
].
diù
 = 
	`diùC»©e
(&
dbDiùTy³
,
NULL
);

1849 
£rv”
.
db
[
j
].
expœes
 = 
	`diùC»©e
(&
key±rDiùTy³
,
NULL
);

1850 
£rv”
.
db
[
j
].
blockšg_keys
 = 
	`diùC»©e
(&
keyli¡DiùTy³
,
NULL
);

1851 
£rv”
.
db
[
j
].
»ady_keys
 = 
	`diùC»©e
(&
objeùKeyPoš‹rV®ueDiùTy³
,
NULL
);

1852 
£rv”
.
db
[
j
].
w©ched_keys
 = 
	`diùC»©e
(&
keyli¡DiùTy³
,
NULL
);

1853 
£rv”
.
db
[
j
].
id
 = j;

1854 
£rv”
.
db
[
j
].
avg_‰l
 = 0;

1856 
	`eviùiÚPoŞAÎoc
();

1857 
£rv”
.
pubsub_chªÃls
 = 
	`diùC»©e
(&
keyli¡DiùTy³
,
NULL
);

1858 
£rv”
.
pubsub_·‰”ns
 = 
	`li¡C»©e
();

1859 
	`li¡S‘F»eM‘hod
(
£rv”
.
pubsub_·‰”ns
,
ä“PubsubP©‹º
);

1860 
	`li¡S‘M©chM‘hod
(
£rv”
.
pubsub_·‰”ns
,
li¡M©chPubsubP©‹º
);

1861 
£rv”
.
üÚloİs
 = 0;

1862 
£rv”
.
rdb_chd_pid
 = -1;

1863 
£rv”
.
aof_chd_pid
 = -1;

1864 
£rv”
.
rdb_chd_ty³
 = 
RDB_CHILD_TYPE_NONE
;

1865 
£rv”
.
rdb_bg§ve_scheduËd
 = 0;

1866 
£rv”
.
chd_šfo_pe
[0] = -1;

1867 
£rv”
.
chd_šfo_pe
[1] = -1;

1868 
£rv”
.
chd_šfo_d©a
.
magic
 = 0;

1869 
	`aofRewr™eBufãrRe£t
();

1870 
£rv”
.
aof_buf
 = 
	`sd£m±y
();

1871 
£rv”
.
Ï¡§ve
 = 
	`time
(
NULL
);

1872 
£rv”
.
Ï¡bg§ve_Œy
 = 0;

1873 
£rv”
.
rdb_§ve_time_Ï¡
 = -1;

1874 
£rv”
.
rdb_§ve_time_¡¬t
 = -1;

1875 
£rv”
.
dœty
 = 0;

1876 
	`»£tS”v”Sts
();

1878 
£rv”
.
¡©_¡¬‰ime
 = 
	`time
(
NULL
);

1879 
£rv”
.
¡©_³ak_memÜy
 = 0;

1880 
£rv”
.
¡©_rdb_cow_by‹s
 = 0;

1881 
£rv”
.
¡©_aof_cow_by‹s
 = 0;

1882 
£rv”
.
»sid’t_£t_size
 = 0;

1883 
£rv”
.
Ï¡bg§ve_¡©us
 = 
C_OK
;

1884 
£rv”
.
aof_Ï¡_wr™e_¡©us
 = 
C_OK
;

1885 
£rv”
.
aof_Ï¡_wr™e_”ºo
 = 0;

1886 
£rv”
.
»¶_good_¦aves_couÁ
 = 0;

1887 
	`upd©eCachedTime
();

1892 ià(
	`«C»©eTimeEv’t
(
£rv”
.
–
, 1, 
£rv”CrÚ
, 
NULL
, NULLè=ğ
AE_ERR
) {

1893 
	`£rv”Pªic
("Can't createƒvent†oopimers.");

1894 
	`ex™
(1);

1899 
j
 = 0; j < 
£rv”
.
fd_couÁ
; j++) {

1900 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
, s”v”.
fd
[
j
], 
AE_READABLE
,

1901 
acû±TıHªdËr
,
NULL
è=ğ
AE_ERR
)

1903 
	`£rv”Pªic
(

1907 ià(
£rv”
.
sofd
 > 0 && 
	`«C»©eFeEv’t
(£rv”.
–
,£rv”.sofd,
AE_READABLE
,

1908 
acû±UnixHªdËr
,
NULL
è=ğ
AE_ERR
è
	`£rv”Pªic
("Unrecoverableƒrror creating server.sofd fileƒvent.");

1913 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
, s”v”.
moduË_blocked_pe
[0], 
AE_READABLE
,

1914 
moduËBlockedCl›ÁPeR—dabË
,
NULL
è=ğ
AE_ERR
) {

1915 
	`£rv”Pªic
(

1921 ià(
£rv”
.
aof_¡©e
 =ğ
AOF_ON
) {

1922 
£rv”
.
aof_fd
 = 
	`İ’
(£rv”.
aof_f’ame
,

1923 
O_WRONLY
|
O_APPEND
|
O_CREAT
,0644);

1924 ià(
£rv”
.
aof_fd
 == -1) {

1925 
	`£rv”Log
(
LL_WARNING
, "Can't openhe‡ppend-only file: %s",

1926 
	`¡»¼Ü
(
”ºo
));

1927 
	`ex™
(1);

1935 ià(
£rv”
.
¬ch_b™s
 =ğ32 && s”v”.
maxmemÜy
 == 0) {

1936 
	`£rv”Log
(
LL_WARNING
,"Warning: 32 bit instance detected but‚o memory†imit set. Setting 3 GB maxmemory†imit with 'noeviction'…olicy‚ow.");

1937 
£rv”
.
maxmemÜy
 = 3072LL*(1024*1024);

1938 
£rv”
.
maxmemÜy_pŞicy
 = 
MAXMEMORY_NO_EVICTION
;

1941 ià(
£rv”
.
şu¡”_’abËd
è
	`şu¡”In™
();

1942 
	`»¶iÿtiÚSütCacheIn™
();

1943 
	`sütšgIn™
(1);

1944 
	`¦owlogIn™
();

1945 
	`Ï‹ncyMÚ™ÜIn™
();

1946 
	`bioIn™
();

1947 
£rv”
.
š™Ÿl_memÜy_u§ge
 = 
	`zm®loc_u£d_memÜy
();

1948 
	}
}

1952 
	$pİuÏ‹CommªdTabË
() {

1953 
j
;

1954 
numcommªds
 = (
»disCommªdTabË
)/(
»disCommªd
);

1956 
j
 = 0; j < 
numcommªds
; j++) {

1957 
»disCommªd
 *
c
 = 
»disCommªdTabË
+
j
;

1958 *
f
 = 
c
->
sæags
;

1959 
»tv®1
, 
»tv®2
;

1961 *
f
 != '\0') {

1962 *
f
) {

1963 'w': 
c
->
æags
 |ğ
CMD_WRITE
; ;

1964 'r': 
c
->
æags
 |ğ
CMD_READONLY
; ;

1965 'm': 
c
->
æags
 |ğ
CMD_DENYOOM
; ;

1966 'a': 
c
->
æags
 |ğ
CMD_ADMIN
; ;

1967 'p': 
c
->
æags
 |ğ
CMD_PUBSUB
; ;

1968 's': 
c
->
æags
 |ğ
CMD_NOSCRIPT
; ;

1969 'R': 
c
->
æags
 |ğ
CMD_RANDOM
; ;

1970 'S': 
c
->
æags
 |ğ
CMD_SORT_FOR_SCRIPT
; ;

1971 'l': 
c
->
æags
 |ğ
CMD_LOADING
; ;

1972 't': 
c
->
æags
 |ğ
CMD_STALE
; ;

1973 'M': 
c
->
æags
 |ğ
CMD_SKIP_MONITOR
; ;

1974 'k': 
c
->
æags
 |ğ
CMD_ASKING
; ;

1975 'F': 
c
->
æags
 |ğ
CMD_FAST
; ;

1976 : 
	`£rv”Pªic
("Unsupported command flag"); ;

1978 
f
++;

1981 
»tv®1
 = 
	`diùAdd
(
£rv”
.
commªds
, 
	`sd¢ew
(
c
->
Çme
), c);

1984 
»tv®2
 = 
	`diùAdd
(
£rv”
.
Üig_commªds
, 
	`sd¢ew
(
c
->
Çme
), c);

1985 
	`£rv”As£¹
(
»tv®1
 =ğ
DICT_OK
 && 
»tv®2
 == DICT_OK);

1987 
	}
}

1989 
	$»£tCommªdTabËSts
() {

1990 
numcommªds
 = (
»disCommªdTabË
)/(
»disCommªd
);

1991 
j
;

1993 
j
 = 0; j < 
numcommªds
; j++) {

1994 
»disCommªd
 *
c
 = 
»disCommªdTabË
+
j
;

1996 
c
->
miüo£cÚds
 = 0;

1997 
c
->
ÿÎs
 = 0;

1999 
	}
}

2003 
	$»disOpA¼ayIn™
(
»disOpA¼ay
 *
ß
) {

2004 
ß
->
İs
 = 
NULL
;

2005 
ß
->
numİs
 = 0;

2006 
	}
}

2008 
	$»disOpA¼ayAµ’d
(
»disOpA¼ay
 *
ß
, 
»disCommªd
 *
cmd
, 
dbid
,

2009 
robj
 **
¬gv
, 
¬gc
, 
rg‘
)

2011 
»disOp
 *
İ
;

2013 
ß
->
İs
 = 
	`z»®loc
(ß->İs,(
»disOp
)*(ß->
numİs
+1));

2014 
İ
 = 
ß
->
İs
+ß->
numİs
;

2015 
İ
->
cmd
 = cmd;

2016 
İ
->
dbid
 = dbid;

2017 
İ
->
¬gv
 =‡rgv;

2018 
İ
->
¬gc
 =‡rgc;

2019 
İ
->
rg‘
 =arget;

2020 
ß
->
numİs
++;

2021  
ß
->
numİs
;

2022 
	}
}

2024 
	$»disOpA¼ayF»e
(
»disOpA¼ay
 *
ß
) {

2025 
ß
->
numİs
) {

2026 
j
;

2027 
»disOp
 *
İ
;

2029 
ß
->
numİs
--;

2030 
İ
 = 
ß
->
İs
+ß->
numİs
;

2031 
j
 = 0; j < 
İ
->
¬gc
; j++)

2032 
	`deüRefCouÁ
(
İ
->
¬gv
[
j
]);

2033 
	`zä“
(
İ
->
¬gv
);

2035 
	`zä“
(
ß
->
İs
);

2036 
	}
}

2040 
»disCommªd
 *
	$lookupCommªd
(
sds
 
Çme
) {

2041  
	`diùF‘chV®ue
(
£rv”
.
commªds
, 
Çme
);

2042 
	}
}

2044 
»disCommªd
 *
	$lookupCommªdByCSŒšg
(*
s
) {

2045 
»disCommªd
 *
cmd
;

2046 
sds
 
Çme
 = 
	`sd¢ew
(
s
);

2048 
cmd
 = 
	`diùF‘chV®ue
(
£rv”
.
commªds
, 
Çme
);

2049 
	`sdsä“
(
Çme
);

2050  
cmd
;

2051 
	}
}

2060 
»disCommªd
 *
	$lookupCommªdOrOrigš®
(
sds
 
Çme
) {

2061 
»disCommªd
 *
cmd
 = 
	`diùF‘chV®ue
(
£rv”
.
commªds
, 
Çme
);

2063 ià(!
cmd
ècmd = 
	`diùF‘chV®ue
(
£rv”
.
Üig_commªds
,
Çme
);

2064  
cmd
;

2065 
	}
}

2078 
	$´İag©e
(
»disCommªd
 *
cmd
, 
dbid
, 
robj
 **
¬gv
, 
¬gc
,

2079 
æags
)

2081 ià(
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
 && 
æags
 & 
PROPAGATE_AOF
)

2082 
	`ãedAµ’dOÆyFe
(
cmd
,
dbid
,
¬gv
,
¬gc
);

2083 ià(
æags
 & 
PROPAGATE_REPL
)

2084 
	`»¶iÿtiÚF“dSÏves
(
£rv”
.
¦aves
,
dbid
,
¬gv
,
¬gc
);

2085 
	}
}

2099 
	$®soPrİag©e
(
»disCommªd
 *
cmd
, 
dbid
, 
robj
 **
¬gv
, 
¬gc
,

2100 
rg‘
)

2102 
robj
 **
¬gvcİy
;

2103 
j
;

2105 ià(
£rv”
.
lßdšg
) ;

2107 
¬gvcİy
 = 
	`zm®loc
((
robj
*)*
¬gc
);

2108 
j
 = 0; j < 
¬gc
; j++) {

2109 
¬gvcİy
[
j
] = 
¬gv
[j];

2110 
	`šüRefCouÁ
(
¬gv
[
j
]);

2112 
	`»disOpA¼ayAµ’d
(&
£rv”
.
®so_´İag©e
,
cmd
,
dbid
,
¬gvcİy
,
¬gc
,
rg‘
);

2113 
	}
}

2118 
	$fÜûCommªdPrİag©iÚ
(
ş›Á
 *
c
, 
æags
) {

2119 ià(
æags
 & 
PROPAGATE_REPL
è
c
->æag |ğ
CLIENT_FORCE_REPL
;

2120 ià(
æags
 & 
PROPAGATE_AOF
è
c
->æag |ğ
CLIENT_FORCE_AOF
;

2121 
	}
}

2126 
	$´ev’tCommªdPrİag©iÚ
(
ş›Á
 *
c
) {

2127 
c
->
æags
 |ğ
CLIENT_PREVENT_PROP
;

2128 
	}
}

2131 
	$´ev’tCommªdAOF
(
ş›Á
 *
c
) {

2132 
c
->
æags
 |ğ
CLIENT_PREVENT_AOF_PROP
;

2133 
	}
}

2136 
	$´ev’tCommªdR•liÿtiÚ
(
ş›Á
 *
c
) {

2137 
c
->
æags
 |ğ
CLIENT_PREVENT_REPL_PROP
;

2138 
	}
}

2177 
	$ÿÎ
(
ş›Á
 *
c
, 
æags
) {

2178 
dœty
, 
¡¬t
, 
du¿tiÚ
;

2179 
ş›Á_Şd_æags
 = 
c
->
æags
;

2183 ià(
	`li¡L’gth
(
£rv”
.
mÚ™Üs
) &&

2184 !
£rv”
.
lßdšg
 &&

2185 !(
c
->
cmd
->
æags
 & (
CMD_SKIP_MONITOR
|
CMD_ADMIN
)))

2187 
	`»¶iÿtiÚF“dMÚ™Üs
(
c
,
£rv”
.
mÚ™Üs
,c->
db
->
id
,c->
¬gv
,c->
¬gc
);

2192 
c
->
æags
 &ğ~(
CLIENT_FORCE_AOF
|
CLIENT_FORCE_REPL
|
CLIENT_PREVENT_PROP
);

2193 
»disOpA¼ay
 
´ev_®so_´İag©e
 = 
£rv”
.
®so_´İag©e
;

2194 
	`»disOpA¼ayIn™
(&
£rv”
.
®so_´İag©e
);

2197 
dœty
 = 
£rv”
.dirty;

2198 
¡¬t
 = 
	`u¡ime
();

2199 
c
->
cmd
->
	`´oc
(c);

2200 
du¿tiÚ
 = 
	`u¡ime
()-
¡¬t
;

2201 
dœty
 = 
£rv”
.dirty-dirty;

2202 ià(
dœty
 < 0) dirty = 0;

2206 ià(
£rv”
.
lßdšg
 && 
c
->
æags
 & 
CLIENT_LUA
)

2207 
æags
 &ğ~(
CMD_CALL_SLOWLOG
 | 
CMD_CALL_STATS
);

2212 ià(
c
->
æags
 & 
CLIENT_LUA
 && 
£rv”
.
lua_ÿÎ”
) {

2213 ià(
c
->
æags
 & 
CLIENT_FORCE_REPL
)

2214 
£rv”
.
lua_ÿÎ”
->
æags
 |ğ
CLIENT_FORCE_REPL
;

2215 ià(
c
->
æags
 & 
CLIENT_FORCE_AOF
)

2216 
£rv”
.
lua_ÿÎ”
->
æags
 |ğ
CLIENT_FORCE_AOF
;

2221 ià(
æags
 & 
CMD_CALL_SLOWLOG
 && 
c
->
cmd
->
´oc
 !ğ
execCommªd
) {

2222 *
Ï‹ncy_ev’t
 = (
c
->
cmd
->
æags
 & 
CMD_FAST
) ?

2224 
	`Ï‹ncyAddSam¶eIfN“ded
(
Ï‹ncy_ev’t
,
du¿tiÚ
/1000);

2225 
	`¦owlogPushEÁryIfN“ded
(
c
,c->
¬gv
,c->
¬gc
,
du¿tiÚ
);

2227 ià(
æags
 & 
CMD_CALL_STATS
) {

2228 
c
->
Ï¡cmd
->
miüo£cÚds
 +ğ
du¿tiÚ
;

2229 
c
->
Ï¡cmd
->
ÿÎs
++;

2233 ià(
æags
 & 
CMD_CALL_PROPAGATE
 &&

2234 (
c
->
æags
 & 
CLIENT_PREVENT_PROP
) != CLIENT_PREVENT_PROP)

2236 
´İag©e_æags
 = 
PROPAGATE_NONE
;

2240 ià(
dœty
è
´İag©e_æags
 |ğ(
PROPAGATE_AOF
|
PROPAGATE_REPL
);

2244 ià(
c
->
æags
 & 
CLIENT_FORCE_REPL
è
´İag©e_æags
 |ğ
PROPAGATE_REPL
;

2245 ià(
c
->
æags
 & 
CLIENT_FORCE_AOF
è
´İag©e_æags
 |ğ
PROPAGATE_AOF
;

2250 ià(
c
->
æags
 & 
CLIENT_PREVENT_REPL_PROP
 ||

2251 !(
æags
 & 
CMD_CALL_PROPAGATE_REPL
))

2252 
´İag©e_æags
 &ğ~
PROPAGATE_REPL
;

2253 ià(
c
->
æags
 & 
CLIENT_PREVENT_AOF_PROP
 ||

2254 !(
æags
 & 
CMD_CALL_PROPAGATE_AOF
))

2255 
´İag©e_æags
 &ğ~
PROPAGATE_AOF
;

2259 ià(
´İag©e_æags
 !ğ
PROPAGATE_NONE
)

2260 
	`´İag©e
(
c
->
cmd
,c->
db
->
id
,c->
¬gv
,c->
¬gc
,
´İag©e_æags
);

2265 
c
->
æags
 &ğ~(
CLIENT_FORCE_AOF
|
CLIENT_FORCE_REPL
|
CLIENT_PREVENT_PROP
);

2266 
c
->
æags
 |ğ
ş›Á_Şd_æags
 &

2267 (
CLIENT_FORCE_AOF
|
CLIENT_FORCE_REPL
|
CLIENT_PREVENT_PROP
);

2272 ià(
£rv”
.
®so_´İag©e
.
numİs
) {

2273 
j
;

2274 
»disOp
 *
rİ
;

2276 ià(
æags
 & 
CMD_CALL_PROPAGATE
) {

2277 
j
 = 0; j < 
£rv”
.
®so_´İag©e
.
numİs
; j++) {

2278 
rİ
 = &
£rv”
.
®so_´İag©e
.
İs
[
j
];

2279 
rg‘
 = 
rİ
->target;

2281 ià(!(
æags
&
CMD_CALL_PROPAGATE_AOF
)è
rg‘
 &ğ~
PROPAGATE_AOF
;

2282 ià(!(
æags
&
CMD_CALL_PROPAGATE_REPL
)è
rg‘
 &ğ~
PROPAGATE_REPL
;

2283 ià(
rg‘
)

2284 
	`´İag©e
(
rİ
->
cmd
,rİ->
dbid
,rİ->
¬gv
,rİ->
¬gc
,
rg‘
);

2287 
	`»disOpA¼ayF»e
(&
£rv”
.
®so_´İag©e
);

2289 
£rv”
.
®so_´İag©e
 = 
´ev_®so_´İag©e
;

2290 
£rv”
.
¡©_numcommªds
++;

2291 
	}
}

2301 
	$´oûssCommªd
(
ş›Á
 *
c
) {

2306 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[0]->
±r
,"quit")) {

2307 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

2308 
c
->
æags
 |ğ
CLIENT_CLOSE_AFTER_REPLY
;

2309  
C_ERR
;

2314 
c
->
cmd
 = c->
Ï¡cmd
 = 
	`lookupCommªd
(c->
¬gv
[0]->
±r
);

2315 ià(!
c
->
cmd
) {

2316 
	`æagT¿n§ùiÚ
(
c
);

2317 
	`addR•lyE¼ÜFÜm©
(
c
,"unknown command '%s'",

2318 (*)
c
->
¬gv
[0]->
±r
);

2319  
C_OK
;

2320 } ià((
c
->
cmd
->
¬™y
 > 0 && c->cmd->¬™y !ğc->
¬gc
) ||

2321 (
c
->
¬gc
 < -c->
cmd
->
¬™y
)) {

2322 
	`æagT¿n§ùiÚ
(
c
);

2323 
	`addR•lyE¼ÜFÜm©
(
c
,"wrong‚umber of‡rguments for '%s' command",

2324 
c
->
cmd
->
Çme
);

2325  
C_OK
;

2329 ià(
£rv”
.
»quœ•ass
 && !
c
->
auth’tiÿ‹d
 && c->
cmd
->
´oc
 !ğ
authCommªd
)

2331 
	`æagT¿n§ùiÚ
(
c
);

2332 
	`addR•ly
(
c
,
sh¬ed
.
nßuth”r
);

2333  
C_OK
;

2340 ià(
£rv”
.
şu¡”_’abËd
 &&

2341 !(
c
->
æags
 & 
CLIENT_MASTER
) &&

2342 !(
c
->
æags
 & 
CLIENT_LUA
 &&

2343 
£rv”
.
lua_ÿÎ”
->
æags
 & 
CLIENT_MASTER
) &&

2344 !(
c
->
cmd
->
g‘keys_´oc
 =ğ
NULL
 && c->cmd->
fœ¡key
 == 0 &&

2345 
c
->
cmd
->
´oc
 !ğ
execCommªd
))

2347 
hash¦Ù
;

2348 
”rÜ_code
;

2349 
şu¡”Node
 *
n
 = 
	`g‘NodeByQu”y
(
c
,c->
cmd
,c->
¬gv
,c->
¬gc
,

2350 &
hash¦Ù
,&
”rÜ_code
);

2351 ià(
n
 =ğ
NULL
 ||‚ !ğ
£rv”
.
şu¡”
->
my£lf
) {

2352 ià(
c
->
cmd
->
´oc
 =ğ
execCommªd
) {

2353 
	`disÿrdT¿n§ùiÚ
(
c
);

2355 
	`æagT¿n§ùiÚ
(
c
);

2357 
	`şu¡”RedœeùCl›Á
(
c
,
n
,
hash¦Ù
,
”rÜ_code
);

2358  
C_OK
;

2367 ià(
£rv”
.
maxmemÜy
) {

2368 
»tv®
 = 
	`ä“MemÜyIfN“ded
();

2371 ià(
£rv”
.
cu¼’t_ş›Á
 =ğ
NULL
è 
C_ERR
;

2375 ià((
c
->
cmd
->
æags
 & 
CMD_DENYOOM
è&& 
»tv®
 =ğ
C_ERR
) {

2376 
	`æagT¿n§ùiÚ
(
c
);

2377 
	`addR•ly
(
c
, 
sh¬ed
.
oom”r
);

2378  
C_OK
;

2384 ià(((
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
 &&

2385 
£rv”
.
§v•¬am¦’
 > 0 &&

2386 
£rv”
.
Ï¡bg§ve_¡©us
 =ğ
C_ERR
) ||

2387 
£rv”
.
aof_Ï¡_wr™e_¡©us
 =ğ
C_ERR
) &&

2388 
£rv”
.
ma¡”ho¡
 =ğ
NULL
 &&

2389 (
c
->
cmd
->
æags
 & 
CMD_WRITE
 ||

2390 
c
->
cmd
->
´oc
 =ğ
pšgCommªd
))

2392 
	`æagT¿n§ùiÚ
(
c
);

2393 ià(
£rv”
.
aof_Ï¡_wr™e_¡©us
 =ğ
C_OK
)

2394 
	`addR•ly
(
c
, 
sh¬ed
.
bg§v“¼
);

2396 
	`addR•lySds
(
c
,

2397 
	`sdsÿrštf
(
	`sd£m±y
(),

2399 
	`¡»¼Ü
(
£rv”
.
aof_Ï¡_wr™e_”ºo
)));

2400  
C_OK
;

2405 ià(
£rv”
.
ma¡”ho¡
 =ğ
NULL
 &&

2406 
£rv”
.
»¶_mš_¦aves_to_wr™e
 &&

2407 
£rv”
.
»¶_mš_¦aves_max_Ïg
 &&

2408 
c
->
cmd
->
æags
 & 
CMD_WRITE
 &&

2409 
£rv”
.
»¶_good_¦aves_couÁ
 < s”v”.
»¶_mš_¦aves_to_wr™e
)

2411 
	`æagT¿n§ùiÚ
(
c
);

2412 
	`addR•ly
(
c
, 
sh¬ed
.
nÜ•liÿ£¼
);

2413  
C_OK
;

2418 ià(
£rv”
.
ma¡”ho¡
 && s”v”.
»¶_¦ave_ro
 &&

2419 !(
c
->
æags
 & 
CLIENT_MASTER
) &&

2420 
c
->
cmd
->
æags
 & 
CMD_WRITE
)

2422 
	`addR•ly
(
c
, 
sh¬ed
.
ro¦av“¼
);

2423  
C_OK
;

2427 ià(
c
->
æags
 & 
CLIENT_PUBSUB
 &&

2428 
c
->
cmd
->
´oc
 !ğ
pšgCommªd
 &&

2429 
c
->
cmd
->
´oc
 !ğ
subsüibeCommªd
 &&

2430 
c
->
cmd
->
´oc
 !ğ
unsubsüibeCommªd
 &&

2431 
c
->
cmd
->
´oc
 !ğ
psubsüibeCommªd
 &&

2432 
c
->
cmd
->
´oc
 !ğ
punsubsüibeCommªd
) {

2433 
	`addR•lyE¼Ü
(
c
,"only (P)SUBSCRIBE / (P)UNSUBSCRIBE / PING / QUIT‡llowed inhis context");

2434  
C_OK
;

2439 ià(
£rv”
.
ma¡”ho¡
 && s”v”.
»¶_¡©e
 !ğ
REPL_STATE_CONNECTED
 &&

2440 
£rv”
.
»¶_£rve_¡®e_d©a
 == 0 &&

2441 !(
c
->
cmd
->
æags
 & 
CMD_STALE
))

2443 
	`æagT¿n§ùiÚ
(
c
);

2444 
	`addR•ly
(
c
, 
sh¬ed
.
ma¡”dowÃ¼
);

2445  
C_OK
;

2450 ià(
£rv”
.
lßdšg
 && !(
c
->
cmd
->
æags
 & 
CMD_LOADING
)) {

2451 
	`addR•ly
(
c
, 
sh¬ed
.
lßdšg”r
);

2452  
C_OK
;

2456 ià(
£rv”
.
lua_timedout
 &&

2457 
c
->
cmd
->
´oc
 !ğ
authCommªd
 &&

2458 
c
->
cmd
->
´oc
 !ğ
»¶cÚfCommªd
 &&

2459 !(
c
->
cmd
->
´oc
 =ğ
shutdownCommªd
 &&

2460 
c
->
¬gc
 == 2 &&

2461 
	`tŞow”
(((*)
c
->
¬gv
[1]->
±r
)[0]) == 'n') &&

2462 !(
c
->
cmd
->
´oc
 =ğ
sütCommªd
 &&

2463 
c
->
¬gc
 == 2 &&

2464 
	`tŞow”
(((*)
c
->
¬gv
[1]->
±r
)[0]) == 'k'))

2466 
	`æagT¿n§ùiÚ
(
c
);

2467 
	`addR•ly
(
c
, 
sh¬ed
.
¦owsü‹¼
);

2468  
C_OK
;

2472 ià(
c
->
æags
 & 
CLIENT_MULTI
 &&

2473 
c
->
cmd
->
´oc
 !ğ
execCommªd
 && c->cmd->´oø!ğ
disÿrdCommªd
 &&

2474 
c
->
cmd
->
´oc
 !ğ
muÉiCommªd
 && c->cmd->´oø!ğ
w©chCommªd
)

2476 
	`queueMuÉiCommªd
(
c
);

2477 
	`addR•ly
(
c
,
sh¬ed
.
queued
);

2479 
	`ÿÎ
(
c
,
CMD_CALL_FULL
);

2480 
c
->
woff
 = 
£rv”
.
ma¡”_»¶_off£t
;

2481 ià(
	`li¡L’gth
(
£rv”
.
»ady_keys
))

2482 
	`hªdËCl›ÁsBlockedOnLi¡s
();

2484  
C_OK
;

2485 
	}
}

2491 
	$şo£Li¡’šgSock‘s
(
uÆšk_unix_sock‘
) {

2492 
j
;

2494 
j
 = 0; j < 
£rv”
.
fd_couÁ
; j++è
	`şo£
(£rv”.
fd
[j]);

2495 ià(
£rv”
.
sofd
 !ğ-1è
	`şo£
(server.sofd);

2496 ià(
£rv”
.
şu¡”_’abËd
)

2497 
j
 = 0; j < 
£rv”
.
cfd_couÁ
; j++è
	`şo£
(£rv”.
cfd
[j]);

2498 ià(
uÆšk_unix_sock‘
 && 
£rv”
.
unixsock‘
) {

2499 
	`£rv”Log
(
LL_NOTICE
,"Removinghe unix socket file.");

2500 
	`uÆšk
(
£rv”
.
unixsock‘
);

2502 
	}
}

2504 
	$´•¬eFÜShutdown
(
æags
) {

2505 
§ve
 = 
æags
 & 
SHUTDOWN_SAVE
;

2506 
no§ve
 = 
æags
 & 
SHUTDOWN_NOSAVE
;

2508 
	`£rv”Log
(
LL_WARNING
,"User„equested shutdown...");

2511 
	`ldbKlFÜkedSessiÚs
();

2516 ià(
£rv”
.
rdb_chd_pid
 != -1) {

2517 
	`£rv”Log
(
LL_WARNING
,"There is‡ child saving‡n .rdb. Killing it!");

2518 
	`kl
(
£rv”
.
rdb_chd_pid
,
SIGUSR1
);

2519 
	`rdbRemoveTempFe
(
£rv”
.
rdb_chd_pid
);

2522 ià(
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
) {

2525 ià(
£rv”
.
aof_chd_pid
 != -1) {

2528 ià(
£rv”
.
aof_¡©e
 =ğ
AOF_WAIT_REWRITE
) {

2529 
	`£rv”Log
(
LL_WARNING
, "Writing initial AOF, can'tƒxit.");

2530  
C_ERR
;

2532 
	`£rv”Log
(
LL_WARNING
,

2534 
	`kl
(
£rv”
.
aof_chd_pid
,
SIGUSR1
);

2537 
	`£rv”Log
(
LL_NOTICE
,"Calling fsync() onhe AOF file.");

2538 
	`aof_fsync
(
£rv”
.
aof_fd
);

2542 ià((
£rv”
.
§v•¬am¦’
 > 0 && !
no§ve
è|| 
§ve
) {

2543 
	`£rv”Log
(
LL_NOTICE
,"Savinghe final RDB snapshot beforeƒxiting.");

2545 ià(
	`rdbSave
(
£rv”
.
rdb_f’ame
,
NULL
è!ğ
C_OK
) {

2551 
	`£rv”Log
(
LL_WARNING
,"Errorryingo savehe DB, can'tƒxit.");

2552  
C_ERR
;

2557 ià(
£rv”
.
d«mÚize
 || s”v”.
pidfe
) {

2558 
	`£rv”Log
(
LL_NOTICE
,"Removinghe…id file.");

2559 
	`uÆšk
(
£rv”
.
pidfe
);

2564 
	`æushSÏvesOuutBufãrs
();

2567 
	`şo£Li¡’šgSock‘s
(1);

2568 
	`£rv”Log
(
LL_WARNING
,"%s is‚ow„eadyoƒxit, bye bye...",

2569 
£rv”
.
£Áš–_mode
 ? "Sentinel" : "Redis");

2570  
C_OK
;

2571 
	}
}

2584 
	$time_šd•’d’t_¡rcmp
(*
a
, *
b
) {

2585 
buç
[
CONFIG_AUTHPASS_MAX_LEN
], 
bufb
[CONFIG_AUTHPASS_MAX_LEN];

2590 
®’
 = 
	`¡¾’
(
a
);

2591 
bËn
 = 
	`¡¾’
(
b
);

2592 
j
;

2593 
diff
 = 0;

2598 ià(
®’
 > (
buç
è|| 
bËn
 > (
bufb
))  1;

2600 
	`mem£t
(
buç
,0,(bufa));

2601 
	`mem£t
(
bufb
,0,(bufb));

2604 
	`memıy
(
buç
,
a
,
®’
);

2605 
	`memıy
(
bufb
,
b
,
bËn
);

2609 
j
 = 0; j < (
buç
); j++) {

2610 
diff
 |ğ(
buç
[
j
] ^ 
bufb
[j]);

2613 
diff
 |ğ
®’
 ^ 
bËn
;

2614  
diff
;

2615 
	}
}

2617 
	$authCommªd
(
ş›Á
 *
c
) {

2618 ià(!
£rv”
.
»quœ•ass
) {

2619 
	`addR•lyE¼Ü
(
c
,"Client sent AUTH, but‚o…assword is set");

2620 } ià(!
	`time_šd•’d’t_¡rcmp
(
c
->
¬gv
[1]->
±r
, 
£rv”
.
»quœ•ass
)) {

2621 
c
->
auth’tiÿ‹d
 = 1;

2622 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

2624 
c
->
auth’tiÿ‹d
 = 0;

2625 
	`addR•lyE¼Ü
(
c
,"invalid…assword");

2627 
	}
}

2631 
	$pšgCommªd
(
ş›Á
 *
c
) {

2633 ià(
c
->
¬gc
 > 2) {

2634 
	`addR•lyE¼ÜFÜm©
(
c
,"wrong‚umber of‡rguments for '%s' command",

2635 
c
->
cmd
->
Çme
);

2639 ià(
c
->
æags
 & 
CLIENT_PUBSUB
) {

2640 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[2]);

2641 
	`addR•lyBulkCBufãr
(
c
,"pong",4);

2642 ià(
c
->
¬gc
 == 1)

2643 
	`addR•lyBulkCBufãr
(
c
,"",0);

2645 
	`addR•lyBulk
(
c
,c->
¬gv
[1]);

2647 ià(
c
->
¬gc
 == 1)

2648 
	`addR•ly
(
c
,
sh¬ed
.
pÚg
);

2650 
	`addR•lyBulk
(
c
,c->
¬gv
[1]);

2652 
	}
}

2654 
	$echoCommªd
(
ş›Á
 *
c
) {

2655 
	`addR•lyBulk
(
c
,c->
¬gv
[1]);

2656 
	}
}

2658 
	$timeCommªd
(
ş›Á
 *
c
) {

2659 
timev®
 
tv
;

2663 
	`g‘timeofday
(&
tv
,
NULL
);

2664 
	`addR•lyMuÉiBulkL’
(
c
,2);

2665 
	`addR•lyBulkLÚgLÚg
(
c
,
tv
.
tv_£c
);

2666 
	`addR•lyBulkLÚgLÚg
(
c
,
tv
.
tv_u£c
);

2667 
	}
}

2670 
	$addR•lyCommªdFÏg
(
ş›Á
 *
c
, 
»disCommªd
 *
cmd
, 
f
, *
»¶y
) {

2671 ià(
cmd
->
æags
 & 
f
) {

2672 
	`addR•lyStus
(
c
, 
»¶y
);

2676 
	}
}

2679 
	$addR•lyCommªd
(
ş›Á
 *
c
, 
»disCommªd
 *
cmd
) {

2680 ià(!
cmd
) {

2681 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

2684 
	`addR•lyMuÉiBulkL’
(
c
, 6);

2685 
	`addR•lyBulkCSŒšg
(
c
, 
cmd
->
Çme
);

2686 
	`addR•lyLÚgLÚg
(
c
, 
cmd
->
¬™y
);

2688 
æagcouÁ
 = 0;

2689 *
æagËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2690 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_WRITE
, "write");

2691 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_READONLY
, "readonly");

2692 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_DENYOOM
, "denyoom");

2693 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_ADMIN
, "admin");

2694 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_PUBSUB
, "pubsub");

2695 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_NOSCRIPT
, "noscript");

2696 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_RANDOM
, "random");

2697 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_SORT_FOR_SCRIPT
,"sort_for_script");

2698 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_LOADING
, "loading");

2699 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_STALE
, "stale");

2700 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_SKIP_MONITOR
, "skip_monitor");

2701 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_ASKING
, "asking");

2702 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_FAST
, "fast");

2703 ià((
cmd
->
g‘keys_´oc
 && !(cmd->
æags
 & 
CMD_MODULE
)) ||

2704 
cmd
->
æags
 & 
CMD_MODULE_GETKEYS
)

2706 
	`addR•lyStus
(
c
, "movablekeys");

2707 
æagcouÁ
 += 1;

2709 
	`£tDeã¼edMuÉiBulkL’gth
(
c
, 
æagËn
, 
æagcouÁ
);

2711 
	`addR•lyLÚgLÚg
(
c
, 
cmd
->
fœ¡key
);

2712 
	`addR•lyLÚgLÚg
(
c
, 
cmd
->
Ï¡key
);

2713 
	`addR•lyLÚgLÚg
(
c
, 
cmd
->
key¡•
);

2715 
	}
}

2718 
	$commªdCommªd
(
ş›Á
 *
c
) {

2719 
diùI‹¿tÜ
 *
di
;

2720 
diùEÁry
 *
de
;

2722 ià(
c
->
¬gc
 == 1) {

2723 
	`addR•lyMuÉiBulkL’
(
c
, 
	`diùSize
(
£rv”
.
commªds
));

2724 
di
 = 
	`diùG‘I‹¿tÜ
(
£rv”
.
commªds
);

2725 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2726 
	`addR•lyCommªd
(
c
, 
	`diùG‘V®
(
de
));

2728 
	`diùR–—£I‹¿tÜ
(
di
);

2729 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
, "info")) {

2730 
i
;

2731 
	`addR•lyMuÉiBulkL’
(
c
, c->
¬gc
-2);

2732 
i
 = 2; i < 
c
->
¬gc
; i++) {

2733 
	`addR•lyCommªd
(
c
, 
	`diùF‘chV®ue
(
£rv”
.
commªds
, c->
¬gv
[
i
]->
±r
));

2735 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
, "couÁ"è&& c->
¬gc
 == 2) {

2736 
	`addR•lyLÚgLÚg
(
c
, 
	`diùSize
(
£rv”
.
commªds
));

2737 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"g‘keys"è&& c->
¬gc
 >= 3) {

2738 
»disCommªd
 *
cmd
 = 
	`lookupCommªd
(
c
->
¬gv
[2]->
±r
);

2739 *
keys
, 
numkeys
, 
j
;

2741 ià(!
cmd
) {

2742 
	`addR•lyE¼ÜFÜm©
(
c
,"Invalid command specified");

2744 } ià((
cmd
->
¬™y
 > 0 && cmd->¬™y !ğ
c
->
¬gc
-2) ||

2745 ((
c
->
¬gc
-2è< -
cmd
->
¬™y
))

2747 
	`addR•lyE¼Ü
(
c
,"Invalid‚umber of‡rguments specified for command");

2751 
keys
 = 
	`g‘KeysFromCommªd
(
cmd
,
c
->
¬gv
+2,c->
¬gc
-2,&
numkeys
);

2752 
	`addR•lyMuÉiBulkL’
(
c
,
numkeys
);

2753 
j
 = 0; j < 
numkeys
; j++è
	`addR•lyBulk
(
c
,c->
¬gv
[
keys
[j]+2]);

2754 
	`g‘KeysF»eResuÉ
(
keys
);

2756 
	`addR•lyE¼Ü
(
c
, "Unknown subcommand or wrong‚umber of‡rguments.");

2759 
	}
}

2763 
	$by‹sToHumª
(*
s
, 
n
) {

2764 
d
;

2766 ià(
n
 < 1024) {

2768 
	`¥rštf
(
s
,"%ÎuB",
n
);

2770 } ià(
n
 < (1024*1024)) {

2771 
d
 = ()
n
/(1024);

2772 
	`¥rštf
(
s
,"%.2fK",
d
);

2773 } ià(
n
 < (1024LL*1024*1024)) {

2774 
d
 = ()
n
/(1024*1024);

2775 
	`¥rštf
(
s
,"%.2fM",
d
);

2776 } ià(
n
 < (1024LL*1024*1024*1024)) {

2777 
d
 = ()
n
/(1024LL*1024*1024);

2778 
	`¥rštf
(
s
,"%.2fG",
d
);

2779 } ià(
n
 < (1024LL*1024*1024*1024*1024)) {

2780 
d
 = ()
n
/(1024LL*1024*1024*1024);

2781 
	`¥rštf
(
s
,"%.2fT",
d
);

2782 } ià(
n
 < (1024LL*1024*1024*1024*1024*1024)) {

2783 
d
 = ()
n
/(1024LL*1024*1024*1024*1024);

2784 
	`¥rštf
(
s
,"%.2fP",
d
);

2787 
	`¥rštf
(
s
,"%ÎuB",
n
);

2789 
	}
}

2794 
sds
 
	$g’RedisInfoSŒšg
(*
£ùiÚ
) {

2795 
sds
 
šfo
 = 
	`sd£m±y
();

2796 
time_t
 
u±ime
 = 
£rv”
.
unixtime
-£rv”.
¡©_¡¬‰ime
;

2797 
j
, 
numcommªds
;

2798 
ru§ge
 
£lf_ru
, 
c_ru
;

2799 
lŞ
, 
bib
;

2800 
®l£ùiÚs
 = 0, 
def£ùiÚs
 = 0;

2801 
£ùiÚs
 = 0;

2803 ià(
£ùiÚ
 =ğ
NULL
) section = "default";

2804 
®l£ùiÚs
 = 
	`¡rÿ£cmp
(
£ùiÚ
,"all") == 0;

2805 
def£ùiÚs
 = 
	`¡rÿ£cmp
(
£ùiÚ
,"default") == 0;

2807 
	`g‘ru§ge
(
RUSAGE_SELF
, &
£lf_ru
);

2808 
	`g‘ru§ge
(
RUSAGE_CHILDREN
, &
c_ru
);

2809 
	`g‘Cl›ÁsMaxBufãrs
(&
lŞ
,&
bib
);

2812 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"server")) {

2813 
ÿÎ_uÇme
 = 1;

2814 
ut¢ame
 
Çme
;

2815 *
mode
;

2817 ià(
£rv”
.
şu¡”_’abËd
è
mode
 = "cluster";

2818 ià(
£rv”
.
£Áš–_mode
è
mode
 = "sentinel";

2819 
mode
 = "standalone";

2821 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

2823 ià(
ÿÎ_uÇme
) {

2825 
	`uÇme
(&
Çme
);

2826 
ÿÎ_uÇme
 = 0;

2829 
Ìuşock
;

2830 
	`©omicG‘
(
£rv”
.
Ìuşock
,lruclock);

2831 
šfo
 = 
	`sdsÿrštf
(info,

2852 
REDIS_VERSION
,

2853 
	`»disG™SHA1
(),

2854 
	`¡¹Ş
(
	`»disG™Dœty
(),
NULL
,10) > 0,

2855 (è
	`»disBudId
(),

2856 
mode
,

2857 
Çme
.
sy¢ame
,‚ame.
»Ëa£
,‚ame.
machše
,

2858 
£rv”
.
¬ch_b™s
,

2859 
	`«G‘ApiName
(),

2860 
REDIS_ATOMIC_API
,

2861 #ifdeà
__GNUC__


2862 
__GNUC__
,
__GNUC_MINOR__
,
__GNUC_PATCHLEVEL__
,

2866 (è
	`g‘pid
(),

2867 
£rv”
.
runid
,

2868 
£rv”
.
pÜt
,

2869 (
štmax_t
)
u±ime
,

2870 (
štmax_t
)(
u±ime
/(3600*24)),

2871 
£rv”
.
hz
,

2872 (è
Ìuşock
,

2873 
£rv”
.
execubË
 ? server.executable : "",

2874 
£rv”
.
cÚfigfe
 ? server.configfile : "");

2878 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"clients")) {

2879 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

2880 
šfo
 = 
	`sdsÿrštf
(info,

2886 
	`li¡L’gth
(
£rv”
.
ş›Ás
)-li¡L’gth(£rv”.
¦aves
),

2887 
lŞ
, 
bib
,

2888 
£rv”
.
bpİ_blocked_ş›Ás
);

2892 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"memory")) {

2893 
hmem
[64];

2894 
³ak_hmem
[64];

2895 
tÙ®_sy¡em_hmem
[64];

2896 
u£d_memÜy_lua_hmem
[64];

2897 
u£d_memÜy_rss_hmem
[64];

2898 
maxmemÜy_hmem
[64];

2899 
size_t
 
zm®loc_u£d
 = 
	`zm®loc_u£d_memÜy
();

2900 
size_t
 
tÙ®_sy¡em_mem
 = 
£rv”
.
sy¡em_memÜy_size
;

2901 cÚ¡ *
eviù_pŞicy
 = 
	`eviùPŞicyToSŒšg
();

2902 
memÜy_lua
 = ()
	`lua_gc
(
£rv”
.
lua
,
LUA_GCCOUNT
,0)*1024;

2903 
»disMemOv”h—d
 *
mh
 = 
	`g‘MemÜyOv”h—dD©a
();

2909 ià(
zm®loc_u£d
 > 
£rv”
.
¡©_³ak_memÜy
)

2910 
£rv”
.
¡©_³ak_memÜy
 = 
zm®loc_u£d
;

2912 
	`by‹sToHumª
(
hmem
,
zm®loc_u£d
);

2913 
	`by‹sToHumª
(
³ak_hmem
,
£rv”
.
¡©_³ak_memÜy
);

2914 
	`by‹sToHumª
(
tÙ®_sy¡em_hmem
,
tÙ®_sy¡em_mem
);

2915 
	`by‹sToHumª
(
u£d_memÜy_lua_hmem
,
memÜy_lua
);

2916 
	`by‹sToHumª
(
u£d_memÜy_rss_hmem
,
£rv”
.
»sid’t_£t_size
);

2917 
	`by‹sToHumª
(
maxmemÜy_hmem
,
£rv”
.
maxmemÜy
);

2919 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

2920 
šfo
 = 
	`sdsÿrštf
(info,

2944 
zm®loc_u£d
,

2945 
hmem
,

2946 
£rv”
.
»sid’t_£t_size
,

2947 
u£d_memÜy_rss_hmem
,

2948 
£rv”
.
¡©_³ak_memÜy
,

2949 
³ak_hmem
,

2950 
mh
->
³ak_³rc
,

2951 
mh
->
ov”h—d_tÙ®
,

2952 
mh
->
¡¬tup_®loÿ‹d
,

2953 
mh
->
d©a£t
,

2954 
mh
->
d©a£t_³rc
,

2955 ()
tÙ®_sy¡em_mem
,

2956 
tÙ®_sy¡em_hmem
,

2957 
memÜy_lua
,

2958 
u£d_memÜy_lua_hmem
,

2959 
£rv”
.
maxmemÜy
,

2960 
maxmemÜy_hmem
,

2961 
eviù_pŞicy
,

2962 
mh
->
äagm’tiÚ
,

2963 
ZMALLOC_LIB
,

2964 
£rv”
.
aùive_deäag_ruÂšg
,

2965 
	`Ïzyä“G‘P’dšgObjeùsCouÁ
()

2967 
	`ä“MemÜyOv”h—dD©a
(
mh
);

2971 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"persistence")) {

2972 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

2973 
šfo
 = 
	`sdsÿrštf
(info,

2991 
£rv”
.
lßdšg
,

2992 
£rv”
.
dœty
,

2993 
£rv”
.
rdb_chd_pid
 != -1,

2994 (
štmax_t
)
£rv”
.
Ï¡§ve
,

2995 (
£rv”
.
Ï¡bg§ve_¡©us
 =ğ
C_OK
) ? "ok" : "err",

2996 (
štmax_t
)
£rv”
.
rdb_§ve_time_Ï¡
,

2997 (
štmax_t
)((
£rv”
.
rdb_chd_pid
 == -1) ?

2998 -1 : 
	`time
(
NULL
)-
£rv”
.
rdb_§ve_time_¡¬t
),

2999 
£rv”
.
¡©_rdb_cow_by‹s
,

3000 
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
,

3001 
£rv”
.
aof_chd_pid
 != -1,

3002 
£rv”
.
aof_»wr™e_scheduËd
,

3003 (
štmax_t
)
£rv”
.
aof_»wr™e_time_Ï¡
,

3004 (
štmax_t
)((
£rv”
.
aof_chd_pid
 == -1) ?

3005 -1 : 
	`time
(
NULL
)-
£rv”
.
aof_»wr™e_time_¡¬t
),

3006 (
£rv”
.
aof_Ï¡bg»wr™e_¡©us
 =ğ
C_OK
) ? "ok" : "err",

3007 (
£rv”
.
aof_Ï¡_wr™e_¡©us
 =ğ
C_OK
) ? "ok" : "err",

3008 
£rv”
.
¡©_aof_cow_by‹s
);

3010 ià(
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
) {

3011 
šfo
 = 
	`sdsÿrštf
(info,

3019 (è
£rv”
.
aof_cu¼’t_size
,

3020 (è
£rv”
.
aof_»wr™e_ba£_size
,

3021 
£rv”
.
aof_»wr™e_scheduËd
,

3022 
	`sd¦’
(
£rv”
.
aof_buf
),

3023 
	`aofRewr™eBufãrSize
(),

3024 
	`bioP’dšgJobsOfTy³
(
BIO_AOF_FSYNC
),

3025 
£rv”
.
aof_d–ayed_fsync
);

3028 ià(
£rv”
.
lßdšg
) {

3029 
³rc
;

3030 
time_t
 
‘a
, 
–­£d
;

3031 
off_t
 
»maššg_by‹s
 = 
£rv”
.
lßdšg_tÙ®_by‹s
-

3032 
£rv”
.
lßdšg_lßded_by‹s
;

3034 
³rc
 = (()
£rv”
.
lßdšg_lßded_by‹s
 /

3035 (
£rv”
.
lßdšg_tÙ®_by‹s
+1)) * 100;

3037 
–­£d
 = 
	`time
(
NULL
)-
£rv”
.
lßdšg_¡¬t_time
;

3038 ià(
–­£d
 == 0) {

3039 
‘a
 = 1;

3042 
‘a
 = (
–­£d
*
»maššg_by‹s
)/(
£rv”
.
lßdšg_lßded_by‹s
+1);

3045 
šfo
 = 
	`sdsÿrštf
(info,

3051 (
štmax_t
è
£rv”
.
lßdšg_¡¬t_time
,

3052 (è
£rv”
.
lßdšg_tÙ®_by‹s
,

3053 (è
£rv”
.
lßdšg_lßded_by‹s
,

3054 
³rc
,

3055 (
štmax_t
)
‘a


3061 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"stats")) {

3062 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

3063 
šfo
 = 
	`sdsÿrštf
(info,

3089 
£rv”
.
¡©_numcÚÃùiÚs
,

3090 
£rv”
.
¡©_numcommªds
,

3091 
	`g‘In¡ªÃousM‘ric
(
STATS_METRIC_COMMAND
),

3092 
£rv”
.
¡©_Ãt_šput_by‹s
,

3093 
£rv”
.
¡©_Ãt_ouut_by‹s
,

3094 ()
	`g‘In¡ªÃousM‘ric
(
STATS_METRIC_NET_INPUT
)/1024,

3095 ()
	`g‘In¡ªÃousM‘ric
(
STATS_METRIC_NET_OUTPUT
)/1024,

3096 
£rv”
.
¡©_»jeùed_cÚn
,

3097 
£rv”
.
¡©_sync_fuÎ
,

3098 
£rv”
.
¡©_sync_·¹Ÿl_ok
,

3099 
£rv”
.
¡©_sync_·¹Ÿl_”r
,

3100 
£rv”
.
¡©_expœedkeys
,

3101 
£rv”
.
¡©_eviùedkeys
,

3102 
£rv”
.
¡©_key¥aû_h™s
,

3103 
£rv”
.
¡©_key¥aû_mis£s
,

3104 
	`diùSize
(
£rv”
.
pubsub_chªÃls
),

3105 
	`li¡L’gth
(
£rv”
.
pubsub_·‰”ns
),

3106 
£rv”
.
¡©_fÜk_time
,

3107 
	`diùSize
(
£rv”
.
mig¿‹_ÿched_sock‘s
),

3108 
	`g‘SÏveKeyW™hExpœeCouÁ
(),

3109 
£rv”
.
¡©_aùive_deäag_h™s
,

3110 
£rv”
.
¡©_aùive_deäag_mis£s
,

3111 
£rv”
.
¡©_aùive_deäag_key_h™s
,

3112 
£rv”
.
¡©_aùive_deäag_key_mis£s
);

3116 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"replication")) {

3117 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

3118 
šfo
 = 
	`sdsÿrštf
(info,

3121 
£rv”
.
ma¡”ho¡
 =ğ
NULL
 ? "master" : "slave");

3122 ià(
£rv”
.
ma¡”ho¡
) {

3123 
¦ave_»¶_off£t
 = 1;

3125 ià(
£rv”
.
ma¡”
)

3126 
¦ave_»¶_off£t
 = 
£rv”
.
ma¡”
->
»¶off
;

3127 ià(
£rv”
.
ÿched_ma¡”
)

3128 
¦ave_»¶_off£t
 = 
£rv”
.
ÿched_ma¡”
->
»¶off
;

3130 
šfo
 = 
	`sdsÿrštf
(info,

3137 ,
£rv”
.
ma¡”ho¡
,

3138 
£rv”
.
ma¡”pÜt
,

3139 (
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_CONNECTED
) ?

3141 
£rv”
.
ma¡”
 ?

3142 (()(
£rv”
.
unixtime
-£rv”.
ma¡”
->
Ï¡š‹¿ùiÚ
)) : -1,

3143 
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_TRANSFER
,

3144 
¦ave_»¶_off£t


3147 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_TRANSFER
) {

3148 
šfo
 = 
	`sdsÿrštf
(info,

3152 (
£rv”
.
»¶_Œªsãr_size
 - s”v”.
»¶_Œªsãr_»ad
),

3153 ()(
£rv”
.
unixtime
-£rv”.
»¶_Œªsãr_Ï¡io
)

3157 ià(
£rv”
.
»¶_¡©e
 !ğ
REPL_STATE_CONNECTED
) {

3158 
šfo
 = 
	`sdsÿrštf
(info,

3160 (
štmax_t
)
£rv”
.
unixtime
-£rv”.
»¶_down_sšû
);

3162 
šfo
 = 
	`sdsÿrštf
(info,

3165 
£rv”
.
¦ave_´iÜ™y
,

3166 
£rv”
.
»¶_¦ave_ro
);

3169 
šfo
 = 
	`sdsÿrštf
(info,

3171 
	`li¡L’gth
(
£rv”
.
¦aves
));

3175 ià(
£rv”
.
»¶_mš_¦aves_to_wr™e
 &&

3176 
£rv”
.
»¶_mš_¦aves_max_Ïg
) {

3177 
šfo
 = 
	`sdsÿrštf
(info,

3179 
£rv”
.
»¶_good_¦aves_couÁ
);

3182 ià(
	`li¡L’gth
(
£rv”
.
¦aves
)) {

3183 
¦aveid
 = 0;

3184 
li¡Node
 *
Ê
;

3185 
li¡I‹r
 
li
;

3187 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

3188 (
Ê
 = 
	`li¡Next
(&
li
))) {

3189 
ş›Á
 *
¦ave
 = 
	`li¡NodeV®ue
(
Ê
);

3190 *
¡©e
 = 
NULL
;

3191 

[
NET_IP_STR_LEN
], *
¦ave
 = 
¦ave
->
¦ave_
;

3192 
pÜt
;

3193 
Ïg
 = 0;

3195 ià(
¦ave
[0] == '\0') {

3196 ià(
	`ª‘P“rToSŒšg
(
¦ave
->
fd
,

,(),&
pÜt
) == -1)

3198 
¦ave
 = 

;

3200 
¦ave
->
»¶¡©e
) {

3201 
SLAVE_STATE_WAIT_BGSAVE_START
:

3202 
SLAVE_STATE_WAIT_BGSAVE_END
:

3203 
¡©e
 = "wait_bgsave";

3205 
SLAVE_STATE_SEND_BULK
:

3206 
¡©e
 = "send_bulk";

3208 
SLAVE_STATE_ONLINE
:

3209 
¡©e
 = "online";

3212 ià(
¡©e
 =ğ
NULL
) ;

3213 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_ONLINE
)

3214 
Ïg
 = 
	`time
(
NULL
è- 
¦ave
->
»¶_ack_time
;

3216 
šfo
 = 
	`sdsÿrštf
(info,

3219 
¦aveid
,
¦ave
,
¦ave
->
¦ave_li¡’šg_pÜt
,
¡©e
,

3220 
¦ave
->
»¶_ack_off
, 
Ïg
);

3221 
¦aveid
++;

3224 
šfo
 = 
	`sdsÿrštf
(info,

3233 
£rv”
.
»¶id
,

3234 
£rv”
.
»¶id2
,

3235 
£rv”
.
ma¡”_»¶_off£t
,

3236 
£rv”
.
£cÚd_»¶id_off£t
,

3237 
£rv”
.
»¶_backlog
 !ğ
NULL
,

3238 
£rv”
.
»¶_backlog_size
,

3239 
£rv”
.
»¶_backlog_off
,

3240 
£rv”
.
»¶_backlog_hi¡Ën
);

3244 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"cpu")) {

3245 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

3246 
šfo
 = 
	`sdsÿrštf
(info,

3252 ()
£lf_ru
.
ru_¡ime
.
tv_£c
+()£lf_ru.ru_¡ime.
tv_u£c
/1000000,

3253 ()
£lf_ru
.
ru_utime
.
tv_£c
+()£lf_ru.ru_utime.
tv_u£c
/1000000,

3254 ()
c_ru
.
ru_¡ime
.
tv_£c
+()c_ru.ru_¡ime.
tv_u£c
/1000000,

3255 ()
c_ru
.
ru_utime
.
tv_£c
+()c_ru.ru_utime.
tv_u£c
/1000000);

3259 ià(
®l£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"commandstats")) {

3260 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

3261 
šfo
 = 
	`sdsÿrštf
(info, "# Commandstats\r\n");

3262 
numcommªds
 = (
»disCommªdTabË
)/(
»disCommªd
);

3263 
j
 = 0; j < 
numcommªds
; j++) {

3264 
»disCommªd
 *
c
 = 
»disCommªdTabË
+
j
;

3266 ià(!
c
->
ÿÎs
) ;

3267 
šfo
 = 
	`sdsÿrštf
(info,

3269 
c
->
Çme
, c->
ÿÎs
, c->
miüo£cÚds
,

3270 (
c
->
ÿÎs
 =ğ0è? 0 : (()c->
miüo£cÚds
/c->calls));

3275 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"cluster")) {

3276 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

3277 
šfo
 = 
	`sdsÿrštf
(info,

3280 
£rv”
.
şu¡”_’abËd
);

3284 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"keyspace")) {

3285 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

3286 
šfo
 = 
	`sdsÿrštf
(info, "# Keyspace\r\n");

3287 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

3288 
keys
, 
vkeys
;

3290 
keys
 = 
	`diùSize
(
£rv”
.
db
[
j
].
diù
);

3291 
vkeys
 = 
	`diùSize
(
£rv”
.
db
[
j
].
expœes
);

3292 ià(
keys
 || 
vkeys
) {

3293 
šfo
 = 
	`sdsÿrštf
(info,

3295 
j
, 
keys
, 
vkeys
, 
£rv”
.
db
[j].
avg_‰l
);

3299  
šfo
;

3300 
	}
}

3302 
	$šfoCommªd
(
ş›Á
 *
c
) {

3303 *
£ùiÚ
 = 
c
->
¬gc
 =ğ2 ? c->
¬gv
[1]->
±r
 : "default";

3305 ià(
c
->
¬gc
 > 2) {

3306 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

3309 
	`addR•lyBulkSds
(
c
, 
	`g’RedisInfoSŒšg
(
£ùiÚ
));

3310 
	}
}

3312 
	$mÚ™ÜCommªd
(
ş›Á
 *
c
) {

3314 ià(
c
->
æags
 & 
CLIENT_SLAVE
) ;

3316 
c
->
æags
 |ğ(
CLIENT_SLAVE
|
CLIENT_MONITOR
);

3317 
	`li¡AddNodeTa
(
£rv”
.
mÚ™Üs
,
c
);

3318 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

3319 
	}
}

3323 #ifdeà
__lšux__


3324 
	$lšuxOv”comm™MemÜyV®ue
() {

3325 
FILE
 *
å
 = 
	`fİ’
("/proc/sys/vm/overcommit_memory","r");

3326 
buf
[64];

3328 ià(!
å
)  -1;

3329 ià(
	`fg‘s
(
buf
,64,
å
è=ğ
NULL
) {

3330 
	`fşo£
(
å
);

3333 
	`fşo£
(
å
);

3335  
	`©oi
(
buf
);

3336 
	}
}

3338 
	$lšuxMemÜyW¬nšgs
() {

3339 ià(
	`lšuxOv”comm™MemÜyV®ue
() == 0) {

3340 
	`£rv”Log
(
LL_WARNING
,"WARNING overcommit_memory is seto 0! Background save may fail under†ow memory condition. To fixhis issue‡dd 'vm.overcommit_memory = 1'o /etc/sysctl.conf‡ndhen„eboot or„unhe command 'sysctl vm.overcommit_memory=1' forhisoakeƒffect.");

3342 ià(
	`THPIsEÇbËd
()) {

3343 
	`£rv”Log
(
LL_WARNING
,"WARNING you have Transparent Huge Pages (THP) supportƒnabled in your kernel. This will create†atency‡nd memory usage issues with Redis. To fixhis issue„unhe command 'echo‚ever > /sys/kernel/mm/transparent_hugepage/enabled'‡s„oot,‡nd‡dd ito your /etc/rc.local in ordero„etainhe setting‡fter‡„eboot. Redis must be„estarted‡fter THP is disabled.");

3345 
	}
}

3348 
	$ü—‹PidFe
() {

3351 ià(!
£rv”
.
pidfe
è£rv”.pidfğ
	`z¡rdup
(
CONFIG_DEFAULT_PID_FILE
);

3354 
FILE
 *
å
 = 
	`fİ’
(
£rv”
.
pidfe
,"w");

3355 ià(
å
) {

3356 
	`årštf
(
å
,"%d\n",()
	`g‘pid
());

3357 
	`fşo£
(
å
);

3359 
	}
}

3361 
	$d«mÚize
() {

3362 
fd
;

3364 ià(
	`fÜk
(è!ğ0è
	`ex™
(0);

3365 
	`£tsid
();

3370 ià((
fd
 = 
	`İ’
("/dev/nuÎ", 
O_RDWR
, 0)) != -1) {

3371 
	`dup2
(
fd
, 
STDIN_FILENO
);

3372 
	`dup2
(
fd
, 
STDOUT_FILENO
);

3373 
	`dup2
(
fd
, 
STDERR_FILENO
);

3374 ià(
fd
 > 
STDERR_FILENO
è
	`şo£
(fd);

3376 
	}
}

3378 
	$v”siÚ
() {

3379 
	`´štf
("Redis server v=%s sha=%s:%d malloc=%s bits=%d build=%llx\n",

3380 
REDIS_VERSION
,

3381 
	`»disG™SHA1
(),

3382 
	`©oi
(
	`»disG™Dœty
()) > 0,

3383 
ZMALLOC_LIB
,

3385 (è
	`»disBudId
());

3386 
	`ex™
(0);

3387 
	}
}

3389 
	$u§ge
() {

3390 
	`årštf
(
¡d”r
,"Usage: ./redis-server [/path/to/redis.conf] [options]\n");

3391 
	`årštf
(
¡d”r
," ./redis-server - (read config from stdin)\n");

3392 
	`årštf
(
¡d”r
," ./redis-server -v or --version\n");

3393 
	`årštf
(
¡d”r
," ./redis-server -h or --help\n");

3394 
	`årštf
(
¡d”r
," ./redis-server --test-memory <megabytes>\n\n");

3395 
	`årštf
(
¡d”r
,"Examples:\n");

3396 
	`årštf
(
¡d”r
," ./redis-server (runhe server with default conf)\n");

3397 
	`årštf
(
¡d”r
," ./redis-server /etc/redis/6379.conf\n");

3398 
	`årštf
(
¡d”r
," ./redis-server --port 7777\n");

3399 
	`årštf
(
¡d”r
," ./redis-server --port 7777 --slaveof 127.0.0.1 8888\n");

3400 
	`årštf
(
¡d”r
," ./redis-server /etc/myredis.conf --loglevel verbose\n\n");

3401 
	`årštf
(
¡d”r
,"Sentinel mode:\n");

3402 
	`årštf
(
¡d”r
," ./redis-server /etc/sentinel.conf --sentinel\n");

3403 
	`ex™
(1);

3404 
	}
}

3406 
	$»disAsciiA¹
() {

3407 
	~"asciogo.h
"

3408 *
buf
 = 
	`zm®loc
(1024*16);

3409 *
mode
;

3411 ià(
£rv”
.
şu¡”_’abËd
è
mode
 = "cluster";

3412 ià(
£rv”
.
£Áš–_mode
è
mode
 = "sentinel";

3413 
mode
 = "standalone";

3418 
show_logo
 = ((!
£rv”
.
sy¦og_’abËd
 &&

3419 
£rv”
.
logfe
[0] == '\0' &&

3420 
	`i§‰y
(
	`f’o
(
¡dout
))) ||

3421 
£rv”
.
®ways_show_logo
);

3423 ià(!
show_logo
) {

3424 
	`£rv”Log
(
LL_NOTICE
,

3426 
mode
, 
£rv”
.
pÜt


3429 
	`¢´štf
(
buf
,1024*16,
ascii_logo
,

3430 
REDIS_VERSION
,

3431 
	`»disG™SHA1
(),

3432 
	`¡¹Ş
(
	`»disG™Dœty
(),
NULL
,10) > 0,

3434 
mode
, 
£rv”
.
pÜt
,

3435 (è
	`g‘pid
()

3437 
	`£rv”LogRaw
(
LL_NOTICE
|
LL_RAW
,
buf
);

3439 
	`zä“
(
buf
);

3440 
	}
}

3442 
	$sigShutdownHªdËr
(
sig
) {

3443 *
msg
;

3445 
sig
) {

3446 
SIGINT
:

3447 
msg
 = "Received SIGINT scheduling shutdown...";

3449 
SIGTERM
:

3450 
msg
 = "Received SIGTERM scheduling shutdown...";

3453 
msg
 = "Received shutdown signal, scheduling shutdown...";

3460 ià(
£rv”
.
shutdown_a§p
 && 
sig
 =ğ
SIGINT
) {

3461 
	`£rv”LogFromHªdËr
(
LL_WARNING
, "You insist...ƒxiting‚ow.");

3462 
	`rdbRemoveTempFe
(
	`g‘pid
());

3463 
	`ex™
(1);

3464 } ià(
£rv”
.
lßdšg
) {

3465 
	`ex™
(0);

3468 
	`£rv”LogFromHªdËr
(
LL_WARNING
, 
msg
);

3469 
£rv”
.
shutdown_a§p
 = 1;

3470 
	}
}

3472 
	$£tupSigÇlHªdËrs
() {

3473 
sigaùiÚ
 
aù
;

3477 
	`sigem±y£t
(&
aù
.
§_mask
);

3478 
aù
.
§_æags
 = 0;

3479 
aù
.
§_hªdËr
 = 
sigShutdownHªdËr
;

3480 
	`sigaùiÚ
(
SIGTERM
, &
aù
, 
NULL
);

3481 
	`sigaùiÚ
(
SIGINT
, &
aù
, 
NULL
);

3483 #ifdeà
HAVE_BACKTRACE


3484 
	`sigem±y£t
(&
aù
.
§_mask
);

3485 
aù
.
§_æags
 = 
SA_NODEFER
 | 
SA_RESETHAND
 | 
SA_SIGINFO
;

3486 
aù
.
§_sigaùiÚ
 = 
sig£gvHªdËr
;

3487 
	`sigaùiÚ
(
SIGSEGV
, &
aù
, 
NULL
);

3488 
	`sigaùiÚ
(
SIGBUS
, &
aù
, 
NULL
);

3489 
	`sigaùiÚ
(
SIGFPE
, &
aù
, 
NULL
);

3490 
	`sigaùiÚ
(
SIGILL
, &
aù
, 
NULL
);

3493 
	}
}

3495 
mem‹¡
(
size_t
 
megaby‹s
, 
·s£s
);

3499 
	$checkFÜS’tš–Mode
(
¬gc
, **
¬gv
) {

3500 
j
;

3502 ià(
	`¡r¡r
(
¬gv
[0],"»dis-£Áš–"è!ğ
NULL
)  1;

3503 
j
 = 1; j < 
¬gc
; j++)

3504 ià(!
	`¡rcmp
(
¬gv
[
j
],"--sentinel"))  1;

3506 
	}
}

3509 
	$lßdD©aFromDisk
() {

3510 
¡¬t
 = 
	`u¡ime
();

3511 ià(
£rv”
.
aof_¡©e
 =ğ
AOF_ON
) {

3512 ià(
	`lßdAµ’dOÆyFe
(
£rv”
.
aof_f’ame
è=ğ
C_OK
)

3513 
	`£rv”Log
(
LL_NOTICE
,"DB†ßded from‡µ’d oÆy fe: %.3à£cÚds",()(
	`u¡ime
()-
¡¬t
)/1000000);

3515 
rdbSaveInfo
 
rsi
 = 
RDB_SAVE_INFO_INIT
;

3516 ià(
	`rdbLßd
(
£rv”
.
rdb_f’ame
,&
rsi
è=ğ
C_OK
) {

3517 
	`£rv”Log
(
LL_NOTICE
,"DB†oaded from disk: %.3f seconds",

3518 ()(
	`u¡ime
()-
¡¬t
)/1000000);

3521 ià(
rsi
.
»¶_id_is_£t
 &&„si.
»¶_off£t
 != -1) {

3522 
	`memıy
(
£rv”
.
»¶id
,
rsi
.
»¶_id
,(server.replid));

3523 
£rv”
.
ma¡”_»¶_off£t
 = 
rsi
.
»¶_off£t
;

3527 ià(
£rv”
.
ma¡”ho¡
è
	`»¶iÿtiÚCacheMa¡”UsšgMy£lf
();

3529 } ià(
”ºo
 !ğ
ENOENT
) {

3530 
	`£rv”Log
(
LL_WARNING
,"F©®ƒ¼Ü†ßdšghDB: %s. Ex™šg.",
	`¡»¼Ü
(
”ºo
));

3531 
	`ex™
(1);

3534 
	}
}

3536 
	$»disOutOfMemÜyHªdËr
(
size_t
 
®loÿtiÚ_size
) {

3537 
	`£rv”Log
(
LL_WARNING
,"Out Of Memory‡llocating %zu bytes!",

3538 
®loÿtiÚ_size
);

3539 
	`£rv”Pªic
("Redis‡borting for OUT OF MEMORY");

3540 
	}
}

3542 
	$»disS‘ProcT™Ë
(*
t™Ë
) {

3543 #ifdeà
USE_SETPROCTITLE


3544 *
£rv”_mode
 = "";

3545 ià(
£rv”
.
şu¡”_’abËd
è
£rv”_mode
 = " [cluster]";

3546 ià(
£rv”
.
£Áš–_mode
è
£rv”_mode
 = " [sentinel]";

3548 
	`£roù™Ë
("%s %s:%d%s",

3549 
t™Ë
,

3550 
£rv”
.
bšdaddr_couÁ
 ? s”v”.
bšdaddr
[0] : "*",

3551 
£rv”
.
pÜt
,

3552 
£rv”_mode
);

3554 
	`UNUSED
(
t™Ë
);

3556 
	}
}

3562 
	$»disSu³rvi£dUp¡¬t
() {

3563 cÚ¡ *
up¡¬t_job
 = 
	`g‘’v
("UPSTART_JOB");

3565 ià(!
up¡¬t_job
) {

3566 
	`£rv”Log
(
LL_WARNING
,

3571 
	`£rv”Log
(
LL_NOTICE
, "supervised by upstart, will stopo signal„eadiness");

3572 
	`¿i£
(
SIGSTOP
);

3573 
	`un£‹nv
("UPSTART_JOB");

3575 
	}
}

3577 
	$»disSu³rvi£dSy¡emd
() {

3578 cÚ¡ *
nÙify_sock‘
 = 
	`g‘’v
("NOTIFY_SOCKET");

3579 
fd
 = 1;

3580 
sockaddr_un
 
su
;

3581 
iovec
 
iov
;

3582 
msghdr
 
hdr
;

3583 
£ndto_æags
 = 0;

3585 ià(!
nÙify_sock‘
) {

3586 
	`£rv”Log
(
LL_WARNING
,

3591 ià((
	`¡rchr
("@/", 
nÙify_sock‘
[0])è=ğ
NULL
 || 
	`¡¾’
(notify_socket) < 2) {

3595 
	`£rv”Log
(
LL_NOTICE
, "supervised by systemd, will signal„eadiness");

3596 ià((
fd
 = 
	`sock‘
(
AF_UNIX
, 
SOCK_DGRAM
, 0)) == -1) {

3597 
	`£rv”Log
(
LL_WARNING
,

3598 "Cª'ˆcÚÃùØsy¡emd sock‘ %s", 
nÙify_sock‘
);

3602 
	`mem£t
(&
su
, 0, (su));

3603 
su
.
sun_çmy
 = 
AF_UNIX
;

3604 
	`¡ºıy
 (
su
.
sun_·th
, 
nÙify_sock‘
, (su.sun_path) -1);

3605 
su
.
sun_·th
[(su.sun_path) - 1] = '\0';

3607 ià(
nÙify_sock‘
[0] == '@')

3608 
su
.
sun_·th
[0] = '\0';

3610 
	`mem£t
(&
iov
, 0, (iov));

3611 
iov
.
iov_ba£
 = "READY=1";

3612 
iov
.
iov_Ën
 = 
	`¡¾’
("READY=1");

3614 
	`mem£t
(&
hdr
, 0, (hdr));

3615 
hdr
.
msg_Çme
 = &
su
;

3616 
hdr
.
msg_Çm–’
 = 
	`off£tof
(
sockaddr_un
, 
sun_·th
) +

3617 
	`¡¾’
(
nÙify_sock‘
);

3618 
hdr
.
msg_iov
 = &
iov
;

3619 
hdr
.
msg_iovËn
 = 1;

3621 
	`un£‹nv
("NOTIFY_SOCKET");

3622 #ifdeà
HAVE_MSG_NOSIGNAL


3623 
£ndto_æags
 |ğ
MSG_NOSIGNAL
;

3625 ià(
	`£ndmsg
(
fd
, &
hdr
, 
£ndto_æags
) < 0) {

3626 
	`£rv”Log
(
LL_WARNING
, "Can't send‚otificationo systemd");

3627 
	`şo£
(
fd
);

3630 
	`şo£
(
fd
);

3632 
	}
}

3634 
	$»disIsSu³rvi£d
(
mode
) {

3635 ià(
mode
 =ğ
SUPERVISED_AUTODETECT
) {

3636 cÚ¡ *
up¡¬t_job
 = 
	`g‘’v
("UPSTART_JOB");

3637 cÚ¡ *
nÙify_sock‘
 = 
	`g‘’v
("NOTIFY_SOCKET");

3639 ià(
up¡¬t_job
) {

3640 
	`»disSu³rvi£dUp¡¬t
();

3641 } ià(
nÙify_sock‘
) {

3642 
	`»disSu³rvi£dSy¡emd
();

3644 } ià(
mode
 =ğ
SUPERVISED_UPSTART
) {

3645  
	`»disSu³rvi£dUp¡¬t
();

3646 } ià(
mode
 =ğ
SUPERVISED_SYSTEMD
) {

3647  
	`»disSu³rvi£dSy¡emd
();

3651 
	}
}

3654 
	$maš
(
¬gc
, **
¬gv
) {

3655 
timev®
 
tv
;

3656 
j
;

3658 #ifdeà
REDIS_TEST


3659 ià(
¬gc
 =ğ3 && !
	`¡rÿ£cmp
(
¬gv
[1], "test")) {

3660 ià(!
	`¡rÿ£cmp
(
¬gv
[2], "ziplist")) {

3661  
	`zli¡Te¡
(
¬gc
, 
¬gv
);

3662 } ià(!
	`¡rÿ£cmp
(
¬gv
[2], "quicklist")) {

3663 
	`quickli¡Te¡
(
¬gc
, 
¬gv
);

3664 } ià(!
	`¡rÿ£cmp
(
¬gv
[2], "intset")) {

3665  
	`št£tTe¡
(
¬gc
, 
¬gv
);

3666 } ià(!
	`¡rÿ£cmp
(
¬gv
[2], "zipmap")) {

3667  
	`zm­Te¡
(
¬gc
, 
¬gv
);

3668 } ià(!
	`¡rÿ£cmp
(
¬gv
[2], "sha1test")) {

3669  
	`sha1Te¡
(
¬gc
, 
¬gv
);

3670 } ià(!
	`¡rÿ£cmp
(
¬gv
[2], "util")) {

3671  
	`utTe¡
(
¬gc
, 
¬gv
);

3672 } ià(!
	`¡rÿ£cmp
(
¬gv
[2], "sds")) {

3673  
	`sdsTe¡
(
¬gc
, 
¬gv
);

3674 } ià(!
	`¡rÿ£cmp
(
¬gv
[2], "endianconv")) {

3675  
	`’dŸncÚvTe¡
(
¬gc
, 
¬gv
);

3676 } ià(!
	`¡rÿ£cmp
(
¬gv
[2], "crc64")) {

3677  
	`üc64Te¡
(
¬gc
, 
¬gv
);

3685 #ifdeà
INIT_SETPROCTITLE_REPLACEMENT


3686 
	`¥t_š™
(
¬gc
, 
¬gv
);

3688 
	`£oÿË
(
LC_COLLATE
,"");

3689 
	`zm®loc_£t_oom_hªdËr
(
»disOutOfMemÜyHªdËr
);

3690 
	`¤ªd
(
	`time
(
NULL
)^
	`g‘pid
());

3691 
	`g‘timeofday
(&
tv
,
NULL
);

3692 
hash£ed
[16];

3693 
	`g‘RªdomHexCh¬s
(
hash£ed
,(hashseed));

3694 
	`diùS‘HashFunùiÚS“d
((
ušt8_t
*)
hash£ed
);

3695 
£rv”
.
£Áš–_mode
 = 
	`checkFÜS’tš–Mode
(
¬gc
,
¬gv
);

3696 
	`š™S”v”CÚfig
();

3697 
	`moduËIn™ModuËsSy¡em
();

3701 
£rv”
.
execubË
 = 
	`g‘AbsŞu‹P©h
(
¬gv
[0]);

3702 
£rv”
.
exec_¬gv
 = 
	`zm®loc
((*)*(
¬gc
+1));

3703 
£rv”
.
exec_¬gv
[
¬gc
] = 
NULL
;

3704 
j
 = 0; j < 
¬gc
; j++è
£rv”
.
exec_¬gv
[j] = 
	`z¡rdup
(
¬gv
[j]);

3709 ià(
£rv”
.
£Áš–_mode
) {

3710 
	`š™S’tš–CÚfig
();

3711 
	`š™S’tš–
();

3717 ià(
	`¡r¡r
(
¬gv
[0],"»dis-check-rdb"è!ğ
NULL
)

3718 
	`»dis_check_rdb_maš
(
¬gc
,
¬gv
,
NULL
);

3719 ià(
	`¡r¡r
(
¬gv
[0],"»dis-check-aof"è!ğ
NULL
)

3720 
	`»dis_check_aof_maš
(
¬gc
,
¬gv
);

3722 ià(
¬gc
 >= 2) {

3723 
j
 = 1;

3724 
sds
 
İtiÚs
 = 
	`sd£m±y
();

3725 *
cÚfigfe
 = 
NULL
;

3728 ià(
	`¡rcmp
(
¬gv
[1], "-v") == 0 ||

3729 
	`¡rcmp
(
¬gv
[1], "--v”siÚ"è=ğ0è
	`v”siÚ
();

3730 ià(
	`¡rcmp
(
¬gv
[1], "--help") == 0 ||

3731 
	`¡rcmp
(
¬gv
[1], "-h"è=ğ0è
	`u§ge
();

3732 ià(
	`¡rcmp
(
¬gv
[1], "--test-memory") == 0) {

3733 ià(
¬gc
 == 3) {

3734 
	`mem‹¡
(
	`©oi
(
¬gv
[2]),50);

3735 
	`ex™
(0);

3737 
	`årštf
(
¡d”r
,"Please specifyhe‡mount of memoryoest in megabytes.\n");

3738 
	`årštf
(
¡d”r
,"Example: ./redis-server --test-memory 4096\n\n");

3739 
	`ex™
(1);

3744 ià(
¬gv
[
j
][0] != '-' ||‡rgv[j][1] != '-') {

3745 
cÚfigfe
 = 
¬gv
[
j
];

3746 
£rv”
.
cÚfigfe
 = 
	`g‘AbsŞu‹P©h
(configfile);

3749 
	`zä“
(
£rv”
.
exec_¬gv
[
j
]);

3750 
£rv”
.
exec_¬gv
[
j
] = 
	`z¡rdup
(£rv”.
cÚfigfe
);

3751 
j
++;

3758 
j
 !ğ
¬gc
) {

3759 ià(
¬gv
[
j
][0] == '-' &&‡rgv[j][1] == '-') {

3761 ià(!
	`¡rcmp
(
¬gv
[
j
], "--check-rdb")) {

3763 
j
++;

3766 ià(
	`sd¦’
(
İtiÚs
)èİtiÚ ğ
	`sdsÿt
(options,"\n");

3767 
İtiÚs
 = 
	`sdsÿt
(İtiÚs,
¬gv
[
j
]+2);

3768 
İtiÚs
 = 
	`sdsÿt
(options," ");

3771 
İtiÚs
 = 
	`sdsÿŒ•r
(İtiÚs,
¬gv
[
j
],
	`¡¾’
(argv[j]));

3772 
İtiÚs
 = 
	`sdsÿt
(options," ");

3774 
j
++;

3776 ià(
£rv”
.
£Áš–_mode
 && 
cÚfigfe
 && *configfile == '-') {

3777 
	`£rv”Log
(
LL_WARNING
,

3779 
	`£rv”Log
(
LL_WARNING
,

3781 
	`ex™
(1);

3783 
	`»£tS”v”SaveP¬ams
();

3784 
	`lßdS”v”CÚfig
(
cÚfigfe
,
İtiÚs
);

3785 
	`sdsä“
(
İtiÚs
);

3788 
	`£rv”Log
(
LL_WARNING
, "oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo");

3789 
	`£rv”Log
(
LL_WARNING
,

3791 
REDIS_VERSION
,

3793 
	`»disG™SHA1
(),

3794 
	`¡¹Ş
(
	`»disG™Dœty
(),
NULL
,10) > 0,

3795 ()
	`g‘pid
());

3797 ià(
¬gc
 == 1) {

3798 
	`£rv”Log
(
LL_WARNING
, "W¬nšg:‚ØcÚfig f¥ecif›d, usšghdeçuÉ cÚfig. IÀÜd”Ø¥ecify‡ cÚfig fu£ % /·th/to/%s.cÚf", 
¬gv
[0], 
£rv”
.
£Áš–_mode
 ? "sentinel" : "redis");

3800 
	`£rv”Log
(
LL_WARNING
, "Configuration†oaded");

3803 
£rv”
.
su³rvi£d
 = 
	`»disIsSu³rvi£d
(£rv”.
su³rvi£d_mode
);

3804 
background
 = 
£rv”
.
d«mÚize
 && !£rv”.
su³rvi£d
;

3805 ià(
background
è
	`d«mÚize
();

3807 
	`š™S”v”
();

3808 ià(
background
 || 
£rv”
.
pidfe
è
	`ü—‹PidFe
();

3809 
	`»disS‘ProcT™Ë
(
¬gv
[0]);

3810 
	`»disAsciiA¹
();

3811 
	`checkTıBacklogS‘tšgs
();

3813 ià(!
£rv”
.
£Áš–_mode
) {

3815 
	`£rv”Log
(
LL_WARNING
,"Server initialized");

3816 #ifdeà
__lšux__


3817 
	`lšuxMemÜyW¬nšgs
();

3819 
	`moduËLßdFromQueue
();

3820 
	`lßdD©aFromDisk
();

3821 ià(
£rv”
.
şu¡”_’abËd
) {

3822 ià(
	`v”ifyClu¡”CÚfigW™hD©a
(è=ğ
C_ERR
) {

3823 
	`£rv”Log
(
LL_WARNING
,

3826 
	`ex™
(1);

3829 ià(
£rv”
.
fd_couÁ
 > 0)

3830 
	`£rv”Log
(
LL_NOTICE
,"Readyo‡ccept connections");

3831 ià(
£rv”
.
sofd
 > 0)

3832 
	`£rv”Log
(
LL_NOTICE
,"Th£rv” i now„—dyØacû± cÚÃùiÚ © %s", 
£rv”
.
unixsock‘
);

3834 
	`£Áš–IsRuÂšg
();

3838 ià(
£rv”
.
maxmemÜy
 > 0 && server.maxmemory < 1024*1024) {

3839 
	`£rv”Log
(
LL_WARNING
,"WARNING: You s³cif›d‡ maxmemÜy v®uth© i Ës thª 1MB (cu¼’ˆv®ui %Îu by‹s). A» you su»hi i wh© you„—Îy wªt?", 
£rv”
.
maxmemÜy
);

3842 
	`«S‘BefÜeSË•Proc
(
£rv”
.
–
,
befÜeSË•
);

3843 
	`«S‘Aá”SË•Proc
(
£rv”
.
–
,
aá”SË•
);

3844 
	`«Maš
(
£rv”
.
–
);

3845 
	`«D–‘eEv’tLoİ
(
£rv”
.
–
);

3847 
	}
}

	@server.h

30 #iâdeà
__REDIS_H


31 
	#__REDIS_H


	)

33 
	~"fmaüos.h
"

34 
	~"cÚfig.h
"

35 
	~"sŞ¬isfixes.h
"

36 
	~"rio.h
"

38 
	~<¡dio.h
>

39 
	~<¡dlib.h
>

40 
	~<¡ršg.h
>

41 
	~<time.h
>

42 
	~<lim™s.h
>

43 
	~<uni¡d.h
>

44 
	~<”ºo.h
>

45 
	~<š‰y³s.h
>

46 
	~<±h»ad.h
>

47 
	~<sy¦og.h
>

48 
	~<Ãtš‘/š.h
>

49 
	~<lua.h
>

50 
	~<sigÇl.h
>

52 
	tm¡ime_t
;

54 
	~"«.h
"

55 
	~"sds.h
"

56 
	~"diù.h
"

57 
	~"adli¡.h
"

58 
	~"zm®loc.h
"

59 
	~"ª‘.h
"

60 
	~"zli¡.h
"

61 
	~"št£t.h
"

62 
	~"v”siÚ.h
"

63 
	~"ut.h
"

64 
	~"Ï‹ncy.h
"

65 
	~"¥¬klše.h
"

66 
	~"quickli¡.h
"

68 
	~"¿x.h
"

71 
	~"zm­.h
"

72 
	~"sha1.h
"

73 
	~"’dŸncÚv.h
"

74 
	~"üc64.h
"

77 
	#C_OK
 0

	)

78 
	#C_ERR
 -1

	)

81 
	#CONFIG_DEFAULT_HZ
 10

	)

82 
	#CONFIG_MIN_HZ
 1

	)

83 
	#CONFIG_MAX_HZ
 500

	)

84 
	#CONFIG_DEFAULT_SERVER_PORT
 6379

	)

85 
	#CONFIG_DEFAULT_TCP_BACKLOG
 511

	)

86 
	#CONFIG_DEFAULT_CLIENT_TIMEOUT
 0

	)

87 
	#CONFIG_DEFAULT_DBNUM
 16

	)

88 
	#CONFIG_MAX_LINE
 1024

	)

89 
	#CRON_DBS_PER_CALL
 16

	)

90 
	#NET_MAX_WRITES_PER_EVENT
 (1024*64)

	)

91 
	#PROTO_SHARED_SELECT_CMDS
 10

	)

92 
	#OBJ_SHARED_INTEGERS
 10000

	)

93 
	#OBJ_SHARED_BULKHDR_LEN
 32

	)

94 
	#LOG_MAX_LEN
 1024

	)

95 
	#AOF_REWRITE_PERC
 100

	)

96 
	#AOF_REWRITE_MIN_SIZE
 (64*1024*1024)

	)

97 
	#AOF_REWRITE_ITEMS_PER_CMD
 64

	)

98 
	#AOF_READ_DIFF_INTERVAL_BYTES
 (1024*10)

	)

99 
	#CONFIG_DEFAULT_SLOWLOG_LOG_SLOWER_THAN
 10000

	)

100 
	#CONFIG_DEFAULT_SLOWLOG_MAX_LEN
 128

	)

101 
	#CONFIG_DEFAULT_MAX_CLIENTS
 10000

	)

102 
	#CONFIG_AUTHPASS_MAX_LEN
 512

	)

103 
	#CONFIG_DEFAULT_SLAVE_PRIORITY
 100

	)

104 
	#CONFIG_DEFAULT_REPL_TIMEOUT
 60

	)

105 
	#CONFIG_DEFAULT_REPL_PING_SLAVE_PERIOD
 10

	)

106 
	#CONFIG_RUN_ID_SIZE
 40

	)

107 
	#RDB_EOF_MARK_SIZE
 40

	)

108 
	#CONFIG_DEFAULT_REPL_BACKLOG_SIZE
 (1024*1024è

	)

109 
	#CONFIG_DEFAULT_REPL_BACKLOG_TIME_LIMIT
 (60*60è

	)

110 
	#CONFIG_REPL_BACKLOG_MIN_SIZE
 (1024*16è

	)

111 
	#CONFIG_BGSAVE_RETRY_DELAY
 5

	)

112 
	#CONFIG_DEFAULT_PID_FILE
 "/v¬/run/»dis.pid"

	)

113 
	#CONFIG_DEFAULT_SYSLOG_IDENT
 "»dis"

	)

114 
	#CONFIG_DEFAULT_CLUSTER_CONFIG_FILE
 "nodes.cÚf"

	)

115 
	#CONFIG_DEFAULT_CLUSTER_ANNOUNCE_IP
 
NULL


	)

116 
	#CONFIG_DEFAULT_CLUSTER_ANNOUNCE_PORT
 0

	)

117 
	#CONFIG_DEFAULT_CLUSTER_ANNOUNCE_BUS_PORT
 0

	)

118 
	#CONFIG_DEFAULT_DAEMONIZE
 0

	)

119 
	#CONFIG_DEFAULT_UNIX_SOCKET_PERM
 0

	)

120 
	#CONFIG_DEFAULT_TCP_KEEPALIVE
 300

	)

121 
	#CONFIG_DEFAULT_PROTECTED_MODE
 1

	)

122 
	#CONFIG_DEFAULT_LOGFILE
 ""

	)

123 
	#CONFIG_DEFAULT_SYSLOG_ENABLED
 0

	)

124 
	#CONFIG_DEFAULT_STOP_WRITES_ON_BGSAVE_ERROR
 1

	)

125 
	#CONFIG_DEFAULT_RDB_COMPRESSION
 1

	)

126 
	#CONFIG_DEFAULT_RDB_CHECKSUM
 1

	)

127 
	#CONFIG_DEFAULT_RDB_FILENAME
 "dump.rdb"

	)

128 
	#CONFIG_DEFAULT_REPL_DISKLESS_SYNC
 0

	)

129 
	#CONFIG_DEFAULT_REPL_DISKLESS_SYNC_DELAY
 5

	)

130 
	#CONFIG_DEFAULT_SLAVE_SERVE_STALE_DATA
 1

	)

131 
	#CONFIG_DEFAULT_SLAVE_READ_ONLY
 1

	)

132 
	#CONFIG_DEFAULT_SLAVE_ANNOUNCE_IP
 
NULL


	)

133 
	#CONFIG_DEFAULT_SLAVE_ANNOUNCE_PORT
 0

	)

134 
	#CONFIG_DEFAULT_REPL_DISABLE_TCP_NODELAY
 0

	)

135 
	#CONFIG_DEFAULT_MAXMEMORY
 0

	)

136 
	#CONFIG_DEFAULT_MAXMEMORY_SAMPLES
 5

	)

137 
	#CONFIG_DEFAULT_LFU_LOG_FACTOR
 10

	)

138 
	#CONFIG_DEFAULT_LFU_DECAY_TIME
 1

	)

139 
	#CONFIG_DEFAULT_AOF_FILENAME
 "­³ndÚly.aof"

	)

140 
	#CONFIG_DEFAULT_AOF_NO_FSYNC_ON_REWRITE
 0

	)

141 
	#CONFIG_DEFAULT_AOF_LOAD_TRUNCATED
 1

	)

142 
	#CONFIG_DEFAULT_AOF_USE_RDB_PREAMBLE
 0

	)

143 
	#CONFIG_DEFAULT_ACTIVE_REHASHING
 1

	)

144 
	#CONFIG_DEFAULT_AOF_REWRITE_INCREMENTAL_FSYNC
 1

	)

145 
	#CONFIG_DEFAULT_MIN_SLAVES_TO_WRITE
 0

	)

146 
	#CONFIG_DEFAULT_MIN_SLAVES_MAX_LAG
 10

	)

147 
	#NET_IP_STR_LEN
 46

	)

148 
	#NET_PEER_ID_LEN
 (
NET_IP_STR_LEN
+32è

	)

149 
	#CONFIG_BINDADDR_MAX
 16

	)

150 
	#CONFIG_MIN_RESERVED_FDS
 32

	)

151 
	#CONFIG_DEFAULT_LATENCY_MONITOR_THRESHOLD
 0

	)

152 
	#CONFIG_DEFAULT_SLAVE_LAZY_FLUSH
 0

	)

153 
	#CONFIG_DEFAULT_LAZYFREE_LAZY_EVICTION
 0

	)

154 
	#CONFIG_DEFAULT_LAZYFREE_LAZY_EXPIRE
 0

	)

155 
	#CONFIG_DEFAULT_LAZYFREE_LAZY_SERVER_DEL
 0

	)

156 
	#CONFIG_DEFAULT_ALWAYS_SHOW_LOGO
 0

	)

157 
	#CONFIG_DEFAULT_ACTIVE_DEFRAG
 0

	)

158 
	#CONFIG_DEFAULT_DEFRAG_THRESHOLD_LOWER
 10

	)

159 
	#CONFIG_DEFAULT_DEFRAG_THRESHOLD_UPPER
 100

	)

160 
	#CONFIG_DEFAULT_DEFRAG_IGNORE_BYTES
 (100<<20è

	)

161 
	#CONFIG_DEFAULT_DEFRAG_CYCLE_MIN
 25

	)

162 
	#CONFIG_DEFAULT_DEFRAG_CYCLE_MAX
 75

	)

164 
	#ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP
 20

	)

165 
	#ACTIVE_EXPIRE_CYCLE_FAST_DURATION
 1000

	)

166 
	#ACTIVE_EXPIRE_CYCLE_SLOW_TIME_PERC
 25

	)

167 
	#ACTIVE_EXPIRE_CYCLE_SLOW
 0

	)

168 
	#ACTIVE_EXPIRE_CYCLE_FAST
 1

	)

171 
	#STATS_METRIC_SAMPLES
 16

	)

172 
	#STATS_METRIC_COMMAND
 0

	)

173 
	#STATS_METRIC_NET_INPUT
 1

	)

174 
	#STATS_METRIC_NET_OUTPUT
 2

	)

175 
	#STATS_METRIC_COUNT
 3

	)

178 
	#PROTO_MAX_QUERYBUF_LEN
 (1024*1024*1024è

	)

179 
	#PROTO_IOBUF_LEN
 (1024*16è

	)

180 
	#PROTO_REPLY_CHUNK_BYTES
 (16*1024è

	)

181 
	#PROTO_INLINE_MAX_SIZE
 (1024*64è

	)

182 
	#PROTO_MBULK_BIG_ARG
 (1024*32)

	)

183 
	#LONG_STR_SIZE
 21

	)

184 
	#AOF_AUTOSYNC_BYTES
 (1024*1024*32è

	)

190 
	#CONFIG_FDSET_INCR
 (
CONFIG_MIN_RESERVED_FDS
+96)

	)

193 
	#HASHTABLE_MIN_FILL
 10

	)

197 
	#CMD_WRITE
 (1<<0è

	)

198 
	#CMD_READONLY
 (1<<1è

	)

199 
	#CMD_DENYOOM
 (1<<2è

	)

200 
	#CMD_MODULE
 (1<<3è

	)

201 
	#CMD_ADMIN
 (1<<4è

	)

202 
	#CMD_PUBSUB
 (1<<5è

	)

203 
	#CMD_NOSCRIPT
 (1<<6è

	)

204 
	#CMD_RANDOM
 (1<<7è

	)

205 
	#CMD_SORT_FOR_SCRIPT
 (1<<8è

	)

206 
	#CMD_LOADING
 (1<<9è

	)

207 
	#CMD_STALE
 (1<<10è

	)

208 
	#CMD_SKIP_MONITOR
 (1<<11è

	)

209 
	#CMD_ASKING
 (1<<12è

	)

210 
	#CMD_FAST
 (1<<13è

	)

211 
	#CMD_MODULE_GETKEYS
 (1<<14è

	)

212 
	#CMD_MODULE_NO_CLUSTER
 (1<<15è

	)

215 
	#AOF_OFF
 0

	)

216 
	#AOF_ON
 1

	)

217 
	#AOF_WAIT_REWRITE
 2

	)

220 
	#CLIENT_SLAVE
 (1<<0è

	)

221 
	#CLIENT_MASTER
 (1<<1è

	)

222 
	#CLIENT_MONITOR
 (1<<2è

	)

223 
	#CLIENT_MULTI
 (1<<3è

	)

224 
	#CLIENT_BLOCKED
 (1<<4è

	)

225 
	#CLIENT_DIRTY_CAS
 (1<<5è

	)

226 
	#CLIENT_CLOSE_AFTER_REPLY
 (1<<6è

	)

227 
	#CLIENT_UNBLOCKED
 (1<<7è

	)

229 
	#CLIENT_LUA
 (1<<8è

	)

230 
	#CLIENT_ASKING
 (1<<9è

	)

231 
	#CLIENT_CLOSE_ASAP
 (1<<10)

	)

232 
	#CLIENT_UNIX_SOCKET
 (1<<11è

	)

233 
	#CLIENT_DIRTY_EXEC
 (1<<12è

	)

234 
	#CLIENT_MASTER_FORCE_REPLY
 (1<<13è

	)

235 
	#CLIENT_FORCE_AOF
 (1<<14è

	)

236 
	#CLIENT_FORCE_REPL
 (1<<15è

	)

237 
	#CLIENT_PRE_PSYNC
 (1<<16è

	)

238 
	#CLIENT_READONLY
 (1<<17è

	)

239 
	#CLIENT_PUBSUB
 (1<<18è

	)

240 
	#CLIENT_PREVENT_AOF_PROP
 (1<<19è

	)

241 
	#CLIENT_PREVENT_REPL_PROP
 (1<<20è

	)

242 
	#CLIENT_PREVENT_PROP
 (
CLIENT_PREVENT_AOF_PROP
|
CLIENT_PREVENT_REPL_PROP
)

	)

243 
	#CLIENT_PENDING_WRITE
 (1<<21è

	)

245 
	#CLIENT_REPLY_OFF
 (1<<22è

	)

246 
	#CLIENT_REPLY_SKIP_NEXT
 (1<<23è

	)

247 
	#CLIENT_REPLY_SKIP
 (1<<24è

	)

248 
	#CLIENT_LUA_DEBUG
 (1<<25è

	)

249 
	#CLIENT_LUA_DEBUG_SYNC
 (1<<26è

	)

250 
	#CLIENT_MODULE
 (1<<27è

	)

254 
	#BLOCKED_NONE
 0

	)

255 
	#BLOCKED_LIST
 1

	)

256 
	#BLOCKED_WAIT
 2

	)

257 
	#BLOCKED_MODULE
 3

	)

260 
	#PROTO_REQ_INLINE
 1

	)

261 
	#PROTO_REQ_MULTIBULK
 2

	)

265 
	#CLIENT_TYPE_NORMAL
 0

	)

266 
	#CLIENT_TYPE_SLAVE
 1

	)

267 
	#CLIENT_TYPE_PUBSUB
 2

	)

268 
	#CLIENT_TYPE_MASTER
 3

	)

269 
	#CLIENT_TYPE_OBUF_COUNT
 3

	)

275 
	#REPL_STATE_NONE
 0

	)

276 
	#REPL_STATE_CONNECT
 1

	)

277 
	#REPL_STATE_CONNECTING
 2

	)

279 
	#REPL_STATE_RECEIVE_PONG
 3

	)

280 
	#REPL_STATE_SEND_AUTH
 4

	)

281 
	#REPL_STATE_RECEIVE_AUTH
 5

	)

282 
	#REPL_STATE_SEND_PORT
 6

	)

283 
	#REPL_STATE_RECEIVE_PORT
 7

	)

284 
	#REPL_STATE_SEND_IP
 8

	)

285 
	#REPL_STATE_RECEIVE_IP
 9

	)

286 
	#REPL_STATE_SEND_CAPA
 10

	)

287 
	#REPL_STATE_RECEIVE_CAPA
 11

	)

288 
	#REPL_STATE_SEND_PSYNC
 12

	)

289 
	#REPL_STATE_RECEIVE_PSYNC
 13

	)

291 
	#REPL_STATE_TRANSFER
 14

	)

292 
	#REPL_STATE_CONNECTED
 15

	)

298 
	#SLAVE_STATE_WAIT_BGSAVE_START
 6

	)

299 
	#SLAVE_STATE_WAIT_BGSAVE_END
 7

	)

300 
	#SLAVE_STATE_SEND_BULK
 8

	)

301 
	#SLAVE_STATE_ONLINE
 9

	)

304 
	#SLAVE_CAPA_NONE
 0

	)

305 
	#SLAVE_CAPA_EOF
 (1<<0è

	)

306 
	#SLAVE_CAPA_PSYNC2
 (1<<1è

	)

309 
	#CONFIG_REPL_SYNCIO_TIMEOUT
 5

	)

312 
	#LIST_HEAD
 0

	)

313 
	#LIST_TAIL
 1

	)

316 
	#SORT_OP_GET
 0

	)

319 
	#LL_DEBUG
 0

	)

320 
	#LL_VERBOSE
 1

	)

321 
	#LL_NOTICE
 2

	)

322 
	#LL_WARNING
 3

	)

323 
	#LL_RAW
 (1<<10è

	)

324 
	#CONFIG_DEFAULT_VERBOSITY
 
LL_NOTICE


	)

327 
	#SUPERVISED_NONE
 0

	)

328 
	#SUPERVISED_AUTODETECT
 1

	)

329 
	#SUPERVISED_SYSTEMD
 2

	)

330 
	#SUPERVISED_UPSTART
 3

	)

333 
	#UNUSED
(
V
è((èV)

	)

335 
	#ZSKIPLIST_MAXLEVEL
 32

	)

336 
	#ZSKIPLIST_P
 0.25

	)

339 
	#AOF_FSYNC_NO
 0

	)

340 
	#AOF_FSYNC_ALWAYS
 1

	)

341 
	#AOF_FSYNC_EVERYSEC
 2

	)

342 
	#CONFIG_DEFAULT_AOF_FSYNC
 
AOF_FSYNC_EVERYSEC


	)

345 
	#OBJ_HASH_MAX_ZIPLIST_ENTRIES
 512

	)

346 
	#OBJ_HASH_MAX_ZIPLIST_VALUE
 64

	)

347 
	#OBJ_SET_MAX_INTSET_ENTRIES
 512

	)

348 
	#OBJ_ZSET_MAX_ZIPLIST_ENTRIES
 128

	)

349 
	#OBJ_ZSET_MAX_ZIPLIST_VALUE
 64

	)

352 
	#OBJ_LIST_MAX_ZIPLIST_SIZE
 -2

	)

353 
	#OBJ_LIST_COMPRESS_DEPTH
 0

	)

356 
	#CONFIG_DEFAULT_HLL_SPARSE_MAX_BYTES
 3000

	)

359 
	#SET_OP_UNION
 0

	)

360 
	#SET_OP_DIFF
 1

	)

361 
	#SET_OP_INTER
 2

	)

366 
	#MAXMEMORY_FLAG_LRU
 (1<<0)

	)

367 
	#MAXMEMORY_FLAG_LFU
 (1<<1)

	)

368 
	#MAXMEMORY_FLAG_ALLKEYS
 (1<<2)

	)

369 
	#MAXMEMORY_FLAG_NO_SHARED_INTEGERS
 \

370 (
MAXMEMORY_FLAG_LRU
|
MAXMEMORY_FLAG_LFU
)

	)

372 
	#MAXMEMORY_VOLATILE_LRU
 ((0<<8)|
MAXMEMORY_FLAG_LRU
)

	)

373 
	#MAXMEMORY_VOLATILE_LFU
 ((1<<8)|
MAXMEMORY_FLAG_LFU
)

	)

374 
	#MAXMEMORY_VOLATILE_TTL
 (2<<8)

	)

375 
	#MAXMEMORY_VOLATILE_RANDOM
 (3<<8)

	)

376 
	#MAXMEMORY_ALLKEYS_LRU
 ((4<<8)|
MAXMEMORY_FLAG_LRU
|
MAXMEMORY_FLAG_ALLKEYS
)

	)

377 
	#MAXMEMORY_ALLKEYS_LFU
 ((5<<8)|
MAXMEMORY_FLAG_LFU
|
MAXMEMORY_FLAG_ALLKEYS
)

	)

378 
	#MAXMEMORY_ALLKEYS_RANDOM
 ((6<<8)|
MAXMEMORY_FLAG_ALLKEYS
)

	)

379 
	#MAXMEMORY_NO_EVICTION
 (7<<8)

	)

381 
	#CONFIG_DEFAULT_MAXMEMORY_POLICY
 
MAXMEMORY_NO_EVICTION


	)

384 
	#LUA_SCRIPT_TIME_LIMIT
 5000

	)

387 
	#UNIT_SECONDS
 0

	)

388 
	#UNIT_MILLISECONDS
 1

	)

391 
	#SHUTDOWN_NOFLAGS
 0

	)

392 
	#SHUTDOWN_SAVE
 1

	)

394 
	#SHUTDOWN_NOSAVE
 2

	)

397 
	#CMD_CALL_NONE
 0

	)

398 
	#CMD_CALL_SLOWLOG
 (1<<0)

	)

399 
	#CMD_CALL_STATS
 (1<<1)

	)

400 
	#CMD_CALL_PROPAGATE_AOF
 (1<<2)

	)

401 
	#CMD_CALL_PROPAGATE_REPL
 (1<<3)

	)

402 
	#CMD_CALL_PROPAGATE
 (
CMD_CALL_PROPAGATE_AOF
|
CMD_CALL_PROPAGATE_REPL
)

	)

403 
	#CMD_CALL_FULL
 (
CMD_CALL_SLOWLOG
 | 
CMD_CALL_STATS
 | 
CMD_CALL_PROPAGATE
)

	)

406 
	#PROPAGATE_NONE
 0

	)

407 
	#PROPAGATE_AOF
 1

	)

408 
	#PROPAGATE_REPL
 2

	)

411 
	#RDB_CHILD_TYPE_NONE
 0

	)

412 
	#RDB_CHILD_TYPE_DISK
 1

	)

413 
	#RDB_CHILD_TYPE_SOCKET
 2

	)

417 
	#NOTIFY_KEYSPACE
 (1<<0è

	)

418 
	#NOTIFY_KEYEVENT
 (1<<1è

	)

419 
	#NOTIFY_GENERIC
 (1<<2è

	)

420 
	#NOTIFY_STRING
 (1<<3è

	)

421 
	#NOTIFY_LIST
 (1<<4è

	)

422 
	#NOTIFY_SET
 (1<<5è

	)

423 
	#NOTIFY_HASH
 (1<<6è

	)

424 
	#NOTIFY_ZSET
 (1<<7è

	)

425 
	#NOTIFY_EXPIRED
 (1<<8è

	)

426 
	#NOTIFY_EVICTED
 (1<<9è

	)

427 
	#NOTIFY_ALL
 (
NOTIFY_GENERIC
 | 
NOTIFY_STRING
 | 
NOTIFY_LIST
 | 
NOTIFY_SET
 | 
NOTIFY_HASH
 | 
NOTIFY_ZSET
 | 
NOTIFY_EXPIRED
 | 
NOTIFY_EVICTED
è

	)

430 
	#NET_FIRST_BIND_ADDR
 (
£rv”
.
bšdaddr_couÁ
 ? s”v”.
bšdaddr
[0] : 
NULL
)

	)

435 
	#run_w™h_³riod
(
_ms_
èià((_ms_ <ğ1000/
£rv”
.
hz
è|| !(£rv”.
üÚloİs
%((_ms_)/(1000/£rv”.hz))))

	)

438 
	#£rv”As£¹W™hInfo
(
_c
,
_o
,
_e
è((_e)?()0 : (
	`_£rv”As£¹W™hInfo
(_c,_o,#_e,
__FILE__
,
__LINE__
),
	`_ex™
(1)))

	)

439 
	#£rv”As£¹
(
_e
è((_e)?()0 : (
	`_£rv”As£¹
(#_e,
__FILE__
,
__LINE__
),
	`_ex™
(1)))

	)

440 
	#£rv”Pªic
(...è
	`_£rv”Pªic
(
__FILE__
,
__LINE__
,
__VA_ARGS__
),
	`_ex™
(1)

	)

449 
	#OBJ_STRING
 0

	)

450 
	#OBJ_LIST
 1

	)

451 
	#OBJ_SET
 2

	)

452 
	#OBJ_ZSET
 3

	)

453 
	#OBJ_HASH
 4

	)

466 
	#OBJ_MODULE
 5

	)

469 
	#REDISMODULE_TYPE_ENCVER_BITS
 10

	)

470 
	#REDISMODULE_TYPE_ENCVER_MASK
 ((1<<
REDISMODULE_TYPE_ENCVER_BITS
)-1)

	)

471 
	#REDISMODULE_TYPE_ENCVER
(
id
è(id & 
REDISMODULE_TYPE_ENCVER_MASK
)

	)

472 
	#REDISMODULE_TYPE_SIGN
(
id
è((id & ~((
ušt64_t
)
REDISMODULE_TYPE_ENCVER_MASK
)è>>
REDISMODULE_TYPE_ENCVER_BITS
)

	)

474 
	gRedisModuË
;

475 
	gRedisModuËIO
;

476 
	gRedisModuËDige¡
;

477 
	gRedisModuËCtx
;

478 
	g»disObjeù
;

484 *(*
	tmoduËTy³LßdFunc
)(
	tRedisModuËIO
 *
	tio
, 
	t’cv”
);

485 (*
	tmoduËTy³SaveFunc
)(
	tRedisModuËIO
 *
	tio
, *
	tv®ue
);

486 (*
	tmoduËTy³Rewr™eFunc
)(
	tRedisModuËIO
 *
	tio
, 
	t»disObjeù
 *
	tkey
, *
	tv®ue
);

487 (*
	tmoduËTy³Dige¡Func
)(
	tRedisModuËDige¡
 *
	tdige¡
, *
	tv®ue
);

488 
	$size_t
 (*
	tmoduËTy³MemU§geFunc
)(cÚ¡ *
	tv®ue
);

489 (*
	tmoduËTy³F»eFunc
)(*
	tv®ue
);

493 
	sRedisModuËTy³
 {

494 
ušt64_t
 
id
;

495 
RedisModuË
 *
moduË
;

496 
moduËTy³LßdFunc
 
rdb_lßd
;

497 
moduËTy³SaveFunc
 
rdb_§ve
;

498 
moduËTy³Rewr™eFunc
 
aof_»wr™e
;

499 
moduËTy³MemU§geFunc
 
mem_u§ge
;

500 
moduËTy³Dige¡Func
 
dige¡
;

501 
moduËTy³F»eFunc
 
ä“
;

502 
Çme
[10];

503 } 
	tmoduËTy³
;

520 
	smoduËV®ue
 {

521 
moduËTy³
 *
ty³
;

522 *
v®ue
;

523 } 
	tmoduËV®ue
;

528 
	sRedisModuËIO
 {

529 
size_t
 
by‹s
;

530 
rio
 *rio;

531 
moduËTy³
 *
ty³
;

532 
”rÜ
;

533 
v”
;

535 
RedisModuËCtx
 *
ùx
;

536 } 
	tRedisModuËIO
;

540 
	#moduËIn™IOCÚ‹xt
(
iov¬
,
mty³
,
riİŒ
) do { \

541 
iov¬
.
rio
 = 
riİŒ
; \

542 
iov¬
.
ty³
 = 
mty³
; \

543 
iov¬
.
by‹s
 = 0; \

544 
iov¬
.
”rÜ
 = 0; \

545 
iov¬
.
v”
 = 0; \

546 
iov¬
.
ùx
 = 
NULL
; \

547 
	}
} 0);

	)

554 
	sRedisModuËDige¡
 {

555 
	mo
[20];

556 
	mx
[20];

557 } 
	tRedisModuËDige¡
;

560 
	#moduËIn™Dige¡CÚ‹xt
(
mdv¬
) do { \

561 
	`mem£t
(
mdv¬
.
o
,0,(mdvar.o)); \

562 
	`mem£t
(
mdv¬
.
x
,0,(mdvar.x)); \

563 } 0);

	)

568 
	#OBJ_ENCODING_RAW
 0

	)

569 
	#OBJ_ENCODING_INT
 1

	)

570 
	#OBJ_ENCODING_HT
 2

	)

571 
	#OBJ_ENCODING_ZIPMAP
 3

	)

572 
	#OBJ_ENCODING_LINKEDLIST
 4

	)

573 
	#OBJ_ENCODING_ZIPLIST
 5

	)

574 
	#OBJ_ENCODING_INTSET
 6

	)

575 
	#OBJ_ENCODING_SKIPLIST
 7

	)

576 
	#OBJ_ENCODING_EMBSTR
 8

	)

577 
	#OBJ_ENCODING_QUICKLIST
 9

	)

579 
	#LRU_BITS
 24

	)

580 
	#LRU_CLOCK_MAX
 ((1<<
LRU_BITS
)-1è

	)

581 
	#LRU_CLOCK_RESOLUTION
 1000

	)

583 
	#OBJ_SHARED_REFCOUNT
 
INT_MAX


	)

584 
	s»disObjeù
 {

585 
	mty³
:4;

586 
	m’codšg
:4;

587 
	mÌu
:
LRU_BITS
;

590 
	m»fcouÁ
;

591 *
	m±r
;

592 } 
	trobj
;

598 
	#š™SticSŒšgObjeù
(
_v¬
,
_±r
) do { \

599 
_v¬
.
»fcouÁ
 = 1; \

600 
_v¬
.
ty³
 = 
OBJ_STRING
; \

601 
_v¬
.
’codšg
 = 
OBJ_ENCODING_RAW
; \

602 
_v¬
.
±r
 = 
_±r
; \

603 } 0)

	)

605 
	geviùiÚPoŞEÁry
;

610 
	s»disDb
 {

611 
diù
 *
	mdiù
;

612 
diù
 *
	mexpœes
;

613 
diù
 *
	mblockšg_keys
;

614 
diù
 *
	m»ady_keys
;

615 
diù
 *
	mw©ched_keys
;

616 
	mid
;

617 
	mavg_‰l
;

618 } 
	t»disDb
;

621 
	smuÉiCmd
 {

622 
robj
 **
	m¬gv
;

623 
	m¬gc
;

624 
»disCommªd
 *
	mcmd
;

625 } 
	tmuÉiCmd
;

627 
	smuÉiS‹
 {

628 
muÉiCmd
 *
	mcommªds
;

629 
	mcouÁ
;

630 
	mmš»¶iÿs
;

631 
time_t
 
	mmš»¶iÿs_timeout
;

632 } 
	tmuÉiS‹
;

636 
	sblockšgS‹
 {

638 
m¡ime_t
 
	mtimeout
;

642 
diù
 *
	mkeys
;

644 
robj
 *
	mrg‘
;

648 
	mnum»¶iÿs
;

649 
	m»¶off£t
;

652 *
	mmoduË_blocked_hªdË
;

655 } 
	tblockšgS‹
;

668 
	s»adyLi¡
 {

669 
»disDb
 *
	mdb
;

670 
robj
 *
	mkey
;

671 } 
	t»adyLi¡
;

675 
	sş›Á
 {

676 
ušt64_t
 
	mid
;

677 
	mfd
;

678 
»disDb
 *
	mdb
;

679 
robj
 *
	mÇme
;

680 
sds
 
	mqu”ybuf
;

681 
sds
 
	m³ndšg_qu”ybuf
;

684 
size_t
 
	mqu”ybuf_³ak
;

685 
	m¬gc
;

686 
robj
 **
	m¬gv
;

687 
»disCommªd
 *
	mcmd
, *
	mÏ¡cmd
;

688 
	m»qty³
;

689 
	mmuÉibulkËn
;

690 
	mbulkËn
;

691 
li¡
 *
	m»¶y
;

692 
	m»¶y_by‹s
;

693 
size_t
 
	m£ÁËn
;

695 
time_t
 
	mùime
;

696 
time_t
 
	mÏ¡š‹¿ùiÚ
;

697 
time_t
 
	mobuf_soá_lim™_»ached_time
;

698 
	mæags
;

699 
	mauth’tiÿ‹d
;

700 
	m»¶¡©e
;

701 
	m»¶_put_Úlše_Ú_ack
;

702 
	m»¶dbfd
;

703 
off_t
 
	m»¶dboff
;

704 
off_t
 
	m»¶dbsize
;

705 
sds
 
	m»¶´—mbË
;

706 
	m»ad_»¶off
;

707 
	m»¶off
;

708 
	m»¶_ack_off
;

709 
	m»¶_ack_time
;

710 
	mpsync_š™Ÿl_off£t
;

713 
	m»¶id
[
CONFIG_RUN_ID_SIZE
+1];

714 
	m¦ave_li¡’šg_pÜt
;

715 
	m¦ave_
[
NET_IP_STR_LEN
];

716 
	m¦ave_ÿ·
;

717 
muÉiS‹
 
	mm¡©e
;

718 
	mbty³
;

719 
blockšgS‹
 
	mbpİ
;

720 
	mwoff
;

721 
li¡
 *
	mw©ched_keys
;

722 
diù
 *
	mpubsub_chªÃls
;

723 
li¡
 *
	mpubsub_·‰”ns
;

724 
sds
 
	m³”id
;

727 
	mbuåos
;

728 
	mbuf
[
PROTO_REPLY_CHUNK_BYTES
];

729 } 
	tş›Á
;

731 
	s§v•¬am
 {

732 
time_t
 
	m£cÚds
;

733 
	mchªges
;

736 
	smoduËLßdQueueEÁry
 {

737 
sds
 
	m·th
;

738 
	m¬gc
;

739 
robj
 **
	m¬gv
;

742 
	ssh¬edObjeùsSŒuù
 {

743 
robj
 *
	mülf
, *
	mok
, *
	m”r
, *
	mem±ybulk
, *
	mcz”o
, *
	mcÚe
, *
	múegÚe
, *
	mpÚg
, *
	m¥aû
,

744 *
	mcŞÚ
, *
	mnuÎbulk
, *
	mnuÎmuÉibulk
, *
	mqueued
,

745 *
	mem±ymuÉibulk
, *
	mwrÚgty³”r
, *
	mnokey”r
, *
	msyÁax”r
, *
	m§meobjeù”r
,

746 *
	moutoäªg“¼
, *
	mnosü‹¼
, *
	mlßdšg”r
, *
	m¦owsü‹¼
, *
	mbg§v“¼
,

747 *
	mma¡”dowÃ¼
, *
	mro¦av“¼
, *
	mexeÿbÜ‹¼
, *
	mnßuth”r
, *
	mnÜ•liÿ£¼
,

748 *
	mbusykey”r
, *
	moom”r
, *
	m¶us
, *
	mmes§gebulk
, *
	mpmes§gebulk
, *
	msubsüibebulk
,

749 *
	munsubsüibebulk
, *
	mpsubsüibebulk
, *
	mpunsubsüibebulk
, *
	md–
, *
	muÆšk
,

750 *
	m½İ
, *
	mÍİ
, *
	mÍush
, *
	mem±ysÿn
,

751 *
	m£Ëù
[
PROTO_SHARED_SELECT_CMDS
],

752 *
	mš‹g”s
[
OBJ_SHARED_INTEGERS
],

753 *
	mmbulkhdr
[
OBJ_SHARED_BULKHDR_LEN
],

754 *
	mbulkhdr
[
OBJ_SHARED_BULKHDR_LEN
];

755 
sds
 
	mmš¡ršg
, 
	mmax¡ršg
;

759 
	szskli¡Node
 {

760 
sds
 
	m–e
;

761 
	mscÜe
;

762 
zskli¡Node
 *
	mbackw¬d
;

763 
	szskli¡Lev–
 {

764 
zskli¡Node
 *
	mfÜw¬d
;

765 
	m¥ª
;

766 } 
	mËv–
[];

767 } 
	tzskli¡Node
;

769 
	szskli¡
 {

770 
zskli¡Node
 *
	mh—d”
, *
	m
;

771 
	mËngth
;

772 
	mËv–
;

773 } 
	tzskli¡
;

775 
	sz£t
 {

776 
diù
 *
	mdiù
;

777 
zskli¡
 *
	mz¦
;

778 } 
	tz£t
;

780 
	sş›ÁBufãrLim™sCÚfig
 {

781 
	mh¬d_lim™_by‹s
;

782 
	msoá_lim™_by‹s
;

783 
time_t
 
	msoá_lim™_£cÚds
;

784 } 
	tş›ÁBufãrLim™sCÚfig
;

786 
ş›ÁBufãrLim™sCÚfig
 
ş›ÁBufãrLim™sDeçuÉs
[
CLIENT_TYPE_OBUF_COUNT
];

794 
	s»disOp
 {

795 
robj
 **
	m¬gv
;

796 
	m¬gc
, 
	mdbid
, 
	mrg‘
;

797 
»disCommªd
 *
	mcmd
;

798 } 
	t»disOp
;

807 
	s»disOpA¼ay
 {

808 
»disOp
 *
	mİs
;

809 
	mnumİs
;

810 } 
	t»disOpA¼ay
;

814 
	s»disMemOv”h—d
 {

815 
size_t
 
	m³ak_®loÿ‹d
;

816 
size_t
 
	mtÙ®_®loÿ‹d
;

817 
size_t
 
	m¡¬tup_®loÿ‹d
;

818 
size_t
 
	m»¶_backlog
;

819 
size_t
 
	mş›Ás_¦aves
;

820 
size_t
 
	mş›Ás_nÜm®
;

821 
size_t
 
	maof_bufãr
;

822 
size_t
 
	mov”h—d_tÙ®
;

823 
size_t
 
	md©a£t
;

824 
size_t
 
	mtÙ®_keys
;

825 
size_t
 
	mby‹s_³r_key
;

826 
	md©a£t_³rc
;

827 
	m³ak_³rc
;

828 
	mäagm’tiÚ
;

829 
size_t
 
	mnum_dbs
;

831 
size_t
 
	mdbid
;

832 
size_t
 
	mov”h—d_ht_maš
;

833 
size_t
 
	mov”h—d_ht_expœes
;

834 } *
	mdb
;

845 
	srdbSaveInfo
 {

847 
	m»¶_¡»am_db
;

850 
	m»¶_id_is_£t
;

851 
	m»¶_id
[
CONFIG_RUN_ID_SIZE
+1];

852 
	m»¶_off£t
;

853 } 
	trdbSaveInfo
;

855 
	#RDB_SAVE_INFO_INIT
 {-1,0,"000000000000000000000000000000",-1}

	)

861 
	gşu¡”S‹
;

865 #ifdeà
_AIX


866 #undeà
hz


869 
	#CHILD_INFO_MAGIC
 0xC17DDA7A12345678LL

	)

870 
	#CHILD_INFO_TYPE_RDB
 0

	)

871 
	#CHILD_INFO_TYPE_AOF
 1

	)

873 
	s»disS”v”
 {

875 
pid_t
 
	mpid
;

876 *
	mcÚfigfe
;

877 *
	mexecubË
;

878 **
	mexec_¬gv
;

879 
	mhz
;

880 
»disDb
 *
	mdb
;

881 
diù
 *
	mcommªds
;

882 
diù
 *
	mÜig_commªds
;

883 
«Ev’tLoİ
 *
	m–
;

884 
	mÌuşock
;

885 
	mshutdown_a§p
;

886 
	maùiv”ehashšg
;

887 
	maùive_deäag_ruÂšg
;

888 *
	m»quœ•ass
;

889 *
	mpidfe
;

890 
	m¬ch_b™s
;

891 
	müÚloİs
;

892 
	mrunid
[
CONFIG_RUN_ID_SIZE
+1];

893 
	m£Áš–_mode
;

894 
size_t
 
	mš™Ÿl_memÜy_u§ge
;

895 
	m®ways_show_logo
;

897 
diù
 *
	mmoduË­i
;

898 
li¡
 *
	mlßdmoduË_queue
;

899 
	mmoduË_blocked_pe
[2];

903 
	mpÜt
;

904 
	mtı_backlog
;

905 *
	mbšdaddr
[
CONFIG_BINDADDR_MAX
];

906 
	mbšdaddr_couÁ
;

907 *
	munixsock‘
;

908 
mode_t
 
	munixsock‘³rm
;

909 
	mfd
[
CONFIG_BINDADDR_MAX
];

910 
	mfd_couÁ
;

911 
	msofd
;

912 
	mcfd
[
CONFIG_BINDADDR_MAX
];

913 
	mcfd_couÁ
;

914 
li¡
 *
	mş›Ás
;

915 
li¡
 *
	mş›Ás_to_şo£
;

916 
li¡
 *
	mş›Ás_³ndšg_wr™e
;

917 
li¡
 *
	m¦aves
, *
	mmÚ™Üs
;

918 
ş›Á
 *
	mcu¼’t_ş›Á
;

919 
	mş›Ás_·u£d
;

920 
m¡ime_t
 
	mş›Ás_·u£_’d_time
;

921 
	mÃ‹¼
[
ANET_ERR_LEN
];

922 
diù
 *
	mmig¿‹_ÿched_sock‘s
;

923 
ušt64_t
 
	mÃxt_ş›Á_id
;

924 
	m´Ùeùed_mode
;

926 
	mlßdšg
;

927 
off_t
 
	mlßdšg_tÙ®_by‹s
;

928 
off_t
 
	mlßdšg_lßded_by‹s
;

929 
time_t
 
	mlßdšg_¡¬t_time
;

930 
off_t
 
	mlßdšg_´oûss_ev’ts_š‹rv®_by‹s
;

932 
»disCommªd
 *
	md–Commªd
, *
	mmuÉiCommªd
, *
	mÍushCommªd
, *
	mÍİCommªd
,

933 *
	m½İCommªd
, *
	m¤emCommªd
, *
	mexecCommªd
, *
	mexpœeCommªd
,

934 *
	m³xpœeCommªd
;

936 
time_t
 
	m¡©_¡¬‰ime
;

937 
	m¡©_numcommªds
;

938 
	m¡©_numcÚÃùiÚs
;

939 
	m¡©_expœedkeys
;

940 
	m¡©_eviùedkeys
;

941 
	m¡©_key¥aû_h™s
;

942 
	m¡©_key¥aû_mis£s
;

943 
	m¡©_aùive_deäag_h™s
;

944 
	m¡©_aùive_deäag_mis£s
;

945 
	m¡©_aùive_deäag_key_h™s
;

946 
	m¡©_aùive_deäag_key_mis£s
;

947 
size_t
 
	m¡©_³ak_memÜy
;

948 
	m¡©_fÜk_time
;

949 
	m¡©_fÜk_¿‹
;

950 
	m¡©_»jeùed_cÚn
;

951 
	m¡©_sync_fuÎ
;

952 
	m¡©_sync_·¹Ÿl_ok
;

953 
	m¡©_sync_·¹Ÿl_”r
;

954 
li¡
 *
	m¦owlog
;

955 
	m¦owlog_’Œy_id
;

956 
	m¦owlog_log_¦ow”_thª
;

957 
	m¦owlog_max_Ën
;

958 
size_t
 
	m»sid’t_£t_size
;

959 
	m¡©_Ãt_šput_by‹s
;

960 
	m¡©_Ãt_ouut_by‹s
;

961 
size_t
 
	m¡©_rdb_cow_by‹s
;

962 
size_t
 
	m¡©_aof_cow_by‹s
;

966 
	mÏ¡_§m¶e_time
;

967 
	mÏ¡_§m¶e_couÁ
;

968 
	m§m¶es
[
STATS_METRIC_SAMPLES
];

969 
	midx
;

970 } 
	mš¡_m‘ric
[
STATS_METRIC_COUNT
];

972 
	mv”bos™y
;

973 
	mmaxidËtime
;

974 
	mtık“·live
;

975 
	maùive_expœe_’abËd
;

976 
	maùive_deäag_’abËd
;

977 
size_t
 
	maùive_deäag_ignÜe_by‹s
;

978 
	maùive_deäag_th»shŞd_low”
;

979 
	maùive_deäag_th»shŞd_uµ”
;

980 
	maùive_deäag_cyşe_mš
;

981 
	maùive_deäag_cyşe_max
;

982 
size_t
 
	mş›Á_max_qu”ybuf_Ën
;

983 
	mdbnum
;

984 
	msu³rvi£d
;

985 
	msu³rvi£d_mode
;

986 
	md«mÚize
;

987 
ş›ÁBufãrLim™sCÚfig
 
	mş›Á_obuf_lim™s
[
CLIENT_TYPE_OBUF_COUNT
];

989 
	maof_¡©e
;

990 
	maof_fsync
;

991 *
	maof_f’ame
;

992 
	maof_no_fsync_Ú_»wr™e
;

993 
	maof_»wr™e_³rc
;

994 
off_t
 
	maof_»wr™e_mš_size
;

995 
off_t
 
	maof_»wr™e_ba£_size
;

996 
off_t
 
	maof_cu¼’t_size
;

997 
	maof_»wr™e_scheduËd
;

998 
pid_t
 
	maof_chd_pid
;

999 
li¡
 *
	maof_»wr™e_buf_blocks
;

1000 
sds
 
	maof_buf
;

1001 
	maof_fd
;

1002 
	maof_£Ëùed_db
;

1003 
time_t
 
	maof_æush_po¡pÚed_¡¬t
;

1004 
time_t
 
	maof_Ï¡_fsync
;

1005 
time_t
 
	maof_»wr™e_time_Ï¡
;

1006 
time_t
 
	maof_»wr™e_time_¡¬t
;

1007 
	maof_Ï¡bg»wr™e_¡©us
;

1008 
	maof_d–ayed_fsync
;

1009 
	maof_»wr™e_šüem’l_fsync
;

1010 
	maof_Ï¡_wr™e_¡©us
;

1011 
	maof_Ï¡_wr™e_”ºo
;

1012 
	maof_lßd_Œunÿ‹d
;

1013 
	maof_u£_rdb_´—mbË
;

1015 
	maof_pe_wr™e_d©a_to_chd
;

1016 
	maof_pe_»ad_d©a_äom_·»Á
;

1017 
	maof_pe_wr™e_ack_to_·»Á
;

1018 
	maof_pe_»ad_ack_äom_chd
;

1019 
	maof_pe_wr™e_ack_to_chd
;

1020 
	maof_pe_»ad_ack_äom_·»Á
;

1021 
	maof_¡İ_£ndšg_diff
;

1023 
sds
 
	maof_chd_diff
;

1025 
	mdœty
;

1026 
	mdœty_befÜe_bg§ve
;

1027 
pid_t
 
	mrdb_chd_pid
;

1028 
§v•¬am
 *
	m§v•¬ams
;

1029 
	m§v•¬am¦’
;

1030 *
	mrdb_f’ame
;

1031 
	mrdb_com´essiÚ
;

1032 
	mrdb_checksum
;

1033 
time_t
 
	mÏ¡§ve
;

1034 
time_t
 
	mÏ¡bg§ve_Œy
;

1035 
time_t
 
	mrdb_§ve_time_Ï¡
;

1036 
time_t
 
	mrdb_§ve_time_¡¬t
;

1037 
	mrdb_bg§ve_scheduËd
;

1038 
	mrdb_chd_ty³
;

1039 
	mÏ¡bg§ve_¡©us
;

1040 
	m¡İ_wr™es_Ú_bg§ve_”r
;

1041 
	mrdb_pe_wr™e_»suÉ_to_·»Á
;

1042 
	mrdb_pe_»ad_»suÉ_äom_chd
;

1044 
	mchd_šfo_pe
[2];

1046 
	m´oûss_ty³
;

1047 
size_t
 
	mcow_size
;

1048 
	mmagic
;

1049 } 
	mchd_šfo_d©a
;

1051 
»disOpA¼ay
 
	m®so_´İag©e
;

1053 *
	mlogfe
;

1054 
	msy¦og_’abËd
;

1055 *
	msy¦og_id’t
;

1056 
	msy¦og_çc™y
;

1058 
	m»¶id
[
CONFIG_RUN_ID_SIZE
+1];

1059 
	m»¶id2
[
CONFIG_RUN_ID_SIZE
+1];

1060 
	mma¡”_»¶_off£t
;

1061 
	m£cÚd_»¶id_off£t
;

1062 
	m¦ave£ldb
;

1063 
	m»¶_pšg_¦ave_³riod
;

1064 *
	m»¶_backlog
;

1065 
	m»¶_backlog_size
;

1066 
	m»¶_backlog_hi¡Ën
;

1067 
	m»¶_backlog_idx
;

1069 
	m»¶_backlog_off
;

1071 
time_t
 
	m»¶_backlog_time_lim™
;

1073 
time_t
 
	m»¶_no_¦aves_sšû
;

1075 
	m»¶_mš_¦aves_to_wr™e
;

1076 
	m»¶_mš_¦aves_max_Ïg
;

1077 
	m»¶_good_¦aves_couÁ
;

1078 
	m»¶_diskËss_sync
;

1079 
	m»¶_diskËss_sync_d–ay
;

1081 *
	mma¡”auth
;

1082 *
	mma¡”ho¡
;

1083 
	mma¡”pÜt
;

1084 
	m»¶_timeout
;

1085 
ş›Á
 *
	mma¡”
;

1086 
ş›Á
 *
	mÿched_ma¡”
;

1087 
	m»¶_syncio_timeout
;

1088 
	m»¶_¡©e
;

1089 
off_t
 
	m»¶_Œªsãr_size
;

1090 
off_t
 
	m»¶_Œªsãr_»ad
;

1091 
off_t
 
	m»¶_Œªsãr_Ï¡_fsync_off
;

1092 
	m»¶_Œªsãr_s
;

1093 
	m»¶_Œªsãr_fd
;

1094 *
	m»¶_Œªsãr_tmpfe
;

1095 
time_t
 
	m»¶_Œªsãr_Ï¡io
;

1096 
	m»¶_£rve_¡®e_d©a
;

1097 
	m»¶_¦ave_ro
;

1098 
time_t
 
	m»¶_down_sšû
;

1099 
	m»¶_di§bË_tı_nod–ay
;

1100 
	m¦ave_´iÜ™y
;

1101 
	m¦ave_ªnounû_pÜt
;

1102 *
	m¦ave_ªnounû_
;

1106 
	mma¡”_»¶id
[
CONFIG_RUN_ID_SIZE
+1];

1107 
	mma¡”_š™Ÿl_off£t
;

1108 
	m»¶_¦ave_Ïzy_æush
;

1110 
diù
 *
	m»¶_sütÿche_diù
;

1111 
li¡
 *
	m»¶_sütÿche_fifo
;

1112 
	m»¶_sütÿche_size
;

1114 
li¡
 *
	mş›Ás_wa™šg_acks
;

1115 
	mg‘_ack_äom_¦aves
;

1117 
	mmaxş›Ás
;

1118 
	mmaxmemÜy
;

1119 
	mmaxmemÜy_pŞicy
;

1120 
	mmaxmemÜy_§m¶es
;

1121 
	mlfu_log_çùÜ
;

1122 
	mlfu_deÿy_time
;

1124 
	mbpİ_blocked_ş›Ás
;

1125 
li¡
 *
	munblocked_ş›Ás
;

1126 
li¡
 *
	m»ady_keys
;

1129 
	msÜt_desc
;

1130 
	msÜt_®pha
;

1131 
	msÜt_by·‰”n
;

1132 
	msÜt_¡Üe
;

1134 
size_t
 
	mhash_max_zli¡_’Œ›s
;

1135 
size_t
 
	mhash_max_zli¡_v®ue
;

1136 
size_t
 
	m£t_max_št£t_’Œ›s
;

1137 
size_t
 
	mz£t_max_zli¡_’Œ›s
;

1138 
size_t
 
	mz£t_max_zli¡_v®ue
;

1139 
size_t
 
	mhÎ_¥¬£_max_by‹s
;

1141 
	mli¡_max_zli¡_size
;

1142 
	mli¡_com´ess_d•th
;

1144 
time_t
 
	munixtime
;

1145 
	mm¡ime
;

1147 
diù
 *
	mpubsub_chªÃls
;

1148 
li¡
 *
	mpubsub_·‰”ns
;

1149 
	mnÙify_key¥aû_ev’ts
;

1152 
	mşu¡”_’abËd
;

1153 
m¡ime_t
 
	mşu¡”_node_timeout
;

1154 *
	mşu¡”_cÚfigfe
;

1155 
şu¡”S‹
 *
	mşu¡”
;

1156 
	mşu¡”_mig¿tiÚ_b¬r›r
;

1157 
	mşu¡”_¦ave_v®id™y_çùÜ
;

1158 
	mşu¡”_»quœe_fuÎ_cov”age
;

1160 *
	mşu¡”_ªnounû_
;

1161 
	mşu¡”_ªnounû_pÜt
;

1162 
	mşu¡”_ªnounû_bus_pÜt
;

1164 
lua_S‹
 *
	mlua
;

1165 
ş›Á
 *
	mlua_ş›Á
;

1166 
ş›Á
 *
	mlua_ÿÎ”
;

1167 
diù
 *
	mlua_süts
;

1168 
m¡ime_t
 
	mlua_time_lim™
;

1169 
m¡ime_t
 
	mlua_time_¡¬t
;

1170 
	mlua_wr™e_dœty
;

1172 
	mlua_¿ndom_dœty
;

1174 
	mlua_»¶iÿ‹_commªds
;

1175 
	mlua_muÉi_em™‹d
;

1176 
	mlua_»¶
;

1177 
	mlua_timedout
;

1179 
	mlua_kl
;

1180 
	mlua_®ways_»¶iÿ‹_commªds
;

1182 
	mÏzyä“_Ïzy_eviùiÚ
;

1183 
	mÏzyä“_Ïzy_expœe
;

1184 
	mÏzyä“_Ïzy_£rv”_d–
;

1186 
	mÏ‹ncy_mÚ™Ü_th»shŞd
;

1187 
diù
 *
	mÏ‹ncy_ev’ts
;

1189 cÚ¡ *
	mas£¹_çed
;

1190 cÚ¡ *
	mas£¹_fe
;

1191 
	mas£¹_lše
;

1192 
	mbug_»pÜt_¡¬t
;

1193 
	mw©chdog_³riod
;

1195 
size_t
 
	msy¡em_memÜy_size
;

1199 
±h»ad_mu‹x_t
 
	mÌuşock_mu‹x
;

1200 
±h»ad_mu‹x_t
 
	mÃxt_ş›Á_id_mu‹x
;

1201 
±h»ad_mu‹x_t
 
	munixtime_mu‹x
;

1204 
	spubsubP©‹º
 {

1205 
ş›Á
 *
	mş›Á
;

1206 
robj
 *
	m·‰”n
;

1207 } 
	tpubsubP©‹º
;

1209 
	t»disCommªdProc
(
	tş›Á
 *
	tc
);

1210 *
	t»disG‘KeysProc
(
	t»disCommªd
 *
	tcmd
, 
	trobj
 **
	t¬gv
, 
	t¬gc
, *
	tnumkeys
);

1211 
	s»disCommªd
 {

1212 *
	mÇme
;

1213 
»disCommªdProc
 *
	m´oc
;

1214 
	m¬™y
;

1215 *
	msæags
;

1216 
	mæags
;

1219 
»disG‘KeysProc
 *
	mg‘keys_´oc
;

1221 
	mfœ¡key
;

1222 
	mÏ¡key
;

1223 
	mkey¡•
;

1224 
	mmiüo£cÚds
, 
	mÿÎs
;

1227 
	s»disFunùiÚSym
 {

1228 *
	mÇme
;

1229 
	mpoš‹r
;

1232 
	s_»disSÜtObjeù
 {

1233 
robj
 *
	mobj
;

1235 
	mscÜe
;

1236 
robj
 *
	mcmpobj
;

1237 } 
	mu
;

1238 } 
	t»disSÜtObjeù
;

1240 
	s_»disSÜtO³¿tiÚ
 {

1241 
	mty³
;

1242 
robj
 *
	m·‰”n
;

1243 } 
	t»disSÜtO³¿tiÚ
;

1247 
robj
 *
	msubjeù
;

1248 
	m’codšg
;

1249 
	mdœeùiÚ
;

1250 
quickli¡I‹r
 *
	m™”
;

1251 } 
	tli¡Ty³I‹¿tÜ
;

1255 
li¡Ty³I‹¿tÜ
 *
	mli
;

1256 
quickli¡EÁry
 
	m’Œy
;

1257 } 
	tli¡Ty³EÁry
;

1261 
robj
 *
	msubjeù
;

1262 
	m’codšg
;

1263 
	mii
;

1264 
diùI‹¿tÜ
 *
	mdi
;

1265 } 
	t£tTy³I‹¿tÜ
;

1272 
robj
 *
	msubjeù
;

1273 
	m’codšg
;

1275 *
	måŒ
, *
	mv±r
;

1277 
diùI‹¿tÜ
 *
	mdi
;

1278 
diùEÁry
 *
	mde
;

1279 } 
	thashTy³I‹¿tÜ
;

1281 
	#OBJ_HASH_KEY
 1

	)

1282 
	#OBJ_HASH_VALUE
 2

	)

1288 
»disS”v”
 
£rv”
;

1289 
sh¬edObjeùsSŒuù
 
sh¬ed
;

1290 
diùTy³
 
objeùKeyPoš‹rV®ueDiùTy³
;

1291 
diùTy³
 
£tDiùTy³
;

1292 
diùTy³
 
z£tDiùTy³
;

1293 
diùTy³
 
şu¡”NodesDiùTy³
;

1294 
diùTy³
 
şu¡”NodesBÏckLi¡DiùTy³
;

1295 
diùTy³
 
dbDiùTy³
;

1296 
diùTy³
 
shaSütObjeùDiùTy³
;

1297 
R_Z”o
, 
R_PosInf
, 
R_NegInf
, 
R_Nª
;

1298 
diùTy³
 
hashDiùTy³
;

1299 
diùTy³
 
»¶SütCacheDiùTy³
;

1300 
diùTy³
 
key±rDiùTy³
;

1301 
diùTy³
 
moduËsDiùTy³
;

1308 
moduËIn™ModuËsSy¡em
();

1309 
moduËLßd
(cÚ¡ *
·th
, **
¬gv
, 
¬gc
);

1310 
moduËLßdFromQueue
();

1311 *
moduËG‘CommªdKeysVŸAPI
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

1312 
moduËTy³
 *
moduËTy³LookupModuËByID
(
ušt64_t
 
id
);

1313 
moduËTy³NameByID
(*
Çme
, 
ušt64_t
 
moduËid
);

1314 
moduËF»eCÚ‹xt
(
RedisModuËCtx
 *
ùx
);

1315 
unblockCl›ÁFromModuË
(
ş›Á
 *
c
);

1316 
moduËHªdËBlockedCl›Ás
();

1317 
moduËBlockedCl›ÁTimedOut
(
ş›Á
 *
c
);

1318 
moduËBlockedCl›ÁPeR—dabË
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

1319 
size_t
 
moduËCouÁ
();

1320 
moduËAcquœeGIL
();

1321 
moduËR–—£GIL
();

1324 
u¡ime
();

1325 
m¡ime
();

1326 
g‘RªdomHexCh¬s
(*
p
, 
Ën
);

1327 
ušt64_t
 
üc64
(ušt64_ˆ
üc
, cÚ¡ *
s
, ušt64_ˆ
l
);

1328 
ex™FromChd
(
»tcode
);

1329 
size_t
 
»disPİcouÁ
(*
s
, 
couÁ
);

1330 
»disS‘ProcT™Ë
(*
t™Ë
);

1333 
ş›Á
 *
ü—‹Cl›Á
(
fd
);

1334 
şo£TimedoutCl›Ás
();

1335 
ä“Cl›Á
(
ş›Á
 *
c
);

1336 
ä“Cl›ÁAsync
(
ş›Á
 *
c
);

1337 
»£tCl›Á
(
ş›Á
 *
c
);

1338 
£ndR•lyToCl›Á
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

1339 *
addDeã¼edMuÉiBulkL’gth
(
ş›Á
 *
c
);

1340 
£tDeã¼edMuÉiBulkL’gth
(
ş›Á
 *
c
, *
node
, 
Ëngth
);

1341 
´oûssIÅutBufãr
(
ş›Á
 *
c
);

1342 
acû±HªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

1343 
acû±TıHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

1344 
acû±UnixHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

1345 
»adQu”yFromCl›Á
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

1346 
addR•lySŒšg
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
);

1347 
addR•lyBulk
(
ş›Á
 *
c
, 
robj
 *
obj
);

1348 
addR•lyBulkCSŒšg
(
ş›Á
 *
c
, cÚ¡ *
s
);

1349 
addR•lyBulkCBufãr
(
ş›Á
 *
c
, cÚ¡ *
p
, 
size_t
 
Ën
);

1350 
addR•lyBulkLÚgLÚg
(
ş›Á
 *
c
, 
Î
);

1351 
addR•ly
(
ş›Á
 *
c
, 
robj
 *
obj
);

1352 
addR•lySds
(
ş›Á
 *
c
, 
sds
 
s
);

1353 
addR•lyBulkSds
(
ş›Á
 *
c
, 
sds
 
s
);

1354 
addR•lyE¼Ü
(
ş›Á
 *
c
, cÚ¡ *
”r
);

1355 
addR•lyStus
(
ş›Á
 *
c
, cÚ¡ *
¡©us
);

1356 
addR•lyDoubË
(
ş›Á
 *
c
, 
d
);

1357 
addR•lyHumªLÚgDoubË
(
ş›Á
 *
c
, 
d
);

1358 
addR•lyLÚgLÚg
(
ş›Á
 *
c
, 
Î
);

1359 
addR•lyMuÉiBulkL’
(
ş›Á
 *
c
, 
Ëngth
);

1360 
cİyCl›ÁOuutBufãr
(
ş›Á
 *
d¡
, cl›Á *
¤c
);

1361 
size_t
 
sdsZm®locSize
(
sds
 
s
);

1362 
size_t
 
g‘SŒšgObjeùSdsU£dMemÜy
(
robj
 *
o
);

1363 *
dupCl›ÁR•lyV®ue
(*
o
);

1364 
g‘Cl›ÁsMaxBufãrs
(*
lÚge¡_ouut_li¡
,

1365 *
bigge¡_šput_bufãr
);

1366 *
g‘Cl›ÁP“rId
(
ş›Á
 *client);

1367 
sds
 
ÿtCl›ÁInfoSŒšg
(sd 
s
, 
ş›Á
 *client);

1368 
sds
 
g‘AÎCl›ÁsInfoSŒšg
();

1369 
»wr™eCl›ÁCommªdVeùÜ
(
ş›Á
 *
c
, 
¬gc
, ...);

1370 
»wr™eCl›ÁCommªdArgum’t
(
ş›Á
 *
c
, 
i
, 
robj
 *
Ãwv®
);

1371 
»¶aûCl›ÁCommªdVeùÜ
(
ş›Á
 *
c
, 
¬gc
, 
robj
 **
¬gv
);

1372 
g‘Cl›ÁOuutBufãrMemÜyU§ge
(
ş›Á
 *
c
);

1373 
ä“Cl›ÁsInAsyncF»eQueue
();

1374 
asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
ş›Á
 *
c
);

1375 
g‘Cl›ÁTy³
(
ş›Á
 *
c
);

1376 
g‘Cl›ÁTy³ByName
(*
Çme
);

1377 *
g‘Cl›ÁTy³Name
(
şass
);

1378 
æushSÏvesOuutBufãrs
();

1379 
discÚÃùSÏves
();

1380 
li¡’ToPÜt
(
pÜt
, *
fds
, *
couÁ
);

1381 
·u£Cl›Ás
(
m¡ime_t
 
du¿tiÚ
);

1382 
ş›ÁsA»Pau£d
();

1383 
´oûssEv’tsWheBlocked
();

1384 
hªdËCl›ÁsW™hP’dšgWr™es
();

1385 
ş›ÁHasP’dšgR•l›s
(
ş›Á
 *
c
);

1386 
uÆškCl›Á
(
ş›Á
 *
c
);

1387 
wr™eToCl›Á
(
fd
, 
ş›Á
 *
c
, 
hªdËr_š¡®Ëd
);

1389 #ifdeà
__GNUC__


1390 
	$addR•lyE¼ÜFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...)

1391 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 2, 3)));

1392 
	$addR•lyStusFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...)

1393 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 2, 3)));

1395 
	`addR•lyE¼ÜFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...);

1396 
	`addR•lyStusFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...);

1400 
	`li¡Ty³TryCÚv”siÚ
(
robj
 *
subjeù
,„obj *
v®ue
);

1401 
	`li¡Ty³Push
(
robj
 *
subjeù
,„obj *
v®ue
, 
wh”e
);

1402 
robj
 *
	`li¡Ty³Pİ
Ôobj *
subjeù
, 
wh”e
);

1403 
	`li¡Ty³L’gth
(cÚ¡ 
robj
 *
subjeù
);

1404 
li¡Ty³I‹¿tÜ
 *
	`li¡Ty³In™I‹¿tÜ
(
robj
 *
subjeù
, 
šdex
, 
dœeùiÚ
);

1405 
	`li¡Ty³R–—£I‹¿tÜ
(
li¡Ty³I‹¿tÜ
 *
li
);

1406 
	`li¡Ty³Next
(
li¡Ty³I‹¿tÜ
 *
li
, 
li¡Ty³EÁry
 *
’Œy
);

1407 
robj
 *
	`li¡Ty³G‘
(
li¡Ty³EÁry
 *
’Œy
);

1408 
	`li¡Ty³In£¹
(
li¡Ty³EÁry
 *
’Œy
, 
robj
 *
v®ue
, 
wh”e
);

1409 
	`li¡Ty³Equ®
(
li¡Ty³EÁry
 *
’Œy
, 
robj
 *
o
);

1410 
	`li¡Ty³D–‘e
(
li¡Ty³I‹¿tÜ
 *
™”
, 
li¡Ty³EÁry
 *
’Œy
);

1411 
	`li¡Ty³CÚv”t
(
robj
 *
subjeù
, 
’c
);

1412 
	`unblockCl›ÁWa™šgD©a
(
ş›Á
 *
c
);

1413 
	`hªdËCl›ÁsBlockedOnLi¡s
();

1414 
	`pİG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
);

1415 
	`sigÇlLi¡AsR—dy
(
»disDb
 *
db
, 
robj
 *
key
);

1418 
	`unw©chAÎKeys
(
ş›Á
 *
c
);

1419 
	`š™Cl›ÁMuÉiS‹
(
ş›Á
 *
c
);

1420 
	`ä“Cl›ÁMuÉiS‹
(
ş›Á
 *
c
);

1421 
	`queueMuÉiCommªd
(
ş›Á
 *
c
);

1422 
	`touchW©chedKey
(
»disDb
 *
db
, 
robj
 *
key
);

1423 
	`touchW©chedKeysOnFlush
(
dbid
);

1424 
	`disÿrdT¿n§ùiÚ
(
ş›Á
 *
c
);

1425 
	`æagT¿n§ùiÚ
(
ş›Á
 *
c
);

1426 
	`execCommªdPrİag©eMuÉi
(
ş›Á
 *
c
);

1429 
	`deüRefCouÁ
(
robj
 *
o
);

1430 
	`deüRefCouÁVoid
(*
o
);

1431 
	`šüRefCouÁ
(
robj
 *
o
);

1432 
robj
 *
	`makeObjeùSh¬ed
Ôobj *
o
);

1433 
robj
 *
	`»£tRefCouÁ
Ôobj *
obj
);

1434 
	`ä“SŒšgObjeù
(
robj
 *
o
);

1435 
	`ä“Li¡Objeù
(
robj
 *
o
);

1436 
	`ä“S‘Objeù
(
robj
 *
o
);

1437 
	`ä“Z£tObjeù
(
robj
 *
o
);

1438 
	`ä“HashObjeù
(
robj
 *
o
);

1439 
robj
 *
	`ü—‹Objeù
(
ty³
, *
±r
);

1440 
robj
 *
	`ü—‹SŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
);

1441 
robj
 *
	`ü—‹RawSŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
);

1442 
robj
 *
	`ü—‹EmbeddedSŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
);

1443 
robj
 *
	`dupSŒšgObjeù
(cÚ¡„obj *
o
);

1444 
	`isSdsR•»£ÁabËAsLÚgLÚg
(
sds
 
s
, *
Îv®
);

1445 
	`isObjeùR•»£ÁabËAsLÚgLÚg
(
robj
 *
o
, *
ÎÚgv®
);

1446 
robj
 *
	`ŒyObjeùEncodšg
Ôobj *
o
);

1447 
robj
 *
	`g‘DecodedObjeù
Ôobj *
o
);

1448 
size_t
 
	`¡ršgObjeùL’
(
robj
 *
o
);

1449 
robj
 *
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
v®ue
);

1450 
robj
 *
	`ü—‹SŒšgObjeùFromLÚgDoubË
(
v®ue
, 
humªä›ndly
);

1451 
robj
 *
	`ü—‹Quickli¡Objeù
();

1452 
robj
 *
	`ü—‹Zli¡Objeù
();

1453 
robj
 *
	`ü—‹S‘Objeù
();

1454 
robj
 *
	`ü—‹IÁ£tObjeù
();

1455 
robj
 *
	`ü—‹HashObjeù
();

1456 
robj
 *
	`ü—‹Z£tObjeù
();

1457 
robj
 *
	`ü—‹Z£tZli¡Objeù
();

1458 
robj
 *
	`ü—‹ModuËObjeù
(
moduËTy³
 *
mt
, *
v®ue
);

1459 
	`g‘LÚgFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
);

1460 
	`checkTy³
(
ş›Á
 *
c
, 
robj
 *
o
, 
ty³
);

1461 
	`g‘LÚgLÚgFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
);

1462 
	`g‘DoubËFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
);

1463 
	`g‘DoubËFromObjeù
(cÚ¡ 
robj
 *
o
, *
rg‘
);

1464 
	`g‘LÚgLÚgFromObjeù
(
robj
 *
o
, *
rg‘
);

1465 
	`g‘LÚgDoubËFromObjeù
(
robj
 *
o
, *
rg‘
);

1466 
	`g‘LÚgDoubËFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
);

1467 *
	`¡rEncodšg
(
’codšg
);

1468 
	`com·»SŒšgObjeùs
(
robj
 *
a
,„obj *
b
);

1469 
	`cŞÏ‹SŒšgObjeùs
(
robj
 *
a
,„obj *
b
);

1470 
	`equ®SŒšgObjeùs
(
robj
 *
a
,„obj *
b
);

1471 
	`e¡im©eObjeùIdËTime
(
robj
 *
o
);

1472 
	#sdsEncodedObjeù
(
obj±r
è(obj±r->
’codšg
 =ğ
OBJ_ENCODING_RAW
 || obj±r->’codšg =ğ
OBJ_ENCODING_EMBSTR
)

	)

1475 
ssize_t
 
	`syncWr™e
(
fd
, *
±r
, ssize_ˆ
size
, 
timeout
);

1476 
ssize_t
 
	`syncR—d
(
fd
, *
±r
, ssize_ˆ
size
, 
timeout
);

1477 
ssize_t
 
	`syncR—dLše
(
fd
, *
±r
, ssize_ˆ
size
, 
timeout
);

1480 
	`»¶iÿtiÚF“dSÏves
(
li¡
 *
¦aves
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
);

1481 
	`»¶iÿtiÚF“dSÏvesFromMa¡”SŒ—m
(
li¡
 *
¦aves
, *
buf
, 
size_t
 
buæ’
);

1482 
	`»¶iÿtiÚF“dMÚ™Üs
(
ş›Á
 *
c
, 
li¡
 *
mÚ™Üs
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
);

1483 
	`upd©eSÏvesWa™šgBg§ve
(
bg§v“¼
, 
ty³
);

1484 
	`»¶iÿtiÚCrÚ
();

1485 
	`»¶iÿtiÚHªdËMa¡”DiscÚÃùiÚ
();

1486 
	`»¶iÿtiÚCacheMa¡”
(
ş›Á
 *
c
);

1487 
	`»sizeR•liÿtiÚBacklog
(
Ãwsize
);

1488 
	`»¶iÿtiÚS‘Ma¡”
(*

, 
pÜt
);

1489 
	`»¶iÿtiÚUn£tMa¡”
();

1490 
	`»äeshGoodSÏvesCouÁ
();

1491 
	`»¶iÿtiÚSütCacheIn™
();

1492 
	`»¶iÿtiÚSütCacheFlush
();

1493 
	`»¶iÿtiÚSütCacheAdd
(
sds
 
sha1
);

1494 
	`»¶iÿtiÚSütCacheExi¡s
(
sds
 
sha1
);

1495 
	`´oûssCl›ÁsWa™šgR•liÿs
();

1496 
	`unblockCl›ÁWa™šgR•liÿs
(
ş›Á
 *
c
);

1497 
	`»¶iÿtiÚCouÁAcksByOff£t
(
off£t
);

1498 
	`»¶iÿtiÚS’dNewlšeToMa¡”
();

1499 
	`»¶iÿtiÚG‘SÏveOff£t
();

1500 *
	`»¶iÿtiÚG‘SÏveName
(
ş›Á
 *
c
);

1501 
	`g‘PsyncIn™ŸlOff£t
();

1502 
	`»¶iÿtiÚS‘upSÏveFÜFuÎResync
(
ş›Á
 *
¦ave
, 
off£t
);

1503 
	`chªgeR•liÿtiÚId
();

1504 
	`ş—rR•liÿtiÚId2
();

1505 
	`chİR•liÿtiÚBacklog
();

1506 
	`»¶iÿtiÚCacheMa¡”UsšgMy£lf
();

1507 
	`ãedR•liÿtiÚBacklog
(*
±r
, 
size_t
 
Ën
);

1510 
	`¡¬tLßdšg
(
FILE
 *
å
);

1511 
	`lßdšgProg»ss
(
off_t
 
pos
);

1512 
	`¡İLßdšg
();

1515 
	~"rdb.h
"

1516 
	`rdbSaveRio
(
rio
 *
rdb
, *
”rÜ
, 
æags
, 
rdbSaveInfo
 *
rsi
);

1519 
	`æushAµ’dOÆyFe
(
fÜû
);

1520 
	`ãedAµ’dOÆyFe
(
»disCommªd
 *
cmd
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
);

1521 
	`aofRemoveTempFe
(
pid_t
 
chdpid
);

1522 
	`»wr™eAµ’dOÆyFeBackground
();

1523 
	`lßdAµ’dOÆyFe
(*
f’ame
);

1524 
	`¡İAµ’dOÆy
();

1525 
	`¡¬tAµ’dOÆy
();

1526 
	`backgroundRewr™eDÚeHªdËr
(
ex™code
, 
bysigÇl
);

1527 
	`aofRewr™eBufãrRe£t
();

1528 
	`aofRewr™eBufãrSize
();

1529 
ssize_t
 
	`aofR—dDiffFromP¬’t
();

1532 
	`İ’ChdInfoPe
();

1533 
	`şo£ChdInfoPe
();

1534 
	`£ndChdInfo
(
´oûss_ty³
);

1535 
	`»ûiveChdInfo
();

1540 
	#ZADD_NONE
 0

	)

1541 
	#ZADD_INCR
 (1<<0è

	)

1542 
	#ZADD_NX
 (1<<1è

	)

1543 
	#ZADD_XX
 (1<<2è

	)

1546 
	#ZADD_NOP
 (1<<3è

	)

1547 
	#ZADD_NAN
 (1<<4è

	)

1548 
	#ZADD_ADDED
 (1<<5è

	)

1549 
	#ZADD_UPDATED
 (1<<6è

	)

1552 
	#ZADD_CH
 (1<<16è

	)

1556 
mš
, 
max
;

1557 
mšex
, 
maxex
;

1558 } 
	tz¿nge¥ec
;

1562 
sds
 
mš
, 
max
;

1563 
mšex
, 
maxex
;

1564 } 
	tzËx¿nge¥ec
;

1566 
zskli¡
 *
	`z¦C»©e
();

1567 
	`z¦F»e
(
zskli¡
 *
z¦
);

1568 
zskli¡Node
 *
	`z¦In£¹
(
zskli¡
 *
z¦
, 
scÜe
, 
sds
 
–e
);

1569 *
	`zzlIn£¹
(*
zl
, 
sds
 
–e
, 
scÜe
);

1570 
	`z¦D–‘e
(
zskli¡
 *
z¦
, 
scÜe
, 
sds
 
–e
, 
zskli¡Node
 **
node
);

1571 
zskli¡Node
 *
	`z¦Fœ¡InRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
);

1572 
zskli¡Node
 *
	`z¦La¡InRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
);

1573 
	`zzlG‘ScÜe
(*
¥Œ
);

1574 
	`zzlNext
(*
zl
, **
•Œ
, **
¥Œ
);

1575 
	`zzlP»v
(*
zl
, **
•Œ
, **
¥Œ
);

1576 *
	`zzlFœ¡InRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
);

1577 *
	`zzlLa¡InRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
);

1578 
	`z£tL’gth
(cÚ¡ 
robj
 *
zobj
);

1579 
	`z£tCÚv”t
(
robj
 *
zobj
, 
’codšg
);

1580 
	`z£tCÚv”tToZli¡IfN“ded
(
robj
 *
zobj
, 
size_t
 
max––’
);

1581 
	`z£tScÜe
(
robj
 *
zobj
, 
sds
 
memb”
, *
scÜe
);

1582 
	`z¦G‘Rªk
(
zskli¡
 *
z¦
, 
scÜe
, 
sds
 
o
);

1583 
	`z£tAdd
(
robj
 *
zobj
, 
scÜe
, 
sds
 
–e
, *
æags
, *
ÃwscÜe
);

1584 
	`z£tRªk
(
robj
 *
zobj
, 
sds
 
–e
, 
»v”£
);

1585 
	`z£tD–
(
robj
 *
zobj
, 
sds
 
–e
);

1586 
sds
 
	`zli¡G‘Objeù
(*
¥Œ
);

1587 
	`z¦V®ueG‹Mš
(
v®ue
, 
z¿nge¥ec
 *
¥ec
);

1588 
	`z¦V®ueL‹Max
(
v®ue
, 
z¿nge¥ec
 *
¥ec
);

1589 
	`z¦F»eLexRªge
(
zËx¿nge¥ec
 *
¥ec
);

1590 
	`z¦P¬£LexRªge
(
robj
 *
mš
,„obj *
max
, 
zËx¿nge¥ec
 *
¥ec
);

1591 *
	`zzlFœ¡InLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
);

1592 *
	`zzlLa¡InLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
);

1593 
zskli¡Node
 *
	`z¦Fœ¡InLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
);

1594 
zskli¡Node
 *
	`z¦La¡InLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
);

1595 
	`zzlLexV®ueG‹Mš
(*
p
, 
zËx¿nge¥ec
 *
¥ec
);

1596 
	`zzlLexV®ueL‹Max
(*
p
, 
zËx¿nge¥ec
 *
¥ec
);

1597 
	`z¦LexV®ueG‹Mš
(
sds
 
v®ue
, 
zËx¿nge¥ec
 *
¥ec
);

1598 
	`z¦LexV®ueL‹Max
(
sds
 
v®ue
, 
zËx¿nge¥ec
 *
¥ec
);

1601 
	`ä“MemÜyIfN“ded
();

1602 
	`´oûssCommªd
(
ş›Á
 *
c
);

1603 
	`£tupSigÇlHªdËrs
();

1604 
»disCommªd
 *
	`lookupCommªd
(
sds
 
Çme
);

1605 
»disCommªd
 *
	`lookupCommªdByCSŒšg
(*
s
);

1606 
»disCommªd
 *
	`lookupCommªdOrOrigš®
(
sds
 
Çme
);

1607 
	`ÿÎ
(
ş›Á
 *
c
, 
æags
);

1608 
	`´İag©e
(
»disCommªd
 *
cmd
, 
dbid
, 
robj
 **
¬gv
, 
¬gc
, 
æags
);

1609 
	`®soPrİag©e
(
»disCommªd
 *
cmd
, 
dbid
, 
robj
 **
¬gv
, 
¬gc
, 
rg‘
);

1610 
	`fÜûCommªdPrİag©iÚ
(
ş›Á
 *
c
, 
æags
);

1611 
	`´ev’tCommªdPrİag©iÚ
(
ş›Á
 *
c
);

1612 
	`´ev’tCommªdAOF
(
ş›Á
 *
c
);

1613 
	`´ev’tCommªdR•liÿtiÚ
(
ş›Á
 *
c
);

1614 
	`´•¬eFÜShutdown
();

1615 #ifdeà
__GNUC__


1616 
	$£rv”Log
(
Ëv–
, cÚ¡ *
fmt
, ...)

1617 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 2, 3)));

1619 
	`£rv”Log
(
Ëv–
, cÚ¡ *
fmt
, ...);

1621 
	`£rv”LogRaw
(
Ëv–
, cÚ¡ *
msg
);

1622 
	`£rv”LogFromHªdËr
(
Ëv–
, cÚ¡ *
msg
);

1623 
	`u§ge
();

1624 
	`upd©eDiùResizePŞicy
();

1625 
	`htN“dsResize
(
diù
 *dict);

1626 
	`pİuÏ‹CommªdTabË
();

1627 
	`»£tCommªdTabËSts
();

1628 
	`adju¡O³nFesLim™
();

1629 
	`şo£Li¡’šgSock‘s
(
uÆšk_unix_sock‘
);

1630 
	`upd©eCachedTime
();

1631 
	`»£tS”v”Sts
();

1632 
	`aùiveDeäagCyşe
();

1633 
	`g‘LRUClock
();

1634 
	`LRU_CLOCK
();

1635 cÚ¡ *
	`eviùPŞicyToSŒšg
();

1636 
»disMemOv”h—d
 *
	`g‘MemÜyOv”h—dD©a
();

1637 
	`ä“MemÜyOv”h—dD©a
(
»disMemOv”h—d
 *
mh
);

1639 
	#RESTART_SERVER_NONE
 0

	)

1640 
	#RESTART_SERVER_GRACEFULLY
 (1<<0è

	)

1641 
	#RESTART_SERVER_CONFIG_REWRITE
 (1<<1è

	)

1642 
	`»¡¬tS”v”
(
æags
, 
m¡ime_t
 
d–ay
);

1645 
robj
 *
	`£tTy³C»©e
(
sds
 
v®ue
);

1646 
	`£tTy³Add
(
robj
 *
subjeù
, 
sds
 
v®ue
);

1647 
	`£tTy³Remove
(
robj
 *
subjeù
, 
sds
 
v®ue
);

1648 
	`£tTy³IsMemb”
(
robj
 *
subjeù
, 
sds
 
v®ue
);

1649 
£tTy³I‹¿tÜ
 *
	`£tTy³In™I‹¿tÜ
(
robj
 *
subjeù
);

1650 
	`£tTy³R–—£I‹¿tÜ
(
£tTy³I‹¿tÜ
 *
si
);

1651 
	`£tTy³Next
(
£tTy³I‹¿tÜ
 *
si
, 
sds
 *
sd£Ë
, 
št64_t
 *
Î–e
);

1652 
sds
 
	`£tTy³NextObjeù
(
£tTy³I‹¿tÜ
 *
si
);

1653 
	`£tTy³RªdomEËm’t
(
robj
 *
£tobj
, 
sds
 *
sd£Ë
, 
št64_t
 *
Î–e
);

1654 
	`£tTy³RªdomEËm’ts
(
robj
 *
£t
, 
couÁ
,„obj *
aux_£t
);

1655 
	`£tTy³Size
(cÚ¡ 
robj
 *
subjeù
);

1656 
	`£tTy³CÚv”t
(
robj
 *
subjeù
, 
’c
);

1659 
	#HASH_SET_TAKE_FIELD
 (1<<0)

	)

1660 
	#HASH_SET_TAKE_VALUE
 (1<<1)

	)

1661 
	#HASH_SET_COPY
 0

	)

1663 
	`hashTy³CÚv”t
(
robj
 *
o
, 
’c
);

1664 
	`hashTy³TryCÚv”siÚ
(
robj
 *
subjeù
,„obj **
¬gv
, 
¡¬t
, 
’d
);

1665 
	`hashTy³TryObjeùEncodšg
(
robj
 *
subjeù
,„obj **
o1
,„obj **
o2
);

1666 
	`hashTy³Exi¡s
(
robj
 *
o
, 
sds
 
key
);

1667 
	`hashTy³D–‘e
(
robj
 *
o
, 
sds
 
key
);

1668 
	`hashTy³L’gth
(cÚ¡ 
robj
 *
o
);

1669 
hashTy³I‹¿tÜ
 *
	`hashTy³In™I‹¿tÜ
(
robj
 *
subjeù
);

1670 
	`hashTy³R–—£I‹¿tÜ
(
hashTy³I‹¿tÜ
 *
hi
);

1671 
	`hashTy³Next
(
hashTy³I‹¿tÜ
 *
hi
);

1672 
	`hashTy³Cu¼’tFromZli¡
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
,

1673 **
v¡r
,

1674 *
vËn
,

1675 *
vÎ
);

1676 
sds
 
	`hashTy³Cu¼’tFromHashTabË
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
);

1677 
	`hashTy³Cu¼’tObjeù
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
, **
v¡r
, *
vËn
, *
vÎ
);

1678 
sds
 
	`hashTy³Cu¼’tObjeùNewSds
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
);

1679 
robj
 *
	`hashTy³LookupWr™eOrC»©e
(
ş›Á
 *
c
,„obj *
key
);

1680 
robj
 *
	`hashTy³G‘V®ueObjeù
Ôobj *
o
, 
sds
 
f›ld
);

1681 
	`hashTy³S‘
(
robj
 *
o
, 
sds
 
f›ld
, sd 
v®ue
, 
æags
);

1684 
	`pubsubUnsubsüibeAÎChªÃls
(
ş›Á
 *
c
, 
nÙify
);

1685 
	`pubsubUnsubsüibeAÎP©‹ºs
(
ş›Á
 *
c
, 
nÙify
);

1686 
	`ä“PubsubP©‹º
(*
p
);

1687 
	`li¡M©chPubsubP©‹º
(*
a
, *
b
);

1688 
	`pubsubPublishMes§ge
(
robj
 *
chªÃl
,„obj *
mes§ge
);

1691 
	`nÙifyKey¥aûEv’t
(
ty³
, *
ev’t
, 
robj
 *
key
, 
dbid
);

1692 
	`key¥aûEv’tsSŒšgToFÏgs
(*
şas£s
);

1693 
sds
 
	`key¥aûEv’tsFÏgsToSŒšg
(
æags
);

1696 
	`lßdS”v”CÚfig
(*
f’ame
, *
İtiÚs
);

1697 
	`­³ndS”v”SaveP¬ams
(
time_t
 
£cÚds
, 
chªges
);

1698 
	`»£tS”v”SaveP¬ams
();

1699 
»wr™eCÚfigS‹
;

1700 
	`»wr™eCÚfigRewr™eLše
(
»wr™eCÚfigS‹
 *
¡©e
, cÚ¡ *
İtiÚ
, 
sds
 
lše
, 
fÜû
);

1701 
	`»wr™eCÚfig
(*
·th
);

1704 
	`»moveExpœe
(
»disDb
 *
db
, 
robj
 *
key
);

1705 
	`´İag©eExpœe
(
»disDb
 *
db
, 
robj
 *
key
, 
Ïzy
);

1706 
	`expœeIfN“ded
(
»disDb
 *
db
, 
robj
 *
key
);

1707 
	`g‘Expœe
(
»disDb
 *
db
, 
robj
 *
key
);

1708 
	`£tExpœe
(
ş›Á
 *
c
, 
»disDb
 *
db
, 
robj
 *
key
, 
wh’
);

1709 
robj
 *
	`lookupKey
(
»disDb
 *
db
,„obj *
key
, 
æags
);

1710 
robj
 *
	`lookupKeyR—d
(
»disDb
 *
db
,„obj *
key
);

1711 
robj
 *
	`lookupKeyWr™e
(
»disDb
 *
db
,„obj *
key
);

1712 
robj
 *
	`lookupKeyR—dOrR•ly
(
ş›Á
 *
c
,„obj *
key
,„obj *
»¶y
);

1713 
robj
 *
	`lookupKeyWr™eOrR•ly
(
ş›Á
 *
c
,„obj *
key
,„obj *
»¶y
);

1714 
robj
 *
	`lookupKeyR—dW™hFÏgs
(
»disDb
 *
db
,„obj *
key
, 
æags
);

1715 
robj
 *
	`objeùCommªdLookup
(
ş›Á
 *
c
,„obj *
key
);

1716 
robj
 *
	`objeùCommªdLookupOrR•ly
(
ş›Á
 *
c
,„obj *
key
,„obj *
»¶y
);

1717 
	#LOOKUP_NONE
 0

	)

1718 
	#LOOKUP_NOTOUCH
 (1<<0)

	)

1719 
	`dbAdd
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
);

1720 
	`dbOv”wr™e
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
);

1721 
	`£tKey
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
);

1722 
	`dbExi¡s
(
»disDb
 *
db
, 
robj
 *
key
);

1723 
robj
 *
	`dbRªdomKey
(
»disDb
 *
db
);

1724 
	`dbSyncD–‘e
(
»disDb
 *
db
, 
robj
 *
key
);

1725 
	`dbD–‘e
(
»disDb
 *
db
, 
robj
 *
key
);

1726 
robj
 *
	`dbUnsh¬eSŒšgV®ue
(
»disDb
 *
db
,„obj *
key
,„obj *
o
);

1728 
	#EMPTYDB_NO_FLAGS
 0

	)

1729 
	#EMPTYDB_ASYNC
 (1<<0è

	)

1730 
	`em±yDb
(
dbnum
, 
æags
, (
ÿÎback
)(*));

1732 
	`£ËùDb
(
ş›Á
 *
c
, 
id
);

1733 
	`sigÇlModif›dKey
(
»disDb
 *
db
, 
robj
 *
key
);

1734 
	`sigÇlFlushedDb
(
dbid
);

1735 
	`g‘KeysInSlÙ
(
hash¦Ù
, 
robj
 **
keys
, 
couÁ
);

1736 
	`couÁKeysInSlÙ
(
hash¦Ù
);

1737 
	`d–KeysInSlÙ
(
hash¦Ù
);

1738 
	`v”ifyClu¡”CÚfigW™hD©a
();

1739 
	`sÿnG’”icCommªd
(
ş›Á
 *
c
, 
robj
 *
o
, 
cursÜ
);

1740 
	`·r£SÿnCursÜOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
cursÜ
);

1741 
	`¦ÙToKeyAdd
(
robj
 *
key
);

1742 
	`¦ÙToKeyD–
(
robj
 *
key
);

1743 
	`¦ÙToKeyFlush
();

1744 
	`dbAsyncD–‘e
(
»disDb
 *
db
, 
robj
 *
key
);

1745 
	`em±yDbAsync
(
»disDb
 *
db
);

1746 
	`¦ÙToKeyFlushAsync
();

1747 
size_t
 
	`Ïzyä“G‘P’dšgObjeùsCouÁ
();

1750 *
	`g‘KeysFromCommªd
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

1751 
	`g‘KeysF»eResuÉ
(*
»suÉ
);

1752 *
	`zuniÚIÁ”G‘Keys
(
»disCommªd
 *
cmd
,
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

1753 *
	`ev®G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

1754 *
	`sÜtG‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

1755 *
	`mig¿‹G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

1756 *
	`geÜadiusG‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

1759 
	`şu¡”In™
();

1760 
	`üc16
(cÚ¡ *
buf
, 
Ën
);

1761 
	`keyHashSlÙ
(*
key
, 
keyËn
);

1762 
	`şu¡”CrÚ
();

1763 
	`şu¡”Prİag©ePublish
(
robj
 *
chªÃl
,„obj *
mes§ge
);

1764 
	`mig¿‹Clo£TimedoutSock‘s
();

1765 
	`şu¡”BefÜeSË•
();

1768 
	`š™S’tš–CÚfig
();

1769 
	`š™S’tš–
();

1770 
	`£Áš–Tim”
();

1771 *
	`£Áš–HªdËCÚfigu¿tiÚ
(**
¬gv
, 
¬gc
);

1772 
	`£Áš–IsRuÂšg
();

1775 
	`»dis_check_rdb
(*
rdbf’ame
, 
FILE
 *
å
);

1776 
	`»dis_check_rdb_maš
(
¬gc
, **
¬gv
, 
FILE
 *
å
);

1777 
	`»dis_check_aof_maš
(
¬gc
, **
¬gv
);

1780 
	`sütšgIn™
(
£tup
);

1781 
	`ldbRemoveChd
(
pid_t
 
pid
);

1782 
	`ldbKlFÜkedSessiÚs
();

1783 
	`ldbP’dšgChd»n
();

1786 
	`´oûssUnblockedCl›Ás
();

1787 
	`blockCl›Á
(
ş›Á
 *
c
, 
bty³
);

1788 
	`unblockCl›Á
(
ş›Á
 *
c
);

1789 
	`»¶yToBlockedCl›ÁTimedOut
(
ş›Á
 *
c
);

1790 
	`g‘TimeoutFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
objeù
, 
m¡ime_t
 *
timeout
, 
un™
);

1791 
	`discÚÃùAÎBlockedCl›Ás
();

1794 
	`aùiveExpœeCyşe
(
ty³
);

1795 
	`expœeSÏveKeys
();

1796 
	`»memb”SÏveKeyW™hExpœe
(
»disDb
 *
db
, 
robj
 *
key
);

1797 
	`æushSÏveKeysW™hExpœeLi¡
();

1798 
size_t
 
	`g‘SÏveKeyW™hExpœeCouÁ
();

1801 
	`eviùiÚPoŞAÎoc
();

1802 
	#LFU_INIT_VAL
 5

	)

1803 
	`LFUG‘TimeInMšu‹s
();

1804 
ušt8_t
 
	`LFULogInü
(ušt8_ˆ
v®ue
);

1807 
ušt64_t
 
	`diùSdsHash
(cÚ¡ *
key
);

1808 
	`diùSdsKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
);

1809 
	`diùSdsDe¡ruùÜ
(*
´ivd©a
, *
v®
);

1812 *
	`»disG™SHA1
();

1813 *
	`»disG™Dœty
();

1814 
ušt64_t
 
	`»disBudId
();

1817 
	`authCommªd
(
ş›Á
 *
c
);

1818 
	`pšgCommªd
(
ş›Á
 *
c
);

1819 
	`echoCommªd
(
ş›Á
 *
c
);

1820 
	`commªdCommªd
(
ş›Á
 *
c
);

1821 
	`£tCommªd
(
ş›Á
 *
c
);

1822 
	`£ŠxCommªd
(
ş›Á
 *
c
);

1823 
	`£‹xCommªd
(
ş›Á
 *
c
);

1824 
	`p£‹xCommªd
(
ş›Á
 *
c
);

1825 
	`g‘Commªd
(
ş›Á
 *
c
);

1826 
	`d–Commªd
(
ş›Á
 *
c
);

1827 
	`uÆškCommªd
(
ş›Á
 *
c
);

1828 
	`exi¡sCommªd
(
ş›Á
 *
c
);

1829 
	`£tb™Commªd
(
ş›Á
 *
c
);

1830 
	`g‘b™Commªd
(
ş›Á
 *
c
);

1831 
	`b™f›ldCommªd
(
ş›Á
 *
c
);

1832 
	`£ŒªgeCommªd
(
ş›Á
 *
c
);

1833 
	`g‘¿ngeCommªd
(
ş›Á
 *
c
);

1834 
	`šüCommªd
(
ş›Á
 *
c
);

1835 
	`deüCommªd
(
ş›Á
 *
c
);

1836 
	`šübyCommªd
(
ş›Á
 *
c
);

1837 
	`deübyCommªd
(
ş›Á
 *
c
);

1838 
	`šübyæßtCommªd
(
ş›Á
 *
c
);

1839 
	`£ËùCommªd
(
ş›Á
 *
c
);

1840 
	`sw­dbCommªd
(
ş›Á
 *
c
);

1841 
	`¿ndomkeyCommªd
(
ş›Á
 *
c
);

1842 
	`keysCommªd
(
ş›Á
 *
c
);

1843 
	`sÿnCommªd
(
ş›Á
 *
c
);

1844 
	`dbsizeCommªd
(
ş›Á
 *
c
);

1845 
	`Ï¡§veCommªd
(
ş›Á
 *
c
);

1846 
	`§veCommªd
(
ş›Á
 *
c
);

1847 
	`bg§veCommªd
(
ş›Á
 *
c
);

1848 
	`bg»wr™—ofCommªd
(
ş›Á
 *
c
);

1849 
	`shutdownCommªd
(
ş›Á
 *
c
);

1850 
	`moveCommªd
(
ş›Á
 *
c
);

1851 
	`»ÇmeCommªd
(
ş›Á
 *
c
);

1852 
	`»Çm’xCommªd
(
ş›Á
 *
c
);

1853 
	`ÍushCommªd
(
ş›Á
 *
c
);

1854 
	`½ushCommªd
(
ş›Á
 *
c
);

1855 
	`ÍushxCommªd
(
ş›Á
 *
c
);

1856 
	`½ushxCommªd
(
ş›Á
 *
c
);

1857 
	`lš£¹Commªd
(
ş›Á
 *
c
);

1858 
	`ÍİCommªd
(
ş›Á
 *
c
);

1859 
	`½İCommªd
(
ş›Á
 *
c
);

1860 
	`Î’Commªd
(
ş›Á
 *
c
);

1861 
	`lšdexCommªd
(
ş›Á
 *
c
);

1862 
	`ÌªgeCommªd
(
ş›Á
 *
c
);

1863 
	`ÉrimCommªd
(
ş›Á
 *
c
);

1864 
	`ty³Commªd
(
ş›Á
 *
c
);

1865 
	`l£tCommªd
(
ş›Á
 *
c
);

1866 
	`§ddCommªd
(
ş›Á
 *
c
);

1867 
	`¤emCommªd
(
ş›Á
 *
c
);

1868 
	`smoveCommªd
(
ş›Á
 *
c
);

1869 
	`sismemb”Commªd
(
ş›Á
 *
c
);

1870 
	`sÿrdCommªd
(
ş›Á
 *
c
);

1871 
	`¥İCommªd
(
ş›Á
 *
c
);

1872 
	`¤ªdmemb”Commªd
(
ş›Á
 *
c
);

1873 
	`sš‹rCommªd
(
ş›Á
 *
c
);

1874 
	`sš‹r¡ÜeCommªd
(
ş›Á
 *
c
);

1875 
	`suniÚCommªd
(
ş›Á
 *
c
);

1876 
	`suniÚ¡ÜeCommªd
(
ş›Á
 *
c
);

1877 
	`sdiffCommªd
(
ş›Á
 *
c
);

1878 
	`sdiff¡ÜeCommªd
(
ş›Á
 *
c
);

1879 
	`ssÿnCommªd
(
ş›Á
 *
c
);

1880 
	`syncCommªd
(
ş›Á
 *
c
);

1881 
	`æushdbCommªd
(
ş›Á
 *
c
);

1882 
	`æush®lCommªd
(
ş›Á
 *
c
);

1883 
	`sÜtCommªd
(
ş›Á
 *
c
);

1884 
	`ÌemCommªd
(
ş›Á
 *
c
);

1885 
	`½İÍushCommªd
(
ş›Á
 *
c
);

1886 
	`šfoCommªd
(
ş›Á
 *
c
);

1887 
	`mg‘Commªd
(
ş›Á
 *
c
);

1888 
	`mÚ™ÜCommªd
(
ş›Á
 *
c
);

1889 
	`expœeCommªd
(
ş›Á
 *
c
);

1890 
	`expœ—tCommªd
(
ş›Á
 *
c
);

1891 
	`³xpœeCommªd
(
ş›Á
 *
c
);

1892 
	`³xpœ—tCommªd
(
ş›Á
 *
c
);

1893 
	`g‘£tCommªd
(
ş›Á
 *
c
);

1894 
	`‰lCommªd
(
ş›Á
 *
c
);

1895 
	`touchCommªd
(
ş›Á
 *
c
);

1896 
	`±Commªd
(
ş›Á
 *
c
);

1897 
	`³rsi¡Commªd
(
ş›Á
 *
c
);

1898 
	`¦aveofCommªd
(
ş›Á
 *
c
);

1899 
	`rŞeCommªd
(
ş›Á
 *
c
);

1900 
	`debugCommªd
(
ş›Á
 *
c
);

1901 
	`m£tCommªd
(
ş›Á
 *
c
);

1902 
	`m£ŠxCommªd
(
ş›Á
 *
c
);

1903 
	`zaddCommªd
(
ş›Á
 *
c
);

1904 
	`zšübyCommªd
(
ş›Á
 *
c
);

1905 
	`z¿ngeCommªd
(
ş›Á
 *
c
);

1906 
	`z¿ngebyscÜeCommªd
(
ş›Á
 *
c
);

1907 
	`z»v¿ngebyscÜeCommªd
(
ş›Á
 *
c
);

1908 
	`z¿ngebyËxCommªd
(
ş›Á
 *
c
);

1909 
	`z»v¿ngebyËxCommªd
(
ş›Á
 *
c
);

1910 
	`zcouÁCommªd
(
ş›Á
 *
c
);

1911 
	`zËxcouÁCommªd
(
ş›Á
 *
c
);

1912 
	`z»v¿ngeCommªd
(
ş›Á
 *
c
);

1913 
	`zÿrdCommªd
(
ş›Á
 *
c
);

1914 
	`z»mCommªd
(
ş›Á
 *
c
);

1915 
	`zscÜeCommªd
(
ş›Á
 *
c
);

1916 
	`z»m¿ngebyscÜeCommªd
(
ş›Á
 *
c
);

1917 
	`z»m¿ngebyËxCommªd
(
ş›Á
 *
c
);

1918 
	`muÉiCommªd
(
ş›Á
 *
c
);

1919 
	`execCommªd
(
ş›Á
 *
c
);

1920 
	`disÿrdCommªd
(
ş›Á
 *
c
);

1921 
	`bÍİCommªd
(
ş›Á
 *
c
);

1922 
	`b½İCommªd
(
ş›Á
 *
c
);

1923 
	`b½İÍushCommªd
(
ş›Á
 *
c
);

1924 
	`­³ndCommªd
(
ş›Á
 *
c
);

1925 
	`¡¾’Commªd
(
ş›Á
 *
c
);

1926 
	`z¿nkCommªd
(
ş›Á
 *
c
);

1927 
	`z»v¿nkCommªd
(
ş›Á
 *
c
);

1928 
	`h£tCommªd
(
ş›Á
 *
c
);

1929 
	`h£ŠxCommªd
(
ş›Á
 *
c
);

1930 
	`hg‘Commªd
(
ş›Á
 *
c
);

1931 
	`hm£tCommªd
(
ş›Á
 *
c
);

1932 
	`hmg‘Commªd
(
ş›Á
 *
c
);

1933 
	`hd–Commªd
(
ş›Á
 *
c
);

1934 
	`hËnCommªd
(
ş›Á
 *
c
);

1935 
	`h¡¾’Commªd
(
ş›Á
 *
c
);

1936 
	`z»m¿ngeby¿nkCommªd
(
ş›Á
 *
c
);

1937 
	`zuniÚ¡ÜeCommªd
(
ş›Á
 *
c
);

1938 
	`zš‹r¡ÜeCommªd
(
ş›Á
 *
c
);

1939 
	`zsÿnCommªd
(
ş›Á
 *
c
);

1940 
	`hkeysCommªd
(
ş›Á
 *
c
);

1941 
	`hv®sCommªd
(
ş›Á
 *
c
);

1942 
	`hg‘®lCommªd
(
ş›Á
 *
c
);

1943 
	`hexi¡sCommªd
(
ş›Á
 *
c
);

1944 
	`hsÿnCommªd
(
ş›Á
 *
c
);

1945 
	`cÚfigCommªd
(
ş›Á
 *
c
);

1946 
	`hšübyCommªd
(
ş›Á
 *
c
);

1947 
	`hšübyæßtCommªd
(
ş›Á
 *
c
);

1948 
	`subsüibeCommªd
(
ş›Á
 *
c
);

1949 
	`unsubsüibeCommªd
(
ş›Á
 *
c
);

1950 
	`psubsüibeCommªd
(
ş›Á
 *
c
);

1951 
	`punsubsüibeCommªd
(
ş›Á
 *
c
);

1952 
	`publishCommªd
(
ş›Á
 *
c
);

1953 
	`pubsubCommªd
(
ş›Á
 *
c
);

1954 
	`w©chCommªd
(
ş›Á
 *
c
);

1955 
	`unw©chCommªd
(
ş›Á
 *
c
);

1956 
	`şu¡”Commªd
(
ş›Á
 *
c
);

1957 
	`»¡ÜeCommªd
(
ş›Á
 *
c
);

1958 
	`mig¿‹Commªd
(
ş›Á
 *
c
);

1959 
	`askšgCommªd
(
ş›Á
 *
c
);

1960 
	`»adÚlyCommªd
(
ş›Á
 *
c
);

1961 
	`»adwr™eCommªd
(
ş›Á
 *
c
);

1962 
	`dumpCommªd
(
ş›Á
 *
c
);

1963 
	`objeùCommªd
(
ş›Á
 *
c
);

1964 
	`memÜyCommªd
(
ş›Á
 *
c
);

1965 
	`ş›ÁCommªd
(
ş›Á
 *
c
);

1966 
	`ev®Commªd
(
ş›Á
 *
c
);

1967 
	`ev®ShaCommªd
(
ş›Á
 *
c
);

1968 
	`sütCommªd
(
ş›Á
 *
c
);

1969 
	`timeCommªd
(
ş›Á
 *
c
);

1970 
	`b™İCommªd
(
ş›Á
 *
c
);

1971 
	`b™couÁCommªd
(
ş›Á
 *
c
);

1972 
	`b™posCommªd
(
ş›Á
 *
c
);

1973 
	`»¶cÚfCommªd
(
ş›Á
 *
c
);

1974 
	`wa™Commªd
(
ş›Á
 *
c
);

1975 
	`geÛncodeCommªd
(
ş›Á
 *
c
);

1976 
	`geodecodeCommªd
(
ş›Á
 *
c
);

1977 
	`geÜadiusbymemb”Commªd
(
ş›Á
 *
c
);

1978 
	`geÜadiusbymemb”roCommªd
(
ş›Á
 *
c
);

1979 
	`geÜadiusCommªd
(
ş›Á
 *
c
);

1980 
	`geÜadiu¤oCommªd
(
ş›Á
 *
c
);

1981 
	`geßddCommªd
(
ş›Á
 *
c
);

1982 
	`geohashCommªd
(
ş›Á
 *
c
);

1983 
	`geİosCommªd
(
ş›Á
 *
c
);

1984 
	`geodi¡Commªd
(
ş›Á
 *
c
);

1985 
	`pf£láe¡Commªd
(
ş›Á
 *
c
);

1986 
	`pçddCommªd
(
ş›Á
 *
c
);

1987 
	`pfcouÁCommªd
(
ş›Á
 *
c
);

1988 
	`pfm”geCommªd
(
ş›Á
 *
c
);

1989 
	`pfdebugCommªd
(
ş›Á
 *
c
);

1990 
	`Ï‹ncyCommªd
(
ş›Á
 *
c
);

1991 
	`moduËCommªd
(
ş›Á
 *
c
);

1992 
	`£cur™yW¬nšgCommªd
(
ş›Á
 *
c
);

1994 #ià
	`defšed
(
__GNUC__
)

1995 *
	$ÿÎoc
(
size_t
 
couÁ
, size_ˆ
size
è
	`__©Œibu‹__
 ((
d•»ÿ‹d
));

1996 
	$ä“
(*
±r
è
	`__©Œibu‹__
 ((
d•»ÿ‹d
));

1997 *
	$m®loc
(
size_t
 
size
è
	`__©Œibu‹__
 ((
d•»ÿ‹d
));

1998 *
	$»®loc
(*
±r
, 
size_t
 
size
è
	`__©Œibu‹__
 ((
d•»ÿ‹d
));

2002 
	`_£rv”As£¹W™hInfo
(cÚ¡ 
ş›Á
 *
c
, cÚ¡ 
robj
 *
o
, cÚ¡ *
e¡r
, cÚ¡ *
fe
, 
lše
);

2003 
	`_£rv”As£¹
(cÚ¡ *
e¡r
, cÚ¡ *
fe
, 
lše
);

2004 
	`_£rv”Pªic
(cÚ¡ *
fe
, 
lše
, cÚ¡ *
msg
, ...);

2005 
	`bugR•ÜtS¹
();

2006 
	`£rv”LogObjeùDebugInfo
(cÚ¡ 
robj
 *
o
);

2007 
	`sig£gvHªdËr
(
sig
, 
sigšfo_t
 *
šfo
, *
£ü‘
);

2008 
sds
 
	`g’RedisInfoSŒšg
(*
£ùiÚ
);

2009 
	`’abËW©chdog
(
³riod
);

2010 
	`di§bËW©chdog
();

2011 
	`w©chdogScheduËSigÇl
(
³riod
);

2012 
	`£rv”LogHexDump
(
Ëv–
, *
desü
, *
v®ue
, 
size_t
 
Ën
);

2013 
	`mem‹¡_´e£rvšg_‹¡
(*
m
, 
size_t
 
by‹s
, 
·s£s
);

2014 
	`mixDige¡
(*
dige¡
, *
±r
, 
size_t
 
Ën
);

2015 
	`xÜDige¡
(*
dige¡
, *
±r
, 
size_t
 
Ën
);

2017 
	#»disDebug
(
fmt
, ...) \

2018 
	`´štf
("DEBUG %s:%d > " 
fmt
 "\n", 
__FILE__
, 
__LINE__
, 
__VA_ARGS__
)

	)

2019 
	#»disDebugM¬k
() \

2020 
	`´štf
("-- MARK %s:%d --\n", 
__FILE__
, 
__LINE__
)

	)

	@setproctitle.c

28 #iâdeà
_GNU_SOURCE


29 
	#_GNU_SOURCE


	)

32 
	~<¡ddef.h
>

33 
	~<¡d¬g.h
>

34 
	~<¡dlib.h
>

35 
	~<¡dio.h
>

37 
	~<¡ršg.h
>

39 
	~<”ºo.h
>

41 #ià!
defšed
(
HAVE_SETPROCTITLE
)

42 
	#HAVE_SETPROCTITLE
 (
defšed
 
__N‘BSD__
 || defšed 
__F»eBSD__
 || defšed 
__O³nBSD__
)

	)

46 #ià!
HAVE_SETPROCTITLE


47 #ià(
defšed
 
__lšux
 || defšed 
__APPLE__
)

49 **
’vœÚ
;

53 cÚ¡ *
	m¬g0
;

56 *
	mba£
, *
	m’d
;

59 *
	mnul
;

61 
_BoŞ
 
	m»£t
;

62 
	m”rÜ
;

63 } 
	gSPT
;

66 #iâdeà
SPT_MIN


67 
	#SPT_MIN
(
a
, 
b
è((×è< (b))? (aè: (b))

	)

70 
šlše
 
size_t
 
	$¥t_mš
(
size_t
 
a
, size_ˆ
b
) {

71  
	`SPT_MIN
(
a
, 
b
);

72 
	}
}

79 
	$¥t_ş—»nv
() {

80 #ià
__GLIBC__


81 
	`ş—»nv
();

85 **
’vœÚ
;

86 **
tmp
;

88 ià(!(
tmp
 = 
	`m®loc
( *tmp)))

89  
”ºo
;

91 
tmp
[0] = 
NULL
;

92 
’vœÚ
 = 
tmp
;

96 
	}
}

99 
	$¥t_cİy’v
(*
Şd’v
[]) {

100 **
’vœÚ
;

101 *
eq
;

102 
i
, 
”rÜ
;

104 ià(
’vœÚ
 !ğ
Şd’v
)

107 ià((
”rÜ
 = 
	`¥t_ş—»nv
()))

108 
”rÜ
;

110 
i
 = 0; 
Şd’v
[i]; i++) {

111 ià(!(
eq
 = 
	`¡rchr
(
Şd’v
[
i
], '=')))

114 *
eq
 = '\0';

115 
”rÜ
 = (0 !ğ
	`£‹nv
(
Şd’v
[
i
], 
eq
 + 1, 1))? 
”ºo
 : 0;

116 *
eq
 = '=';

118 ià(
”rÜ
)

119 
”rÜ
;

123 
”rÜ
:

124 
’vœÚ
 = 
Şd’v
;

126  
”rÜ
;

127 
	}
}

130 
	$¥t_cİy¬gs
(
¬gc
, *
¬gv
[]) {

131 *
tmp
;

132 
i
;

134 
i
 = 1; i < 
¬gc
 || (˜>ğ¬gø&& 
¬gv
[i]); i++) {

135 ià(!
¬gv
[
i
])

138 ià(!(
tmp
 = 
	`¡rdup
(
¬gv
[
i
])))

139  
”ºo
;

141 
¬gv
[
i
] = 
tmp
;

145 
	}
}

148 
	$¥t_š™
(
¬gc
, *
¬gv
[]) {

149 **
’vp
 = 
’vœÚ
;

150 *
ba£
, *
’d
, *
nul
, *
tmp
;

151 
i
, 
”rÜ
;

153 ià(!(
ba£
 = 
¬gv
[0]))

156 
nul
 = &
ba£
[
	`¡¾’
(base)];

157 
’d
 = 
nul
 + 1;

159 
i
 = 0; i < 
¬gc
 || (˜>ğ¬gø&& 
¬gv
[i]); i++) {

160 ià(!
¬gv
[
i
] ||‡rgv[i] < 
’d
)

163 
’d
 = 
¬gv
[
i
] + 
	`¡¾’
(argv[i]) + 1;

166 
i
 = 0; 
’vp
[i]; i++) {

167 ià(
’vp
[
i
] < 
’d
)

170 
’d
 = 
’vp
[
i
] + 
	`¡¾’
(envp[i]) + 1;

173 ià(!(
SPT
.
¬g0
 = 
	`¡rdup
(
¬gv
[0])))

174 
sy”r
;

176 #ià
__GLIBC__


177 ià(!(
tmp
 = 
	`¡rdup
(
´og¿m_švoÿtiÚ_Çme
)))

178 
sy”r
;

180 
´og¿m_švoÿtiÚ_Çme
 = 
tmp
;

182 ià(!(
tmp
 = 
	`¡rdup
(
´og¿m_švoÿtiÚ_shÜt_Çme
)))

183 
sy”r
;

185 
´og¿m_švoÿtiÚ_shÜt_Çme
 = 
tmp
;

186 #–ià
__APPLE__


187 ià(!(
tmp
 = 
	`¡rdup
(
	`g‘´ogÇme
())))

188 
sy”r
;

190 
	`£rogÇme
(
tmp
);

194 ià((
”rÜ
 = 
	`¥t_cİy’v
(
’vp
)))

195 
”rÜ
;

197 ià((
”rÜ
 = 
	`¥t_cİy¬gs
(
¬gc
, 
¬gv
)))

198 
”rÜ
;

200 
SPT
.
nul
 =‚ul;

201 
SPT
.
ba£
 = base;

202 
SPT
.
’d
 =ƒnd;

205 
sy”r
:

206 
”rÜ
 = 
”ºo
;

207 
”rÜ
:

208 
SPT
.
”rÜ
 =ƒrror;

209 
	}
}

212 #iâdeà
SPT_MAXTITLE


213 
	#SPT_MAXTITLE
 255

	)

216 
	$£roù™Ë
(cÚ¡ *
fmt
, ...) {

217 
buf
[
SPT_MAXTITLE
 + 1];

218 
va_li¡
 
­
;

219 *
nul
;

220 
Ën
, 
”rÜ
;

222 ià(!
SPT
.
ba£
)

225 ià(
fmt
) {

226 
	`va_¡¬t
(
­
, 
fmt
);

227 
Ën
 = 
	`v¢´štf
(
buf
,  buf, 
fmt
, 
­
);

228 
	`va_’d
(
­
);

230 
Ën
 = 
	`¢´štf
(
buf
,  buf, "%s", 
SPT
.
¬g0
);

233 ià(
Ën
 <= 0)

234 { 
”rÜ
 = 
”ºo
; error; }

236 ià(!
SPT
.
»£t
) {

237 
	`mem£t
(
SPT
.
ba£
, 0, SPT.
’d
 - SPT.base);

238 
SPT
.
»£t
 = 1;

240 
	`mem£t
(
SPT
.
ba£
, 0, 
	`¥t_mš
( 
buf
, SPT.
’d
 - SPT.base));

243 
Ën
 = 
	`¥t_mš
Ö’, s±_mš( 
buf
, 
SPT
.
’d
 - SPT.
ba£
) - 1);

244 
	`memıy
(
SPT
.
ba£
, 
buf
, 
Ën
);

245 
nul
 = &
SPT
.
ba£
[
Ën
];

247 ià(
nul
 < 
SPT
.nul) {

248 *
SPT
.
nul
 = '.';

249 } ià(
nul
 =ğ
SPT
.nuÈ&& &nul[1] < SPT.
’d
) {

250 *
SPT
.
nul
 = ' ';

251 *++
nul
 = '\0';

255 
”rÜ
:

256 
SPT
.
”rÜ
 =ƒrror;

257 
	}
}

	@sha1.c

22 
	#SHA1HANDSOFF


	)

24 
	~<¡dio.h
>

25 
	~<¡ršg.h
>

26 
	~<¡dšt.h
>

27 
	~"sŞ¬isfixes.h
"

28 
	~"sha1.h
"

29 
	~"cÚfig.h
"

31 
	#rŞ
(
v®ue
, 
b™s
è(((v®ueè<< (b™s)è| ((v®ueè>> (32 - (b™s))))

	)

35 #ià
BYTE_ORDER
 =ğ
LITTLE_ENDIAN


36 
	#blk0
(
i
è(
block
->
l
[i] = (
	`rŞ
(block->l[i],24)&0xFF00FF00) \

37 |(
	`rŞ
(
block
->
l
[
i
],8)&0x00FF00FF))

	)

38 #–ià
BYTE_ORDER
 =ğ
BIG_ENDIAN


39 
	#blk0
(
i
è
block
->
l
[i]

	)

43 
	#blk
(
i
è(
block
->
l
[i&15] = 
	`rŞ
(block->l[(i+13)&15]^block->l[(i+8)&15] \

44 ^
block
->
l
[(
i
+2)&15]^block->l[i&15],1))

	)

47 
	#R0
(
v
,
w
,
x
,
y
,
z
,
i
èz+=((w&(x^y))^y)+
	`blk0
(i)+0x5A827999+
	`rŞ
(v,5);wôŞ(w,30);

	)

48 
	#R1
(
v
,
w
,
x
,
y
,
z
,
i
èz+=((w&(x^y))^y)+
	`blk
(i)+0x5A827999+
	`rŞ
(v,5);wôŞ(w,30);

	)

49 
	#R2
(
v
,
w
,
x
,
y
,
z
,
i
èz+=(w^x^y)+
	`blk
(i)+0x6ED9EBA1+
	`rŞ
(v,5);wôŞ(w,30);

	)

50 
	#R3
(
v
,
w
,
x
,
y
,
z
,
i
èz+=(((w|x)&y)|(w&x))+
	`blk
(i)+0x8F1BBCDC+
	`rŞ
(v,5);wôŞ(w,30);

	)

51 
	#R4
(
v
,
w
,
x
,
y
,
z
,
i
èz+=(w^x^y)+
	`blk
(i)+0xCA62C1D6+
	`rŞ
(v,5);wôŞ(w,30);

	)

56 
	$SHA1T¿nsfÜm
(
ušt32_t
 
¡©e
[5], cÚ¡ 
bufãr
[64])

58 
ušt32_t
 
a
, 
b
, 
c
, 
d
, 
e
;

60 
c
[64];

61 
ušt32_t
 
l
[16];

62 } 
	tCHAR64LONG16
;

63 #ifdeà
SHA1HANDSOFF


64 
CHAR64LONG16
 
block
[1];

65 
	`memıy
(
block
, 
bufãr
, 64);

72 
CHAR64LONG16
* 
block
 = (cÚ¡ CHAR64LONG16*)
bufãr
;

75 
a
 = 
¡©e
[0];

76 
b
 = 
¡©e
[1];

77 
c
 = 
¡©e
[2];

78 
d
 = 
¡©e
[3];

79 
e
 = 
¡©e
[4];

81 
	`R0
(
a
,
b
,
c
,
d
,
e
, 0); R0(e,a,b,c,d, 1); R0(d,e,a,b,c, 2); R0(c,d,e,a,b, 3);

82 
	`R0
(
b
,
c
,
d
,
e
,
a
, 4); R0(a,b,c,d,e, 5); R0(e,a,b,c,d, 6); R0(d,e,a,b,c, 7);

83 
	`R0
(
c
,
d
,
e
,
a
,
b
, 8); R0(b,c,d,e,a, 9); R0(a,b,c,d,e,10); R0(e,a,b,c,d,11);

84 
	`R0
(
d
,
e
,
a
,
b
,
c
,12); R0(c,d,e,a,b,13); R0(b,c,d,e,a,14); R0(a,b,c,d,e,15);

85 
	`R1
(
e
,
a
,
b
,
c
,
d
,16); R1(d,e,a,b,c,17); R1(c,d,e,a,b,18); R1(b,c,d,e,a,19);

86 
	`R2
(
a
,
b
,
c
,
d
,
e
,20); R2(e,a,b,c,d,21); R2(d,e,a,b,c,22); R2(c,d,e,a,b,23);

87 
	`R2
(
b
,
c
,
d
,
e
,
a
,24); R2(a,b,c,d,e,25); R2(e,a,b,c,d,26); R2(d,e,a,b,c,27);

88 
	`R2
(
c
,
d
,
e
,
a
,
b
,28); R2(b,c,d,e,a,29); R2(a,b,c,d,e,30); R2(e,a,b,c,d,31);

89 
	`R2
(
d
,
e
,
a
,
b
,
c
,32); R2(c,d,e,a,b,33); R2(b,c,d,e,a,34); R2(a,b,c,d,e,35);

90 
	`R2
(
e
,
a
,
b
,
c
,
d
,36); R2(d,e,a,b,c,37); R2(c,d,e,a,b,38); R2(b,c,d,e,a,39);

91 
	`R3
(
a
,
b
,
c
,
d
,
e
,40); R3(e,a,b,c,d,41); R3(d,e,a,b,c,42); R3(c,d,e,a,b,43);

92 
	`R3
(
b
,
c
,
d
,
e
,
a
,44); R3(a,b,c,d,e,45); R3(e,a,b,c,d,46); R3(d,e,a,b,c,47);

93 
	`R3
(
c
,
d
,
e
,
a
,
b
,48); R3(b,c,d,e,a,49); R3(a,b,c,d,e,50); R3(e,a,b,c,d,51);

94 
	`R3
(
d
,
e
,
a
,
b
,
c
,52); R3(c,d,e,a,b,53); R3(b,c,d,e,a,54); R3(a,b,c,d,e,55);

95 
	`R3
(
e
,
a
,
b
,
c
,
d
,56); R3(d,e,a,b,c,57); R3(c,d,e,a,b,58); R3(b,c,d,e,a,59);

96 
	`R4
(
a
,
b
,
c
,
d
,
e
,60); R4(e,a,b,c,d,61); R4(d,e,a,b,c,62); R4(c,d,e,a,b,63);

97 
	`R4
(
b
,
c
,
d
,
e
,
a
,64); R4(a,b,c,d,e,65); R4(e,a,b,c,d,66); R4(d,e,a,b,c,67);

98 
	`R4
(
c
,
d
,
e
,
a
,
b
,68); R4(b,c,d,e,a,69); R4(a,b,c,d,e,70); R4(e,a,b,c,d,71);

99 
	`R4
(
d
,
e
,
a
,
b
,
c
,72); R4(c,d,e,a,b,73); R4(b,c,d,e,a,74); R4(a,b,c,d,e,75);

100 
	`R4
(
e
,
a
,
b
,
c
,
d
,76); R4(d,e,a,b,c,77); R4(c,d,e,a,b,78); R4(b,c,d,e,a,79);

102 
¡©e
[0] +ğ
a
;

103 
¡©e
[1] +ğ
b
;

104 
¡©e
[2] +ğ
c
;

105 
¡©e
[3] +ğ
d
;

106 
¡©e
[4] +ğ
e
;

108 
a
 = 
b
 = 
c
 = 
d
 = 
e
 = 0;

109 #ifdeà
SHA1HANDSOFF


110 
	`mem£t
(
block
, '\0', (block));

112 
	}
}

117 
	$SHA1In™
(
SHA1_CTX
* 
cÚ‹xt
)

120 
cÚ‹xt
->
¡©e
[0] = 0x67452301;

121 
cÚ‹xt
->
¡©e
[1] = 0xEFCDAB89;

122 
cÚ‹xt
->
¡©e
[2] = 0x98BADCFE;

123 
cÚ‹xt
->
¡©e
[3] = 0x10325476;

124 
cÚ‹xt
->
¡©e
[4] = 0xC3D2E1F0;

125 
cÚ‹xt
->
couÁ
[0] = context->count[1] = 0;

126 
	}
}

131 
	$SHA1Upd©e
(
SHA1_CTX
* 
cÚ‹xt
, cÚ¡ * 
d©a
, 
ušt32_t
 
Ën
)

133 
ušt32_t
 
i
, 
j
;

135 
j
 = 
cÚ‹xt
->
couÁ
[0];

136 ià((
cÚ‹xt
->
couÁ
[0] +ğ
Ën
 << 3è< 
j
)

137 
cÚ‹xt
->
couÁ
[1]++;

138 
cÚ‹xt
->
couÁ
[1] +ğ(
Ën
>>29);

139 
j
 = (j >> 3) & 63;

140 ià((
j
 + 
Ën
) > 63) {

141 
	`memıy
(&
cÚ‹xt
->
bufãr
[
j
], 
d©a
, (
i
 = 64-j));

142 
	`SHA1T¿nsfÜm
(
cÚ‹xt
->
¡©e
, cÚ‹xt->
bufãr
);

143  ; 
i
 + 63 < 
Ën
; i += 64) {

144 
	`SHA1T¿nsfÜm
(
cÚ‹xt
->
¡©e
, &
d©a
[
i
]);

146 
j
 = 0;

148 
i
 = 0;

149 
	`memıy
(&
cÚ‹xt
->
bufãr
[
j
], &
d©a
[
i
], 
Ën
 - i);

150 
	}
}

155 
	$SHA1Fš®
(
dige¡
[20], 
SHA1_CTX
* 
cÚ‹xt
)

157 
i
;

158 
fš®couÁ
[8];

159 
c
;

167 *
fı
 = &
fš®couÁ
[8];

169 
i
 = 0; i < 2; i++)

171 
ušt32_t
 
t
 = 
cÚ‹xt
->
couÁ
[
i
];

172 
j
;

174 
j
 = 0; j < 4; 
t
 >>= 8, j++)

175 *--
fı
 = (è
t
;

178 
i
 = 0; i < 8; i++) {

179 
fš®couÁ
[
i
] = ()((
cÚ‹xt
->
couÁ
[(i >= 4 ? 0 : 1)]

180 >> ((3-(
i
 & 3)) * 8) ) & 255);

183 
c
 = 0200;

184 
	`SHA1Upd©e
(
cÚ‹xt
, &
c
, 1);

185 (
cÚ‹xt
->
couÁ
[0] & 504) != 448) {

186 
c
 = 0000;

187 
	`SHA1Upd©e
(
cÚ‹xt
, &
c
, 1);

189 
	`SHA1Upd©e
(
cÚ‹xt
, 
fš®couÁ
, 8);

190 
i
 = 0; i < 20; i++) {

191 
dige¡
[
i
] = ()

192 ((
cÚ‹xt
->
¡©e
[
i
>>2] >> ((3-(i & 3)) * 8) ) & 255);

195 
	`mem£t
(
cÚ‹xt
, '\0', (*context));

196 
	`mem£t
(&
fš®couÁ
, '\0', (finalcount));

197 
	}
}

200 #ifdeà
REDIS_TEST


201 
	#BUFSIZE
 4096

	)

203 
	#UNUSED
(
x
è()(x)

	)

204 
	$sha1Te¡
(
¬gc
, **
¬gv
)

206 
SHA1_CTX
 
ùx
;

207 
hash
[20], 
buf
[
BUFSIZE
];

208 
i
;

210 
	`UNUSED
(
¬gc
);

211 
	`UNUSED
(
¬gv
);

213 
i
=0;i<
BUFSIZE
;i++)

214 
buf
[
i
] = i;

216 
	`SHA1In™
(&
ùx
);

217 
i
=0;i<1000;i++)

218 
	`SHA1Upd©e
(&
ùx
, 
buf
, 
BUFSIZE
);

219 
	`SHA1Fš®
(
hash
, &
ùx
);

221 
	`´štf
("SHA1=");

222 
i
=0;i<20;i++)

223 
	`´štf
("%02x", 
hash
[
i
]);

224 
	`´štf
("\n");

226 
	}
}

	@sha1.h

1 #iâdeà
SHA1_H


2 
	#SHA1_H


	)

11 
ušt32_t
 
	m¡©e
[5];

12 
ušt32_t
 
	mcouÁ
[2];

13 
	mbufãr
[64];

14 } 
	tSHA1_CTX
;

16 
SHA1T¿nsfÜm
(
ušt32_t
 
¡©e
[5], cÚ¡ 
bufãr
[64]);

17 
SHA1In™
(
SHA1_CTX
* 
cÚ‹xt
);

18 
SHA1Upd©e
(
SHA1_CTX
* 
cÚ‹xt
, cÚ¡ * 
d©a
, 
ušt32_t
 
Ën
);

19 
SHA1Fš®
(
dige¡
[20], 
SHA1_CTX
* 
cÚ‹xt
);

21 #ifdeà
REDIS_TEST


22 
sha1Te¡
(
¬gc
, **
¬gv
);

	@siphash.c

42 
	~<as£¹.h
>

43 
	~<¡dšt.h
>

44 
	~<¡dio.h
>

45 
	~<¡ršg.h
>

46 
	~<ùy³.h
>

50 
	$sw
(
c
) {

51 ià(
c
 >= 'A' && c <= 'Z') {

52  
c
+('a'-'A');

54  
c
;

56 
	}
}

61 #ià
defšed
(
__X86_64__
è|| defšed(
__x86_64__
è|| defšed (
__i386__
)

62 
	#UNALIGNED_LE_CPU


	)

65 
	#ROTL
(
x
, 
b
è(
ušt64_t
)(((xè<< (b)è| ((xè>> (64 - (b))))

	)

67 
	#U32TO8_LE
(
p
, 
v
) \

68 (
p
)[0] = (
ušt8_t
)((
v
)); \

69 (
p
)[1] = (
ušt8_t
)((
v
) >> 8); \

70 (
p
)[2] = (
ušt8_t
)((
v
) >> 16); \

71 (
p
)[3] = (
ušt8_t
)((
v
è>> 24);

	)

73 
	#U64TO8_LE
(
p
, 
v
) \

74 
	`U32TO8_LE
((
p
), (
ušt32_t
)((
v
))); \

75 
	`U32TO8_LE
((
p
è+ 4, (
ušt32_t
)((
v
è>> 32));

	)

77 #ifdeà
UNALIGNED_LE_CPU


78 
	#U8TO64_LE
(
p
è(*((
ušt64_t
*)Õ)))

	)

80 
	#U8TO64_LE
(
p
) \

81 (((
ušt64_t
)((
p
)[0])) | ((uint64_t)((p)[1]) << 8) | \

82 ((
ušt64_t
)((
p
)[2]) << 16) | ((uint64_t)((p)[3]) << 24) | \

83 ((
ušt64_t
)((
p
)[4]) << 32) | ((uint64_t)((p)[5]) << 40) | \

84 ((
ušt64_t
)((
p
)[6]è<< 48è| ((ušt64_t)(Õ)[7]è<< 56))

	)

87 
	#U8TO64_LE_NOCASE
(
p
) \

88 (((
ušt64_t
)(
	`sw
((
p
)[0]))) | \

89 ((
ušt64_t
)(
	`sw
((
p
)[1])) << 8) | \

90 ((
ušt64_t
)(
	`sw
((
p
)[2])) << 16) | \

91 ((
ušt64_t
)(
	`sw
((
p
)[3])) << 24) | \

92 ((
ušt64_t
)(
	`sw
((
p
)[4])) << 32) | \

93 ((
ušt64_t
)(
	`sw
((
p
)[5])) << 40) | \

94 ((
ušt64_t
)(
	`sw
((
p
)[6])) << 48) | \

95 ((
ušt64_t
)(
	`sw
((
p
)[7])è<< 56))

	)

97 
	#SIPROUND
 \

99 
v0
 +ğ
v1
; \

100 
v1
 = 
	`ROTL
(v1, 13); \

101 
v1
 ^ğ
v0
; \

102 
v0
 = 
	`ROTL
(v0, 32); \

103 
v2
 +ğ
v3
; \

104 
v3
 = 
	`ROTL
(v3, 16); \

105 
v3
 ^ğ
v2
; \

106 
v0
 +ğ
v3
; \

107 
v3
 = 
	`ROTL
(v3, 21); \

108 
v3
 ^ğ
v0
; \

109 
v2
 +ğ
v1
; \

110 
v1
 = 
	`ROTL
(v1, 17); \

111 
v1
 ^ğ
v2
; \

112 
v2
 = 
	`ROTL
(v2, 32); \

113 } 0)

	)

115 
ušt64_t
 
	$shash
(cÚ¡ 
ušt8_t
 *
š
, cÚ¡ 
size_t
 
šËn
, cÚ¡ ušt8_ˆ*
k
) {

116 #iâdeà
UNALIGNED_LE_CPU


117 
ušt64_t
 
hash
;

118 
ušt8_t
 *
out
 = (ušt8_t*è&
hash
;

120 
ušt64_t
 
v0
 = 0x736f6d6570736575ULL;

121 
ušt64_t
 
v1
 = 0x646f72616e646f6dULL;

122 
ušt64_t
 
v2
 = 0x6c7967656e657261ULL;

123 
ušt64_t
 
v3
 = 0x7465646279746573ULL;

124 
ušt64_t
 
k0
 = 
	`U8TO64_LE
(
k
);

125 
ušt64_t
 
k1
 = 
	`U8TO64_LE
(
k
 + 8);

126 
ušt64_t
 
m
;

127 cÚ¡ 
ušt8_t
 *
’d
 = 
š
 + 
šËn
 - (šËÀ% (
ušt64_t
));

128 cÚ¡ 
Ëá
 = 
šËn
 & 7;

129 
ušt64_t
 
b
 = ((ušt64_t)
šËn
) << 56;

130 
v3
 ^ğ
k1
;

131 
v2
 ^ğ
k0
;

132 
v1
 ^ğ
k1
;

133 
v0
 ^ğ
k0
;

135 ; 
š
 !ğ
’d
; in += 8) {

136 
m
 = 
	`U8TO64_LE
(
š
);

137 
v3
 ^ğ
m
;

139 
SIPROUND
;

141 
v0
 ^ğ
m
;

144 
Ëá
) {

145 7: 
b
 |ğ((
ušt64_t
)
š
[6]) << 48;

146 6: 
b
 |ğ((
ušt64_t
)
š
[5]) << 40;

147 5: 
b
 |ğ((
ušt64_t
)
š
[4]) << 32;

148 4: 
b
 |ğ((
ušt64_t
)
š
[3]) << 24;

149 3: 
b
 |ğ((
ušt64_t
)
š
[2]) << 16;

150 2: 
b
 |ğ((
ušt64_t
)
š
[1]) << 8;

151 1: 
b
 |ğ((
ušt64_t
)
š
[0]); ;

155 
v3
 ^ğ
b
;

157 
SIPROUND
;

159 
v0
 ^ğ
b
;

160 
v2
 ^= 0xff;

162 
SIPROUND
;

163 
SIPROUND
;

165 
b
 = 
v0
 ^ 
v1
 ^ 
v2
 ^ 
v3
;

166 #iâdeà
UNALIGNED_LE_CPU


167 
	`U64TO8_LE
(
out
, 
b
);

168  
hash
;

170  
b
;

172 
	}
}

174 
ušt64_t
 
	$shash_noÿ£
(cÚ¡ 
ušt8_t
 *
š
, cÚ¡ 
size_t
 
šËn
, cÚ¡ ušt8_ˆ*
k
)

176 #iâdeà
UNALIGNED_LE_CPU


177 
ušt64_t
 
hash
;

178 
ušt8_t
 *
out
 = (ušt8_t*è&
hash
;

180 
ušt64_t
 
v0
 = 0x736f6d6570736575ULL;

181 
ušt64_t
 
v1
 = 0x646f72616e646f6dULL;

182 
ušt64_t
 
v2
 = 0x6c7967656e657261ULL;

183 
ušt64_t
 
v3
 = 0x7465646279746573ULL;

184 
ušt64_t
 
k0
 = 
	`U8TO64_LE
(
k
);

185 
ušt64_t
 
k1
 = 
	`U8TO64_LE
(
k
 + 8);

186 
ušt64_t
 
m
;

187 cÚ¡ 
ušt8_t
 *
’d
 = 
š
 + 
šËn
 - (šËÀ% (
ušt64_t
));

188 cÚ¡ 
Ëá
 = 
šËn
 & 7;

189 
ušt64_t
 
b
 = ((ušt64_t)
šËn
) << 56;

190 
v3
 ^ğ
k1
;

191 
v2
 ^ğ
k0
;

192 
v1
 ^ğ
k1
;

193 
v0
 ^ğ
k0
;

195 ; 
š
 !ğ
’d
; in += 8) {

196 
m
 = 
	`U8TO64_LE_NOCASE
(
š
);

197 
v3
 ^ğ
m
;

199 
SIPROUND
;

201 
v0
 ^ğ
m
;

204 
Ëá
) {

205 7: 
b
 |ğ((
ušt64_t
)
	`sw
(
š
[6])) << 48;

206 6: 
b
 |ğ((
ušt64_t
)
	`sw
(
š
[5])) << 40;

207 5: 
b
 |ğ((
ušt64_t
)
	`sw
(
š
[4])) << 32;

208 4: 
b
 |ğ((
ušt64_t
)
	`sw
(
š
[3])) << 24;

209 3: 
b
 |ğ((
ušt64_t
)
	`sw
(
š
[2])) << 16;

210 2: 
b
 |ğ((
ušt64_t
)
	`sw
(
š
[1])) << 8;

211 1: 
b
 |ğ((
ušt64_t
)
	`sw
(
š
[0])); ;

215 
v3
 ^ğ
b
;

217 
SIPROUND
;

219 
v0
 ^ğ
b
;

220 
v2
 ^= 0xff;

222 
SIPROUND
;

223 
SIPROUND
;

225 
b
 = 
v0
 ^ 
v1
 ^ 
v2
 ^ 
v3
;

226 #iâdeà
UNALIGNED_LE_CPU


227 
	`U64TO8_LE
(
out
, 
b
);

228  
hash
;

230  
b
;

232 
	}
}

237 #ifdeà
SIPHASH_TEST


239 cÚ¡ 
ušt8_t
 
	gveùÜs_s64
[64][8] = {

313 
	$shash_‹¡
() {

314 
ušt8_t
 
š
[64], 
k
[16];

315 
i
;

316 
çs
 = 0;

318 
i
 = 0; i < 16; ++i)

319 
k
[
i
] = i;

321 
i
 = 0; i < 64; ++i) {

322 
š
[
i
] = i;

323 
ušt64_t
 
hash
 = 
	`shash
(
š
, 
i
, 
k
);

324 cÚ¡ 
ušt8_t
 *
v
 = 
NULL
;

325 
v
 = (
ušt8_t
 *)
veùÜs_s64
;

326 ià(
	`memcmp
(&
hash
, 
v
 + (
i
 * 8), 8)) {

328 
çs
++;

333 
ušt64_t
 
h1
, 
h2
;

334 
h1
 = 
	`shash
((
ušt8_t
*)"hello world",11,(uint8_t*)"1234567812345678");

335 
h2
 = 
	`shash_noÿ£
((
ušt8_t
*)"hello world",11,(uint8_t*)"1234567812345678");

336 ià(
h1
 !ğ
h2
è
çs
++;

338 
h1
 = 
	`shash
((
ušt8_t
*)"hello world",11,(uint8_t*)"1234567812345678");

339 
h2
 = 
	`shash_noÿ£
((
ušt8_t
*)"HELLO world",11,(uint8_t*)"1234567812345678");

340 ià(
h1
 !ğ
h2
è
çs
++;

342 
h1
 = 
	`shash
((
ušt8_t
*)"HELLO world",11,(uint8_t*)"1234567812345678");

343 
h2
 = 
	`shash_noÿ£
((
ušt8_t
*)"HELLO world",11,(uint8_t*)"1234567812345678");

344 ià(
h1
 =ğ
h2
è
çs
++;

346 ià(!
çs
)  0;

348 
	}
}

350 
	$maš
() {

351 ià(
	`shash_‹¡
() == 0) {

352 
	`´štf
("SipHashest: OK\n");

355 
	`´štf
("SipHashest: FAILED\n");

358 
	}
}

	@slowlog.c

42 
	~"£rv”.h
"

43 
	~"¦owlog.h
"

48 
¦owlogEÁry
 *
	$¦owlogC»©eEÁry
(
ş›Á
 *
c
, 
robj
 **
¬gv
, 
¬gc
, 
du¿tiÚ
) {

49 
¦owlogEÁry
 *
£
 = 
	`zm®loc
((*se));

50 
j
, 
¦¬gc
 = 
¬gc
;

52 ià(
¦¬gc
 > 
SLOWLOG_ENTRY_MAX_ARGC
) slargc = SLOWLOG_ENTRY_MAX_ARGC;

53 
£
->
¬gc
 = 
¦¬gc
;

54 
£
->
¬gv
 = 
	`zm®loc
((
robj
*)*
¦¬gc
);

55 
j
 = 0; j < 
¦¬gc
; j++) {

59 ià(
¦¬gc
 !ğ
¬gc
 && 
j
 == slargc-1) {

60 
£
->
¬gv
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,

61 
	`sdsÿrštf
(
	`sd£m±y
(),"... (%d more‡rguments)",

62 
¬gc
-
¦¬gc
+1));

65 ià(
¬gv
[
j
]->
ty³
 =ğ
OBJ_STRING
 &&

66 
	`sdsEncodedObjeù
(
¬gv
[
j
]) &&

67 
	`sd¦’
(
¬gv
[
j
]->
±r
è> 
SLOWLOG_ENTRY_MAX_STRING
)

69 
sds
 
s
 = 
	`sd¢ewËn
(
¬gv
[
j
]->
±r
, 
SLOWLOG_ENTRY_MAX_STRING
);

71 
s
 = 
	`sdsÿrštf
(s,"... (%lu more bytes)",

73 
	`sd¦’
(
¬gv
[
j
]->
±r
è- 
SLOWLOG_ENTRY_MAX_STRING
);

74 
£
->
¬gv
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,
s
);

76 
£
->
¬gv
[
j
] =‡rgv[j];

77 
	`šüRefCouÁ
(
¬gv
[
j
]);

81 
£
->
time
 = 
	`time
(
NULL
);

82 
£
->
du¿tiÚ
 = duration;

83 
£
->
id
 = 
£rv”
.
¦owlog_’Œy_id
++;

84 
£
->
³”id
 = 
	`sd¢ew
(
	`g‘Cl›ÁP“rId
(
c
));

85 
£
->
úame
 = 
c
->
Çme
 ? 
	`sd¢ew
(c->Çme->
±r
è: 
	`sd£m±y
();

86  
£
;

87 
	}
}

93 
	$¦owlogF»eEÁry
(*
£±r
) {

94 
¦owlogEÁry
 *
£
 = 
£±r
;

95 
j
;

97 
j
 = 0; j < 
£
->
¬gc
; j++)

98 
	`deüRefCouÁ
(
£
->
¬gv
[
j
]);

99 
	`zä“
(
£
->
¬gv
);

100 
	`sdsä“
(
£
->
³”id
);

101 
	`sdsä“
(
£
->
úame
);

102 
	`zä“
(
£
);

103 
	}
}

107 
	$¦owlogIn™
() {

108 
£rv”
.
¦owlog
 = 
	`li¡C»©e
();

109 
£rv”
.
¦owlog_’Œy_id
 = 0;

110 
	`li¡S‘F»eM‘hod
(
£rv”
.
¦owlog
,
¦owlogF»eEÁry
);

111 
	}
}

116 
	$¦owlogPushEÁryIfN“ded
(
ş›Á
 *
c
, 
robj
 **
¬gv
, 
¬gc
, 
du¿tiÚ
) {

117 ià(
£rv”
.
¦owlog_log_¦ow”_thª
 < 0) ;

118 ià(
du¿tiÚ
 >ğ
£rv”
.
¦owlog_log_¦ow”_thª
)

119 
	`li¡AddNodeH—d
(
£rv”
.
¦owlog
,

120 
	`¦owlogC»©eEÁry
(
c
,
¬gv
,
¬gc
,
du¿tiÚ
));

123 
	`li¡L’gth
(
£rv”
.
¦owlog
è> s”v”.
¦owlog_max_Ën
)

124 
	`li¡D–Node
(
£rv”
.
¦owlog
,
	`li¡La¡
(server.slowlog));

125 
	}
}

128 
	$¦owlogRe£t
() {

129 
	`li¡L’gth
(
£rv”
.
¦owlog
) > 0)

130 
	`li¡D–Node
(
£rv”
.
¦owlog
,
	`li¡La¡
(server.slowlog));

131 
	}
}

135 
	$¦owlogCommªd
(
ş›Á
 *
c
) {

136 ià(
c
->
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"reset")) {

137 
	`¦owlogRe£t
();

138 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

139 } ià(
c
->
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"len")) {

140 
	`addR•lyLÚgLÚg
(
c
,
	`li¡L’gth
(
£rv”
.
¦owlog
));

141 } ià((
c
->
¬gc
 == 2 || c->argc == 3) &&

142 !
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"get"))

144 
couÁ
 = 10, 
£Á
 = 0;

145 
li¡I‹r
 
li
;

146 *
tÙ’Œ›s
;

147 
li¡Node
 *
Ê
;

148 
¦owlogEÁry
 *
£
;

150 ià(
c
->
¬gc
 == 3 &&

151 
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
couÁ
,
NULL
è!ğ
C_OK
)

154 
	`li¡Rewšd
(
£rv”
.
¦owlog
,&
li
);

155 
tÙ’Œ›s
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

156 
couÁ
-- && (
Ê
 = 
	`li¡Next
(&
li
))) {

157 
j
;

159 
£
 = 
Ê
->
v®ue
;

160 
	`addR•lyMuÉiBulkL’
(
c
,6);

161 
	`addR•lyLÚgLÚg
(
c
,
£
->
id
);

162 
	`addR•lyLÚgLÚg
(
c
,
£
->
time
);

163 
	`addR•lyLÚgLÚg
(
c
,
£
->
du¿tiÚ
);

164 
	`addR•lyMuÉiBulkL’
(
c
,
£
->
¬gc
);

165 
j
 = 0; j < 
£
->
¬gc
; j++)

166 
	`addR•lyBulk
(
c
,
£
->
¬gv
[
j
]);

167 
	`addR•lyBulkCBufãr
(
c
,
£
->
³”id
,
	`sd¦’
(se->peerid));

168 
	`addR•lyBulkCBufãr
(
c
,
£
->
úame
,
	`sd¦’
(se->cname));

169 
£Á
++;

171 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
tÙ’Œ›s
,
£Á
);

173 
	`addR•lyE¼Ü
(
c
,

176 
	}
}

	@slowlog.h

30 
	#SLOWLOG_ENTRY_MAX_ARGC
 32

	)

31 
	#SLOWLOG_ENTRY_MAX_STRING
 128

	)

34 
	s¦owlogEÁry
 {

35 
robj
 **
	m¬gv
;

36 
	m¬gc
;

37 
	mid
;

38 
	mdu¿tiÚ
;

39 
time_t
 
	mtime
;

40 
sds
 
	múame
;

41 
sds
 
	m³”id
;

42 } 
	t¦owlogEÁry
;

45 
¦owlogIn™
();

46 
¦owlogPushEÁryIfN“ded
(
ş›Á
 *
c
, 
robj
 **
¬gv
, 
¬gc
, 
du¿tiÚ
);

49 
¦owlogCommªd
(
ş›Á
 *
c
);

	@solarisfixes.h

31 #ià
defšed
(
__sun
)

33 #ià
defšed
(
__GNUC__
)

34 
	~<m©h.h
>

35 #undeà
i¢ª


36 
	#i¢ª
(
x
) \

37 
	`__ex‹nsiÚ__
({ 
	`__ty³of
 (
x
è
__x_a
 = (x); \

38 
	`__butš_ex³ù
(
__x_a
 !ğ__x_a, 0); })

	)

40 #undeà
isfš™e


41 
	#isfš™e
(
x
) \

42 
	`__ex‹nsiÚ__
 ({ 
	`__ty³of
 (
x
è
__x_f
 = (x); \

43 
	`__butš_ex³ù
(!
	`i¢ª
(
__x_f
 - __x_f), 1); })

	)

45 #undeà
isšf


46 
	#isšf
(
x
) \

47 
	`__ex‹nsiÚ__
 ({ 
	`__ty³of
 (
x
è
__x_i
 = (x); \

48 
	`__butš_ex³ù
(!
	`i¢ª
(
__x_i
è&& !
	`isfš™e
(__x_i), 0); })

	)

50 
	#u_št
 
ušt


	)

51 
	#u_št32_t
 
ušt32_t


	)

	@sort.c

32 
	~"£rv”.h
"

33 
	~"pqsÜt.h
"

34 
	~<m©h.h
>

36 
zskli¡Node
* 
z¦G‘EËm’tByRªk
(
zskli¡
 *
z¦
, 
¿nk
);

38 
»disSÜtO³¿tiÚ
 *
	$ü—‹SÜtO³¿tiÚ
(
ty³
, 
robj
 *
·‰”n
) {

39 
»disSÜtO³¿tiÚ
 *
so
 = 
	`zm®loc
((*so));

40 
so
->
ty³
 =ype;

41 
so
->
·‰”n
 =…attern;

42  
so
;

43 
	}
}

61 
robj
 *
	$lookupKeyByP©‹º
(
»disDb
 *
db
, 
robj
 *
·‰”n
,„obj *
sub¡
) {

62 *
p
, *
f
, *
k
;

63 
sds
 
¥©
, 
ssub
;

64 
robj
 *
keyobj
, *
f›ldobj
 = 
NULL
, *
o
;

65 
´efixËn
, 
subËn
, 
po¡fixËn
, 
f›ldËn
;

69 
¥©
 = 
·‰”n
->
±r
;

70 ià(
¥©
[0] == '#' && spat[1] == '\0') {

71 
	`šüRefCouÁ
(
sub¡
);

72  
sub¡
;

78 
sub¡
 = 
	`g‘DecodedObjeù
(subst);

79 
ssub
 = 
sub¡
->
±r
;

83 
p
 = 
	`¡rchr
(
¥©
,'*');

84 ià(!
p
) {

85 
	`deüRefCouÁ
(
sub¡
);

86  
NULL
;

90 ià((
f
 = 
	`¡r¡r
(
p
+1, "->")è!ğ
NULL
 && *(f+2) != '\0') {

91 
f›ldËn
 = 
	`sd¦’
(
¥©
)-(
f
-spat)-2;

92 
f›ldobj
 = 
	`ü—‹SŒšgObjeù
(
f
+2,
f›ldËn
);

94 
f›ldËn
 = 0;

98 
´efixËn
 = 
p
-
¥©
;

99 
subËn
 = 
	`sd¦’
(
ssub
);

100 
po¡fixËn
 = 
	`sd¦’
(
¥©
)-(
´efixËn
+1)-(
f›ldËn
 ? fieldlen+2 : 0);

101 
keyobj
 = 
	`ü—‹SŒšgObjeù
(
NULL
,
´efixËn
+
subËn
+
po¡fixËn
);

102 
k
 = 
keyobj
->
±r
;

103 
	`memıy
(
k
,
¥©
,
´efixËn
);

104 
	`memıy
(
k
+
´efixËn
,
ssub
,
subËn
);

105 
	`memıy
(
k
+
´efixËn
+
subËn
,
p
+1,
po¡fixËn
);

106 
	`deüRefCouÁ
(
sub¡
);

109 
o
 = 
	`lookupKeyR—d
(
db
,
keyobj
);

110 ià(
o
 =ğ
NULL
è
noobj
;

112 ià(
f›ldobj
) {

113 ià(
o
->
ty³
 !ğ
OBJ_HASH
è
noobj
;

117 
o
 = 
	`hashTy³G‘V®ueObjeù
(o, 
f›ldobj
->
±r
);

119 ià(
o
->
ty³
 !ğ
OBJ_STRING
è
noobj
;

123 
	`šüRefCouÁ
(
o
);

125 
	`deüRefCouÁ
(
keyobj
);

126 ià(
f›ldobj
è
	`deüRefCouÁ
(fieldobj);

127  
o
;

129 
noobj
:

130 
	`deüRefCouÁ
(
keyobj
);

131 ià(
f›ldËn
è
	`deüRefCouÁ
(
f›ldobj
);

132  
NULL
;

133 
	}
}

138 
	$sÜtCom·»
(cÚ¡ *
s1
, cÚ¡ *
s2
) {

139 cÚ¡ 
»disSÜtObjeù
 *
so1
 = 
s1
, *
so2
 = 
s2
;

140 
cmp
;

142 ià(!
£rv”
.
sÜt_®pha
) {

144 ià(
so1
->
u
.
scÜe
 > 
so2
->u.score) {

145 
cmp
 = 1;

146 } ià(
so1
->
u
.
scÜe
 < 
so2
->u.score) {

147 
cmp
 = -1;

152 
cmp
 = 
	`com·»SŒšgObjeùs
(
so1
->
obj
,
so2
->obj);

156 ià(
£rv”
.
sÜt_by·‰”n
) {

157 ià(!
so1
->
u
.
cmpobj
 || !
so2
->u.cmpobj) {

159 ià(
so1
->
u
.
cmpobj
 =ğ
so2
->u.cmpobj)

160 
cmp
 = 0;

161 ià(
so1
->
u
.
cmpobj
 =ğ
NULL
)

162 
cmp
 = -1;

164 
cmp
 = 1;

167 ià(
£rv”
.
sÜt_¡Üe
) {

168 
cmp
 = 
	`com·»SŒšgObjeùs
(
so1
->
u
.
cmpobj
,
so2
->u.cmpobj);

172 
cmp
 = 
	`¡rcŞl
(
so1
->
u
.
cmpobj
->
±r
,
so2
->u.cmpobj->ptr);

177 ià(
£rv”
.
sÜt_¡Üe
) {

178 
cmp
 = 
	`com·»SŒšgObjeùs
(
so1
->
obj
,
so2
->obj);

180 
cmp
 = 
	`cŞÏ‹SŒšgObjeùs
(
so1
->
obj
,
so2
->obj);

184  
£rv”
.
sÜt_desc
 ? -
cmp
 : cmp;

185 
	}
}

189 
	$sÜtCommªd
(
ş›Á
 *
c
) {

190 
li¡
 *
İ”©iÚs
;

191 
ouu’
 = 0;

192 
desc
 = 0, 
®pha
 = 0;

193 
lim™_¡¬t
 = 0, 
lim™_couÁ
 = -1, 
¡¬t
, 
’d
;

194 
j
, 
dÚtsÜt
 = 0, 
veùÜËn
;

195 
g‘İ
 = 0;

196 
št_cÚv”tiÚ_”rÜ
 = 0;

197 
syÁax_”rÜ
 = 0;

198 
robj
 *
sÜtv®
, *
sÜtby
 = 
NULL
, *
¡Üekey
 = NULL;

199 
»disSÜtObjeù
 *
veùÜ
;

202 
sÜtv®
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[1]);

203 ià(
sÜtv®
 && sÜtv®->
ty³
 !ğ
OBJ_SET
 &&

204 
sÜtv®
->
ty³
 !ğ
OBJ_LIST
 &&

205 
sÜtv®
->
ty³
 !ğ
OBJ_ZSET
)

207 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

213 
İ”©iÚs
 = 
	`li¡C»©e
();

214 
	`li¡S‘F»eM‘hod
(
İ”©iÚs
,
zä“
);

215 
j
 = 2;

220 ià(
sÜtv®
)

221 
	`šüRefCouÁ
(
sÜtv®
);

223 
sÜtv®
 = 
	`ü—‹Quickli¡Objeù
();

226 
j
 < 
c
->
¬gc
) {

227 
Ëá¬gs
 = 
c
->
¬gc
-
j
-1;

228 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"asc")) {

229 
desc
 = 0;

230 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"desc")) {

231 
desc
 = 1;

232 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"alpha")) {

233 
®pha
 = 1;

234 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"lim™"è&& 
Ëá¬gs
 >= 2) {

235 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
j
+1], &
lim™_¡¬t
, 
NULL
)

236 !ğ
C_OK
) ||

237 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
j
+2], &
lim™_couÁ
, 
NULL
)

238 !ğ
C_OK
))

240 
syÁax_”rÜ
++;

243 
j
+=2;

244 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"¡Üe"è&& 
Ëá¬gs
 >= 1) {

245 
¡Üekey
 = 
c
->
¬gv
[
j
+1];

246 
j
++;

247 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"by"è&& 
Ëá¬gs
 >= 1) {

248 
sÜtby
 = 
c
->
¬gv
[
j
+1];

251 ià(
	`¡rchr
(
c
->
¬gv
[
j
+1]->
±r
,'*'è=ğ
NULL
) {

252 
dÚtsÜt
 = 1;

256 ià(
£rv”
.
şu¡”_’abËd
) {

257 
	`addR•lyE¼Ü
(
c
,"BY option of SORT denied in Cluster mode.");

258 
syÁax_”rÜ
++;

262 
j
++;

263 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"g‘"è&& 
Ëá¬gs
 >= 1) {

264 ià(
£rv”
.
şu¡”_’abËd
) {

265 
	`addR•lyE¼Ü
(
c
,"GET option of SORT denied in Cluster mode.");

266 
syÁax_”rÜ
++;

269 
	`li¡AddNodeTa
(
İ”©iÚs
,
	`ü—‹SÜtO³¿tiÚ
(

270 
SORT_OP_GET
,
c
->
¬gv
[
j
+1]));

271 
g‘İ
++;

272 
j
++;

274 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

275 
syÁax_”rÜ
++;

278 
j
++;

282 ià(
syÁax_”rÜ
) {

283 
	`deüRefCouÁ
(
sÜtv®
);

284 
	`li¡R–—£
(
İ”©iÚs
);

294 ià(
dÚtsÜt
 &&

295 
sÜtv®
->
ty³
 =ğ
OBJ_SET
 &&

296 (
¡Üekey
 || 
c
->
æags
 & 
CLIENT_LUA
))

299 
dÚtsÜt
 = 0;

300 
®pha
 = 1;

301 
sÜtby
 = 
NULL
;

305 ià(
sÜtv®
->
ty³
 =ğ
OBJ_ZSET
)

306 
	`z£tCÚv”t
(
sÜtv®
, 
OBJ_ENCODING_SKIPLIST
);

309 
sÜtv®
->
ty³
) {

310 
OBJ_LIST
: 
veùÜËn
 = 
	`li¡Ty³L’gth
(
sÜtv®
); ;

311 
OBJ_SET
: 
veùÜËn
 = 
	`£tTy³Size
(
sÜtv®
); ;

312 
OBJ_ZSET
: 
veùÜËn
 = 
	`diùSize
(((
z£t
*)
sÜtv®
->
±r
)->
diù
); ;

313 : 
veùÜËn
 = 0; 
	`£rv”Pªic
("Bad SORType");

317 
¡¬t
 = (
lim™_¡¬t
 < 0) ? 0 :†imit_start;

318 
’d
 = (
lim™_couÁ
 < 0è? 
veùÜËn
-1 : 
¡¬t
+limit_count-1;

319 ià(
¡¬t
 >ğ
veùÜËn
) {

320 
¡¬t
 = 
veùÜËn
-1;

321 
’d
 = 
veùÜËn
-2;

323 ià(
’d
 >ğ
veùÜËn
)ƒnd = vectorlen-1;

335 ià((
sÜtv®
->
ty³
 =ğ
OBJ_ZSET
 || sÜtv®->ty³ =ğ
OBJ_LIST
) &&

336 
dÚtsÜt
 &&

337 (
¡¬t
 !ğ0 || 
’d
 !ğ
veùÜËn
-1))

339 
veùÜËn
 = 
’d
-
¡¬t
+1;

343 
veùÜ
 = 
	`zm®loc
((
»disSÜtObjeù
)*
veùÜËn
);

344 
j
 = 0;

346 ià(
sÜtv®
->
ty³
 =ğ
OBJ_LIST
 && 
dÚtsÜt
) {

353 ià(
’d
 >ğ
¡¬t
) {

354 
li¡Ty³I‹¿tÜ
 *
li
;

355 
li¡Ty³EÁry
 
’Œy
;

356 
li
 = 
	`li¡Ty³In™I‹¿tÜ
(
sÜtv®
,

357 
desc
 ? ()(
	`li¡Ty³L’gth
(
sÜtv®
è- 
¡¬t
 - 1) : start,

358 
desc
 ? 
LIST_HEAD
 : 
LIST_TAIL
);

360 
j
 < 
veùÜËn
 && 
	`li¡Ty³Next
(
li
,&
’Œy
)) {

361 
veùÜ
[
j
].
obj
 = 
	`li¡Ty³G‘
(&
’Œy
);

362 
veùÜ
[
j
].
u
.
scÜe
 = 0;

363 
veùÜ
[
j
].
u
.
cmpobj
 = 
NULL
;

364 
j
++;

366 
	`li¡Ty³R–—£I‹¿tÜ
(
li
);

368 
’d
 -ğ
¡¬t
;

369 
¡¬t
 = 0;

371 } ià(
sÜtv®
->
ty³
 =ğ
OBJ_LIST
) {

372 
li¡Ty³I‹¿tÜ
 *
li
 = 
	`li¡Ty³In™I‹¿tÜ
(
sÜtv®
,0,
LIST_TAIL
);

373 
li¡Ty³EÁry
 
’Œy
;

374 
	`li¡Ty³Next
(
li
,&
’Œy
)) {

375 
veùÜ
[
j
].
obj
 = 
	`li¡Ty³G‘
(&
’Œy
);

376 
veùÜ
[
j
].
u
.
scÜe
 = 0;

377 
veùÜ
[
j
].
u
.
cmpobj
 = 
NULL
;

378 
j
++;

380 
	`li¡Ty³R–—£I‹¿tÜ
(
li
);

381 } ià(
sÜtv®
->
ty³
 =ğ
OBJ_SET
) {

382 
£tTy³I‹¿tÜ
 *
si
 = 
	`£tTy³In™I‹¿tÜ
(
sÜtv®
);

383 
sds
 
sd£Ë
;

384 (
sd£Ë
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

385 
veùÜ
[
j
].
obj
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
sd£Ë
);

386 
veùÜ
[
j
].
u
.
scÜe
 = 0;

387 
veùÜ
[
j
].
u
.
cmpobj
 = 
NULL
;

388 
j
++;

390 
	`£tTy³R–—£I‹¿tÜ
(
si
);

391 } ià(
sÜtv®
->
ty³
 =ğ
OBJ_ZSET
 && 
dÚtsÜt
) {

399 
z£t
 *
zs
 = 
sÜtv®
->
±r
;

400 
zskli¡
 *
z¦
 = 
zs
->zsl;

401 
zskli¡Node
 *
Ê
;

402 
sds
 
sd£Ë
;

403 
¿ng–’
 = 
veùÜËn
;

406 ià(
desc
) {

407 
z£’
 = 
	`diùSize
(((
z£t
*)
sÜtv®
->
±r
)->
diù
);

409 
Ê
 = 
z¦
->

;

410 ià(
¡¬t
 > 0)

411 
Ê
 = 
	`z¦G‘EËm’tByRªk
(
z¦
,
z£’
-
¡¬t
);

413 
Ê
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

414 ià(
¡¬t
 > 0)

415 
Ê
 = 
	`z¦G‘EËm’tByRªk
(
z¦
,
¡¬t
+1);

418 
¿ng–’
--) {

419 
	`£rv”As£¹W™hInfo
(
c
,
sÜtv®
,
Ê
 !ğ
NULL
);

420 
sd£Ë
 = 
Ê
->
–e
;

421 
veùÜ
[
j
].
obj
 = 
	`ü—‹SŒšgObjeù
(
sd£Ë
,
	`sd¦’
(sdsele));

422 
veùÜ
[
j
].
u
.
scÜe
 = 0;

423 
veùÜ
[
j
].
u
.
cmpobj
 = 
NULL
;

424 
j
++;

425 
Ê
 = 
desc
 ?†n->
backw¬d
 :†n->
Ëv–
[0].
fÜw¬d
;

428 
’d
 -ğ
¡¬t
;

429 
¡¬t
 = 0;

430 } ià(
sÜtv®
->
ty³
 =ğ
OBJ_ZSET
) {

431 
diù
 *
£t
 = ((
z£t
*)
sÜtv®
->
±r
)->dict;

432 
diùI‹¿tÜ
 *
di
;

433 
diùEÁry
 *
£‹Ë
;

434 
sds
 
sd£Ë
;

435 
di
 = 
	`diùG‘I‹¿tÜ
(
£t
);

436 (
£‹Ë
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

437 
sd£Ë
 = 
	`diùG‘Key
(
£‹Ë
);

438 
veùÜ
[
j
].
obj
 = 
	`ü—‹SŒšgObjeù
(
sd£Ë
,
	`sd¦’
(sdsele));

439 
veùÜ
[
j
].
u
.
scÜe
 = 0;

440 
veùÜ
[
j
].
u
.
cmpobj
 = 
NULL
;

441 
j
++;

443 
	`diùR–—£I‹¿tÜ
(
di
);

445 
	`£rv”Pªic
("Unknownype");

447 
	`£rv”As£¹W™hInfo
(
c
,
sÜtv®
,
j
 =ğ
veùÜËn
);

450 ià(
dÚtsÜt
 == 0) {

451 
j
 = 0; j < 
veùÜËn
; j++) {

452 
robj
 *
byv®
;

453 ià(
sÜtby
) {

455 
byv®
 = 
	`lookupKeyByP©‹º
(
c
->
db
,
sÜtby
,
veùÜ
[
j
].
obj
);

456 ià(!
byv®
) ;

459 
byv®
 = 
veùÜ
[
j
].
obj
;

462 ià(
®pha
) {

463 ià(
sÜtby
è
veùÜ
[
j
].
u
.
cmpobj
 = 
	`g‘DecodedObjeù
(
byv®
);

465 ià(
	`sdsEncodedObjeù
(
byv®
)) {

466 *
•Œ
;

468 
veùÜ
[
j
].
u
.
scÜe
 = 
	`¡¹od
(
byv®
->
±r
,&
•Œ
);

469 ià(
•Œ
[0] !ğ'\0' || 
”ºo
 =ğ
ERANGE
 ||

470 
	`i¢ª
(
veùÜ
[
j
].
u
.
scÜe
))

472 
št_cÚv”tiÚ_”rÜ
 = 1;

474 } ià(
byv®
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

478 
veùÜ
[
j
].
u
.
scÜe
 = ()
byv®
->
±r
;

480 
	`£rv”As£¹W™hInfo
(
c
,
sÜtv®
,1 != 1);

486 ià(
sÜtby
) {

487 
	`deüRefCouÁ
(
byv®
);

492 ià(
dÚtsÜt
 == 0) {

493 
£rv”
.
sÜt_desc
 = 
desc
;

494 
£rv”
.
sÜt_®pha
 = 
®pha
;

495 
£rv”
.
sÜt_by·‰”n
 = 
sÜtby
 ? 1 : 0;

496 
£rv”
.
sÜt_¡Üe
 = 
¡Üekey
 ? 1 : 0;

497 ià(
sÜtby
 && (
¡¬t
 !ğ0 || 
’d
 !ğ
veùÜËn
-1))

498 
	`pqsÜt
(
veùÜ
,
veùÜËn
,(
»disSÜtObjeù
),
sÜtCom·»
, 
¡¬t
,
’d
);

500 
	`qsÜt
(
veùÜ
,
veùÜËn
,(
»disSÜtObjeù
),
sÜtCom·»
);

505 
ouu’
 = 
g‘İ
 ? g‘İ*(
’d
-
¡¬t
+1) :ƒnd-start+1;

506 ià(
št_cÚv”tiÚ_”rÜ
) {

507 
	`addR•lyE¼Ü
(
c
,"One or more scores can't be converted into double");

508 } ià(
¡Üekey
 =ğ
NULL
) {

510 
	`addR•lyMuÉiBulkL’
(
c
,
ouu’
);

511 
j
 = 
¡¬t
; j <ğ
’d
; j++) {

512 
li¡Node
 *
Ê
;

513 
li¡I‹r
 
li
;

515 ià(!
g‘İ
è
	`addR•lyBulk
(
c
,
veùÜ
[
j
].
obj
);

516 
	`li¡Rewšd
(
İ”©iÚs
,&
li
);

517 (
Ê
 = 
	`li¡Next
(&
li
))) {

518 
»disSÜtO³¿tiÚ
 *
sİ
 = 
Ê
->
v®ue
;

519 
robj
 *
v®
 = 
	`lookupKeyByP©‹º
(
c
->
db
,
sİ
->
·‰”n
,

520 
veùÜ
[
j
].
obj
);

522 ià(
sİ
->
ty³
 =ğ
SORT_OP_GET
) {

523 ià(!
v®
) {

524 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

526 
	`addR•lyBulk
(
c
,
v®
);

527 
	`deüRefCouÁ
(
v®
);

531 
	`£rv”As£¹W™hInfo
(
c
,
sÜtv®
,
sİ
->
ty³
 =ğ
SORT_OP_GET
);

536 
robj
 *
sobj
 = 
	`ü—‹Quickli¡Objeù
();

539 
j
 = 
¡¬t
; j <ğ
’d
; j++) {

540 
li¡Node
 *
Ê
;

541 
li¡I‹r
 
li
;

543 ià(!
g‘İ
) {

544 
	`li¡Ty³Push
(
sobj
,
veùÜ
[
j
].
obj
,
LIST_TAIL
);

546 
	`li¡Rewšd
(
İ”©iÚs
,&
li
);

547 (
Ê
 = 
	`li¡Next
(&
li
))) {

548 
»disSÜtO³¿tiÚ
 *
sİ
 = 
Ê
->
v®ue
;

549 
robj
 *
v®
 = 
	`lookupKeyByP©‹º
(
c
->
db
,
sİ
->
·‰”n
,

550 
veùÜ
[
j
].
obj
);

552 ià(
sİ
->
ty³
 =ğ
SORT_OP_GET
) {

553 ià(!
v®
èv® = 
	`ü—‹SŒšgObjeù
("",0);

558 
	`li¡Ty³Push
(
sobj
,
v®
,
LIST_TAIL
);

559 
	`deüRefCouÁ
(
v®
);

562 
	`£rv”As£¹W™hInfo
(
c
,
sÜtv®
,
sİ
->
ty³
 =ğ
SORT_OP_GET
);

567 ià(
ouu’
) {

568 
	`£tKey
(
c
->
db
,
¡Üekey
,
sobj
);

569 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"sÜt¡Üe",
¡Üekey
,

570 
c
->
db
->
id
);

571 
£rv”
.
dœty
 +ğ
ouu’
;

572 } ià(
	`dbD–‘e
(
c
->
db
,
¡Üekey
)) {

573 
	`sigÇlModif›dKey
(
c
->
db
,
¡Üekey
);

574 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
¡Üekey
,
c
->
db
->
id
);

575 
£rv”
.
dœty
++;

577 
	`deüRefCouÁ
(
sobj
);

578 
	`addR•lyLÚgLÚg
(
c
,
ouu’
);

582 
j
 = 0; j < 
veùÜËn
; j++)

583 
	`deüRefCouÁ
(
veùÜ
[
j
].
obj
);

585 
	`deüRefCouÁ
(
sÜtv®
);

586 
	`li¡R–—£
(
İ”©iÚs
);

587 
j
 = 0; j < 
veùÜËn
; j++) {

588 ià(
®pha
 && 
veùÜ
[
j
].
u
.
cmpobj
)

589 
	`deüRefCouÁ
(
veùÜ
[
j
].
u
.
cmpobj
);

591 
	`zä“
(
veùÜ
);

592 
	}
}

	@sparkline.c

33 
	~"£rv”.h
"

35 
	~<m©h.h
>

39 
	gch¬£t
[] = "_-`";

40 
	gch¬£t_fl
[] = "_o#";

41 
	gch¬£t_Ën
 = (
ch¬£t
)-1;

42 
	gÏb–_m¬gš_tİ
 = 1;

57 
£qu’û
 *
	$ü—‹S·rklšeSequ’û
() {

58 
£qu’û
 *
£q
 = 
	`zm®loc
((*seq));

59 
£q
->
Ëngth
 = 0;

60 
£q
->
§m¶es
 = 
NULL
;

61  
£q
;

62 
	}
}

65 
	$¥¬klšeSequ’ûAddSam¶e
(
£qu’û
 *
£q
, 
v®ue
, *
Ïb–
) {

66 
Ïb–
 = (Ïb– =ğ
NULL
 ||†ab–[0] =ğ'\0'è? NULL : 
	`z¡rdup
(label);

67 ià(
£q
->
Ëngth
 == 0) {

68 
£q
->
mš
 = seq->
max
 = 
v®ue
;

70 ià(
v®ue
 < 
£q
->
mš
) seq->min = value;

71 ià(
v®ue
 > 
£q
->
max
) seq->max = value;

73 
£q
->
§m¶es
 = 
	`z»®loc
(£q->§m¶es,(
§m¶e
)*(£q->
Ëngth
+1));

74 
£q
->
§m¶es
[£q->
Ëngth
].
v®ue
 = value;

75 
£q
->
§m¶es
[£q->
Ëngth
].
Ïb–
 =†abel;

76 
£q
->
Ëngth
++;

77 ià(
Ïb–
è
£q
->
Ïb–s
++;

78 
	}
}

81 
	$ä“S·rklšeSequ’û
(
£qu’û
 *
£q
) {

82 
j
;

84 
j
 = 0; j < 
£q
->
Ëngth
; j++)

85 
	`zä“
(
£q
->
§m¶es
[
j
].
Ïb–
);

86 
	`zä“
(
£q
->
§m¶es
);

87 
	`zä“
(
£q
);

88 
	}
}

97 
sds
 
	$¥¬klšeR’d”Rªge
(
sds
 
ouut
, 
£qu’û
 *
£q
, 
rows
, 
off£t
, 
Ën
, 
æags
) {

98 
j
;

99 
»lmax
 = 
£q
->
max
 - seq->
mš
;

100 
¡•s
 = 
ch¬£t_Ën
*
rows
;

101 
row
 = 0;

102 *
ch¬s
 = 
	`zm®loc
(
Ën
);

103 
loİ
 = 1;

104 
İt_fl
 = 
æags
 & 
SPARKLINE_FILL
;

105 
İt_log
 = 
æags
 & 
SPARKLINE_LOG_SCALE
;

107 ià(
İt_log
) {

108 
»lmax
 = 
	`log
(relmax+1);

109 } ià(
»lmax
 == 0) {

110 
»lmax
 = 1;

113 
loİ
) {

114 
loİ
 = 0;

115 
	`mem£t
(
ch¬s
,' ',
Ën
);

116 
j
 = 0; j < 
Ën
; j++) {

117 
§m¶e
 *
s
 = &
£q
->
§m¶es
[
j
+
off£t
];

118 
»lv®
 = 
s
->
v®ue
 - 
£q
->
mš
;

119 
¡•
;

121 ià(
İt_log
è
»lv®
 = 
	`log
(relval+1);

122 
¡•
 = (è(
»lv®
*
¡•s
)/
»lmax
;

123 ià(
¡•
 < 0) step = 0;

124 ià(
¡•
 >ğ
¡•s
) step = steps-1;

126 ià(
row
 < 
rows
) {

128 
ch¬idx
 = 
¡•
-((
rows
-
row
-1)*
ch¬£t_Ën
);

129 
loİ
 = 1;

130 ià(
ch¬idx
 >ğ0 && ch¬idx < 
ch¬£t_Ën
) {

131 
ch¬s
[
j
] = 
İt_fl
 ? 
ch¬£t_fl
[
ch¬idx
] :

132 
ch¬£t
[
ch¬idx
];

133 } if(
İt_fl
 && 
ch¬idx
 >ğ
ch¬£t_Ën
) {

134 
ch¬s
[
j
] = '|';

138 ià(
£q
->
Ïb–s
 && 
row
-
rows
 < 
Ïb–_m¬gš_tİ
) {

139 
loİ
 = 1;

143 ià(
s
->
Ïb–
) {

144 
Ïb–_Ën
 = 
	`¡¾’
(
s
->
Ïb–
);

145 
Ïb–_ch¬
 = 
row
 - 
rows
 - 
Ïb–_m¬gš_tİ
;

147 ià(
Ïb–_Ën
 > 
Ïb–_ch¬
) {

148 
loİ
 = 1;

149 
ch¬s
[
j
] = 
s
->
Ïb–
[
Ïb–_ch¬
];

154 ià(
loİ
) {

155 
row
++;

156 
ouut
 = 
	`sdsÿ’
(ouut,
ch¬s
,
Ën
);

157 
ouut
 = 
	`sdsÿ’
(output,"\n",1);

160 
	`zä“
(
ch¬s
);

161  
ouut
;

162 
	}
}

165 
sds
 
	$¥¬klšeR’d”
(
sds
 
ouut
, 
£qu’û
 *
£q
, 
cŞumns
, 
rows
, 
æags
) {

166 
j
;

168 
j
 = 0; j < 
£q
->
Ëngth
; j +ğ
cŞumns
) {

169 
subËn
 = (
£q
->
Ëngth
-
j
è< 
cŞumns
 ? (seq->length-j) : columns;

171 ià(
j
 !ğ0è
ouut
 = 
	`sdsÿ’
(output,"\n",1);

172 
ouut
 = 
	`¥¬klšeR’d”Rªge
(ouut, 
£q
, 
rows
, 
j
, 
subËn
, 
æags
);

174  
ouut
;

175 
	}
}

	@sparkline.h

30 #iâdeà
__SPARKLINE_H


31 
	#__SPARKLINE_H


	)

34 
	s§m¶e
 {

35 
	mv®ue
;

36 *
	mÏb–
;

39 
	s£qu’û
 {

40 
	mËngth
;

41 
	mÏb–s
;

42 
§m¶e
 *
	m§m¶es
;

43 
	mmš
, 
	mmax
;

46 
	#SPARKLINE_NO_FLAGS
 0

	)

47 
	#SPARKLINE_FILL
 1

	)

48 
	#SPARKLINE_LOG_SCALE
 2

	)

50 
£qu’û
 *
ü—‹S·rklšeSequ’û
();

51 
¥¬klšeSequ’ûAddSam¶e
(
£qu’û
 *
£q
, 
v®ue
, *
Ïb–
);

52 
ä“S·rklšeSequ’û
(
£qu’û
 *
£q
);

53 
sds
 
¥¬klšeR’d”Rªge
(sd 
ouut
, 
£qu’û
 *
£q
, 
rows
, 
off£t
, 
Ën
, 
æags
);

54 
sds
 
¥¬klšeR’d”
(sd 
ouut
, 
£qu’û
 *
£q
, 
cŞumns
, 
rows
, 
æags
);

	@syncio.c

31 
	~"£rv”.h
"

43 
	#SYNCIO__RESOLUTION
 10

	)

49 
ssize_t
 
	$syncWr™e
(
fd
, *
±r
, 
ssize_t
 
size
, 
timeout
) {

50 
ssize_t
 
nwr™‹n
, 
»t
 = 
size
;

51 
¡¬t
 = 
	`m¡ime
();

52 
»maššg
 = 
timeout
;

55 
wa™
 = (
»maššg
 > 
SYNCIO__RESOLUTION
) ?

56 
»maššg
 : 
SYNCIO__RESOLUTION
;

57 
–­£d
;

61 
nwr™‹n
 = 
	`wr™e
(
fd
,
±r
,
size
);

62 ià(
nwr™‹n
 == -1) {

63 ià(
”ºo
 !ğ
EAGAIN
)  -1;

65 
±r
 +ğ
nwr™‹n
;

66 
size
 -ğ
nwr™‹n
;

68 ià(
size
 =ğ0è 
»t
;

71 
	`«Wa™
(
fd
,
AE_WRITABLE
,
wa™
);

72 
–­£d
 = 
	`m¡ime
(è- 
¡¬t
;

73 ià(
–­£d
 >ğ
timeout
) {

74 
”ºo
 = 
ETIMEDOUT
;

77 
»maššg
 = 
timeout
 - 
–­£d
;

79 
	}
}

85 
ssize_t
 
	$syncR—d
(
fd
, *
±r
, 
ssize_t
 
size
, 
timeout
) {

86 
ssize_t
 
Ä—d
, 
tÙ»ad
 = 0;

87 
¡¬t
 = 
	`m¡ime
();

88 
»maššg
 = 
timeout
;

90 ià(
size
 == 0)  0;

92 
wa™
 = (
»maššg
 > 
SYNCIO__RESOLUTION
) ?

93 
»maššg
 : 
SYNCIO__RESOLUTION
;

94 
–­£d
;

98 
Ä—d
 = 
	`»ad
(
fd
,
±r
,
size
);

99 ià(
Ä—d
 == 0)  -1;

100 ià(
Ä—d
 == -1) {

101 ià(
”ºo
 !ğ
EAGAIN
)  -1;

103 
±r
 +ğ
Ä—d
;

104 
size
 -ğ
Ä—d
;

105 
tÙ»ad
 +ğ
Ä—d
;

107 ià(
size
 =ğ0è 
tÙ»ad
;

110 
	`«Wa™
(
fd
,
AE_READABLE
,
wa™
);

111 
–­£d
 = 
	`m¡ime
(è- 
¡¬t
;

112 ià(
–­£d
 >ğ
timeout
) {

113 
”ºo
 = 
ETIMEDOUT
;

116 
»maššg
 = 
timeout
 - 
–­£d
;

118 
	}
}

125 
ssize_t
 
	$syncR—dLše
(
fd
, *
±r
, 
ssize_t
 
size
, 
timeout
) {

126 
ssize_t
 
Ä—d
 = 0;

128 
size
--;

129 
size
) {

130 
c
;

132 ià(
	`syncR—d
(
fd
,&
c
,1,
timeout
) == -1)  -1;

133 ià(
c
 == '\n') {

134 *
±r
 = '\0';

135 ià(
Ä—d
 && *(
±r
-1) == '\r') *(ptr-1) = '\0';

136  
Ä—d
;

138 *
±r
++ = 
c
;

139 *
±r
 = '\0';

140 
Ä—d
++;

142 
size
--;

144  
Ä—d
;

145 
	}
}

	@t_hash.c

30 
	~"£rv”.h
"

31 
	~<m©h.h
>

40 
	$hashTy³TryCÚv”siÚ
(
robj
 *
o
,„obj **
¬gv
, 
¡¬t
, 
’d
) {

41 
i
;

43 ià(
o
->
’codšg
 !ğ
OBJ_ENCODING_ZIPLIST
) ;

45 
i
 = 
¡¬t
; i <ğ
’d
; i++) {

46 ià(
	`sdsEncodedObjeù
(
¬gv
[
i
]) &&

47 
	`sd¦’
(
¬gv
[
i
]->
±r
è> 
£rv”
.
hash_max_zli¡_v®ue
)

49 
	`hashTy³CÚv”t
(
o
, 
OBJ_ENCODING_HT
);

53 
	}
}

57 
	$hashTy³G‘FromZli¡
(
robj
 *
o
, 
sds
 
f›ld
,

58 **
v¡r
,

59 *
vËn
,

60 *
vÎ
)

62 *
zl
, *
åŒ
 = 
NULL
, *
v±r
 = NULL;

63 
»t
;

65 
	`£rv”As£¹
(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
);

67 
zl
 = 
o
->
±r
;

68 
åŒ
 = 
	`zli¡Index
(
zl
, 
ZIPLIST_HEAD
);

69 ià(
åŒ
 !ğ
NULL
) {

70 
åŒ
 = 
	`zli¡Fšd
(åŒ, (*)
f›ld
, 
	`sd¦’
(field), 1);

71 ià(
åŒ
 !ğ
NULL
) {

73 
v±r
 = 
	`zli¡Next
(
zl
, 
åŒ
);

74 
	`£rv”As£¹
(
v±r
 !ğ
NULL
);

78 ià(
v±r
 !ğ
NULL
) {

79 
»t
 = 
	`zli¡G‘
(
v±r
, 
v¡r
, 
vËn
, 
vÎ
);

80 
	`£rv”As£¹
(
»t
);

85 
	}
}

90 
sds
 
	$hashTy³G‘FromHashTabË
(
robj
 *
o
, 
sds
 
f›ld
) {

91 
diùEÁry
 *
de
;

93 
	`£rv”As£¹
(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
);

95 
de
 = 
	`diùFšd
(
o
->
±r
, 
f›ld
);

96 ià(
de
 =ğ
NULL
)  NULL;

97  
	`diùG‘V®
(
de
);

98 
	}
}

109 
	$hashTy³G‘V®ue
(
robj
 *
o
, 
sds
 
f›ld
, **
v¡r
, *
vËn
, *
vÎ
) {

110 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

111 *
v¡r
 = 
NULL
;

112 ià(
	`hashTy³G‘FromZli¡
(
o
, 
f›ld
, 
v¡r
, 
vËn
, 
vÎ
) == 0)

113  
C_OK
;

114 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

115 
sds
 
v®ue
;

116 ià((
v®ue
 = 
	`hashTy³G‘FromHashTabË
(
o
, 
f›ld
)è!ğ
NULL
) {

117 *
v¡r
 = (*è
v®ue
;

118 *
vËn
 = 
	`sd¦’
(
v®ue
);

119  
C_OK
;

122 
	`£rv”Pªic
("Unknown hashƒncoding");

124  
C_ERR
;

125 
	}
}

131 
robj
 *
	$hashTy³G‘V®ueObjeù
(
robj
 *
o
, 
sds
 
f›ld
) {

132 *
v¡r
;

133 
vËn
;

134 
vÎ
;

136 ià(
	`hashTy³G‘V®ue
(
o
,
f›ld
,&
v¡r
,&
vËn
,&
vÎ
è=ğ
C_ERR
è 
NULL
;

137 ià(
v¡r
è 
	`ü—‹SŒšgObjeù
((*)v¡r,
vËn
);

138  
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vÎ
);

139 
	}
}

144 
size_t
 
	$hashTy³G‘V®ueL’gth
(
robj
 *
o
, 
sds
 
f›ld
) {

145 
size_t
 
Ën
 = 0;

146 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

147 *
v¡r
 = 
NULL
;

148 
vËn
 = 
UINT_MAX
;

149 
vÎ
 = 
LLONG_MAX
;

151 ià(
	`hashTy³G‘FromZli¡
(
o
, 
f›ld
, &
v¡r
, &
vËn
, &
vÎ
) == 0)

152 
Ën
 = 
v¡r
 ? 
vËn
 : 
	`sdig™s10
(
vÎ
);

153 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

154 
sds
 
aux
;

156 ià((
aux
 = 
	`hashTy³G‘FromHashTabË
(
o
, 
f›ld
)è!ğ
NULL
)

157 
Ën
 = 
	`sd¦’
(
aux
);

159 
	`£rv”Pªic
("Unknown hashƒncoding");

161  
Ën
;

162 
	}
}

166 
	$hashTy³Exi¡s
(
robj
 *
o
, 
sds
 
f›ld
) {

167 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

168 *
v¡r
 = 
NULL
;

169 
vËn
 = 
UINT_MAX
;

170 
vÎ
 = 
LLONG_MAX
;

172 ià(
	`hashTy³G‘FromZli¡
(
o
, 
f›ld
, &
v¡r
, &
vËn
, &
vÎ
) == 0)  1;

173 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

174 ià(
	`hashTy³G‘FromHashTabË
(
o
, 
f›ld
è!ğ
NULL
)  1;

176 
	`£rv”Pªic
("Unknown hashƒncoding");

179 
	}
}

199 
	#HASH_SET_TAKE_FIELD
 (1<<0)

	)

200 
	#HASH_SET_TAKE_VALUE
 (1<<1)

	)

201 
	#HASH_SET_COPY
 0

	)

202 
	$hashTy³S‘
(
robj
 *
o
, 
sds
 
f›ld
, sd 
v®ue
, 
æags
) {

203 
upd©e
 = 0;

205 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

206 *
zl
, *
åŒ
, *
v±r
;

208 
zl
 = 
o
->
±r
;

209 
åŒ
 = 
	`zli¡Index
(
zl
, 
ZIPLIST_HEAD
);

210 ià(
åŒ
 !ğ
NULL
) {

211 
åŒ
 = 
	`zli¡Fšd
(åŒ, (*)
f›ld
, 
	`sd¦’
(field), 1);

212 ià(
åŒ
 !ğ
NULL
) {

214 
v±r
 = 
	`zli¡Next
(
zl
, 
åŒ
);

215 
	`£rv”As£¹
(
v±r
 !ğ
NULL
);

216 
upd©e
 = 1;

219 
zl
 = 
	`zli¡D–‘e
(zl, &
v±r
);

222 
zl
 = 
	`zli¡In£¹
(zl, 
v±r
, (*)
v®ue
,

223 
	`sd¦’
(
v®ue
));

227 ià(!
upd©e
) {

229 
zl
 = 
	`zli¡Push
(zl, (*)
f›ld
, 
	`sd¦’
(field),

230 
ZIPLIST_TAIL
);

231 
zl
 = 
	`zli¡Push
(zl, (*)
v®ue
, 
	`sd¦’
(value),

232 
ZIPLIST_TAIL
);

234 
o
->
±r
 = 
zl
;

237 ià(
	`hashTy³L’gth
(
o
è> 
£rv”
.
hash_max_zli¡_’Œ›s
)

238 
	`hashTy³CÚv”t
(
o
, 
OBJ_ENCODING_HT
);

239 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

240 
diùEÁry
 *
de
 = 
	`diùFšd
(
o
->
±r
,
f›ld
);

241 ià(
de
) {

242 
	`sdsä“
(
	`diùG‘V®
(
de
));

243 ià(
æags
 & 
HASH_SET_TAKE_VALUE
) {

244 
	`diùG‘V®
(
de
èğ
v®ue
;

245 
v®ue
 = 
NULL
;

247 
	`diùG‘V®
(
de
èğ
	`sdsdup
(
v®ue
);

249 
upd©e
 = 1;

251 
sds
 
f
,
v
;

252 ià(
æags
 & 
HASH_SET_TAKE_FIELD
) {

253 
f
 = 
f›ld
;

254 
f›ld
 = 
NULL
;

256 
f
 = 
	`sdsdup
(
f›ld
);

258 ià(
æags
 & 
HASH_SET_TAKE_VALUE
) {

259 
v
 = 
v®ue
;

260 
v®ue
 = 
NULL
;

262 
v
 = 
	`sdsdup
(
v®ue
);

264 
	`diùAdd
(
o
->
±r
,
f
,
v
);

267 
	`£rv”Pªic
("Unknown hashƒncoding");

272 ià(
æags
 & 
HASH_SET_TAKE_FIELD
 && 
f›ld
è
	`sdsä“
(field);

273 ià(
æags
 & 
HASH_SET_TAKE_VALUE
 && 
v®ue
è
	`sdsä“
(value);

274  
upd©e
;

275 
	}
}

279 
	$hashTy³D–‘e
(
robj
 *
o
, 
sds
 
f›ld
) {

280 
d–‘ed
 = 0;

282 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

283 *
zl
, *
åŒ
;

285 
zl
 = 
o
->
±r
;

286 
åŒ
 = 
	`zli¡Index
(
zl
, 
ZIPLIST_HEAD
);

287 ià(
åŒ
 !ğ
NULL
) {

288 
åŒ
 = 
	`zli¡Fšd
(åŒ, (*)
f›ld
, 
	`sd¦’
(field), 1);

289 ià(
åŒ
 !ğ
NULL
) {

290 
zl
 = 
	`zli¡D–‘e
(zl,&
åŒ
);

291 
zl
 = 
	`zli¡D–‘e
(zl,&
åŒ
);

292 
o
->
±r
 = 
zl
;

293 
d–‘ed
 = 1;

296 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

297 ià(
	`diùD–‘e
((
diù
*)
o
->
±r
, 
f›ld
è=ğ
C_OK
) {

298 
d–‘ed
 = 1;

301 ià(
	`htN“dsResize
(
o
->
±r
)è
	`diùResize
(o->ptr);

305 
	`£rv”Pªic
("Unknown hashƒncoding");

307  
d–‘ed
;

308 
	}
}

311 
	$hashTy³L’gth
(cÚ¡ 
robj
 *
o
) {

312 
Ëngth
 = 
ULONG_MAX
;

314 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

315 
Ëngth
 = 
	`zli¡L’
(
o
->
±r
) / 2;

316 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

317 
Ëngth
 = 
	`diùSize
((cÚ¡ 
diù
*)
o
->
±r
);

319 
	`£rv”Pªic
("Unknown hashƒncoding");

321  
Ëngth
;

322 
	}
}

324 
hashTy³I‹¿tÜ
 *
	$hashTy³In™I‹¿tÜ
(
robj
 *
subjeù
) {

325 
hashTy³I‹¿tÜ
 *
hi
 = 
	`zm®loc
((hashTypeIterator));

326 
hi
->
subjeù
 = subject;

327 
hi
->
’codšg
 = 
subjeù
->encoding;

329 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

330 
hi
->
åŒ
 = 
NULL
;

331 
hi
->
v±r
 = 
NULL
;

332 } ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

333 
hi
->
di
 = 
	`diùG‘I‹¿tÜ
(
subjeù
->
±r
);

335 
	`£rv”Pªic
("Unknown hashƒncoding");

337  
hi
;

338 
	}
}

340 
	$hashTy³R–—£I‹¿tÜ
(
hashTy³I‹¿tÜ
 *
hi
) {

341 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
)

342 
	`diùR–—£I‹¿tÜ
(
hi
->
di
);

343 
	`zä“
(
hi
);

344 
	}
}

348 
	$hashTy³Next
(
hashTy³I‹¿tÜ
 *
hi
) {

349 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

350 *
zl
;

351 *
åŒ
, *
v±r
;

353 
zl
 = 
hi
->
subjeù
->
±r
;

354 
åŒ
 = 
hi
->fptr;

355 
v±r
 = 
hi
->vptr;

357 ià(
åŒ
 =ğ
NULL
) {

359 
	`£rv”As£¹
(
v±r
 =ğ
NULL
);

360 
åŒ
 = 
	`zli¡Index
(
zl
, 0);

363 
	`£rv”As£¹
(
v±r
 !ğ
NULL
);

364 
åŒ
 = 
	`zli¡Next
(
zl
, 
v±r
);

366 ià(
åŒ
 =ğ
NULL
è 
C_ERR
;

369 
v±r
 = 
	`zli¡Next
(
zl
, 
åŒ
);

370 
	`£rv”As£¹
(
v±r
 !ğ
NULL
);

373 
hi
->
åŒ
 = fptr;

374 
hi
->
v±r
 = vptr;

375 } ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

376 ià((
hi
->
de
 = 
	`diùNext
(hi->
di
)è=ğ
NULL
è 
C_ERR
;

378 
	`£rv”Pªic
("Unknown hashƒncoding");

380  
C_OK
;

381 
	}
}

385 
	$hashTy³Cu¼’tFromZli¡
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
,

386 **
v¡r
,

387 *
vËn
,

388 *
vÎ
)

390 
»t
;

392 
	`£rv”As£¹
(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
);

394 ià(
wh©
 & 
OBJ_HASH_KEY
) {

395 
»t
 = 
	`zli¡G‘
(
hi
->
åŒ
, 
v¡r
, 
vËn
, 
vÎ
);

396 
	`£rv”As£¹
(
»t
);

398 
»t
 = 
	`zli¡G‘
(
hi
->
v±r
, 
v¡r
, 
vËn
, 
vÎ
);

399 
	`£rv”As£¹
(
»t
);

401 
	}
}

406 
sds
 
	$hashTy³Cu¼’tFromHashTabË
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
) {

407 
	`£rv”As£¹
(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
);

409 ià(
wh©
 & 
OBJ_HASH_KEY
) {

410  
	`diùG‘Key
(
hi
->
de
);

412  
	`diùG‘V®
(
hi
->
de
);

414 
	}
}

426 
	$hashTy³Cu¼’tObjeù
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
, **
v¡r
, *
vËn
, *
vÎ
) {

427 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

428 *
v¡r
 = 
NULL
;

429 
	`hashTy³Cu¼’tFromZli¡
(
hi
, 
wh©
, 
v¡r
, 
vËn
, 
vÎ
);

430 } ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

431 
sds
 
–e
 = 
	`hashTy³Cu¼’tFromHashTabË
(
hi
, 
wh©
);

432 *
v¡r
 = (*è
–e
;

433 *
vËn
 = 
	`sd¦’
(
–e
);

435 
	`£rv”Pªic
("Unknown hashƒncoding");

437 
	}
}

441 
sds
 
	$hashTy³Cu¼’tObjeùNewSds
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
) {

442 *
v¡r
;

443 
vËn
;

444 
vÎ
;

446 
	`hashTy³Cu¼’tObjeù
(
hi
,
wh©
,&
v¡r
,&
vËn
,&
vÎ
);

447 ià(
v¡r
è 
	`sd¢ewËn
(v¡r,
vËn
);

448  
	`sdsäomlÚglÚg
(
vÎ
);

449 
	}
}

451 
robj
 *
	$hashTy³LookupWr™eOrC»©e
(
ş›Á
 *
c
, 
robj
 *
key
) {

452 
robj
 *
o
 = 
	`lookupKeyWr™e
(
c
->
db
,
key
);

453 ià(
o
 =ğ
NULL
) {

454 
o
 = 
	`ü—‹HashObjeù
();

455 
	`dbAdd
(
c
->
db
,
key
,
o
);

457 ià(
o
->
ty³
 !ğ
OBJ_HASH
) {

458 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

459  
NULL
;

462  
o
;

463 
	}
}

465 
	$hashTy³CÚv”tZli¡
(
robj
 *
o
, 
’c
) {

466 
	`£rv”As£¹
(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
);

468 ià(
’c
 =ğ
OBJ_ENCODING_ZIPLIST
) {

471 } ià(
’c
 =ğ
OBJ_ENCODING_HT
) {

472 
hashTy³I‹¿tÜ
 *
hi
;

473 
diù
 *dict;

474 
»t
;

476 
hi
 = 
	`hashTy³In™I‹¿tÜ
(
o
);

477 
diù
 = 
	`diùC»©e
(&
hashDiùTy³
, 
NULL
);

479 
	`hashTy³Next
(
hi
è!ğ
C_ERR
) {

480 
sds
 
key
, 
v®ue
;

482 
key
 = 
	`hashTy³Cu¼’tObjeùNewSds
(
hi
,
OBJ_HASH_KEY
);

483 
v®ue
 = 
	`hashTy³Cu¼’tObjeùNewSds
(
hi
,
OBJ_HASH_VALUE
);

484 
»t
 = 
	`diùAdd
(
diù
, 
key
, 
v®ue
);

485 ià(
»t
 !ğ
DICT_OK
) {

486 
	`£rv”LogHexDump
(
LL_WARNING
,"ziplist with dupƒlements dump",

487 
o
->
±r
,
	`zli¡BlobL’
(o->ptr));

488 
	`£rv”Pªic
("Ziplist corruption detected");

491 
	`hashTy³R–—£I‹¿tÜ
(
hi
);

492 
	`zä“
(
o
->
±r
);

493 
o
->
’codšg
 = 
OBJ_ENCODING_HT
;

494 
o
->
±r
 = 
diù
;

496 
	`£rv”Pªic
("Unknown hashƒncoding");

498 
	}
}

500 
	$hashTy³CÚv”t
(
robj
 *
o
, 
’c
) {

501 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

502 
	`hashTy³CÚv”tZli¡
(
o
, 
’c
);

503 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

504 
	`£rv”Pªic
("Not implemented");

506 
	`£rv”Pªic
("Unknown hashƒncoding");

508 
	}
}

514 
	$h£ŠxCommªd
(
ş›Á
 *
c
) {

515 
robj
 *
o
;

516 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1])è=ğ
NULL
) ;

517 
	`hashTy³TryCÚv”siÚ
(
o
,
c
->
¬gv
,2,3);

519 ià(
	`hashTy³Exi¡s
(
o
, 
c
->
¬gv
[2]->
±r
)) {

520 
	`addR•ly
(
c
, 
sh¬ed
.
cz”o
);

522 
	`hashTy³S‘
(
o
,
c
->
¬gv
[2]->
±r
,c->¬gv[3]->±r,
HASH_SET_COPY
);

523 
	`addR•ly
(
c
, 
sh¬ed
.
cÚe
);

524 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

525 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"h£t",
c
->
¬gv
[1],c->
db
->
id
);

526 
£rv”
.
dœty
++;

528 
	}
}

530 
	$h£tCommªd
(
ş›Á
 *
c
) {

531 
i
, 
ü—‹d
 = 0;

532 
robj
 *
o
;

534 ià((
c
->
¬gc
 % 2) == 1) {

535 
	`addR•lyE¼Ü
(
c
,"wrong‚umber of‡rguments for HMSET");

539 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1])è=ğ
NULL
) ;

540 
	`hashTy³TryCÚv”siÚ
(
o
,
c
->
¬gv
,2,c->
¬gc
-1);

542 
i
 = 2; i < 
c
->
¬gc
; i += 2)

543 
ü—‹d
 +ğ!
	`hashTy³S‘
(
o
,
c
->
¬gv
[
i
]->
±r
,c->¬gv[i+1]->±r,
HASH_SET_COPY
);

546 *
cmdÇme
 = 
c
->
¬gv
[0]->
±r
;

547 ià(
cmdÇme
[1] == 's' || cmdname[1] == 'S') {

549 
	`addR•lyLÚgLÚg
(
c
, 
ü—‹d
);

552 
	`addR•ly
(
c
, 
sh¬ed
.
ok
);

554 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

555 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"h£t",
c
->
¬gv
[1],c->
db
->
id
);

556 
£rv”
.
dœty
++;

557 
	}
}

559 
	$hšübyCommªd
(
ş›Á
 *
c
) {

560 
v®ue
, 
šü
, 
Şdv®ue
;

561 
robj
 *
o
;

562 
sds
 
Ãw
;

563 *
v¡r
;

564 
vËn
;

566 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
šü
,
NULL
è!ğ
C_OK
) ;

567 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1])è=ğ
NULL
) ;

568 ià(
	`hashTy³G‘V®ue
(
o
,
c
->
¬gv
[2]->
±r
,&
v¡r
,&
vËn
,&
v®ue
è=ğ
C_OK
) {

569 ià(
v¡r
) {

570 ià(
	`¡ršg2Î
((*)
v¡r
,
vËn
,&
v®ue
) == 0) {

571 
	`addR•lyE¼Ü
(
c
,"hash value is‚ot‡n integer");

576 
v®ue
 = 0;

579 
Şdv®ue
 = 
v®ue
;

580 ià((
šü
 < 0 && 
Şdv®ue
 < 0 && inü < (
LLONG_MIN
-oldvalue)) ||

581 (
šü
 > 0 && 
Şdv®ue
 > 0 && inü > (
LLONG_MAX
-oldvalue))) {

582 
	`addR•lyE¼Ü
(
c
,"increment or decrement would overflow");

585 
v®ue
 +ğ
šü
;

586 
Ãw
 = 
	`sdsäomlÚglÚg
(
v®ue
);

587 
	`hashTy³S‘
(
o
,
c
->
¬gv
[2]->
±r
,
Ãw
,
HASH_SET_TAKE_VALUE
);

588 
	`addR•lyLÚgLÚg
(
c
,
v®ue
);

589 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

590 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"hšüby",
c
->
¬gv
[1],c->
db
->
id
);

591 
£rv”
.
dœty
++;

592 
	}
}

594 
	$hšübyæßtCommªd
(
ş›Á
 *
c
) {

595 
v®ue
, 
šü
;

596 
Î
;

597 
robj
 *
o
;

598 
sds
 
Ãw
;

599 *
v¡r
;

600 
vËn
;

602 ià(
	`g‘LÚgDoubËFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
šü
,
NULL
è!ğ
C_OK
) ;

603 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1])è=ğ
NULL
) ;

604 ià(
	`hashTy³G‘V®ue
(
o
,
c
->
¬gv
[2]->
±r
,&
v¡r
,&
vËn
,&
Î
è=ğ
C_OK
) {

605 ià(
v¡r
) {

606 ià(
	`¡ršg2ld
((*)
v¡r
,
vËn
,&
v®ue
) == 0) {

607 
	`addR•lyE¼Ü
(
c
,"hash value is‚ot‡ float");

611 
v®ue
 = ()
Î
;

614 
v®ue
 = 0;

617 
v®ue
 +ğ
šü
;

619 
buf
[256];

620 
Ën
 = 
	`ld2¡ršg
(
buf
,(buf),
v®ue
,1);

621 
Ãw
 = 
	`sd¢ewËn
(
buf
,
Ën
);

622 
	`hashTy³S‘
(
o
,
c
->
¬gv
[2]->
±r
,
Ãw
,
HASH_SET_TAKE_VALUE
);

623 
	`addR•lyBulkCBufãr
(
c
,
buf
,
Ën
);

624 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

625 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"hšübyæßt",
c
->
¬gv
[1],c->
db
->
id
);

626 
£rv”
.
dœty
++;

631 
robj
 *
aux
, *
Ãwobj
;

632 
aux
 = 
	`ü—‹SŒšgObjeù
("HSET",4);

633 
Ãwobj
 = 
	`ü—‹RawSŒšgObjeù
(
buf
,
Ën
);

634 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,0,
aux
);

635 
	`deüRefCouÁ
(
aux
);

636 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,3,
Ãwobj
);

637 
	`deüRefCouÁ
(
Ãwobj
);

638 
	}
}

640 
	$addHashF›ldToR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, 
sds
 
f›ld
) {

641 
»t
;

643 ià(
o
 =ğ
NULL
) {

644 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

648 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

649 *
v¡r
 = 
NULL
;

650 
vËn
 = 
UINT_MAX
;

651 
vÎ
 = 
LLONG_MAX
;

653 
»t
 = 
	`hashTy³G‘FromZli¡
(
o
, 
f›ld
, &
v¡r
, &
vËn
, &
vÎ
);

654 ià(
»t
 < 0) {

655 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

657 ià(
v¡r
) {

658 
	`addR•lyBulkCBufãr
(
c
, 
v¡r
, 
vËn
);

660 
	`addR•lyBulkLÚgLÚg
(
c
, 
vÎ
);

664 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

665 
sds
 
v®ue
 = 
	`hashTy³G‘FromHashTabË
(
o
, 
f›ld
);

666 ià(
v®ue
 =ğ
NULL
)

667 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

669 
	`addR•lyBulkCBufãr
(
c
, 
v®ue
, 
	`sd¦’
(value));

671 
	`£rv”Pªic
("Unknown hashƒncoding");

673 
	}
}

675 
	$hg‘Commªd
(
ş›Á
 *
c
) {

676 
robj
 *
o
;

678 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
)è=ğ
NULL
 ||

679 
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) ;

681 
	`addHashF›ldToR•ly
(
c
, 
o
, c->
¬gv
[2]->
±r
);

682 
	}
}

684 
	$hmg‘Commªd
(
ş›Á
 *
c
) {

685 
robj
 *
o
;

686 
i
;

690 
o
 = 
	`lookupKeyR—d
(
c
->
db
, c->
¬gv
[1]);

691 ià(
o
 !ğ
NULL
 && o->
ty³
 !ğ
OBJ_HASH
) {

692 
	`addR•ly
(
c
, 
sh¬ed
.
wrÚgty³”r
);

696 
	`addR•lyMuÉiBulkL’
(
c
, c->
¬gc
-2);

697 
i
 = 2; i < 
c
->
¬gc
; i++) {

698 
	`addHashF›ldToR•ly
(
c
, 
o
, c->
¬gv
[
i
]->
±r
);

700 
	}
}

702 
	$hd–Commªd
(
ş›Á
 *
c
) {

703 
robj
 *
o
;

704 
j
, 
d–‘ed
 = 0, 
key»moved
 = 0;

706 ià((
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

707 
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) ;

709 
j
 = 2; j < 
c
->
¬gc
; j++) {

710 ià(
	`hashTy³D–‘e
(
o
,
c
->
¬gv
[
j
]->
±r
)) {

711 
d–‘ed
++;

712 ià(
	`hashTy³L’gth
(
o
) == 0) {

713 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

714 
key»moved
 = 1;

719 ià(
d–‘ed
) {

720 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

721 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"hd–",
c
->
¬gv
[1],c->
db
->
id
);

722 ià(
key»moved
)

723 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],

724 
c
->
db
->
id
);

725 
£rv”
.
dœty
 +ğ
d–‘ed
;

727 
	`addR•lyLÚgLÚg
(
c
,
d–‘ed
);

728 
	}
}

730 
	$hËnCommªd
(
ş›Á
 *
c
) {

731 
robj
 *
o
;

733 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

734 
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) ;

736 
	`addR•lyLÚgLÚg
(
c
,
	`hashTy³L’gth
(
o
));

737 
	}
}

739 
	$h¡¾’Commªd
(
ş›Á
 *
c
) {

740 
robj
 *
o
;

742 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

743 
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) ;

744 
	`addR•lyLÚgLÚg
(
c
,
	`hashTy³G‘V®ueL’gth
(
o
,c->
¬gv
[2]->
±r
));

745 
	}
}

747 
	$addHashI‹¿tÜCursÜToR•ly
(
ş›Á
 *
c
, 
hashTy³I‹¿tÜ
 *
hi
, 
wh©
) {

748 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

749 *
v¡r
 = 
NULL
;

750 
vËn
 = 
UINT_MAX
;

751 
vÎ
 = 
LLONG_MAX
;

753 
	`hashTy³Cu¼’tFromZli¡
(
hi
, 
wh©
, &
v¡r
, &
vËn
, &
vÎ
);

754 ià(
v¡r
)

755 
	`addR•lyBulkCBufãr
(
c
, 
v¡r
, 
vËn
);

757 
	`addR•lyBulkLÚgLÚg
(
c
, 
vÎ
);

758 } ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

759 
sds
 
v®ue
 = 
	`hashTy³Cu¼’tFromHashTabË
(
hi
, 
wh©
);

760 
	`addR•lyBulkCBufãr
(
c
, 
v®ue
, 
	`sd¦’
(value));

762 
	`£rv”Pªic
("Unknown hashƒncoding");

764 
	}
}

766 
	$g’”icHg‘®lCommªd
(
ş›Á
 *
c
, 
æags
) {

767 
robj
 *
o
;

768 
hashTy³I‹¿tÜ
 *
hi
;

769 
muÉl›r
 = 0;

770 
Ëngth
, 
couÁ
 = 0;

772 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL


773 || 
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) ;

775 ià(
æags
 & 
OBJ_HASH_KEY
è
muÉl›r
++;

776 ià(
æags
 & 
OBJ_HASH_VALUE
è
muÉl›r
++;

778 
Ëngth
 = 
	`hashTy³L’gth
(
o
è* 
muÉl›r
;

779 
	`addR•lyMuÉiBulkL’
(
c
, 
Ëngth
);

781 
hi
 = 
	`hashTy³In™I‹¿tÜ
(
o
);

782 
	`hashTy³Next
(
hi
è!ğ
C_ERR
) {

783 ià(
æags
 & 
OBJ_HASH_KEY
) {

784 
	`addHashI‹¿tÜCursÜToR•ly
(
c
, 
hi
, 
OBJ_HASH_KEY
);

785 
couÁ
++;

787 ià(
æags
 & 
OBJ_HASH_VALUE
) {

788 
	`addHashI‹¿tÜCursÜToR•ly
(
c
, 
hi
, 
OBJ_HASH_VALUE
);

789 
couÁ
++;

793 
	`hashTy³R–—£I‹¿tÜ
(
hi
);

794 
	`£rv”As£¹
(
couÁ
 =ğ
Ëngth
);

795 
	}
}

797 
	$hkeysCommªd
(
ş›Á
 *
c
) {

798 
	`g’”icHg‘®lCommªd
(
c
,
OBJ_HASH_KEY
);

799 
	}
}

801 
	$hv®sCommªd
(
ş›Á
 *
c
) {

802 
	`g’”icHg‘®lCommªd
(
c
,
OBJ_HASH_VALUE
);

803 
	}
}

805 
	$hg‘®lCommªd
(
ş›Á
 *
c
) {

806 
	`g’”icHg‘®lCommªd
(
c
,
OBJ_HASH_KEY
|
OBJ_HASH_VALUE
);

807 
	}
}

809 
	$hexi¡sCommªd
(
ş›Á
 *
c
) {

810 
robj
 *
o
;

811 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

812 
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) ;

814 
	`addR•ly
(
c
, 
	`hashTy³Exi¡s
(
o
,c->
¬gv
[2]->
±r
è? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

815 
	}
}

817 
	$hsÿnCommªd
(
ş›Á
 *
c
) {

818 
robj
 *
o
;

819 
cursÜ
;

821 ià(
	`·r£SÿnCursÜOrR•ly
(
c
,c->
¬gv
[2],&
cursÜ
è=ğ
C_ERR
) ;

822 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ysÿn
)è=ğ
NULL
 ||

823 
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) ;

824 
	`sÿnG’”icCommªd
(
c
,
o
,
cursÜ
);

825 
	}
}

	@t_list.c

30 
	~"£rv”.h
"

41 
	$li¡Ty³Push
(
robj
 *
subjeù
,„obj *
v®ue
, 
wh”e
) {

42 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

43 
pos
 = (
wh”e
 =ğ
LIST_HEAD
è? 
QUICKLIST_HEAD
 : 
QUICKLIST_TAIL
;

44 
v®ue
 = 
	`g‘DecodedObjeù
(value);

45 
size_t
 
Ën
 = 
	`sd¦’
(
v®ue
->
±r
);

46 
	`quickli¡Push
(
subjeù
->
±r
, 
v®ue
->±r, 
Ën
, 
pos
);

47 
	`deüRefCouÁ
(
v®ue
);

49 
	`£rv”Pªic
("Unknown†istƒncoding");

51 
	}
}

53 *
	$li¡PİSav”
(*
d©a
, 
sz
) {

54  
	`ü—‹SŒšgObjeù
((*)
d©a
,
sz
);

55 
	}
}

57 
robj
 *
	$li¡Ty³Pİ
(
robj
 *
subjeù
, 
wh”e
) {

58 
vlÚg
;

59 
robj
 *
v®ue
 = 
NULL
;

61 
ql_wh”e
 = 
wh”e
 =ğ
LIST_HEAD
 ? 
QUICKLIST_HEAD
 : 
QUICKLIST_TAIL
;

62 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

63 ià(
	`quickli¡PİCu¡om
(
subjeù
->
±r
, 
ql_wh”e
, (**)&
v®ue
,

64 
NULL
, &
vlÚg
, 
li¡PİSav”
)) {

65 ià(!
v®ue
)

66 
v®ue
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vlÚg
);

69 
	`£rv”Pªic
("Unknown†istƒncoding");

71  
v®ue
;

72 
	}
}

74 
	$li¡Ty³L’gth
(cÚ¡ 
robj
 *
subjeù
) {

75 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

76  
	`quickli¡CouÁ
(
subjeù
->
±r
);

78 
	`£rv”Pªic
("Unknown†istƒncoding");

80 
	}
}

83 
li¡Ty³I‹¿tÜ
 *
	$li¡Ty³In™I‹¿tÜ
(
robj
 *
subjeù
, 
šdex
,

84 
dœeùiÚ
) {

85 
li¡Ty³I‹¿tÜ
 *
li
 = 
	`zm®loc
((listTypeIterator));

86 
li
->
subjeù
 = subject;

87 
li
->
’codšg
 = 
subjeù
->encoding;

88 
li
->
dœeùiÚ
 = direction;

89 
li
->
™”
 = 
NULL
;

92 
™”_dœeùiÚ
 =

93 
dœeùiÚ
 =ğ
LIST_HEAD
 ? 
AL_START_TAIL
 : 
AL_START_HEAD
;

94 ià(
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

95 
li
->
™”
 = 
	`quickli¡G‘I‹¿tÜAtIdx
Öi->
subjeù
->
±r
,

96 
™”_dœeùiÚ
, 
šdex
);

98 
	`£rv”Pªic
("Unknown†istƒncoding");

100  
li
;

101 
	}
}

104 
	$li¡Ty³R–—£I‹¿tÜ
(
li¡Ty³I‹¿tÜ
 *
li
) {

105 
	`zä“
(
li
->
™”
);

106 
	`zä“
(
li
);

107 
	}
}

112 
	$li¡Ty³Next
(
li¡Ty³I‹¿tÜ
 *
li
, 
li¡Ty³EÁry
 *
’Œy
) {

114 
	`£rv”As£¹
(
li
->
subjeù
->
’codšg
 ==†i->encoding);

116 
’Œy
->
li
 =†i;

117 ià(
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

118  
	`quickli¡Next
(
li
->
™”
, &
’Œy
->entry);

120 
	`£rv”Pªic
("Unknown†istƒncoding");

123 
	}
}

126 
robj
 *
	$li¡Ty³G‘
(
li¡Ty³EÁry
 *
’Œy
) {

127 
robj
 *
v®ue
 = 
NULL
;

128 ià(
’Œy
->
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

129 ià(
’Œy
->’Œy.
v®ue
) {

130 
v®ue
 = 
	`ü—‹SŒšgObjeù
((*)
’Œy
->entry.value,

131 
’Œy
->’Œy.
sz
);

133 
v®ue
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
’Œy
->’Œy.
lÚgv®
);

136 
	`£rv”Pªic
("Unknown†istƒncoding");

138  
v®ue
;

139 
	}
}

141 
	$li¡Ty³In£¹
(
li¡Ty³EÁry
 *
’Œy
, 
robj
 *
v®ue
, 
wh”e
) {

142 ià(
’Œy
->
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

143 
v®ue
 = 
	`g‘DecodedObjeù
(value);

144 
sds
 
¡r
 = 
v®ue
->
±r
;

145 
size_t
 
Ën
 = 
	`sd¦’
(
¡r
);

146 ià(
wh”e
 =ğ
LIST_TAIL
) {

147 
	`quickli¡In£¹Aá”
((
quickli¡
 *)
’Œy
->entry.quicklist,

148 &
’Œy
->’Œy, 
¡r
, 
Ën
);

149 } ià(
wh”e
 =ğ
LIST_HEAD
) {

150 
	`quickli¡In£¹BefÜe
((
quickli¡
 *)
’Œy
->entry.quicklist,

151 &
’Œy
->’Œy, 
¡r
, 
Ën
);

153 
	`deüRefCouÁ
(
v®ue
);

155 
	`£rv”Pªic
("Unknown†istƒncoding");

157 
	}
}

160 
	$li¡Ty³Equ®
(
li¡Ty³EÁry
 *
’Œy
, 
robj
 *
o
) {

161 ià(
’Œy
->
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

162 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,
	`sdsEncodedObjeù
(o));

163  
	`quickli¡Com·»
(
’Œy
->’Œy.
zi
,
o
->
±r
,
	`sd¦’
(o->ptr));

165 
	`£rv”Pªic
("Unknown†istƒncoding");

167 
	}
}

170 
	$li¡Ty³D–‘e
(
li¡Ty³I‹¿tÜ
 *
™”
, 
li¡Ty³EÁry
 *
’Œy
) {

171 ià(
’Œy
->
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

172 
	`quickli¡D–EÁry
(
™”
->™”, &
’Œy
->entry);

174 
	`£rv”Pªic
("Unknown†istƒncoding");

176 
	}
}

179 
	$li¡Ty³CÚv”t
(
robj
 *
subjeù
, 
’c
) {

180 
	`£rv”As£¹W™hInfo
(
NULL
,
subjeù
,subjeù->
ty³
==
OBJ_LIST
);

181 
	`£rv”As£¹W™hInfo
(
NULL
,
subjeù
,subjeù->
’codšg
==
OBJ_ENCODING_ZIPLIST
);

183 ià(
’c
 =ğ
OBJ_ENCODING_QUICKLIST
) {

184 
size_t
 
zËn
 = 
£rv”
.
li¡_max_zli¡_size
;

185 
d•th
 = 
£rv”
.
li¡_com´ess_d•th
;

186 
subjeù
->
±r
 = 
	`quickli¡C»©eFromZli¡
(
zËn
, 
d•th
, subject->ptr);

187 
subjeù
->
’codšg
 = 
OBJ_ENCODING_QUICKLIST
;

189 
	`£rv”Pªic
("Unsupported†ist conversion");

191 
	}
}

197 
	$pushG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
) {

198 
j
, 
pushed
 = 0;

199 
robj
 *
lobj
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

201 ià(
lobj
 &&†obj->
ty³
 !ğ
OBJ_LIST
) {

202 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

206 
j
 = 2; j < 
c
->
¬gc
; j++) {

207 ià(!
lobj
) {

208 
lobj
 = 
	`ü—‹Quickli¡Objeù
();

209 
	`quickli¡S‘O±iÚs
(
lobj
->
±r
, 
£rv”
.
li¡_max_zli¡_size
,

210 
£rv”
.
li¡_com´ess_d•th
);

211 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
lobj
);

213 
	`li¡Ty³Push
(
lobj
,
c
->
¬gv
[
j
],
wh”e
);

214 
pushed
++;

216 
	`addR•lyLÚgLÚg
(
c
, (
lobj
 ? 
	`li¡Ty³L’gth
(lobj) : 0));

217 ià(
pushed
) {

218 *
ev’t
 = (
wh”e
 =ğ
LIST_HEAD
) ? "lpush" : "rpush";

220 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

221 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,
ev’t
,
c
->
¬gv
[1],c->
db
->
id
);

223 
£rv”
.
dœty
 +ğ
pushed
;

224 
	}
}

226 
	$ÍushCommªd
(
ş›Á
 *
c
) {

227 
	`pushG’”icCommªd
(
c
,
LIST_HEAD
);

228 
	}
}

230 
	$½ushCommªd
(
ş›Á
 *
c
) {

231 
	`pushG’”icCommªd
(
c
,
LIST_TAIL
);

232 
	}
}

234 
	$pushxG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
) {

235 
j
, 
pushed
 = 0;

236 
robj
 *
subjeù
;

238 ià((
subjeù
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

239 
	`checkTy³
(
c
,
subjeù
,
OBJ_LIST
)) ;

241 
j
 = 2; j < 
c
->
¬gc
; j++) {

242 
	`li¡Ty³Push
(
subjeù
,
c
->
¬gv
[
j
],
wh”e
);

243 
pushed
++;

246 
	`addR•lyLÚgLÚg
(
c
,
	`li¡Ty³L’gth
(
subjeù
));

248 ià(
pushed
) {

249 *
ev’t
 = (
wh”e
 =ğ
LIST_HEAD
) ? "lpush" : "rpush";

250 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

251 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,
ev’t
,
c
->
¬gv
[1],c->
db
->
id
);

253 
£rv”
.
dœty
 +ğ
pushed
;

254 
	}
}

256 
	$ÍushxCommªd
(
ş›Á
 *
c
) {

257 
	`pushxG’”icCommªd
(
c
,
LIST_HEAD
);

258 
	}
}

260 
	$½ushxCommªd
(
ş›Á
 *
c
) {

261 
	`pushxG’”icCommªd
(
c
,
LIST_TAIL
);

262 
	}
}

264 
	$lš£¹Commªd
(
ş›Á
 *
c
) {

265 
wh”e
;

266 
robj
 *
subjeù
;

267 
li¡Ty³I‹¿tÜ
 *
™”
;

268 
li¡Ty³EÁry
 
’Œy
;

269 
š£¹ed
 = 0;

271 ià(
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"after") == 0) {

272 
wh”e
 = 
LIST_TAIL
;

273 } ià(
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"before") == 0) {

274 
wh”e
 = 
LIST_HEAD
;

276 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

280 ià((
subjeù
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

281 
	`checkTy³
(
c
,
subjeù
,
OBJ_LIST
)) ;

284 
™”
 = 
	`li¡Ty³In™I‹¿tÜ
(
subjeù
,0,
LIST_TAIL
);

285 
	`li¡Ty³Next
(
™”
,&
’Œy
)) {

286 ià(
	`li¡Ty³Equ®
(&
’Œy
,
c
->
¬gv
[3])) {

287 
	`li¡Ty³In£¹
(&
’Œy
,
c
->
¬gv
[4],
wh”e
);

288 
š£¹ed
 = 1;

292 
	`li¡Ty³R–—£I‹¿tÜ
(
™”
);

294 ià(
š£¹ed
) {

295 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

296 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"linsert",

297 
c
->
¬gv
[1],c->
db
->
id
);

298 
£rv”
.
dœty
++;

301 
	`addR•ly
(
c
,
sh¬ed
.
úegÚe
);

305 
	`addR•lyLÚgLÚg
(
c
,
	`li¡Ty³L’gth
(
subjeù
));

306 
	}
}

308 
	$Î’Commªd
(
ş›Á
 *
c
) {

309 
robj
 *
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
);

310 ià(
o
 =ğ
NULL
 || 
	`checkTy³
(
c
,o,
OBJ_LIST
)) ;

311 
	`addR•lyLÚgLÚg
(
c
,
	`li¡Ty³L’gth
(
o
));

312 
	}
}

314 
	$lšdexCommªd
(
ş›Á
 *
c
) {

315 
robj
 *
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
);

316 ià(
o
 =ğ
NULL
 || 
	`checkTy³
(
c
,o,
OBJ_LIST
)) ;

317 
šdex
;

318 
robj
 *
v®ue
 = 
NULL
;

320 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
šdex
, 
NULL
è!ğ
C_OK
))

323 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

324 
quickli¡EÁry
 
’Œy
;

325 ià(
	`quickli¡Index
(
o
->
±r
, 
šdex
, &
’Œy
)) {

326 ià(
’Œy
.
v®ue
) {

327 
v®ue
 = 
	`ü—‹SŒšgObjeù
((*)
’Œy
.v®ue,’Œy.
sz
);

329 
v®ue
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
’Œy
.
lÚgv®
);

331 
	`addR•lyBulk
(
c
,
v®ue
);

332 
	`deüRefCouÁ
(
v®ue
);

334 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

337 
	`£rv”Pªic
("Unknown†istƒncoding");

339 
	}
}

341 
	$l£tCommªd
(
ş›Á
 *
c
) {

342 
robj
 *
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nokey”r
);

343 ià(
o
 =ğ
NULL
 || 
	`checkTy³
(
c
,o,
OBJ_LIST
)) ;

344 
šdex
;

345 
robj
 *
v®ue
 = 
c
->
¬gv
[3];

347 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
šdex
, 
NULL
è!ğ
C_OK
))

350 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

351 
quickli¡
 *
ql
 = 
o
->
±r
;

352 
»¶aûd
 = 
	`quickli¡R•ÏûAtIndex
(
ql
, 
šdex
,

353 
v®ue
->
±r
, 
	`sd¦’
(value->ptr));

354 ià(!
»¶aûd
) {

355 
	`addR•ly
(
c
,
sh¬ed
.
outoäªg“¼
);

357 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

358 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

359 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"l£t",
c
->
¬gv
[1],c->
db
->
id
);

360 
£rv”
.
dœty
++;

363 
	`£rv”Pªic
("Unknown†istƒncoding");

365 
	}
}

367 
	$pİG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
) {

368 
robj
 *
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
);

369 ià(
o
 =ğ
NULL
 || 
	`checkTy³
(
c
,o,
OBJ_LIST
)) ;

371 
robj
 *
v®ue
 = 
	`li¡Ty³Pİ
(
o
,
wh”e
);

372 ià(
v®ue
 =ğ
NULL
) {

373 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

375 *
ev’t
 = (
wh”e
 =ğ
LIST_HEAD
) ? "lpop" : "rpop";

377 
	`addR•lyBulk
(
c
,
v®ue
);

378 
	`deüRefCouÁ
(
v®ue
);

379 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,
ev’t
,
c
->
¬gv
[1],c->
db
->
id
);

380 ià(
	`li¡Ty³L’gth
(
o
) == 0) {

381 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"del",

382 
c
->
¬gv
[1],c->
db
->
id
);

383 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

385 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

386 
£rv”
.
dœty
++;

388 
	}
}

390 
	$ÍİCommªd
(
ş›Á
 *
c
) {

391 
	`pİG’”icCommªd
(
c
,
LIST_HEAD
);

392 
	}
}

394 
	$½İCommªd
(
ş›Á
 *
c
) {

395 
	`pİG’”icCommªd
(
c
,
LIST_TAIL
);

396 
	}
}

398 
	$ÌªgeCommªd
(
ş›Á
 *
c
) {

399 
robj
 *
o
;

400 
¡¬t
, 
’d
, 
Î’
, 
¿ng–’
;

402 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
¡¬t
, 
NULL
è!ğ
C_OK
) ||

403 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[3], &
’d
, 
NULL
è!ğ
C_OK
)) ;

405 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL


406 || 
	`checkTy³
(
c
,
o
,
OBJ_LIST
)) ;

407 
Î’
 = 
	`li¡Ty³L’gth
(
o
);

410 ià(
¡¬t
 < 0è¡¬ˆğ
Î’
+start;

411 ià(
’d
 < 0è’d = 
Î’
+end;

412 ià(
¡¬t
 < 0) start = 0;

416 ià(
¡¬t
 > 
’d
 || s¹ >ğ
Î’
) {

417 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

420 ià(
’d
 >ğ
Î’
)ƒnd =†len-1;

421 
¿ng–’
 = (
’d
-
¡¬t
)+1;

424 
	`addR•lyMuÉiBulkL’
(
c
,
¿ng–’
);

425 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

426 
li¡Ty³I‹¿tÜ
 *
™”
 = 
	`li¡Ty³In™I‹¿tÜ
(
o
, 
¡¬t
, 
LIST_TAIL
);

428 
¿ng–’
--) {

429 
li¡Ty³EÁry
 
’Œy
;

430 
	`li¡Ty³Next
(
™”
, &
’Œy
);

431 
quickli¡EÁry
 *
qe
 = &
’Œy
.entry;

432 ià(
qe
->
v®ue
) {

433 
	`addR•lyBulkCBufãr
(
c
,
qe
->
v®ue
,qe->
sz
);

435 
	`addR•lyBulkLÚgLÚg
(
c
,
qe
->
lÚgv®
);

438 
	`li¡Ty³R–—£I‹¿tÜ
(
™”
);

440 
	`£rv”Pªic
("Listƒncoding is‚ot QUICKLIST!");

442 
	}
}

444 
	$ÉrimCommªd
(
ş›Á
 *
c
) {

445 
robj
 *
o
;

446 
¡¬t
, 
’d
, 
Î’
, 
Érim
, 
¹rim
;

448 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
¡¬t
, 
NULL
è!ğ
C_OK
) ||

449 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[3], &
’d
, 
NULL
è!ğ
C_OK
)) ;

451 ià((
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
ok
)è=ğ
NULL
 ||

452 
	`checkTy³
(
c
,
o
,
OBJ_LIST
)) ;

453 
Î’
 = 
	`li¡Ty³L’gth
(
o
);

456 ià(
¡¬t
 < 0è¡¬ˆğ
Î’
+start;

457 ià(
’d
 < 0è’d = 
Î’
+end;

458 ià(
¡¬t
 < 0) start = 0;

462 ià(
¡¬t
 > 
’d
 || s¹ >ğ
Î’
) {

464 
Érim
 = 
Î’
;

465 
¹rim
 = 0;

467 ià(
’d
 >ğ
Î’
)ƒnd =†len-1;

468 
Érim
 = 
¡¬t
;

469 
¹rim
 = 
Î’
-
’d
-1;

473 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

474 
	`quickli¡D–Rªge
(
o
->
±r
,0,
Érim
);

475 
	`quickli¡D–Rªge
(
o
->
±r
,-
¹rim
,rtrim);

477 
	`£rv”Pªic
("Unknown†istƒncoding");

480 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"Érim",
c
->
¬gv
[1],c->
db
->
id
);

481 ià(
	`li¡Ty³L’gth
(
o
) == 0) {

482 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

483 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

485 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

486 
£rv”
.
dœty
++;

487 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

488 
	}
}

490 
	$ÌemCommªd
(
ş›Á
 *
c
) {

491 
robj
 *
subjeù
, *
obj
;

492 
obj
 = 
c
->
¬gv
[3];

493 
tÜemove
;

494 
»moved
 = 0;

496 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
tÜemove
, 
NULL
è!ğ
C_OK
))

499 
subjeù
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
);

500 ià(
subjeù
 =ğ
NULL
 || 
	`checkTy³
(
c
,subjeù,
OBJ_LIST
)) ;

502 
li¡Ty³I‹¿tÜ
 *
li
;

503 ià(
tÜemove
 < 0) {

504 
tÜemove
 = -toremove;

505 
li
 = 
	`li¡Ty³In™I‹¿tÜ
(
subjeù
,-1,
LIST_HEAD
);

507 
li
 = 
	`li¡Ty³In™I‹¿tÜ
(
subjeù
,0,
LIST_TAIL
);

510 
li¡Ty³EÁry
 
’Œy
;

511 
	`li¡Ty³Next
(
li
,&
’Œy
)) {

512 ià(
	`li¡Ty³Equ®
(&
’Œy
,
obj
)) {

513 
	`li¡Ty³D–‘e
(
li
, &
’Œy
);

514 
£rv”
.
dœty
++;

515 
»moved
++;

516 ià(
tÜemove
 && 
»moved
 ==oremove) ;

519 
	`li¡Ty³R–—£I‹¿tÜ
(
li
);

521 ià(
»moved
) {

522 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

523 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"Ìem",
c
->
¬gv
[1],c->
db
->
id
);

526 ià(
	`li¡Ty³L’gth
(
subjeù
) == 0) {

527 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

528 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

531 
	`addR•lyLÚgLÚg
(
c
,
»moved
);

532 
	}
}

550 
	$½İÍushHªdËPush
(
ş›Á
 *
c
, 
robj
 *
d¡key
,„obj *
d¡obj
,„obj *
v®ue
) {

552 ià(!
d¡obj
) {

553 
d¡obj
 = 
	`ü—‹Quickli¡Objeù
();

554 
	`quickli¡S‘O±iÚs
(
d¡obj
->
±r
, 
£rv”
.
li¡_max_zli¡_size
,

555 
£rv”
.
li¡_com´ess_d•th
);

556 
	`dbAdd
(
c
->
db
,
d¡key
,
d¡obj
);

558 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

559 
	`li¡Ty³Push
(
d¡obj
,
v®ue
,
LIST_HEAD
);

560 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"Íush",
d¡key
,
c
->
db
->
id
);

562 
	`addR•lyBulk
(
c
,
v®ue
);

563 
	}
}

565 
	$½İÍushCommªd
(
ş›Á
 *
c
) {

566 
robj
 *
sobj
, *
v®ue
;

567 ià((
sobj
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
)è=ğ
NULL
 ||

568 
	`checkTy³
(
c
,
sobj
,
OBJ_LIST
)) ;

570 ià(
	`li¡Ty³L’gth
(
sobj
) == 0) {

573 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

575 
robj
 *
dobj
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[2]);

576 
robj
 *
touchedkey
 = 
c
->
¬gv
[1];

578 ià(
dobj
 && 
	`checkTy³
(
c
,dobj,
OBJ_LIST
)) ;

579 
v®ue
 = 
	`li¡Ty³Pİ
(
sobj
,
LIST_TAIL
);

583 
	`šüRefCouÁ
(
touchedkey
);

584 
	`½İÍushHªdËPush
(
c
,c->
¬gv
[2],
dobj
,
v®ue
);

587 
	`deüRefCouÁ
(
v®ue
);

590 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"½İ",
touchedkey
,
c
->
db
->
id
);

591 ià(
	`li¡Ty³L’gth
(
sobj
) == 0) {

592 
	`dbD–‘e
(
c
->
db
,
touchedkey
);

593 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"del",

594 
touchedkey
,
c
->
db
->
id
);

596 
	`sigÇlModif›dKey
(
c
->
db
,
touchedkey
);

597 
	`deüRefCouÁ
(
touchedkey
);

598 
£rv”
.
dœty
++;

600 
	}
}

625 
	$blockFÜKeys
(
ş›Á
 *
c
, 
robj
 **
keys
, 
numkeys
, 
m¡ime_t
 
timeout
,„obj *
rg‘
) {

626 
diùEÁry
 *
de
;

627 
li¡
 *
l
;

628 
j
;

630 
c
->
bpİ
.
timeout
 =imeout;

631 
c
->
bpİ
.
rg‘
 =arget;

633 ià(
rg‘
 !ğ
NULL
è
	`šüRefCouÁ
(target);

635 
j
 = 0; j < 
numkeys
; j++) {

637 ià(
	`diùAdd
(
c
->
bpİ
.
keys
,keys[
j
],
NULL
è!ğ
DICT_OK
) ;

638 
	`šüRefCouÁ
(
keys
[
j
]);

641 
de
 = 
	`diùFšd
(
c
->
db
->
blockšg_keys
,
keys
[
j
]);

642 ià(
de
 =ğ
NULL
) {

643 
»tv®
;

646 
l
 = 
	`li¡C»©e
();

647 
»tv®
 = 
	`diùAdd
(
c
->
db
->
blockšg_keys
,
keys
[
j
],
l
);

648 
	`šüRefCouÁ
(
keys
[
j
]);

649 
	`£rv”As£¹W™hInfo
(
c
,
keys
[
j
],
»tv®
 =ğ
DICT_OK
);

651 
l
 = 
	`diùG‘V®
(
de
);

653 
	`li¡AddNodeTa
(
l
,
c
);

655 
	`blockCl›Á
(
c
,
BLOCKED_LIST
);

656 
	}
}

660 
	$unblockCl›ÁWa™šgD©a
(
ş›Á
 *
c
) {

661 
diùEÁry
 *
de
;

662 
diùI‹¿tÜ
 *
di
;

663 
li¡
 *
l
;

665 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`diùSize
(c->
bpİ
.
keys
) != 0);

666 
di
 = 
	`diùG‘I‹¿tÜ
(
c
->
bpİ
.
keys
);

668 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

669 
robj
 *
key
 = 
	`diùG‘Key
(
de
);

672 
l
 = 
	`diùF‘chV®ue
(
c
->
db
->
blockšg_keys
,
key
);

673 
	`£rv”As£¹W™hInfo
(
c
,
key
,
l
 !ğ
NULL
);

674 
	`li¡D–Node
(
l
,
	`li¡S—rchKey
Ö,
c
));

676 ià(
	`li¡L’gth
(
l
) == 0)

677 
	`diùD–‘e
(
c
->
db
->
blockšg_keys
,
key
);

679 
	`diùR–—£I‹¿tÜ
(
di
);

682 
	`diùEm±y
(
c
->
bpİ
.
keys
,
NULL
);

683 ià(
c
->
bpİ
.
rg‘
) {

684 
	`deüRefCouÁ
(
c
->
bpİ
.
rg‘
);

685 
c
->
bpİ
.
rg‘
 = 
NULL
;

687 
	}
}

696 
	$sigÇlLi¡AsR—dy
(
»disDb
 *
db
, 
robj
 *
key
) {

697 
»adyLi¡
 *
¾
;

700 ià(
	`diùFšd
(
db
->
blockšg_keys
,
key
è=ğ
NULL
) ;

703 ià(
	`diùFšd
(
db
->
»ady_keys
,
key
è!ğ
NULL
) ;

706 
¾
 = 
	`zm®loc
((*rl));

707 
¾
->
key
 = key;

708 
¾
->
db
 = db;

709 
	`šüRefCouÁ
(
key
);

710 
	`li¡AddNodeTa
(
£rv”
.
»ady_keys
,
¾
);

715 
	`šüRefCouÁ
(
key
);

716 
	`£rv”As£¹
(
	`diùAdd
(
db
->
»ady_keys
,
key
,
NULL
è=ğ
DICT_OK
);

717 
	}
}

738 
	$£rveCl›ÁBlockedOnLi¡
(
ş›Á
 *
»ûiv”
, 
robj
 *
key
,„obj *
d¡key
, 
»disDb
 *
db
,„obj *
v®ue
, 
wh”e
)

740 
robj
 *
¬gv
[3];

742 ià(
d¡key
 =ğ
NULL
) {

744 
¬gv
[0] = (
wh”e
 =ğ
LIST_HEAD
è? 
sh¬ed
.
Íİ
 :

745 
sh¬ed
.
½İ
;

746 
¬gv
[1] = 
key
;

747 
	`´İag©e
((
wh”e
 =ğ
LIST_HEAD
) ?

748 
£rv”
.
ÍİCommªd
 : s”v”.
½İCommªd
,

749 
db
->
id
,
¬gv
,2,
PROPAGATE_AOF
|
PROPAGATE_REPL
);

752 
	`addR•lyMuÉiBulkL’
(
»ûiv”
,2);

753 
	`addR•lyBulk
(
»ûiv”
,
key
);

754 
	`addR•lyBulk
(
»ûiv”
,
v®ue
);

757 
robj
 *
d¡obj
 =

758 
	`lookupKeyWr™e
(
»ûiv”
->
db
,
d¡key
);

759 ià(!(
d¡obj
 &&

760 
	`checkTy³
(
»ûiv”
,
d¡obj
,
OBJ_LIST
)))

763 
¬gv
[0] = 
sh¬ed
.
½İ
;

764 
¬gv
[1] = 
key
;

765 
	`´İag©e
(
£rv”
.
½İCommªd
,

766 
db
->
id
,
¬gv
,2,

767 
PROPAGATE_AOF
|

768 
PROPAGATE_REPL
);

769 
	`½İÍushHªdËPush
(
»ûiv”
,
d¡key
,
d¡obj
,

770 
v®ue
);

772 
¬gv
[0] = 
sh¬ed
.
Íush
;

773 
¬gv
[1] = 
d¡key
;

774 
¬gv
[2] = 
v®ue
;

775 
	`´İag©e
(
£rv”
.
ÍushCommªd
,

776 
db
->
id
,
¬gv
,3,

777 
PROPAGATE_AOF
|

778 
PROPAGATE_REPL
);

782  
C_ERR
;

785  
C_OK
;

786 
	}
}

798 
	$hªdËCl›ÁsBlockedOnLi¡s
() {

799 
	`li¡L’gth
(
£rv”
.
»ady_keys
) != 0) {

800 
li¡
 *
l
;

806 
l
 = 
£rv”
.
»ady_keys
;

807 
£rv”
.
»ady_keys
 = 
	`li¡C»©e
();

809 
	`li¡L’gth
(
l
) != 0) {

810 
li¡Node
 *
Ê
 = 
	`li¡Fœ¡
(
l
);

811 
»adyLi¡
 *
¾
 = 
Ê
->
v®ue
;

815 
	`diùD–‘e
(
¾
->
db
->
»ady_keys
,¾->
key
);

819 
robj
 *
o
 = 
	`lookupKeyWr™e
(
¾
->
db
,¾->
key
);

820 ià(
o
 !ğ
NULL
 && o->
ty³
 =ğ
OBJ_LIST
) {

821 
diùEÁry
 *
de
;

825 
de
 = 
	`diùFšd
(
¾
->
db
->
blockšg_keys
,¾->
key
);

826 ià(
de
) {

827 
li¡
 *
ş›Ás
 = 
	`diùG‘V®
(
de
);

828 
numş›Ás
 = 
	`li¡L’gth
(
ş›Ás
);

830 
numş›Ás
--) {

831 
li¡Node
 *
ş›Ánode
 = 
	`li¡Fœ¡
(
ş›Ás
);

832 
ş›Á
 *
»ûiv”
 = 
ş›Ánode
->
v®ue
;

833 
robj
 *
d¡key
 = 
»ûiv”
->
bpİ
.
rg‘
;

834 
wh”e
 = (
»ûiv”
->
Ï¡cmd
 &&

835 
»ûiv”
->
Ï¡cmd
->
´oc
 =ğ
bÍİCommªd
) ?

836 
LIST_HEAD
 : 
LIST_TAIL
;

837 
robj
 *
v®ue
 = 
	`li¡Ty³Pİ
(
o
,
wh”e
);

839 ià(
v®ue
) {

843 ià(
d¡key
è
	`šüRefCouÁ
(dstkey);

844 
	`unblockCl›Á
(
»ûiv”
);

846 ià(
	`£rveCl›ÁBlockedOnLi¡
(
»ûiv”
,

847 
¾
->
key
,
d¡key
,¾->
db
,
v®ue
,

848 
wh”e
è=ğ
C_ERR
)

852 
	`li¡Ty³Push
(
o
,
v®ue
,
wh”e
);

855 ià(
d¡key
è
	`deüRefCouÁ
(dstkey);

856 
	`deüRefCouÁ
(
v®ue
);

863 ià(
	`li¡Ty³L’gth
(
o
) == 0) {

864 
	`dbD–‘e
(
¾
->
db
,¾->
key
);

871 
	`deüRefCouÁ
(
¾
->
key
);

872 
	`zä“
(
¾
);

873 
	`li¡D–Node
(
l
,
Ê
);

875 
	`li¡R–—£
(
l
);

877 
	}
}

880 
	$blockšgPİG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
) {

881 
robj
 *
o
;

882 
m¡ime_t
 
timeout
;

883 
j
;

885 ià(
	`g‘TimeoutFromObjeùOrR•ly
(
c
,c->
¬gv
[c->
¬gc
-1],&
timeout
,
UNIT_SECONDS
)

886 !ğ
C_OK
) ;

888 
j
 = 1; j < 
c
->
¬gc
-1; j++) {

889 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[
j
]);

890 ià(
o
 !ğ
NULL
) {

891 ià(
o
->
ty³
 !ğ
OBJ_LIST
) {

892 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

895 ià(
	`li¡Ty³L’gth
(
o
) != 0) {

897 *
ev’t
 = (
wh”e
 =ğ
LIST_HEAD
) ? "lpop" : "rpop";

898 
robj
 *
v®ue
 = 
	`li¡Ty³Pİ
(
o
,
wh”e
);

899 
	`£rv”As£¹
(
v®ue
 !ğ
NULL
);

901 
	`addR•lyMuÉiBulkL’
(
c
,2);

902 
	`addR•lyBulk
(
c
,c->
¬gv
[
j
]);

903 
	`addR•lyBulk
(
c
,
v®ue
);

904 
	`deüRefCouÁ
(
v®ue
);

905 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,
ev’t
,

906 
c
->
¬gv
[
j
],c->
db
->
id
);

907 ià(
	`li¡Ty³L’gth
(
o
) == 0) {

908 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[
j
]);

909 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"del",

910 
c
->
¬gv
[
j
],c->
db
->
id
);

912 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[
j
]);

913 
£rv”
.
dœty
++;

916 
	`»wr™eCl›ÁCommªdVeùÜ
(
c
,2,

917 (
wh”e
 =ğ
LIST_HEAD
è? 
sh¬ed
.
Íİ
 : sh¬ed.
½İ
,

918 
c
->
¬gv
[
j
]);

927 ià(
c
->
æags
 & 
CLIENT_MULTI
) {

928 
	`addR•ly
(
c
,
sh¬ed
.
nuÎmuÉibulk
);

933 
	`blockFÜKeys
(
c
, c->
¬gv
 + 1, c->
¬gc
 - 2, 
timeout
, 
NULL
);

934 
	}
}

936 
	$bÍİCommªd
(
ş›Á
 *
c
) {

937 
	`blockšgPİG’”icCommªd
(
c
,
LIST_HEAD
);

938 
	}
}

940 
	$b½İCommªd
(
ş›Á
 *
c
) {

941 
	`blockšgPİG’”icCommªd
(
c
,
LIST_TAIL
);

942 
	}
}

944 
	$b½İÍushCommªd
(
ş›Á
 *
c
) {

945 
m¡ime_t
 
timeout
;

947 ià(
	`g‘TimeoutFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
timeout
,
UNIT_SECONDS
)

948 !ğ
C_OK
) ;

950 
robj
 *
key
 = 
	`lookupKeyWr™e
(
c
->
db
, c->
¬gv
[1]);

952 ià(
key
 =ğ
NULL
) {

953 ià(
c
->
æags
 & 
CLIENT_MULTI
) {

956 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

959 
	`blockFÜKeys
(
c
, c->
¬gv
 + 1, 1, 
timeout
, c->argv[2]);

962 ià(
key
->
ty³
 !ğ
OBJ_LIST
) {

963 
	`addR•ly
(
c
, 
sh¬ed
.
wrÚgty³”r
);

967 
	`£rv”As£¹W™hInfo
(
c
,
key
,
	`li¡Ty³L’gth
(key) > 0);

968 
	`½İÍushCommªd
(
c
);

971 
	}
}

	@t_set.c

30 
	~"£rv”.h
"

36 
suniÚDiffG’”icCommªd
(
ş›Á
 *
c
, 
robj
 **
£tkeys
, 
£Šum
,

37 
robj
 *
d¡key
, 
İ
);

42 
robj
 *
	$£tTy³C»©e
(
sds
 
v®ue
) {

43 ià(
	`isSdsR•»£ÁabËAsLÚgLÚg
(
v®ue
,
NULL
è=ğ
C_OK
)

44  
	`ü—‹IÁ£tObjeù
();

45  
	`ü—‹S‘Objeù
();

46 
	}
}

52 
	$£tTy³Add
(
robj
 *
subjeù
, 
sds
 
v®ue
) {

53 
Îv®
;

54 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

55 
diù
 *
ht
 = 
subjeù
->
±r
;

56 
diùEÁry
 *
de
 = 
	`diùAddRaw
(
ht
,
v®ue
,
NULL
);

57 ià(
de
) {

58 
	`diùS‘Key
(
ht
,
de
,
	`sdsdup
(
v®ue
));

59 
	`diùS‘V®
(
ht
,
de
,
NULL
);

62 } ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

63 ià(
	`isSdsR•»£ÁabËAsLÚgLÚg
(
v®ue
,&
Îv®
è=ğ
C_OK
) {

64 
ušt8_t
 
sucûss
 = 0;

65 
subjeù
->
±r
 = 
	`št£tAdd
(subjeù->±r,
Îv®
,&
sucûss
);

66 ià(
sucûss
) {

69 ià(
	`št£tL’
(
subjeù
->
±r
è> 
£rv”
.
£t_max_št£t_’Œ›s
)

70 
	`£tTy³CÚv”t
(
subjeù
,
OBJ_ENCODING_HT
);

75 
	`£tTy³CÚv”t
(
subjeù
,
OBJ_ENCODING_HT
);

79 
	`£rv”As£¹
(
	`diùAdd
(
subjeù
->
±r
,
	`sdsdup
(
v®ue
),
NULL
è=ğ
DICT_OK
);

83 
	`£rv”Pªic
("Unknown setƒncoding");

86 
	}
}

88 
	$£tTy³Remove
(
robj
 *
£tobj
, 
sds
 
v®ue
) {

89 
Îv®
;

90 ià(
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

91 ià(
	`diùD–‘e
(
£tobj
->
±r
,
v®ue
è=ğ
DICT_OK
) {

92 ià(
	`htN“dsResize
(
£tobj
->
±r
)è
	`diùResize
(setobj->ptr);

95 } ià(
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

96 ià(
	`isSdsR•»£ÁabËAsLÚgLÚg
(
v®ue
,&
Îv®
è=ğ
C_OK
) {

97 
sucûss
;

98 
£tobj
->
±r
 = 
	`št£tRemove
(£tobj->±r,
Îv®
,&
sucûss
);

99 ià(
sucûss
)  1;

102 
	`£rv”Pªic
("Unknown setƒncoding");

105 
	}
}

107 
	$£tTy³IsMemb”
(
robj
 *
subjeù
, 
sds
 
v®ue
) {

108 
Îv®
;

109 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

110  
	`diùFšd
((
diù
*)
subjeù
->
±r
,
v®ue
è!ğ
NULL
;

111 } ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

112 ià(
	`isSdsR•»£ÁabËAsLÚgLÚg
(
v®ue
,&
Îv®
è=ğ
C_OK
) {

113  
	`št£tFšd
((
št£t
*)
subjeù
->
±r
,
Îv®
);

116 
	`£rv”Pªic
("Unknown setƒncoding");

119 
	}
}

121 
£tTy³I‹¿tÜ
 *
	$£tTy³In™I‹¿tÜ
(
robj
 *
subjeù
) {

122 
£tTy³I‹¿tÜ
 *
si
 = 
	`zm®loc
((setTypeIterator));

123 
si
->
subjeù
 = subject;

124 
si
->
’codšg
 = 
subjeù
->encoding;

125 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

126 
si
->
di
 = 
	`diùG‘I‹¿tÜ
(
subjeù
->
±r
);

127 } ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

128 
si
->
ii
 = 0;

130 
	`£rv”Pªic
("Unknown setƒncoding");

132  
si
;

133 
	}
}

135 
	$£tTy³R–—£I‹¿tÜ
(
£tTy³I‹¿tÜ
 *
si
) {

136 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_HT
)

137 
	`diùR–—£I‹¿tÜ
(
si
->
di
);

138 
	`zä“
(
si
);

139 
	}
}

154 
	$£tTy³Next
(
£tTy³I‹¿tÜ
 *
si
, 
sds
 *
sd£Ë
, 
št64_t
 *
Î–e
) {

155 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

156 
diùEÁry
 *
de
 = 
	`diùNext
(
si
->
di
);

157 ià(
de
 =ğ
NULL
)  -1;

158 *
sd£Ë
 = 
	`diùG‘Key
(
de
);

159 *
Î–e
 = -123456789;

160 } ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

161 ià(!
	`št£tG‘
(
si
->
subjeù
->
±r
,si->
ii
++,
Î–e
))

163 *
sd£Ë
 = 
NULL
;

165 
	`£rv”Pªic
("Wrong setƒncoding in setTypeNext");

167  
si
->
’codšg
;

168 
	}
}

177 
sds
 
	$£tTy³NextObjeù
(
£tTy³I‹¿tÜ
 *
si
) {

178 
št64_t
 
š‹Ë
;

179 
sds
 
sd£Ë
;

180 
’codšg
;

182 
’codšg
 = 
	`£tTy³Next
(
si
,&
sd£Ë
,&
š‹Ë
);

183 
’codšg
) {

184 -1:  
NULL
;

185 
OBJ_ENCODING_INTSET
:

186  
	`sdsäomlÚglÚg
(
š‹Ë
);

187 
OBJ_ENCODING_HT
:

188  
	`sdsdup
(
sd£Ë
);

190 
	`£rv”Pªic
("Unsupportedƒncoding");

192  
NULL
;

193 
	}
}

208 
	$£tTy³RªdomEËm’t
(
robj
 *
£tobj
, 
sds
 *
sd£Ë
, 
št64_t
 *
Î–e
) {

209 ià(
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

210 
diùEÁry
 *
de
 = 
	`diùG‘RªdomKey
(
£tobj
->
±r
);

211 *
sd£Ë
 = 
	`diùG‘Key
(
de
);

212 *
Î–e
 = -123456789;

213 } ià(
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

214 *
Î–e
 = 
	`št£tRªdom
(
£tobj
->
±r
);

215 *
sd£Ë
 = 
NULL
;

217 
	`£rv”Pªic
("Unknown setƒncoding");

219  
£tobj
->
’codšg
;

220 
	}
}

222 
	$£tTy³Size
(cÚ¡ 
robj
 *
subjeù
) {

223 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

224  
	`diùSize
((cÚ¡ 
diù
*)
subjeù
->
±r
);

225 } ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

226  
	`št£tL’
((cÚ¡ 
št£t
*)
subjeù
->
±r
);

228 
	`£rv”Pªic
("Unknown setƒncoding");

230 
	}
}

235 
	$£tTy³CÚv”t
(
robj
 *
£tobj
, 
’c
) {

236 
£tTy³I‹¿tÜ
 *
si
;

237 
	`£rv”As£¹W™hInfo
(
NULL
,
£tobj
,£tobj->
ty³
 =ğ
OBJ_SET
 &&

238 
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
);

240 ià(
’c
 =ğ
OBJ_ENCODING_HT
) {

241 
št64_t
 
š‹Ë
;

242 
diù
 *
d
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

243 
sds
 
–em’t
;

246 
	`diùEx·nd
(
d
,
	`št£tL’
(
£tobj
->
±r
));

249 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£tobj
);

250 
	`£tTy³Next
(
si
,&
–em’t
,&
š‹Ë
) != -1) {

251 
–em’t
 = 
	`sdsäomlÚglÚg
(
š‹Ë
);

252 
	`£rv”As£¹
(
	`diùAdd
(
d
,
–em’t
,
NULL
è=ğ
DICT_OK
);

254 
	`£tTy³R–—£I‹¿tÜ
(
si
);

256 
£tobj
->
’codšg
 = 
OBJ_ENCODING_HT
;

257 
	`zä“
(
£tobj
->
±r
);

258 
£tobj
->
±r
 = 
d
;

260 
	`£rv”Pªic
("Unsupported set conversion");

262 
	}
}

264 
	$§ddCommªd
(
ş›Á
 *
c
) {

265 
robj
 *
£t
;

266 
j
, 
added
 = 0;

268 
£t
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

269 ià(
£t
 =ğ
NULL
) {

270 
£t
 = 
	`£tTy³C»©e
(
c
->
¬gv
[2]->
±r
);

271 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
£t
);

273 ià(
£t
->
ty³
 !ğ
OBJ_SET
) {

274 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

279 
j
 = 2; j < 
c
->
¬gc
; j++) {

280 ià(
	`£tTy³Add
(
£t
,
c
->
¬gv
[
j
]->
±r
)è
added
++;

282 ià(
added
) {

283 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

284 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"§dd",
c
->
¬gv
[1],c->
db
->
id
);

286 
£rv”
.
dœty
 +ğ
added
;

287 
	`addR•lyLÚgLÚg
(
c
,
added
);

288 
	}
}

290 
	$¤emCommªd
(
ş›Á
 *
c
) {

291 
robj
 *
£t
;

292 
j
, 
d–‘ed
 = 0, 
key»moved
 = 0;

294 ià((
£t
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

295 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) ;

297 
j
 = 2; j < 
c
->
¬gc
; j++) {

298 ià(
	`£tTy³Remove
(
£t
,
c
->
¬gv
[
j
]->
±r
)) {

299 
d–‘ed
++;

300 ià(
	`£tTy³Size
(
£t
) == 0) {

301 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

302 
key»moved
 = 1;

307 ià(
d–‘ed
) {

308 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

309 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"¤em",
c
->
¬gv
[1],c->
db
->
id
);

310 ià(
key»moved
)

311 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],

312 
c
->
db
->
id
);

313 
£rv”
.
dœty
 +ğ
d–‘ed
;

315 
	`addR•lyLÚgLÚg
(
c
,
d–‘ed
);

316 
	}
}

318 
	$smoveCommªd
(
ş›Á
 *
c
) {

319 
robj
 *
¤c£t
, *
d¡£t
, *
–e
;

320 
¤c£t
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

321 
d¡£t
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[2]);

322 
–e
 = 
c
->
¬gv
[3];

325 ià(
¤c£t
 =ğ
NULL
) {

326 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

332 ià(
	`checkTy³
(
c
,
¤c£t
,
OBJ_SET
) ||

333 (
d¡£t
 && 
	`checkTy³
(
c
,d¡£t,
OBJ_SET
))) ;

336 ià(
¤c£t
 =ğ
d¡£t
) {

337 
	`addR•ly
(
c
,
	`£tTy³IsMemb”
(
¤c£t
,
–e
->
±r
) ?

338 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

343 ià(!
	`£tTy³Remove
(
¤c£t
,
–e
->
±r
)) {

344 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

347 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"¤em",
c
->
¬gv
[1],c->
db
->
id
);

350 ià(
	`£tTy³Size
(
¤c£t
) == 0) {

351 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

352 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

356 ià(!
d¡£t
) {

357 
d¡£t
 = 
	`£tTy³C»©e
(
–e
->
±r
);

358 
	`dbAdd
(
c
->
db
,c->
¬gv
[2],
d¡£t
);

361 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

362 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[2]);

363 
£rv”
.
dœty
++;

366 ià(
	`£tTy³Add
(
d¡£t
,
–e
->
±r
)) {

367 
£rv”
.
dœty
++;

368 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"§dd",
c
->
¬gv
[2],c->
db
->
id
);

370 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

371 
	}
}

373 
	$sismemb”Commªd
(
ş›Á
 *
c
) {

374 
robj
 *
£t
;

376 ià((
£t
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

377 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) ;

379 ià(
	`£tTy³IsMemb”
(
£t
,
c
->
¬gv
[2]->
±r
))

380 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

382 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

383 
	}
}

385 
	$sÿrdCommªd
(
ş›Á
 *
c
) {

386 
robj
 *
o
;

388 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

389 
	`checkTy³
(
c
,
o
,
OBJ_SET
)) ;

391 
	`addR•lyLÚgLÚg
(
c
,
	`£tTy³Size
(
o
));

392 
	}
}

400 
	#SPOP_MOVE_STRATEGY_MUL
 5

	)

402 
	$¥İW™hCouÁCommªd
(
ş›Á
 *
c
) {

403 
l
;

404 
couÁ
, 
size
;

405 
robj
 *
£t
;

408 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
l
,
NULL
è!ğ
C_OK
) ;

409 ià(
l
 >= 0) {

410 
couÁ
 = (è
l
;

412 
	`addR•ly
(
c
,
sh¬ed
.
outoäªg“¼
);

418 ià((
£t
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ymuÉibulk
))

419 =ğ
NULL
 || 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) ;

423 ià(
couÁ
 == 0) {

424 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

428 
size
 = 
	`£tTy³Size
(
£t
);

431 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"¥İ",
c
->
¬gv
[1],c->
db
->
id
);

432 
£rv”
.
dœty
 +ğ
couÁ
;

437 ià(
couÁ
 >ğ
size
) {

439 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+1,1,
NULL
,
SET_OP_UNION
);

442 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

443 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

446 
	`»wr™eCl›ÁCommªdVeùÜ
(
c
,2,
sh¬ed
.
d–
,c->
¬gv
[1]);

447 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

448 
£rv”
.
dœty
++;

455 
robj
 *
´İ¬gv
[3];

456 
´İ¬gv
[0] = 
	`ü—‹SŒšgObjeù
("SREM",4);

457 
´İ¬gv
[1] = 
c
->
¬gv
[1];

458 
	`addR•lyMuÉiBulkL’
(
c
,
couÁ
);

461 
sds
 
sd£Ë
;

462 
robj
 *
obj–e
;

463 
’codšg
;

464 
št64_t
 
Î–e
;

465 
»maššg
 = 
size
-
couÁ
;

474 ià(
»maššg
*
SPOP_MOVE_STRATEGY_MUL
 > 
couÁ
) {

475 
couÁ
--) {

477 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
sd£Ë
,&
Î–e
);

478 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

479 
	`addR•lyBulkLÚgLÚg
(
c
,
Î–e
);

480 
obj–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
);

481 
£t
->
±r
 = 
	`št£tRemove
(£t->±r,
Î–e
,
NULL
);

483 
	`addR•lyBulkCBufãr
(
c
,
sd£Ë
,
	`sd¦’
(sdsele));

484 
obj–e
 = 
	`ü—‹SŒšgObjeù
(
sd£Ë
,
	`sd¦’
(sdsele));

485 
	`£tTy³Remove
(
£t
,
sd£Ë
);

489 
´İ¬gv
[2] = 
obj–e
;

490 
	`®soPrİag©e
(
£rv”
.
¤emCommªd
,
c
->
db
->
id
,
´İ¬gv
,3,

491 
PROPAGATE_AOF
|
PROPAGATE_REPL
);

492 
	`deüRefCouÁ
(
obj–e
);

503 
robj
 *
Ãw£t
 = 
NULL
;

506 
»maššg
--) {

507 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
sd£Ë
,&
Î–e
);

508 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

509 
sd£Ë
 = 
	`sdsäomlÚglÚg
(
Î–e
);

511 
sd£Ë
 = 
	`sdsdup
(sdsele);

513 ià(!
Ãw£t
èÃw£ˆğ
	`£tTy³C»©e
(
sd£Ë
);

514 
	`£tTy³Add
(
Ãw£t
,
sd£Ë
);

515 
	`£tTy³Remove
(
£t
,
sd£Ë
);

516 
	`sdsä“
(
sd£Ë
);

520 
	`šüRefCouÁ
(
£t
);

521 
	`dbOv”wr™e
(
c
->
db
,c->
¬gv
[1],
Ãw£t
);

524 
£tTy³I‹¿tÜ
 *
si
;

525 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£t
);

526 (
’codšg
 = 
	`£tTy³Next
(
si
,&
sd£Ë
,&
Î–e
)) != -1) {

527 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

528 
	`addR•lyBulkLÚgLÚg
(
c
,
Î–e
);

529 
obj–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
);

531 
	`addR•lyBulkCBufãr
(
c
,
sd£Ë
,
	`sd¦’
(sdsele));

532 
obj–e
 = 
	`ü—‹SŒšgObjeù
(
sd£Ë
,
	`sd¦’
(sdsele));

536 
´İ¬gv
[2] = 
obj–e
;

537 
	`®soPrİag©e
(
£rv”
.
¤emCommªd
,
c
->
db
->
id
,
´İ¬gv
,3,

538 
PROPAGATE_AOF
|
PROPAGATE_REPL
);

539 
	`deüRefCouÁ
(
obj–e
);

541 
	`£tTy³R–—£I‹¿tÜ
(
si
);

542 
	`deüRefCouÁ
(
£t
);

549 
	`deüRefCouÁ
(
´İ¬gv
[0]);

550 
	`´ev’tCommªdPrİag©iÚ
(
c
);

551 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

552 
£rv”
.
dœty
++;

553 
	}
}

555 
	$¥İCommªd
(
ş›Á
 *
c
) {

556 
robj
 *
£t
, *
–e
, *
aux
;

557 
sds
 
sd£Ë
;

558 
št64_t
 
Î–e
;

559 
’codšg
;

561 ià(
c
->
¬gc
 == 3) {

562 
	`¥İW™hCouÁCommªd
(
c
);

564 } ià(
c
->
¬gc
 > 3) {

565 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

571 ià((
£t
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
)è=ğ
NULL
 ||

572 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) ;

575 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
sd£Ë
,&
Î–e
);

578 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

579 
–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
);

580 
£t
->
±r
 = 
	`št£tRemove
(£t->±r,
Î–e
,
NULL
);

582 
–e
 = 
	`ü—‹SŒšgObjeù
(
sd£Ë
,
	`sd¦’
(sdsele));

583 
	`£tTy³Remove
(
£t
,
–e
->
±r
);

586 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"¥İ",
c
->
¬gv
[1],c->
db
->
id
);

589 
aux
 = 
	`ü—‹SŒšgObjeù
("SREM",4);

590 
	`»wr™eCl›ÁCommªdVeùÜ
(
c
,3,
aux
,c->
¬gv
[1],
–e
);

591 
	`deüRefCouÁ
(
aux
);

594 
	`addR•lyBulk
(
c
,
–e
);

595 
	`deüRefCouÁ
(
–e
);

598 ià(
	`£tTy³Size
(
£t
) == 0) {

599 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

600 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

604 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

605 
£rv”
.
dœty
++;

606 
	}
}

614 
	#SRANDMEMBER_SUB_STRATEGY_MUL
 3

	)

616 
	$¤ªdmemb”W™hCouÁCommªd
(
ş›Á
 *
c
) {

617 
l
;

618 
couÁ
, 
size
;

619 
uniq
 = 1;

620 
robj
 *
£t
;

621 
sds
 
–e
;

622 
št64_t
 
Î–e
;

623 
’codšg
;

625 
diù
 *
d
;

627 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
l
,
NULL
è!ğ
C_OK
) ;

628 ià(
l
 >= 0) {

629 
couÁ
 = (è
l
;

633 
couÁ
 = -
l
;

634 
uniq
 = 0;

637 ià((
£t
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ymuÉibulk
))

638 =ğ
NULL
 || 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) ;

639 
size
 = 
	`£tTy³Size
(
£t
);

642 ià(
couÁ
 == 0) {

643 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

651 ià(!
uniq
) {

652 
	`addR•lyMuÉiBulkL’
(
c
,
couÁ
);

653 
couÁ
--) {

654 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
–e
,&
Î–e
);

655 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

656 
	`addR•lyBulkLÚgLÚg
(
c
,
Î–e
);

658 
	`addR•lyBulkCBufãr
(
c
,
–e
,
	`sd¦’
(ele));

667 ià(
couÁ
 >ğ
size
) {

668 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+1,1,
NULL
,
SET_OP_UNION
);

673 
d
 = 
	`diùC»©e
(&
objeùKeyPoš‹rV®ueDiùTy³
,
NULL
);

684 ià(
couÁ
*
SRANDMEMBER_SUB_STRATEGY_MUL
 > 
size
) {

685 
£tTy³I‹¿tÜ
 *
si
;

688 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£t
);

689 (
’codšg
 = 
	`£tTy³Next
(
si
,&
–e
,&
Î–e
)) != -1) {

690 
»tv®
 = 
DICT_ERR
;

692 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

693 
»tv®
 = 
	`diùAdd
(
d
,
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
),
NULL
);

695 
»tv®
 = 
	`diùAdd
(
d
,
	`ü—‹SŒšgObjeù
(
–e
,
	`sd¦’
ÓË)),
NULL
);

697 
	`£rv”As£¹
(
»tv®
 =ğ
DICT_OK
);

699 
	`£tTy³R–—£I‹¿tÜ
(
si
);

700 
	`£rv”As£¹
(
	`diùSize
(
d
è=ğ
size
);

703 
size
 > 
couÁ
) {

704 
diùEÁry
 *
de
;

706 
de
 = 
	`diùG‘RªdomKey
(
d
);

707 
	`diùD–‘e
(
d
,
	`diùG‘Key
(
de
));

708 
size
--;

717 
added
 = 0;

718 
robj
 *
obj–e
;

720 
added
 < 
couÁ
) {

721 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
–e
,&
Î–e
);

722 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

723 
obj–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
);

725 
obj–e
 = 
	`ü—‹SŒšgObjeù
(
–e
,
	`sd¦’
(ele));

730 ià(
	`diùAdd
(
d
,
obj–e
,
NULL
è=ğ
DICT_OK
)

731 
added
++;

733 
	`deüRefCouÁ
(
obj–e
);

739 
diùI‹¿tÜ
 *
di
;

740 
diùEÁry
 *
de
;

742 
	`addR•lyMuÉiBulkL’
(
c
,
couÁ
);

743 
di
 = 
	`diùG‘I‹¿tÜ
(
d
);

744 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
)

745 
	`addR•lyBulk
(
c
,
	`diùG‘Key
(
de
));

746 
	`diùR–—£I‹¿tÜ
(
di
);

747 
	`diùR–—£
(
d
);

749 
	}
}

751 
	$¤ªdmemb”Commªd
(
ş›Á
 *
c
) {

752 
robj
 *
£t
;

753 
sds
 
–e
;

754 
št64_t
 
Î–e
;

755 
’codšg
;

757 ià(
c
->
¬gc
 == 3) {

758 
	`¤ªdmemb”W™hCouÁCommªd
(
c
);

760 } ià(
c
->
¬gc
 > 3) {

761 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

765 ià((
£t
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
)è=ğ
NULL
 ||

766 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) ;

768 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
–e
,&
Î–e
);

769 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

770 
	`addR•lyBulkLÚgLÚg
(
c
,
Î–e
);

772 
	`addR•lyBulkCBufãr
(
c
,
–e
,
	`sd¦’
(ele));

774 
	}
}

776 
	$qsÜtCom·»S‘sByC¬dš®™y
(cÚ¡ *
s1
, cÚ¡ *
s2
) {

777  
	`£tTy³Size
(*(
robj
**)
s1
)-£tTy³Size(*Ôobj**)
s2
);

778 
	}
}

782 
	$qsÜtCom·»S‘sByRevC¬dš®™y
(cÚ¡ *
s1
, cÚ¡ *
s2
) {

783 
robj
 *
o1
 = *Ôobj**)
s1
, *
o2
 = *Ôobj**)
s2
;

785  (
o2
 ? 
	`£tTy³Size
(o2è: 0è- (
o1
 ? setTypeSize(o1) : 0);

786 
	}
}

788 
	$sš‹rG’”icCommªd
(
ş›Á
 *
c
, 
robj
 **
£tkeys
,

789 
£Šum
, 
robj
 *
d¡key
) {

790 
robj
 **
£ts
 = 
	`zm®loc
(Ôobj*)*
£Šum
);

791 
£tTy³I‹¿tÜ
 *
si
;

792 
robj
 *
d¡£t
 = 
NULL
;

793 
sds
 
–esds
;

794 
št64_t
 
štobj
;

795 *
»¶yËn
 = 
NULL
;

796 
j
, 
ÿrdš®™y
 = 0;

797 
’codšg
;

799 
j
 = 0; j < 
£Šum
; j++) {

800 
robj
 *
£tobj
 = 
d¡key
 ?

801 
	`lookupKeyWr™e
(
c
->
db
,
£tkeys
[
j
]) :

802 
	`lookupKeyR—d
(
c
->
db
,
£tkeys
[
j
]);

803 ià(!
£tobj
) {

804 
	`zä“
(
£ts
);

805 ià(
d¡key
) {

806 ià(
	`dbD–‘e
(
c
->
db
,
d¡key
)) {

807 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

808 
£rv”
.
dœty
++;

810 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

812 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

816 ià(
	`checkTy³
(
c
,
£tobj
,
OBJ_SET
)) {

817 
	`zä“
(
£ts
);

820 
£ts
[
j
] = 
£tobj
;

824 
	`qsÜt
(
£ts
,
£Šum
,(
robj
*),
qsÜtCom·»S‘sByC¬dš®™y
);

831 ià(!
d¡key
) {

832 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

836 
d¡£t
 = 
	`ü—‹IÁ£tObjeù
();

842 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£ts
[0]);

843 (
’codšg
 = 
	`£tTy³Next
(
si
,&
–esds
,&
štobj
)) != -1) {

844 
j
 = 1; j < 
£Šum
; j++) {

845 ià(
£ts
[
j
] == sets[0]) ;

846 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

848 ià(
£ts
[
j
]->
’codšg
 =ğ
OBJ_ENCODING_INTSET
 &&

849 !
	`št£tFšd
((
št£t
*)
£ts
[
j
]->
±r
,
štobj
))

855 } ià(
£ts
[
j
]->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

856 
–esds
 = 
	`sdsäomlÚglÚg
(
štobj
);

857 ià(!
	`£tTy³IsMemb”
(
£ts
[
j
],
–esds
)) {

858 
	`sdsä“
(
–esds
);

861 
	`sdsä“
(
–esds
);

863 } ià(
’codšg
 =ğ
OBJ_ENCODING_HT
) {

864 ià(!
	`£tTy³IsMemb”
(
£ts
[
j
],
–esds
)) {

871 ià(
j
 =ğ
£Šum
) {

872 ià(!
d¡key
) {

873 ià(
’codšg
 =ğ
OBJ_ENCODING_HT
)

874 
	`addR•lyBulkCBufãr
(
c
,
–esds
,
	`sd¦’
(elesds));

876 
	`addR•lyBulkLÚgLÚg
(
c
,
štobj
);

877 
ÿrdš®™y
++;

879 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

880 
–esds
 = 
	`sdsäomlÚglÚg
(
štobj
);

881 
	`£tTy³Add
(
d¡£t
,
–esds
);

882 
	`sdsä“
(
–esds
);

884 
	`£tTy³Add
(
d¡£t
,
–esds
);

889 
	`£tTy³R–—£I‹¿tÜ
(
si
);

891 ià(
d¡key
) {

894 
d–‘ed
 = 
	`dbD–‘e
(
c
->
db
,
d¡key
);

895 ià(
	`£tTy³Size
(
d¡£t
) > 0) {

896 
	`dbAdd
(
c
->
db
,
d¡key
,
d¡£t
);

897 
	`addR•lyLÚgLÚg
(
c
,
	`£tTy³Size
(
d¡£t
));

898 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"sinterstore",

899 
d¡key
,
c
->
db
->
id
);

901 
	`deüRefCouÁ
(
d¡£t
);

902 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

903 ià(
d–‘ed
)

904 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"del",

905 
d¡key
,
c
->
db
->
id
);

907 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

908 
£rv”
.
dœty
++;

910 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn
,
ÿrdš®™y
);

912 
	`zä“
(
£ts
);

913 
	}
}

915 
	$sš‹rCommªd
(
ş›Á
 *
c
) {

916 
	`sš‹rG’”icCommªd
(
c
,c->
¬gv
+1,c->
¬gc
-1,
NULL
);

917 
	}
}

919 
	$sš‹r¡ÜeCommªd
(
ş›Á
 *
c
) {

920 
	`sš‹rG’”icCommªd
(
c
,c->
¬gv
+2,c->
¬gc
-2,c->argv[1]);

921 
	}
}

923 
	#SET_OP_UNION
 0

	)

924 
	#SET_OP_DIFF
 1

	)

925 
	#SET_OP_INTER
 2

	)

927 
	$suniÚDiffG’”icCommªd
(
ş›Á
 *
c
, 
robj
 **
£tkeys
, 
£Šum
,

928 
robj
 *
d¡key
, 
İ
) {

929 
robj
 **
£ts
 = 
	`zm®loc
(Ôobj*)*
£Šum
);

930 
£tTy³I‹¿tÜ
 *
si
;

931 
robj
 *
d¡£t
 = 
NULL
;

932 
sds
 
–e
;

933 
j
, 
ÿrdš®™y
 = 0;

934 
diff_®go
 = 1;

936 
j
 = 0; j < 
£Šum
; j++) {

937 
robj
 *
£tobj
 = 
d¡key
 ?

938 
	`lookupKeyWr™e
(
c
->
db
,
£tkeys
[
j
]) :

939 
	`lookupKeyR—d
(
c
->
db
,
£tkeys
[
j
]);

940 ià(!
£tobj
) {

941 
£ts
[
j
] = 
NULL
;

944 ià(
	`checkTy³
(
c
,
£tobj
,
OBJ_SET
)) {

945 
	`zä“
(
£ts
);

948 
£ts
[
j
] = 
£tobj
;

960 ià(
İ
 =ğ
SET_OP_DIFF
 && 
£ts
[0]) {

961 
®go_Úe_wÜk
 = 0, 
®go_two_wÜk
 = 0;

963 
j
 = 0; j < 
£Šum
; j++) {

964 ià(
£ts
[
j
] =ğ
NULL
) ;

966 
®go_Úe_wÜk
 +ğ
	`£tTy³Size
(
£ts
[0]);

967 
®go_two_wÜk
 +ğ
	`£tTy³Size
(
£ts
[
j
]);

972 
®go_Úe_wÜk
 /= 2;

973 
diff_®go
 = (
®go_Úe_wÜk
 <ğ
®go_two_wÜk
) ? 1 : 2;

975 ià(
diff_®go
 =ğ1 && 
£Šum
 > 1) {

979 
	`qsÜt
(
£ts
+1,
£Šum
-1,(
robj
*),

980 
qsÜtCom·»S‘sByRevC¬dš®™y
);

987 
d¡£t
 = 
	`ü—‹IÁ£tObjeù
();

989 ià(
İ
 =ğ
SET_OP_UNION
) {

992 
j
 = 0; j < 
£Šum
; j++) {

993 ià(!
£ts
[
j
]) ;

995 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£ts
[
j
]);

996 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

997 ià(
	`£tTy³Add
(
d¡£t
,
–e
)è
ÿrdš®™y
++;

998 
	`sdsä“
(
–e
);

1000 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1002 } ià(
İ
 =ğ
SET_OP_DIFF
 && 
£ts
[0] && 
diff_®go
 == 1) {

1011 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£ts
[0]);

1012 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

1013 
j
 = 1; j < 
£Šum
; j++) {

1014 ià(!
£ts
[
j
]) ;

1015 ià(
£ts
[
j
] == sets[0]) ;

1016 ià(
	`£tTy³IsMemb”
(
£ts
[
j
],
–e
)) ;

1018 ià(
j
 =ğ
£Šum
) {

1020 
	`£tTy³Add
(
d¡£t
,
–e
);

1021 
ÿrdš®™y
++;

1023 
	`sdsä“
(
–e
);

1025 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1026 } ià(
İ
 =ğ
SET_OP_DIFF
 && 
£ts
[0] && 
diff_®go
 == 2) {

1034 
j
 = 0; j < 
£Šum
; j++) {

1035 ià(!
£ts
[
j
]) ;

1037 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£ts
[
j
]);

1038 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

1039 ià(
j
 == 0) {

1040 ià(
	`£tTy³Add
(
d¡£t
,
–e
)è
ÿrdš®™y
++;

1042 ià(
	`£tTy³Remove
(
d¡£t
,
–e
)è
ÿrdš®™y
--;

1044 
	`sdsä“
(
–e
);

1046 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1050 ià(
ÿrdš®™y
 == 0) ;

1055 ià(!
d¡key
) {

1056 
	`addR•lyMuÉiBulkL’
(
c
,
ÿrdš®™y
);

1057 
si
 = 
	`£tTy³In™I‹¿tÜ
(
d¡£t
);

1058 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

1059 
	`addR•lyBulkCBufãr
(
c
,
–e
,
	`sd¦’
(ele));

1060 
	`sdsä“
(
–e
);

1062 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1063 
	`deüRefCouÁ
(
d¡£t
);

1067 
d–‘ed
 = 
	`dbD–‘e
(
c
->
db
,
d¡key
);

1068 ià(
	`£tTy³Size
(
d¡£t
) > 0) {

1069 
	`dbAdd
(
c
->
db
,
d¡key
,
d¡£t
);

1070 
	`addR•lyLÚgLÚg
(
c
,
	`£tTy³Size
(
d¡£t
));

1071 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,

1072 
İ
 =ğ
SET_OP_UNION
 ? "sunionstore" : "sdiffstore",

1073 
d¡key
,
c
->
db
->
id
);

1075 
	`deüRefCouÁ
(
d¡£t
);

1076 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1077 ià(
d–‘ed
)

1078 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"del",

1079 
d¡key
,
c
->
db
->
id
);

1081 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

1082 
£rv”
.
dœty
++;

1084 
	`zä“
(
£ts
);

1085 
	}
}

1087 
	$suniÚCommªd
(
ş›Á
 *
c
) {

1088 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+1,c->
¬gc
-1,
NULL
,
SET_OP_UNION
);

1089 
	}
}

1091 
	$suniÚ¡ÜeCommªd
(
ş›Á
 *
c
) {

1092 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+2,c->
¬gc
-2,c->¬gv[1],
SET_OP_UNION
);

1093 
	}
}

1095 
	$sdiffCommªd
(
ş›Á
 *
c
) {

1096 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+1,c->
¬gc
-1,
NULL
,
SET_OP_DIFF
);

1097 
	}
}

1099 
	$sdiff¡ÜeCommªd
(
ş›Á
 *
c
) {

1100 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+2,c->
¬gc
-2,c->¬gv[1],
SET_OP_DIFF
);

1101 
	}
}

1103 
	$ssÿnCommªd
(
ş›Á
 *
c
) {

1104 
robj
 *
£t
;

1105 
cursÜ
;

1107 ià(
	`·r£SÿnCursÜOrR•ly
(
c
,c->
¬gv
[2],&
cursÜ
è=ğ
C_ERR
) ;

1108 ià((
£t
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ysÿn
)è=ğ
NULL
 ||

1109 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) ;

1110 
	`sÿnG’”icCommªd
(
c
,
£t
,
cursÜ
);

1111 
	}
}

	@t_string.c

30 
	~"£rv”.h
"

31 
	~<m©h.h
>

37 
	$checkSŒšgL’gth
(
ş›Á
 *
c
, 
size
) {

38 ià(
size
 > 512*1024*1024) {

39 
	`addR•lyE¼Ü
(
c
,"stringƒxceeds maximum‡llowed size (512MB)");

40  
C_ERR
;

42  
C_OK
;

43 
	}
}

61 
	#OBJ_SET_NO_FLAGS
 0

	)

62 
	#OBJ_SET_NX
 (1<<0è

	)

63 
	#OBJ_SET_XX
 (1<<1è

	)

64 
	#OBJ_SET_EX
 (1<<2è

	)

65 
	#OBJ_SET_PX
 (1<<3è

	)

67 
	$£tG’”icCommªd
(
ş›Á
 *
c
, 
æags
, 
robj
 *
key
,„obj *
v®
,„obj *
expœe
, 
un™
,„obj *
ok_»¶y
,„obj *
abÜt_»¶y
) {

68 
mli£cÚds
 = 0;

70 ià(
expœe
) {

71 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, 
expœe
, &
mli£cÚds
, 
NULL
è!ğ
C_OK
)

73 ià(
mli£cÚds
 <= 0) {

74 
	`addR•lyE¼ÜFÜm©
(
c
,"šv®idƒxpœtimš %s",c->
cmd
->
Çme
);

77 ià(
un™
 =ğ
UNIT_SECONDS
è
mli£cÚds
 *= 1000;

80 ià((
æags
 & 
OBJ_SET_NX
 && 
	`lookupKeyWr™e
(
c
->
db
,
key
è!ğ
NULL
) ||

81 (
æags
 & 
OBJ_SET_XX
 && 
	`lookupKeyWr™e
(
c
->
db
,
key
è=ğ
NULL
))

83 
	`addR•ly
(
c
, 
abÜt_»¶y
 ?‡bÜt_»¶y : 
sh¬ed
.
nuÎbulk
);

86 
	`£tKey
(
c
->
db
,
key
,
v®
);

87 
£rv”
.
dœty
++;

88 ià(
expœe
è
	`£tExpœe
(
c
,c->
db
,
key
,
	`m¡ime
()+
mli£cÚds
);

89 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£t",
key
,
c
->
db
->
id
);

90 ià(
expœe
è
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,

91 "expœe",
key
,
c
->
db
->
id
);

92 
	`addR•ly
(
c
, 
ok_»¶y
 ? ok_»¶y : 
sh¬ed
.
ok
);

93 
	}
}

96 
	$£tCommªd
(
ş›Á
 *
c
) {

97 
j
;

98 
robj
 *
expœe
 = 
NULL
;

99 
un™
 = 
UNIT_SECONDS
;

100 
æags
 = 
OBJ_SET_NO_FLAGS
;

102 
j
 = 3; j < 
c
->
¬gc
; j++) {

103 *
a
 = 
c
->
¬gv
[
j
]->
±r
;

104 
robj
 *
Ãxt
 = (
j
 =ğ
c
->
¬gc
-1è? 
NULL
 : c->
¬gv
[j+1];

106 ià((
a
[0] == 'n' ||‡[0] == 'N') &&

107 (
a
[1] == 'x' ||‡[1] == 'X') &&‡[2] == '\0' &&

108 !(
æags
 & 
OBJ_SET_XX
))

110 
æags
 |ğ
OBJ_SET_NX
;

111 } ià((
a
[0] == 'x' ||‡[0] == 'X') &&

112 (
a
[1] == 'x' ||‡[1] == 'X') &&‡[2] == '\0' &&

113 !(
æags
 & 
OBJ_SET_NX
))

115 
æags
 |ğ
OBJ_SET_XX
;

116 } ià((
a
[0] == 'e' ||‡[0] == 'E') &&

117 (
a
[1] == 'x' ||‡[1] == 'X') &&‡[2] == '\0' &&

118 !(
æags
 & 
OBJ_SET_PX
è&& 
Ãxt
)

120 
æags
 |ğ
OBJ_SET_EX
;

121 
un™
 = 
UNIT_SECONDS
;

122 
expœe
 = 
Ãxt
;

123 
j
++;

124 } ià((
a
[0] == 'p' ||‡[0] == 'P') &&

125 (
a
[1] == 'x' ||‡[1] == 'X') &&‡[2] == '\0' &&

126 !(
æags
 & 
OBJ_SET_EX
è&& 
Ãxt
)

128 
æags
 |ğ
OBJ_SET_PX
;

129 
un™
 = 
UNIT_MILLISECONDS
;

130 
expœe
 = 
Ãxt
;

131 
j
++;

133 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

138 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

139 
	`£tG’”icCommªd
(
c
,
æags
,c->
¬gv
[1],c->¬gv[2],
expœe
,
un™
,
NULL
,NULL);

140 
	}
}

142 
	$£ŠxCommªd
(
ş›Á
 *
c
) {

143 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

144 
	`£tG’”icCommªd
(
c
,
OBJ_SET_NX
,c->
¬gv
[1],c->¬gv[2],
NULL
,0,
sh¬ed
.
cÚe
,sh¬ed.
cz”o
);

145 
	}
}

147 
	$£‹xCommªd
(
ş›Á
 *
c
) {

148 
c
->
¬gv
[3] = 
	`ŒyObjeùEncodšg
(c->argv[3]);

149 
	`£tG’”icCommªd
(
c
,
OBJ_SET_NO_FLAGS
,c->
¬gv
[1],c->¬gv[3],c->¬gv[2],
UNIT_SECONDS
,
NULL
,NULL);

150 
	}
}

152 
	$p£‹xCommªd
(
ş›Á
 *
c
) {

153 
c
->
¬gv
[3] = 
	`ŒyObjeùEncodšg
(c->argv[3]);

154 
	`£tG’”icCommªd
(
c
,
OBJ_SET_NO_FLAGS
,c->
¬gv
[1],c->¬gv[3],c->¬gv[2],
UNIT_MILLISECONDS
,
NULL
,NULL);

155 
	}
}

157 
	$g‘G’”icCommªd
(
ş›Á
 *
c
) {

158 
robj
 *
o
;

160 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
)è=ğ
NULL
)

161  
C_OK
;

163 ià(
o
->
ty³
 !ğ
OBJ_STRING
) {

164 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

165  
C_ERR
;

167 
	`addR•lyBulk
(
c
,
o
);

168  
C_OK
;

170 
	}
}

172 
	$g‘Commªd
(
ş›Á
 *
c
) {

173 
	`g‘G’”icCommªd
(
c
);

174 
	}
}

176 
	$g‘£tCommªd
(
ş›Á
 *
c
) {

177 ià(
	`g‘G’”icCommªd
(
c
è=ğ
C_ERR
) ;

178 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

179 
	`£tKey
(
c
->
db
,c->
¬gv
[1],c->argv[2]);

180 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£t",
c
->
¬gv
[1],c->
db
->
id
);

181 
£rv”
.
dœty
++;

182 
	}
}

184 
	$£ŒªgeCommªd
(
ş›Á
 *
c
) {

185 
robj
 *
o
;

186 
off£t
;

187 
sds
 
v®ue
 = 
c
->
¬gv
[3]->
±r
;

189 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
off£t
,
NULL
è!ğ
C_OK
)

192 ià(
off£t
 < 0) {

193 
	`addR•lyE¼Ü
(
c
,"offset is out of„ange");

197 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

198 ià(
o
 =ğ
NULL
) {

200 ià(
	`sd¦’
(
v®ue
) == 0) {

201 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

206 ià(
	`checkSŒšgL’gth
(
c
,
off£t
+
	`sd¦’
(
v®ue
)è!ğ
C_OK
)

209 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ewËn
(
NULL
, 
off£t
+
	`sd¦’
(
v®ue
)));

210 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
o
);

212 
size_t
 
Ş’
;

215 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
))

219 
Ş’
 = 
	`¡ršgObjeùL’
(
o
);

220 ià(
	`sd¦’
(
v®ue
) == 0) {

221 
	`addR•lyLÚgLÚg
(
c
,
Ş’
);

226 ià(
	`checkSŒšgL’gth
(
c
,
off£t
+
	`sd¦’
(
v®ue
)è!ğ
C_OK
)

230 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

233 ià(
	`sd¦’
(
v®ue
) > 0) {

234 
o
->
±r
 = 
	`sdsgrowz”o
(o->±r,
off£t
+
	`sd¦’
(
v®ue
));

235 
	`memıy
((*)
o
->
±r
+
off£t
,
v®ue
,
	`sd¦’
(value));

236 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

237 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,

238 "£Œªge",
c
->
¬gv
[1],c->
db
->
id
);

239 
£rv”
.
dœty
++;

241 
	`addR•lyLÚgLÚg
(
c
,
	`sd¦’
(
o
->
±r
));

242 
	}
}

244 
	$g‘¿ngeCommªd
(
ş›Á
 *
c
) {

245 
robj
 *
o
;

246 
¡¬t
, 
’d
;

247 *
¡r
, 
Îbuf
[32];

248 
size_t
 
¡¾’
;

250 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
¡¬t
,
NULL
è!ğ
C_OK
)

252 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
’d
,
NULL
è!ğ
C_OK
)

254 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ybulk
)è=ğ
NULL
 ||

255 
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) ;

257 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

258 
¡r
 = 
Îbuf
;

259 
¡¾’
 = 
	`Î2¡ršg
(
Îbuf
,Ölbuf),()
o
->
±r
);

261 
¡r
 = 
o
->
±r
;

262 
¡¾’
 = 
	`sd¦’
(
¡r
);

266 ià(
¡¬t
 < 0 && 
’d
 < 0 && start >ƒnd) {

267 
	`addR•ly
(
c
,
sh¬ed
.
em±ybulk
);

270 ià(
¡¬t
 < 0è¡¬ˆğ
¡¾’
+start;

271 ià(
’d
 < 0è’d = 
¡¾’
+end;

272 ià(
¡¬t
 < 0) start = 0;

273 ià(
’d
 < 0)ƒnd = 0;

274 ià(()
’d
 >ğ
¡¾’
)ƒnd = strlen-1;

278 ià(
¡¬t
 > 
’d
 || 
¡¾’
 == 0) {

279 
	`addR•ly
(
c
,
sh¬ed
.
em±ybulk
);

281 
	`addR•lyBulkCBufãr
(
c
,(*)
¡r
+
¡¬t
,
’d
-start+1);

283 
	}
}

285 
	$mg‘Commªd
(
ş›Á
 *
c
) {

286 
j
;

288 
	`addR•lyMuÉiBulkL’
(
c
,c->
¬gc
-1);

289 
j
 = 1; j < 
c
->
¬gc
; j++) {

290 
robj
 *
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
j
]);

291 ià(
o
 =ğ
NULL
) {

292 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

294 ià(
o
->
ty³
 !ğ
OBJ_STRING
) {

295 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

297 
	`addR•lyBulk
(
c
,
o
);

301 
	}
}

303 
	$m£tG’”icCommªd
(
ş›Á
 *
c
, 
nx
) {

304 
j
, 
busykeys
 = 0;

306 ià((
c
->
¬gc
 % 2) == 0) {

307 
	`addR•lyE¼Ü
(
c
,"wrong‚umber of‡rguments for MSET");

312 ià(
nx
) {

313 
j
 = 1; j < 
c
->
¬gc
; j += 2) {

314 ià(
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[
j
]è!ğ
NULL
) {

315 
busykeys
++;

318 ià(
busykeys
) {

319 
	`addR•ly
(
c
, 
sh¬ed
.
cz”o
);

324 
j
 = 1; j < 
c
->
¬gc
; j += 2) {

325 
c
->
¬gv
[
j
+1] = 
	`ŒyObjeùEncodšg
(c->argv[j+1]);

326 
	`£tKey
(
c
->
db
,c->
¬gv
[
j
],c->argv[j+1]);

327 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£t",
c
->
¬gv
[
j
],c->
db
->
id
);

329 
£rv”
.
dœty
 +ğ(
c
->
¬gc
-1)/2;

330 
	`addR•ly
(
c
, 
nx
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
ok
);

331 
	}
}

333 
	$m£tCommªd
(
ş›Á
 *
c
) {

334 
	`m£tG’”icCommªd
(
c
,0);

335 
	}
}

337 
	$m£ŠxCommªd
(
ş›Á
 *
c
) {

338 
	`m£tG’”icCommªd
(
c
,1);

339 
	}
}

341 
	$šüDeüCommªd
(
ş›Á
 *
c
, 
šü
) {

342 
v®ue
, 
Şdv®ue
;

343 
robj
 *
o
, *
Ãw
;

345 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

346 ià(
o
 !ğ
NULL
 && 
	`checkTy³
(
c
,o,
OBJ_STRING
)) ;

347 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,
o
,&
v®ue
,
NULL
è!ğ
C_OK
) ;

349 
Şdv®ue
 = 
v®ue
;

350 ià((
šü
 < 0 && 
Şdv®ue
 < 0 && inü < (
LLONG_MIN
-oldvalue)) ||

351 (
šü
 > 0 && 
Şdv®ue
 > 0 && inü > (
LLONG_MAX
-oldvalue))) {

352 
	`addR•lyE¼Ü
(
c
,"increment or decrement would overflow");

355 
v®ue
 +ğ
šü
;

357 ià(
o
 && o->
»fcouÁ
 =ğ1 && o->
’codšg
 =ğ
OBJ_ENCODING_INT
 &&

358 (
v®ue
 < 0 || v®u>ğ
OBJ_SHARED_INTEGERS
) &&

359 
v®ue
 >ğ
LONG_MIN
 && v®u<ğ
LONG_MAX
)

361 
Ãw
 = 
o
;

362 
o
->
±r
 = (*)(()
v®ue
);

364 
Ãw
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
v®ue
);

365 ià(
o
) {

366 
	`dbOv”wr™e
(
c
->
db
,c->
¬gv
[1],
Ãw
);

368 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
Ãw
);

371 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

372 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"šüby",
c
->
¬gv
[1],c->
db
->
id
);

373 
£rv”
.
dœty
++;

374 
	`addR•ly
(
c
,
sh¬ed
.
cŞÚ
);

375 
	`addR•ly
(
c
,
Ãw
);

376 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

377 
	}
}

379 
	$šüCommªd
(
ş›Á
 *
c
) {

380 
	`šüDeüCommªd
(
c
,1);

381 
	}
}

383 
	$deüCommªd
(
ş›Á
 *
c
) {

384 
	`šüDeüCommªd
(
c
,-1);

385 
	}
}

387 
	$šübyCommªd
(
ş›Á
 *
c
) {

388 
šü
;

390 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
šü
, 
NULL
è!ğ
C_OK
) ;

391 
	`šüDeüCommªd
(
c
,
šü
);

392 
	}
}

394 
	$deübyCommªd
(
ş›Á
 *
c
) {

395 
šü
;

397 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
šü
, 
NULL
è!ğ
C_OK
) ;

398 
	`šüDeüCommªd
(
c
,-
šü
);

399 
	}
}

401 
	$šübyæßtCommªd
(
ş›Á
 *
c
) {

402 
šü
, 
v®ue
;

403 
robj
 *
o
, *
Ãw
, *
aux
;

405 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

406 ià(
o
 !ğ
NULL
 && 
	`checkTy³
(
c
,o,
OBJ_STRING
)) ;

407 ià(
	`g‘LÚgDoubËFromObjeùOrR•ly
(
c
,
o
,&
v®ue
,
NULL
è!ğ
C_OK
 ||

408 
	`g‘LÚgDoubËFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
šü
,
NULL
è!ğ
C_OK
)

411 
v®ue
 +ğ
šü
;

412 ià(
	`i¢ª
(
v®ue
è|| 
	`isšf
(value)) {

413 
	`addR•lyE¼Ü
(
c
,"increment would…roduce NaN or Infinity");

416 
Ãw
 = 
	`ü—‹SŒšgObjeùFromLÚgDoubË
(
v®ue
,1);

417 ià(
o
)

418 
	`dbOv”wr™e
(
c
->
db
,c->
¬gv
[1],
Ãw
);

420 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
Ãw
);

421 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

422 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"šübyæßt",
c
->
¬gv
[1],c->
db
->
id
);

423 
£rv”
.
dœty
++;

424 
	`addR•lyBulk
(
c
,
Ãw
);

429 
aux
 = 
	`ü—‹SŒšgObjeù
("SET",3);

430 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,0,
aux
);

431 
	`deüRefCouÁ
(
aux
);

432 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,2,
Ãw
);

433 
	}
}

435 
	$­³ndCommªd
(
ş›Á
 *
c
) {

436 
size_t
 
tÙËn
;

437 
robj
 *
o
, *
­³nd
;

439 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

440 ià(
o
 =ğ
NULL
) {

442 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

443 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],c->argv[2]);

444 
	`šüRefCouÁ
(
c
->
¬gv
[2]);

445 
tÙËn
 = 
	`¡ršgObjeùL’
(
c
->
¬gv
[2]);

448 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
))

452 
­³nd
 = 
c
->
¬gv
[2];

453 
tÙËn
 = 
	`¡ršgObjeùL’
(
o
)+
	`sd¦’
(
­³nd
->
±r
);

454 ià(
	`checkSŒšgL’gth
(
c
,
tÙËn
è!ğ
C_OK
)

458 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

459 
o
->
±r
 = 
	`sdsÿ’
(o->±r,
­³nd
->±r,
	`sd¦’
(append->ptr));

460 
tÙËn
 = 
	`sd¦’
(
o
->
±r
);

462 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

463 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"­³nd",
c
->
¬gv
[1],c->
db
->
id
);

464 
£rv”
.
dœty
++;

465 
	`addR•lyLÚgLÚg
(
c
,
tÙËn
);

466 
	}
}

468 
	$¡¾’Commªd
(
ş›Á
 *
c
) {

469 
robj
 *
o
;

470 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

471 
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) ;

472 
	`addR•lyLÚgLÚg
(
c
,
	`¡ršgObjeùL’
(
o
));

473 
	}
}

	@t_zset.c

59 
	~"£rv”.h
"

60 
	~<m©h.h
>

66 
z¦LexV®ueG‹Mš
(
sds
 
v®ue
, 
zËx¿nge¥ec
 *
¥ec
);

67 
z¦LexV®ueL‹Max
(
sds
 
v®ue
, 
zËx¿nge¥ec
 *
¥ec
);

71 
zskli¡Node
 *
	$z¦C»©eNode
(
Ëv–
, 
scÜe
, 
sds
 
–e
) {

72 
zskli¡Node
 *
zn
 =

73 
	`zm®loc
((*
zn
)+
Ëv–
*(
zskli¡Lev–
));

74 
zn
->
scÜe
 = score;

75 
zn
->
–e
 =ƒle;

76  
zn
;

77 
	}
}

80 
zskli¡
 *
	$z¦C»©e
() {

81 
j
;

82 
zskli¡
 *
z¦
;

84 
z¦
 = 
	`zm®loc
((*zsl));

85 
z¦
->
Ëv–
 = 1;

86 
z¦
->
Ëngth
 = 0;

87 
z¦
->
h—d”
 = 
	`z¦C»©eNode
(
ZSKIPLIST_MAXLEVEL
,0,
NULL
);

88 
j
 = 0; j < 
ZSKIPLIST_MAXLEVEL
; j++) {

89 
z¦
->
h—d”
->
Ëv–
[
j
].
fÜw¬d
 = 
NULL
;

90 
z¦
->
h—d”
->
Ëv–
[
j
].
¥ª
 = 0;

92 
z¦
->
h—d”
->
backw¬d
 = 
NULL
;

93 
z¦
->

 = 
NULL
;

94  
z¦
;

95 
	}
}

100 
	$z¦F»eNode
(
zskli¡Node
 *
node
) {

101 
	`sdsä“
(
node
->
–e
);

102 
	`zä“
(
node
);

103 
	}
}

106 
	$z¦F»e
(
zskli¡
 *
z¦
) {

107 
zskli¡Node
 *
node
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
, *
Ãxt
;

109 
	`zä“
(
z¦
->
h—d”
);

110 
node
) {

111 
Ãxt
 = 
node
->
Ëv–
[0].
fÜw¬d
;

112 
	`z¦F»eNode
(
node
);

113 
node
 = 
Ãxt
;

115 
	`zä“
(
z¦
);

116 
	}
}

122 
	$z¦RªdomLev–
() {

123 
Ëv–
 = 1;

124 (
	`¿ndom
()&0xFFFFè< (
ZSKIPLIST_P
 * 0xFFFF))

125 
Ëv–
 += 1;

126  (
Ëv–
<
ZSKIPLIST_MAXLEVEL
) ?†evel : ZSKIPLIST_MAXLEVEL;

127 
	}
}

132 
zskli¡Node
 *
	$z¦In£¹
(
zskli¡
 *
z¦
, 
scÜe
, 
sds
 
–e
) {

133 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

134 
¿nk
[
ZSKIPLIST_MAXLEVEL
];

135 
i
, 
Ëv–
;

137 
	`£rv”As£¹
(!
	`i¢ª
(
scÜe
));

138 
x
 = 
z¦
->
h—d”
;

139 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

141 
¿nk
[
i
] = i =ğ(
z¦
->
Ëv–
-1) ? 0 :„ank[i+1];

142 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

143 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 < score ||

144 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 == score &&

145 
	`sdscmp
(
x
->
Ëv–
[
i
].
fÜw¬d
->
–e
,ele) < 0)))

147 
¿nk
[
i
] +ğ
x
->
Ëv–
[i].
¥ª
;

148 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

150 
upd©e
[
i
] = 
x
;

156 
Ëv–
 = 
	`z¦RªdomLev–
();

157 ià(
Ëv–
 > 
z¦
->level) {

158 
i
 = 
z¦
->
Ëv–
; i <†evel; i++) {

159 
¿nk
[
i
] = 0;

160 
upd©e
[
i
] = 
z¦
->
h—d”
;

161 
upd©e
[
i
]->
Ëv–
[i].
¥ª
 = 
z¦
->
Ëngth
;

163 
z¦
->
Ëv–
 =†evel;

165 
x
 = 
	`z¦C»©eNode
(
Ëv–
,
scÜe
,
–e
);

166 
i
 = 0; i < 
Ëv–
; i++) {

167 
x
->
Ëv–
[
i
].
fÜw¬d
 = 
upd©e
[i]->level[i].forward;

168 
upd©e
[
i
]->
Ëv–
[i].
fÜw¬d
 = 
x
;

171 
x
->
Ëv–
[
i
].
¥ª
 = 
upd©e
[i]->Ëv–[i].¥ª - (
¿nk
[0] -„ank[i]);

172 
upd©e
[
i
]->
Ëv–
[i].
¥ª
 = (
¿nk
[0] -„ank[i]) + 1;

176 
i
 = 
Ëv–
; i < 
z¦
->level; i++) {

177 
upd©e
[
i
]->
Ëv–
[i].
¥ª
++;

180 
x
->
backw¬d
 = (
upd©e
[0] =ğ
z¦
->
h—d”
è? 
NULL
 : update[0];

181 ià(
x
->
Ëv–
[0].
fÜw¬d
)

182 
x
->
Ëv–
[0].
fÜw¬d
->
backw¬d
 = x;

184 
z¦
->

 = 
x
;

185 
z¦
->
Ëngth
++;

186  
x
;

187 
	}
}

190 
	$z¦D–‘eNode
(
zskli¡
 *
z¦
, 
zskli¡Node
 *
x
, zskli¡Nod**
upd©e
) {

191 
i
;

192 
i
 = 0; i < 
z¦
->
Ëv–
; i++) {

193 ià(
upd©e
[
i
]->
Ëv–
[i].
fÜw¬d
 =ğ
x
) {

194 
upd©e
[
i
]->
Ëv–
[i].
¥ª
 +ğ
x
->level[i].span - 1;

195 
upd©e
[
i
]->
Ëv–
[i].
fÜw¬d
 = 
x
->level[i].forward;

197 
upd©e
[
i
]->
Ëv–
[i].
¥ª
 -= 1;

200 ià(
x
->
Ëv–
[0].
fÜw¬d
) {

201 
x
->
Ëv–
[0].
fÜw¬d
->
backw¬d
 = x->backward;

203 
z¦
->

 = 
x
->
backw¬d
;

205 
z¦
->
Ëv–
 > 1 && z¦->
h—d”
->Ëv–[z¦->Ëv–-1].
fÜw¬d
 =ğ
NULL
)

206 
z¦
->
Ëv–
--;

207 
z¦
->
Ëngth
--;

208 
	}
}

218 
	$z¦D–‘e
(
zskli¡
 *
z¦
, 
scÜe
, 
sds
 
–e
, 
zskli¡Node
 **
node
) {

219 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

220 
i
;

222 
x
 = 
z¦
->
h—d”
;

223 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

224 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

225 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 < score ||

226 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 == score &&

227 
	`sdscmp
(
x
->
Ëv–
[
i
].
fÜw¬d
->
–e
,ele) < 0)))

229 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

231 
upd©e
[
i
] = 
x
;

235 
x
 = x->
Ëv–
[0].
fÜw¬d
;

236 ià(
x
 && 
scÜe
 =ğx->scÜ&& 
	`sdscmp
(x->
–e
,ele) == 0) {

237 
	`z¦D–‘eNode
(
z¦
, 
x
, 
upd©e
);

238 ià(!
node
)

239 
	`z¦F»eNode
(
x
);

241 *
node
 = 
x
;

245 
	}
}

247 
	$z¦V®ueG‹Mš
(
v®ue
, 
z¿nge¥ec
 *
¥ec
) {

248  
¥ec
->
mšex
 ? (
v®ue
 > s³c->
mš
) : (value >= spec->min);

249 
	}
}

251 
	$z¦V®ueL‹Max
(
v®ue
, 
z¿nge¥ec
 *
¥ec
) {

252  
¥ec
->
maxex
 ? (
v®ue
 < s³c->
max
) : (value <= spec->max);

253 
	}
}

256 
	$z¦IsInRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
) {

257 
zskli¡Node
 *
x
;

260 ià(
¿nge
->
mš
 >„ªge->
max
 ||

261 (
¿nge
->
mš
 =ğ¿nge->
max
 && (¿nge->
mšex
 ||„ªge->
maxex
)))

263 
x
 = 
z¦
->

;

264 ià(
x
 =ğ
NULL
 || !
	`z¦V®ueG‹Mš
(x->
scÜe
,
¿nge
))

266 
x
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

267 ià(
x
 =ğ
NULL
 || !
	`z¦V®ueL‹Max
(x->
scÜe
,
¿nge
))

270 
	}
}

274 
zskli¡Node
 *
	$z¦Fœ¡InRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
) {

275 
zskli¡Node
 *
x
;

276 
i
;

279 ià(!
	`z¦IsInRªge
(
z¦
,
¿nge
)è 
NULL
;

281 
x
 = 
z¦
->
h—d”
;

282 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

284 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

285 !
	`z¦V®ueG‹Mš
(
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
,
¿nge
))

286 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

290 
x
 = x->
Ëv–
[0].
fÜw¬d
;

291 
	`£rv”As£¹
(
x
 !ğ
NULL
);

294 ià(!
	`z¦V®ueL‹Max
(
x
->
scÜe
,
¿nge
)è 
NULL
;

295  
x
;

296 
	}
}

300 
zskli¡Node
 *
	$z¦La¡InRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
) {

301 
zskli¡Node
 *
x
;

302 
i
;

305 ià(!
	`z¦IsInRªge
(
z¦
,
¿nge
)è 
NULL
;

307 
x
 = 
z¦
->
h—d”
;

308 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

310 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

311 
	`z¦V®ueL‹Max
(
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
,
¿nge
))

312 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

316 
	`£rv”As£¹
(
x
 !ğ
NULL
);

319 ià(!
	`z¦V®ueG‹Mš
(
x
->
scÜe
,
¿nge
)è 
NULL
;

320  
x
;

321 
	}
}

327 
	$z¦D–‘eRªgeByScÜe
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
, 
diù
 *dict) {

328 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

329 
»moved
 = 0;

330 
i
;

332 
x
 = 
z¦
->
h—d”
;

333 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

334 
x
->
Ëv–
[
i
].
fÜw¬d
 && (
¿nge
->
mšex
 ?

335 
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 <ğ
¿nge
->
mš
 :

336 
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 < 
¿nge
->
mš
))

337 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

338 
upd©e
[
i
] = 
x
;

342 
x
 = x->
Ëv–
[0].
fÜw¬d
;

345 
x
 &&

346 (
¿nge
->
maxex
 ? 
x
->
scÜe
 <„ªge->
max
 : x->score <=„ange->max))

348 
zskli¡Node
 *
Ãxt
 = 
x
->
Ëv–
[0].
fÜw¬d
;

349 
	`z¦D–‘eNode
(
z¦
,
x
,
upd©e
);

350 
	`diùD–‘e
(
diù
,
x
->
–e
);

351 
	`z¦F»eNode
(
x
);

352 
»moved
++;

353 
x
 = 
Ãxt
;

355  
»moved
;

356 
	}
}

358 
	$z¦D–‘eRªgeByLex
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
, 
diù
 *dict) {

359 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

360 
»moved
 = 0;

361 
i
;

364 
x
 = 
z¦
->
h—d”
;

365 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

366 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

367 !
	`z¦LexV®ueG‹Mš
(
x
->
Ëv–
[
i
].
fÜw¬d
->
–e
,
¿nge
))

368 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

369 
upd©e
[
i
] = 
x
;

373 
x
 = x->
Ëv–
[0].
fÜw¬d
;

376 
x
 && 
	`z¦LexV®ueL‹Max
(x->
–e
,
¿nge
)) {

377 
zskli¡Node
 *
Ãxt
 = 
x
->
Ëv–
[0].
fÜw¬d
;

378 
	`z¦D–‘eNode
(
z¦
,
x
,
upd©e
);

379 
	`diùD–‘e
(
diù
,
x
->
–e
);

380 
	`z¦F»eNode
(
x
);

381 
»moved
++;

382 
x
 = 
Ãxt
;

384  
»moved
;

385 
	}
}

389 
	$z¦D–‘eRªgeByRªk
(
zskli¡
 *
z¦
, 
¡¬t
, 
’d
, 
diù
 *dict) {

390 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

391 
Œav”£d
 = 0, 
»moved
 = 0;

392 
i
;

394 
x
 = 
z¦
->
h—d”
;

395 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

396 
x
->
Ëv–
[
i
].
fÜw¬d
 && (
Œav”£d
 + x->Ëv–[i].
¥ª
è< 
¡¬t
) {

397 
Œav”£d
 +ğ
x
->
Ëv–
[
i
].
¥ª
;

398 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

400 
upd©e
[
i
] = 
x
;

403 
Œav”£d
++;

404 
x
 = x->
Ëv–
[0].
fÜw¬d
;

405 
x
 && 
Œav”£d
 <ğ
’d
) {

406 
zskli¡Node
 *
Ãxt
 = 
x
->
Ëv–
[0].
fÜw¬d
;

407 
	`z¦D–‘eNode
(
z¦
,
x
,
upd©e
);

408 
	`diùD–‘e
(
diù
,
x
->
–e
);

409 
	`z¦F»eNode
(
x
);

410 
»moved
++;

411 
Œav”£d
++;

412 
x
 = 
Ãxt
;

414  
»moved
;

415 
	}
}

421 
	$z¦G‘Rªk
(
zskli¡
 *
z¦
, 
scÜe
, 
sds
 
–e
) {

422 
zskli¡Node
 *
x
;

423 
¿nk
 = 0;

424 
i
;

426 
x
 = 
z¦
->
h—d”
;

427 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

428 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

429 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 < score ||

430 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 == score &&

431 
	`sdscmp
(
x
->
Ëv–
[
i
].
fÜw¬d
->
–e
,ele) <= 0))) {

432 
¿nk
 +ğ
x
->
Ëv–
[
i
].
¥ª
;

433 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

437 ià(
x
->
–e
 && 
	`sdscmp
(x->ele,ele) == 0) {

438  
¿nk
;

442 
	}
}

445 
zskli¡Node
* 
	$z¦G‘EËm’tByRªk
(
zskli¡
 *
z¦
, 
¿nk
) {

446 
zskli¡Node
 *
x
;

447 
Œav”£d
 = 0;

448 
i
;

450 
x
 = 
z¦
->
h—d”
;

451 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

452 
x
->
Ëv–
[
i
].
fÜw¬d
 && (
Œav”£d
 + x->Ëv–[i].
¥ª
è<ğ
¿nk
)

454 
Œav”£d
 +ğ
x
->
Ëv–
[
i
].
¥ª
;

455 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

457 ià(
Œav”£d
 =ğ
¿nk
) {

458  
x
;

461  
NULL
;

462 
	}
}

465 
	$z¦P¬£Rªge
(
robj
 *
mš
,„obj *
max
, 
z¿nge¥ec
 *
¥ec
) {

466 *
•Œ
;

467 
¥ec
->
mšex
 = s³c->
maxex
 = 0;

473 ià(
mš
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

474 
¥ec
->
mš
 = ()mš->
±r
;

476 ià(((*)
mš
->
±r
)[0] == '(') {

477 
¥ec
->
mš
 = 
	`¡¹od
((*)mš->
±r
+1,&
•Œ
);

478 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
¥ec
->
mš
)è 
C_ERR
;

479 
¥ec
->
mšex
 = 1;

481 
¥ec
->
mš
 = 
	`¡¹od
((*)mš->
±r
,&
•Œ
);

482 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
¥ec
->
mš
)è 
C_ERR
;

485 ià(
max
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

486 
¥ec
->
max
 = ()max->
±r
;

488 ià(((*)
max
->
±r
)[0] == '(') {

489 
¥ec
->
max
 = 
	`¡¹od
((*)max->
±r
+1,&
•Œ
);

490 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
¥ec
->
max
)è 
C_ERR
;

491 
¥ec
->
maxex
 = 1;

493 
¥ec
->
max
 = 
	`¡¹od
((*)max->
±r
,&
•Œ
);

494 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
¥ec
->
max
)è 
C_ERR
;

498  
C_OK
;

499 
	}
}

516 
	$z¦P¬£LexRªgeI‹m
(
robj
 *
™em
, 
sds
 *
de¡
, *
ex
) {

517 *
c
 = 
™em
->
±r
;

519 
c
[0]) {

521 ià(
c
[1] !ğ'\0'è 
C_ERR
;

522 *
ex
 = 0;

523 *
de¡
 = 
sh¬ed
.
max¡ršg
;

524  
C_OK
;

526 ià(
c
[1] !ğ'\0'è 
C_ERR
;

527 *
ex
 = 0;

528 *
de¡
 = 
sh¬ed
.
mš¡ršg
;

529  
C_OK
;

531 *
ex
 = 1;

532 *
de¡
 = 
	`sd¢ewËn
(
c
+1,
	`sd¦’
(c)-1);

533  
C_OK
;

535 *
ex
 = 0;

536 *
de¡
 = 
	`sd¢ewËn
(
c
+1,
	`sd¦’
(c)-1);

537  
C_OK
;

539  
C_ERR
;

541 
	}
}

545 
	$z¦F»eLexRªge
(
zËx¿nge¥ec
 *
¥ec
) {

546 ià(
¥ec
->
mš
 !ğ
sh¬ed
.
mš¡ršg
 &&

547 
¥ec
->
mš
 !ğ
sh¬ed
.
max¡ršg
è
	`sdsä“
(spec->min);

548 ià(
¥ec
->
max
 !ğ
sh¬ed
.
mš¡ršg
 &&

549 
¥ec
->
max
 !ğ
sh¬ed
.
max¡ršg
è
	`sdsä“
(spec->max);

550 
	}
}

557 
	$z¦P¬£LexRªge
(
robj
 *
mš
,„obj *
max
, 
zËx¿nge¥ec
 *
¥ec
) {

560 ià(
mš
->
’codšg
 =ğ
OBJ_ENCODING_INT
 ||

561 
max
->
’codšg
 =ğ
OBJ_ENCODING_INT
è 
C_ERR
;

563 
¥ec
->
mš
 = s³c->
max
 = 
NULL
;

564 ià(
	`z¦P¬£LexRªgeI‹m
(
mš
, &
¥ec
->mš, &¥ec->
mšex
è=ğ
C_ERR
 ||

565 
	`z¦P¬£LexRªgeI‹m
(
max
, &
¥ec
->max, &¥ec->
maxex
è=ğ
C_ERR
) {

566 
	`z¦F»eLexRªge
(
¥ec
);

567  
C_ERR
;

569  
C_OK
;

571 
	}
}

576 
	$sdscm¶ex
(
sds
 
a
, sd 
b
) {

577 ià(
a
 =ğ
b
)  0;

578 ià(
a
 =ğ
sh¬ed
.
mš¡ršg
 || 
b
 =ğsh¬ed.
max¡ršg
)  -1;

579 ià(
a
 =ğ
sh¬ed
.
max¡ršg
 || 
b
 =ğsh¬ed.
mš¡ršg
)  1;

580  
	`sdscmp
(
a
,
b
);

581 
	}
}

583 
	$z¦LexV®ueG‹Mš
(
sds
 
v®ue
, 
zËx¿nge¥ec
 *
¥ec
) {

584  
¥ec
->
mšex
 ?

585 (
	`sdscm¶ex
(
v®ue
,
¥ec
->
mš
) > 0) :

586 (
	`sdscm¶ex
(
v®ue
,
¥ec
->
mš
) >= 0);

587 
	}
}

589 
	$z¦LexV®ueL‹Max
(
sds
 
v®ue
, 
zËx¿nge¥ec
 *
¥ec
) {

590  
¥ec
->
maxex
 ?

591 (
	`sdscm¶ex
(
v®ue
,
¥ec
->
max
) < 0) :

592 (
	`sdscm¶ex
(
v®ue
,
¥ec
->
max
) <= 0);

593 
	}
}

596 
	$z¦IsInLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
) {

597 
zskli¡Node
 *
x
;

600 ià(
	`sdscm¶ex
(
¿nge
->
mš
,¿nge->
max
) > 1 ||

601 (
	`sdscmp
(
¿nge
->
mš
,¿nge->
max
) == 0 &&

602 (
¿nge
->
mšex
 ||„ªge->
maxex
)))

604 
x
 = 
z¦
->

;

605 ià(
x
 =ğ
NULL
 || !
	`z¦LexV®ueG‹Mš
(x->
–e
,
¿nge
))

607 
x
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

608 ià(
x
 =ğ
NULL
 || !
	`z¦LexV®ueL‹Max
(x->
–e
,
¿nge
))

611 
	}
}

615 
zskli¡Node
 *
	$z¦Fœ¡InLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
) {

616 
zskli¡Node
 *
x
;

617 
i
;

620 ià(!
	`z¦IsInLexRªge
(
z¦
,
¿nge
)è 
NULL
;

622 
x
 = 
z¦
->
h—d”
;

623 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

625 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

626 !
	`z¦LexV®ueG‹Mš
(
x
->
Ëv–
[
i
].
fÜw¬d
->
–e
,
¿nge
))

627 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

631 
x
 = x->
Ëv–
[0].
fÜw¬d
;

632 
	`£rv”As£¹
(
x
 !ğ
NULL
);

635 ià(!
	`z¦LexV®ueL‹Max
(
x
->
–e
,
¿nge
)è 
NULL
;

636  
x
;

637 
	}
}

641 
zskli¡Node
 *
	$z¦La¡InLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
) {

642 
zskli¡Node
 *
x
;

643 
i
;

646 ià(!
	`z¦IsInLexRªge
(
z¦
,
¿nge
)è 
NULL
;

648 
x
 = 
z¦
->
h—d”
;

649 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

651 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

652 
	`z¦LexV®ueL‹Max
(
x
->
Ëv–
[
i
].
fÜw¬d
->
–e
,
¿nge
))

653 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

657 
	`£rv”As£¹
(
x
 !ğ
NULL
);

660 ià(!
	`z¦LexV®ueG‹Mš
(
x
->
–e
,
¿nge
)è 
NULL
;

661  
x
;

662 
	}
}

668 
	$zzlG‘ScÜe
(*
¥Œ
) {

669 *
v¡r
;

670 
vËn
;

671 
vlÚg
;

672 
buf
[128];

673 
scÜe
;

675 
	`£rv”As£¹
(
¥Œ
 !ğ
NULL
);

676 
	`£rv”As£¹
(
	`zli¡G‘
(
¥Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

678 ià(
v¡r
) {

679 
	`memıy
(
buf
,
v¡r
,
vËn
);

680 
buf
[
vËn
] = '\0';

681 
scÜe
 = 
	`¡¹od
(
buf
,
NULL
);

683 
scÜe
 = 
vlÚg
;

686  
scÜe
;

687 
	}
}

690 
sds
 
	$zli¡G‘Objeù
(*
¥Œ
) {

691 *
v¡r
;

692 
vËn
;

693 
vlÚg
;

695 
	`£rv”As£¹
(
¥Œ
 !ğ
NULL
);

696 
	`£rv”As£¹
(
	`zli¡G‘
(
¥Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

698 ià(
v¡r
) {

699  
	`sd¢ewËn
((*)
v¡r
,
vËn
);

701  
	`sdsäomlÚglÚg
(
vlÚg
);

703 
	}
}

706 
	$zzlCom·»EËm’ts
(*
•Œ
, *
c¡r
, 
ş’
) {

707 *
v¡r
;

708 
vËn
;

709 
vlÚg
;

710 
vbuf
[32];

711 
mšËn
, 
cmp
;

713 
	`£rv”As£¹
(
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

714 ià(
v¡r
 =ğ
NULL
) {

716 
vËn
 = 
	`Î2¡ršg
((*)
vbuf
,(vbuf),
vlÚg
);

717 
v¡r
 = 
vbuf
;

720 
mšËn
 = (
vËn
 < 
ş’
) ? vlen : clen;

721 
cmp
 = 
	`memcmp
(
v¡r
,
c¡r
,
mšËn
);

722 ià(
cmp
 =ğ0è 
vËn
-
ş’
;

723  
cmp
;

724 
	}
}

726 
	$zzlL’gth
(*
zl
) {

727  
	`zli¡L’
(
zl
)/2;

728 
	}
}

732 
	$zzlNext
(*
zl
, **
•Œ
, **
¥Œ
) {

733 *
_•Œ
, *
_¥Œ
;

734 
	`£rv”As£¹
(*
•Œ
 !ğ
NULL
 && *
¥Œ
 != NULL);

736 
_•Œ
 = 
	`zli¡Next
(
zl
,*
¥Œ
);

737 ià(
_•Œ
 !ğ
NULL
) {

738 
_¥Œ
 = 
	`zli¡Next
(
zl
,
_•Œ
);

739 
	`£rv”As£¹
(
_¥Œ
 !ğ
NULL
);

742 
_¥Œ
 = 
NULL
;

745 *
•Œ
 = 
_•Œ
;

746 *
¥Œ
 = 
_¥Œ
;

747 
	}
}

751 
	$zzlP»v
(*
zl
, **
•Œ
, **
¥Œ
) {

752 *
_•Œ
, *
_¥Œ
;

753 
	`£rv”As£¹
(*
•Œ
 !ğ
NULL
 && *
¥Œ
 != NULL);

755 
_¥Œ
 = 
	`zli¡P»v
(
zl
,*
•Œ
);

756 ià(
_¥Œ
 !ğ
NULL
) {

757 
_•Œ
 = 
	`zli¡P»v
(
zl
,
_¥Œ
);

758 
	`£rv”As£¹
(
_•Œ
 !ğ
NULL
);

761 
_•Œ
 = 
NULL
;

764 *
•Œ
 = 
_•Œ
;

765 *
¥Œ
 = 
_¥Œ
;

766 
	}
}

770 
	$zzlIsInRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
) {

771 *
p
;

772 
scÜe
;

775 ià(
¿nge
->
mš
 >„ªge->
max
 ||

776 (
¿nge
->
mš
 =ğ¿nge->
max
 && (¿nge->
mšex
 ||„ªge->
maxex
)))

779 
p
 = 
	`zli¡Index
(
zl
,-1);

780 ià(
p
 =ğ
NULL
)  0;

781 
scÜe
 = 
	`zzlG‘ScÜe
(
p
);

782 ià(!
	`z¦V®ueG‹Mš
(
scÜe
,
¿nge
))

785 
p
 = 
	`zli¡Index
(
zl
,1);

786 
	`£rv”As£¹
(
p
 !ğ
NULL
);

787 
scÜe
 = 
	`zzlG‘ScÜe
(
p
);

788 ià(!
	`z¦V®ueL‹Max
(
scÜe
,
¿nge
))

792 
	}
}

796 *
	$zzlFœ¡InRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
) {

797 *
•Œ
 = 
	`zli¡Index
(
zl
,0), *
¥Œ
;

798 
scÜe
;

801 ià(!
	`zzlIsInRªge
(
zl
,
¿nge
)è 
NULL
;

803 
•Œ
 !ğ
NULL
) {

804 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

805 
	`£rv”As£¹
(
¥Œ
 !ğ
NULL
);

807 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

808 ià(
	`z¦V®ueG‹Mš
(
scÜe
,
¿nge
)) {

810 ià(
	`z¦V®ueL‹Max
(
scÜe
,
¿nge
))

811  
•Œ
;

812  
NULL
;

816 
•Œ
 = 
	`zli¡Next
(
zl
,
¥Œ
);

819  
NULL
;

820 
	}
}

824 *
	$zzlLa¡InRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
) {

825 *
•Œ
 = 
	`zli¡Index
(
zl
,-2), *
¥Œ
;

826 
scÜe
;

829 ià(!
	`zzlIsInRªge
(
zl
,
¿nge
)è 
NULL
;

831 
•Œ
 !ğ
NULL
) {

832 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

833 
	`£rv”As£¹
(
¥Œ
 !ğ
NULL
);

835 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

836 ià(
	`z¦V®ueL‹Max
(
scÜe
,
¿nge
)) {

838 ià(
	`z¦V®ueG‹Mš
(
scÜe
,
¿nge
))

839  
•Œ
;

840  
NULL
;

845 
¥Œ
 = 
	`zli¡P»v
(
zl
,
•Œ
);

846 ià(
¥Œ
 !ğ
NULL
)

847 
	`£rv”As£¹
((
•Œ
 = 
	`zli¡P»v
(
zl
,
¥Œ
)è!ğ
NULL
);

849 
•Œ
 = 
NULL
;

852  
NULL
;

853 
	}
}

855 
	$zzlLexV®ueG‹Mš
(*
p
, 
zËx¿nge¥ec
 *
¥ec
) {

856 
sds
 
v®ue
 = 
	`zli¡G‘Objeù
(
p
);

857 
»s
 = 
	`z¦LexV®ueG‹Mš
(
v®ue
,
¥ec
);

858 
	`sdsä“
(
v®ue
);

859  
»s
;

860 
	}
}

862 
	$zzlLexV®ueL‹Max
(*
p
, 
zËx¿nge¥ec
 *
¥ec
) {

863 
sds
 
v®ue
 = 
	`zli¡G‘Objeù
(
p
);

864 
»s
 = 
	`z¦LexV®ueL‹Max
(
v®ue
,
¥ec
);

865 
	`sdsä“
(
v®ue
);

866  
»s
;

867 
	}
}

871 
	$zzlIsInLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
) {

872 *
p
;

875 ià(
	`sdscm¶ex
(
¿nge
->
mš
,¿nge->
max
) > 1 ||

876 (
	`sdscmp
(
¿nge
->
mš
,¿nge->
max
) == 0 &&

877 (
¿nge
->
mšex
 ||„ªge->
maxex
)))

880 
p
 = 
	`zli¡Index
(
zl
,-2);

881 ià(
p
 =ğ
NULL
)  0;

882 ià(!
	`zzlLexV®ueG‹Mš
(
p
,
¿nge
))

885 
p
 = 
	`zli¡Index
(
zl
,0);

886 
	`£rv”As£¹
(
p
 !ğ
NULL
);

887 ià(!
	`zzlLexV®ueL‹Max
(
p
,
¿nge
))

891 
	}
}

895 *
	$zzlFœ¡InLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
) {

896 *
•Œ
 = 
	`zli¡Index
(
zl
,0), *
¥Œ
;

899 ià(!
	`zzlIsInLexRªge
(
zl
,
¿nge
)è 
NULL
;

901 
•Œ
 !ğ
NULL
) {

902 ià(
	`zzlLexV®ueG‹Mš
(
•Œ
,
¿nge
)) {

904 ià(
	`zzlLexV®ueL‹Max
(
•Œ
,
¿nge
))

905  
•Œ
;

906  
NULL
;

910 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

911 
	`£rv”As£¹
(
¥Œ
 !ğ
NULL
);

912 
•Œ
 = 
	`zli¡Next
(
zl
,
¥Œ
);

915  
NULL
;

916 
	}
}

920 *
	$zzlLa¡InLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
) {

921 *
•Œ
 = 
	`zli¡Index
(
zl
,-2), *
¥Œ
;

924 ià(!
	`zzlIsInLexRªge
(
zl
,
¿nge
)è 
NULL
;

926 
•Œ
 !ğ
NULL
) {

927 ià(
	`zzlLexV®ueL‹Max
(
•Œ
,
¿nge
)) {

929 ià(
	`zzlLexV®ueG‹Mš
(
•Œ
,
¿nge
))

930  
•Œ
;

931  
NULL
;

936 
¥Œ
 = 
	`zli¡P»v
(
zl
,
•Œ
);

937 ià(
¥Œ
 !ğ
NULL
)

938 
	`£rv”As£¹
((
•Œ
 = 
	`zli¡P»v
(
zl
,
¥Œ
)è!ğ
NULL
);

940 
•Œ
 = 
NULL
;

943  
NULL
;

944 
	}
}

946 *
	$zzlFšd
(*
zl
, 
sds
 
–e
, *
scÜe
) {

947 *
•Œ
 = 
	`zli¡Index
(
zl
,0), *
¥Œ
;

949 
•Œ
 !ğ
NULL
) {

950 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

951 
	`£rv”As£¹
(
¥Œ
 !ğ
NULL
);

953 ià(
	`zli¡Com·»
(
•Œ
,(*)
–e
,
	`sd¦’
(ele))) {

955 ià(
scÜe
 !ğ
NULL
è*scÜğ
	`zzlG‘ScÜe
(
¥Œ
);

956  
•Œ
;

960 
•Œ
 = 
	`zli¡Next
(
zl
,
¥Œ
);

962  
NULL
;

963 
	}
}

967 *
	$zzlD–‘e
(*
zl
, *
•Œ
) {

968 *
p
 = 
•Œ
;

971 
zl
 = 
	`zli¡D–‘e
(zl,&
p
);

972 
zl
 = 
	`zli¡D–‘e
(zl,&
p
);

973  
zl
;

974 
	}
}

976 *
	$zzlIn£¹At
(*
zl
, *
•Œ
, 
sds
 
–e
, 
scÜe
) {

977 *
¥Œ
;

978 
scÜebuf
[128];

979 
scÜ–’
;

980 
size_t
 
off£t
;

982 
scÜ–’
 = 
	`d2¡ršg
(
scÜebuf
,(scÜebuf),
scÜe
);

983 ià(
•Œ
 =ğ
NULL
) {

984 
zl
 = 
	`zli¡Push
(zl,(*)
–e
,
	`sd¦’
ÓË),
ZIPLIST_TAIL
);

985 
zl
 = 
	`zli¡Push
(zl,(*)
scÜebuf
,
scÜ–’
,
ZIPLIST_TAIL
);

988 
off£t
 = 
•Œ
-
zl
;

989 
zl
 = 
	`zli¡In£¹
(zl,
•Œ
,(*)
–e
,
	`sd¦’
(ele));

990 
•Œ
 = 
zl
+
off£t
;

993 
	`£rv”As£¹
((
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
)è!ğ
NULL
);

994 
zl
 = 
	`zli¡In£¹
(zl,
¥Œ
,(*)
scÜebuf
,
scÜ–’
);

996  
zl
;

997 
	}
}

1001 *
	$zzlIn£¹
(*
zl
, 
sds
 
–e
, 
scÜe
) {

1002 *
•Œ
 = 
	`zli¡Index
(
zl
,0), *
¥Œ
;

1003 
s
;

1005 
•Œ
 !ğ
NULL
) {

1006 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

1007 
	`£rv”As£¹
(
¥Œ
 !ğ
NULL
);

1008 
s
 = 
	`zzlG‘ScÜe
(
¥Œ
);

1010 ià(
s
 > 
scÜe
) {

1014 
zl
 = 
	`zzlIn£¹At
(zl,
•Œ
,
–e
,
scÜe
);

1016 } ià(
s
 =ğ
scÜe
) {

1018 ià(
	`zzlCom·»EËm’ts
(
•Œ
,(*)
–e
,
	`sd¦’
(ele)) > 0) {

1019 
zl
 = 
	`zzlIn£¹At
(zl,
•Œ
,
–e
,
scÜe
);

1025 
•Œ
 = 
	`zli¡Next
(
zl
,
¥Œ
);

1029 ià(
•Œ
 =ğ
NULL
)

1030 
zl
 = 
	`zzlIn£¹At
(zl,
NULL
,
–e
,
scÜe
);

1031  
zl
;

1032 
	}
}

1034 *
	$zzlD–‘eRªgeByScÜe
(*
zl
, 
z¿nge¥ec
 *
¿nge
, *
d–‘ed
) {

1035 *
•Œ
, *
¥Œ
;

1036 
scÜe
;

1037 
num
 = 0;

1039 ià(
d–‘ed
 !ğ
NULL
) *deleted = 0;

1041 
•Œ
 = 
	`zzlFœ¡InRªge
(
zl
,
¿nge
);

1042 ià(
•Œ
 =ğ
NULL
è 
zl
;

1046 (
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
)è!ğ
NULL
) {

1047 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

1048 ià(
	`z¦V®ueL‹Max
(
scÜe
,
¿nge
)) {

1050 
zl
 = 
	`zli¡D–‘e
(zl,&
•Œ
);

1051 
zl
 = 
	`zli¡D–‘e
(zl,&
•Œ
);

1052 
num
++;

1059 ià(
d–‘ed
 !ğ
NULL
è*d–‘ed = 
num
;

1060  
zl
;

1061 
	}
}

1063 *
	$zzlD–‘eRªgeByLex
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
, *
d–‘ed
) {

1064 *
•Œ
, *
¥Œ
;

1065 
num
 = 0;

1067 ià(
d–‘ed
 !ğ
NULL
) *deleted = 0;

1069 
•Œ
 = 
	`zzlFœ¡InLexRªge
(
zl
,
¿nge
);

1070 ià(
•Œ
 =ğ
NULL
è 
zl
;

1074 (
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
)è!ğ
NULL
) {

1075 ià(
	`zzlLexV®ueL‹Max
(
•Œ
,
¿nge
)) {

1077 
zl
 = 
	`zli¡D–‘e
(zl,&
•Œ
);

1078 
zl
 = 
	`zli¡D–‘e
(zl,&
•Œ
);

1079 
num
++;

1086 ià(
d–‘ed
 !ğ
NULL
è*d–‘ed = 
num
;

1087  
zl
;

1088 
	}
}

1092 *
	$zzlD–‘eRªgeByRªk
(*
zl
, 
¡¬t
, 
’d
, *
d–‘ed
) {

1093 
num
 = (
’d
-
¡¬t
)+1;

1094 ià(
d–‘ed
è*d–‘ed = 
num
;

1095 
zl
 = 
	`zli¡D–‘eRªge
(zl,2*(
¡¬t
-1),2*
num
);

1096  
zl
;

1097 
	}
}

1103 
	$z£tL’gth
(cÚ¡ 
robj
 *
zobj
) {

1104 
Ëngth
 = -1;

1105 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1106 
Ëngth
 = 
	`zzlL’gth
(
zobj
->
±r
);

1107 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1108 
Ëngth
 = ((cÚ¡ 
z£t
*)
zobj
->
±r
)->
z¦
->length;

1110 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1112  
Ëngth
;

1113 
	}
}

1115 
	$z£tCÚv”t
(
robj
 *
zobj
, 
’codšg
) {

1116 
z£t
 *
zs
;

1117 
zskli¡Node
 *
node
, *
Ãxt
;

1118 
sds
 
–e
;

1119 
scÜe
;

1121 ià(
zobj
->
’codšg
 ==ƒncoding) ;

1122 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1123 *
zl
 = 
zobj
->
±r
;

1124 *
•Œ
, *
¥Œ
;

1125 *
v¡r
;

1126 
vËn
;

1127 
vlÚg
;

1129 ià(
’codšg
 !ğ
OBJ_ENCODING_SKIPLIST
)

1130 
	`£rv”Pªic
("Unknownargetƒncoding");

1132 
zs
 = 
	`zm®loc
((*zs));

1133 
zs
->
diù
 = 
	`diùC»©e
(&
z£tDiùTy³
,
NULL
);

1134 
zs
->
z¦
 = 
	`z¦C»©e
();

1136 
•Œ
 = 
	`zli¡Index
(
zl
,0);

1137 
	`£rv”As£¹W™hInfo
(
NULL
,
zobj
,
•Œ
 != NULL);

1138 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

1139 
	`£rv”As£¹W™hInfo
(
NULL
,
zobj
,
¥Œ
 != NULL);

1141 
•Œ
 !ğ
NULL
) {

1142 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

1143 
	`£rv”As£¹W™hInfo
(
NULL
,
zobj
,
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

1144 ià(
v¡r
 =ğ
NULL
)

1145 
–e
 = 
	`sdsäomlÚglÚg
(
vlÚg
);

1147 
–e
 = 
	`sd¢ewËn
((*)
v¡r
,
vËn
);

1149 
node
 = 
	`z¦In£¹
(
zs
->
z¦
,
scÜe
,
–e
);

1150 
	`£rv”As£¹
(
	`diùAdd
(
zs
->
diù
,
–e
,&
node
->
scÜe
è=ğ
DICT_OK
);

1151 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

1154 
	`zä“
(
zobj
->
±r
);

1155 
zobj
->
±r
 = 
zs
;

1156 
zobj
->
’codšg
 = 
OBJ_ENCODING_SKIPLIST
;

1157 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1158 *
zl
 = 
	`zli¡New
();

1160 ià(
’codšg
 !ğ
OBJ_ENCODING_ZIPLIST
)

1161 
	`£rv”Pªic
("Unknownargetƒncoding");

1165 
zs
 = 
zobj
->
±r
;

1166 
	`diùR–—£
(
zs
->
diù
);

1167 
node
 = 
zs
->
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

1168 
	`zä“
(
zs
->
z¦
->
h—d”
);

1169 
	`zä“
(
zs
->
z¦
);

1171 
node
) {

1172 
zl
 = 
	`zzlIn£¹At
(zl,
NULL
,
node
->
–e
,node->
scÜe
);

1173 
Ãxt
 = 
node
->
Ëv–
[0].
fÜw¬d
;

1174 
	`z¦F»eNode
(
node
);

1175 
node
 = 
Ãxt
;

1178 
	`zä“
(
zs
);

1179 
zobj
->
±r
 = 
zl
;

1180 
zobj
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

1182 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1184 
	}
}

1189 
	$z£tCÚv”tToZli¡IfN“ded
(
robj
 *
zobj
, 
size_t
 
max––’
) {

1190 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) ;

1191 
z£t
 *z£ˆğ
zobj
->
±r
;

1193 ià(
z£t
->
z¦
->
Ëngth
 <ğ
£rv”
.
z£t_max_zli¡_’Œ›s
 &&

1194 
max––’
 <ğ
£rv”
.
z£t_max_zli¡_v®ue
)

1195 
	`z£tCÚv”t
(
zobj
,
OBJ_ENCODING_ZIPLIST
);

1196 
	}
}

1202 
	$z£tScÜe
(
robj
 *
zobj
, 
sds
 
memb”
, *
scÜe
) {

1203 ià(!
zobj
 || !
memb”
è 
C_ERR
;

1205 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1206 ià(
	`zzlFšd
(
zobj
->
±r
, 
memb”
, 
scÜe
è=ğ
NULL
è 
C_ERR
;

1207 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1208 
z£t
 *
zs
 = 
zobj
->
±r
;

1209 
diùEÁry
 *
de
 = 
	`diùFšd
(
zs
->
diù
, 
memb”
);

1210 ià(
de
 =ğ
NULL
è 
C_ERR
;

1211 *
scÜe
 = *(*)
	`diùG‘V®
(
de
);

1213 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1215  
C_OK
;

1216 
	}
}

1261 
	$z£tAdd
(
robj
 *
zobj
, 
scÜe
, 
sds
 
–e
, *
æags
, *
ÃwscÜe
) {

1263 
šü
 = (*
æags
 & 
ZADD_INCR
) != 0;

1264 
nx
 = (*
æags
 & 
ZADD_NX
) != 0;

1265 
xx
 = (*
æags
 & 
ZADD_XX
) != 0;

1266 *
æags
 = 0;

1267 
curscÜe
;

1270 ià(
	`i¢ª
(
scÜe
)) {

1271 *
æags
 = 
ZADD_NAN
;

1276 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1277 *
•Œ
;

1279 ià((
•Œ
 = 
	`zzlFšd
(
zobj
->
±r
,
–e
,&
curscÜe
)è!ğ
NULL
) {

1281 ià(
nx
) {

1282 *
æags
 |ğ
ZADD_NOP
;

1287 ià(
šü
) {

1288 
scÜe
 +ğ
curscÜe
;

1289 ià(
	`i¢ª
(
scÜe
)) {

1290 *
æags
 |ğ
ZADD_NAN
;

1293 ià(
ÃwscÜe
è*ÃwscÜğ
scÜe
;

1297 ià(
scÜe
 !ğ
curscÜe
) {

1298 
zobj
->
±r
 = 
	`zzlD–‘e
(zobj->±r,
•Œ
);

1299 
zobj
->
±r
 = 
	`zzlIn£¹
(zobj->±r,
–e
,
scÜe
);

1300 *
æags
 |ğ
ZADD_UPDATED
;

1303 } ià(!
xx
) {

1306 
zobj
->
±r
 = 
	`zzlIn£¹
(zobj->±r,
–e
,
scÜe
);

1307 ià(
	`zzlL’gth
(
zobj
->
±r
è> 
£rv”
.
z£t_max_zli¡_’Œ›s
)

1308 
	`z£tCÚv”t
(
zobj
,
OBJ_ENCODING_SKIPLIST
);

1309 ià(
	`sd¦’
(
–e
è> 
£rv”
.
z£t_max_zli¡_v®ue
)

1310 
	`z£tCÚv”t
(
zobj
,
OBJ_ENCODING_SKIPLIST
);

1311 ià(
ÃwscÜe
è*ÃwscÜğ
scÜe
;

1312 *
æags
 |ğ
ZADD_ADDED
;

1315 *
æags
 |ğ
ZADD_NOP
;

1318 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1319 
z£t
 *
zs
 = 
zobj
->
±r
;

1320 
zskli¡Node
 *
znode
;

1321 
diùEÁry
 *
de
;

1323 
de
 = 
	`diùFšd
(
zs
->
diù
,
–e
);

1324 ià(
de
 !ğ
NULL
) {

1326 ià(
nx
) {

1327 *
æags
 |ğ
ZADD_NOP
;

1330 
curscÜe
 = *(*)
	`diùG‘V®
(
de
);

1333 ià(
šü
) {

1334 
scÜe
 +ğ
curscÜe
;

1335 ià(
	`i¢ª
(
scÜe
)) {

1336 *
æags
 |ğ
ZADD_NAN
;

1339 ià(
ÃwscÜe
è*ÃwscÜğ
scÜe
;

1343 ià(
scÜe
 !ğ
curscÜe
) {

1344 
zskli¡Node
 *
node
;

1345 
	`£rv”As£¹
(
	`z¦D–‘e
(
zs
->
z¦
,
curscÜe
,
–e
,&
node
));

1346 
znode
 = 
	`z¦In£¹
(
zs
->
z¦
,
scÜe
,
node
->
–e
);

1349 
node
->
–e
 = 
NULL
;

1350 
	`z¦F»eNode
(
node
);

1354 
	`diùG‘V®
(
de
èğ&
znode
->
scÜe
;

1355 *
æags
 |ğ
ZADD_UPDATED
;

1358 } ià(!
xx
) {

1359 
–e
 = 
	`sdsdup
(ele);

1360 
znode
 = 
	`z¦In£¹
(
zs
->
z¦
,
scÜe
,
–e
);

1361 
	`£rv”As£¹
(
	`diùAdd
(
zs
->
diù
,
–e
,&
znode
->
scÜe
è=ğ
DICT_OK
);

1362 *
æags
 |ğ
ZADD_ADDED
;

1363 ià(
ÃwscÜe
è*ÃwscÜğ
scÜe
;

1366 *
æags
 |ğ
ZADD_NOP
;

1370 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1373 
	}
}

1377 
	$z£tD–
(
robj
 *
zobj
, 
sds
 
–e
) {

1378 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1379 *
•Œ
;

1381 ià((
•Œ
 = 
	`zzlFšd
(
zobj
->
±r
,
–e
,
NULL
)) != NULL) {

1382 
zobj
->
±r
 = 
	`zzlD–‘e
(zobj->±r,
•Œ
);

1385 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1386 
z£t
 *
zs
 = 
zobj
->
±r
;

1387 
diùEÁry
 *
de
;

1388 
scÜe
;

1390 
de
 = 
	`diùUÆšk
(
zs
->
diù
,
–e
);

1391 ià(
de
 !ğ
NULL
) {

1393 
scÜe
 = *(*)
	`diùG‘V®
(
de
);

1400 
	`diùF»eUÆškedEÁry
(
zs
->
diù
,
de
);

1403 
»tv®
 = 
	`z¦D–‘e
(
zs
->
z¦
,
scÜe
,
–e
,
NULL
);

1404 
	`£rv”As£¹
(
»tv®
);

1406 ià(
	`htN“dsResize
(
zs
->
diù
)è
	`diùResize
(zs->dict);

1410 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1413 
	}
}

1426 
	$z£tRªk
(
robj
 *
zobj
, 
sds
 
–e
, 
»v”£
) {

1427 
Î’
;

1428 
¿nk
;

1430 
Î’
 = 
	`z£tL’gth
(
zobj
);

1432 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1433 *
zl
 = 
zobj
->
±r
;

1434 *
•Œ
, *
¥Œ
;

1436 
•Œ
 = 
	`zli¡Index
(
zl
,0);

1437 
	`£rv”As£¹
(
•Œ
 !ğ
NULL
);

1438 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

1439 
	`£rv”As£¹
(
¥Œ
 !ğ
NULL
);

1441 
¿nk
 = 1;

1442 
•Œ
 !ğ
NULL
) {

1443 ià(
	`zli¡Com·»
(
•Œ
,(*)
–e
,
	`sd¦’
(ele)))

1445 
¿nk
++;

1446 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

1449 ià(
•Œ
 !ğ
NULL
) {

1450 ià(
»v”£
)

1451  
Î’
-
¿nk
;

1453  
¿nk
-1;

1457 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1458 
z£t
 *
zs
 = 
zobj
->
±r
;

1459 
zskli¡
 *
z¦
 = 
zs
->zsl;

1460 
diùEÁry
 *
de
;

1461 
scÜe
;

1463 
de
 = 
	`diùFšd
(
zs
->
diù
,
–e
);

1464 ià(
de
 !ğ
NULL
) {

1465 
scÜe
 = *(*)
	`diùG‘V®
(
de
);

1466 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
,
scÜe
,
–e
);

1468 
	`£rv”As£¹
(
¿nk
 != 0);

1469 ià(
»v”£
)

1470  
Î’
-
¿nk
;

1472  
¿nk
-1;

1477 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1479 
	}
}

1486 
	$zaddG’”icCommªd
(
ş›Á
 *
c
, 
æags
) {

1487 *
ÇÃ¼
 = "resulting score is‚ot‡‚umber (NaN)";

1488 
robj
 *
key
 = 
c
->
¬gv
[1];

1489 
robj
 *
zobj
;

1490 
sds
 
–e
;

1491 
scÜe
 = 0, *
scÜes
 = 
NULL
;

1492 
j
, 
–em’ts
;

1493 
scÜeidx
 = 0;

1497 
added
 = 0;

1498 
upd©ed
 = 0;

1499 
´oûs£d
 = 0;

1504 
scÜeidx
 = 2;

1505 
scÜeidx
 < 
c
->
¬gc
) {

1506 *
İt
 = 
c
->
¬gv
[
scÜeidx
]->
±r
;

1507 ià(!
	`¡rÿ£cmp
(
İt
,"nx")è
æags
 |ğ
ZADD_NX
;

1508 ià(!
	`¡rÿ£cmp
(
İt
,"xx")è
æags
 |ğ
ZADD_XX
;

1509 ià(!
	`¡rÿ£cmp
(
İt
,"ch")è
æags
 |ğ
ZADD_CH
;

1510 ià(!
	`¡rÿ£cmp
(
İt
,"šü")è
æags
 |ğ
ZADD_INCR
;

1512 
scÜeidx
++;

1516 
šü
 = (
æags
 & 
ZADD_INCR
) != 0;

1517 
nx
 = (
æags
 & 
ZADD_NX
) != 0;

1518 
xx
 = (
æags
 & 
ZADD_XX
) != 0;

1519 
ch
 = (
æags
 & 
ZADD_CH
) != 0;

1523 
–em’ts
 = 
c
->
¬gc
-
scÜeidx
;

1524 ià(
–em’ts
 % 2 || !elements) {

1525 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1528 
–em’ts
 /= 2;

1531 ià(
nx
 && 
xx
) {

1532 
	`addR•lyE¼Ü
(
c
,

1537 ià(
šü
 && 
–em’ts
 > 1) {

1538 
	`addR•lyE¼Ü
(
c
,

1546 
scÜes
 = 
	`zm®loc
(()*
–em’ts
);

1547 
j
 = 0; j < 
–em’ts
; j++) {

1548 ià(
	`g‘DoubËFromObjeùOrR•ly
(
c
,c->
¬gv
[
scÜeidx
+
j
*2],&
scÜes
[j],
NULL
)

1549 !ğ
C_OK
è
ş—nup
;

1553 
zobj
 = 
	`lookupKeyWr™e
(
c
->
db
,
key
);

1554 ià(
zobj
 =ğ
NULL
) {

1555 ià(
xx
è
»¶y_to_ş›Á
;

1556 ià(
£rv”
.
z£t_max_zli¡_’Œ›s
 == 0 ||

1557 
£rv”
.
z£t_max_zli¡_v®ue
 < 
	`sd¦’
(
c
->
¬gv
[
scÜeidx
+1]->
±r
))

1559 
zobj
 = 
	`ü—‹Z£tObjeù
();

1561 
zobj
 = 
	`ü—‹Z£tZli¡Objeù
();

1563 
	`dbAdd
(
c
->
db
,
key
,
zobj
);

1565 ià(
zobj
->
ty³
 !ğ
OBJ_ZSET
) {

1566 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

1567 
ş—nup
;

1571 
j
 = 0; j < 
–em’ts
; j++) {

1572 
ÃwscÜe
;

1573 
scÜe
 = 
scÜes
[
j
];

1574 
»tæags
 = 
æags
;

1576 
–e
 = 
c
->
¬gv
[
scÜeidx
+1+
j
*2]->
±r
;

1577 
»tv®
 = 
	`z£tAdd
(
zobj
, 
scÜe
, 
–e
, &
»tæags
, &
ÃwscÜe
);

1578 ià(
»tv®
 == 0) {

1579 
	`addR•lyE¼Ü
(
c
,
ÇÃ¼
);

1580 
ş—nup
;

1582 ià(
»tæags
 & 
ZADD_ADDED
è
added
++;

1583 ià(
»tæags
 & 
ZADD_UPDATED
è
upd©ed
++;

1584 ià(!(
»tæags
 & 
ZADD_NOP
)è
´oûs£d
++;

1585 
scÜe
 = 
ÃwscÜe
;

1587 
£rv”
.
dœty
 +ğ(
added
+
upd©ed
);

1589 
»¶y_to_ş›Á
:

1590 ià(
šü
) {

1591 ià(
´oûs£d
)

1592 
	`addR•lyDoubË
(
c
,
scÜe
);

1594 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

1596 
	`addR•lyLÚgLÚg
(
c
,
ch
 ? 
added
+
upd©ed
 :‡dded);

1599 
ş—nup
:

1600 
	`zä“
(
scÜes
);

1601 ià(
added
 || 
upd©ed
) {

1602 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

1603 
	`nÙifyKey¥aûEv’t
(
NOTIFY_ZSET
,

1604 
šü
 ? "zšü" : "zadd", 
key
, 
c
->
db
->
id
);

1606 
	}
}

1608 
	$zaddCommªd
(
ş›Á
 *
c
) {

1609 
	`zaddG’”icCommªd
(
c
,
ZADD_NONE
);

1610 
	}
}

1612 
	$zšübyCommªd
(
ş›Á
 *
c
) {

1613 
	`zaddG’”icCommªd
(
c
,
ZADD_INCR
);

1614 
	}
}

1616 
	$z»mCommªd
(
ş›Á
 *
c
) {

1617 
robj
 *
key
 = 
c
->
¬gv
[1];

1618 
robj
 *
zobj
;

1619 
d–‘ed
 = 0, 
key»moved
 = 0, 
j
;

1621 ià((
zobj
 = 
	`lookupKeyWr™eOrR•ly
(
c
,
key
,
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

1622 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) ;

1624 
j
 = 2; j < 
c
->
¬gc
; j++) {

1625 ià(
	`z£tD–
(
zobj
,
c
->
¬gv
[
j
]->
±r
)è
d–‘ed
++;

1626 ià(
	`z£tL’gth
(
zobj
) == 0) {

1627 
	`dbD–‘e
(
c
->
db
,
key
);

1628 
key»moved
 = 1;

1633 ià(
d–‘ed
) {

1634 
	`nÙifyKey¥aûEv’t
(
NOTIFY_ZSET
,"z»m",
key
,
c
->
db
->
id
);

1635 ià(
key»moved
)

1636 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
key
,
c
->
db
->
id
);

1637 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

1638 
£rv”
.
dœty
 +ğ
d–‘ed
;

1640 
	`addR•lyLÚgLÚg
(
c
,
d–‘ed
);

1641 
	}
}

1644 
	#ZRANGE_RANK
 0

	)

1645 
	#ZRANGE_SCORE
 1

	)

1646 
	#ZRANGE_LEX
 2

	)

1647 
	$z»m¿ngeG’”icCommªd
(
ş›Á
 *
c
, 
¿ng‘y³
) {

1648 
robj
 *
key
 = 
c
->
¬gv
[1];

1649 
robj
 *
zobj
;

1650 
key»moved
 = 0;

1651 
d–‘ed
 = 0;

1652 
z¿nge¥ec
 
¿nge
;

1653 
zËx¿nge¥ec
 
Ëx¿nge
;

1654 
¡¬t
, 
’d
, 
Î’
;

1657 ià(
¿ng‘y³
 =ğ
ZRANGE_RANK
) {

1658 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
¡¬t
,
NULL
è!ğ
C_OK
) ||

1659 (
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
’d
,
NULL
è!ğ
C_OK
))

1661 } ià(
¿ng‘y³
 =ğ
ZRANGE_SCORE
) {

1662 ià(
	`z¦P¬£Rªge
(
c
->
¬gv
[2],c->¬gv[3],&
¿nge
è!ğ
C_OK
) {

1663 
	`addR•lyE¼Ü
(
c
,"min or max is‚ot‡ float");

1666 } ià(
¿ng‘y³
 =ğ
ZRANGE_LEX
) {

1667 ià(
	`z¦P¬£LexRªge
(
c
->
¬gv
[2],c->¬gv[3],&
Ëx¿nge
è!ğ
C_OK
) {

1668 
	`addR•lyE¼Ü
(
c
,"min or max‚ot valid string„ange item");

1674 ià((
zobj
 = 
	`lookupKeyWr™eOrR•ly
(
c
,
key
,
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

1675 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)è
ş—nup
;

1677 ià(
¿ng‘y³
 =ğ
ZRANGE_RANK
) {

1679 
Î’
 = 
	`z£tL’gth
(
zobj
);

1680 ià(
¡¬t
 < 0è¡¬ˆğ
Î’
+start;

1681 ià(
’d
 < 0è’d = 
Î’
+end;

1682 ià(
¡¬t
 < 0) start = 0;

1686 ià(
¡¬t
 > 
’d
 || s¹ >ğ
Î’
) {

1687 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1688 
ş—nup
;

1690 ià(
’d
 >ğ
Î’
)ƒnd =†len-1;

1694 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1695 
¿ng‘y³
) {

1696 
ZRANGE_RANK
:

1697 
zobj
->
±r
 = 
	`zzlD–‘eRªgeByRªk
(zobj->±r,
¡¬t
+1,
’d
+1,&
d–‘ed
);

1699 
ZRANGE_SCORE
:

1700 
zobj
->
±r
 = 
	`zzlD–‘eRªgeByScÜe
(zobj->±r,&
¿nge
,&
d–‘ed
);

1702 
ZRANGE_LEX
:

1703 
zobj
->
±r
 = 
	`zzlD–‘eRªgeByLex
(zobj->±r,&
Ëx¿nge
,&
d–‘ed
);

1706 ià(
	`zzlL’gth
(
zobj
->
±r
) == 0) {

1707 
	`dbD–‘e
(
c
->
db
,
key
);

1708 
key»moved
 = 1;

1710 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1711 
z£t
 *
zs
 = 
zobj
->
±r
;

1712 
¿ng‘y³
) {

1713 
ZRANGE_RANK
:

1714 
d–‘ed
 = 
	`z¦D–‘eRªgeByRªk
(
zs
->
z¦
,
¡¬t
+1,
’d
+1,zs->
diù
);

1716 
ZRANGE_SCORE
:

1717 
d–‘ed
 = 
	`z¦D–‘eRªgeByScÜe
(
zs
->
z¦
,&
¿nge
,zs->
diù
);

1719 
ZRANGE_LEX
:

1720 
d–‘ed
 = 
	`z¦D–‘eRªgeByLex
(
zs
->
z¦
,&
Ëx¿nge
,zs->
diù
);

1723 ià(
	`htN“dsResize
(
zs
->
diù
)è
	`diùResize
(zs->dict);

1724 ià(
	`diùSize
(
zs
->
diù
) == 0) {

1725 
	`dbD–‘e
(
c
->
db
,
key
);

1726 
key»moved
 = 1;

1729 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1733 ià(
d–‘ed
) {

1734 *
ev’t
[3] = {"zremrangebyrank","zremrangebyscore","zremrangebylex"};

1735 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

1736 
	`nÙifyKey¥aûEv’t
(
NOTIFY_ZSET
,
ev’t
[
¿ng‘y³
],
key
,
c
->
db
->
id
);

1737 ià(
key»moved
)

1738 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
key
,
c
->
db
->
id
);

1740 
£rv”
.
dœty
 +ğ
d–‘ed
;

1741 
	`addR•lyLÚgLÚg
(
c
,
d–‘ed
);

1743 
ş—nup
:

1744 ià(
¿ng‘y³
 =ğ
ZRANGE_LEX
è
	`z¦F»eLexRªge
(&
Ëx¿nge
);

1745 
	}
}

1747 
	$z»m¿ngeby¿nkCommªd
(
ş›Á
 *
c
) {

1748 
	`z»m¿ngeG’”icCommªd
(
c
,
ZRANGE_RANK
);

1749 
	}
}

1751 
	$z»m¿ngebyscÜeCommªd
(
ş›Á
 *
c
) {

1752 
	`z»m¿ngeG’”icCommªd
(
c
,
ZRANGE_SCORE
);

1753 
	}
}

1755 
	$z»m¿ngebyËxCommªd
(
ş›Á
 *
c
) {

1756 
	`z»m¿ngeG’”icCommªd
(
c
,
ZRANGE_LEX
);

1757 
	}
}

1760 
robj
 *
	msubjeù
;

1761 
	mty³
;

1762 
	m’codšg
;

1763 
	mweight
;

1767 
	u_™”£t
 {

1769 
št£t
 *
	mis
;

1770 
	mii
;

1771 } 
	mis
;

1773 
diù
 *
	mdiù
;

1774 
diùI‹¿tÜ
 *
	mdi
;

1775 
diùEÁry
 *
	mde
;

1776 } 
	mht
;

1777 } 
	m£t
;

1780 
	u_™”z£t
 {

1782 *
	mzl
;

1783 *
	m•Œ
, *
	m¥Œ
;

1784 } 
	mzl
;

1786 
z£t
 *
	mzs
;

1787 
zskli¡Node
 *
	mnode
;

1788 } 
	m¦
;

1789 } 
	mz£t
;

1790 } 
	m™”
;

1791 } 
	tz£tİ¤c
;

1800 
	#OPVAL_DIRTY_SDS
 1

	)

1801 
	#OPVAL_DIRTY_LL
 2

	)

1802 
	#OPVAL_VALID_LL
 4

	)

1806 
	mæags
;

1807 
	m_buf
[32];

1808 
sds
 
	m–e
;

1809 *
	me¡r
;

1810 
	m–’
;

1811 
	m–l
;

1812 
	mscÜe
;

1813 } 
	tz£tİv®
;

1815 
_™”£t
 
	t™”£t
;

1816 
_™”z£t
 
	t™”z£t
;

1818 
	$zuiIn™I‹¿tÜ
(
z£tİ¤c
 *
İ
) {

1819 ià(
İ
->
subjeù
 =ğ
NULL
)

1822 ià(
İ
->
ty³
 =ğ
OBJ_SET
) {

1823 
™”£t
 *
™
 = &
İ
->
™”
.
£t
;

1824 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1825 
™
->
is
.i ğ
İ
->
subjeù
->
±r
;

1826 
™
->
is
.
ii
 = 0;

1827 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

1828 
™
->
ht
.
diù
 = 
İ
->
subjeù
->
±r
;

1829 
™
->
ht
.
di
 = 
	`diùG‘I‹¿tÜ
(
İ
->
subjeù
->
±r
);

1830 
™
->
ht
.
de
 = 
	`diùNext
(™->ht.
di
);

1832 
	`£rv”Pªic
("Unknown setƒncoding");

1834 } ià(
İ
->
ty³
 =ğ
OBJ_ZSET
) {

1835 
™”z£t
 *
™
 = &
İ
->
™”
.
z£t
;

1836 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1837 
™
->
zl
.zÈğ
İ
->
subjeù
->
±r
;

1838 
™
->
zl
.
•Œ
 = 
	`zli¡Index
(it->zl.zl,0);

1839 ià(
™
->
zl
.
•Œ
 !ğ
NULL
) {

1840 
™
->
zl
.
¥Œ
 = 
	`zli¡Next
(™->zl.zl,™->zl.
•Œ
);

1841 
	`£rv”As£¹
(
™
->
zl
.
¥Œ
 !ğ
NULL
);

1843 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1844 
™
->
¦
.
zs
 = 
İ
->
subjeù
->
±r
;

1845 
™
->
¦
.
node
 = it->¦.
zs
->
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

1847 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1850 
	`£rv”Pªic
("Unsupportedype");

1852 
	}
}

1854 
	$zuiCË¬I‹¿tÜ
(
z£tİ¤c
 *
İ
) {

1855 ià(
İ
->
subjeù
 =ğ
NULL
)

1858 ià(
İ
->
ty³
 =ğ
OBJ_SET
) {

1859 
™”£t
 *
™
 = &
İ
->
™”
.
£t
;

1860 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1861 
	`UNUSED
(
™
);

1862 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

1863 
	`diùR–—£I‹¿tÜ
(
™
->
ht
.
di
);

1865 
	`£rv”Pªic
("Unknown setƒncoding");

1867 } ià(
İ
->
ty³
 =ğ
OBJ_ZSET
) {

1868 
™”z£t
 *
™
 = &
İ
->
™”
.
z£t
;

1869 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1870 
	`UNUSED
(
™
);

1871 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1872 
	`UNUSED
(
™
);

1874 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1877 
	`£rv”Pªic
("Unsupportedype");

1879 
	}
}

1881 
	$zuiL’gth
(
z£tİ¤c
 *
İ
) {

1882 ià(
İ
->
subjeù
 =ğ
NULL
)

1885 ià(
İ
->
ty³
 =ğ
OBJ_SET
) {

1886 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1887  
	`št£tL’
(
İ
->
subjeù
->
±r
);

1888 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

1889 
diù
 *
ht
 = 
İ
->
subjeù
->
±r
;

1890  
	`diùSize
(
ht
);

1892 
	`£rv”Pªic
("Unknown setƒncoding");

1894 } ià(
İ
->
ty³
 =ğ
OBJ_ZSET
) {

1895 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1896  
	`zzlL’gth
(
İ
->
subjeù
->
±r
);

1897 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1898 
z£t
 *
zs
 = 
İ
->
subjeù
->
±r
;

1899  
zs
->
z¦
->
Ëngth
;

1901 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1904 
	`£rv”Pªic
("Unsupportedype");

1906 
	}
}

1911 
	$zuiNext
(
z£tİ¤c
 *
İ
, 
z£tİv®
 *
v®
) {

1912 ià(
İ
->
subjeù
 =ğ
NULL
)

1915 ià(
v®
->
æags
 & 
OPVAL_DIRTY_SDS
)

1916 
	`sdsä“
(
v®
->
–e
);

1918 
	`mem£t
(
v®
,0,(
z£tİv®
));

1920 ià(
İ
->
ty³
 =ğ
OBJ_SET
) {

1921 
™”£t
 *
™
 = &
İ
->
™”
.
£t
;

1922 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1923 
št64_t
 
–l
;

1925 ià(!
	`št£tG‘
(
™
->
is
.is,™->is.
ii
,&
–l
))

1927 
v®
->
–l
 =ƒll;

1928 
v®
->
scÜe
 = 1.0;

1931 
™
->
is
.
ii
++;

1932 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

1933 ià(
™
->
ht
.
de
 =ğ
NULL
)

1935 
v®
->
–e
 = 
	`diùG‘Key
(
™
->
ht
.
de
);

1936 
v®
->
scÜe
 = 1.0;

1939 
™
->
ht
.
de
 = 
	`diùNext
(™->ht.
di
);

1941 
	`£rv”Pªic
("Unknown setƒncoding");

1943 } ià(
İ
->
ty³
 =ğ
OBJ_ZSET
) {

1944 
™”z£t
 *
™
 = &
İ
->
™”
.
z£t
;

1945 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1947 ià(
™
->
zl
.
•Œ
 =ğ
NULL
 || it->zl.
¥Œ
 == NULL)

1949 
	`£rv”As£¹
(
	`zli¡G‘
(
™
->
zl
.
•Œ
,&
v®
->
e¡r
,&v®->
–’
,&v®->
–l
));

1950 
v®
->
scÜe
 = 
	`zzlG‘ScÜe
(
™
->
zl
.
¥Œ
);

1953 
	`zzlNext
(
™
->
zl
.zl,&™->zl.
•Œ
,&™->zl.
¥Œ
);

1954 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1955 ià(
™
->
¦
.
node
 =ğ
NULL
)

1957 
v®
->
–e
 = 
™
->
¦
.
node
->ele;

1958 
v®
->
scÜe
 = 
™
->
¦
.
node
->score;

1961 
™
->
¦
.
node
 = it->¦.node->
Ëv–
[0].
fÜw¬d
;

1963 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1966 
	`£rv”Pªic
("Unsupportedype");

1969 
	}
}

1971 
	$zuiLÚgLÚgFromV®ue
(
z£tİv®
 *
v®
) {

1972 ià(!(
v®
->
æags
 & 
OPVAL_DIRTY_LL
)) {

1973 
v®
->
æags
 |ğ
OPVAL_DIRTY_LL
;

1975 ià(
v®
->
–e
 !ğ
NULL
) {

1976 ià(
	`¡ršg2Î
(
v®
->
–e
,
	`sd¦’
(v®->–e),&v®->
–l
))

1977 
v®
->
æags
 |ğ
OPVAL_VALID_LL
;

1978 } ià(
v®
->
e¡r
 !ğ
NULL
) {

1979 ià(
	`¡ršg2Î
((*)
v®
->
e¡r
,v®->
–’
,&v®->
–l
))

1980 
v®
->
æags
 |ğ
OPVAL_VALID_LL
;

1983 
v®
->
æags
 |ğ
OPVAL_VALID_LL
;

1986  
v®
->
æags
 & 
OPVAL_VALID_LL
;

1987 
	}
}

1989 
sds
 
	$zuiSdsFromV®ue
(
z£tİv®
 *
v®
) {

1990 ià(
v®
->
–e
 =ğ
NULL
) {

1991 ià(
v®
->
e¡r
 !ğ
NULL
) {

1992 
v®
->
–e
 = 
	`sd¢ewËn
((*)v®->
e¡r
,v®->
–’
);

1994 
v®
->
–e
 = 
	`sdsäomlÚglÚg
(v®->
–l
);

1996 
v®
->
æags
 |ğ
OPVAL_DIRTY_SDS
;

1998  
v®
->
–e
;

1999 
	}
}

2003 
sds
 
	$zuiNewSdsFromV®ue
(
z£tİv®
 *
v®
) {

2004 ià(
v®
->
æags
 & 
OPVAL_DIRTY_SDS
) {

2006 
sds
 
–e
 = 
v®
->ele;

2007 
v®
->
æags
 &ğ~
OPVAL_DIRTY_SDS
;

2008 
v®
->
–e
 = 
NULL
;

2009  
–e
;

2010 } ià(
v®
->
–e
) {

2011  
	`sdsdup
(
v®
->
–e
);

2012 } ià(
v®
->
e¡r
) {

2013  
	`sd¢ewËn
((*)
v®
->
e¡r
,v®->
–’
);

2015  
	`sdsäomlÚglÚg
(
v®
->
–l
);

2017 
	}
}

2019 
	$zuiBufãrFromV®ue
(
z£tİv®
 *
v®
) {

2020 ià(
v®
->
e¡r
 =ğ
NULL
) {

2021 ià(
v®
->
–e
 !ğ
NULL
) {

2022 
v®
->
–’
 = 
	`sd¦’
(v®->
–e
);

2023 
v®
->
e¡r
 = (*)v®->
–e
;

2025 
v®
->
–’
 = 
	`Î2¡ršg
((*)v®->
_buf
,(v®->_buf),v®->
–l
);

2026 
v®
->
e¡r
 = v®->
_buf
;

2030 
	}
}

2034 
	$zuiFšd
(
z£tİ¤c
 *
İ
, 
z£tİv®
 *
v®
, *
scÜe
) {

2035 ià(
İ
->
subjeù
 =ğ
NULL
)

2038 ià(
İ
->
ty³
 =ğ
OBJ_SET
) {

2039 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

2040 ià(
	`zuiLÚgLÚgFromV®ue
(
v®
) &&

2041 
	`št£tFšd
(
İ
->
subjeù
->
±r
,
v®
->
–l
))

2043 *
scÜe
 = 1.0;

2048 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

2049 
diù
 *
ht
 = 
İ
->
subjeù
->
±r
;

2050 
	`zuiSdsFromV®ue
(
v®
);

2051 ià(
	`diùFšd
(
ht
,
v®
->
–e
è!ğ
NULL
) {

2052 *
scÜe
 = 1.0;

2058 
	`£rv”Pªic
("Unknown setƒncoding");

2060 } ià(
İ
->
ty³
 =ğ
OBJ_ZSET
) {

2061 
	`zuiSdsFromV®ue
(
v®
);

2063 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2064 ià(
	`zzlFšd
(
İ
->
subjeù
->
±r
,
v®
->
–e
,
scÜe
è!ğ
NULL
) {

2070 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2071 
z£t
 *
zs
 = 
İ
->
subjeù
->
±r
;

2072 
diùEÁry
 *
de
;

2073 ià((
de
 = 
	`diùFšd
(
zs
->
diù
,
v®
->
–e
)è!ğ
NULL
) {

2074 *
scÜe
 = *(*)
	`diùG‘V®
(
de
);

2080 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2083 
	`£rv”Pªic
("Unsupportedype");

2085 
	}
}

2087 
	$zuiCom·»ByC¬dš®™y
(cÚ¡ *
s1
, cÚ¡ *
s2
) {

2088  
	`zuiL’gth
((
z£tİ¤c
*)
s1
è- zuiL’gth((z£tİ¤c*)
s2
);

2089 
	}
}

2091 
	#REDIS_AGGR_SUM
 1

	)

2092 
	#REDIS_AGGR_MIN
 2

	)

2093 
	#REDIS_AGGR_MAX
 3

	)

2094 
	#zuniÚIÁ”DiùV®ue
(
_e
è(
	`diùG‘V®
(_eè=ğ
NULL
 ? 1.0 : *(*)diùG‘V®(_e))

	)

2096 
šlše
 
	$zuniÚIÁ”Agg»g©e
(*
rg‘
, 
v®
, 
agg»g©e
) {

2097 ià(
agg»g©e
 =ğ
REDIS_AGGR_SUM
) {

2098 *
rg‘
 = *rg‘ + 
v®
;

2102 ià(
	`i¢ª
(*
rg‘
)) *target = 0.0;

2103 } ià(
agg»g©e
 =ğ
REDIS_AGGR_MIN
) {

2104 *
rg‘
 = 
v®
 < *target ? val : *target;

2105 } ià(
agg»g©e
 =ğ
REDIS_AGGR_MAX
) {

2106 *
rg‘
 = 
v®
 > *target ? val : *target;

2109 
	`£rv”Pªic
("Unknown ZUNION/INTER‡ggregateype");

2111 
	}
}

2113 
ušt64_t
 
diùSdsHash
(cÚ¡ *
key
);

2114 
diùSdsKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
);

2116 
diùTy³
 
	g£tAccumuÏtÜDiùTy³
 = {

2117 
diùSdsHash
,

2118 
NULL
,

2119 
NULL
,

2120 
diùSdsKeyCom·»
,

2121 
NULL
,

2122 
NULL


2125 
	$zuniÚIÁ”G’”icCommªd
(
ş›Á
 *
c
, 
robj
 *
d¡key
, 
İ
) {

2126 
i
, 
j
;

2127 
£Šum
;

2128 
agg»g©e
 = 
REDIS_AGGR_SUM
;

2129 
z£tİ¤c
 *
¤c
;

2130 
z£tİv®
 
zv®
;

2131 
sds
 
tmp
;

2132 
max––’
 = 0;

2133 
robj
 *
d¡obj
;

2134 
z£t
 *
d¡z£t
;

2135 
zskli¡Node
 *
znode
;

2136 
touched
 = 0;

2139 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
£Šum
, 
NULL
è!ğ
C_OK
))

2142 ià(
£Šum
 < 1) {

2143 
	`addR•lyE¼Ü
(
c
,

2149 ià(
£Šum
 > 
c
->
¬gc
-3) {

2150 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2155 
¤c
 = 
	`zÿÎoc
((
z£tİ¤c
è* 
£Šum
);

2156 
i
 = 0, 
j
 = 3; i < 
£Šum
; i++, j++) {

2157 
robj
 *
obj
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[
j
]);

2158 ià(
obj
 !ğ
NULL
) {

2159 ià(
obj
->
ty³
 !ğ
OBJ_ZSET
 && obj->ty³ !ğ
OBJ_SET
) {

2160 
	`zä“
(
¤c
);

2161 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

2165 
¤c
[
i
].
subjeù
 = 
obj
;

2166 
¤c
[
i
].
ty³
 = 
obj
->type;

2167 
¤c
[
i
].
’codšg
 = 
obj
->encoding;

2169 
¤c
[
i
].
subjeù
 = 
NULL
;

2173 
¤c
[
i
].
weight
 = 1.0;

2177 ià(
j
 < 
c
->
¬gc
) {

2178 
»maššg
 = 
c
->
¬gc
 - 
j
;

2180 
»maššg
) {

2181 ià(
»maššg
 >ğ(
£Šum
 + 1) &&

2182 !
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"weights"))

2184 
j
++; 
»maššg
--;

2185 
i
 = 0; i < 
£Šum
; i++, 
j
++, 
»maššg
--) {

2186 ià(
	`g‘DoubËFromObjeùOrR•ly
(
c
,c->
¬gv
[
j
],&
¤c
[
i
].
weight
,

2187 "weighˆv®ui nÙ‡ flßt"è!ğ
C_OK
)

2189 
	`zä“
(
¤c
);

2193 } ià(
»maššg
 >= 2 &&

2194 !
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"aggregate"))

2196 
j
++; 
»maššg
--;

2197 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"sum")) {

2198 
agg»g©e
 = 
REDIS_AGGR_SUM
;

2199 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"min")) {

2200 
agg»g©e
 = 
REDIS_AGGR_MIN
;

2201 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"max")) {

2202 
agg»g©e
 = 
REDIS_AGGR_MAX
;

2204 
	`zä“
(
¤c
);

2205 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2208 
j
++; 
»maššg
--;

2210 
	`zä“
(
¤c
);

2211 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2219 
	`qsÜt
(
¤c
,
£Šum
,(
z£tİ¤c
),
zuiCom·»ByC¬dš®™y
);

2221 
d¡obj
 = 
	`ü—‹Z£tObjeù
();

2222 
d¡z£t
 = 
d¡obj
->
±r
;

2223 
	`mem£t
(&
zv®
, 0, (zval));

2225 ià(
İ
 =ğ
SET_OP_INTER
) {

2227 ià(
	`zuiL’gth
(&
¤c
[0]) > 0) {

2230 
	`zuiIn™I‹¿tÜ
(&
¤c
[0]);

2231 
	`zuiNext
(&
¤c
[0],&
zv®
)) {

2232 
scÜe
, 
v®ue
;

2234 
scÜe
 = 
¤c
[0].
weight
 * 
zv®
.score;

2235 ià(
	`i¢ª
(
scÜe
)) score = 0;

2237 
j
 = 1; j < 
£Šum
; j++) {

2240 ià(
¤c
[
j
].
subjeù
 == src[0].subject) {

2241 
v®ue
 = 
zv®
.
scÜe
*
¤c
[
j
].
weight
;

2242 
	`zuniÚIÁ”Agg»g©e
(&
scÜe
,
v®ue
,
agg»g©e
);

2243 } ià(
	`zuiFšd
(&
¤c
[
j
],&
zv®
,&
v®ue
)) {

2244 
v®ue
 *ğ
¤c
[
j
].
weight
;

2245 
	`zuniÚIÁ”Agg»g©e
(&
scÜe
,
v®ue
,
agg»g©e
);

2252 ià(
j
 =ğ
£Šum
) {

2253 
tmp
 = 
	`zuiNewSdsFromV®ue
(&
zv®
);

2254 
znode
 = 
	`z¦In£¹
(
d¡z£t
->
z¦
,
scÜe
,
tmp
);

2255 
	`diùAdd
(
d¡z£t
->
diù
,
tmp
,&
znode
->
scÜe
);

2256 ià(
	`sd¦’
(
tmp
è> 
max––’
) maxelelen = sdslen(tmp);

2259 
	`zuiCË¬I‹¿tÜ
(&
¤c
[0]);

2261 } ià(
İ
 =ğ
SET_OP_UNION
) {

2262 
diù
 *
accumuÏtÜ
 = 
	`diùC»©e
(&
£tAccumuÏtÜDiùTy³
,
NULL
);

2263 
diùI‹¿tÜ
 *
di
;

2264 
diùEÁry
 *
de
, *
exi¡šg
;

2265 
scÜe
;

2267 ià(
£Šum
) {

2270 
	`diùEx·nd
(
accumuÏtÜ
,
	`zuiL’gth
(&
¤c
[
£Šum
-1]));

2275 
i
 = 0; i < 
£Šum
; i++) {

2276 ià(
	`zuiL’gth
(&
¤c
[
i
]) == 0) ;

2278 
	`zuiIn™I‹¿tÜ
(&
¤c
[
i
]);

2279 
	`zuiNext
(&
¤c
[
i
],&
zv®
)) {

2281 
scÜe
 = 
¤c
[
i
].
weight
 * 
zv®
.score;

2282 ià(
	`i¢ª
(
scÜe
)) score = 0;

2285 
de
 = 
	`diùAddRaw
(
accumuÏtÜ
,
	`zuiSdsFromV®ue
(&
zv®
),&
exi¡šg
);

2287 ià(!
exi¡šg
) {

2288 
tmp
 = 
	`zuiNewSdsFromV®ue
(&
zv®
);

2292 ià(
	`sd¦’
(
tmp
è> 
max––’
) maxelelen = sdslen(tmp);

2294 
	`diùS‘Key
(
accumuÏtÜ
, 
de
, 
tmp
);

2295 
	`diùS‘DoubËV®
(
de
,
scÜe
);

2303 
	`zuniÚIÁ”Agg»g©e
(&
exi¡šg
->
v
.
d
,
scÜe
,
agg»g©e
);

2306 
	`zuiCË¬I‹¿tÜ
(&
¤c
[
i
]);

2310 
di
 = 
	`diùG‘I‹¿tÜ
(
accumuÏtÜ
);

2315 
	`diùEx·nd
(
d¡z£t
->
diù
,
	`diùSize
(
accumuÏtÜ
));

2317 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2318 
sds
 
–e
 = 
	`diùG‘Key
(
de
);

2319 
scÜe
 = 
	`diùG‘DoubËV®
(
de
);

2320 
znode
 = 
	`z¦In£¹
(
d¡z£t
->
z¦
,
scÜe
,
–e
);

2321 
	`diùAdd
(
d¡z£t
->
diù
,
–e
,&
znode
->
scÜe
);

2323 
	`diùR–—£I‹¿tÜ
(
di
);

2324 
	`diùR–—£
(
accumuÏtÜ
);

2326 
	`£rv”Pªic
("Unknown operator");

2329 ià(
	`dbD–‘e
(
c
->
db
,
d¡key
))

2330 
touched
 = 1;

2331 ià(
d¡z£t
->
z¦
->
Ëngth
) {

2332 
	`z£tCÚv”tToZli¡IfN“ded
(
d¡obj
,
max––’
);

2333 
	`dbAdd
(
c
->
db
,
d¡key
,
d¡obj
);

2334 
	`addR•lyLÚgLÚg
(
c
,
	`z£tL’gth
(
d¡obj
));

2335 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

2336 
	`nÙifyKey¥aûEv’t
(
NOTIFY_ZSET
,

2337 (
İ
 =ğ
SET_OP_UNION
) ? "zunionstore" : "zinterstore",

2338 
d¡key
,
c
->
db
->
id
);

2339 
£rv”
.
dœty
++;

2341 
	`deüRefCouÁ
(
d¡obj
);

2342 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

2343 ià(
touched
) {

2344 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

2345 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
d¡key
,
c
->
db
->
id
);

2346 
£rv”
.
dœty
++;

2349 
	`zä“
(
¤c
);

2350 
	}
}

2352 
	$zuniÚ¡ÜeCommªd
(
ş›Á
 *
c
) {

2353 
	`zuniÚIÁ”G’”icCommªd
(
c
,c->
¬gv
[1], 
SET_OP_UNION
);

2354 
	}
}

2356 
	$zš‹r¡ÜeCommªd
(
ş›Á
 *
c
) {

2357 
	`zuniÚIÁ”G’”icCommªd
(
c
,c->
¬gv
[1], 
SET_OP_INTER
);

2358 
	}
}

2360 
	$z¿ngeG’”icCommªd
(
ş›Á
 *
c
, 
»v”£
) {

2361 
robj
 *
key
 = 
c
->
¬gv
[1];

2362 
robj
 *
zobj
;

2363 
w™hscÜes
 = 0;

2364 
¡¬t
;

2365 
’d
;

2366 
Î’
;

2367 
¿ng–’
;

2369 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
¡¬t
, 
NULL
è!ğ
C_OK
) ||

2370 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[3], &
’d
, 
NULL
è!ğ
C_OK
)) ;

2372 ià(
c
->
¬gc
 =ğ5 && !
	`¡rÿ£cmp
(c->
¬gv
[4]->
±r
,"withscores")) {

2373 
w™hscÜes
 = 1;

2374 } ià(
c
->
¬gc
 >= 5) {

2375 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2379 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL


2380 || 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) ;

2383 
Î’
 = 
	`z£tL’gth
(
zobj
);

2384 ià(
¡¬t
 < 0è¡¬ˆğ
Î’
+start;

2385 ià(
’d
 < 0è’d = 
Î’
+end;

2386 ià(
¡¬t
 < 0) start = 0;

2390 ià(
¡¬t
 > 
’d
 || s¹ >ğ
Î’
) {

2391 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

2394 ià(
’d
 >ğ
Î’
)ƒnd =†len-1;

2395 
¿ng–’
 = (
’d
-
¡¬t
)+1;

2398 
	`addR•lyMuÉiBulkL’
(
c
, 
w™hscÜes
 ? (
¿ng–’
*2) :„angelen);

2400 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2401 *
zl
 = 
zobj
->
±r
;

2402 *
•Œ
, *
¥Œ
;

2403 *
v¡r
;

2404 
vËn
;

2405 
vlÚg
;

2407 ià(
»v”£
)

2408 
•Œ
 = 
	`zli¡Index
(
zl
,-2-(2*
¡¬t
));

2410 
•Œ
 = 
	`zli¡Index
(
zl
,2*
¡¬t
);

2412 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
•Œ
 !ğ
NULL
);

2413 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2415 
¿ng–’
--) {

2416 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
•Œ
 !ğ
NULL
 && 
¥Œ
 != NULL);

2417 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

2418 ià(
v¡r
 =ğ
NULL
)

2419 
	`addR•lyBulkLÚgLÚg
(
c
,
vlÚg
);

2421 
	`addR•lyBulkCBufãr
(
c
,
v¡r
,
vËn
);

2423 ià(
w™hscÜes
)

2424 
	`addR•lyDoubË
(
c
,
	`zzlG‘ScÜe
(
¥Œ
));

2426 ià(
»v”£
)

2427 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2429 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2432 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2433 
z£t
 *
zs
 = 
zobj
->
±r
;

2434 
zskli¡
 *
z¦
 = 
zs
->zsl;

2435 
zskli¡Node
 *
Ê
;

2436 
sds
 
–e
;

2439 ià(
»v”£
) {

2440 
Ê
 = 
z¦
->

;

2441 ià(
¡¬t
 > 0)

2442 
Ê
 = 
	`z¦G‘EËm’tByRªk
(
z¦
,
Î’
-
¡¬t
);

2444 
Ê
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

2445 ià(
¡¬t
 > 0)

2446 
Ê
 = 
	`z¦G‘EËm’tByRªk
(
z¦
,
¡¬t
+1);

2449 
¿ng–’
--) {

2450 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
Ê
 !ğ
NULL
);

2451 
–e
 = 
Ê
->ele;

2452 
	`addR•lyBulkCBufãr
(
c
,
–e
,
	`sd¦’
(ele));

2453 ià(
w™hscÜes
)

2454 
	`addR•lyDoubË
(
c
,
Ê
->
scÜe
);

2455 
Ê
 = 
»v”£
 ?†n->
backw¬d
 :†n->
Ëv–
[0].
fÜw¬d
;

2458 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2460 
	}
}

2462 
	$z¿ngeCommªd
(
ş›Á
 *
c
) {

2463 
	`z¿ngeG’”icCommªd
(
c
,0);

2464 
	}
}

2466 
	$z»v¿ngeCommªd
(
ş›Á
 *
c
) {

2467 
	`z¿ngeG’”icCommªd
(
c
,1);

2468 
	}
}

2471 
	$g’”icZ¿ngebyscÜeCommªd
(
ş›Á
 *
c
, 
»v”£
) {

2472 
z¿nge¥ec
 
¿nge
;

2473 
robj
 *
key
 = 
c
->
¬gv
[1];

2474 
robj
 *
zobj
;

2475 
off£t
 = 0, 
lim™
 = -1;

2476 
w™hscÜes
 = 0;

2477 
¿ng–’
 = 0;

2478 *
»¶yËn
 = 
NULL
;

2479 
mšidx
, 
maxidx
;

2482 ià(
»v”£
) {

2484 
maxidx
 = 2; 
mšidx
 = 3;

2487 
mšidx
 = 2; 
maxidx
 = 3;

2490 ià(
	`z¦P¬£Rªge
(
c
->
¬gv
[
mšidx
],c->¬gv[
maxidx
],&
¿nge
è!ğ
C_OK
) {

2491 
	`addR•lyE¼Ü
(
c
,"min or max is‚ot‡ float");

2497 ià(
c
->
¬gc
 > 4) {

2498 
»maššg
 = 
c
->
¬gc
 - 4;

2499 
pos
 = 4;

2501 
»maššg
) {

2502 ià(
»maššg
 >ğ1 && !
	`¡rÿ£cmp
(
c
->
¬gv
[
pos
]->
±r
,"withscores")) {

2503 
pos
++; 
»maššg
--;

2504 
w™hscÜes
 = 1;

2505 } ià(
»maššg
 >ğ3 && !
	`¡rÿ£cmp
(
c
->
¬gv
[
pos
]->
±r
,"limit")) {

2506 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
pos
+1], &
off£t
, 
NULL
)

2507 !ğ
C_OK
) ||

2508 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
pos
+2], &
lim™
, 
NULL
)

2509 !ğ
C_OK
))

2513 
pos
 +ğ3; 
»maššg
 -= 3;

2515 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2522 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL
 ||

2523 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) ;

2525 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2526 *
zl
 = 
zobj
->
±r
;

2527 *
•Œ
, *
¥Œ
;

2528 *
v¡r
;

2529 
vËn
;

2530 
vlÚg
;

2531 
scÜe
;

2534 ià(
»v”£
) {

2535 
•Œ
 = 
	`zzlLa¡InRªge
(
zl
,&
¿nge
);

2537 
•Œ
 = 
	`zzlFœ¡InRªge
(
zl
,&
¿nge
);

2541 ià(
•Œ
 =ğ
NULL
) {

2542 
	`addR•ly
(
c
, 
sh¬ed
.
em±ymuÉibulk
);

2547 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
•Œ
 !ğ
NULL
);

2548 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2553 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2557 
•Œ
 && 
off£t
--) {

2558 ià(
»v”£
) {

2559 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2561 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2565 
•Œ
 && 
lim™
--) {

2566 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

2569 ià(
»v”£
) {

2570 ià(!
	`z¦V®ueG‹Mš
(
scÜe
,&
¿nge
)) ;

2572 ià(!
	`z¦V®ueL‹Max
(
scÜe
,&
¿nge
)) ;

2576 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

2578 
¿ng–’
++;

2579 ià(
v¡r
 =ğ
NULL
) {

2580 
	`addR•lyBulkLÚgLÚg
(
c
,
vlÚg
);

2582 
	`addR•lyBulkCBufãr
(
c
,
v¡r
,
vËn
);

2585 ià(
w™hscÜes
) {

2586 
	`addR•lyDoubË
(
c
,
scÜe
);

2590 ià(
»v”£
) {

2591 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2593 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2596 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2597 
z£t
 *
zs
 = 
zobj
->
±r
;

2598 
zskli¡
 *
z¦
 = 
zs
->zsl;

2599 
zskli¡Node
 *
Ê
;

2602 ià(
»v”£
) {

2603 
Ê
 = 
	`z¦La¡InRªge
(
z¦
,&
¿nge
);

2605 
Ê
 = 
	`z¦Fœ¡InRªge
(
z¦
,&
¿nge
);

2609 ià(
Ê
 =ğ
NULL
) {

2610 
	`addR•ly
(
c
, 
sh¬ed
.
em±ymuÉibulk
);

2617 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2621 
Ê
 && 
off£t
--) {

2622 ià(
»v”£
) {

2623 
Ê
 =†n->
backw¬d
;

2625 
Ê
 =†n->
Ëv–
[0].
fÜw¬d
;

2629 
Ê
 && 
lim™
--) {

2631 ià(
»v”£
) {

2632 ià(!
	`z¦V®ueG‹Mš
(
Ê
->
scÜe
,&
¿nge
)) ;

2634 ià(!
	`z¦V®ueL‹Max
(
Ê
->
scÜe
,&
¿nge
)) ;

2637 
¿ng–’
++;

2638 
	`addR•lyBulkCBufãr
(
c
,
Ê
->
–e
,
	`sd¦’
(ln->ele));

2640 ià(
w™hscÜes
) {

2641 
	`addR•lyDoubË
(
c
,
Ê
->
scÜe
);

2645 ià(
»v”£
) {

2646 
Ê
 =†n->
backw¬d
;

2648 
Ê
 =†n->
Ëv–
[0].
fÜw¬d
;

2652 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2655 ià(
w™hscÜes
) {

2656 
¿ng–’
 *= 2;

2659 
	`£tDeã¼edMuÉiBulkL’gth
(
c
, 
»¶yËn
, 
¿ng–’
);

2660 
	}
}

2662 
	$z¿ngebyscÜeCommªd
(
ş›Á
 *
c
) {

2663 
	`g’”icZ¿ngebyscÜeCommªd
(
c
,0);

2664 
	}
}

2666 
	$z»v¿ngebyscÜeCommªd
(
ş›Á
 *
c
) {

2667 
	`g’”icZ¿ngebyscÜeCommªd
(
c
,1);

2668 
	}
}

2670 
	$zcouÁCommªd
(
ş›Á
 *
c
) {

2671 
robj
 *
key
 = 
c
->
¬gv
[1];

2672 
robj
 *
zobj
;

2673 
z¿nge¥ec
 
¿nge
;

2674 
couÁ
 = 0;

2677 ià(
	`z¦P¬£Rªge
(
c
->
¬gv
[2],c->¬gv[3],&
¿nge
è!ğ
C_OK
) {

2678 
	`addR•lyE¼Ü
(
c
,"min or max is‚ot‡ float");

2683 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
, 
key
, 
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

2684 
	`checkTy³
(
c
, 
zobj
, 
OBJ_ZSET
)) ;

2686 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2687 *
zl
 = 
zobj
->
±r
;

2688 *
•Œ
, *
¥Œ
;

2689 
scÜe
;

2692 
•Œ
 = 
	`zzlFœ¡InRªge
(
zl
,&
¿nge
);

2695 ià(
•Œ
 =ğ
NULL
) {

2696 
	`addR•ly
(
c
, 
sh¬ed
.
cz”o
);

2701 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2702 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

2703 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
	`z¦V®ueL‹Max
(
scÜe
,&
¿nge
));

2706 
•Œ
) {

2707 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

2710 ià(!
	`z¦V®ueL‹Max
(
scÜe
,&
¿nge
)) {

2713 
couÁ
++;

2714 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2717 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2718 
z£t
 *
zs
 = 
zobj
->
±r
;

2719 
zskli¡
 *
z¦
 = 
zs
->zsl;

2720 
zskli¡Node
 *
zn
;

2721 
¿nk
;

2724 
zn
 = 
	`z¦Fœ¡InRªge
(
z¦
, &
¿nge
);

2727 ià(
zn
 !ğ
NULL
) {

2728 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
, 
zn
->
scÜe
, zn->
–e
);

2729 
couÁ
 = (
z¦
->
Ëngth
 - (
¿nk
 - 1));

2732 
zn
 = 
	`z¦La¡InRªge
(
z¦
, &
¿nge
);

2735 ià(
zn
 !ğ
NULL
) {

2736 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
, 
zn
->
scÜe
, zn->
–e
);

2737 
couÁ
 -ğ(
z¦
->
Ëngth
 - 
¿nk
);

2741 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2744 
	`addR•lyLÚgLÚg
(
c
, 
couÁ
);

2745 
	}
}

2747 
	$zËxcouÁCommªd
(
ş›Á
 *
c
) {

2748 
robj
 *
key
 = 
c
->
¬gv
[1];

2749 
robj
 *
zobj
;

2750 
zËx¿nge¥ec
 
¿nge
;

2751 
couÁ
 = 0;

2754 ià(
	`z¦P¬£LexRªge
(
c
->
¬gv
[2],c->¬gv[3],&
¿nge
è!ğ
C_OK
) {

2755 
	`addR•lyE¼Ü
(
c
,"min or max‚ot valid string„ange item");

2760 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
, 
key
, 
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

2761 
	`checkTy³
(
c
, 
zobj
, 
OBJ_ZSET
))

2763 
	`z¦F»eLexRªge
(&
¿nge
);

2767 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2768 *
zl
 = 
zobj
->
±r
;

2769 *
•Œ
, *
¥Œ
;

2772 
•Œ
 = 
	`zzlFœ¡InLexRªge
(
zl
,&
¿nge
);

2775 ià(
•Œ
 =ğ
NULL
) {

2776 
	`z¦F»eLexRªge
(&
¿nge
);

2777 
	`addR•ly
(
c
, 
sh¬ed
.
cz”o
);

2782 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2783 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
	`zzlLexV®ueL‹Max
(
•Œ
,&
¿nge
));

2786 
•Œ
) {

2788 ià(!
	`zzlLexV®ueL‹Max
(
•Œ
,&
¿nge
)) {

2791 
couÁ
++;

2792 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2795 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2796 
z£t
 *
zs
 = 
zobj
->
±r
;

2797 
zskli¡
 *
z¦
 = 
zs
->zsl;

2798 
zskli¡Node
 *
zn
;

2799 
¿nk
;

2802 
zn
 = 
	`z¦Fœ¡InLexRªge
(
z¦
, &
¿nge
);

2805 ià(
zn
 !ğ
NULL
) {

2806 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
, 
zn
->
scÜe
, zn->
–e
);

2807 
couÁ
 = (
z¦
->
Ëngth
 - (
¿nk
 - 1));

2810 
zn
 = 
	`z¦La¡InLexRªge
(
z¦
, &
¿nge
);

2813 ià(
zn
 !ğ
NULL
) {

2814 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
, 
zn
->
scÜe
, zn->
–e
);

2815 
couÁ
 -ğ(
z¦
->
Ëngth
 - 
¿nk
);

2819 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2822 
	`z¦F»eLexRªge
(&
¿nge
);

2823 
	`addR•lyLÚgLÚg
(
c
, 
couÁ
);

2824 
	}
}

2827 
	$g’”icZ¿ngebyËxCommªd
(
ş›Á
 *
c
, 
»v”£
) {

2828 
zËx¿nge¥ec
 
¿nge
;

2829 
robj
 *
key
 = 
c
->
¬gv
[1];

2830 
robj
 *
zobj
;

2831 
off£t
 = 0, 
lim™
 = -1;

2832 
¿ng–’
 = 0;

2833 *
»¶yËn
 = 
NULL
;

2834 
mšidx
, 
maxidx
;

2837 ià(
»v”£
) {

2839 
maxidx
 = 2; 
mšidx
 = 3;

2842 
mšidx
 = 2; 
maxidx
 = 3;

2845 ià(
	`z¦P¬£LexRªge
(
c
->
¬gv
[
mšidx
],c->¬gv[
maxidx
],&
¿nge
è!ğ
C_OK
) {

2846 
	`addR•lyE¼Ü
(
c
,"min or max‚ot valid string„ange item");

2852 ià(
c
->
¬gc
 > 4) {

2853 
»maššg
 = 
c
->
¬gc
 - 4;

2854 
pos
 = 4;

2856 
»maššg
) {

2857 ià(
»maššg
 >ğ3 && !
	`¡rÿ£cmp
(
c
->
¬gv
[
pos
]->
±r
,"limit")) {

2858 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
pos
+1], &
off£t
, 
NULL
è!ğ
C_OK
) ||

2859 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
pos
+2], &
lim™
, 
NULL
è!ğ
C_OK
)) ;

2860 
pos
 +ğ3; 
»maššg
 -= 3;

2862 
	`z¦F»eLexRªge
(&
¿nge
);

2863 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2870 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL
 ||

2871 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
))

2873 
	`z¦F»eLexRªge
(&
¿nge
);

2877 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2878 *
zl
 = 
zobj
->
±r
;

2879 *
•Œ
, *
¥Œ
;

2880 *
v¡r
;

2881 
vËn
;

2882 
vlÚg
;

2885 ià(
»v”£
) {

2886 
•Œ
 = 
	`zzlLa¡InLexRªge
(
zl
,&
¿nge
);

2888 
•Œ
 = 
	`zzlFœ¡InLexRªge
(
zl
,&
¿nge
);

2892 ià(
•Œ
 =ğ
NULL
) {

2893 
	`addR•ly
(
c
, 
sh¬ed
.
em±ymuÉibulk
);

2894 
	`z¦F»eLexRªge
(&
¿nge
);

2899 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
•Œ
 !ğ
NULL
);

2900 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2905 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2909 
•Œ
 && 
off£t
--) {

2910 ià(
»v”£
) {

2911 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2913 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2917 
•Œ
 && 
lim™
--) {

2919 ià(
»v”£
) {

2920 ià(!
	`zzlLexV®ueG‹Mš
(
•Œ
,&
¿nge
)) ;

2922 ià(!
	`zzlLexV®ueL‹Max
(
•Œ
,&
¿nge
)) ;

2927 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

2929 
¿ng–’
++;

2930 ià(
v¡r
 =ğ
NULL
) {

2931 
	`addR•lyBulkLÚgLÚg
(
c
,
vlÚg
);

2933 
	`addR•lyBulkCBufãr
(
c
,
v¡r
,
vËn
);

2937 ià(
»v”£
) {

2938 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2940 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2943 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2944 
z£t
 *
zs
 = 
zobj
->
±r
;

2945 
zskli¡
 *
z¦
 = 
zs
->zsl;

2946 
zskli¡Node
 *
Ê
;

2949 ià(
»v”£
) {

2950 
Ê
 = 
	`z¦La¡InLexRªge
(
z¦
,&
¿nge
);

2952 
Ê
 = 
	`z¦Fœ¡InLexRªge
(
z¦
,&
¿nge
);

2956 ià(
Ê
 =ğ
NULL
) {

2957 
	`addR•ly
(
c
, 
sh¬ed
.
em±ymuÉibulk
);

2958 
	`z¦F»eLexRªge
(&
¿nge
);

2965 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2969 
Ê
 && 
off£t
--) {

2970 ià(
»v”£
) {

2971 
Ê
 =†n->
backw¬d
;

2973 
Ê
 =†n->
Ëv–
[0].
fÜw¬d
;

2977 
Ê
 && 
lim™
--) {

2979 ià(
»v”£
) {

2980 ià(!
	`z¦LexV®ueG‹Mš
(
Ê
->
–e
,&
¿nge
)) ;

2982 ià(!
	`z¦LexV®ueL‹Max
(
Ê
->
–e
,&
¿nge
)) ;

2985 
¿ng–’
++;

2986 
	`addR•lyBulkCBufãr
(
c
,
Ê
->
–e
,
	`sd¦’
(ln->ele));

2989 ià(
»v”£
) {

2990 
Ê
 =†n->
backw¬d
;

2992 
Ê
 =†n->
Ëv–
[0].
fÜw¬d
;

2996 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2999 
	`z¦F»eLexRªge
(&
¿nge
);

3000 
	`£tDeã¼edMuÉiBulkL’gth
(
c
, 
»¶yËn
, 
¿ng–’
);

3001 
	}
}

3003 
	$z¿ngebyËxCommªd
(
ş›Á
 *
c
) {

3004 
	`g’”icZ¿ngebyËxCommªd
(
c
,0);

3005 
	}
}

3007 
	$z»v¿ngebyËxCommªd
(
ş›Á
 *
c
) {

3008 
	`g’”icZ¿ngebyËxCommªd
(
c
,1);

3009 
	}
}

3011 
	$zÿrdCommªd
(
ş›Á
 *
c
) {

3012 
robj
 *
key
 = 
c
->
¬gv
[1];

3013 
robj
 *
zobj
;

3015 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

3016 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) ;

3018 
	`addR•lyLÚgLÚg
(
c
,
	`z£tL’gth
(
zobj
));

3019 
	}
}

3021 
	$zscÜeCommªd
(
ş›Á
 *
c
) {

3022 
robj
 *
key
 = 
c
->
¬gv
[1];

3023 
robj
 *
zobj
;

3024 
scÜe
;

3026 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
nuÎbulk
)è=ğ
NULL
 ||

3027 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) ;

3029 ià(
	`z£tScÜe
(
zobj
,
c
->
¬gv
[2]->
±r
,&
scÜe
è=ğ
C_ERR
) {

3030 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

3032 
	`addR•lyDoubË
(
c
,
scÜe
);

3034 
	}
}

3036 
	$z¿nkG’”icCommªd
(
ş›Á
 *
c
, 
»v”£
) {

3037 
robj
 *
key
 = 
c
->
¬gv
[1];

3038 
robj
 *
–e
 = 
c
->
¬gv
[2];

3039 
robj
 *
zobj
;

3040 
¿nk
;

3042 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
nuÎbulk
)è=ğ
NULL
 ||

3043 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) ;

3045 
	`£rv”As£¹W™hInfo
(
c
,
–e
,
	`sdsEncodedObjeù
(ele));

3046 
¿nk
 = 
	`z£tRªk
(
zobj
,
–e
->
±r
,
»v”£
);

3047 ià(
¿nk
 >= 0) {

3048 
	`addR•lyLÚgLÚg
(
c
,
¿nk
);

3050 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

3052 
	}
}

3054 
	$z¿nkCommªd
(
ş›Á
 *
c
) {

3055 
	`z¿nkG’”icCommªd
(
c
, 0);

3056 
	}
}

3058 
	$z»v¿nkCommªd
(
ş›Á
 *
c
) {

3059 
	`z¿nkG’”icCommªd
(
c
, 1);

3060 
	}
}

3062 
	$zsÿnCommªd
(
ş›Á
 *
c
) {

3063 
robj
 *
o
;

3064 
cursÜ
;

3066 ià(
	`·r£SÿnCursÜOrR•ly
(
c
,c->
¬gv
[2],&
cursÜ
è=ğ
C_ERR
) ;

3067 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ysÿn
)è=ğ
NULL
 ||

3068 
	`checkTy³
(
c
,
o
,
OBJ_ZSET
)) ;

3069 
	`sÿnG’”icCommªd
(
c
,
o
,
cursÜ
);

3070 
	}
}

	@testhelp.h

39 #iâdeà
__TESTHELP_H


40 
	#__TESTHELP_H


	)

42 
	g__çed_‹¡s
 = 0;

43 
	g__‹¡_num
 = 0;

44 
	#‹¡_cÚd
(
desü
,
_c
) do { \

45 
__‹¡_num
++; 
	`´štf
("%d - %s: ", __‹¡_num, 
desü
); \

46 if(
_c
è
	`´štf
("PASSED\n"); {´štf("FAILED\n"); 
__çed_‹¡s
++;} \

47 } 0);

	)

48 
	#‹¡_»pÜt
() do { \

49 
	`´štf
("%de¡s, %d…as£d, %d faed\n", 
__‹¡_num
, \

50 
__‹¡_num
-
__çed_‹¡s
, __failed_tests); \

51 ià(
__çed_‹¡s
) { \

52 
	`´štf
("=== WARNING === We have failedests here...\n"); \

53 
	`ex™
(1); \

55 } 0);

	)

	@util.c

30 
	~"fmaüos.h
"

31 
	~<¡dlib.h
>

32 
	~<¡dio.h
>

33 
	~<¡ršg.h
>

34 
	~<ùy³.h
>

35 
	~<lim™s.h
>

36 
	~<m©h.h
>

37 
	~<uni¡d.h
>

38 
	~<sys/time.h
>

39 
	~<æßt.h
>

40 
	~<¡dšt.h
>

41 
	~<”ºo.h
>

43 
	~"ut.h
"

44 
	~"sha1.h
"

47 
	$¡ršgm©chËn
(cÚ¡ *
·‰”n
, 
·‰”nL’
,

48 cÚ¡ *
¡ršg
, 
¡ršgL’
, 
noÿ£
)

50 
·‰”nL’
) {

51 
·‰”n
[0]) {

53 
·‰”n
[1] == '*') {

54 
·‰”n
++;

55 
·‰”nL’
--;

57 ià(
·‰”nL’
 == 1)

59 
¡ršgL’
) {

60 ià(
	`¡ršgm©chËn
(
·‰”n
+1, 
·‰”nL’
-1,

61 
¡ršg
, 
¡ršgL’
, 
noÿ£
))

63 
¡ršg
++;

64 
¡ršgL’
--;

69 ià(
¡ršgL’
 == 0)

71 
¡ršg
++;

72 
¡ršgL’
--;

76 
nÙ
, 
m©ch
;

78 
·‰”n
++;

79 
·‰”nL’
--;

80 
nÙ
 = 
·‰”n
[0] == '^';

81 ià(
nÙ
) {

82 
·‰”n
++;

83 
·‰”nL’
--;

85 
m©ch
 = 0;

87 ià(
·‰”n
[0] == '\\') {

88 
·‰”n
++;

89 
·‰”nL’
--;

90 ià(
·‰”n
[0] =ğ
¡ršg
[0])

91 
m©ch
 = 1;

92 } ià(
·‰”n
[0] == ']') {

94 } ià(
·‰”nL’
 == 0) {

95 
·‰”n
--;

96 
·‰”nL’
++;

98 } ià(
·‰”n
[1] =ğ'-' && 
·‰”nL’
 >= 3) {

99 
¡¬t
 = 
·‰”n
[0];

100 
’d
 = 
·‰”n
[2];

101 
c
 = 
¡ršg
[0];

102 ià(
¡¬t
 > 
’d
) {

103 
t
 = 
¡¬t
;

104 
¡¬t
 = 
’d
;

105 
’d
 = 
t
;

107 ià(
noÿ£
) {

108 
¡¬t
 = 
	`tŞow”
(start);

109 
’d
 = 
	`tŞow”
(end);

110 
c
 = 
	`tŞow”
(c);

112 
·‰”n
 += 2;

113 
·‰”nL’
 -= 2;

114 ià(
c
 >ğ
¡¬t
 && c <ğ
’d
)

115 
m©ch
 = 1;

117 ià(!
noÿ£
) {

118 ià(
·‰”n
[0] =ğ
¡ršg
[0])

119 
m©ch
 = 1;

121 ià(
	`tŞow”
(()
·‰”n
[0]è=ğtŞow”(()
¡ršg
[0]))

122 
m©ch
 = 1;

125 
·‰”n
++;

126 
·‰”nL’
--;

128 ià(
nÙ
)

129 
m©ch
 = !match;

130 ià(!
m©ch
)

132 
¡ršg
++;

133 
¡ršgL’
--;

137 ià(
·‰”nL’
 >= 2) {

138 
·‰”n
++;

139 
·‰”nL’
--;

143 ià(!
noÿ£
) {

144 ià(
·‰”n
[0] !ğ
¡ršg
[0])

147 ià(
	`tŞow”
(()
·‰”n
[0]è!ğtŞow”(()
¡ršg
[0]))

150 
¡ršg
++;

151 
¡ršgL’
--;

154 
·‰”n
++;

155 
·‰”nL’
--;

156 ià(
¡ršgL’
 == 0) {

157 *
·‰”n
 == '*') {

158 
·‰”n
++;

159 
·‰”nL’
--;

164 ià(
·‰”nL’
 =ğ0 && 
¡ršgL’
 == 0)

167 
	}
}

169 
	$¡ršgm©ch
(cÚ¡ *
·‰”n
, cÚ¡ *
¡ršg
, 
noÿ£
) {

170  
	`¡ršgm©chËn
(
·‰”n
,
	`¡¾’
Õ©‹º),
¡ršg
,¡¾’(¡ršg),
noÿ£
);

171 
	}
}

180 
	$memtŞl
(cÚ¡ *
p
, *
”r
) {

181 cÚ¡ *
u
;

182 
buf
[128];

183 
mul
;

184 
v®
;

185 
dig™s
;

187 ià(
”r
) *err = 0;

190 
u
 = 
p
;

191 ià(*
u
 == '-') u++;

192 *
u
 && 
	`isdig™
(*u)) u++;

193 ià(*
u
 =ğ'\0' || !
	`¡rÿ£cmp
(u,"b")) {

194 
mul
 = 1;

195 } ià(!
	`¡rÿ£cmp
(
u
,"k")) {

196 
mul
 = 1000;

197 } ià(!
	`¡rÿ£cmp
(
u
,"kb")) {

198 
mul
 = 1024;

199 } ià(!
	`¡rÿ£cmp
(
u
,"m")) {

200 
mul
 = 1000*1000;

201 } ià(!
	`¡rÿ£cmp
(
u
,"mb")) {

202 
mul
 = 1024*1024;

203 } ià(!
	`¡rÿ£cmp
(
u
,"g")) {

204 
mul
 = 1000L*1000*1000;

205 } ià(!
	`¡rÿ£cmp
(
u
,"gb")) {

206 
mul
 = 1024L*1024*1024;

208 ià(
”r
) *err = 1;

214 
dig™s
 = 
u
-
p
;

215 ià(
dig™s
 >ğ(
buf
)) {

216 ià(
”r
) *err = 1;

219 
	`memıy
(
buf
,
p
,
dig™s
);

220 
buf
[
dig™s
] = '\0';

222 *
’d±r
;

223 
”ºo
 = 0;

224 
v®
 = 
	`¡¹Şl
(
buf
,&
’d±r
,10);

225 ià((
v®
 =ğ0 && 
”ºo
 =ğ
EINVAL
è|| *
’d±r
 != '\0') {

226 ià(
”r
) *err = 1;

229  
v®
*
mul
;

230 
	}
}

234 
ušt32_t
 
	$dig™s10
(
ušt64_t
 
v
) {

235 ià(
v
 < 10)  1;

236 ià(
v
 < 100)  2;

237 ià(
v
 < 1000)  3;

238 ià(
v
 < 1000000000000UL) {

239 ià(
v
 < 100000000UL) {

240 ià(
v
 < 1000000) {

241 ià(
v
 < 10000)  4;

242  5 + (
v
 >= 100000);

244  7 + (
v
 >= 10000000UL);

246 ià(
v
 < 10000000000UL) {

247  9 + (
v
 >= 1000000000UL);

249  11 + (
v
 >= 100000000000UL);

251  12 + 
	`dig™s10
(
v
 / 1000000000000UL);

252 
	}
}

255 
ušt32_t
 
	$sdig™s10
(
št64_t
 
v
) {

256 ià(
v
 < 0) {

258 
ušt64_t
 
uv
 = (
v
 !ğ
LLONG_MIN
) ?

259 (
ušt64_t
)-
v
 : ((ušt64_tè
LLONG_MAX
)+1;

260  
	`dig™s10
(
uv
)+1;

262  
	`dig™s10
(
v
);

264 
	}
}

277 
	$Î2¡ršg
(*
d¡
, 
size_t
 
d¡Ën
, 
sv®ue
) {

278 cÚ¡ 
dig™s
[201] =

284 
Ãg©ive
;

285 
v®ue
;

289 ià(
sv®ue
 < 0) {

290 ià(
sv®ue
 !ğ
LLONG_MIN
) {

291 
v®ue
 = -
sv®ue
;

293 
v®ue
 = ((è
LLONG_MAX
)+1;

295 
Ãg©ive
 = 1;

297 
v®ue
 = 
sv®ue
;

298 
Ãg©ive
 = 0;

302 
ušt32_t
 cÚ¡ 
Ëngth
 = 
	`dig™s10
(
v®ue
)+
Ãg©ive
;

303 ià(
Ëngth
 >ğ
d¡Ën
)  0;

306 
ušt32_t
 
Ãxt
 = 
Ëngth
;

307 
d¡
[
Ãxt
] = '\0';

308 
Ãxt
--;

309 
v®ue
 >= 100) {

310 cÚ¡ 
i
 = (
v®ue
 % 100) * 2;

311 
v®ue
 /= 100;

312 
d¡
[
Ãxt
] = 
dig™s
[
i
 + 1];

313 
d¡
[
Ãxt
 - 1] = 
dig™s
[
i
];

314 
Ãxt
 -= 2;

318 ià(
v®ue
 < 10) {

319 
d¡
[
Ãxt
] = '0' + (
ušt32_t
è
v®ue
;

321 
i
 = (
ušt32_t
è
v®ue
 * 2;

322 
d¡
[
Ãxt
] = 
dig™s
[
i
 + 1];

323 
d¡
[
Ãxt
 - 1] = 
dig™s
[
i
];

327 ià(
Ãg©ive
è
d¡
[0] = '-';

328  
Ëngth
;

329 
	}
}

343 
	$¡ršg2Î
(cÚ¡ *
s
, 
size_t
 
¦’
, *
v®ue
) {

344 cÚ¡ *
p
 = 
s
;

345 
size_t
 
¶’
 = 0;

346 
Ãg©ive
 = 0;

347 
v
;

349 ià(
¶’
 =ğ
¦’
)

353 ià(
¦’
 =ğ1 && 
p
[0] == '0') {

354 ià(
v®ue
 !ğ
NULL
) *value = 0;

358 ià(
p
[0] == '-') {

359 
Ãg©ive
 = 1;

360 
p
++; 
¶’
++;

363 ià(
¶’
 =ğ
¦’
)

368 ià(
p
[0] >= '1' &&…[0] <= '9') {

369 
v
 = 
p
[0]-'0';

370 
p
++; 
¶’
++;

371 } ià(
p
[0] =ğ'0' && 
¦’
 == 1) {

372 *
v®ue
 = 0;

378 
¶’
 < 
¦’
 && 
p
[0] >= '0' &&…[0] <= '9') {

379 ià(
v
 > (
ULLONG_MAX
 / 10))

381 
v
 *= 10;

383 ià(
v
 > (
ULLONG_MAX
 - (
p
[0]-'0')))

385 
v
 +ğ
p
[0]-'0';

387 
p
++; 
¶’
++;

391 ià(
¶’
 < 
¦’
)

394 ià(
Ãg©ive
) {

395 ià(
v
 > (()(-(
LLONG_MIN
+1))+1))

397 ià(
v®ue
 !ğ
NULL
è*v®uğ-
v
;

399 ià(
v
 > 
LLONG_MAX
)

401 ià(
v®ue
 !ğ
NULL
è*v®uğ
v
;

404 
	}
}

409 
	$¡ršg2l
(cÚ¡ *
s
, 
size_t
 
¦’
, *
lv®
) {

410 
Îv®
;

412 ià(!
	`¡ršg2Î
(
s
,
¦’
,&
Îv®
))

415 ià(
Îv®
 < 
LONG_MIN
 ||†lv® > 
LONG_MAX
)

418 *
lv®
 = ()
Îv®
;

420 
	}
}

429 
	$¡ršg2ld
(cÚ¡ *
s
, 
size_t
 
¦’
, *
dp
) {

430 
buf
[256];

431 
v®ue
;

432 *
•Œ
;

434 ià(
¦’
 >ğ(
buf
))  0;

435 
	`memıy
(
buf
,
s
,
¦’
);

436 
buf
[
¦’
] = '\0';

438 
”ºo
 = 0;

439 
v®ue
 = 
	`¡¹Şd
(
buf
, &
•Œ
);

440 ià(
	`is¥aû
(
buf
[0]è|| 
•Œ
[0] != '\0' ||

441 (
”ºo
 =ğ
ERANGE
 &&

442 (
v®ue
 =ğ
HUGE_VAL
 || value == -HUGE_VAL || value == 0)) ||

443 
”ºo
 =ğ
EINVAL
 ||

444 
	`i¢ª
(
v®ue
))

447 ià(
dp
è*d°ğ
v®ue
;

449 
	}
}

456 
	$d2¡ršg
(*
buf
, 
size_t
 
Ën
, 
v®ue
) {

457 ià(
	`i¢ª
(
v®ue
)) {

458 
Ën
 = 
	`¢´štf
(
buf
,len,"nan");

459 } ià(
	`isšf
(
v®ue
)) {

460 ià(
v®ue
 < 0)

461 
Ën
 = 
	`¢´štf
(
buf
,len,"-inf");

463 
Ën
 = 
	`¢´štf
(
buf
,len,"inf");

464 } ià(
v®ue
 == 0) {

466 ià(1.0/
v®ue
 < 0)

467 
Ën
 = 
	`¢´štf
(
buf
,len,"-0");

469 
Ën
 = 
	`¢´štf
(
buf
,len,"0");

471 #ià(
DBL_MANT_DIG
 >ğ52è&& (
LLONG_MAX
 == 0x7fffffffffffffffLL)

481 
mš
 = -4503599627370495;

482 
max
 = 4503599627370496;

483 ià(
v®ue
 > 
mš
 && v®u< 
max
 && value == (()(()value)))

484 
Ën
 = 
	`Î2¡ršg
(
buf
,Ën,()
v®ue
);

487 
Ën
 = 
	`¢´štf
(
buf
,Ën,"%.17g",
v®ue
);

490  
Ën
;

491 
	}
}

500 
	$ld2¡ršg
(*
buf
, 
size_t
 
Ën
, 
v®ue
, 
humªä›ndly
) {

501 
size_t
 
l
;

503 ià(
	`isšf
(
v®ue
)) {

506 ià(
Ën
 < 5)  0;

507 ià(
v®ue
 > 0) {

508 
	`memıy
(
buf
,"inf",3);

509 
l
 = 3;

511 
	`memıy
(
buf
,"-inf",4);

512 
l
 = 4;

514 } ià(
humªä›ndly
) {

520 
l
 = 
	`¢´štf
(
buf
,
Ën
,"%.17Lf", 
v®ue
);

521 ià(
l
+1 > 
Ën
)  0;

523 ià(
	`¡rchr
(
buf
,'.'è!ğ
NULL
) {

524 *
p
 = 
buf
+
l
-1;

525 *
p
 == '0') {

526 
p
--;

527 
l
--;

529 ià(*
p
 =ğ'.'è
l
--;

532 
l
 = 
	`¢´štf
(
buf
,
Ën
,"%.17Lg", 
v®ue
);

533 ià(
l
+1 > 
Ën
)  0;

535 
buf
[
l
] = '\0';

536  
l
;

537 
	}
}

543 
	$g‘RªdomHexCh¬s
(*
p
, 
Ën
) {

544 *
ch¬£t
 = "0123456789abcdef";

545 
j
;

548 
£ed_š™Ÿlized
 = 0;

549 
£ed
[20];

550 
ušt64_t
 
couÁ”
 = 0;

552 ià(!
£ed_š™Ÿlized
) {

557 
FILE
 *
å
 = 
	`fİ’
("/dev/urandom","r");

558 ià(
å
 && 
	`ä—d
(
£ed
,(seed),1,fp) == 1)

559 
£ed_š™Ÿlized
 = 1;

560 ià(
å
è
	`fşo£
(fp);

563 ià(
£ed_š™Ÿlized
) {

564 
Ën
) {

565 
dige¡
[20];

566 
SHA1_CTX
 
ùx
;

567 
cİyËn
 = 
Ën
 > 20 ? 20 :†en;

569 
	`SHA1In™
(&
ùx
);

570 
	`SHA1Upd©e
(&
ùx
, 
£ed
, (seed));

571 
	`SHA1Upd©e
(&
ùx
, (*)&
couÁ”
,(counter));

572 
	`SHA1Fš®
(
dige¡
, &
ùx
);

573 
couÁ”
++;

575 
	`memıy
(
p
,
dige¡
,
cİyËn
);

577 
j
 = 0; j < 
cİyËn
; j++è
p
[j] = 
ch¬£t
[p[j] & 0x0F];

578 
Ën
 -ğ
cİyËn
;

579 
p
 +ğ
cİyËn
;

585 *
x
 = 
p
;

586 
l
 = 
Ën
;

587 
timev®
 
tv
;

588 
pid_t
 
pid
 = 
	`g‘pid
();

591 
	`g‘timeofday
(&
tv
,
NULL
);

592 ià(
l
 >ğ(
tv
.
tv_u£c
)) {

593 
	`memıy
(
x
,&
tv
.
tv_u£c
,(tv.tv_usec));

594 
l
 -ğ(
tv
.
tv_u£c
);

595 
x
 +ğ(
tv
.
tv_u£c
);

597 ià(
l
 >ğ(
tv
.
tv_£c
)) {

598 
	`memıy
(
x
,&
tv
.
tv_£c
,(tv.tv_sec));

599 
l
 -ğ(
tv
.
tv_£c
);

600 
x
 +ğ(
tv
.
tv_£c
);

602 ià(
l
 >ğ(
pid
)) {

603 
	`memıy
(
x
,&
pid
,(pid));

604 
l
 -ğ(
pid
);

605 
x
 +ğ(
pid
);

609 
j
 = 0; j < 
Ën
; j++) {

610 
p
[
j
] ^ğ
	`¿nd
();

611 
p
[
j
] = 
ch¬£t
[p[j] & 0x0F];

614 
	}
}

623 
sds
 
	$g‘AbsŞu‹P©h
(*
f’ame
) {

624 
cwd
[1024];

625 
sds
 
ab¥©h
;

626 
sds
 
»Í©h
 = 
	`sd¢ew
(
f’ame
);

628 
»Í©h
 = 
	`sd¡rim
(relpath," \r\n\t");

629 ià(
»Í©h
[0] == '/') „elpath;

632 ià(
	`g‘cwd
(
cwd
,(cwd)è=ğ
NULL
) {

633 
	`sdsä“
(
»Í©h
);

634  
NULL
;

636 
ab¥©h
 = 
	`sd¢ew
(
cwd
);

637 ià(
	`sd¦’
(
ab¥©h
) &&‡bspath[sdslen(abspath)-1] != '/')

638 
ab¥©h
 = 
	`sdsÿt
(abspath,"/");

646 
	`sd¦’
(
»Í©h
) >= 3 &&

647 
»Í©h
[0] == '.' &&„elpath[1] == '.' &&„elpath[2] == '/')

649 
	`sd¤ªge
(
»Í©h
,3,-1);

650 ià(
	`sd¦’
(
ab¥©h
) > 1) {

651 *
p
 = 
ab¥©h
 + 
	`sd¦’
(abspath)-2;

652 
ŒimËn
 = 1;

654 *
p
 != '/') {

655 
p
--;

656 
ŒimËn
++;

658 
	`sd¤ªge
(
ab¥©h
,0,-(
ŒimËn
+1));

663 
ab¥©h
 = 
	`sdsÿtsds
×b¥©h,
»Í©h
);

664 
	`sdsä“
(
»Í©h
);

665  
ab¥©h
;

666 
	}
}

672 
	$·thIsBa£Name
(*
·th
) {

673  
	`¡rchr
(
·th
,'/'è=ğ
NULL
 && strchr(path,'\\') == NULL;

674 
	}
}

676 #ifdeà
REDIS_TEST


677 
	~<as£¹.h
>

679 
	$‹¡_¡ršg2Î
() {

680 
buf
[32];

681 
v
;

684 
	`¡rıy
(
buf
,"+1");

685 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

688 
	`¡rıy
(
buf
," 1");

689 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

692 
	`¡rıy
(
buf
,"1 ");

693 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

696 
	`¡rıy
(
buf
,"01");

697 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

699 
	`¡rıy
(
buf
,"-1");

700 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

701 
	`as£¹
(
v
 == -1);

703 
	`¡rıy
(
buf
,"0");

704 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

705 
	`as£¹
(
v
 == 0);

707 
	`¡rıy
(
buf
,"1");

708 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

709 
	`as£¹
(
v
 == 1);

711 
	`¡rıy
(
buf
,"99");

712 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

713 
	`as£¹
(
v
 == 99);

715 
	`¡rıy
(
buf
,"-99");

716 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

717 
	`as£¹
(
v
 == -99);

719 
	`¡rıy
(
buf
,"-9223372036854775808");

720 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

721 
	`as£¹
(
v
 =ğ
LLONG_MIN
);

723 
	`¡rıy
(
buf
,"-9223372036854775809");

724 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

726 
	`¡rıy
(
buf
,"9223372036854775807");

727 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

728 
	`as£¹
(
v
 =ğ
LLONG_MAX
);

730 
	`¡rıy
(
buf
,"9223372036854775808");

731 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

732 
	}
}

734 
	$‹¡_¡ršg2l
() {

735 
buf
[32];

736 
v
;

739 
	`¡rıy
(
buf
,"+1");

740 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

743 
	`¡rıy
(
buf
,"01");

744 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

746 
	`¡rıy
(
buf
,"-1");

747 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

748 
	`as£¹
(
v
 == -1);

750 
	`¡rıy
(
buf
,"0");

751 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

752 
	`as£¹
(
v
 == 0);

754 
	`¡rıy
(
buf
,"1");

755 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

756 
	`as£¹
(
v
 == 1);

758 
	`¡rıy
(
buf
,"99");

759 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

760 
	`as£¹
(
v
 == 99);

762 
	`¡rıy
(
buf
,"-99");

763 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

764 
	`as£¹
(
v
 == -99);

766 #ià
LONG_MAX
 !ğ
LLONG_MAX


767 
	`¡rıy
(
buf
,"-2147483648");

768 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

769 
	`as£¹
(
v
 =ğ
LONG_MIN
);

771 
	`¡rıy
(
buf
,"-2147483649");

772 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

774 
	`¡rıy
(
buf
,"2147483647");

775 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

776 
	`as£¹
(
v
 =ğ
LONG_MAX
);

778 
	`¡rıy
(
buf
,"2147483648");

779 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

781 
	}
}

783 
	$‹¡_Î2¡ršg
() {

784 
buf
[32];

785 
v
;

786 
sz
;

788 
v
 = 0;

789 
sz
 = 
	`Î2¡ršg
(
buf
,  buf, 
v
);

790 
	`as£¹
(
sz
 == 1);

791 
	`as£¹
(!
	`¡rcmp
(
buf
, "0"));

793 
v
 = -1;

794 
sz
 = 
	`Î2¡ršg
(
buf
,  buf, 
v
);

795 
	`as£¹
(
sz
 == 2);

796 
	`as£¹
(!
	`¡rcmp
(
buf
, "-1"));

798 
v
 = 99;

799 
sz
 = 
	`Î2¡ršg
(
buf
,  buf, 
v
);

800 
	`as£¹
(
sz
 == 2);

801 
	`as£¹
(!
	`¡rcmp
(
buf
, "99"));

803 
v
 = -99;

804 
sz
 = 
	`Î2¡ršg
(
buf
,  buf, 
v
);

805 
	`as£¹
(
sz
 == 3);

806 
	`as£¹
(!
	`¡rcmp
(
buf
, "-99"));

808 
v
 = -2147483648;

809 
sz
 = 
	`Î2¡ršg
(
buf
,  buf, 
v
);

810 
	`as£¹
(
sz
 == 11);

811 
	`as£¹
(!
	`¡rcmp
(
buf
, "-2147483648"));

813 
v
 = 
LLONG_MIN
;

814 
sz
 = 
	`Î2¡ršg
(
buf
,  buf, 
v
);

815 
	`as£¹
(
sz
 == 20);

816 
	`as£¹
(!
	`¡rcmp
(
buf
, "-9223372036854775808"));

818 
v
 = 
LLONG_MAX
;

819 
sz
 = 
	`Î2¡ršg
(
buf
,  buf, 
v
);

820 
	`as£¹
(
sz
 == 19);

821 
	`as£¹
(!
	`¡rcmp
(
buf
, "9223372036854775807"));

822 
	}
}

824 
	#UNUSED
(
x
è()(x)

	)

825 
	$utTe¡
(
¬gc
, **
¬gv
) {

826 
	`UNUSED
(
¬gc
);

827 
	`UNUSED
(
¬gv
);

829 
	`‹¡_¡ršg2Î
();

830 
	`‹¡_¡ršg2l
();

831 
	`‹¡_Î2¡ršg
();

833 
	}
}

	@util.h

30 #iâdeà
__REDIS_UTIL_H


31 
	#__REDIS_UTIL_H


	)

33 
	~<¡dšt.h
>

34 
	~"sds.h
"

36 
¡ršgm©chËn
(cÚ¡ *
p
, 
¶’
, cÚ¡ *
s
, 
¦’
, 
noÿ£
);

37 
¡ršgm©ch
(cÚ¡ *
p
, cÚ¡ *
s
, 
noÿ£
);

38 
memtŞl
(cÚ¡ *
p
, *
”r
);

39 
ušt32_t
 
dig™s10
(
ušt64_t
 
v
);

40 
ušt32_t
 
sdig™s10
(
št64_t
 
v
);

41 
Î2¡ršg
(*
s
, 
size_t
 
Ën
, 
v®ue
);

42 
¡ršg2Î
(cÚ¡ *
s
, 
size_t
 
¦’
, *
v®ue
);

43 
¡ršg2l
(cÚ¡ *
s
, 
size_t
 
¦’
, *
v®ue
);

44 
¡ršg2ld
(cÚ¡ *
s
, 
size_t
 
¦’
, *
dp
);

45 
d2¡ršg
(*
buf
, 
size_t
 
Ën
, 
v®ue
);

46 
ld2¡ršg
(*
buf
, 
size_t
 
Ën
, 
v®ue
, 
humªä›ndly
);

47 
sds
 
g‘AbsŞu‹P©h
(*
f’ame
);

48 
·thIsBa£Name
(*
·th
);

50 #ifdeà
REDIS_TEST


51 
utTe¡
(
¬gc
, **
¬gv
);

	@version.h

1 
	#REDIS_VERSION
 "4.0.1"

	)

	@ziplist.c

182 
	~<¡dio.h
>

183 
	~<¡dlib.h
>

184 
	~<¡ršg.h
>

185 
	~<¡dšt.h
>

186 
	~<lim™s.h
>

187 
	~"zm®loc.h
"

188 
	~"ut.h
"

189 
	~"zli¡.h
"

190 
	~"’dŸncÚv.h
"

191 
	~"»di§s£¹.h
"

193 
	#ZIP_END
 255

	)

194 
	#ZIP_BIG_PREVLEN
 254

	)

202 
	#ZIP_STR_MASK
 0xc0

	)

203 
	#ZIP_INT_MASK
 0x30

	)

204 
	#ZIP_STR_06B
 (0 << 6)

	)

205 
	#ZIP_STR_14B
 (1 << 6)

	)

206 
	#ZIP_STR_32B
 (2 << 6)

	)

207 
	#ZIP_INT_16B
 (0xc0 | 0<<4)

	)

208 
	#ZIP_INT_32B
 (0xc0 | 1<<4)

	)

209 
	#ZIP_INT_64B
 (0xc0 | 2<<4)

	)

210 
	#ZIP_INT_24B
 (0xc0 | 3<<4)

	)

211 
	#ZIP_INT_8B
 0xã

	)

215 
	#ZIP_INT_IMM_MASK
 0x0à

	)

217 
	#ZIP_INT_IMM_MIN
 0xf1

	)

218 
	#ZIP_INT_IMM_MAX
 0xfd

	)

220 
	#INT24_MAX
 0x7fffff

	)

221 
	#INT24_MIN
 (-
INT24_MAX
 - 1)

	)

225 
	#ZIP_IS_STR
(
’c
è((Óncè& 
ZIP_STR_MASK
è< ZIP_STR_MASK)

	)

230 
	#ZIPLIST_BYTES
(
zl
è(*((
ušt32_t
*)(zl)))

	)

233 
	#ZIPLIST_TAIL_OFFSET
(
zl
è(*((
ušt32_t
*)((zl)+(ušt32_t))))

	)

237 
	#ZIPLIST_LENGTH
(
zl
è(*((
ušt16_t
*)((zl)+(
ušt32_t
)*2)))

	)

242 
	#ZIPLIST_HEADER_SIZE
 ((
ušt32_t
)*2+(
ušt16_t
))

	)

245 
	#ZIPLIST_END_SIZE
 ((
ušt8_t
))

	)

248 
	#ZIPLIST_ENTRY_HEAD
(
zl
è((zl)+
ZIPLIST_HEADER_SIZE
)

	)

252 
	#ZIPLIST_ENTRY_TAIL
(
zl
è((zl)+
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(zl)))

	)

256 
	#ZIPLIST_ENTRY_END
(
zl
è((zl)+
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(zl))-1)

	)

263 
	#ZIPLIST_INCR_LENGTH
(
zl
,
šü
) { \

264 ià(
	`ZIPLIST_LENGTH
(
zl
è< 
UINT16_MAX
) \

265 
	`ZIPLIST_LENGTH
(
zl
èğ
	`šŒev16ifbe
(šŒev16ifbe(ZIPLIST_LENGTH(zl))+
šü
); \

266 }

	)

271 
	szËÁry
 {

272 
	m´ev¿wËnsize
;

273 
	m´ev¿wËn
;

274 
	mËnsize
;

277 
	mËn
;

282 
	mh—d”size
;

283 
	m’codšg
;

287 *
	mp
;

289 } 
	tzËÁry
;

291 
	#ZIPLIST_ENTRY_ZERO
(
zË
) { \

292 (
zË
)->
´ev¿wËnsize
 = (zË)->
´ev¿wËn
 = 0; \

293 (
zË
)->
Ënsize
 = (zË)->
Ën
 = (zË)->
h—d”size
 = 0; \

294 (
zË
)->
’codšg
 = 0; \

295 (
zË
)->
p
 = 
NULL
; \

296 }

	)

300 
	#ZIP_ENTRY_ENCODING
(
±r
, 
’codšg
) do { \

301 (
’codšg
èğ(
±r
[0]); \

302 ià((
’codšg
è< 
ZIP_STR_MASK
) (encoding) &= ZIP_STR_MASK; \

303 } 0)

	)

306 
	$zIÁSize
(
’codšg
) {

307 
’codšg
) {

308 
ZIP_INT_8B
:  1;

309 
ZIP_INT_16B
:  2;

310 
ZIP_INT_24B
:  3;

311 
ZIP_INT_32B
:  4;

312 
ZIP_INT_64B
:  8;

314 ià(
’codšg
 >ğ
ZIP_INT_IMM_MIN
 &&ƒncodšg <ğ
ZIP_INT_IMM_MAX
)

316 
	`·nic
("Inv®id iÁeg”ƒncodšg 0x%02X", 
’codšg
);

318 
	}
}

332 
	$zStÜeEÁryEncodšg
(*
p
, 
’codšg
, 
¿wËn
) {

333 
Ën
 = 1, 
buf
[5];

335 ià(
	`ZIP_IS_STR
(
’codšg
)) {

338 ià(
¿wËn
 <= 0x3f) {

339 ià(!
p
è 
Ën
;

340 
buf
[0] = 
ZIP_STR_06B
 | 
¿wËn
;

341 } ià(
¿wËn
 <= 0x3fff) {

342 
Ën
 += 1;

343 ià(!
p
è 
Ën
;

344 
buf
[0] = 
ZIP_STR_14B
 | ((
¿wËn
 >> 8) & 0x3f);

345 
buf
[1] = 
¿wËn
 & 0xff;

347 
Ën
 += 4;

348 ià(!
p
è 
Ën
;

349 
buf
[0] = 
ZIP_STR_32B
;

350 
buf
[1] = (
¿wËn
 >> 24) & 0xff;

351 
buf
[2] = (
¿wËn
 >> 16) & 0xff;

352 
buf
[3] = (
¿wËn
 >> 8) & 0xff;

353 
buf
[4] = 
¿wËn
 & 0xff;

357 ià(!
p
è 
Ën
;

358 
buf
[0] = 
’codšg
;

362 
	`memıy
(
p
,
buf
,
Ën
);

363  
Ën
;

364 
	}
}

371 
	#ZIP_DECODE_LENGTH
(
±r
, 
’codšg
, 
Ënsize
, 
Ën
) do { \

372 
	`ZIP_ENTRY_ENCODING
((
±r
), (
’codšg
)); \

373 ià((
’codšg
è< 
ZIP_STR_MASK
) { \

374 ià((
’codšg
è=ğ
ZIP_STR_06B
) { \

375 (
Ënsize
) = 1; \

376 (
Ën
èğ(
±r
)[0] & 0x3f; \

377 } ià((
’codšg
è=ğ
ZIP_STR_14B
) { \

378 (
Ënsize
) = 2; \

379 (
Ën
èğ(((
±r
)[0] & 0x3f) << 8) | (ptr)[1]; \

380 } ià((
’codšg
è=ğ
ZIP_STR_32B
) { \

381 (
Ënsize
) = 5; \

382 (
Ën
èğ((
±r
)[1] << 24) | \

383 ((
±r
)[2] << 16) | \

384 ((
±r
)[3] << 8) | \

385 ((
±r
)[4]); \

387 
	`·nic
("Inv®id sŒšgƒncodšg 0x%02X", (
’codšg
)); \

390 (
Ënsize
) = 1; \

391 (
Ën
èğ
	`zIÁSize
(
’codšg
); \

393 } 0);

	)

397 
	$zStÜeP»vEÁryL’gthL¬ge
(*
p
, 
Ën
) {

398 ià(
p
 !ğ
NULL
) {

399 
p
[0] = 
ZIP_BIG_PREVLEN
;

400 
	`memıy
(
p
+1,&
Ën
,(len));

401 
	`mem»v32ifbe
(
p
+1);

403  1+(
Ën
);

404 
	}
}

408 
	$zStÜeP»vEÁryL’gth
(*
p
, 
Ën
) {

409 ià(
p
 =ğ
NULL
) {

410  (
Ën
 < 
ZIP_BIG_PREVLEN
) ? 1 : (len)+1;

412 ià(
Ën
 < 
ZIP_BIG_PREVLEN
) {

413 
p
[0] = 
Ën
;

416  
	`zStÜeP»vEÁryL’gthL¬ge
(
p
,
Ën
);

419 
	}
}

423 
	#ZIP_DECODE_PREVLENSIZE
(
±r
, 
´evËnsize
) do { \

424 ià((
±r
)[0] < 
ZIP_BIG_PREVLEN
) { \

425 (
´evËnsize
) = 1; \

427 (
´evËnsize
) = 5; \

429 } 0);

	)

438 
	#ZIP_DECODE_PREVLEN
(
±r
, 
´evËnsize
, 
´evËn
) do { \

439 
	`ZIP_DECODE_PREVLENSIZE
(
±r
, 
´evËnsize
); \

440 ià((
´evËnsize
) == 1) { \

441 (
´evËn
èğ(
±r
)[0]; \

442 } ià((
´evËnsize
) == 5) { \

443 
	`as£¹
(((
´evËnsize
)) == 4); \

444 
	`memıy
(&(
´evËn
), ((*)(
±r
)) + 1, 4); \

445 
	`mem»v32ifbe
(&
´evËn
); \

447 } 0);

	)

464 
	$zP»vL’By‹Diff
(*
p
, 
Ën
) {

465 
´evËnsize
;

466 
	`ZIP_DECODE_PREVLENSIZE
(
p
, 
´evËnsize
);

467  
	`zStÜeP»vEÁryL’gth
(
NULL
, 
Ën
è- 
´evËnsize
;

468 
	}
}

471 
	$zRawEÁryL’gth
(*
p
) {

472 
´evËnsize
, 
’codšg
, 
Ënsize
, 
Ën
;

473 
	`ZIP_DECODE_PREVLENSIZE
(
p
, 
´evËnsize
);

474 
	`ZIP_DECODE_LENGTH
(
p
 + 
´evËnsize
, 
’codšg
, 
Ënsize
, 
Ën
);

475  
´evËnsize
 + 
Ënsize
 + 
Ën
;

476 
	}
}

480 
	$zTryEncodšg
(*
’Œy
, 
’ŒyËn
, *
v
, *
’codšg
) {

481 
v®ue
;

483 ià(
’ŒyËn
 >= 32 ||ƒntrylen == 0)  0;

484 ià(
	`¡ršg2Î
((*)
’Œy
,
’ŒyËn
,&
v®ue
)) {

487 ià(
v®ue
 >= 0 && value <= 12) {

488 *
’codšg
 = 
ZIP_INT_IMM_MIN
+
v®ue
;

489 } ià(
v®ue
 >ğ
INT8_MIN
 && v®u<ğ
INT8_MAX
) {

490 *
’codšg
 = 
ZIP_INT_8B
;

491 } ià(
v®ue
 >ğ
INT16_MIN
 && v®u<ğ
INT16_MAX
) {

492 *
’codšg
 = 
ZIP_INT_16B
;

493 } ià(
v®ue
 >ğ
INT24_MIN
 && v®u<ğ
INT24_MAX
) {

494 *
’codšg
 = 
ZIP_INT_24B
;

495 } ià(
v®ue
 >ğ
INT32_MIN
 && v®u<ğ
INT32_MAX
) {

496 *
’codšg
 = 
ZIP_INT_32B
;

498 *
’codšg
 = 
ZIP_INT_64B
;

500 *
v
 = 
v®ue
;

504 
	}
}

507 
	$zSaveIÁeg”
(*
p
, 
št64_t
 
v®ue
, 
’codšg
) {

508 
št16_t
 
i16
;

509 
št32_t
 
i32
;

510 
št64_t
 
i64
;

511 ià(
’codšg
 =ğ
ZIP_INT_8B
) {

512 ((
št8_t
*)
p
)[0] = (št8_t)
v®ue
;

513 } ià(
’codšg
 =ğ
ZIP_INT_16B
) {

514 
i16
 = 
v®ue
;

515 
	`memıy
(
p
,&
i16
,(i16));

516 
	`mem»v16ifbe
(
p
);

517 } ià(
’codšg
 =ğ
ZIP_INT_24B
) {

518 
i32
 = 
v®ue
<<8;

519 
	`mem»v32ifbe
(&
i32
);

520 
	`memıy
(
p
,((
ušt8_t
*)&
i32
)+1,(i32)-(uint8_t));

521 } ià(
’codšg
 =ğ
ZIP_INT_32B
) {

522 
i32
 = 
v®ue
;

523 
	`memıy
(
p
,&
i32
,(i32));

524 
	`mem»v32ifbe
(
p
);

525 } ià(
’codšg
 =ğ
ZIP_INT_64B
) {

526 
i64
 = 
v®ue
;

527 
	`memıy
(
p
,&
i64
,(i64));

528 
	`mem»v64ifbe
(
p
);

529 } ià(
’codšg
 >ğ
ZIP_INT_IMM_MIN
 &&ƒncodšg <ğ
ZIP_INT_IMM_MAX
) {

532 
	`as£¹
(
NULL
);

534 
	}
}

537 
št64_t
 
	$zLßdIÁeg”
(*
p
, 
’codšg
) {

538 
št16_t
 
i16
;

539 
št32_t
 
i32
;

540 
št64_t
 
i64
, 
»t
 = 0;

541 ià(
’codšg
 =ğ
ZIP_INT_8B
) {

542 
»t
 = ((
št8_t
*)
p
)[0];

543 } ià(
’codšg
 =ğ
ZIP_INT_16B
) {

544 
	`memıy
(&
i16
,
p
,(i16));

545 
	`mem»v16ifbe
(&
i16
);

546 
»t
 = 
i16
;

547 } ià(
’codšg
 =ğ
ZIP_INT_32B
) {

548 
	`memıy
(&
i32
,
p
,(i32));

549 
	`mem»v32ifbe
(&
i32
);

550 
»t
 = 
i32
;

551 } ià(
’codšg
 =ğ
ZIP_INT_24B
) {

552 
i32
 = 0;

553 
	`memıy
(((
ušt8_t
*)&
i32
)+1,
p
,(i32)-(uint8_t));

554 
	`mem»v32ifbe
(&
i32
);

555 
»t
 = 
i32
>>8;

556 } ià(
’codšg
 =ğ
ZIP_INT_64B
) {

557 
	`memıy
(&
i64
,
p
,(i64));

558 
	`mem»v64ifbe
(&
i64
);

559 
»t
 = 
i64
;

560 } ià(
’codšg
 >ğ
ZIP_INT_IMM_MIN
 &&ƒncodšg <ğ
ZIP_INT_IMM_MAX
) {

561 
»t
 = (
’codšg
 & 
ZIP_INT_IMM_MASK
)-1;

563 
	`as£¹
(
NULL
);

565  
»t
;

566 
	}
}

569 
	$zEÁry
(*
p
, 
zËÁry
 *
e
) {

571 
	`ZIP_DECODE_PREVLEN
(
p
, 
e
->
´ev¿wËnsize
,ƒ->
´ev¿wËn
);

572 
	`ZIP_DECODE_LENGTH
(
p
 + 
e
->
´ev¿wËnsize
,ƒ->
’codšg
,ƒ->
Ënsize
,ƒ->
Ën
);

573 
e
->
h—d”size
 =ƒ->
´ev¿wËnsize
 +ƒ->
Ënsize
;

574 
e
->
p
 =…;

575 
	}
}

578 *
	$zli¡New
() {

579 
by‹s
 = 
ZIPLIST_HEADER_SIZE
+1;

580 *
zl
 = 
	`zm®loc
(
by‹s
);

581 
	`ZIPLIST_BYTES
(
zl
èğ
	`šŒev32ifbe
(
by‹s
);

582 
	`ZIPLIST_TAIL_OFFSET
(
zl
èğ
	`šŒev32ifbe
(
ZIPLIST_HEADER_SIZE
);

583 
	`ZIPLIST_LENGTH
(
zl
) = 0;

584 
zl
[
by‹s
-1] = 
ZIP_END
;

585  
zl
;

586 
	}
}

589 *
	$zli¡Resize
(*
zl
, 
Ën
) {

590 
zl
 = 
	`z»®loc
(zl,
Ën
);

591 
	`ZIPLIST_BYTES
(
zl
èğ
	`šŒev32ifbe
(
Ën
);

592 
zl
[
Ën
-1] = 
ZIP_END
;

593  
zl
;

594 
	}
}

616 *
	$__zli¡CasÿdeUpd©e
(*
zl
, *
p
) {

617 
size_t
 
cu¾’
 = 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
)), 
¿wËn
, 
¿wËnsize
;

618 
size_t
 
off£t
, 
noff£t
, 
exŒa
;

619 *
Å
;

620 
zËÁry
 
cur
, 
Ãxt
;

622 
p
[0] !ğ
ZIP_END
) {

623 
	`zEÁry
(
p
, &
cur
);

624 
¿wËn
 = 
cur
.
h—d”size
 + cur.
Ën
;

625 
¿wËnsize
 = 
	`zStÜeP»vEÁryL’gth
(
NULL
,
¿wËn
);

628 ià(
p
[
¿wËn
] =ğ
ZIP_END
) ;

629 
	`zEÁry
(
p
+
¿wËn
, &
Ãxt
);

632 ià(
Ãxt
.
´ev¿wËn
 =ğ
¿wËn
) ;

634 ià(
Ãxt
.
´ev¿wËnsize
 < 
¿wËnsize
) {

637 
off£t
 = 
p
-
zl
;

638 
exŒa
 = 
¿wËnsize
-
Ãxt
.
´ev¿wËnsize
;

639 
zl
 = 
	`zli¡Resize
(zl,
cu¾’
+
exŒa
);

640 
p
 = 
zl
+
off£t
;

643 
Å
 = 
p
+
¿wËn
;

644 
noff£t
 = 
Å
-
zl
;

647 ià((
zl
+
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(zl))è!ğ
Å
) {

648 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

649 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))+
exŒa
);

653 
	`memmove
(
Å
+
¿wËnsize
,

654 
Å
+
Ãxt
.
´ev¿wËnsize
,

655 
cu¾’
-
noff£t
-
Ãxt
.
´ev¿wËnsize
-1);

656 
	`zStÜeP»vEÁryL’gth
(
Å
,
¿wËn
);

659 
p
 +ğ
¿wËn
;

660 
cu¾’
 +ğ
exŒa
;

662 ià(
Ãxt
.
´ev¿wËnsize
 > 
¿wËnsize
) {

665 
	`zStÜeP»vEÁryL’gthL¬ge
(
p
+
¿wËn
,rawlen);

667 
	`zStÜeP»vEÁryL’gth
(
p
+
¿wËn
,rawlen);

674  
zl
;

675 
	}
}

678 *
	$__zli¡D–‘e
(*
zl
, *
p
, 
num
) {

679 
i
, 
tÙËn
, 
d–‘ed
 = 0;

680 
size_t
 
off£t
;

681 
Ãxtdiff
 = 0;

682 
zËÁry
 
fœ¡
, 

;

684 
	`zEÁry
(
p
, &
fœ¡
);

685 
i
 = 0; 
p
[0] !ğ
ZIP_END
 && i < 
num
; i++) {

686 
p
 +ğ
	`zRawEÁryL’gth
(p);

687 
d–‘ed
++;

690 
tÙËn
 = 
p
-
fœ¡
.p;

691 ià(
tÙËn
 > 0) {

692 ià(
p
[0] !ğ
ZIP_END
) {

697 
Ãxtdiff
 = 
	`zP»vL’By‹Diff
(
p
,
fœ¡
.
´ev¿wËn
);

703 
p
 -ğ
Ãxtdiff
;

704 
	`zStÜeP»vEÁryL’gth
(
p
,
fœ¡
.
´ev¿wËn
);

707 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

708 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))-
tÙËn
);

713 
	`zEÁry
(
p
, &

);

714 ià(
p
[

.
h—d”size
+.
Ën
] !ğ
ZIP_END
) {

715 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

716 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))+
Ãxtdiff
);

720 
	`memmove
(
fœ¡
.
p
,p,

721 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
))-(
p
-zl)-1);

724 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

725 
	`šŒev32ifbe
((
fœ¡
.
p
-
zl
)-fœ¡.
´ev¿wËn
);

729 
off£t
 = 
fœ¡
.
p
-
zl
;

730 
zl
 = 
	`zli¡Resize
(zl, 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(zl))-
tÙËn
+
Ãxtdiff
);

731 
	`ZIPLIST_INCR_LENGTH
(
zl
,-
d–‘ed
);

732 
p
 = 
zl
+
off£t
;

736 ià(
Ãxtdiff
 != 0)

737 
zl
 = 
	`__zli¡CasÿdeUpd©e
(zl,
p
);

739  
zl
;

740 
	}
}

743 *
	$__zli¡In£¹
(*
zl
, *
p
, *
s
, 
¦’
) {

744 
size_t
 
cu¾’
 = 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
)), 
»qËn
;

745 
´evËnsize
, 
´evËn
 = 0;

746 
size_t
 
off£t
;

747 
Ãxtdiff
 = 0;

748 
’codšg
 = 0;

749 
v®ue
 = 123456789;

752 
zËÁry
 

;

755 ià(
p
[0] !ğ
ZIP_END
) {

756 
	`ZIP_DECODE_PREVLEN
(
p
, 
´evËnsize
, 
´evËn
);

758 *
±a
 = 
	`ZIPLIST_ENTRY_TAIL
(
zl
);

759 ià(
±a
[0] !ğ
ZIP_END
) {

760 
´evËn
 = 
	`zRawEÁryL’gth
(
±a
);

765 ià(
	`zTryEncodšg
(
s
,
¦’
,&
v®ue
,&
’codšg
)) {

767 
»qËn
 = 
	`zIÁSize
(
’codšg
);

771 
»qËn
 = 
¦’
;

775 
»qËn
 +ğ
	`zStÜeP»vEÁryL’gth
(
NULL
,
´evËn
);

776 
»qËn
 +ğ
	`zStÜeEÁryEncodšg
(
NULL
,
’codšg
,
¦’
);

781 
fÜûÏrge
 = 0;

782 
Ãxtdiff
 = (
p
[0] !ğ
ZIP_END
è? 
	`zP»vL’By‹Diff
Õ,
»qËn
) : 0;

783 ià(
Ãxtdiff
 =ğ-4 && 
»qËn
 < 4) {

784 
Ãxtdiff
 = 0;

785 
fÜûÏrge
 = 1;

789 
off£t
 = 
p
-
zl
;

790 
zl
 = 
	`zli¡Resize
(zl,
cu¾’
+
»qËn
+
Ãxtdiff
);

791 
p
 = 
zl
+
off£t
;

794 ià(
p
[0] !ğ
ZIP_END
) {

796 
	`memmove
(
p
+
»qËn
,p-
Ãxtdiff
,
cu¾’
-
off£t
-1+nextdiff);

799 ià(
fÜûÏrge
)

800 
	`zStÜeP»vEÁryL’gthL¬ge
(
p
+
»qËn
,reqlen);

802 
	`zStÜeP»vEÁryL’gth
(
p
+
»qËn
,reqlen);

805 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

806 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))+
»qËn
);

811 
	`zEÁry
(
p
+
»qËn
, &

);

812 ià(
p
[
»qËn
+

.
h—d”size
+.
Ën
] !ğ
ZIP_END
) {

813 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

814 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))+
Ãxtdiff
);

818 
	`ZIPLIST_TAIL_OFFSET
(
zl
èğ
	`šŒev32ifbe
(
p
-zl);

823 ià(
Ãxtdiff
 != 0) {

824 
off£t
 = 
p
-
zl
;

825 
zl
 = 
	`__zli¡CasÿdeUpd©e
(zl,
p
+
»qËn
);

826 
p
 = 
zl
+
off£t
;

830 
p
 +ğ
	`zStÜeP»vEÁryL’gth
Õ,
´evËn
);

831 
p
 +ğ
	`zStÜeEÁryEncodšg
Õ,
’codšg
,
¦’
);

832 ià(
	`ZIP_IS_STR
(
’codšg
)) {

833 
	`memıy
(
p
,
s
,
¦’
);

835 
	`zSaveIÁeg”
(
p
,
v®ue
,
’codšg
);

837 
	`ZIPLIST_INCR_LENGTH
(
zl
,1);

838  
zl
;

839 
	}
}

856 *
	$zli¡M”ge
(**
fœ¡
, **
£cÚd
) {

858 ià(
fœ¡
 =ğ
NULL
 || *fœ¡ =ğNULL || 
£cÚd
 == NULL || *second == NULL)

859  
NULL
;

862 ià(*
fœ¡
 =ğ*
£cÚd
)

863  
NULL
;

865 
size_t
 
fœ¡_by‹s
 = 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(*
fœ¡
));

866 
size_t
 
fœ¡_Ën
 = 
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(*
fœ¡
));

868 
size_t
 
£cÚd_by‹s
 = 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(*
£cÚd
));

869 
size_t
 
£cÚd_Ën
 = 
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(*
£cÚd
));

871 
­³nd
;

872 *
sourû
, *
rg‘
;

873 
size_t
 
rg‘_by‹s
, 
sourû_by‹s
;

877 ià(
fœ¡_Ën
 >ğ
£cÚd_Ën
) {

879 
rg‘
 = *
fœ¡
;

880 
rg‘_by‹s
 = 
fœ¡_by‹s
;

881 
sourû
 = *
£cÚd
;

882 
sourû_by‹s
 = 
£cÚd_by‹s
;

883 
­³nd
 = 1;

886 
rg‘
 = *
£cÚd
;

887 
rg‘_by‹s
 = 
£cÚd_by‹s
;

888 
sourû
 = *
fœ¡
;

889 
sourû_by‹s
 = 
fœ¡_by‹s
;

890 
­³nd
 = 0;

894 
size_t
 
zlby‹s
 = 
fœ¡_by‹s
 + 
£cÚd_by‹s
 -

895 
ZIPLIST_HEADER_SIZE
 - 
ZIPLIST_END_SIZE
;

896 
size_t
 
zÎ’gth
 = 
fœ¡_Ën
 + 
£cÚd_Ën
;

899 
zÎ’gth
 = zÎ’gth < 
UINT16_MAX
 ? zllength : UINT16_MAX;

902 
size_t
 
fœ¡_off£t
 = 
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(*
fœ¡
));

903 
size_t
 
£cÚd_off£t
 = 
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(*
£cÚd
));

906 
rg‘
 = 
	`z»®loc
Ñ¬g‘, 
zlby‹s
);

907 ià(
­³nd
) {

911 
	`memıy
(
rg‘
 + 
rg‘_by‹s
 - 
ZIPLIST_END_SIZE
,

912 
sourû
 + 
ZIPLIST_HEADER_SIZE
,

913 
sourû_by‹s
 - 
ZIPLIST_HEADER_SIZE
);

919 
	`memmove
(
rg‘
 + 
sourû_by‹s
 - 
ZIPLIST_END_SIZE
,

920 
rg‘
 + 
ZIPLIST_HEADER_SIZE
,

921 
rg‘_by‹s
 - 
ZIPLIST_HEADER_SIZE
);

922 
	`memıy
(
rg‘
, 
sourû
, 
sourû_by‹s
 - 
ZIPLIST_END_SIZE
);

926 
	`ZIPLIST_BYTES
(
rg‘
èğ
	`šŒev32ifbe
(
zlby‹s
);

927 
	`ZIPLIST_LENGTH
(
rg‘
èğ
	`šŒev16ifbe
(
zÎ’gth
);

933 
	`ZIPLIST_TAIL_OFFSET
(
rg‘
èğ
	`šŒev32ifbe
(

934 (
fœ¡_by‹s
 - 
ZIPLIST_END_SIZE
) +

935 (
£cÚd_off£t
 - 
ZIPLIST_HEADER_SIZE
));

941 
rg‘
 = 
	`__zli¡CasÿdeUpd©e
Ñ¬g‘,¬g‘+
fœ¡_off£t
);

944 ià(
­³nd
) {

945 
	`zä“
(*
£cÚd
);

946 *
£cÚd
 = 
NULL
;

947 *
fœ¡
 = 
rg‘
;

949 
	`zä“
(*
fœ¡
);

950 *
fœ¡
 = 
NULL
;

951 *
£cÚd
 = 
rg‘
;

953  
rg‘
;

954 
	}
}

956 *
	$zli¡Push
(*
zl
, *
s
, 
¦’
, 
wh”e
) {

957 *
p
;

958 
p
 = (
wh”e
 =ğ
ZIPLIST_HEAD
è? 
	`ZIPLIST_ENTRY_HEAD
(
zl
è: 
	`ZIPLIST_ENTRY_END
(zl);

959  
	`__zli¡In£¹
(
zl
,
p
,
s
,
¦’
);

960 
	}
}

965 *
	$zli¡Index
(*
zl
, 
šdex
) {

966 *
p
;

967 
´evËnsize
, 
´evËn
 = 0;

968 ià(
šdex
 < 0) {

969 
šdex
 = (-index)-1;

970 
p
 = 
	`ZIPLIST_ENTRY_TAIL
(
zl
);

971 ià(
p
[0] !ğ
ZIP_END
) {

972 
	`ZIP_DECODE_PREVLEN
(
p
, 
´evËnsize
, 
´evËn
);

973 
´evËn
 > 0 && 
šdex
--) {

974 
p
 -ğ
´evËn
;

975 
	`ZIP_DECODE_PREVLEN
(
p
, 
´evËnsize
, 
´evËn
);

979 
p
 = 
	`ZIPLIST_ENTRY_HEAD
(
zl
);

980 
p
[0] !ğ
ZIP_END
 && 
šdex
--) {

981 
p
 +ğ
	`zRawEÁryL’gth
(p);

984  (
p
[0] =ğ
ZIP_END
 || 
šdex
 > 0è? 
NULL
 :…;

985 
	}
}

993 *
	$zli¡Next
(*
zl
, *
p
) {

994 ((è
zl
);

999 ià(
p
[0] =ğ
ZIP_END
) {

1000  
NULL
;

1003 
p
 +ğ
	`zRawEÁryL’gth
(p);

1004 ià(
p
[0] =ğ
ZIP_END
) {

1005  
NULL
;

1008  
p
;

1009 
	}
}

1012 *
	$zli¡P»v
(*
zl
, *
p
) {

1013 
´evËnsize
, 
´evËn
 = 0;

1018 ià(
p
[0] =ğ
ZIP_END
) {

1019 
p
 = 
	`ZIPLIST_ENTRY_TAIL
(
zl
);

1020  (
p
[0] =ğ
ZIP_END
è? 
NULL
 :…;

1021 } ià(
p
 =ğ
	`ZIPLIST_ENTRY_HEAD
(
zl
)) {

1022  
NULL
;

1024 
	`ZIP_DECODE_PREVLEN
(
p
, 
´evËnsize
, 
´evËn
);

1025 
	`as£¹
(
´evËn
 > 0);

1026  
p
-
´evËn
;

1028 
	}
}

1034 
	$zli¡G‘
(*
p
, **
s¡r
, *
¦’
, *
sv®
) {

1035 
zËÁry
 
’Œy
;

1036 ià(
p
 =ğ
NULL
 ||…[0] =ğ
ZIP_END
)  0;

1037 ià(
s¡r
è*s¡¸ğ
NULL
;

1039 
	`zEÁry
(
p
, &
’Œy
);

1040 ià(
	`ZIP_IS_STR
(
’Œy
.
’codšg
)) {

1041 ià(
s¡r
) {

1042 *
¦’
 = 
’Œy
.
Ën
;

1043 *
s¡r
 = 
p
+
’Œy
.
h—d”size
;

1046 ià(
sv®
) {

1047 *
sv®
 = 
	`zLßdIÁeg”
(
p
+
’Œy
.
h—d”size
,’Œy.
’codšg
);

1051 
	}
}

1054 *
	$zli¡In£¹
(*
zl
, *
p
, *
s
, 
¦’
) {

1055  
	`__zli¡In£¹
(
zl
,
p
,
s
,
¦’
);

1056 
	}
}

1061 *
	$zli¡D–‘e
(*
zl
, **
p
) {

1062 
size_t
 
off£t
 = *
p
-
zl
;

1063 
zl
 = 
	`__zli¡D–‘e
(zl,*
p
,1);

1069 *
p
 = 
zl
+
off£t
;

1070  
zl
;

1071 
	}
}

1074 *
	$zli¡D–‘eRªge
(*
zl
, 
šdex
, 
num
) {

1075 *
p
 = 
	`zli¡Index
(
zl
,
šdex
);

1076  (
p
 =ğ
NULL
è? 
zl
 : 
	`__zli¡D–‘e
(zl,p,
num
);

1077 
	}
}

1081 
	$zli¡Com·»
(*
p
, *
s¡r
, 
¦’
) {

1082 
zËÁry
 
’Œy
;

1083 
£ncodšg
;

1084 
zv®
, 
sv®
;

1085 ià(
p
[0] =ğ
ZIP_END
)  0;

1087 
	`zEÁry
(
p
, &
’Œy
);

1088 ià(
	`ZIP_IS_STR
(
’Œy
.
’codšg
)) {

1090 ià(
’Œy
.
Ën
 =ğ
¦’
) {

1091  
	`memcmp
(
p
+
’Œy
.
h—d”size
,
s¡r
,
¦’
) == 0;

1098 ià(
	`zTryEncodšg
(
s¡r
,
¦’
,&
sv®
,&
£ncodšg
)) {

1099 
zv®
 = 
	`zLßdIÁeg”
(
p
+
’Œy
.
h—d”size
,’Œy.
’codšg
);

1100  
zv®
 =ğ
sv®
;

1104 
	}
}

1108 *
	$zli¡Fšd
(*
p
, *
v¡r
, 
vËn
, 
sk
) {

1109 
skút
 = 0;

1110 
v’codšg
 = 0;

1111 
vÎ
 = 0;

1113 
p
[0] !ğ
ZIP_END
) {

1114 
´evËnsize
, 
’codšg
, 
Ënsize
, 
Ën
;

1115 *
q
;

1117 
	`ZIP_DECODE_PREVLENSIZE
(
p
, 
´evËnsize
);

1118 
	`ZIP_DECODE_LENGTH
(
p
 + 
´evËnsize
, 
’codšg
, 
Ënsize
, 
Ën
);

1119 
q
 = 
p
 + 
´evËnsize
 + 
Ënsize
;

1121 ià(
skút
 == 0) {

1123 ià(
	`ZIP_IS_STR
(
’codšg
)) {

1124 ià(
Ën
 =ğ
vËn
 && 
	`memcmp
(
q
, 
v¡r
, vlen) == 0) {

1125  
p
;

1131 ià(
v’codšg
 == 0) {

1132 ià(!
	`zTryEncodšg
(
v¡r
, 
vËn
, &
vÎ
, &
v’codšg
)) {

1136 
v’codšg
 = 
UCHAR_MAX
;

1139 
	`as£¹
(
v’codšg
);

1145 ià(
v’codšg
 !ğ
UCHAR_MAX
) {

1146 
Î
 = 
	`zLßdIÁeg”
(
q
, 
’codšg
);

1147 ià(
Î
 =ğ
vÎ
) {

1148  
p
;

1154 
skút
 = 
sk
;

1157 
skút
--;

1161 
p
 = 
q
 + 
Ën
;

1164  
NULL
;

1165 
	}
}

1168 
	$zli¡L’
(*
zl
) {

1169 
Ën
 = 0;

1170 ià(
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(
zl
)è< 
UINT16_MAX
) {

1171 
Ën
 = 
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(
zl
));

1173 *
p
 = 
zl
+
ZIPLIST_HEADER_SIZE
;

1174 *
p
 !ğ
ZIP_END
) {

1175 
p
 +ğ
	`zRawEÁryL’gth
(p);

1176 
Ën
++;

1180 ià(
Ën
 < 
UINT16_MAX
è
	`ZIPLIST_LENGTH
(
zl
èğ
	`šŒev16ifbe
(len);

1182  
Ën
;

1183 
	}
}

1186 
size_t
 
	$zli¡BlobL’
(*
zl
) {

1187  
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
));

1188 
	}
}

1190 
	$zli¡R•r
(*
zl
) {

1191 *
p
;

1192 
šdex
 = 0;

1193 
zËÁry
 
’Œy
;

1195 
	`´štf
(

1199 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
)),

1200 
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(
zl
)),

1201 
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(
zl
)));

1202 
p
 = 
	`ZIPLIST_ENTRY_HEAD
(
zl
);

1203 *
p
 !ğ
ZIP_END
) {

1204 
	`zEÁry
(
p
, &
’Œy
);

1205 
	`´štf
(

1215 ()
p
,

1216 
šdex
,

1217 (è(
p
-
zl
),

1218 
’Œy
.
h—d”size
+’Œy.
Ën
,

1219 
’Œy
.
h—d”size
,

1220 
’Œy
.
´ev¿wËn
,

1221 
’Œy
.
´ev¿wËnsize
,

1222 
’Œy
.
Ën
);

1223 
	`´štf
("\tbytes: ");

1224 
i
 = 0; i < 
’Œy
.
h—d”size
+’Œy.
Ën
; i++) {

1225 
	`´štf
("%02x|",
p
[
i
]);

1227 
	`´štf
("\n");

1228 
p
 +ğ
’Œy
.
h—d”size
;

1229 ià(
	`ZIP_IS_STR
(
’Œy
.
’codšg
)) {

1230 
	`´štf
("\t[str]");

1231 ià(
’Œy
.
Ën
 > 40) {

1232 ià(
	`fwr™e
(
p
,40,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1233 
	`´štf
("...");

1235 ià(
’Œy
.
Ën
 &&

1236 
	`fwr™e
(
p
,
’Œy
.
Ën
,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1239 
	`´štf
("\t[št]%Îd", (è
	`zLßdIÁeg”
(
p
,
’Œy
.
’codšg
));

1241 
	`´štf
("\n}\n");

1242 
p
 +ğ
’Œy
.
Ën
;

1243 
šdex
++;

1245 
	`´štf
("{end}\n\n");

1246 
	}
}

1248 #ifdeà
REDIS_TEST


1249 
	~<sys/time.h
>

1250 
	~"adli¡.h
"

1251 
	~"sds.h
"

1253 
	#debug
(
f
, ...è{ ià(
DEBUG
è
	`´štf
(f, 
__VA_ARGS__
); }

	)

1255 *
	$ü—‹Li¡
() {

1256 *
zl
 = 
	`zli¡New
();

1257 
zl
 = 
	`zli¡Push
(zl, (*)"foo", 3, 
ZIPLIST_TAIL
);

1258 
zl
 = 
	`zli¡Push
(zl, (*)"quux", 4, 
ZIPLIST_TAIL
);

1259 
zl
 = 
	`zli¡Push
(zl, (*)"h–lo", 5, 
ZIPLIST_HEAD
);

1260 
zl
 = 
	`zli¡Push
(zl, (*)"1024", 4, 
ZIPLIST_TAIL
);

1261  
zl
;

1262 
	}
}

1264 *
	$ü—‹IÁLi¡
() {

1265 *
zl
 = 
	`zli¡New
();

1266 
buf
[32];

1268 
	`¥rštf
(
buf
, "100");

1269 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_TAIL
);

1270 
	`¥rštf
(
buf
, "128000");

1271 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_TAIL
);

1272 
	`¥rštf
(
buf
, "-100");

1273 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_HEAD
);

1274 
	`¥rštf
(
buf
, "4294967296");

1275 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_HEAD
);

1276 
	`¥rštf
(
buf
, "non integer");

1277 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_TAIL
);

1278 
	`¥rštf
(
buf
, "much much†onger‚on integer");

1279 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_TAIL
);

1280  
zl
;

1281 
	}
}

1283 
	$u£c
() {

1284 
timev®
 
tv
;

1285 
	`g‘timeofday
(&
tv
,
NULL
);

1286  ((()
tv
.
tv_£c
)*1000000)+tv.
tv_u£c
;

1287 
	}
}

1289 
	$¡»ss
(
pos
, 
num
, 
maxsize
, 
dnum
) {

1290 
i
,
j
,
k
;

1291 *
zl
;

1292 
pos¡r
[2][5] = { "HEAD", "TAIL" };

1293 
¡¬t
;

1294 
i
 = 0; i < 
maxsize
; i+=
dnum
) {

1295 
zl
 = 
	`zli¡New
();

1296 
j
 = 0; j < 
i
; j++) {

1297 
zl
 = 
	`zli¡Push
(zl,(*)"quux",4,
ZIPLIST_TAIL
);

1301 
¡¬t
 = 
	`u£c
();

1302 
k
 = 0; k < 
num
; k++) {

1303 
zl
 = 
	`zli¡Push
(zl,(*)"quux",4,
pos
);

1304 
zl
 = 
	`zli¡D–‘eRªge
(zl,0,1);

1306 
	`´štf
("List size: %8d, bytes: %8d, %dx…ush+pop (%s): %6lld usec\n",

1307 
i
,
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
)),
num
,
pos¡r
[
pos
],
	`u£c
()-
¡¬t
);

1308 
	`zä“
(
zl
);

1310 
	}
}

1312 *
	$pİ
(*
zl
, 
wh”e
) {

1313 *
p
, *
v¡r
;

1314 
vËn
;

1315 
vlÚg
;

1317 
p
 = 
	`zli¡Index
(
zl
,
wh”e
 =ğ
ZIPLIST_HEAD
 ? 0 : -1);

1318 ià(
	`zli¡G‘
(
p
,&
v¡r
,&
vËn
,&
vlÚg
)) {

1319 ià(
wh”e
 =ğ
ZIPLIST_HEAD
)

1320 
	`´štf
("Pop head: ");

1322 
	`´štf
("Popail: ");

1324 ià(
v¡r
) {

1325 ià(
vËn
 && 
	`fwr™e
(
v¡r
,vËn,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1328 
	`´štf
("%Îd", 
vlÚg
);

1331 
	`´štf
("\n");

1332  
	`zli¡D–‘e
(
zl
,&
p
);

1334 
	`´štf
("ERROR: Could‚ot…op\n");

1335 
	`ex™
(1);

1337 
	}
}

1339 
	$¿nd¡ršg
(*
rg‘
, 
mš
, 
max
) {

1340 
p
 = 0;

1341 
Ën
 = 
mš
+
	`¿nd
()%(
max
-min+1);

1342 
mšv®
, 
maxv®
;

1343 
	`¿nd
() % 3) {

1345 
mšv®
 = 0;

1346 
maxv®
 = 255;

1349 
mšv®
 = 48;

1350 
maxv®
 = 122;

1353 
mšv®
 = 48;

1354 
maxv®
 = 52;

1357 
	`as£¹
(
NULL
);

1360 
p
 < 
Ën
)

1361 
rg‘
[
p
++] = 
mšv®
+
	`¿nd
()%(
maxv®
-minval+1);

1362  
Ën
;

1363 
	}
}

1365 
	$v”ify
(*
zl
, 
zËÁry
 *
e
) {

1366 
Ën
 = 
	`zli¡L’
(
zl
);

1367 
zËÁry
 
_e
;

1369 
	`ZIPLIST_ENTRY_ZERO
(&
_e
);

1371 
i
 = 0; i < 
Ën
; i++) {

1372 
	`mem£t
(&
e
[
i
], 0, (
zËÁry
));

1373 
	`zEÁry
(
	`zli¡Index
(
zl
, 
i
), &
e
[i]);

1375 
	`mem£t
(&
_e
, 0, (
zËÁry
));

1376 
	`zEÁry
(
	`zli¡Index
(
zl
, -
Ën
+
i
), &
_e
);

1378 
	`as£¹
(
	`memcmp
(&
e
[
i
], &
_e
, (
zËÁry
)) == 0);

1380 
	}
}

1382 
	$zli¡Te¡
(
¬gc
, **
¬gv
) {

1383 *
zl
, *
p
;

1384 *
’Œy
;

1385 
–’
;

1386 
v®ue
;

1389 ià(
¬gc
 == 2)

1390 
	`¤ªd
(
	`©oi
(
¬gv
[1]));

1392 
zl
 = 
	`ü—‹IÁLi¡
();

1393 
	`zli¡R•r
(
zl
);

1395 
	`zä“
(
zl
);

1397 
zl
 = 
	`ü—‹Li¡
();

1398 
	`zli¡R•r
(
zl
);

1400 
zl
 = 
	`pİ
(zl,
ZIPLIST_TAIL
);

1401 
	`zli¡R•r
(
zl
);

1403 
zl
 = 
	`pİ
(zl,
ZIPLIST_HEAD
);

1404 
	`zli¡R•r
(
zl
);

1406 
zl
 = 
	`pİ
(zl,
ZIPLIST_TAIL
);

1407 
	`zli¡R•r
(
zl
);

1409 
zl
 = 
	`pİ
(zl,
ZIPLIST_TAIL
);

1410 
	`zli¡R•r
(
zl
);

1412 
	`zä“
(
zl
);

1414 
	`´štf
("Getƒlement‡t index 3:\n");

1416 
zl
 = 
	`ü—‹Li¡
();

1417 
p
 = 
	`zli¡Index
(
zl
, 3);

1418 ià(!
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1419 
	`´štf
("ERROR: Could‚ot‡ccess index 3\n");

1422 ià(
’Œy
) {

1423 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1424 
	`´štf
("\n");

1426 
	`´štf
("%Îd\n", 
v®ue
);

1428 
	`´štf
("\n");

1429 
	`zä“
(
zl
);

1432 
	`´štf
("Getƒlement‡t index 4 (out of„ange):\n");

1434 
zl
 = 
	`ü—‹Li¡
();

1435 
p
 = 
	`zli¡Index
(
zl
, 4);

1436 ià(
p
 =ğ
NULL
) {

1437 
	`´štf
("Noƒntry\n");

1439 
	`´štf
("ERROR: Ouˆoà¿ngšdex should„‘uº NULL,„‘uºed off£t: %ld\n", 
p
-
zl
);

1442 
	`´štf
("\n");

1443 
	`zä“
(
zl
);

1446 
	`´štf
("Getƒlement‡t index -1 (lastƒlement):\n");

1448 
zl
 = 
	`ü—‹Li¡
();

1449 
p
 = 
	`zli¡Index
(
zl
, -1);

1450 ià(!
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1451 
	`´štf
("ERROR: Could‚ot‡ccess index -1\n");

1454 ià(
’Œy
) {

1455 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1456 
	`´štf
("\n");

1458 
	`´štf
("%Îd\n", 
v®ue
);

1460 
	`´štf
("\n");

1461 
	`zä“
(
zl
);

1464 
	`´štf
("Getƒlement‡t index -4 (firstƒlement):\n");

1466 
zl
 = 
	`ü—‹Li¡
();

1467 
p
 = 
	`zli¡Index
(
zl
, -4);

1468 ià(!
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1469 
	`´štf
("ERROR: Could‚ot‡ccess index -4\n");

1472 ià(
’Œy
) {

1473 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1474 
	`´štf
("\n");

1476 
	`´štf
("%Îd\n", 
v®ue
);

1478 
	`´štf
("\n");

1479 
	`zä“
(
zl
);

1482 
	`´štf
("Getƒlement‡t index -5 (reverse out of„ange):\n");

1484 
zl
 = 
	`ü—‹Li¡
();

1485 
p
 = 
	`zli¡Index
(
zl
, -5);

1486 ià(
p
 =ğ
NULL
) {

1487 
	`´štf
("Noƒntry\n");

1489 
	`´štf
("ERROR: Ouˆoà¿ngšdex should„‘uº NULL,„‘uºed off£t: %ld\n", 
p
-
zl
);

1492 
	`´štf
("\n");

1493 
	`zä“
(
zl
);

1496 
	`´štf
("Iterate†ist from 0oƒnd:\n");

1498 
zl
 = 
	`ü—‹Li¡
();

1499 
p
 = 
	`zli¡Index
(
zl
, 0);

1500 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1501 
	`´štf
("Entry: ");

1502 ià(
’Œy
) {

1503 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1505 
	`´štf
("%Îd", 
v®ue
);

1507 
p
 = 
	`zli¡Next
(
zl
,p);

1508 
	`´štf
("\n");

1510 
	`´štf
("\n");

1511 
	`zä“
(
zl
);

1514 
	`´štf
("Iterate†ist from 1oƒnd:\n");

1516 
zl
 = 
	`ü—‹Li¡
();

1517 
p
 = 
	`zli¡Index
(
zl
, 1);

1518 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1519 
	`´štf
("Entry: ");

1520 ià(
’Œy
) {

1521 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1523 
	`´štf
("%Îd", 
v®ue
);

1525 
p
 = 
	`zli¡Next
(
zl
,p);

1526 
	`´štf
("\n");

1528 
	`´štf
("\n");

1529 
	`zä“
(
zl
);

1532 
	`´štf
("Iterate†ist from 2oƒnd:\n");

1534 
zl
 = 
	`ü—‹Li¡
();

1535 
p
 = 
	`zli¡Index
(
zl
, 2);

1536 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1537 
	`´štf
("Entry: ");

1538 ià(
’Œy
) {

1539 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1541 
	`´štf
("%Îd", 
v®ue
);

1543 
p
 = 
	`zli¡Next
(
zl
,p);

1544 
	`´štf
("\n");

1546 
	`´štf
("\n");

1547 
	`zä“
(
zl
);

1550 
	`´štf
("Iterate starting out of„ange:\n");

1552 
zl
 = 
	`ü—‹Li¡
();

1553 
p
 = 
	`zli¡Index
(
zl
, 4);

1554 ià(!
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1555 
	`´štf
("Noƒntry\n");

1557 
	`´štf
("ERROR\n");

1559 
	`´štf
("\n");

1560 
	`zä“
(
zl
);

1563 
	`´štf
("Iterate from backo front:\n");

1565 
zl
 = 
	`ü—‹Li¡
();

1566 
p
 = 
	`zli¡Index
(
zl
, -1);

1567 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1568 
	`´štf
("Entry: ");

1569 ià(
’Œy
) {

1570 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1572 
	`´štf
("%Îd", 
v®ue
);

1574 
p
 = 
	`zli¡P»v
(
zl
,p);

1575 
	`´štf
("\n");

1577 
	`´štf
("\n");

1578 
	`zä“
(
zl
);

1581 
	`´štf
("Iterate from backo front, deleting‡ll items:\n");

1583 
zl
 = 
	`ü—‹Li¡
();

1584 
p
 = 
	`zli¡Index
(
zl
, -1);

1585 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1586 
	`´štf
("Entry: ");

1587 ià(
’Œy
) {

1588 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1590 
	`´štf
("%Îd", 
v®ue
);

1592 
zl
 = 
	`zli¡D–‘e
(zl,&
p
);

1593 
p
 = 
	`zli¡P»v
(
zl
,p);

1594 
	`´štf
("\n");

1596 
	`´štf
("\n");

1597 
	`zä“
(
zl
);

1600 
	`´štf
("Delete inclusive„ange 0,0:\n");

1602 
zl
 = 
	`ü—‹Li¡
();

1603 
zl
 = 
	`zli¡D–‘eRªge
(zl, 0, 1);

1604 
	`zli¡R•r
(
zl
);

1605 
	`zä“
(
zl
);

1608 
	`´štf
("Delete inclusive„ange 0,1:\n");

1610 
zl
 = 
	`ü—‹Li¡
();

1611 
zl
 = 
	`zli¡D–‘eRªge
(zl, 0, 2);

1612 
	`zli¡R•r
(
zl
);

1613 
	`zä“
(
zl
);

1616 
	`´štf
("Delete inclusive„ange 1,2:\n");

1618 
zl
 = 
	`ü—‹Li¡
();

1619 
zl
 = 
	`zli¡D–‘eRªge
(zl, 1, 2);

1620 
	`zli¡R•r
(
zl
);

1621 
	`zä“
(
zl
);

1624 
	`´štf
("Delete with start index out of„ange:\n");

1626 
zl
 = 
	`ü—‹Li¡
();

1627 
zl
 = 
	`zli¡D–‘eRªge
(zl, 5, 1);

1628 
	`zli¡R•r
(
zl
);

1629 
	`zä“
(
zl
);

1632 
	`´štf
("Delete with‚um overflow:\n");

1634 
zl
 = 
	`ü—‹Li¡
();

1635 
zl
 = 
	`zli¡D–‘eRªge
(zl, 1, 5);

1636 
	`zli¡R•r
(
zl
);

1637 
	`zä“
(
zl
);

1640 
	`´štf
("Delete foo while iterating:\n");

1642 
zl
 = 
	`ü—‹Li¡
();

1643 
p
 = 
	`zli¡Index
(
zl
,0);

1644 
	`zli¡G‘
(
p
,&
’Œy
,&
–’
,&
v®ue
)) {

1645 ià(
’Œy
 && 
	`¡ºcmp
("foo",(*ëÁry,
–’
) == 0) {

1646 
	`´štf
("Delete foo\n");

1647 
zl
 = 
	`zli¡D–‘e
(zl,&
p
);

1649 
	`´štf
("Entry: ");

1650 ià(
’Œy
) {

1651 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
) == 0)

1652 
	`³¼Ü
("fwrite");

1654 
	`´štf
("%Îd",
v®ue
);

1656 
p
 = 
	`zli¡Next
(
zl
,p);

1657 
	`´štf
("\n");

1660 
	`´štf
("\n");

1661 
	`zli¡R•r
(
zl
);

1662 
	`zä“
(
zl
);

1665 
	`´štf
("Regressionest for >255 byte strings:\n");

1667 
v1
[257] = {0}, 
v2
[257] = {0};

1668 
	`mem£t
(
v1
,'x',256);

1669 
	`mem£t
(
v2
,'y',256);

1670 
zl
 = 
	`zli¡New
();

1671 
zl
 = 
	`zli¡Push
(zl,(*)
v1
,
	`¡¾’
(v1),
ZIPLIST_TAIL
);

1672 
zl
 = 
	`zli¡Push
(zl,(*)
v2
,
	`¡¾’
(v2),
ZIPLIST_TAIL
);

1675 
p
 = 
	`zli¡Index
(
zl
,0);

1676 
	`as£¹
(
	`zli¡G‘
(
p
,&
’Œy
,&
–’
,&
v®ue
));

1677 
	`as£¹
(
	`¡ºcmp
(
v1
,(*)
’Œy
,
–’
) == 0);

1678 
p
 = 
	`zli¡Index
(
zl
,1);

1679 
	`as£¹
(
	`zli¡G‘
(
p
,&
’Œy
,&
–’
,&
v®ue
));

1680 
	`as£¹
(
	`¡ºcmp
(
v2
,(*)
’Œy
,
–’
) == 0);

1681 
	`´štf
("SUCCESS\n\n");

1682 
	`zä“
(
zl
);

1685 
	`´štf
("Regressionest deleting‚exto†astƒntries:\n");

1687 
v
[3][257] = {{0}};

1688 
zËÁry
 
e
[3] = {{.
´ev¿wËnsize
 = 0, .
´ev¿wËn
 = 0, .
Ënsize
 = 0,

1689 .
Ën
 = 0, .
h—d”size
 = 0, .
’codšg
 = 0, .
p
 = 
NULL
}};

1690 
size_t
 
i
;

1692 
i
 = 0; i < ((
v
)/(v[0])); i++) {

1693 
	`mem£t
(
v
[
i
], 'a' + i, (v[0]));

1696 
v
[0][256] = '\0';

1697 
v
[1][ 1] = '\0';

1698 
v
[2][256] = '\0';

1700 
zl
 = 
	`zli¡New
();

1701 
i
 = 0; i < ((
v
)/(v[0])); i++) {

1702 
zl
 = 
	`zli¡Push
(zl, (*è
v
[
i
], 
	`¡¾’
(v[i]), 
ZIPLIST_TAIL
);

1705 
	`v”ify
(
zl
, 
e
);

1707 
	`as£¹
(
e
[0].
´ev¿wËnsize
 == 1);

1708 
	`as£¹
(
e
[1].
´ev¿wËnsize
 == 5);

1709 
	`as£¹
(
e
[2].
´ev¿wËnsize
 == 1);

1712 *
p
 = 
e
[1].p;

1713 
zl
 = 
	`zli¡D–‘e
(zl, &
p
);

1715 
	`v”ify
(
zl
, 
e
);

1717 
	`as£¹
(
e
[0].
´ev¿wËnsize
 == 1);

1718 
	`as£¹
(
e
[1].
´ev¿wËnsize
 == 5);

1720 
	`´štf
("SUCCESS\n\n");

1721 
	`zä“
(
zl
);

1724 
	`´štf
("Create†ong†ist‡nd check indices:\n");

1726 
zl
 = 
	`zli¡New
();

1727 
buf
[32];

1728 
i
,
Ën
;

1729 
i
 = 0; i < 1000; i++) {

1730 
Ën
 = 
	`¥rštf
(
buf
,"%d",
i
);

1731 
zl
 = 
	`zli¡Push
(zl,(*)
buf
,
Ën
,
ZIPLIST_TAIL
);

1733 
i
 = 0; i < 1000; i++) {

1734 
p
 = 
	`zli¡Index
(
zl
,
i
);

1735 
	`as£¹
(
	`zli¡G‘
(
p
,
NULL
,NULL,&
v®ue
));

1736 
	`as£¹
(
i
 =ğ
v®ue
);

1738 
p
 = 
	`zli¡Index
(
zl
,-
i
-1);

1739 
	`as£¹
(
	`zli¡G‘
(
p
,
NULL
,NULL,&
v®ue
));

1740 
	`as£¹
(999-
i
 =ğ
v®ue
);

1742 
	`´štf
("SUCCESS\n\n");

1743 
	`zä“
(
zl
);

1746 
	`´štf
("Compare strings with ziplistƒntries:\n");

1748 
zl
 = 
	`ü—‹Li¡
();

1749 
p
 = 
	`zli¡Index
(
zl
,0);

1750 ià(!
	`zli¡Com·»
(
p
,(*)"hello",5)) {

1751 
	`´štf
("ERROR:‚ot \"hello\"\n");

1754 ià(
	`zli¡Com·»
(
p
,(*)"hella",5)) {

1755 
	`´štf
("ERROR: \"hella\"\n");

1759 
p
 = 
	`zli¡Index
(
zl
,3);

1760 ià(!
	`zli¡Com·»
(
p
,(*)"1024",4)) {

1761 
	`´štf
("ERROR:‚ot \"1024\"\n");

1764 ià(
	`zli¡Com·»
(
p
,(*)"1025",4)) {

1765 
	`´štf
("ERROR: \"1025\"\n");

1768 
	`´štf
("SUCCESS\n\n");

1769 
	`zä“
(
zl
);

1772 
	`´štf
("Mergeest:\n");

1775 
zl
 = 
	`ü—‹Li¡
();

1776 *
zl2
 = 
	`ü—‹Li¡
();

1778 *
zl3
 = 
	`zli¡New
();

1779 *
zl4
 = 
	`zli¡New
();

1781 ià(
	`zli¡M”ge
(&
zl4
, &zl4)) {

1782 
	`´štf
("ERROR: Allowed merging of one ziplist into itself.\n");

1787 
zl4
 = 
	`zli¡M”ge
(&
zl3
, &zl4);

1788 
	`zli¡R•r
(
zl4
);

1789 ià(
	`zli¡L’
(
zl4
)) {

1790 
	`´štf
("ERROR: Mergingwoƒmpty ziplists createdƒntries.\n");

1793 
	`zä“
(
zl4
);

1795 
zl2
 = 
	`zli¡M”ge
(&
zl
, &zl2);

1797 
	`zli¡R•r
(
zl2
);

1799 ià(
	`zli¡L’
(
zl2
) != 8) {

1800 
	`´štf
("ERROR: M”ged†’gth‚Ù 8, but: %u\n", 
	`zli¡L’
(
zl2
));

1804 
p
 = 
	`zli¡Index
(
zl2
,0);

1805 ià(!
	`zli¡Com·»
(
p
,(*)"hello",5)) {

1806 
	`´štf
("ERROR:‚ot \"hello\"\n");

1809 ià(
	`zli¡Com·»
(
p
,(*)"hella",5)) {

1810 
	`´štf
("ERROR: \"hella\"\n");

1814 
p
 = 
	`zli¡Index
(
zl2
,3);

1815 ià(!
	`zli¡Com·»
(
p
,(*)"1024",4)) {

1816 
	`´štf
("ERROR:‚ot \"1024\"\n");

1819 ià(
	`zli¡Com·»
(
p
,(*)"1025",4)) {

1820 
	`´štf
("ERROR: \"1025\"\n");

1824 
p
 = 
	`zli¡Index
(
zl2
,4);

1825 ià(!
	`zli¡Com·»
(
p
,(*)"hello",5)) {

1826 
	`´štf
("ERROR:‚ot \"hello\"\n");

1829 ià(
	`zli¡Com·»
(
p
,(*)"hella",5)) {

1830 
	`´štf
("ERROR: \"hella\"\n");

1834 
p
 = 
	`zli¡Index
(
zl2
,7);

1835 ià(!
	`zli¡Com·»
(
p
,(*)"1024",4)) {

1836 
	`´štf
("ERROR:‚ot \"1024\"\n");

1839 ià(
	`zli¡Com·»
(
p
,(*)"1025",4)) {

1840 
	`´štf
("ERROR: \"1025\"\n");

1843 
	`´štf
("SUCCESS\n\n");

1844 
	`zä“
(
zl
);

1847 
	`´štf
("Stress with„andom…ayloads of differentƒncoding:\n");

1849 
i
,
j
,
Ën
,
wh”e
;

1850 *
p
;

1851 
buf
[1024];

1852 
buæ’
;

1853 
li¡
 *
»f
;

1854 
li¡Node
 *
»âode
;

1857 *
s¡r
;

1858 
¦’
;

1859 
sv®
;

1861 
i
 = 0; i < 20000; i++) {

1862 
zl
 = 
	`zli¡New
();

1863 
»f
 = 
	`li¡C»©e
();

1864 
	`li¡S‘F»eM‘hod
(
»f
,((*)(*))
sdsä“
);

1865 
Ën
 = 
	`¿nd
() % 256;

1868 
j
 = 0; j < 
Ën
; j++) {

1869 
wh”e
 = (
	`¿nd
(è& 1è? 
ZIPLIST_HEAD
 : 
ZIPLIST_TAIL
;

1870 ià(
	`¿nd
() % 2) {

1871 
buæ’
 = 
	`¿nd¡ršg
(
buf
,1,(buf)-1);

1873 
	`¿nd
() % 3) {

1875 
buæ’
 = 
	`¥rštf
(
buf
,"%Îd",(0LL + 
	`¿nd
()) >> 20);

1878 
buæ’
 = 
	`¥rštf
(
buf
,"%Îd",(0LL + 
	`¿nd
()));

1881 
buæ’
 = 
	`¥rštf
(
buf
,"%Îd",(0LL + 
	`¿nd
()) << 20);

1884 
	`as£¹
(
NULL
);

1889 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
buæ’
, 
wh”e
);

1892 ià(
wh”e
 =ğ
ZIPLIST_HEAD
) {

1893 
	`li¡AddNodeH—d
(
»f
,
	`sd¢ewËn
(
buf
, 
buæ’
));

1894 } ià(
wh”e
 =ğ
ZIPLIST_TAIL
) {

1895 
	`li¡AddNodeTa
(
»f
,
	`sd¢ewËn
(
buf
, 
buæ’
));

1897 
	`as£¹
(
NULL
);

1901 
	`as£¹
(
	`li¡L’gth
(
»f
è=ğ
	`zli¡L’
(
zl
));

1902 
j
 = 0; j < 
Ën
; j++) {

1905 
p
 = 
	`zli¡Index
(
zl
,
j
);

1906 
»âode
 = 
	`li¡Index
(
»f
,
j
);

1908 
	`as£¹
(
	`zli¡G‘
(
p
,&
s¡r
,&
¦’
,&
sv®
));

1909 ià(
s¡r
 =ğ
NULL
) {

1910 
buæ’
 = 
	`¥rštf
(
buf
,"%Îd",
sv®
);

1912 
buæ’
 = 
¦’
;

1913 
	`memıy
(
buf
,
s¡r
,
buæ’
);

1914 
buf
[
buæ’
] = '\0';

1916 
	`as£¹
(
	`memcmp
(
buf
,
	`li¡NodeV®ue
(
»âode
),
buæ’
) == 0);

1918 
	`zä“
(
zl
);

1919 
	`li¡R–—£
(
»f
);

1921 
	`´štf
("SUCCESS\n\n");

1924 
	`´štf
("Stress with variable ziplist size:\n");

1926 
	`¡»ss
(
ZIPLIST_HEAD
,100000,16384,256);

1927 
	`¡»ss
(
ZIPLIST_TAIL
,100000,16384,256);

1931 
	}
}

	@ziplist.h

31 #iâdeà
_ZIPLIST_H


32 
	#_ZIPLIST_H


	)

34 
	#ZIPLIST_HEAD
 0

	)

35 
	#ZIPLIST_TAIL
 1

	)

37 *
zli¡New
();

38 *
zli¡M”ge
(**
fœ¡
, **
£cÚd
);

39 *
zli¡Push
(*
zl
, *
s
, 
¦’
, 
wh”e
);

40 *
zli¡Index
(*
zl
, 
šdex
);

41 *
zli¡Next
(*
zl
, *
p
);

42 *
zli¡P»v
(*
zl
, *
p
);

43 
zli¡G‘
(*
p
, **
sv®
, *
¦’
, *
lv®
);

44 *
zli¡In£¹
(*
zl
, *
p
, *
s
, 
¦’
);

45 *
zli¡D–‘e
(*
zl
, **
p
);

46 *
zli¡D–‘eRªge
(*
zl
, 
šdex
, 
num
);

47 
zli¡Com·»
(*
p
, *
s
, 
¦’
);

48 *
zli¡Fšd
(*
p
, *
v¡r
, 
vËn
, 
sk
);

49 
zli¡L’
(*
zl
);

50 
size_t
 
zli¡BlobL’
(*
zl
);

51 
zli¡R•r
(*
zl
);

53 #ifdeà
REDIS_TEST


54 
zli¡Te¡
(
¬gc
, *
¬gv
[]);

	@zipmap.c

78 
	~<¡dio.h
>

79 
	~<¡ršg.h
>

80 
	~"zm®loc.h
"

81 
	~"’dŸncÚv.h
"

83 
	#ZIPMAP_BIGLEN
 254

	)

84 
	#ZIPMAP_END
 255

	)

88 
	#ZIPMAP_VALUE_MAX_FREE
 4

	)

93 
	#ZIPMAP_LEN_BYTES
(
_l
è(((_lè< 
ZIPMAP_BIGLEN
è? 1 : ()+1)

	)

96 *
	$zm­New
() {

97 *
zm
 = 
	`zm®loc
(2);

99 
zm
[0] = 0;

100 
zm
[1] = 
ZIPMAP_END
;

101  
zm
;

102 
	}
}

105 
	$zm­DecodeL’gth
(*
p
) {

106 
Ën
 = *
p
;

108 ià(
Ën
 < 
ZIPMAP_BIGLEN
) †en;

109 
	`memıy
(&
Ën
,
p
+1,());

110 
	`mem»v32ifbe
(&
Ën
);

111  
Ën
;

112 
	}
}

116 
	$zm­EncodeL’gth
(*
p
, 
Ën
) {

117 ià(
p
 =ğ
NULL
) {

118  
	`ZIPMAP_LEN_BYTES
(
Ën
);

120 ià(
Ën
 < 
ZIPMAP_BIGLEN
) {

121 
p
[0] = 
Ën
;

124 
p
[0] = 
ZIPMAP_BIGLEN
;

125 
	`memıy
(
p
+1,&
Ën
,(len));

126 
	`mem»v32ifbe
(
p
+1);

127  1+(
Ën
);

130 
	}
}

138 *
	$zm­LookupRaw
(*
zm
, *
key
, 
kËn
, *
tÙËn
) {

139 *
p
 = 
zm
+1, *
k
 = 
NULL
;

140 
l
,
Î’
;

142 *
p
 !ğ
ZIPMAP_END
) {

143 
ä“
;

146 
l
 = 
	`zm­DecodeL’gth
(
p
);

147 
Î’
 = 
	`zm­EncodeL’gth
(
NULL
,
l
);

148 ià(
key
 !ğ
NULL
 && 
k
 =ğNULL && 
l
 =ğ
kËn
 && !
	`memcmp
(
p
+
Î’
,key,l)) {

151 ià(
tÙËn
 !ğ
NULL
) {

152 
k
 = 
p
;

154  
p
;

157 
p
 +ğ
Î’
+
l
;

159 
l
 = 
	`zm­DecodeL’gth
(
p
);

160 
p
 +ğ
	`zm­EncodeL’gth
(
NULL
,
l
);

161 
ä“
 = 
p
[0];

162 
p
 +ğ
l
+1+
ä“
;

164 ià(
tÙËn
 !ğ
NULL
è*tÙËÀğ()(
p
-
zm
)+1;

165  
k
;

166 
	}
}

168 
	$zm­RequœedL’gth
(
kËn
, 
vËn
) {

169 
l
;

171 
l
 = 
kËn
+
vËn
+3;

172 ià(
kËn
 >ğ
ZIPMAP_BIGLEN
è
l
 += 4;

173 ià(
vËn
 >ğ
ZIPMAP_BIGLEN
è
l
 += 4;

174  
l
;

175 
	}
}

178 
	$zm­RawKeyL’gth
(*
p
) {

179 
l
 = 
	`zm­DecodeL’gth
(
p
);

180  
	`zm­EncodeL’gth
(
NULL
,
l
) +†;

181 
	}
}

185 
	$zm­RawV®ueL’gth
(*
p
) {

186 
l
 = 
	`zm­DecodeL’gth
(
p
);

187 
u£d
;

189 
u£d
 = 
	`zm­EncodeL’gth
(
NULL
,
l
);

190 
u£d
 +ğ
p
[u£d] + 1 + 
l
;

191  
u£d
;

192 
	}
}

197 
	$zm­RawEÁryL’gth
(*
p
) {

198 
l
 = 
	`zm­RawKeyL’gth
(
p
);

199  
l
 + 
	`zm­RawV®ueL’gth
(
p
+l);

200 
	}
}

202 
šlše
 *
	$zm­Resize
(*
zm
, 
Ën
) {

203 
zm
 = 
	`z»®loc
(zm, 
Ën
);

204 
zm
[
Ën
-1] = 
ZIPMAP_END
;

205  
zm
;

206 
	}
}

211 *
	$zm­S‘
(*
zm
, *
key
, 
kËn
, *
v®
, 
vËn
, *
upd©e
) {

212 
zmËn
, 
off£t
;

213 
ä“Ën
, 
»qËn
 = 
	`zm­RequœedL’gth
(
kËn
,
vËn
);

214 
em±y
, 
vem±y
;

215 *
p
;

217 
ä“Ën
 = 
»qËn
;

218 ià(
upd©e
) *update = 0;

219 
p
 = 
	`zm­LookupRaw
(
zm
,
key
,
kËn
,&
zmËn
);

220 ià(
p
 =ğ
NULL
) {

222 
zm
 = 
	`zm­Resize
(zm, 
zmËn
+
»qËn
);

223 
p
 = 
zm
+
zmËn
-1;

224 
zmËn
 = zmËn+
»qËn
;

227 ià(
zm
[0] < 
ZIPMAP_BIGLEN
) zm[0]++;

231 ià(
upd©e
) *update = 1;

232 
ä“Ën
 = 
	`zm­RawEÁryL’gth
(
p
);

233 ià(
ä“Ën
 < 
»qËn
) {

237 
off£t
 = 
p
-
zm
;

238 
zm
 = 
	`zm­Resize
(zm, 
zmËn
-
ä“Ën
+
»qËn
);

239 
p
 = 
zm
+
off£t
;

243 
	`memmove
(
p
+
»qËn
,…+
ä“Ën
, 
zmËn
-(
off£t
+freelen+1));

244 
zmËn
 = zmËn-
ä“Ën
+
»qËn
;

245 
ä“Ën
 = 
»qËn
;

253 
em±y
 = 
ä“Ën
-
»qËn
;

254 ià(
em±y
 >ğ
ZIPMAP_VALUE_MAX_FREE
) {

257 
off£t
 = 
p
-
zm
;

258 
	`memmove
(
p
+
»qËn
,…+
ä“Ën
, 
zmËn
-(
off£t
+freelen+1));

259 
zmËn
 -ğ
em±y
;

260 
zm
 = 
	`zm­Resize
(zm, 
zmËn
);

261 
p
 = 
zm
+
off£t
;

262 
vem±y
 = 0;

264 
vem±y
 = 
em±y
;

269 
p
 +ğ
	`zm­EncodeL’gth
Õ,
kËn
);

270 
	`memıy
(
p
,
key
,
kËn
);

271 
p
 +ğ
kËn
;

273 
p
 +ğ
	`zm­EncodeL’gth
Õ,
vËn
);

274 *
p
++ = 
vem±y
;

275 
	`memıy
(
p
,
v®
,
vËn
);

276  
zm
;

277 
	}
}

281 *
	$zm­D–
(*
zm
, *
key
, 
kËn
, *
d–‘ed
) {

282 
zmËn
, 
ä“Ën
;

283 *
p
 = 
	`zm­LookupRaw
(
zm
,
key
,
kËn
,&
zmËn
);

284 ià(
p
) {

285 
ä“Ën
 = 
	`zm­RawEÁryL’gth
(
p
);

286 
	`memmove
(
p
,…+
ä“Ën
, 
zmËn
-(Õ-
zm
)+freelen+1));

287 
zm
 = 
	`zm­Resize
(zm, 
zmËn
-
ä“Ën
);

290 ià(
zm
[0] < 
ZIPMAP_BIGLEN
) zm[0]--;

292 ià(
d–‘ed
) *deleted = 1;

294 ià(
d–‘ed
) *deleted = 0;

296  
zm
;

297 
	}
}

300 *
	$zm­Rewšd
(*
zm
) {

301  
zm
+1;

302 
	}
}

315 *
	$zm­Next
(*
zm
, **
key
, *
kËn
, **
v®ue
, *
vËn
) {

316 ià(
zm
[0] =ğ
ZIPMAP_END
è 
NULL
;

317 ià(
key
) {

318 *
key
 = 
zm
;

319 *
kËn
 = 
	`zm­DecodeL’gth
(
zm
);

320 *
key
 +ğ
	`ZIPMAP_LEN_BYTES
(*
kËn
);

322 
zm
 +ğ
	`zm­RawKeyL’gth
(zm);

323 ià(
v®ue
) {

324 *
v®ue
 = 
zm
+1;

325 *
vËn
 = 
	`zm­DecodeL’gth
(
zm
);

326 *
v®ue
 +ğ
	`ZIPMAP_LEN_BYTES
(*
vËn
);

328 
zm
 +ğ
	`zm­RawV®ueL’gth
(zm);

329  
zm
;

330 
	}
}

334 
	$zm­G‘
(*
zm
, *
key
, 
kËn
, **
v®ue
, *
vËn
) {

335 *
p
;

337 ià((
p
 = 
	`zm­LookupRaw
(
zm
,
key
,
kËn
,
NULL
)) == NULL)  0;

338 
p
 +ğ
	`zm­RawKeyL’gth
(p);

339 *
vËn
 = 
	`zm­DecodeL’gth
(
p
);

340 *
v®ue
 = 
p
 + 
	`ZIPMAP_LEN_BYTES
(*
vËn
) + 1;

342 
	}
}

345 
	$zm­Exi¡s
(*
zm
, *
key
, 
kËn
) {

346  
	`zm­LookupRaw
(
zm
,
key
,
kËn
,
NULL
) != NULL;

347 
	}
}

350 
	$zm­L’
(*
zm
) {

351 
Ën
 = 0;

352 ià(
zm
[0] < 
ZIPMAP_BIGLEN
) {

353 
Ën
 = 
zm
[0];

355 *
p
 = 
	`zm­Rewšd
(
zm
);

356 (
p
 = 
	`zm­Next
Õ,
NULL
,NULL,NULL,NULL)è!ğNULLè
Ën
++;

359 ià(
Ën
 < 
ZIPMAP_BIGLEN
è
zm
[0] =†en;

361  
Ën
;

362 
	}
}

367 
size_t
 
	$zm­BlobL’
(*
zm
) {

368 
tÙËn
;

369 
	`zm­LookupRaw
(
zm
,
NULL
,0,&
tÙËn
);

370  
tÙËn
;

371 
	}
}

373 #ifdeà
REDIS_TEST


374 
	$zm­R•r
(*
p
) {

375 
l
;

377 
	`´štf
("{¡©u %u}",*
p
++);

379 ià(
p
[0] =ğ
ZIPMAP_END
) {

380 
	`´štf
("{end}");

383 
e
;

385 
l
 = 
	`zm­DecodeL’gth
(
p
);

386 
	`´štf
("{key %u}",
l
);

387 
p
 +ğ
	`zm­EncodeL’gth
(
NULL
,
l
);

388 ià(
l
 !ğ0 && 
	`fwr™e
(
p
,l,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

389 
p
 +ğ
l
;

391 
l
 = 
	`zm­DecodeL’gth
(
p
);

392 
	`´štf
("{v®u%u}",
l
);

393 
p
 +ğ
	`zm­EncodeL’gth
(
NULL
,
l
);

394 
e
 = *
p
++;

395 ià(
l
 !ğ0 && 
	`fwr™e
(
p
,l,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

396 
p
 +ğ
l
+
e
;

397 ià(
e
) {

398 
	`´štf
("[");

399 
e
--è
	`´štf
(".");

400 
	`´štf
("]");

404 
	`´štf
("\n");

405 
	}
}

407 
	#UNUSED
(
x
è()(x)

	)

408 
	$zm­Te¡
(
¬gc
, *
¬gv
[]) {

409 *
zm
;

411 
	`UNUSED
(
¬gc
);

412 
	`UNUSED
(
¬gv
);

414 
zm
 = 
	`zm­New
();

416 
zm
 = 
	`zm­S‘
(zm,(*è"Çme",4, (*è"foo",3,
NULL
);

417 
zm
 = 
	`zm­S‘
(zm,(*è"suºame",7, (*è"foo",3,
NULL
);

418 
zm
 = 
	`zm­S‘
(zm,(*è"age",3, (*è"foo",3,
NULL
);

419 
	`zm­R•r
(
zm
);

421 
zm
 = 
	`zm­S‘
(zm,(*è"h–lo",5, (*è"wÜld!",6,
NULL
);

422 
zm
 = 
	`zm­S‘
(zm,(*è"foo",3, (*è"b¬",3,
NULL
);

423 
zm
 = 
	`zm­S‘
(zm,(*è"foo",3, (*è"!",1,
NULL
);

424 
	`zm­R•r
(
zm
);

425 
zm
 = 
	`zm­S‘
(zm,(*è"foo",3, (*è"12345",5,
NULL
);

426 
	`zm­R•r
(
zm
);

427 
zm
 = 
	`zm­S‘
(zm,(*è"Ãw",3, (*è"xx",2,
NULL
);

428 
zm
 = 
	`zm­S‘
(zm,(*è"nov®",5, (*è"",0,
NULL
);

429 
	`zm­R•r
(
zm
);

430 
zm
 = 
	`zm­D–
(zm,(*è"Ãw",3,
NULL
);

431 
	`zm­R•r
(
zm
);

433 
	`´štf
("\nLook up†arge key:\n");

435 
buf
[512];

436 *
v®ue
;

437 
vËn
, 
i
;

438 
i
 = 0; i < 512; i++è
buf
[i] = 'a';

440 
zm
 = 
	`zm­S‘
(zm,
buf
,512,(*è"lÚg",4,
NULL
);

441 ià(
	`zm­G‘
(
zm
,
buf
,512,&
v®ue
,&
vËn
)) {

442 
	`´štf
(" <long key> is‡ssociatedohe %d bytes value: %.*s\n",

443 
vËn
, vËn, 
v®ue
);

447 
	`´štf
("\nPerform‡ direct†ookup:\n");

449 *
v®ue
;

450 
vËn
;

452 ià(
	`zm­G‘
(
zm
,(*è"foo",3,&
v®ue
,&
vËn
)) {

453 
	`´štf
(" foo is‡ssociatedohe %d bytes value: %.*s\n",

454 
vËn
, vËn, 
v®ue
);

457 
	`´štf
("\nIteratehroughƒlements:\n");

459 *
i
 = 
	`zm­Rewšd
(
zm
);

460 *
key
, *
v®ue
;

461 
kËn
, 
vËn
;

463 (
i
 = 
	`zm­Next
(i,&
key
,&
kËn
,&
v®ue
,&
vËn
)è!ğ
NULL
) {

464 
	`´štf
(" %d:%.* => %d:%.*s\n", 
kËn
, kËn, 
key
, 
vËn
, vËn, 
v®ue
);

468 
	}
}

	@zipmap.h

35 #iâdeà
_ZIPMAP_H


36 
	#_ZIPMAP_H


	)

38 *
zm­New
();

39 *
zm­S‘
(*
zm
, *
key
, 
kËn
, *
v®
, 
vËn
, *
upd©e
);

40 *
zm­D–
(*
zm
, *
key
, 
kËn
, *
d–‘ed
);

41 *
zm­Rewšd
(*
zm
);

42 *
zm­Next
(*
zm
, **
key
, *
kËn
, **
v®ue
, *
vËn
);

43 
zm­G‘
(*
zm
, *
key
, 
kËn
, **
v®ue
, *
vËn
);

44 
zm­Exi¡s
(*
zm
, *
key
, 
kËn
);

45 
zm­L’
(*
zm
);

46 
size_t
 
zm­BlobL’
(*
zm
);

47 
zm­R•r
(*
p
);

49 #ifdeà
REDIS_TEST


50 
zm­Te¡
(
¬gc
, *
¬gv
[]);

	@zmalloc.c

31 
	~<¡dio.h
>

32 
	~<¡dlib.h
>

38 
	$zlibc_ä“
(*
±r
) {

39 
	`ä“
(
±r
);

40 
	}
}

42 
	~<¡ršg.h
>

43 
	~<±h»ad.h
>

44 
	~"cÚfig.h
"

45 
	~"zm®loc.h
"

46 
	~"©omicv¬.h
"

48 #ifdeà
HAVE_MALLOC_SIZE


49 
	#PREFIX_SIZE
 (0)

	)

51 #ià
defšed
(
__sun
è|| defšed(
__¥¬c
è|| defšed(
__¥¬c__
)

52 
	#PREFIX_SIZE
 (())

	)

54 
	#PREFIX_SIZE
 ((
size_t
))

	)

59 #ià
defšed
(
USE_TCMALLOC
)

60 
	#m®loc
(
size
è
	`tc_m®loc
(size)

	)

61 
	#ÿÎoc
(
couÁ
,
size
è
	`tc_ÿÎoc
(couÁ,size)

	)

62 
	#»®loc
(
±r
,
size
è
	`tc_»®loc
ÕŒ,size)

	)

63 
	#ä“
(
±r
è
	`tc_ä“
ÕŒ)

	)

64 #–ià
defšed
(
USE_JEMALLOC
)

65 
	#m®loc
(
size
è
	`je_m®loc
(size)

	)

66 
	#ÿÎoc
(
couÁ
,
size
è
	`je_ÿÎoc
(couÁ,size)

	)

67 
	#»®loc
(
±r
,
size
è
	`je_»®loc
ÕŒ,size)

	)

68 
	#ä“
(
±r
è
	`je_ä“
ÕŒ)

	)

69 
	#m®locx
(
size
,
æags
è
	`je_m®locx
(size,æags)

	)

70 
	#d®locx
(
±r
,
æags
è
	`je_d®locx
ÕŒ,æags)

	)

73 
	#upd©e_zm®loc_¡©_®loc
(
__n
) do { \

74 
size_t
 
_n
 = (
__n
); \

75 ià(
_n
&(()-1)) _n += ()-(_n&(()-1)); \

76 
	`©omicInü
(
u£d_memÜy
,
__n
); \

77 } 0)

	)

79 
	#upd©e_zm®loc_¡©_ä“
(
__n
) do { \

80 
size_t
 
_n
 = (
__n
); \

81 ià(
_n
&(()-1)) _n += ()-(_n&(()-1)); \

82 
	`©omicDeü
(
u£d_memÜy
,
__n
); \

83 } 0)

	)

85 
size_t
 
	gu£d_memÜy
 = 0;

86 
±h»ad_mu‹x_t
 
	gu£d_memÜy_mu‹x
 = 
PTHREAD_MUTEX_INITIALIZER
;

88 
	$zm®loc_deçuÉ_oom
(
size_t
 
size
) {

89 
	`årštf
(
¡d”r
, "zmalloc: Out of memoryryingo‡llocate %zu bytes\n",

90 
size
);

91 
	`fæush
(
¡d”r
);

92 
	`abÜt
();

93 
	}
}

95 (*
zm®loc_oom_hªdËr
)(
size_t
èğ
zm®loc_deçuÉ_oom
;

97 *
	$zm®loc
(
size_t
 
size
) {

98 *
±r
 = 
	`m®loc
(
size
+
PREFIX_SIZE
);

100 ià(!
±r
è
	`zm®loc_oom_hªdËr
(
size
);

101 #ifdeà
HAVE_MALLOC_SIZE


102 
	`upd©e_zm®loc_¡©_®loc
(
	`zm®loc_size
(
±r
));

103  
±r
;

105 *((
size_t
*)
±r
èğ
size
;

106 
	`upd©e_zm®loc_¡©_®loc
(
size
+
PREFIX_SIZE
);

107  (*)
±r
+
PREFIX_SIZE
;

109 
	}
}

114 #ifdeà
HAVE_DEFRAG


115 *
	$zm®loc_no_tÿche
(
size_t
 
size
) {

116 *
±r
 = 
	`m®locx
(
size
+
PREFIX_SIZE
, 
MALLOCX_TCACHE_NONE
);

117 ià(!
±r
è
	`zm®loc_oom_hªdËr
(
size
);

118 
	`upd©e_zm®loc_¡©_®loc
(
	`zm®loc_size
(
±r
));

119  
±r
;

120 
	}
}

122 
	$zä“_no_tÿche
(*
±r
) {

123 ià(
±r
 =ğ
NULL
) ;

124 
	`upd©e_zm®loc_¡©_ä“
(
	`zm®loc_size
(
±r
));

125 
	`d®locx
(
±r
, 
MALLOCX_TCACHE_NONE
);

126 
	}
}

129 *
	$zÿÎoc
(
size_t
 
size
) {

130 *
±r
 = 
	`ÿÎoc
(1, 
size
+
PREFIX_SIZE
);

132 ià(!
±r
è
	`zm®loc_oom_hªdËr
(
size
);

133 #ifdeà
HAVE_MALLOC_SIZE


134 
	`upd©e_zm®loc_¡©_®loc
(
	`zm®loc_size
(
±r
));

135  
±r
;

137 *((
size_t
*)
±r
èğ
size
;

138 
	`upd©e_zm®loc_¡©_®loc
(
size
+
PREFIX_SIZE
);

139  (*)
±r
+
PREFIX_SIZE
;

141 
	}
}

143 *
	$z»®loc
(*
±r
, 
size_t
 
size
) {

144 #iâdeà
HAVE_MALLOC_SIZE


145 *
»®±r
;

147 
size_t
 
Şdsize
;

148 *
Ãw±r
;

150 ià(
±r
 =ğ
NULL
è 
	`zm®loc
(
size
);

151 #ifdeà
HAVE_MALLOC_SIZE


152 
Şdsize
 = 
	`zm®loc_size
(
±r
);

153 
Ãw±r
 = 
	`»®loc
(
±r
,
size
);

154 ià(!
Ãw±r
è
	`zm®loc_oom_hªdËr
(
size
);

156 
	`upd©e_zm®loc_¡©_ä“
(
Şdsize
);

157 
	`upd©e_zm®loc_¡©_®loc
(
	`zm®loc_size
(
Ãw±r
));

158  
Ãw±r
;

160 
»®±r
 = (*)
±r
-
PREFIX_SIZE
;

161 
Şdsize
 = *((
size_t
*)
»®±r
);

162 
Ãw±r
 = 
	`»®loc
(
»®±r
,
size
+
PREFIX_SIZE
);

163 ià(!
Ãw±r
è
	`zm®loc_oom_hªdËr
(
size
);

165 *((
size_t
*)
Ãw±r
èğ
size
;

166 
	`upd©e_zm®loc_¡©_ä“
(
Şdsize
);

167 
	`upd©e_zm®loc_¡©_®loc
(
size
);

168  (*)
Ãw±r
+
PREFIX_SIZE
;

170 
	}
}

175 #iâdeà
HAVE_MALLOC_SIZE


176 
size_t
 
	$zm®loc_size
(*
±r
) {

177 *
»®±r
 = (*)
±r
-
PREFIX_SIZE
;

178 
size_t
 
size
 = *((size_t*)
»®±r
);

181 ià(
size
&(()-1)) size += ()-(size&(()-1));

182  
size
+
PREFIX_SIZE
;

183 
	}
}

186 
	$zä“
(*
±r
) {

187 #iâdeà
HAVE_MALLOC_SIZE


188 *
»®±r
;

189 
size_t
 
Şdsize
;

192 ià(
±r
 =ğ
NULL
) ;

193 #ifdeà
HAVE_MALLOC_SIZE


194 
	`upd©e_zm®loc_¡©_ä“
(
	`zm®loc_size
(
±r
));

195 
	`ä“
(
±r
);

197 
»®±r
 = (*)
±r
-
PREFIX_SIZE
;

198 
Şdsize
 = *((
size_t
*)
»®±r
);

199 
	`upd©e_zm®loc_¡©_ä“
(
Şdsize
+
PREFIX_SIZE
);

200 
	`ä“
(
»®±r
);

202 
	}
}

204 *
	$z¡rdup
(cÚ¡ *
s
) {

205 
size_t
 
l
 = 
	`¡¾’
(
s
)+1;

206 *
p
 = 
	`zm®loc
(
l
);

208 
	`memıy
(
p
,
s
,
l
);

209  
p
;

210 
	}
}

212 
size_t
 
	$zm®loc_u£d_memÜy
() {

213 
size_t
 
um
;

214 
	`©omicG‘
(
u£d_memÜy
,
um
);

215  
um
;

216 
	}
}

218 
	$zm®loc_£t_oom_hªdËr
((*
oom_hªdËr
)(
size_t
)) {

219 
zm®loc_oom_hªdËr
 = 
oom_hªdËr
;

220 
	}
}

232 #ià
defšed
(
HAVE_PROC_STAT
)

233 
	~<uni¡d.h
>

234 
	~<sys/ty³s.h
>

235 
	~<sys/¡©.h
>

236 
	~<fú.h
>

238 
size_t
 
	$zm®loc_g‘_rss
() {

239 
·ge
 = 
	`syscÚf
(
_SC_PAGESIZE
);

240 
size_t
 
rss
;

241 
buf
[4096];

242 
f’ame
[256];

243 
fd
, 
couÁ
;

244 *
p
, *
x
;

246 
	`¢´štf
(
f’ame
,256,"/´oc/%d/¡©",
	`g‘pid
());

247 ià((
fd
 = 
	`İ’
(
f’ame
,
O_RDONLY
)) == -1)  0;

248 ià(
	`»ad
(
fd
,
buf
,4096) <= 0) {

249 
	`şo£
(
fd
);

252 
	`şo£
(
fd
);

254 
p
 = 
buf
;

255 
couÁ
 = 23;

256 
p
 && 
couÁ
--) {

257 
p
 = 
	`¡rchr
(p,' ');

258 ià(
p
)…++;

260 ià(!
p
)  0;

261 
x
 = 
	`¡rchr
(
p
,' ');

262 ià(!
x
)  0;

263 *
x
 = '\0';

265 
rss
 = 
	`¡¹Şl
(
p
,
NULL
,10);

266 
rss
 *ğ
·ge
;

267  
rss
;

268 
	}
}

269 #–ià
defšed
(
HAVE_TASKINFO
)

270 
	~<uni¡d.h
>

271 
	~<¡dio.h
>

272 
	~<¡dlib.h
>

273 
	~<sys/ty³s.h
>

274 
	~<sys/sysùl.h
>

275 
	~<mach/sk.h
>

276 
	~<mach/mach_š™.h
>

278 
size_t
 
	$zm®loc_g‘_rss
() {

279 
sk_t
 
sk
 = 
MACH_PORT_NULL
;

280 
sk_basic_šfo
 
t_šfo
;

281 
mach_msg_ty³_numb”_t
 
t_šfo_couÁ
 = 
TASK_BASIC_INFO_COUNT
;

283 ià(
	`sk_fÜ_pid
(
	`cu¼’t_sk
(), 
	`g‘pid
(), &
sk
è!ğ
KERN_SUCCESS
)

285 
	`sk_šfo
(
sk
, 
TASK_BASIC_INFO
, (
sk_šfo_t
)&
t_šfo
, &
t_šfo_couÁ
);

287  
t_šfo
.
»sid’t_size
;

288 
	}
}

290 
size_t
 
	$zm®loc_g‘_rss
() {

296  
	`zm®loc_u£d_memÜy
();

297 
	}
}

301 
	$zm®loc_g‘_äagm’tiÚ_¿tio
(
size_t
 
rss
) {

302  ()
rss
/
	`zm®loc_u£d_memÜy
();

303 
	}
}

315 #ià
defšed
(
HAVE_PROC_SMAPS
)

316 
size_t
 
	$zm®loc_g‘_sm­_by‹s_by_f›ld
(*
f›ld
, 
pid
) {

317 
lše
[1024];

318 
size_t
 
by‹s
 = 0;

319 
æ’
 = 
	`¡¾’
(
f›ld
);

320 
FILE
 *
å
;

322 ià(
pid
 == -1) {

323 
å
 = 
	`fİ’
("/proc/self/smaps","r");

325 
f’ame
[128];

326 
	`¢´štf
(
f’ame
,(f’ame),"/´oc/%ld/sm­s",
pid
);

327 
å
 = 
	`fİ’
(
f’ame
,"r");

330 ià(!
å
)  0;

331 
	`fg‘s
(
lše
,Öše),
å
è!ğ
NULL
) {

332 ià(
	`¡ºcmp
(
lše
,
f›ld
,
æ’
) == 0) {

333 *
p
 = 
	`¡rchr
(
lše
,'k');

334 ià(
p
) {

335 *
p
 = '\0';

336 
by‹s
 +ğ
	`¡¹Ş
(
lše
+
æ’
,
NULL
,10) * 1024;

340 
	`fşo£
(
å
);

341  
by‹s
;

342 
	}
}

344 
size_t
 
	$zm®loc_g‘_sm­_by‹s_by_f›ld
(*
f›ld
, 
pid
) {

345 ((è
f›ld
);

346 ((è
pid
);

348 
	}
}

351 
size_t
 
	$zm®loc_g‘_´iv©e_dœty
(
pid
) {

352  
	`zm®loc_g‘_sm­_by‹s_by_f›ld
("Priv©e_Dœty:",
pid
);

353 
	}
}

368 
size_t
 
	$zm®loc_g‘_memÜy_size
() {

369 #ià
	`defšed
(
__unix__
è|| defšed(
__unix
è|| defšed(
unix
) || \

370 (
	`defšed
(
__APPLE__
è&& defšed(
__MACH__
))

371 #ià
	`defšed
(
CTL_HW
è&& (defšed(
HW_MEMSIZE
è|| defšed(
HW_PHYSMEM64
))

372 
mib
[2];

373 
mib
[0] = 
CTL_HW
;

374 #ià
	`defšed
(
HW_MEMSIZE
)

375 
mib
[1] = 
HW_MEMSIZE
;

376 #–ià
	`defšed
(
HW_PHYSMEM64
)

377 
mib
[1] = 
HW_PHYSMEM64
;

379 
št64_t
 
size
 = 0;

380 
size_t
 
Ën
 = (
size
);

381 ià(
	`sysùl
Ğ
mib
, 2, &
size
, &
Ën
, 
NULL
, 0) == 0)

382  (
size_t
)
size
;

385 #–ià
	`defšed
(
_SC_PHYS_PAGES
è&& defšed(
_SC_PAGESIZE
)

387  (
size_t
)
	`syscÚf
(
_SC_PHYS_PAGES
è* (size_t)syscÚf(
_SC_PAGESIZE
);

389 #–ià
	`defšed
(
CTL_HW
è&& (defšed(
HW_PHYSMEM
è|| defšed(
HW_REALMEM
))

391 
mib
[2];

392 
mib
[0] = 
CTL_HW
;

393 #ià
	`defšed
(
HW_REALMEM
)

394 
mib
[1] = 
HW_REALMEM
;

395 #–ià
	`defšed
(
HW_PYSMEM
)

396 
mib
[1] = 
HW_PHYSMEM
;

398 
size
 = 0;

399 
size_t
 
Ën
 = (
size
);

400 ià(
	`sysùl
(
mib
, 2, &
size
, &
Ën
, 
NULL
, 0) == 0)

401  (
size_t
)
size
;

409 
	}
}

	@zmalloc.h

31 #iâdeà
__ZMALLOC_H


32 
	#__ZMALLOC_H


	)

35 
	#__x¡r
(
s
è
	`__¡r
(s)

	)

36 
	#__¡r
(
s
è#s

	)

38 #ià
defšed
(
USE_TCMALLOC
)

39 
	#ZMALLOC_LIB
 ("tcm®loc-" 
	`__x¡r
(
TC_VERSION_MAJOR
è"." __x¡r(
TC_VERSION_MINOR
))

	)

40 
	~<googË/tcm®loc.h
>

41 #ià(
TC_VERSION_MAJOR
 =ğ1 && 
TC_VERSION_MINOR
 >= 6) || (TC_VERSION_MAJOR > 1)

42 
	#HAVE_MALLOC_SIZE
 1

	)

43 
	#zm®loc_size
(
p
è
	`tc_m®loc_size
Õ)

	)

48 #–ià
defšed
(
USE_JEMALLOC
)

49 
	#ZMALLOC_LIB
 ("jem®loc-" 
	`__x¡r
(
JEMALLOC_VERSION_MAJOR
è"." __x¡r(
JEMALLOC_VERSION_MINOR
è"." __x¡r(
JEMALLOC_VERSION_BUGFIX
))

	)

50 
	~<jem®loc/jem®loc.h
>

51 #ià(
JEMALLOC_VERSION_MAJOR
 =ğ2 && 
JEMALLOC_VERSION_MINOR
 >= 1) || (JEMALLOC_VERSION_MAJOR > 2)

52 
	#HAVE_MALLOC_SIZE
 1

	)

53 
	#zm®loc_size
(
p
è
	`je_m®loc_u§bË_size
Õ)

	)

58 #–ià
defšed
(
__APPLE__
)

59 
	~<m®loc/m®loc.h
>

60 
	#HAVE_MALLOC_SIZE
 1

	)

61 
	#zm®loc_size
(
p
è
	`m®loc_size
Õ)

	)

64 #iâdeà
ZMALLOC_LIB


65 
	#ZMALLOC_LIB
 "libc"

	)

71 #ià
defšed
(
USE_JEMALLOC
è&& defšed(
JEMALLOC_FRAG_HINT
)

72 
	#HAVE_DEFRAG


	)

75 *
zm®loc
(
size_t
 
size
);

76 *
zÿÎoc
(
size_t
 
size
);

77 *
z»®loc
(*
±r
, 
size_t
 
size
);

78 
zä“
(*
±r
);

79 *
z¡rdup
(cÚ¡ *
s
);

80 
size_t
 
zm®loc_u£d_memÜy
();

81 
zm®loc_£t_oom_hªdËr
((*
oom_hªdËr
)(
size_t
));

82 
	`zm®loc_g‘_äagm’tiÚ_¿tio
(
size_t
 
rss
);

83 
size_t
 
	`zm®loc_g‘_rss
();

84 
size_t
 
	`zm®loc_g‘_´iv©e_dœty
(
pid
);

85 
size_t
 
	`zm®loc_g‘_sm­_by‹s_by_f›ld
(*
f›ld
, 
pid
);

86 
size_t
 
	`zm®loc_g‘_memÜy_size
();

87 
	`zlibc_ä“
(*
±r
);

89 #ifdeà
HAVE_DEFRAG


90 
	`zä“_no_tÿche
(*
±r
);

91 *
	`zm®loc_no_tÿche
(
size_t
 
size
);

94 #iâdeà
HAVE_MALLOC_SIZE


95 
size_t
 
	`zm®loc_size
(*
±r
);

	@/usr/include/arpa/inet.h

18 #iâdeà
_ARPA_INET_H


19 
	#_ARPA_INET_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	~<Ãtš‘/š.h
>

25 #iâdeà
__sockËn_t_defšed


26 
__sockËn_t
 
	tsockËn_t
;

27 
	#__sockËn_t_defšed


	)

30 
__BEGIN_DECLS


34 
š_addr_t
 
	$š‘_addr
 (cÚ¡ *
__ı
è
__THROW
;

37 
š_addr_t
 
	$š‘_Êaof
 (
š_addr
 
__š
è
__THROW
;

41 
š_addr
 
	$š‘_mak—ddr
 (
š_addr_t
 
__Ãt
, in_addr_ˆ
__ho¡
)

42 
__THROW
;

45 
š_addr_t
 
	$š‘_Ãtof
 (
š_addr
 
__š
è
__THROW
;

49 
š_addr_t
 
	$š‘_ÃtwÜk
 (cÚ¡ *
__ı
è
__THROW
;

53 *
	$š‘_Áß
 (
š_addr
 
__š
è
__THROW
;

58 
	$š‘_±Ú
 (
__af
, cÚ¡ *
__»¡riù
 
__ı
,

59 *
__»¡riù
 
__buf
è
__THROW
;

64 cÚ¡ *
	$š‘_Áİ
 (
__af
, cÚ¡ *
__»¡riù
 
__ı
,

65 *
__»¡riù
 
__buf
, 
sockËn_t
 
__Ën
)

66 
__THROW
;

70 #ifdeà
__USE_MISC


73 
	$š‘_©Ú
 (cÚ¡ *
__ı
, 
š_addr
 *
__šp
è
__THROW
;

77 *
	$š‘_Ã
 (
š_addr_t
 
__Ãt
, *
__buf
, 
size_t
 
__Ën
è
__THROW
;

82 *
	$š‘_Ãt_Áİ
 (
__af
, cÚ¡ *
__ı
, 
__b™s
,

83 *
__buf
, 
size_t
 
__Ën
è
__THROW
;

88 
	$š‘_Ãt_±Ú
 (
__af
, cÚ¡ *
__ı
,

89 *
__buf
, 
size_t
 
__Ën
è
__THROW
;

94 
	$š‘_n§p_addr
 (cÚ¡ *
__ı
,

95 *
__buf
, 
__Ën
è
__THROW
;

99 *
	$š‘_n§p_Áß
 (
__Ën
, cÚ¡ *
__ı
,

100 *
__buf
è
__THROW
;

103 
__END_DECLS


	@/usr/include/assert.h

22 #ifdef 
_ASSERT_H


24 #undeà
_ASSERT_H


25 #undeà
as£¹


26 #undeà
__ASSERT_VOID_CAST


28 #ifdef 
__USE_GNU


29 #undeà
as£¹_³¼Ü


34 
	#_ASSERT_H
 1

	)

35 
	~<ã©u»s.h
>

37 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (2,95)

38 
	#__ASSERT_VOID_CAST
 
¡©ic_ÿ¡
<>

	)

40 
	#__ASSERT_VOID_CAST
 ()

	)

48 #ifdef 
NDEBUG


50 
	#as£¹
(
ex´
è(
	`__ASSERT_VOID_CAST
 (0))

	)

58 #ifdef 
__USE_GNU


59 
	#as£¹_³¼Ü
(
”ºum
è(
	`__ASSERT_VOID_CAST
 (0))

	)

64 #iâdeà
_ASSERT_H_DECLS


65 
	#_ASSERT_H_DECLS


	)

66 
__BEGIN_DECLS


69 
	$__as£¹_ç
 (cÚ¡ *
__as£¹iÚ
, cÚ¡ *
__fe
,

70 
__lše
, cÚ¡ *
__funùiÚ
)

71 
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

74 
	$__as£¹_³¼Ü_ç
 (
__”ºum
, cÚ¡ *
__fe
,

75 
__lše
, cÚ¡ *
__funùiÚ
)

76 
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

81 
	$__as£¹
 (cÚ¡ *
__as£¹iÚ
, cÚ¡ *
__fe
, 
__lše
)

82 
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

85 
__END_DECLS


88 
	#as£¹
(
ex´
) \

89 ((
ex´
) \

90 ? 
	`__ASSERT_VOID_CAST
 (0) \

91 : 
	`__as£¹_ç
 (#ex´, 
__FILE__
, 
__LINE__
, 
__ASSERT_FUNCTION
))

	)

93 #ifdef 
__USE_GNU


94 
	#as£¹_³¼Ü
(
”ºum
) \

95 (!(
”ºum
) \

96 ? 
	`__ASSERT_VOID_CAST
 (0) \

97 : 
	`__as£¹_³¼Ü_ç
 ((
”ºum
), 
__FILE__
, 
__LINE__
, 
__ASSERT_FUNCTION
))

	)

105 #ià
defšed
 
__ılu¥lus
 ? 
	`__GNUC_PREREQ
 (2, 6) : __GNUC_PREREQ (2, 4)

106 
	#__ASSERT_FUNCTION
 
__PRETTY_FUNCTION__


	)

108 #ià
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L

109 
	#__ASSERT_FUNCTION
 
__func__


	)

111 
	#__ASSERT_FUNCTION
 ((cÚ¡ *è0)

	)

118 #ià
defšed
 
__USE_ISOC11
 && !defšed 
__ılu¥lus


119 #undeà
¡©ic_as£¹


120 
	#¡©ic_as£¹
 
_Stic_as£¹


	)

	@/usr/include/ctype.h

22 #iâdef 
_CTYPE_H


23 
	#_CTYPE_H
 1

	)

25 
	~<ã©u»s.h
>

26 
	~<b™s/ty³s.h
>

28 
	g__BEGIN_DECLS


30 #iâdeà
_ISb™


39 
	~<’dŸn.h
>

40 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


41 
	#_ISb™
(
b™
è(1 << (b™))

	)

43 
	#_ISb™
(
b™
è((b™è< 8 ? ((1 << (b™)è<< 8è: ((1 << (b™)è>> 8))

	)

48 
	m_ISuµ”
 = 
_ISb™
 (0),

49 
	m_ISlow”
 = 
_ISb™
 (1),

50 
	m_IS®pha
 = 
_ISb™
 (2),

51 
	m_ISdig™
 = 
_ISb™
 (3),

52 
	m_ISxdig™
 = 
_ISb™
 (4),

53 
	m_IS¥aû
 = 
_ISb™
 (5),

54 
	m_IS´št
 = 
_ISb™
 (6),

55 
	m_ISg¿ph
 = 
_ISb™
 (7),

56 
	m_ISbÏnk
 = 
_ISb™
 (8),

57 
	m_ISúŒl
 = 
_ISb™
 (9),

58 
	m_ISpunù
 = 
_ISb™
 (10),

59 
	m_IS®num
 = 
_ISb™
 (11)

79 cÚ¡ **
	$__ùy³_b_loc
 ()

80 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

81 cÚ¡ 
__št32_t
 **
	$__ùy³_tŞow”_loc
 ()

82 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

83 cÚ¡ 
__št32_t
 **
	$__ùy³_touµ”_loc
 ()

84 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

87 #iâdeà
__ılu¥lus


88 
	#__isùy³
(
c
, 
ty³
) \

89 ((*
	`__ùy³_b_loc
 ())[(è(
c
)] & (è
ty³
)

	)

90 #–ià
defšed
 
__USE_EXTERN_INLINES


91 
	#__isùy³_f
(
ty³
) \

92 
__ex‹º_šlše
 \

93 
is
##
	`ty³
 (
__c
è
__THROW
 \

95  (*
	`__ùy³_b_loc
 ())[(è(
__c
)] & (è
_IS
##
ty³
; \

96 
	}

	)
}

99 
	#__i§scii
(
c
è(((cè& ~0x7fè=ğ0è

	)

100 
	#__tßscii
(
c
è((cè& 0x7fè

	)

102 
	#__exùy³
(
Çme
è
	`Çme
 (è
__THROW


	)

104 
__BEGIN_NAMESPACE_STD


110 
__exùy³
 (
i§Êum
);

111 
__exùy³
 (
i§Íha
);

112 
__exùy³
 (
isúŒl
);

113 
__exùy³
 (
isdig™
);

114 
__exùy³
 (
i¦ow”
);

115 
__exùy³
 (
isg¿ph
);

116 
__exùy³
 (
i¥ršt
);

117 
__exùy³
 (
i¥unù
);

118 
__exùy³
 (
is¥aû
);

119 
__exùy³
 (
isuµ”
);

120 
__exùy³
 (
isxdig™
);

124 
	$tŞow”
 (
__c
è
__THROW
;

127 
	$touµ”
 (
__c
è
__THROW
;

129 
__END_NAMESPACE_STD


133 #ifdef 
__USE_ISOC99


134 
__BEGIN_NAMESPACE_C99


136 
	`__exùy³
 (
isbÏnk
);

138 
__END_NAMESPACE_C99


141 #ifdeà
__USE_GNU


143 
	$isùy³
 (
__c
, 
__mask
è
__THROW
;

146 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


150 
	$i§scii
 (
__c
è
__THROW
;

154 
	$tßscii
 (
__c
è
__THROW
;

158 
	`__exùy³
 (
_touµ”
);

159 
	`__exùy³
 (
_tŞow”
);

163 
	#__tobody
(
c
, 
f
, 
a
, 
¬gs
) \

164 (
__ex‹nsiÚ__
 \

165 ({ 
__»s
; \

166 ià( (
c
) > 1) \

168 ià(
	`__butš_cÚ¡ªt_p
 (
c
)) \

170 
__c
 = (
c
); \

171 
__»s
 = 
__c
 < -128 || __ø> 255 ? __ø: (
a
)[__c]; \

174 
__»s
 = 
f
 
¬gs
; \

177 
__»s
 = (
a
)[(è(
c
)]; \

178 
__»s
; 
	}
}))

	)

180 #ià!
defšed
 
__NO_CTYPE


181 #ifdeà
__isùy³_f


182 
	$__isùy³_f
 (
®num
)

183 
	$__isùy³_f
 (
®pha
)

184 
	$__isùy³_f
 (
úŒl
)

185 
	$__isùy³_f
 (
dig™
)

186 
	$__isùy³_f
 (
low”
)

187 
	$__isùy³_f
 (
g¿ph
)

188 
	$__isùy³_f
 (
´št
)

189 
	$__isùy³_f
 (
punù
)

190 
	$__isùy³_f
 (
¥aû
)

191 
	$__isùy³_f
 (
uµ”
)

192 
	$__isùy³_f
 (
xdig™
)

193 #ifdeà
__USE_ISOC99


194 
	$__isùy³_f
 (
bÏnk
)

196 #–ià
defšed
 
__isùy³


197 
	#i§Êum
(
c
è
	`__isùy³
((c), 
_IS®num
)

	)

198 
	#i§Íha
(
c
è
	`__isùy³
((c), 
_IS®pha
)

	)

199 
	#isúŒl
(
c
è
	`__isùy³
((c), 
_ISúŒl
)

	)

200 
	#isdig™
(
c
è
	`__isùy³
((c), 
_ISdig™
)

	)

201 
	#i¦ow”
(
c
è
	`__isùy³
((c), 
_ISlow”
)

	)

202 
	#isg¿ph
(
c
è
	`__isùy³
((c), 
_ISg¿ph
)

	)

203 
	#i¥ršt
(
c
è
	`__isùy³
((c), 
_IS´št
)

	)

204 
	#i¥unù
(
c
è
	`__isùy³
((c), 
_ISpunù
)

	)

205 
	#is¥aû
(
c
è
	`__isùy³
((c), 
_IS¥aû
)

	)

206 
	#isuµ”
(
c
è
	`__isùy³
((c), 
_ISuµ”
)

	)

207 
	#isxdig™
(
c
è
	`__isùy³
((c), 
_ISxdig™
)

	)

208 #ifdeà
__USE_ISOC99


209 
	#isbÏnk
(
c
è
	`__isùy³
((c), 
_ISbÏnk
)

	)

213 #ifdeà
__USE_EXTERN_INLINES


214 
__ex‹º_šlše
 

215 
	`__NTH
 (
	$tŞow”
 (
__c
))

217  
__c
 >ğ-128 && __ø< 256 ? (*
	`__ùy³_tŞow”_loc
 ())[__c] : __c;

218 
	}
}

220 
__ex‹º_šlše
 

221 
__NTH
 (
	$touµ”
 (
__c
))

223  
__c
 >ğ-128 && __ø< 256 ? (*
	`__ùy³_touµ”_loc
 ())[__c] : __c;

224 
	}
}

227 #ià
__GNUC__
 >ğ2 && 
defšed
 
__OPTIMIZE__
 && !defšed 
__ılu¥lus


228 
	#tŞow”
(
c
è
	`__tobody
 (c, 
tŞow”
, *
	`__ùy³_tŞow”_loc
 (), (c))

	)

229 
	#touµ”
(
c
è
	`__tobody
 (c, 
touµ”
, *
	`__ùy³_touµ”_loc
 (), (c))

	)

232 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


233 
	#i§scii
(
c
è
	`__i§scii
 (c)

	)

234 
	#tßscii
(
c
è
	`__tßscii
 (c)

	)

236 
	#_tŞow”
(
c
è((è(*
	`__ùy³_tŞow”_loc
 ())[(è(c)])

	)

237 
	#_touµ”
(
c
è((è(*
	`__ùy³_touµ”_loc
 ())[(è(c)])

	)

243 #ifdeà
__USE_XOPEN2K8


257 
	~<xloÿË.h
>

261 
	#__isùy³_l
(
c
, 
ty³
, 
loÿË
) \

262 ((
loÿË
)->
__ùy³_b
[(è(
c
)] & (è
ty³
)

	)

264 
	#__exùy³_l
(
Çme
) \

265 
	`Çme
 (, 
__loÿË_t
è
__THROW


	)

271 
__exùy³_l
 (
i§Êum_l
);

272 
__exùy³_l
 (
i§Íha_l
);

273 
__exùy³_l
 (
isúŒl_l
);

274 
__exùy³_l
 (
isdig™_l
);

275 
__exùy³_l
 (
i¦ow”_l
);

276 
__exùy³_l
 (
isg¿ph_l
);

277 
__exùy³_l
 (
i¥ršt_l
);

278 
__exùy³_l
 (
i¥unù_l
);

279 
__exùy³_l
 (
is¥aû_l
);

280 
__exùy³_l
 (
isuµ”_l
);

281 
__exùy³_l
 (
isxdig™_l
);

283 
__exùy³_l
 (
isbÏnk_l
);

287 
	$__tŞow”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

288 
	$tŞow”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

291 
	$__touµ”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

292 
	$touµ”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

294 #ià
__GNUC__
 >ğ2 && 
defšed
 
__OPTIMIZE__
 && !defšed 
__ılu¥lus


295 
	#__tŞow”_l
(
c
, 
loÿË
) \

296 
	`__tobody
 (
c
, 
__tŞow”_l
, (
loÿË
)->
__ùy³_tŞow”
, (c,†oÿË))

	)

297 
	#__touµ”_l
(
c
, 
loÿË
) \

298 
	`__tobody
 (
c
, 
__touµ”_l
, (
loÿË
)->
__ùy³_touµ”
, (c,†oÿË))

	)

299 
	#tŞow”_l
(
c
, 
loÿË
è
	`__tŞow”_l
 ((c), (loÿË))

	)

300 
	#touµ”_l
(
c
, 
loÿË
è
	`__touµ”_l
 ((c), (loÿË))

	)

304 #iâdeà
__NO_CTYPE


305 
	#__i§Êum_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS®num
, (l))

	)

306 
	#__i§Íha_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS®pha
, (l))

	)

307 
	#__isúŒl_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISúŒl
, (l))

	)

308 
	#__isdig™_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISdig™
, (l))

	)

309 
	#__i¦ow”_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISlow”
, (l))

	)

310 
	#__isg¿ph_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISg¿ph
, (l))

	)

311 
	#__i¥ršt_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS´št
, (l))

	)

312 
	#__i¥unù_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISpunù
, (l))

	)

313 
	#__is¥aû_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS¥aû
, (l))

	)

314 
	#__isuµ”_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISuµ”
, (l))

	)

315 
	#__isxdig™_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISxdig™
, (l))

	)

317 
	#__isbÏnk_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISbÏnk
, (l))

	)

319 #ifdeà
__USE_MISC


320 
	#__i§scii_l
(
c
,
l
è(Ö), 
	`__i§scii
 (c))

	)

321 
	#__tßscii_l
(
c
,
l
è(Ö), 
	`__tßscii
 (c))

	)

324 
	#i§Êum_l
(
c
,
l
è
	`__i§Êum_l
 ((c), (l))

	)

325 
	#i§Íha_l
(
c
,
l
è
	`__i§Íha_l
 ((c), (l))

	)

326 
	#isúŒl_l
(
c
,
l
è
	`__isúŒl_l
 ((c), (l))

	)

327 
	#isdig™_l
(
c
,
l
è
	`__isdig™_l
 ((c), (l))

	)

328 
	#i¦ow”_l
(
c
,
l
è
	`__i¦ow”_l
 ((c), (l))

	)

329 
	#isg¿ph_l
(
c
,
l
è
	`__isg¿ph_l
 ((c), (l))

	)

330 
	#i¥ršt_l
(
c
,
l
è
	`__i¥ršt_l
 ((c), (l))

	)

331 
	#i¥unù_l
(
c
,
l
è
	`__i¥unù_l
 ((c), (l))

	)

332 
	#is¥aû_l
(
c
,
l
è
	`__is¥aû_l
 ((c), (l))

	)

333 
	#isuµ”_l
(
c
,
l
è
	`__isuµ”_l
 ((c), (l))

	)

334 
	#isxdig™_l
(
c
,
l
è
	`__isxdig™_l
 ((c), (l))

	)

336 
	#isbÏnk_l
(
c
,
l
è
	`__isbÏnk_l
 ((c), (l))

	)

338 #ifdeà
__USE_MISC


339 
	#i§scii_l
(
c
,
l
è
	`__i§scii_l
 ((c), (l))

	)

340 
	#tßscii_l
(
c
,
l
è
	`__tßscii_l
 ((c), (l))

	)

347 
__END_DECLS


	@/usr/include/dlfcn.h

19 #iâdef 
_DLFCN_H


20 
	#_DLFCN_H
 1

	)

22 
	~<ã©u»s.h
>

23 
	#__Ãed_size_t


	)

24 
	~<¡ddef.h
>

27 
	~<b™s/dlfú.h
>

30 #ifdeà
__USE_GNU


35 
	#RTLD_NEXT
 ((*è-1l)

	)

40 
	#RTLD_DEFAULT
 ((*è0)

	)

44 
	tLmid_t
;

47 
	#LM_ID_BASE
 0

	)

48 
	#LM_ID_NEWLM
 -1

	)

52 
__BEGIN_DECLS


56 *
	$dlİ’
 (cÚ¡ *
__fe
, 
__mode
è
__THROWNL
;

60 
	$dlşo£
 (*
__hªdË
è
__THROWNL
 
	`__nÚnuÎ
 ((1));

64 *
	$dlsym
 (*
__»¡riù
 
__hªdË
,

65 cÚ¡ *
__»¡riù
 
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((2));

67 #ifdeà
__USE_GNU


69 *
	$dlmİ’
 (
Lmid_t
 
__nsid
, cÚ¡ *
__fe
, 
__mode
è
__THROWNL
;

73 *
	$dlvsym
 (*
__»¡riù
 
__hªdË
,

74 cÚ¡ *
__»¡riù
 
__Çme
,

75 cÚ¡ *
__»¡riù
 
__v”siÚ
)

76 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

82 *
	$dË¼Ü
 (è
__THROW
;

85 #ifdeà
__USE_GNU


90 cÚ¡ *
dli_âame
;

91 *
dli_fba£
;

92 cÚ¡ *
dli_¢ame
;

93 *
dli_§ddr
;

94 } 
	tDl_šfo
;

98 
	$dÏddr
 (cÚ¡ *
__add»ss
, 
Dl_šfo
 *
__šfo
)

99 
__THROW
 
	`__nÚnuÎ
 ((2));

102 
	$dÏddr1
 (cÚ¡ *
__add»ss
, 
Dl_šfo
 *
__šfo
,

103 **
__exŒa_šfo
, 
__æags
è
__THROW
 
	`__nÚnuÎ
 ((2));

111 
RTLD_DL_SYMENT
 = 1,

114 
RTLD_DL_LINKMAP
 = 2

123 
	$dlšfo
 (*
__»¡riù
 
__hªdË
,

124 
__»que¡
, *
__»¡riù
 
__¬g
)

125 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

131 
RTLD_DI_LMID
 = 1,

135 
RTLD_DI_LINKMAP
 = 2,

137 
RTLD_DI_CONFIGADDR
 = 3,

144 
RTLD_DI_SERINFO
 = 4,

145 
RTLD_DI_SERINFOSIZE
 = 5,

149 
RTLD_DI_ORIGIN
 = 6,

151 
RTLD_DI_PROFILENAME
 = 7,

152 
RTLD_DI_PROFILEOUT
 = 8,

157 
RTLD_DI_TLS_MODID
 = 9,

163 
RTLD_DI_TLS_DATA
 = 10,

165 
RTLD_DI_MAX
 = 10

173 *
dls_Çme
;

174 
dls_æags
;

175 } 
	tDl_£½©h
;

181 
size_t
 
dls_size
;

182 
dls_út
;

183 
Dl_£½©h
 
dls_£½©h
[1];

184 } 
	tDl_£ršfo
;

188 
__END_DECLS


	@/usr/include/endian.h

18 #iâdef 
_ENDIAN_H


19 
	#_ENDIAN_H
 1

	)

21 
	~<ã©u»s.h
>

31 
	#__LITTLE_ENDIAN
 1234

	)

32 
	#__BIG_ENDIAN
 4321

	)

33 
	#__PDP_ENDIAN
 3412

	)

36 
	~<b™s/’dŸn.h
>

40 #iâdeà
__FLOAT_WORD_ORDER


41 
	#__FLOAT_WORD_ORDER
 
__BYTE_ORDER


	)

44 #ifdef 
__USE_MISC


45 
	#LITTLE_ENDIAN
 
__LITTLE_ENDIAN


	)

46 
	#BIG_ENDIAN
 
__BIG_ENDIAN


	)

47 
	#PDP_ENDIAN
 
__PDP_ENDIAN


	)

48 
	#BYTE_ORDER
 
__BYTE_ORDER


	)

51 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


52 
	#__LONG_LONG_PAIR
(
HI
, 
LO
èLO, 
	)
HI

53 #–ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


54 
	#__LONG_LONG_PAIR
(
HI
, 
LO
èHI, 
	)
LO

58 #ià
defšed
 
__USE_MISC
 && !defšed 
__ASSEMBLER__


60 
	~<b™s/by‹sw­.h
>

62 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


63 
	#htobe16
(
x
è
	`__bsw­_16
 (x)

	)

64 
	#htŞe16
(
x
è(x)

	)

65 
	#be16toh
(
x
è
	`__bsw­_16
 (x)

	)

66 
	#Ë16toh
(
x
è(x)

	)

68 
	#htobe32
(
x
è
	`__bsw­_32
 (x)

	)

69 
	#htŞe32
(
x
è(x)

	)

70 
	#be32toh
(
x
è
	`__bsw­_32
 (x)

	)

71 
	#Ë32toh
(
x
è(x)

	)

73 
	#htobe64
(
x
è
	`__bsw­_64
 (x)

	)

74 
	#htŞe64
(
x
è(x)

	)

75 
	#be64toh
(
x
è
	`__bsw­_64
 (x)

	)

76 
	#Ë64toh
(
x
è(x)

	)

79 
	#htobe16
(
x
è(x)

	)

80 
	#htŞe16
(
x
è
	`__bsw­_16
 (x)

	)

81 
	#be16toh
(
x
è(x)

	)

82 
	#Ë16toh
(
x
è
	`__bsw­_16
 (x)

	)

84 
	#htobe32
(
x
è(x)

	)

85 
	#htŞe32
(
x
è
	`__bsw­_32
 (x)

	)

86 
	#be32toh
(
x
è(x)

	)

87 
	#Ë32toh
(
x
è
	`__bsw­_32
 (x)

	)

89 
	#htobe64
(
x
è(x)

	)

90 
	#htŞe64
(
x
è
	`__bsw­_64
 (x)

	)

91 
	#be64toh
(
x
è(x)

	)

92 
	#Ë64toh
(
x
è
	`__bsw­_64
 (x)

	)

	@/usr/include/errno.h

22 #iâdef 
_ERRNO_H


26 #iâdef 
__Ãed_Em©h


27 
	#_ERRNO_H
 1

	)

28 
	~<ã©u»s.h
>

31 
	g__BEGIN_DECLS


35 
	~<b™s/”ºo.h
>

36 #undeà
__Ãed_Em©h


38 #ifdef 
_ERRNO_H


45 #iâdef 
”ºo


46 
”ºo
;

49 #ifdeà
__USE_GNU


54 *
´og¿m_švoÿtiÚ_Çme
, *
´og¿m_švoÿtiÚ_shÜt_Çme
;

58 
	g__END_DECLS


66 #ià
defšed
 
__USE_GNU
 || defšed 
__Ãed_”rÜ_t


67 #iâdeà
__”rÜ_t_defšed


68 
	t”rÜ_t
;

69 
	#__”rÜ_t_defšed
 1

	)

71 #undeà
__Ãed_”rÜ_t


	@/usr/include/execinfo.h

18 #iâdeà
_EXECINFO_H


19 
	#_EXECINFO_H
 1

	)

21 
	~<ã©u»s.h
>

23 
__BEGIN_DECLS


27 
	$backŒaû
 (**
__¬¿y
, 
__size
è
	`__nÚnuÎ
 ((1));

32 **
	$backŒaû_symbŞs
 (*cÚ¡ *
__¬¿y
, 
__size
)

33 
__THROW
 
	`__nÚnuÎ
 ((1));

38 
	$backŒaû_symbŞs_fd
 (*cÚ¡ *
__¬¿y
, 
__size
, 
__fd
)

39 
__THROW
 
	`__nÚnuÎ
 ((1));

41 
__END_DECLS


	@/usr/include/fcntl.h

22 #iâdef 
_FCNTL_H


23 
	#_FCNTL_H
 1

	)

25 
	~<ã©u»s.h
>

28 
	g__BEGIN_DECLS


31 
	~<b™s/ty³s.h
>

35 
	~<b™s/fú.h
>

39 #ifdeà
__O_TMPFILE


40 
	#__OPEN_NEEDS_MODE
(
oæag
) \

41 (((
oæag
è& 
O_CREAT
è!ğ0 || ((oæagè& 
__O_TMPFILE
è=ğ__O_TMPFILE)

	)

43 
	#__OPEN_NEEDS_MODE
(
oæag
è(((oæagè& 
O_CREAT
è!ğ0)

	)

49 #iâdeà
__mode_t_defšed


50 
__mode_t
 
	tmode_t
;

51 
	#__mode_t_defšed


	)

54 #iâdeà
__off_t_defšed


55 #iâdeà
__USE_FILE_OFFSET64


56 
__off_t
 
	toff_t
;

58 
__off64_t
 
	toff_t
;

60 
	#__off_t_defšed


	)

63 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__off64_t_defšed


64 
__off64_t
 
	toff64_t
;

65 
	#__off64_t_defšed


	)

68 #iâdeà
__pid_t_defšed


69 
__pid_t
 
	tpid_t
;

70 
	#__pid_t_defšed


	)

74 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


75 
	#__Ãed_time¥ec


	)

76 
	~<time.h
>

77 
	~<b™s/¡©.h
>

79 
	#S_IFMT
 
__S_IFMT


	)

80 
	#S_IFDIR
 
__S_IFDIR


	)

81 
	#S_IFCHR
 
__S_IFCHR


	)

82 
	#S_IFBLK
 
__S_IFBLK


	)

83 
	#S_IFREG
 
__S_IFREG


	)

84 #ifdeà
__S_IFIFO


85 
	#S_IFIFO
 
__S_IFIFO


	)

87 #ifdeà
__S_IFLNK


88 
	#S_IFLNK
 
__S_IFLNK


	)

90 #ià(
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8
è&& defšed 
__S_IFSOCK


91 
	#S_IFSOCK
 
__S_IFSOCK


	)

96 
	#S_ISUID
 
__S_ISUID


	)

97 
	#S_ISGID
 
__S_ISGID


	)

99 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


101 
	#S_ISVTX
 
__S_ISVTX


	)

104 
	#S_IRUSR
 
__S_IREAD


	)

105 
	#S_IWUSR
 
__S_IWRITE


	)

106 
	#S_IXUSR
 
__S_IEXEC


	)

108 
	#S_IRWXU
 (
__S_IREAD
|
__S_IWRITE
|
__S_IEXEC
)

	)

110 
	#S_IRGRP
 (
S_IRUSR
 >> 3è

	)

111 
	#S_IWGRP
 (
S_IWUSR
 >> 3è

	)

112 
	#S_IXGRP
 (
S_IXUSR
 >> 3è

	)

114 
	#S_IRWXG
 (
S_IRWXU
 >> 3)

	)

116 
	#S_IROTH
 (
S_IRGRP
 >> 3è

	)

117 
	#S_IWOTH
 (
S_IWGRP
 >> 3è

	)

118 
	#S_IXOTH
 (
S_IXGRP
 >> 3è

	)

120 
	#S_IRWXO
 (
S_IRWXG
 >> 3)

	)

123 #ifdef 
__USE_MISC


124 #iâdeà
R_OK


127 
	#R_OK
 4

	)

128 
	#W_OK
 2

	)

129 
	#X_OK
 1

	)

130 
	#F_OK
 0

	)

135 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


136 
	#SEEK_SET
 0

	)

137 
	#SEEK_CUR
 1

	)

138 
	#SEEK_END
 2

	)

146 
fú
 (
__fd
, 
__cmd
, ...);

155 #iâdeà
__USE_FILE_OFFSET64


156 
	$İ’
 (cÚ¡ *
__fe
, 
__oæag
, ...è
	`__nÚnuÎ
 ((1));

158 #ifdeà
__REDIRECT


159 
	`__REDIRECT
 (
İ’
, (cÚ¡ *
__fe
, 
__oæag
, ...), 
İ’64
)

160 
	`__nÚnuÎ
 ((1));

162 
	#İ’
 
İ’64


	)

165 #ifdeà
__USE_LARGEFILE64


166 
	$İ’64
 (cÚ¡ *
__fe
, 
__oæag
, ...è
	`__nÚnuÎ
 ((1));

169 #ifdeà
__USE_ATFILE


179 #iâdeà
__USE_FILE_OFFSET64


180 
	$İ’©
 (
__fd
, cÚ¡ *
__fe
, 
__oæag
, ...)

181 
	`__nÚnuÎ
 ((2));

183 #ifdeà
__REDIRECT


184 
	`__REDIRECT
 (
İ’©
, (
__fd
, cÚ¡ *
__fe
, 
__oæag
,

185 ...), 
İ’©64
è
	`__nÚnuÎ
 ((2));

187 
	#İ’©
 
İ’©64


	)

190 #ifdeà
__USE_LARGEFILE64


191 
	$İ’©64
 (
__fd
, cÚ¡ *
__fe
, 
__oæag
, ...)

192 
	`__nÚnuÎ
 ((2));

201 #iâdeà
__USE_FILE_OFFSET64


202 
	$ü—t
 (cÚ¡ *
__fe
, 
mode_t
 
__mode
è
	`__nÚnuÎ
 ((1));

204 #ifdeà
__REDIRECT


205 
	`__REDIRECT
 (
ü—t
, (cÚ¡ *
__fe
, 
mode_t
 
__mode
),

206 
ü—t64
è
	`__nÚnuÎ
 ((1));

208 
	#ü—t
 
ü—t64


	)

211 #ifdeà
__USE_LARGEFILE64


212 
	$ü—t64
 (cÚ¡ *
__fe
, 
mode_t
 
__mode
è
	`__nÚnuÎ
 ((1));

215 #ià!
defšed
 
F_LOCK
 && (defšed 
__USE_MISC
 || (defšed 
__USE_XOPEN_EXTENDED
 \

216 && !
defšed
 
__USE_POSIX
))

225 
	#F_ULOCK
 0

	)

226 
	#F_LOCK
 1

	)

227 
	#F_TLOCK
 2

	)

228 
	#F_TEST
 3

	)

230 #iâdeà
__USE_FILE_OFFSET64


231 
	`lockf
 (
__fd
, 
__cmd
, 
off_t
 
__Ën
);

233 #ifdeà
__REDIRECT


234 
	`__REDIRECT
 (
lockf
, (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
), 
lockf64
);

236 
	#lockf
 
lockf64


	)

239 #ifdeà
__USE_LARGEFILE64


240 
	`lockf64
 (
__fd
, 
__cmd
, 
off64_t
 
__Ën
);

244 #ifdeà
__USE_XOPEN2K


247 #iâdeà
__USE_FILE_OFFSET64


248 
	$posix_çdvi£
 (
__fd
, 
off_t
 
__off£t
, off_ˆ
__Ën
,

249 
__advi£
è
__THROW
;

251 #ifdeà
__REDIRECT_NTH


252 
	`__REDIRECT_NTH
 (
posix_çdvi£
, (
__fd
, 
__off64_t
 
__off£t
,

253 
__off64_t
 
__Ën
, 
__advi£
),

254 
posix_çdvi£64
);

256 
	#posix_çdvi£
 
posix_çdvi£64


	)

259 #ifdeà
__USE_LARGEFILE64


260 
	$posix_çdvi£64
 (
__fd
, 
off64_t
 
__off£t
, off64_ˆ
__Ën
,

261 
__advi£
è
__THROW
;

269 #iâdeà
__USE_FILE_OFFSET64


270 
	`posix_çÎoÿ‹
 (
__fd
, 
off_t
 
__off£t
, off_ˆ
__Ën
);

272 #ifdeà
__REDIRECT


273 
	`__REDIRECT
 (
posix_çÎoÿ‹
, (
__fd
, 
__off64_t
 
__off£t
,

274 
__off64_t
 
__Ën
),

275 
posix_çÎoÿ‹64
);

277 
	#posix_çÎoÿ‹
 
posix_çÎoÿ‹64


	)

280 #ifdeà
__USE_LARGEFILE64


281 
	`posix_çÎoÿ‹64
 (
__fd
, 
off64_t
 
__off£t
, off64_ˆ
__Ën
);

287 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ
 \

288 && 
defšed
 
__va_¬g_·ck_Ën


289 
	~<b™s/fú2.h
>

292 
__END_DECLS


	@/usr/include/features.h

18 #iâdef 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

97 #undeà
__USE_ISOC11


98 #undeà
__USE_ISOC99


99 #undeà
__USE_ISOC95


100 #undeà
__USE_ISOCXX11


101 #undeà
__USE_POSIX


102 #undeà
__USE_POSIX2


103 #undeà
__USE_POSIX199309


104 #undeà
__USE_POSIX199506


105 #undeà
__USE_XOPEN


106 #undeà
__USE_XOPEN_EXTENDED


107 #undeà
__USE_UNIX98


108 #undeà
__USE_XOPEN2K


109 #undeà
__USE_XOPEN2KXSI


110 #undeà
__USE_XOPEN2K8


111 #undeà
__USE_XOPEN2K8XSI


112 #undeà
__USE_LARGEFILE


113 #undeà
__USE_LARGEFILE64


114 #undeà
__USE_FILE_OFFSET64


115 #undeà
__USE_MISC


116 #undeà
__USE_ATFILE


117 #undeà
__USE_GNU


118 #undeà
__USE_REENTRANT


119 #undeà
__USE_FORTIFY_LEVEL


120 #undeà
__KERNEL_STRICT_NAMES


124 #iâdeà
_LOOSE_KERNEL_NAMES


125 
	#__KERNEL_STRICT_NAMES


	)

135 #ià
defšed
 
__GNUC__
 && defšed 
__GNUC_MINOR__


136 
	#__GNUC_PREREQ
(
maj
, 
mš
) \

137 ((
__GNUC__
 << 16è+ 
__GNUC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

139 
	#__GNUC_PREREQ
(
maj
, 
mš
è0

	)

146 #ià(
defšed
 
_BSD_SOURCE
 || defšed 
_SVID_SOURCE
) \

147 && !
defšed
 
	g_DEFAULT_SOURCE


152 #undeà
_DEFAULT_SOURCE


153 
	#_DEFAULT_SOURCE
 1

	)

157 #ifdeà
_GNU_SOURCE


158 #undeà
_ISOC95_SOURCE


159 
	#_ISOC95_SOURCE
 1

	)

160 #undeà
_ISOC99_SOURCE


161 
	#_ISOC99_SOURCE
 1

	)

162 #undeà
_ISOC11_SOURCE


163 
	#_ISOC11_SOURCE
 1

	)

164 #undeà
_POSIX_SOURCE


165 
	#_POSIX_SOURCE
 1

	)

166 #undeà
_POSIX_C_SOURCE


167 
	#_POSIX_C_SOURCE
 200809L

	)

168 #undeà
_XOPEN_SOURCE


169 
	#_XOPEN_SOURCE
 700

	)

170 #undeà
_XOPEN_SOURCE_EXTENDED


171 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

172 #undeà
_LARGEFILE64_SOURCE


173 
	#_LARGEFILE64_SOURCE
 1

	)

174 #undeà
_DEFAULT_SOURCE


175 
	#_DEFAULT_SOURCE
 1

	)

176 #undeà
_ATFILE_SOURCE


177 
	#_ATFILE_SOURCE
 1

	)

182 #ià(
defšed
 
_DEFAULT_SOURCE
 \

183 || (!
defšed
 
	g__STRICT_ANSI__
 \

184 && !
defšed
 
	g_ISOC99_SOURCE
 \

185 && !
defšed
 
	g_POSIX_SOURCE
 && !defšed 
	g_POSIX_C_SOURCE
 \

186 && !
defšed
 
	g_XOPEN_SOURCE
))

187 #undeà
_DEFAULT_SOURCE


188 
	#_DEFAULT_SOURCE
 1

	)

192 #ià(
defšed
 
_ISOC11_SOURCE
 \

193 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

194 
	#__USE_ISOC11
 1

	)

198 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

199 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

200 
	#__USE_ISOC99
 1

	)

204 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

205 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

206 
	#__USE_ISOC95
 1

	)

213 #ià((
defšed
 
__ılu¥lus
 && __cplusplus >= 201103L) \

214 || 
defšed
 
__GXX_EXPERIMENTAL_CXX0X__
)

215 
	#__USE_ISOCXX11
 1

	)

221 #ifdeà
_DEFAULT_SOURCE


222 #ià!
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE


223 
	#__USE_POSIX_IMPLICITLY
 1

	)

225 #undeà
_POSIX_SOURCE


226 
	#_POSIX_SOURCE
 1

	)

227 #undeà
_POSIX_C_SOURCE


228 
	#_POSIX_C_SOURCE
 200809L

	)

230 #ià((!
defšed
 
__STRICT_ANSI__
 \

231 || (
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) >= 500)) \

232 && !
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE
)

233 
	#_POSIX_SOURCE
 1

	)

234 #ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

235 
	#_POSIX_C_SOURCE
 2

	)

236 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

237 
	#_POSIX_C_SOURCE
 199506L

	)

238 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

239 
	#_POSIX_C_SOURCE
 200112L

	)

241 
	#_POSIX_C_SOURCE
 200809L

	)

243 
	#__USE_POSIX_IMPLICITLY
 1

	)

246 #ià(
defšed
 
_POSIX_SOURCE
 \

247 || (
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >= 1) \

248 || 
defšed
 
_XOPEN_SOURCE
)

249 
	#__USE_POSIX
 1

	)

252 #ià
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >ğ2 || defšed 
_XOPEN_SOURCE


253 
	#__USE_POSIX2
 1

	)

256 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199309L

257 
	#__USE_POSIX199309
 1

	)

260 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199506L

261 
	#__USE_POSIX199506
 1

	)

264 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200112L

265 
	#__USE_XOPEN2K
 1

	)

266 #undeà
__USE_ISOC95


267 
	#__USE_ISOC95
 1

	)

268 #undeà
__USE_ISOC99


269 
	#__USE_ISOC99
 1

	)

272 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200809L

273 
	#__USE_XOPEN2K8
 1

	)

274 #undeà
_ATFILE_SOURCE


275 
	#_ATFILE_SOURCE
 1

	)

278 #ifdef 
_XOPEN_SOURCE


279 
	#__USE_XOPEN
 1

	)

280 #ià(
_XOPEN_SOURCE
 - 0) >= 500

281 
	#__USE_XOPEN_EXTENDED
 1

	)

282 
	#__USE_UNIX98
 1

	)

283 #undeà
_LARGEFILE_SOURCE


284 
	#_LARGEFILE_SOURCE
 1

	)

285 #ià(
_XOPEN_SOURCE
 - 0) >= 600

286 #ià(
_XOPEN_SOURCE
 - 0) >= 700

287 
	#__USE_XOPEN2K8
 1

	)

288 
	#__USE_XOPEN2K8XSI
 1

	)

290 
	#__USE_XOPEN2K
 1

	)

291 
	#__USE_XOPEN2KXSI
 1

	)

292 #undeà
__USE_ISOC95


293 
	#__USE_ISOC95
 1

	)

294 #undeà
__USE_ISOC99


295 
	#__USE_ISOC99
 1

	)

298 #ifdeà
_XOPEN_SOURCE_EXTENDED


299 
	#__USE_XOPEN_EXTENDED
 1

	)

304 #ifdeà
_LARGEFILE_SOURCE


305 
	#__USE_LARGEFILE
 1

	)

308 #ifdeà
_LARGEFILE64_SOURCE


309 
	#__USE_LARGEFILE64
 1

	)

312 #ià
defšed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

313 
	#__USE_FILE_OFFSET64
 1

	)

316 #ià
defšed
 
_DEFAULT_SOURCE


317 
	#__USE_MISC
 1

	)

320 #ifdef 
_ATFILE_SOURCE


321 
	#__USE_ATFILE
 1

	)

324 #ifdef 
_GNU_SOURCE


325 
	#__USE_GNU
 1

	)

328 #ià
defšed
 
_REENTRANT
 || defšed 
_THREAD_SAFE


329 
	#__USE_REENTRANT
 1

	)

332 #ià
defšed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

333 && 
__GNUC_PREREQ
 (4, 1è&& 
defšed
 
	g__OPTIMIZE__
 && __OPTIMIZE__ > 0

334 #ià
_FORTIFY_SOURCE
 > 1

335 
	#__USE_FORTIFY_LEVEL
 2

	)

337 
	#__USE_FORTIFY_LEVEL
 1

	)

340 
	#__USE_FORTIFY_LEVEL
 0

	)

345 
	~<¡dc-´edef.h
>

353 #undeà
__GNU_LIBRARY__


354 
	#__GNU_LIBRARY__
 6

	)

358 
	#__GLIBC__
 2

	)

359 
	#__GLIBC_MINOR__
 23

	)

361 
	#__GLIBC_PREREQ
(
maj
, 
mš
) \

362 ((
__GLIBC__
 << 16è+ 
__GLIBC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

365 #iâdeà
__ASSEMBLER__


366 #iâdeà
_SYS_CDEFS_H


367 
	~<sys/cdefs.h
>

372 #ià
defšed
 
__USE_FILE_OFFSET64
 && !defšed 
__REDIRECT


373 
	#__USE_LARGEFILE
 1

	)

374 
	#__USE_LARGEFILE64
 1

	)

380 #ià
__GNUC_PREREQ
 (2, 7è&& 
defšed
 
__OPTIMIZE__
 \

381 && !
defšed
 
	g__OPTIMIZE_SIZE__
 && !defšed 
	g__NO_INLINE__
 \

382 && 
defšed
 
	g__ex‹º_šlše


383 
	#__USE_EXTERN_INLINES
 1

	)

391 
	~<gnu/¡ubs.h
>

	@/usr/include/inttypes.h

22 #iâdeà
_INTTYPES_H


23 
	#_INTTYPES_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	~<¡dšt.h
>

30 #iâdeà
____gwch¬_t_defšed


31 #ifdeà
__ılu¥lus


32 
	#__gwch¬_t
 
wch¬_t


	)

33 #–ià
defšed
 
__WCHAR_TYPE__


34 
__WCHAR_TYPE__
 
	t__gwch¬_t
;

36 
	#__Ãed_wch¬_t


	)

37 
	~<¡ddef.h
>

38 
wch¬_t
 
	t__gwch¬_t
;

40 
	#____gwch¬_t_defšed
 1

	)

43 #ià
__WORDSIZE
 == 64

44 
	#__PRI64_PREFIX
 "l"

	)

45 
	#__PRIPTR_PREFIX
 "l"

	)

47 
	#__PRI64_PREFIX
 "Î"

	)

48 
	#__PRIPTR_PREFIX


	)

54 
	#PRId8
 "d"

	)

55 
	#PRId16
 "d"

	)

56 
	#PRId32
 "d"

	)

57 
	#PRId64
 
__PRI64_PREFIX
 "d"

	)

59 
	#PRIdLEAST8
 "d"

	)

60 
	#PRIdLEAST16
 "d"

	)

61 
	#PRIdLEAST32
 "d"

	)

62 
	#PRIdLEAST64
 
__PRI64_PREFIX
 "d"

	)

64 
	#PRIdFAST8
 "d"

	)

65 
	#PRIdFAST16
 
__PRIPTR_PREFIX
 "d"

	)

66 
	#PRIdFAST32
 
__PRIPTR_PREFIX
 "d"

	)

67 
	#PRIdFAST64
 
__PRI64_PREFIX
 "d"

	)

70 
	#PRIi8
 "i"

	)

71 
	#PRIi16
 "i"

	)

72 
	#PRIi32
 "i"

	)

73 
	#PRIi64
 
__PRI64_PREFIX
 "i"

	)

75 
	#PRIiLEAST8
 "i"

	)

76 
	#PRIiLEAST16
 "i"

	)

77 
	#PRIiLEAST32
 "i"

	)

78 
	#PRIiLEAST64
 
__PRI64_PREFIX
 "i"

	)

80 
	#PRIiFAST8
 "i"

	)

81 
	#PRIiFAST16
 
__PRIPTR_PREFIX
 "i"

	)

82 
	#PRIiFAST32
 
__PRIPTR_PREFIX
 "i"

	)

83 
	#PRIiFAST64
 
__PRI64_PREFIX
 "i"

	)

86 
	#PRIo8
 "o"

	)

87 
	#PRIo16
 "o"

	)

88 
	#PRIo32
 "o"

	)

89 
	#PRIo64
 
__PRI64_PREFIX
 "o"

	)

91 
	#PRIoLEAST8
 "o"

	)

92 
	#PRIoLEAST16
 "o"

	)

93 
	#PRIoLEAST32
 "o"

	)

94 
	#PRIoLEAST64
 
__PRI64_PREFIX
 "o"

	)

96 
	#PRIoFAST8
 "o"

	)

97 
	#PRIoFAST16
 
__PRIPTR_PREFIX
 "o"

	)

98 
	#PRIoFAST32
 
__PRIPTR_PREFIX
 "o"

	)

99 
	#PRIoFAST64
 
__PRI64_PREFIX
 "o"

	)

102 
	#PRIu8
 "u"

	)

103 
	#PRIu16
 "u"

	)

104 
	#PRIu32
 "u"

	)

105 
	#PRIu64
 
__PRI64_PREFIX
 "u"

	)

107 
	#PRIuLEAST8
 "u"

	)

108 
	#PRIuLEAST16
 "u"

	)

109 
	#PRIuLEAST32
 "u"

	)

110 
	#PRIuLEAST64
 
__PRI64_PREFIX
 "u"

	)

112 
	#PRIuFAST8
 "u"

	)

113 
	#PRIuFAST16
 
__PRIPTR_PREFIX
 "u"

	)

114 
	#PRIuFAST32
 
__PRIPTR_PREFIX
 "u"

	)

115 
	#PRIuFAST64
 
__PRI64_PREFIX
 "u"

	)

118 
	#PRIx8
 "x"

	)

119 
	#PRIx16
 "x"

	)

120 
	#PRIx32
 "x"

	)

121 
	#PRIx64
 
__PRI64_PREFIX
 "x"

	)

123 
	#PRIxLEAST8
 "x"

	)

124 
	#PRIxLEAST16
 "x"

	)

125 
	#PRIxLEAST32
 "x"

	)

126 
	#PRIxLEAST64
 
__PRI64_PREFIX
 "x"

	)

128 
	#PRIxFAST8
 "x"

	)

129 
	#PRIxFAST16
 
__PRIPTR_PREFIX
 "x"

	)

130 
	#PRIxFAST32
 
__PRIPTR_PREFIX
 "x"

	)

131 
	#PRIxFAST64
 
__PRI64_PREFIX
 "x"

	)

134 
	#PRIX8
 "X"

	)

135 
	#PRIX16
 "X"

	)

136 
	#PRIX32
 "X"

	)

137 
	#PRIX64
 
__PRI64_PREFIX
 "X"

	)

139 
	#PRIXLEAST8
 "X"

	)

140 
	#PRIXLEAST16
 "X"

	)

141 
	#PRIXLEAST32
 "X"

	)

142 
	#PRIXLEAST64
 
__PRI64_PREFIX
 "X"

	)

144 
	#PRIXFAST8
 "X"

	)

145 
	#PRIXFAST16
 
__PRIPTR_PREFIX
 "X"

	)

146 
	#PRIXFAST32
 
__PRIPTR_PREFIX
 "X"

	)

147 
	#PRIXFAST64
 
__PRI64_PREFIX
 "X"

	)

151 
	#PRIdMAX
 
__PRI64_PREFIX
 "d"

	)

152 
	#PRIiMAX
 
__PRI64_PREFIX
 "i"

	)

153 
	#PRIoMAX
 
__PRI64_PREFIX
 "o"

	)

154 
	#PRIuMAX
 
__PRI64_PREFIX
 "u"

	)

155 
	#PRIxMAX
 
__PRI64_PREFIX
 "x"

	)

156 
	#PRIXMAX
 
__PRI64_PREFIX
 "X"

	)

160 
	#PRIdPTR
 
__PRIPTR_PREFIX
 "d"

	)

161 
	#PRIiPTR
 
__PRIPTR_PREFIX
 "i"

	)

162 
	#PRIoPTR
 
__PRIPTR_PREFIX
 "o"

	)

163 
	#PRIuPTR
 
__PRIPTR_PREFIX
 "u"

	)

164 
	#PRIxPTR
 
__PRIPTR_PREFIX
 "x"

	)

165 
	#PRIXPTR
 
__PRIPTR_PREFIX
 "X"

	)

171 
	#SCNd8
 "hhd"

	)

172 
	#SCNd16
 "hd"

	)

173 
	#SCNd32
 "d"

	)

174 
	#SCNd64
 
__PRI64_PREFIX
 "d"

	)

176 
	#SCNdLEAST8
 "hhd"

	)

177 
	#SCNdLEAST16
 "hd"

	)

178 
	#SCNdLEAST32
 "d"

	)

179 
	#SCNdLEAST64
 
__PRI64_PREFIX
 "d"

	)

181 
	#SCNdFAST8
 "hhd"

	)

182 
	#SCNdFAST16
 
__PRIPTR_PREFIX
 "d"

	)

183 
	#SCNdFAST32
 
__PRIPTR_PREFIX
 "d"

	)

184 
	#SCNdFAST64
 
__PRI64_PREFIX
 "d"

	)

187 
	#SCNi8
 "hhi"

	)

188 
	#SCNi16
 "hi"

	)

189 
	#SCNi32
 "i"

	)

190 
	#SCNi64
 
__PRI64_PREFIX
 "i"

	)

192 
	#SCNiLEAST8
 "hhi"

	)

193 
	#SCNiLEAST16
 "hi"

	)

194 
	#SCNiLEAST32
 "i"

	)

195 
	#SCNiLEAST64
 
__PRI64_PREFIX
 "i"

	)

197 
	#SCNiFAST8
 "hhi"

	)

198 
	#SCNiFAST16
 
__PRIPTR_PREFIX
 "i"

	)

199 
	#SCNiFAST32
 
__PRIPTR_PREFIX
 "i"

	)

200 
	#SCNiFAST64
 
__PRI64_PREFIX
 "i"

	)

203 
	#SCNu8
 "hhu"

	)

204 
	#SCNu16
 "hu"

	)

205 
	#SCNu32
 "u"

	)

206 
	#SCNu64
 
__PRI64_PREFIX
 "u"

	)

208 
	#SCNuLEAST8
 "hhu"

	)

209 
	#SCNuLEAST16
 "hu"

	)

210 
	#SCNuLEAST32
 "u"

	)

211 
	#SCNuLEAST64
 
__PRI64_PREFIX
 "u"

	)

213 
	#SCNuFAST8
 "hhu"

	)

214 
	#SCNuFAST16
 
__PRIPTR_PREFIX
 "u"

	)

215 
	#SCNuFAST32
 
__PRIPTR_PREFIX
 "u"

	)

216 
	#SCNuFAST64
 
__PRI64_PREFIX
 "u"

	)

219 
	#SCNo8
 "hho"

	)

220 
	#SCNo16
 "ho"

	)

221 
	#SCNo32
 "o"

	)

222 
	#SCNo64
 
__PRI64_PREFIX
 "o"

	)

224 
	#SCNoLEAST8
 "hho"

	)

225 
	#SCNoLEAST16
 "ho"

	)

226 
	#SCNoLEAST32
 "o"

	)

227 
	#SCNoLEAST64
 
__PRI64_PREFIX
 "o"

	)

229 
	#SCNoFAST8
 "hho"

	)

230 
	#SCNoFAST16
 
__PRIPTR_PREFIX
 "o"

	)

231 
	#SCNoFAST32
 
__PRIPTR_PREFIX
 "o"

	)

232 
	#SCNoFAST64
 
__PRI64_PREFIX
 "o"

	)

235 
	#SCNx8
 "hhx"

	)

236 
	#SCNx16
 "hx"

	)

237 
	#SCNx32
 "x"

	)

238 
	#SCNx64
 
__PRI64_PREFIX
 "x"

	)

240 
	#SCNxLEAST8
 "hhx"

	)

241 
	#SCNxLEAST16
 "hx"

	)

242 
	#SCNxLEAST32
 "x"

	)

243 
	#SCNxLEAST64
 
__PRI64_PREFIX
 "x"

	)

245 
	#SCNxFAST8
 "hhx"

	)

246 
	#SCNxFAST16
 
__PRIPTR_PREFIX
 "x"

	)

247 
	#SCNxFAST32
 
__PRIPTR_PREFIX
 "x"

	)

248 
	#SCNxFAST64
 
__PRI64_PREFIX
 "x"

	)

252 
	#SCNdMAX
 
__PRI64_PREFIX
 "d"

	)

253 
	#SCNiMAX
 
__PRI64_PREFIX
 "i"

	)

254 
	#SCNoMAX
 
__PRI64_PREFIX
 "o"

	)

255 
	#SCNuMAX
 
__PRI64_PREFIX
 "u"

	)

256 
	#SCNxMAX
 
__PRI64_PREFIX
 "x"

	)

259 
	#SCNdPTR
 
__PRIPTR_PREFIX
 "d"

	)

260 
	#SCNiPTR
 
__PRIPTR_PREFIX
 "i"

	)

261 
	#SCNoPTR
 
__PRIPTR_PREFIX
 "o"

	)

262 
	#SCNuPTR
 
__PRIPTR_PREFIX
 "u"

	)

263 
	#SCNxPTR
 
__PRIPTR_PREFIX
 "x"

	)

266 
	g__BEGIN_DECLS


268 #ià
__WORDSIZE
 == 64

273 
	mquÙ
;

274 
	m»m
;

275 } 
	timaxdiv_t
;

282 
__ex‹nsiÚ__
 
	mquÙ
;

283 
__ex‹nsiÚ__
 
	m»m
;

284 } 
	timaxdiv_t
;

290 
štmax_t
 
	$imaxabs
 (
štmax_t
 
__n
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

293 
imaxdiv_t
 
	$imaxdiv
 (
štmax_t
 
__num”
, iÁmax_ˆ
__d’om
)

294 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

297 
štmax_t
 
	$¡¹oimax
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

298 **
__»¡riù
 
__’d±r
, 
__ba£
è
__THROW
;

301 
uštmax_t
 
	$¡¹oumax
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

302 ** 
__»¡riù
 
__’d±r
, 
__ba£
è
__THROW
;

305 
štmax_t
 
	$wc¡oimax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
__ÅŒ
,

306 
__gwch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

307 
__THROW
;

310 
uštmax_t
 
	$wc¡oumax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
__ÅŒ
,

311 
__gwch¬_t
 ** 
__»¡riù
 
__’d±r
, 
__ba£
)

312 
__THROW
;

314 #ifdeà
__USE_EXTERN_INLINES


316 #ià
__WORDSIZE
 == 64

318 
	$__¡¹Ş_š‹º®
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

319 **
__»¡riù
 
__’d±r
,

320 
__ba£
, 
__group
)

321 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

323 
__ex‹º_šlše
 
štmax_t


324 
	`__NTH
 (
	$¡¹oimax
 (cÚ¡ *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

325 
ba£
))

327  
	`__¡¹Ş_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

328 
	}
}

330 
	$__¡¹oul_š‹º®
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

331 ** 
__»¡riù
 
__’d±r
,

332 
__ba£
, 
__group
)

333 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

335 
__ex‹º_šlše
 
uštmax_t


336 
	`__NTH
 (
	$¡¹oumax
 (cÚ¡ *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

337 
ba£
))

339  
	`__¡¹oul_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

340 
	}
}

342 
	$__wc¡Ş_š‹º®
 (cÚ¡ 
__gwch¬_t
 * 
__»¡riù
 
__ÅŒ
,

343 
__gwch¬_t
 **
__»¡riù
 
__’d±r
,

344 
__ba£
, 
__group
)

345 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

347 
__ex‹º_šlše
 
štmax_t


348 
	`__NTH
 (
	$wc¡oimax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

349 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

351  
	`__wc¡Ş_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

352 
	}
}

354 
	$__wc¡oul_š‹º®
 (cÚ¡ 
__gwch¬_t
 *

355 
__»¡riù
 
__ÅŒ
,

356 
__gwch¬_t
 **

357 
__»¡riù
 
__’d±r
,

358 
__ba£
, 
__group
)

359 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

361 
__ex‹º_šlše
 
uštmax_t


362 
	`__NTH
 (
	$wc¡oumax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

363 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

365  
	`__wc¡oul_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

366 
	}
}

370 
__ex‹nsiÚ__


371 
	$__¡¹Şl_š‹º®
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

372 **
__»¡riù
 
__’d±r
,

373 
__ba£
, 
__group
)

374 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

376 
__ex‹º_šlše
 
štmax_t


377 
	`__NTH
 (
	$¡¹oimax
 (cÚ¡ *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

378 
ba£
))

380  
	`__¡¹Şl_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

381 
	}
}

383 
__ex‹nsiÚ__


384 
	$__¡¹ouÎ_š‹º®
 (const *

385 
__»¡riù
 
__ÅŒ
,

387 
__»¡riù
 
__’d±r
,

388 
__ba£
,

389 
__group
)

390 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

392 
__ex‹º_šlše
 
uštmax_t


393 
	`__NTH
 (
	$¡¹oumax
 (cÚ¡ *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

394 
ba£
))

396  
	`__¡¹ouÎ_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

397 
	}
}

399 
__ex‹nsiÚ__


400 
	$__wc¡Şl_š‹º®
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
__ÅŒ
,

401 
__gwch¬_t
 **
__»¡riù
 
__’d±r
,

402 
__ba£
, 
__group
)

403 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

405 
__ex‹º_šlše
 
štmax_t


406 
	`__NTH
 (
	$wc¡oimax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

407 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

409  
	`__wc¡Şl_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

410 
	}
}

413 
__ex‹nsiÚ__


414 
	$__wc¡ouÎ_š‹º®
 (cÚ¡ 
__gwch¬_t
 *

415 
__»¡riù
 
__ÅŒ
,

416 
__gwch¬_t
 **

417 
__»¡riù
 
__’d±r
,

418 
__ba£
,

419 
__group
)

420 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

422 
__ex‹º_šlše
 
uštmax_t


423 
	`__NTH
 (
	$wc¡oumax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

424 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

426  
	`__wc¡ouÎ_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

427 
	}
}

432 
	g__END_DECLS


	@/usr/include/limits.h

22 #iâdeà
_LIBC_LIMITS_H_


23 
	#_LIBC_LIMITS_H_
 1

	)

25 
	~<ã©u»s.h
>

31 
	#MB_LEN_MAX
 16

	)

36 #ià!
defšed
 
__GNUC__
 || __GNUC__ < 2

41 #iâdeà
_LIMITS_H


42 
	#_LIMITS_H
 1

	)

44 
	~<b™s/wÜdsize.h
>

53 
	#CHAR_BIT
 8

	)

56 
	#SCHAR_MIN
 (-128)

	)

57 
	#SCHAR_MAX
 127

	)

60 
	#UCHAR_MAX
 255

	)

63 #ifdeà
__CHAR_UNSIGNED__


64 
	#CHAR_MIN
 0

	)

65 
	#CHAR_MAX
 
UCHAR_MAX


	)

67 
	#CHAR_MIN
 
SCHAR_MIN


	)

68 
	#CHAR_MAX
 
SCHAR_MAX


	)

72 
	#SHRT_MIN
 (-32768)

	)

73 
	#SHRT_MAX
 32767

	)

76 
	#USHRT_MAX
 65535

	)

79 
	#INT_MIN
 (-
INT_MAX
 - 1)

	)

80 
	#INT_MAX
 2147483647

	)

83 
	#UINT_MAX
 4294967295U

	)

86 #ià
__WORDSIZE
 == 64

87 
	#LONG_MAX
 9223372036854775807L

	)

89 
	#LONG_MAX
 2147483647L

	)

91 
	#LONG_MIN
 (-
LONG_MAX
 - 1L)

	)

94 #ià
__WORDSIZE
 == 64

95 
	#ULONG_MAX
 18446744073709551615UL

	)

97 
	#ULONG_MAX
 4294967295UL

	)

100 #ifdeà
__USE_ISOC99


103 
	#LLONG_MAX
 9223372036854775807LL

	)

104 
	#LLONG_MIN
 (-
LLONG_MAX
 - 1LL)

	)

107 
	#ULLONG_MAX
 18446744073709551615ULL

	)

121 #ià
defšed
 
__GNUC__
 && !defšed 
_GCC_LIMITS_H_


123 #šşude_Ãxˆ<
lim™s
.
h
>

129 #ià
defšed
 
__USE_ISOC99
 && defšed 
__GNUC__


130 #iâdeà
LLONG_MIN


131 
	#LLONG_MIN
 (-
LLONG_MAX
-1)

	)

133 #iâdeà
LLONG_MAX


134 
	#LLONG_MAX
 
__LONG_LONG_MAX__


	)

136 #iâdeà
ULLONG_MAX


137 
	#ULLONG_MAX
 (
LLONG_MAX
 * 2ULL + 1)

	)

141 #ifdef 
__USE_POSIX


143 
	~<b™s/posix1_lim.h
>

146 #ifdef 
__USE_POSIX2


147 
	~<b™s/posix2_lim.h
>

150 #ifdef 
__USE_XOPEN


151 
	~<b™s/xİ’_lim.h
>

	@/usr/include/linux/version.h

1 
	#LINUX_VERSION_CODE
 263247

	)

2 
	#KERNEL_VERSION
(
a
,
b
,
c
è((×è<< 16è+ ((bè<< 8è+ (c))

	)

	@/usr/include/locale.h

22 #iâdef 
_LOCALE_H


23 
	#_LOCALE_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	#__Ãed_NULL


	)

28 
	~<¡ddef.h
>

29 
	~<b™s/loÿË.h
>

31 
	g__BEGIN_DECLS


35 
	#LC_CTYPE
 
__LC_CTYPE


	)

36 
	#LC_NUMERIC
 
__LC_NUMERIC


	)

37 
	#LC_TIME
 
__LC_TIME


	)

38 
	#LC_COLLATE
 
__LC_COLLATE


	)

39 
	#LC_MONETARY
 
__LC_MONETARY


	)

40 
	#LC_MESSAGES
 
__LC_MESSAGES


	)

41 
	#LC_ALL
 
__LC_ALL


	)

42 
	#LC_PAPER
 
__LC_PAPER


	)

43 
	#LC_NAME
 
__LC_NAME


	)

44 
	#LC_ADDRESS
 
__LC_ADDRESS


	)

45 
	#LC_TELEPHONE
 
__LC_TELEPHONE


	)

46 
	#LC_MEASUREMENT
 
__LC_MEASUREMENT


	)

47 
	#LC_IDENTIFICATION
 
__LC_IDENTIFICATION


	)

50 
__BEGIN_NAMESPACE_STD


53 
	slcÚv


57 *
	mdecim®_pošt
;

58 *
	mthou§nds_£p
;

64 *
	mgroupšg
;

70 *
	mšt_cu¼_symbŞ
;

71 *
	mcu¼’cy_symbŞ
;

72 *
	mmÚ_decim®_pošt
;

73 *
	mmÚ_thou§nds_£p
;

74 *
	mmÚ_groupšg
;

75 *
	mpos™ive_sign
;

76 *
	mÃg©ive_sign
;

77 
	mšt_äac_dig™s
;

78 
	mäac_dig™s
;

80 
	mp_cs_´eûdes
;

82 
	mp_£p_by_¥aû
;

84 
	mn_cs_´eûdes
;

86 
	mn_£p_by_¥aû
;

93 
	mp_sign_po¢
;

94 
	mn_sign_po¢
;

95 #ifdeà
__USE_ISOC99


97 
	mšt_p_cs_´eûdes
;

99 
	mšt_p_£p_by_¥aû
;

101 
	mšt_n_cs_´eûdes
;

103 
	mšt_n_£p_by_¥aû
;

110 
	mšt_p_sign_po¢
;

111 
	mšt_n_sign_po¢
;

113 
	m__št_p_cs_´eûdes
;

114 
	m__št_p_£p_by_¥aû
;

115 
	m__št_n_cs_´eûdes
;

116 
	m__št_n_£p_by_¥aû
;

117 
	m__št_p_sign_po¢
;

118 
	m__št_n_sign_po¢
;

124 *
	$£oÿË
 (
__ÿ‹gÜy
, cÚ¡ *
__loÿË
è
__THROW
;

127 
lcÚv
 *
	$loÿËcÚv
 (è
__THROW
;

129 
__END_NAMESPACE_STD


132 #ifdef 
__USE_XOPEN2K8


145 
	~<xloÿË.h
>

151 
__loÿË_t
 
	$ÃwloÿË
 (
__ÿ‹gÜy_mask
, cÚ¡ *
__loÿË
,

152 
__loÿË_t
 
__ba£
è
__THROW
;

158 
	#LC_CTYPE_MASK
 (1 << 
__LC_CTYPE
)

	)

159 
	#LC_NUMERIC_MASK
 (1 << 
__LC_NUMERIC
)

	)

160 
	#LC_TIME_MASK
 (1 << 
__LC_TIME
)

	)

161 
	#LC_COLLATE_MASK
 (1 << 
__LC_COLLATE
)

	)

162 
	#LC_MONETARY_MASK
 (1 << 
__LC_MONETARY
)

	)

163 
	#LC_MESSAGES_MASK
 (1 << 
__LC_MESSAGES
)

	)

164 
	#LC_PAPER_MASK
 (1 << 
__LC_PAPER
)

	)

165 
	#LC_NAME_MASK
 (1 << 
__LC_NAME
)

	)

166 
	#LC_ADDRESS_MASK
 (1 << 
__LC_ADDRESS
)

	)

167 
	#LC_TELEPHONE_MASK
 (1 << 
__LC_TELEPHONE
)

	)

168 
	#LC_MEASUREMENT_MASK
 (1 << 
__LC_MEASUREMENT
)

	)

169 
	#LC_IDENTIFICATION_MASK
 (1 << 
__LC_IDENTIFICATION
)

	)

170 
	#LC_ALL_MASK
 (
LC_CTYPE_MASK
 \

171 | 
LC_NUMERIC_MASK
 \

172 | 
LC_TIME_MASK
 \

173 | 
LC_COLLATE_MASK
 \

174 | 
LC_MONETARY_MASK
 \

175 | 
LC_MESSAGES_MASK
 \

176 | 
LC_PAPER_MASK
 \

177 | 
LC_NAME_MASK
 \

178 | 
LC_ADDRESS_MASK
 \

179 | 
LC_TELEPHONE_MASK
 \

180 | 
LC_MEASUREMENT_MASK
 \

181 | 
LC_IDENTIFICATION_MASK
 \

182 )

	)

186 
__loÿË_t
 
	$du¶oÿË
 (
__loÿË_t
 
__d©a£t
è
__THROW
;

190 
	$ä“loÿË
 (
__loÿË_t
 
__d©a£t
è
__THROW
;

197 
__loÿË_t
 
	$u£loÿË
 (
__loÿË_t
 
__d©a£t
è
__THROW
;

201 
	#LC_GLOBAL_LOCALE
 ((
__loÿË_t
è-1L)

	)

205 
__END_DECLS


	@/usr/include/math.h

23 #iâdef 
_MATH_H


24 
	#_MATH_H
 1

	)

26 
	~<ã©u»s.h
>

28 
	g__BEGIN_DECLS


31 
	~<b™s/m©h-veùÜ.h
>

35 
	~<b™s/huge_v®.h
>

36 #ifdeà
__USE_ISOC99


37 
	~<b™s/huge_v®f.h
>

38 
	~<b™s/huge_v®l.h
>

41 
	~<b™s/šf.h
>

44 
	~<b™s/Çn.h
>

48 
	~<b™s/m©hdef.h
>

55 
	#__SIMD_DECL
(
funùiÚ
è
	`__CONCAT
 (
__DECL_SIMD_
, funùiÚ)

	)

57 
	#__MATHCALL_VEC
(
funùiÚ
, 
suffix
, 
¬gs
) \

58 
	`__SIMD_DECL
 (
	`__MATH_PRECNAME
 (
funùiÚ
, 
suffix
)) \

59 
	`__MATHCALL
 (
funùiÚ
, 
suffix
, 
¬gs
)

	)

61 
	#__MATHDECL_VEC
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
) \

62 
	`__SIMD_DECL
 (
	`__MATH_PRECNAME
 (
funùiÚ
, 
suffix
)) \

63 
	`__MATHDECL
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
)

	)

65 
	#__MATHCALL
(
funùiÚ
,
suffix
, 
¬gs
) \

66 
	`__MATHDECL
 (
_MdoubË_
,
funùiÚ
,
suffix
, 
¬gs
)

	)

67 
	#__MATHDECL
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
) \

68 
	`__MATHDECL_1
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
); \

69 
	`__MATHDECL_1
(
ty³
, 
	`__CONCAT
(
__
,
funùiÚ
),
suffix
, 
¬gs
)

	)

70 
	#__MATHCALLX
(
funùiÚ
,
suffix
, 
¬gs
, 
©Œib
) \

71 
	`__MATHDECLX
 (
_MdoubË_
,
funùiÚ
,
suffix
, 
¬gs
, 
©Œib
)

	)

72 
	#__MATHDECLX
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
, 
©Œib
) \

73 
	`__MATHDECL_1
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
è
	`__©Œibu‹__
 (
©Œib
); \

74 
	`__MATHDECL_1
(
ty³
, 
	`__CONCAT
(
__
,
funùiÚ
),
suffix
, 
¬gs
è
	`__©Œibu‹__
 (
©Œib
)

	)

75 
	#__MATHDECL_1
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
) \

76 
ty³
 
	`__MATH_PRECNAME
(
funùiÚ
,
suffix
è
¬gs
 
__THROW


	)

78 
	#_MdoubË_
 

	)

79 
	#__MATH_PRECNAME
(
Çme
,
r
è
	`__CONCAT
Òame,r)

	)

80 
	#__MATH_DECLARING_DOUBLE
 1

	)

81 
	#_MdoubË_BEGIN_NAMESPACE
 
__BEGIN_NAMESPACE_STD


	)

82 
	#_MdoubË_END_NAMESPACE
 
__END_NAMESPACE_STD


	)

83 
	~<b™s/m©hÿÎs.h
>

84 #undeà
_MdoubË_


85 #undeà
_MdoubË_BEGIN_NAMESPACE


86 #undeà
_MdoubË_END_NAMESPACE


87 #undeà
__MATH_PRECNAME


88 #undeà
__MATH_DECLARING_DOUBLE


90 #ifdeà
__USE_ISOC99


96 #iâdeà
_Mæßt_


97 
	#_Mæßt_
 

	)

99 
	#_MdoubË_
 
_Mæßt_


	)

100 
	#__MATH_PRECNAME
(
Çme
,
r
èÇme##
f
##
	)
r

101 
	#__MATH_DECLARING_DOUBLE
 0

	)

102 
	#_MdoubË_BEGIN_NAMESPACE
 
__BEGIN_NAMESPACE_C99


	)

103 
	#_MdoubË_END_NAMESPACE
 
__END_NAMESPACE_C99


	)

104 
	~<b™s/m©hÿÎs.h
>

105 #undeà
_MdoubË_


106 #undeà
_MdoubË_BEGIN_NAMESPACE


107 #undeà
_MdoubË_END_NAMESPACE


108 #undeà
__MATH_PRECNAME


109 #undeà
__MATH_DECLARING_DOUBLE


111 #ià!(
defšed
 
__NO_LONG_DOUBLE_MATH
 && defšed 
_LIBC
) \

112 || 
defšed
 
__LDBL_COMPAT
 \

113 || 
defšed
 
_LIBC_TEST


114 #ifdeà
__LDBL_COMPAT


116 #ifdeà
__USE_ISOC99


117 
	$__Ædbl_Ãx‰ow¬df
 (
__x
, 
__y
)

118 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

119 #ifdeà
__REDIRECT_NTH


120 
	`__REDIRECT_NTH
 (
Ãx‰ow¬df
, (
__x
, 
__y
),

121 
__Ædbl_Ãx‰ow¬df
)

122 
	`__©Œibu‹__
 ((
__cÚ¡__
));

123 
	`__REDIRECT_NTH
 (
Ãx‰ow¬d
, (
__x
, 
__y
),

124 
Ãxá”
è
	`__©Œibu‹__
 ((
__cÚ¡__
));

125 
	`__REDIRECT_NTH
 (
Ãx‰ow¬dl
,

126 (
__x
, 
__y
),

127 
Ãxá”
è
	`__©Œibu‹__
 ((
__cÚ¡__
));

131 #undeà
__MATHDECL_1


132 
	#__MATHDECL_2
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
, 
®Ÿs
) \

133 
ty³
 
	`__REDIRECT_NTH
(
	`__MATH_PRECNAME
(
funùiÚ
,
suffix
), \

134 
¬gs
, 
®Ÿs
)

	)

135 
	#__MATHDECL_1
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
) \

136 
	`__MATHDECL_2
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
, 
	`__CONCAT
(funùiÚ,suffix))

	)

142 #iâdeà
_MlÚg_doubË_


143 
	#_MlÚg_doubË_
 

	)

145 
	#_MdoubË_
 
_MlÚg_doubË_


	)

146 
	#__MATH_PRECNAME
(
Çme
,
r
èÇme##
l
##
	)
r

147 
	#__MATH_DECLARING_DOUBLE
 0

	)

148 
	#_MdoubË_BEGIN_NAMESPACE
 
__BEGIN_NAMESPACE_C99


	)

149 
	#_MdoubË_END_NAMESPACE
 
__END_NAMESPACE_C99


	)

150 
	#__MATH_DECLARE_LDOUBLE
 1

	)

151 
	~<b™s/m©hÿÎs.h
>

152 #undeà
_MdoubË_


153 #undeà
_MdoubË_BEGIN_NAMESPACE


154 #undeà
_MdoubË_END_NAMESPACE


155 #undeà
__MATH_PRECNAME


156 #undeà
__MATH_DECLARING_DOUBLE


161 #undeà
__MATHDECL_1


162 #undeà
__MATHDECL


163 #undeà
__MATHCALL


166 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


168 
signgam
;

173 #ifdeà
__USE_ISOC99


211 
FP_NAN
 =

212 
	#FP_NAN
 0

	)

213 
FP_NAN
,

214 
FP_INFINITE
 =

215 
	#FP_INFINITE
 1

	)

216 
FP_INFINITE
,

217 
FP_ZERO
 =

218 
	#FP_ZERO
 2

	)

219 
FP_ZERO
,

220 
FP_SUBNORMAL
 =

221 
	#FP_SUBNORMAL
 3

	)

222 
FP_SUBNORMAL
,

223 
FP_NORMAL
 =

224 
	#FP_NORMAL
 4

	)

225 
FP_NORMAL


233 #ià
	`__GNUC_PREREQ
 (4,4è&& !
defšed
 
__SUPPORT_SNAN__
 \

234 && !
defšed
 
__OPTIMIZE_SIZE__


235 
	#åşassify
(
x
è
	`__butš_åşassify
 (
FP_NAN
, 
FP_INFINITE
, \

236 
FP_NORMAL
, 
FP_SUBNORMAL
, 
FP_ZERO
, 
x
)

	)

237 #–ià
defšed
 
__NO_LONG_DOUBLE_MATH


238 
	#åşassify
(
x
) \

239 ( (
x
è=ğ (è? 
	`__åşassifyf
 (xè: 
	`__åşassify
 (x))

	)

241 
	#åşassify
(
x
) \

242 ( (
x
) ==  () \

243 ? 
	`__åşassifyf
 (
x
) \

244 :  (
x
) ==  () \

245 ? 
	`__åşassify
 (
x
è: 
	`__åşassifyl
 (x))

	)

249 #ià
	`__GNUC_PREREQ
 (4,0)

250 
	#signb™
(
x
) \

251 ( (
x
) ==  () \

252 ? 
	`__butš_signb™f
 (
x
) \

253 :  (
x
) ==  () \

254 ? 
	`__butš_signb™
 (
x
è: 
	`__butš_signb™l
 (x))

	)

256 #ifdeà
__NO_LONG_DOUBLE_MATH


257 
	#signb™
(
x
) \

258 ( (
x
è=ğ (è? 
	`__signb™f
 (xè: 
	`__signb™
 (x))

	)

260 
	#signb™
(
x
) \

261 ( (
x
) ==  () \

262 ? 
	`__signb™f
 (
x
) \

263 :  (
x
) ==  () \

264 ? 
	`__signb™
 (
x
è: 
	`__signb™l
 (x))

	)

269 #ià
	`__GNUC_PREREQ
 (4,4è&& !
defšed
 
__SUPPORT_SNAN__


270 
	#isfš™e
(
x
è
	`__butš_isfš™e
 (x)

	)

271 #–ià
defšed
 
__NO_LONG_DOUBLE_MATH


272 
	#isfš™e
(
x
) \

273 ( (
x
è=ğ (è? 
	`__fš™ef
 (xè: 
	`__fš™e
 (x))

	)

275 
	#isfš™e
(
x
) \

276 ( (
x
) ==  () \

277 ? 
	`__fš™ef
 (
x
) \

278 :  (
x
) ==  () \

279 ? 
	`__fš™e
 (
x
è: 
	`__fš™–
 (x))

	)

283 #ià
	`__GNUC_PREREQ
 (4,4è&& !
defšed
 
__SUPPORT_SNAN__


284 
	#i¢Üm®
(
x
è
	`__butš_i¢Üm®
 (x)

	)

286 
	#i¢Üm®
(
x
è(
	`åşassify
 (xè=ğ
FP_NORMAL
)

	)

291 #ià
	`__GNUC_PREREQ
 (4,4è&& !
defšed
 
__SUPPORT_SNAN__


292 
	#i¢ª
(
x
è
	`__butš_i¢ª
 (x)

	)

293 #–ià
defšed
 
__NO_LONG_DOUBLE_MATH


294 
	#i¢ª
(
x
) \

295 ( (
x
è=ğ (è? 
	`__i¢ªf
 (xè: 
	`__i¢ª
 (x))

	)

297 
	#i¢ª
(
x
) \

298 ( (
x
) ==  () \

299 ? 
	`__i¢ªf
 (
x
) \

300 :  (
x
) ==  () \

301 ? 
	`__i¢ª
 (
x
è: 
	`__i¢ªl
 (x))

	)

305 #ià
	`__GNUC_PREREQ
 (4,4è&& !
defšed
 
__SUPPORT_SNAN__


306 
	#isšf
(
x
è
	`__butš_isšf_sign
 (x)

	)

307 #–ià
defšed
 
__NO_LONG_DOUBLE_MATH


308 
	#isšf
(
x
) \

309 ( (
x
è=ğ (è? 
	`__isšff
 (xè: 
	`__isšf
 (x))

	)

311 
	#isšf
(
x
) \

312 ( (
x
) ==  () \

313 ? 
	`__isšff
 (
x
) \

314 :  (
x
) ==  () \

315 ? 
	`__isšf
 (
x
è: 
	`__isšæ
 (x))

	)

319 
	#MATH_ERRNO
 1

	)

320 
	#MATH_ERREXCEPT
 2

	)

325 #iâdeà
__FAST_MATH__


326 
	#m©h_”rhªdlšg
 (
MATH_ERRNO
 | 
MATH_ERREXCEPT
)

	)

331 #ifdeà
__USE_GNU


333 #ifdeà
__NO_LONG_DOUBLE_MATH


334 
	#issigÇlšg
(
x
) \

335 ( (
x
è=ğ (è? 
	`__issigÇlšgf
 (xè: 
	`__issigÇlšg
 (x))

	)

337 
	#issigÇlšg
(
x
) \

338 ( (
x
) ==  () \

339 ? 
	`__issigÇlšgf
 (
x
) \

340 :  (
x
) ==  () \

341 ? 
	`__issigÇlšg
 (
x
è: 
	`__issigÇlšgl
 (x))

	)

345 #ifdef 
__USE_MISC


349 
_IEEE_
 = -1,

350 
_SVID_
,

351 
_XOPEN_
,

352 
_POSIX_
,

353 
_ISOC_


354 } 
	t_LIB_VERSION_TYPE
;

359 
_LIB_VERSION_TYPE
 
_LIB_VERSION
;

363 #ifdeà
__USE_MISC


369 #ifdeà
__ılu¥lus


370 
__exû±iÚ


372 
exû±iÚ


375 
ty³
;

376 *
Çme
;

377 
¬g1
;

378 
¬g2
;

379 
»tv®
;

380 
	}
};

382 #ifdeà
__ılu¥lus


383 
	$m©h”r
 (
__exû±iÚ
 *
__exc
è
	`throw
 ();

385 
	`m©h”r
 (
exû±iÚ
 *
__exc
);

388 
	#X_TLOSS
 1.41484755040568800000e+16

	)

391 
	#DOMAIN
 1

	)

392 
	#SING
 2

	)

393 
	#OVERFLOW
 3

	)

394 
	#UNDERFLOW
 4

	)

395 
	#TLOSS
 5

	)

396 
	#PLOSS
 6

	)

399 
	#HUGE
 3.40282347e+38F

	)

403 #ifdeà
__USE_XOPEN


405 
	#MAXFLOAT
 3.40282347e+38F

	)

412 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


413 
	#M_E
 2.7182818284590452354

	)

414 
	#M_LOG2E
 1.4426950408889634074

	)

415 
	#M_LOG10E
 0.43429448190325182765

	)

416 
	#M_LN2
 0.69314718055994530942

	)

417 
	#M_LN10
 2.30258509299404568402

	)

418 
	#M_PI
 3.14159265358979323846

	)

419 
	#M_PI_2
 1.57079632679489661923

	)

420 
	#M_PI_4
 0.78539816339744830962

	)

421 
	#M_1_PI
 0.31830988618379067154

	)

422 
	#M_2_PI
 0.63661977236758134308

	)

423 
	#M_2_SQRTPI
 1.12837916709551257390

	)

424 
	#M_SQRT2
 1.41421356237309504880

	)

425 
	#M_SQRT1_2
 0.70710678118654752440

	)

431 #ifdeà
__USE_GNU


432 
	#M_El
 2.718281828459045235360287471352662498L

	)

433 
	#M_LOG2El
 1.442695040888963407359924681001892137L

	)

434 
	#M_LOG10El
 0.434294481903251827651128918916605082L

	)

435 
	#M_LN2l
 0.693147180559945309417232121458176568L

	)

436 
	#M_LN10l
 2.302585092994045684017991454684364208L

	)

437 
	#M_PIl
 3.141592653589793238462643383279502884L

	)

438 
	#M_PI_2l
 1.570796326794896619231321691639751442L

	)

439 
	#M_PI_4l
 0.785398163397448309615660845819875721L

	)

440 
	#M_1_PIl
 0.318309886183790671537767526745028724L

	)

441 
	#M_2_PIl
 0.636619772367581343075535053490057448L

	)

442 
	#M_2_SQRTPIl
 1.128379167095512573896158903121545172L

	)

443 
	#M_SQRT2l
 1.414213562373095048801688724209698079L

	)

444 
	#M_SQRT1_2l
 0.707106781186547524400844362104849039L

	)

451 #ià
defšed
 
__STRICT_ANSI__
 && !defšed 
__NO_MATH_INLINES


452 
	#__NO_MATH_INLINES
 1

	)

455 #ià
defšed
 
__USE_ISOC99
 && 
	`__GNUC_PREREQ
(2,97)

462 
	#isg»©”
(
x
, 
y
è
	`__butš_isg»©”
(x, y)

	)

463 
	#isg»©”equ®
(
x
, 
y
è
	`__butš_isg»©”equ®
(x, y)

	)

464 
	#i¦ess
(
x
, 
y
è
	`__butš_i¦ess
(x, y)

	)

465 
	#i¦es£qu®
(
x
, 
y
è
	`__butš_i¦es£qu®
(x, y)

	)

466 
	#i¦essg»©”
(
x
, 
y
è
	`__butš_i¦essg»©”
(x, y)

	)

467 
	#isunÜd”ed
(
u
, 
v
è
	`__butš_isunÜd”ed
(u, v)

	)

471 #ifdeà
__USE_EXTERN_INLINES


472 
	~<b™s/m©hšlše.h
>

477 #ià
defšed
 
__FINITE_MATH_ONLY__
 && __FINITE_MATH_ONLY__ > 0

478 
	~<b™s/m©h-fš™e.h
>

481 #ifdeà
__USE_ISOC99


485 #iâdeà
isg»©”


486 
	#isg»©”
(
x
, 
y
) \

487 (
__ex‹nsiÚ__
 \

488 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

489 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x > __y; 
	}
}))

	)

493 #iâdeà
isg»©”equ®


494 
	#isg»©”equ®
(
x
, 
y
) \

495 (
__ex‹nsiÚ__
 \

496 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

497 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x >ğ__y; }))

	)

501 #iâdeà
i¦ess


502 
	#i¦ess
(
x
, 
y
) \

503 (
__ex‹nsiÚ__
 \

504 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

505 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x < __y; }))

	)

509 #iâdeà
i¦es£qu®


510 
	#i¦es£qu®
(
x
, 
y
) \

511 (
__ex‹nsiÚ__
 \

512 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

513 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x <ğ__y; }))

	)

517 #iâdeà
i¦essg»©”


518 
	#i¦essg»©”
(
x
, 
y
) \

519 (
__ex‹nsiÚ__
 \

520 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

521 !
	`isunÜd”ed
 (
__x
, 
__y
è&& (__x < __y || __y < __x); }))

	)

525 #iâdeà
isunÜd”ed


526 
	#isunÜd”ed
(
u
, 
v
) \

527 (
__ex‹nsiÚ__
 \

528 ({ 
	`__ty³of__
(
u
è
__u
 = (u); __ty³of__(
v
è
__v
 = (v); \

529 
	`åşassify
 (
__u
è=ğ
FP_NAN
 || fpşassify (
__v
è=ğFP_NAN; }))

	)

534 
	g__END_DECLS


	@/usr/include/netdb.h

22 #iâdef 
_NETDB_H


23 
	#_NETDB_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	~<Ãtš‘/š.h
>

28 
	~<¡dšt.h
>

29 #ifdeà
__USE_MISC


32 
	~<½c/Ãtdb.h
>

35 #ifdeà
__USE_GNU


36 
	#__Ãed_sigev’t_t


	)

37 
	~<b™s/sigšfo.h
>

38 
	#__Ãed_time¥ec


	)

39 
	~<time.h
>

42 
	~<b™s/Ãtdb.h
>

45 
	#_PATH_HEQUIV
 "/‘c/ho¡s.equiv"

	)

46 
	#_PATH_HOSTS
 "/‘c/ho¡s"

	)

47 
	#_PATH_NETWORKS
 "/‘c/ÃtwÜks"

	)

48 
	#_PATH_NSSWITCH_CONF
 "/‘c/nssw™ch.cÚf"

	)

49 
	#_PATH_PROTOCOLS
 "/‘c/´ÙocŞs"

	)

50 
	#_PATH_SERVICES
 "/‘c/£rviûs"

	)

53 
	g__BEGIN_DECLS


55 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8


58 
	#h_”ºo
 (*
	`__h_”ºo_loÿtiÚ
 ())

	)

61 *
	$__h_”ºo_loÿtiÚ
 (è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

65 
	#HOST_NOT_FOUND
 1

	)

66 
	#TRY_AGAIN
 2

	)

68 
	#NO_RECOVERY
 3

	)

70 
	#NO_DATA
 4

	)

73 #ifdeà
__USE_MISC


74 
	#NETDB_INTERNAL
 -1

	)

75 
	#NETDB_SUCCESS
 0

	)

76 
	#NO_ADDRESS
 
NO_DATA


	)

79 #ià
defšed
 
__USE_XOPEN2K
 || defšed 
__USE_XOPEN_EXTENDED


81 
	#IPPORT_RESERVED
 1024

	)

84 #ifdeà
__USE_GNU


86 
	#SCOPE_DELIMITER
 '%'

	)

89 #ifdeà
__USE_MISC


92 
	$h”rÜ
 (cÚ¡ *
__¡r
è
__THROW
;

95 cÚ¡ *
	$h¡»¼Ü
 (
__”r_num
è
__THROW
;

100 
	sho¡’t


102 *
h_Çme
;

103 **
h_®Ÿ£s
;

104 
h_add¹y³
;

105 
h_Ëngth
;

106 **
h_addr_li¡
;

107 #ifdeà
__USE_MISC


108 
	#h_addr
 
h_addr_li¡
[0]

	)

117 
	`£tho¡’t
 (
__¡ay_İ’
);

123 
	`’dho¡’t
 ();

130 
ho¡’t
 *
	`g‘ho¡’t
 ();

137 
ho¡’t
 *
	`g‘ho¡byaddr
 (cÚ¡ *
__addr
, 
__sockËn_t
 
__Ën
,

138 
__ty³
);

144 
ho¡’t
 *
	`g‘ho¡byÇme
 (cÚ¡ *
__Çme
);

146 #ifdeà
__USE_MISC


155 
ho¡’t
 *
	`g‘ho¡byÇme2
 (cÚ¡ *
__Çme
, 
__af
);

167 
	`g‘ho¡’t_r
 (
ho¡’t
 *
__»¡riù
 
__»suÉ_buf
,

168 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

169 
ho¡’t
 **
__»¡riù
 
__»suÉ
,

170 *
__»¡riù
 
__h_”ºİ
);

172 
	`g‘ho¡byaddr_r
 (cÚ¡ *
__»¡riù
 
__addr
, 
__sockËn_t
 
__Ën
,

173 
__ty³
,

174 
ho¡’t
 *
__»¡riù
 
__»suÉ_buf
,

175 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

176 
ho¡’t
 **
__»¡riù
 
__»suÉ
,

177 *
__»¡riù
 
__h_”ºİ
);

179 
	`g‘ho¡byÇme_r
 (cÚ¡ *
__»¡riù
 
__Çme
,

180 
ho¡’t
 *
__»¡riù
 
__»suÉ_buf
,

181 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

182 
ho¡’t
 **
__»¡riù
 
__»suÉ
,

183 *
__»¡riù
 
__h_”ºİ
);

185 
	`g‘ho¡byÇme2_r
 (cÚ¡ *
__»¡riù
 
__Çme
, 
__af
,

186 
ho¡’t
 *
__»¡riù
 
__»suÉ_buf
,

187 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

188 
ho¡’t
 **
__»¡riù
 
__»suÉ
,

189 *
__»¡riù
 
__h_”ºİ
);

198 
	`£Š‘’t
 (
__¡ay_İ’
);

204 
	`’dÃ‹Á
 ();

211 
Ã‹Á
 *
	`g‘Ã‹Á
 ();

218 
Ã‹Á
 *
	`g‘Ãtbyaddr
 (
ušt32_t
 
__Ãt
, 
__ty³
);

224 
Ã‹Á
 *
	`g‘ÃtbyÇme
 (cÚ¡ *
__Çme
);

226 #ifdef 
__USE_MISC


237 
	`g‘Ã‹Á_r
 (
Ã‹Á
 *
__»¡riù
 
__»suÉ_buf
,

238 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

239 
Ã‹Á
 **
__»¡riù
 
__»suÉ
,

240 *
__»¡riù
 
__h_”ºİ
);

242 
	`g‘Ãtbyaddr_r
 (
ušt32_t
 
__Ãt
, 
__ty³
,

243 
Ã‹Á
 *
__»¡riù
 
__»suÉ_buf
,

244 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

245 
Ã‹Á
 **
__»¡riù
 
__»suÉ
,

246 *
__»¡riù
 
__h_”ºİ
);

248 
	`g‘ÃtbyÇme_r
 (cÚ¡ *
__»¡riù
 
__Çme
,

249 
Ã‹Á
 *
__»¡riù
 
__»suÉ_buf
,

250 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

251 
Ã‹Á
 **
__»¡riù
 
__»suÉ
,

252 *
__»¡riù
 
__h_”ºİ
);

257 
	s£rv’t


259 *
s_Çme
;

260 **
s_®Ÿ£s
;

261 
s_pÜt
;

262 *
s_´Ùo
;

270 
	`£t£rv’t
 (
__¡ay_İ’
);

276 
	`’d£rv’t
 ();

283 
£rv’t
 *
	`g‘£rv’t
 ();

290 
£rv’t
 *
	`g‘£rvbyÇme
 (cÚ¡ *
__Çme
, cÚ¡ *
__´Ùo
);

297 
£rv’t
 *
	`g‘£rvbypÜt
 (
__pÜt
, cÚ¡ *
__´Ùo
);

300 #ifdef 
__USE_MISC


308 
	`g‘£rv’t_r
 (
£rv’t
 *
__»¡riù
 
__»suÉ_buf
,

309 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

310 
£rv’t
 **
__»¡riù
 
__»suÉ
);

312 
	`g‘£rvbyÇme_r
 (cÚ¡ *
__»¡riù
 
__Çme
,

313 cÚ¡ *
__»¡riù
 
__´Ùo
,

314 
£rv’t
 *
__»¡riù
 
__»suÉ_buf
,

315 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

316 
£rv’t
 **
__»¡riù
 
__»suÉ
);

318 
	`g‘£rvbypÜt_r
 (
__pÜt
, cÚ¡ *
__»¡riù
 
__´Ùo
,

319 
£rv’t
 *
__»¡riù
 
__»suÉ_buf
,

320 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

321 
£rv’t
 **
__»¡riù
 
__»suÉ
);

326 
	s´ÙÛÁ


328 *
p_Çme
;

329 **
p_®Ÿ£s
;

330 
p_´Ùo
;

338 
	`£rÙÛÁ
 (
__¡ay_İ’
);

344 
	`’d´ÙÛÁ
 ();

351 
´ÙÛÁ
 *
	`g‘´ÙÛÁ
 ();

357 
´ÙÛÁ
 *
	`g‘´ÙobyÇme
 (cÚ¡ *
__Çme
);

363 
´ÙÛÁ
 *
	`g‘´Ùobynumb”
 (
__´Ùo
);

366 #ifdef 
__USE_MISC


374 
	`g‘´ÙÛÁ_r
 (
´ÙÛÁ
 *
__»¡riù
 
__»suÉ_buf
,

375 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

376 
´ÙÛÁ
 **
__»¡riù
 
__»suÉ
);

378 
	`g‘´ÙobyÇme_r
 (cÚ¡ *
__»¡riù
 
__Çme
,

379 
´ÙÛÁ
 *
__»¡riù
 
__»suÉ_buf
,

380 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

381 
´ÙÛÁ
 **
__»¡riù
 
__»suÉ
);

383 
	`g‘´Ùobynumb”_r
 (
__´Ùo
,

384 
´ÙÛÁ
 *
__»¡riù
 
__»suÉ_buf
,

385 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

386 
´ÙÛÁ
 **
__»¡riù
 
__»suÉ
);

395 
	`£Š‘g»Á
 (cÚ¡ *
__Ãtgroup
);

403 
	`’dÃtg»Á
 ();

412 
	`g‘Ãtg»Á
 (**
__»¡riù
 
__ho¡p
,

413 **
__»¡riù
 
__u£½
,

414 **
__»¡riù
 
__domašp
);

423 
	`šÃtgr
 (cÚ¡ *
__Ãtgroup
, cÚ¡ *
__ho¡
,

424 cÚ¡ *
__u£r
, cÚ¡ *
__domaš
);

432 
	`g‘Ãtg»Á_r
 (**
__»¡riù
 
__ho¡p
,

433 **
__»¡riù
 
__u£½
,

434 **
__»¡riù
 
__domašp
,

435 *
__»¡riù
 
__bufãr
, 
size_t
 
__buæ’
);

439 #ifdeà
__USE_MISC


451 
	`rcmd
 (**
__»¡riù
 
__aho¡
, 
__½Üt
,

452 cÚ¡ *
__»¡riù
 
__locu£r
,

453 cÚ¡ *
__»¡riù
 
__»mu£r
,

454 cÚ¡ *
__»¡riù
 
__cmd
, *__»¡riù 
__fd2p
);

463 
	`rcmd_af
 (**
__»¡riù
 
__aho¡
, 
__½Üt
,

464 cÚ¡ *
__»¡riù
 
__locu£r
,

465 cÚ¡ *
__»¡riù
 
__»mu£r
,

466 cÚ¡ *
__»¡riù
 
__cmd
, *__»¡riù 
__fd2p
,

467 
§_çmy_t
 
__af
);

479 
	`»xec
 (**
__»¡riù
 
__aho¡
, 
__½Üt
,

480 cÚ¡ *
__»¡riù
 
__Çme
,

481 cÚ¡ *
__»¡riù
 
__·ss
,

482 cÚ¡ *
__»¡riù
 
__cmd
, *__»¡riù 
__fd2p
);

491 
	`»xec_af
 (**
__»¡riù
 
__aho¡
, 
__½Üt
,

492 cÚ¡ *
__»¡riù
 
__Çme
,

493 cÚ¡ *
__»¡riù
 
__·ss
,

494 cÚ¡ *
__»¡riù
 
__cmd
, *__»¡riù 
__fd2p
,

495 
§_çmy_t
 
__af
);

505 
	`ru£rok
 (cÚ¡ *
__rho¡
, 
__su£r
,

506 cÚ¡ *
__»mu£r
, cÚ¡ *
__locu£r
);

515 
	`ru£rok_af
 (cÚ¡ *
__rho¡
, 
__su£r
,

516 cÚ¡ *
__»mu£r
, cÚ¡ *
__locu£r
,

517 
§_çmy_t
 
__af
);

528 
	`œu£rok
 (
ušt32_t
 
__¿ddr
, 
__su£r
,

529 cÚ¡ *
__»mu£r
, cÚ¡ *
__locu£r
);

539 
	`œu£rok_af
 (cÚ¡ *
__¿ddr
, 
__su£r
,

540 cÚ¡ *
__»mu£r
, cÚ¡ *
__locu£r
,

541 
§_çmy_t
 
__af
);

551 
	`¼esvpÜt
 (*
__®pÜt
);

560 
	`¼esvpÜt_af
 (*
__®pÜt
, 
§_çmy_t
 
__af
);

565 #ifdeà
__USE_XOPEN2K


567 
	saddršfo


569 
ai_æags
;

570 
ai_çmy
;

571 
ai_sockty³
;

572 
ai_´ÙocŞ
;

573 
sockËn_t
 
ai_add¾’
;

574 
sockaddr
 *
ai_addr
;

575 *
ai_ÿnÚÇme
;

576 
addršfo
 *
ai_Ãxt
;

579 #ifdeà
__USE_GNU


581 
	sgaicb


583 cÚ¡ *
¬_Çme
;

584 cÚ¡ *
¬_£rviû
;

585 cÚ¡ 
addršfo
 *
¬_»que¡
;

586 
addršfo
 *
¬_»suÉ
;

588 
__»tuº
;

589 
__glibc_»£rved
[5];

593 
	#GAI_WAIT
 0

	)

594 
	#GAI_NOWAIT
 1

	)

598 
	#AI_PASSIVE
 0x0001

	)

599 
	#AI_CANONNAME
 0x0002

	)

600 
	#AI_NUMERICHOST
 0x0004

	)

601 
	#AI_V4MAPPED
 0x0008

	)

602 
	#AI_ALL
 0x0010

	)

603 
	#AI_ADDRCONFIG
 0x0020

	)

605 #ifdeà
__USE_GNU


606 
	#AI_IDN
 0x0040

	)

609 
	#AI_CANONIDN
 0x0080

	)

610 
	#AI_IDN_ALLOW_UNASSIGNED
 0x0100

	)

612 
	#AI_IDN_USE_STD3_ASCII_RULES
 0x0200

	)

615 
	#AI_NUMERICSERV
 0x0400

	)

618 
	#EAI_BADFLAGS
 -1

	)

619 
	#EAI_NONAME
 -2

	)

620 
	#EAI_AGAIN
 -3

	)

621 
	#EAI_FAIL
 -4

	)

622 
	#EAI_FAMILY
 -6

	)

623 
	#EAI_SOCKTYPE
 -7

	)

624 
	#EAI_SERVICE
 -8

	)

625 
	#EAI_MEMORY
 -10

	)

626 
	#EAI_SYSTEM
 -11

	)

627 
	#EAI_OVERFLOW
 -12

	)

628 #ifdeà
__USE_GNU


629 
	#EAI_NODATA
 -5

	)

630 
	#EAI_ADDRFAMILY
 -9

	)

631 
	#EAI_INPROGRESS
 -100

	)

632 
	#EAI_CANCELED
 -101

	)

633 
	#EAI_NOTCANCELED
 -102

	)

634 
	#EAI_ALLDONE
 -103

	)

635 
	#EAI_INTR
 -104

	)

636 
	#EAI_IDN_ENCODE
 -105

	)

639 #ifdeà
__USE_MISC


640 
	#NI_MAXHOST
 1025

	)

641 
	#NI_MAXSERV
 32

	)

644 
	#NI_NUMERICHOST
 1

	)

645 
	#NI_NUMERICSERV
 2

	)

646 
	#NI_NOFQDN
 4

	)

647 
	#NI_NAMEREQD
 8

	)

648 
	#NI_DGRAM
 16

	)

649 #ifdeà
__USE_GNU


650 
	#NI_IDN
 32

	)

651 
	#NI_IDN_ALLOW_UNASSIGNED
 64

	)

653 
	#NI_IDN_USE_STD3_ASCII_RULES
 128

	)

662 
	`g‘addršfo
 (cÚ¡ *
__»¡riù
 
__Çme
,

663 cÚ¡ *
__»¡riù
 
__£rviû
,

664 cÚ¡ 
addršfo
 *
__»¡riù
 
__»q
,

665 
addršfo
 **
__»¡riù
 
__·i
);

668 
	$ä“addršfo
 (
addršfo
 *
__ai
è
__THROW
;

671 cÚ¡ *
	$gai_¡»¼Ü
 (
__ecode
è
__THROW
;

677 
	`g‘Çmešfo
 (cÚ¡ 
sockaddr
 *
__»¡riù
 
__§
,

678 
sockËn_t
 
__§Ën
, *
__»¡riù
 
__ho¡
,

679 
sockËn_t
 
__ho¡Ën
, *
__»¡riù
 
__£rv
,

680 
sockËn_t
 
__£rvËn
, 
__æags
);

683 #ifdeà
__USE_GNU


692 
	`g‘addršfo_a
 (
__mode
, 
gaicb
 *
__li¡
[
__»¡riù_¬r
],

693 
__’t
, 
sigev’t
 *
__»¡riù
 
__sig
);

703 
	`gai_su¥’d
 (cÚ¡ 
gaicb
 *cÚ¡ 
__li¡
[], 
__’t
,

704 cÚ¡ 
time¥ec
 *
__timeout
);

707 
	$gai_”rÜ
 (
gaicb
 *
__»q
è
__THROW
;

710 
	$gai_ÿnûl
 (
gaicb
 *
__gaicbp
è
__THROW
;

713 
__END_DECLS


	@/usr/include/netinet/in.h

18 #iâdef 
_NETINET_IN_H


19 
	#_NETINET_IN_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	~<¡dšt.h
>

23 
	~<sys/sock‘.h
>

24 
	~<b™s/ty³s.h
>

27 
__BEGIN_DECLS


30 
ušt32_t
 
	tš_addr_t
;

31 
	sš_addr


33 
š_addr_t
 
	ms_addr
;

37 
	~<b™s/š.h
>

42 
	mIPPROTO_IP
 = 0,

43 
	#IPPROTO_IP
 
IPPROTO_IP


	)

44 
	mIPPROTO_ICMP
 = 1,

45 
	#IPPROTO_ICMP
 
IPPROTO_ICMP


	)

46 
	mIPPROTO_IGMP
 = 2,

47 
	#IPPROTO_IGMP
 
IPPROTO_IGMP


	)

48 
	mIPPROTO_IPIP
 = 4,

49 
	#IPPROTO_IPIP
 
IPPROTO_IPIP


	)

50 
	mIPPROTO_TCP
 = 6,

51 
	#IPPROTO_TCP
 
IPPROTO_TCP


	)

52 
	mIPPROTO_EGP
 = 8,

53 
	#IPPROTO_EGP
 
IPPROTO_EGP


	)

54 
	mIPPROTO_PUP
 = 12,

55 
	#IPPROTO_PUP
 
IPPROTO_PUP


	)

56 
	mIPPROTO_UDP
 = 17,

57 
	#IPPROTO_UDP
 
IPPROTO_UDP


	)

58 
	mIPPROTO_IDP
 = 22,

59 
	#IPPROTO_IDP
 
IPPROTO_IDP


	)

60 
	mIPPROTO_TP
 = 29,

61 
	#IPPROTO_TP
 
IPPROTO_TP


	)

62 
	mIPPROTO_DCCP
 = 33,

63 
	#IPPROTO_DCCP
 
IPPROTO_DCCP


	)

64 
	mIPPROTO_IPV6
 = 41,

65 
	#IPPROTO_IPV6
 
IPPROTO_IPV6


	)

66 
	mIPPROTO_RSVP
 = 46,

67 
	#IPPROTO_RSVP
 
IPPROTO_RSVP


	)

68 
	mIPPROTO_GRE
 = 47,

69 
	#IPPROTO_GRE
 
IPPROTO_GRE


	)

70 
	mIPPROTO_ESP
 = 50,

71 
	#IPPROTO_ESP
 
IPPROTO_ESP


	)

72 
	mIPPROTO_AH
 = 51,

73 
	#IPPROTO_AH
 
IPPROTO_AH


	)

74 
	mIPPROTO_MTP
 = 92,

75 
	#IPPROTO_MTP
 
IPPROTO_MTP


	)

76 
	mIPPROTO_BEETPH
 = 94,

77 
	#IPPROTO_BEETPH
 
IPPROTO_BEETPH


	)

78 
	mIPPROTO_ENCAP
 = 98,

79 
	#IPPROTO_ENCAP
 
IPPROTO_ENCAP


	)

80 
	mIPPROTO_PIM
 = 103,

81 
	#IPPROTO_PIM
 
IPPROTO_PIM


	)

82 
	mIPPROTO_COMP
 = 108,

83 
	#IPPROTO_COMP
 
IPPROTO_COMP


	)

84 
	mIPPROTO_SCTP
 = 132,

85 
	#IPPROTO_SCTP
 
IPPROTO_SCTP


	)

86 
	mIPPROTO_UDPLITE
 = 136,

87 
	#IPPROTO_UDPLITE
 
IPPROTO_UDPLITE


	)

88 
	mIPPROTO_MPLS
 = 137,

89 
	#IPPROTO_MPLS
 
IPPROTO_MPLS


	)

90 
	mIPPROTO_RAW
 = 255,

91 
	#IPPROTO_RAW
 
IPPROTO_RAW


	)

92 
	mIPPROTO_MAX


98 #iâdeà
__USE_KERNEL_IPV6_DEFS


101 
	mIPPROTO_HOPOPTS
 = 0,

102 
	#IPPROTO_HOPOPTS
 
IPPROTO_HOPOPTS


	)

103 
	mIPPROTO_ROUTING
 = 43,

104 
	#IPPROTO_ROUTING
 
IPPROTO_ROUTING


	)

105 
	mIPPROTO_FRAGMENT
 = 44,

106 
	#IPPROTO_FRAGMENT
 
IPPROTO_FRAGMENT


	)

107 
	mIPPROTO_ICMPV6
 = 58,

108 
	#IPPROTO_ICMPV6
 
IPPROTO_ICMPV6


	)

109 
	mIPPROTO_NONE
 = 59,

110 
	#IPPROTO_NONE
 
IPPROTO_NONE


	)

111 
	mIPPROTO_DSTOPTS
 = 60,

112 
	#IPPROTO_DSTOPTS
 
IPPROTO_DSTOPTS


	)

113 
	mIPPROTO_MH
 = 135

114 
	#IPPROTO_MH
 
IPPROTO_MH


	)

119 
ušt16_t
 
	tš_pÜt_t
;

124 
	mIPPORT_ECHO
 = 7,

125 
	mIPPORT_DISCARD
 = 9,

126 
	mIPPORT_SYSTAT
 = 11,

127 
	mIPPORT_DAYTIME
 = 13,

128 
	mIPPORT_NETSTAT
 = 15,

129 
	mIPPORT_FTP
 = 21,

130 
	mIPPORT_TELNET
 = 23,

131 
	mIPPORT_SMTP
 = 25,

132 
	mIPPORT_TIMESERVER
 = 37,

133 
	mIPPORT_NAMESERVER
 = 42,

134 
	mIPPORT_WHOIS
 = 43,

135 
	mIPPORT_MTP
 = 57,

137 
	mIPPORT_TFTP
 = 69,

138 
	mIPPORT_RJE
 = 77,

139 
	mIPPORT_FINGER
 = 79,

140 
	mIPPORT_TTYLINK
 = 87,

141 
	mIPPORT_SUPDUP
 = 95,

144 
	mIPPORT_EXECSERVER
 = 512,

145 
	mIPPORT_LOGINSERVER
 = 513,

146 
	mIPPORT_CMDSERVER
 = 514,

147 
	mIPPORT_EFSSERVER
 = 520,

150 
	mIPPORT_BIFFUDP
 = 512,

151 
	mIPPORT_WHOSERVER
 = 513,

152 
	mIPPORT_ROUTESERVER
 = 520,

155 
	mIPPORT_RESERVED
 = 1024,

158 
	mIPPORT_USERRESERVED
 = 5000

166 
	#IN_CLASSA
(
a
è((((
š_addr_t
)×)è& 0x80000000è=ğ0)

	)

167 
	#IN_CLASSA_NET
 0xff000000

	)

168 
	#IN_CLASSA_NSHIFT
 24

	)

169 
	#IN_CLASSA_HOST
 (0xfffffffà& ~
IN_CLASSA_NET
)

	)

170 
	#IN_CLASSA_MAX
 128

	)

172 
	#IN_CLASSB
(
a
è((((
š_addr_t
)×)è& 0xc0000000è=ğ0x80000000)

	)

173 
	#IN_CLASSB_NET
 0xffff0000

	)

174 
	#IN_CLASSB_NSHIFT
 16

	)

175 
	#IN_CLASSB_HOST
 (0xfffffffà& ~
IN_CLASSB_NET
)

	)

176 
	#IN_CLASSB_MAX
 65536

	)

178 
	#IN_CLASSC
(
a
è((((
š_addr_t
)×)è& 0xe0000000è=ğ0xc0000000)

	)

179 
	#IN_CLASSC_NET
 0xffffff00

	)

180 
	#IN_CLASSC_NSHIFT
 8

	)

181 
	#IN_CLASSC_HOST
 (0xfffffffà& ~
IN_CLASSC_NET
)

	)

183 
	#IN_CLASSD
(
a
è((((
š_addr_t
)×)è& 0xf0000000è=ğ0xe0000000)

	)

184 
	#IN_MULTICAST
(
a
è
	`IN_CLASSD
×)

	)

186 
	#IN_EXPERIMENTAL
(
a
è((((
š_addr_t
)×)è& 0xe0000000è=ğ0xe0000000)

	)

187 
	#IN_BADCLASS
(
a
è((((
š_addr_t
)×)è& 0xf0000000è=ğ0xf0000000)

	)

190 
	#INADDR_ANY
 ((
š_addr_t
è0x00000000)

	)

192 
	#INADDR_BROADCAST
 ((
š_addr_t
è0xffffffff)

	)

194 
	#INADDR_NONE
 ((
š_addr_t
è0xffffffff)

	)

197 
	#IN_LOOPBACKNET
 127

	)

199 #iâdeà
INADDR_LOOPBACK


200 
	#INADDR_LOOPBACK
 ((
š_addr_t
è0x7f000001è

	)

204 
	#INADDR_UNSPEC_GROUP
 ((
š_addr_t
è0xe0000000è

	)

205 
	#INADDR_ALLHOSTS_GROUP
 ((
š_addr_t
è0xe0000001è

	)

206 
	#INADDR_ALLRTRS_GROUP
 ((
š_addr_t
è0xe0000002è

	)

207 
	#INADDR_MAX_LOCAL_GROUP
 ((
š_addr_t
è0xe00000ffè

	)

209 #iâdeà
__USE_KERNEL_IPV6_DEFS


211 
	sš6_addr


215 
ušt8_t
 
	m__u6_addr8
[16];

216 #ifdeà
__USE_MISC


217 
ušt16_t
 
	m__u6_addr16
[8];

218 
ušt32_t
 
	m__u6_addr32
[4];

220 } 
	m__š6_u
;

221 
	#s6_addr
 
__š6_u
.
__u6_addr8


	)

222 #ifdeà
__USE_MISC


223 
	#s6_addr16
 
__š6_u
.
__u6_addr16


	)

224 
	#s6_addr32
 
__š6_u
.
__u6_addr32


	)

229 cÚ¡ 
š6_addr
 
š6addr_ªy
;

230 cÚ¡ 
š6_addr
 
š6addr_loİback
;

231 
	#IN6ADDR_ANY_INIT
 { { { 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 } } }

	)

232 
	#IN6ADDR_LOOPBACK_INIT
 { { { 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1 } } }

	)

234 
	#INET_ADDRSTRLEN
 16

	)

235 
	#INET6_ADDRSTRLEN
 46

	)

239 
	ssockaddr_š


241 
__SOCKADDR_COMMON
 (
sš_
);

242 
š_pÜt_t
 
	msš_pÜt
;

243 
š_addr
 
	msš_addr
;

246 
	msš_z”o
[ (
sockaddr
) -

247 
__SOCKADDR_COMMON_SIZE
 -

248  (
š_pÜt_t
) -

249  (
š_addr
)];

252 #iâdeà
__USE_KERNEL_IPV6_DEFS


254 
	ssockaddr_š6


256 
__SOCKADDR_COMMON
 (
sš6_
);

257 
š_pÜt_t
 
	msš6_pÜt
;

258 
ušt32_t
 
	msš6_æowšfo
;

259 
š6_addr
 
	msš6_addr
;

260 
ušt32_t
 
	msš6_scİe_id
;

264 #ifdeà
__USE_MISC


266 
	s_m»q


269 
š_addr
 
	mimr_muÉŸddr
;

272 
š_addr
 
	mimr_š‹rçû
;

275 
	s_m»q_sourû


278 
š_addr
 
	mimr_muÉŸddr
;

281 
š_addr
 
	mimr_š‹rçû
;

284 
š_addr
 
	mimr_sourûaddr
;

288 #iâdeà
__USE_KERNEL_IPV6_DEFS


290 
	sv6_m»q


293 
š6_addr
 
	mv6mr_muÉŸddr
;

296 
	mv6mr_š‹rçû
;

300 #ifdeà
__USE_MISC


302 
	sgroup_»q


305 
ušt32_t
 
	mgr_š‹rçû
;

308 
sockaddr_¡Üage
 
	mgr_group
;

311 
	sgroup_sourû_»q


314 
ušt32_t
 
	mg¤_š‹rçû
;

317 
sockaddr_¡Üage
 
	mg¤_group
;

320 
sockaddr_¡Üage
 
	mg¤_sourû
;

325 
	s_msf‹r


328 
š_addr
 
	mimsf_muÉŸddr
;

331 
š_addr
 
	mimsf_š‹rçû
;

334 
ušt32_t
 
	mimsf_fmode
;

337 
ušt32_t
 
	mimsf_num¤c
;

339 
š_addr
 
	mimsf_¦i¡
[1];

342 
	#IP_MSFILTER_SIZE
(
num¤c
è( (
_msf‹r
) \

343 -  (
š_addr
) \

344 + (
num¤c
è*  (
š_addr
))

	)

346 
	sgroup_f‹r


349 
ušt32_t
 
	mgf_š‹rçû
;

352 
sockaddr_¡Üage
 
	mgf_group
;

355 
ušt32_t
 
	mgf_fmode
;

358 
ušt32_t
 
	mgf_num¤c
;

360 
sockaddr_¡Üage
 
	mgf_¦i¡
[1];

363 
	#GROUP_FILTER_SIZE
(
num¤c
è( (
group_f‹r
) \

364 -  (
sockaddr_¡Üage
) \

365 + ((
num¤c
) \

366 *  (
sockaddr_¡Üage
)))

	)

376 
ušt32_t
 
	$Áohl
 (
ušt32_t
 
__ÃÚg
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

377 
ušt16_t
 
	$Áohs
 (
ušt16_t
 
__ÃtshÜt
)

378 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

379 
ušt32_t
 
	$htÚl
 (
ušt32_t
 
__ho¡lÚg
)

380 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

381 
ušt16_t
 
	$htÚs
 (
ušt16_t
 
__ho¡shÜt
)

382 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

384 
	~<’dŸn.h
>

387 
	~<b™s/by‹sw­.h
>

389 #ifdeà
__OPTIMIZE__


393 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


396 
	#Áohl
(
x
è(x)

	)

397 
	#Áohs
(
x
è(x)

	)

398 
	#htÚl
(
x
è(x)

	)

399 
	#htÚs
(
x
è(x)

	)

401 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


402 
	#Áohl
(
x
è
	`__bsw­_32
 (x)

	)

403 
	#Áohs
(
x
è
	`__bsw­_16
 (x)

	)

404 
	#htÚl
(
x
è
	`__bsw­_32
 (x)

	)

405 
	#htÚs
(
x
è
	`__bsw­_16
 (x)

	)

410 #ifdeà
__GNUC__


411 
	#IN6_IS_ADDR_UNSPECIFIED
(
a
) \

412 (
__ex‹nsiÚ__
 \

413 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

414 
__a
->
s6_addr32
[0] == 0 \

415 && 
__a
->
s6_addr32
[1] == 0 \

416 && 
__a
->
s6_addr32
[2] == 0 \

417 && 
__a
->
s6_addr32
[3] =ğ0; 
	}
}))

	)

419 
	#IN6_IS_ADDR_LOOPBACK
(
a
) \

420 (
__ex‹nsiÚ__
 \

421 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

422 
__a
->
s6_addr32
[0] == 0 \

423 && 
__a
->
s6_addr32
[1] == 0 \

424 && 
__a
->
s6_addr32
[2] == 0 \

425 && 
__a
->
s6_addr32
[3] =ğ
	`htÚl
 (1); }))

	)

427 
	#IN6_IS_ADDR_LINKLOCAL
(
a
) \

428 (
__ex‹nsiÚ__
 \

429 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

430 (
__a
->
s6_addr32
[0] & 
	`htÚl
 (0xffc00000)è=ğhtÚÈ(0xã800000); }))

	)

432 
	#IN6_IS_ADDR_SITELOCAL
(
a
) \

433 (
__ex‹nsiÚ__
 \

434 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

435 (
__a
->
s6_addr32
[0] & 
	`htÚl
 (0xffc00000)è=ğhtÚÈ(0xãc00000); }))

	)

437 
	#IN6_IS_ADDR_V4MAPPED
(
a
) \

438 (
__ex‹nsiÚ__
 \

439 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

440 
__a
->
s6_addr32
[0] == 0 \

441 && 
__a
->
s6_addr32
[1] == 0 \

442 && 
__a
->
s6_addr32
[2] =ğ
	`htÚl
 (0xffff); }))

	)

444 
	#IN6_IS_ADDR_V4COMPAT
(
a
) \

445 (
__ex‹nsiÚ__
 \

446 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

447 
__a
->
s6_addr32
[0] == 0 \

448 && 
__a
->
s6_addr32
[1] == 0 \

449 && 
__a
->
s6_addr32
[2] == 0 \

450 && 
	`Áohl
 (
__a
->
s6_addr32
[3]è> 1; }))

	)

452 
	#IN6_ARE_ADDR_EQUAL
(
a
,
b
) \

453 (
__ex‹nsiÚ__
 \

454 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

455 cÚ¡ 
š6_addr
 *
__b
 = (cÚ¡ š6_add¸*è(
b
); \

456 
__a
->
s6_addr32
[0] =ğ
__b
->s6_addr32[0] \

457 && 
__a
->
s6_addr32
[1] =ğ
__b
->s6_addr32[1] \

458 && 
__a
->
s6_addr32
[2] =ğ
__b
->s6_addr32[2] \

459 && 
__a
->
s6_addr32
[3] =ğ
__b
->s6_addr32[3]; }))

	)

461 
	#IN6_IS_ADDR_UNSPECIFIED
(
a
) \

462 (((cÚ¡ 
ušt32_t
 *è(
a
))[0] == 0 \

463 && ((cÚ¡ 
ušt32_t
 *è(
a
))[1] == 0 \

464 && ((cÚ¡ 
ušt32_t
 *è(
a
))[2] == 0 \

465 && ((cÚ¡ 
ušt32_t
 *è(
a
))[3] =ğ0)

	)

467 
	#IN6_IS_ADDR_LOOPBACK
(
a
) \

468 (((cÚ¡ 
ušt32_t
 *è(
a
))[0] == 0 \

469 && ((cÚ¡ 
ušt32_t
 *è(
a
))[1] == 0 \

470 && ((cÚ¡ 
ušt32_t
 *è(
a
))[2] == 0 \

471 && ((cÚ¡ 
ušt32_t
 *è(
a
))[3] =ğ
	`htÚl
 (1))

	)

473 
	#IN6_IS_ADDR_LINKLOCAL
(
a
) \

474 ((((cÚ¡ 
ušt32_t
 *è(
a
))[0] & 
	`htÚl
 (0xffc00000)) \

475 =ğ
	`htÚl
 (0xã800000))

	)

477 
	#IN6_IS_ADDR_SITELOCAL
(
a
) \

478 ((((cÚ¡ 
ušt32_t
 *è(
a
))[0] & 
	`htÚl
 (0xffc00000)) \

479 =ğ
	`htÚl
 (0xãc00000))

	)

481 
	#IN6_IS_ADDR_V4MAPPED
(
a
) \

482 ((((cÚ¡ 
ušt32_t
 *è(
a
))[0] == 0) \

483 && (((cÚ¡ 
ušt32_t
 *è(
a
))[1] == 0) \

484 && (((cÚ¡ 
ušt32_t
 *è(
a
))[2] =ğ
	`htÚl
 (0xffff)))

	)

486 
	#IN6_IS_ADDR_V4COMPAT
(
a
) \

487 ((((cÚ¡ 
ušt32_t
 *è(
a
))[0] == 0) \

488 && (((cÚ¡ 
ušt32_t
 *è(
a
))[1] == 0) \

489 && (((cÚ¡ 
ušt32_t
 *è(
a
))[2] == 0) \

490 && (
	`Áohl
 (((cÚ¡ 
ušt32_t
 *è(
a
))[3]è> 1))

	)

492 
	#IN6_ARE_ADDR_EQUAL
(
a
,
b
) \

493 ((((cÚ¡ 
ušt32_t
 *è(
a
))[0] =ğ((cÚ¡ ušt32_ˆ*è(
b
))[0]) \

494 && (((cÚ¡ 
ušt32_t
 *è(
a
))[1] =ğ((cÚ¡ ušt32_ˆ*è(
b
))[1]) \

495 && (((cÚ¡ 
ušt32_t
 *è(
a
))[2] =ğ((cÚ¡ ušt32_ˆ*è(
b
))[2]) \

496 && (((cÚ¡ 
ušt32_t
 *è(
a
))[3] =ğ((cÚ¡ ušt32_ˆ*è(
b
))[3]))

	)

499 
	#IN6_IS_ADDR_MULTICAST
(
a
è(((cÚ¡ 
ušt8_t
 *è×))[0] =ğ0xff)

	)

501 #ifdeà
__USE_MISC


503 
	$bšd»svpÜt
 (
__sockfd
, 
sockaddr_š
 *
__sock_š
è
__THROW
;

506 
	$bšd»svpÜt6
 (
__sockfd
, 
sockaddr_š6
 *
__sock_š
)

507 
__THROW
;

511 
	#IN6_IS_ADDR_MC_NODELOCAL
(
a
) \

512 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

513 && ((((cÚ¡ 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0x1))

	)

515 
	#IN6_IS_ADDR_MC_LINKLOCAL
(
a
) \

516 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

517 && ((((cÚ¡ 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0x2))

	)

519 
	#IN6_IS_ADDR_MC_SITELOCAL
(
a
) \

520 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

521 && ((((cÚ¡ 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0x5))

	)

523 
	#IN6_IS_ADDR_MC_ORGLOCAL
(
a
) \

524 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

525 && ((((cÚ¡ 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0x8))

	)

527 
	#IN6_IS_ADDR_MC_GLOBAL
(
a
) \

528 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

529 && ((((cÚ¡ 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0xe))

	)

532 #ifdeà
__USE_GNU


533 
cmsghdr
;

535 #iâdeà
__USE_KERNEL_IPV6_DEFS


537 
	sš6_pktšfo


539 
š6_addr
 
i6_addr
;

540 
i6_ifšdex
;

544 
	s6_mtušfo


546 
sockaddr_š6
 
6m_addr
;

547 
ušt32_t
 
6m_mtu
;

552 
	$š‘6_İtiÚ_¥aû
 (
__nby‹s
)

553 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

554 
	$š‘6_İtiÚ_š™
 (*
__bp
, 
cmsghdr
 **
__cmsgp
,

555 
__ty³
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

556 
	$š‘6_İtiÚ_­³nd
 (
cmsghdr
 *
__cmsg
,

557 cÚ¡ 
ušt8_t
 *
__ty³p
, 
__muÉx
,

558 
__¶usy
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

559 
ušt8_t
 *
	$š‘6_İtiÚ_®loc
 (
cmsghdr
 *
__cmsg
, 
__d©®’
,

560 
__muÉx
, 
__¶usy
)

561 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

562 
	$š‘6_İtiÚ_Ãxt
 (cÚ¡ 
cmsghdr
 *
__cmsg
,

563 
ušt8_t
 **
__Œp
)

564 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

565 
	$š‘6_İtiÚ_fšd
 (cÚ¡ 
cmsghdr
 *
__cmsg
,

566 
ušt8_t
 **
__Œp
, 
__ty³
)

567 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

571 
	$š‘6_İt_š™
 (*
__extbuf
, 
sockËn_t
 
__ex’
è
__THROW
;

572 
	$š‘6_İt_­³nd
 (*
__extbuf
, 
sockËn_t
 
__ex’
, 
__off£t
,

573 
ušt8_t
 
__ty³
, 
sockËn_t
 
__Ën
, ušt8_ˆ
__®ign
,

574 **
__d©abuå
è
__THROW
;

575 
	$š‘6_İt_fšish
 (*
__extbuf
, 
sockËn_t
 
__ex’
, 
__off£t
)

576 
__THROW
;

577 
	$š‘6_İt_£t_v®
 (*
__d©abuf
, 
__off£t
, *
__v®
,

578 
sockËn_t
 
__v®Ën
è
__THROW
;

579 
	$š‘6_İt_Ãxt
 (*
__extbuf
, 
sockËn_t
 
__ex’
, 
__off£t
,

580 
ušt8_t
 *
__ty³p
, 
sockËn_t
 *
__ËÅ
,

581 **
__d©abuå
è
__THROW
;

582 
	$š‘6_İt_fšd
 (*
__extbuf
, 
sockËn_t
 
__ex’
, 
__off£t
,

583 
ušt8_t
 
__ty³
, 
sockËn_t
 *
__ËÅ
,

584 **
__d©abuå
è
__THROW
;

585 
	$š‘6_İt_g‘_v®
 (*
__d©abuf
, 
__off£t
, *
__v®
,

586 
sockËn_t
 
__v®Ën
è
__THROW
;

590 
sockËn_t
 
	$š‘6_¹h_¥aû
 (
__ty³
, 
__£gm’ts
è
__THROW
;

591 *
	$š‘6_¹h_š™
 (*
__bp
, 
sockËn_t
 
__bp_Ën
, 
__ty³
,

592 
__£gm’ts
è
__THROW
;

593 
	$š‘6_¹h_add
 (*
__bp
, cÚ¡ 
š6_addr
 *
__addr
è
__THROW
;

594 
	$š‘6_¹h_»v”£
 (cÚ¡ *
__š
, *
__out
è
__THROW
;

595 
	$š‘6_¹h_£gm’ts
 (cÚ¡ *
__bp
è
__THROW
;

596 
š6_addr
 *
	$š‘6_¹h_g‘addr
 (cÚ¡ *
__bp
, 
__šdex
)

597 
__THROW
;

603 
	$g‘v4sourûf‹r
 (
__s
, 
š_addr
 
__š‹rçû_addr
,

604 
š_addr
 
__group
, 
ušt32_t
 *
__fmode
,

605 
ušt32_t
 *
__num¤c
, 
š_addr
 *
__¦i¡
)

606 
__THROW
;

609 
	$£tv4sourûf‹r
 (
__s
, 
š_addr
 
__š‹rçû_addr
,

610 
š_addr
 
__group
, 
ušt32_t
 
__fmode
,

611 
ušt32_t
 
__num¤c
,

612 cÚ¡ 
š_addr
 *
__¦i¡
)

613 
__THROW
;

617 
	$g‘sourûf‹r
 (
__s
, 
ušt32_t
 
__š‹rçû_addr
,

618 cÚ¡ 
sockaddr
 *
__group
,

619 
sockËn_t
 
__grou¶’
, 
ušt32_t
 *
__fmode
,

620 
ušt32_t
 *
__num¤c
,

621 
sockaddr_¡Üage
 *
__¦i¡
è
__THROW
;

624 
	$£tsourûf‹r
 (
__s
, 
ušt32_t
 
__š‹rçû_addr
,

625 cÚ¡ 
sockaddr
 *
__group
,

626 
sockËn_t
 
__grou¶’
, 
ušt32_t
 
__fmode
,

627 
ušt32_t
 
__num¤c
,

628 cÚ¡ 
sockaddr_¡Üage
 *
__¦i¡
è
__THROW
;

631 
__END_DECLS


	@/usr/include/netinet/tcp.h

32 #iâdeà
_NETINET_TCP_H


33 
	#_NETINET_TCP_H
 1

	)

35 
	~<ã©u»s.h
>

40 
	#TCP_NODELAY
 1

	)

41 
	#TCP_MAXSEG
 2

	)

42 
	#TCP_CORK
 3

	)

43 
	#TCP_KEEPIDLE
 4

	)

44 
	#TCP_KEEPINTVL
 5

	)

45 
	#TCP_KEEPCNT
 6

	)

46 
	#TCP_SYNCNT
 7

	)

47 
	#TCP_LINGER2
 8

	)

48 
	#TCP_DEFER_ACCEPT
 9

	)

49 
	#TCP_WINDOW_CLAMP
 10

	)

50 
	#TCP_INFO
 11

	)

51 
	#TCP_QUICKACK
 12

	)

52 
	#TCP_CONGESTION
 13

	)

53 
	#TCP_MD5SIG
 14

	)

54 
	#TCP_COOKIE_TRANSACTIONS
 15

	)

55 
	#TCP_THIN_LINEAR_TIMEOUTS
 16

	)

56 
	#TCP_THIN_DUPACK
 17

	)

57 
	#TCP_USER_TIMEOUT
 18

	)

58 
	#TCP_REPAIR
 19

	)

59 
	#TCP_REPAIR_QUEUE
 20

	)

60 
	#TCP_QUEUE_SEQ
 21

	)

61 
	#TCP_REPAIR_OPTIONS
 22

	)

62 
	#TCP_FASTOPEN
 23

	)

63 
	#TCP_TIMESTAMP
 24

	)

64 
	#TCP_NOTSENT_LOWAT
 25

	)

66 
	#TCP_CC_INFO
 26

	)

68 
	#TCP_SAVE_SYN
 27

	)

70 
	#TCP_SAVED_SYN
 28

	)

73 #ifdeà
__USE_MISC


74 
	~<sys/ty³s.h
>

75 
	~<sys/sock‘.h
>

77 
u_št32_t
 
	ttı_£q
;

82 
	stıhdr


84 
__ex‹nsiÚ__
 union

88 
u_št16_t
 
	mth_¥Üt
;

89 
u_št16_t
 
	mth_dpÜt
;

90 
tı_£q
 
	mth_£q
;

91 
tı_£q
 
	mth_ack
;

92 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


93 
u_št8_t
 
	mth_x2
:4;

94 
u_št8_t
 
	mth_off
:4;

96 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


97 
u_št8_t
 
	mth_off
:4;

98 
u_št8_t
 
	mth_x2
:4;

100 
u_št8_t
 
	mth_æags
;

101 
	#TH_FIN
 0x01

	)

102 
	#TH_SYN
 0x02

	)

103 
	#TH_RST
 0x04

	)

104 
	#TH_PUSH
 0x08

	)

105 
	#TH_ACK
 0x10

	)

106 
	#TH_URG
 0x20

	)

107 
u_št16_t
 
	mth_wš
;

108 
u_št16_t
 
	mth_sum
;

109 
u_št16_t
 
	mth_u½
;

113 
u_št16_t
 
	msourû
;

114 
u_št16_t
 
	mde¡
;

115 
u_št32_t
 
	m£q
;

116 
u_št32_t
 
	mack_£q
;

117 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


118 
u_št16_t
 
	m»s1
:4;

119 
u_št16_t
 
	mdoff
:4;

120 
u_št16_t
 
	mfš
:1;

121 
u_št16_t
 
	msyn
:1;

122 
u_št16_t
 
	mr¡
:1;

123 
u_št16_t
 
	mpsh
:1;

124 
u_št16_t
 
	mack
:1;

125 
u_št16_t
 
	murg
:1;

126 
u_št16_t
 
	m»s2
:2;

127 #–ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


128 
u_št16_t
 
	mdoff
:4;

129 
u_št16_t
 
	m»s1
:4;

130 
u_št16_t
 
	m»s2
:2;

131 
u_št16_t
 
	murg
:1;

132 
u_št16_t
 
	mack
:1;

133 
u_št16_t
 
	mpsh
:1;

134 
u_št16_t
 
	mr¡
:1;

135 
u_št16_t
 
	msyn
:1;

136 
u_št16_t
 
	mfš
:1;

140 
u_št16_t
 
	mwšdow
;

141 
u_št16_t
 
	mcheck
;

142 
u_št16_t
 
	murg_±r
;

149 
	mTCP_ESTABLISHED
 = 1,

150 
	mTCP_SYN_SENT
,

151 
	mTCP_SYN_RECV
,

152 
	mTCP_FIN_WAIT1
,

153 
	mTCP_FIN_WAIT2
,

154 
	mTCP_TIME_WAIT
,

155 
	mTCP_CLOSE
,

156 
	mTCP_CLOSE_WAIT
,

157 
	mTCP_LAST_ACK
,

158 
	mTCP_LISTEN
,

159 
	mTCP_CLOSING


162 
	#TCPOPT_EOL
 0

	)

163 
	#TCPOPT_NOP
 1

	)

164 
	#TCPOPT_MAXSEG
 2

	)

165 
	#TCPOLEN_MAXSEG
 4

	)

166 
	#TCPOPT_WINDOW
 3

	)

167 
	#TCPOLEN_WINDOW
 3

	)

168 
	#TCPOPT_SACK_PERMITTED
 4

	)

169 
	#TCPOLEN_SACK_PERMITTED
 2

	)

170 
	#TCPOPT_SACK
 5

	)

171 
	#TCPOPT_TIMESTAMP
 8

	)

172 
	#TCPOLEN_TIMESTAMP
 10

	)

173 
	#TCPOLEN_TSTAMP_APPA
 (
TCPOLEN_TIMESTAMP
+2è

	)

175 
	#TCPOPT_TSTAMP_HDR
 \

176 (
TCPOPT_NOP
<<24|TCPOPT_NOP<<16|
TCPOPT_TIMESTAMP
<<8|
TCPOLEN_TIMESTAMP
)

	)

184 
	#TCP_MSS
 512

	)

186 
	#TCP_MAXWIN
 65535

	)

188 
	#TCP_MAX_WINSHIFT
 14

	)

190 
	#SOL_TCP
 6

	)

193 
	#TCPI_OPT_TIMESTAMPS
 1

	)

194 
	#TCPI_OPT_SACK
 2

	)

195 
	#TCPI_OPT_WSCALE
 4

	)

196 
	#TCPI_OPT_ECN
 8

	)

197 
	#TCPI_OPT_ECN_SEEN
 16

	)

198 
	#TCPI_OPT_SYN_DATA
 32

	)

201 
	etı_ÿ_¡©e


203 
	mTCP_CA_O³n
 = 0,

204 
	mTCP_CA_DisÜd”
 = 1,

205 
	mTCP_CA_CWR
 = 2,

206 
	mTCP_CA_Recov”y
 = 3,

207 
	mTCP_CA_Loss
 = 4

210 
	stı_šfo


212 
u_št8_t
 
	mtıi_¡©e
;

213 
u_št8_t
 
	mtıi_ÿ_¡©e
;

214 
u_št8_t
 
	mtıi_»Œªsm™s
;

215 
u_št8_t
 
	mtıi_´obes
;

216 
u_št8_t
 
	mtıi_backoff
;

217 
u_št8_t
 
	mtıi_İtiÚs
;

218 
u_št8_t
 
	mtıi_¢d_wsÿË
 : 4, 
	mtıi_rcv_wsÿË
 : 4;

220 
u_št32_t
 
	mtıi_¹o
;

221 
u_št32_t
 
	mtıi_©o
;

222 
u_št32_t
 
	mtıi_¢d_mss
;

223 
u_št32_t
 
	mtıi_rcv_mss
;

225 
u_št32_t
 
	mtıi_uÇcked
;

226 
u_št32_t
 
	mtıi_§cked
;

227 
u_št32_t
 
	mtıi_lo¡
;

228 
u_št32_t
 
	mtıi_»Œªs
;

229 
u_št32_t
 
	mtıi_çck‘s
;

232 
u_št32_t
 
	mtıi_Ï¡_d©a_£Á
;

233 
u_št32_t
 
	mtıi_Ï¡_ack_£Á
;

234 
u_št32_t
 
	mtıi_Ï¡_d©a_»cv
;

235 
u_št32_t
 
	mtıi_Ï¡_ack_»cv
;

238 
u_št32_t
 
	mtıi_pmtu
;

239 
u_št32_t
 
	mtıi_rcv_s¡h»sh
;

240 
u_št32_t
 
	mtıi_¹t
;

241 
u_št32_t
 
	mtıi_¹tv¬
;

242 
u_št32_t
 
	mtıi_¢d_s¡h»sh
;

243 
u_št32_t
 
	mtıi_¢d_cwnd
;

244 
u_št32_t
 
	mtıi_advmss
;

245 
u_št32_t
 
	mtıi_»Üd”šg
;

247 
u_št32_t
 
	mtıi_rcv_¹t
;

248 
u_št32_t
 
	mtıi_rcv_¥aû
;

250 
u_št32_t
 
	mtıi_tÙ®_»Œªs
;

255 
	#TCP_MD5SIG_MAXKEYLEN
 80

	)

257 
	stı_md5sig


259 
sockaddr_¡Üage
 
	mtım_addr
;

260 
u_št16_t
 
	m__tım_·d1
;

261 
u_št16_t
 
	mtım_keyËn
;

262 
u_št32_t
 
	m__tım_·d2
;

263 
u_št8_t
 
	mtım_key
[
TCP_MD5SIG_MAXKEYLEN
];

267 
	stı_»·œ_İt


269 
u_št32_t
 
	mİt_code
;

270 
u_št32_t
 
	mİt_v®
;

276 
	mTCP_NO_QUEUE
,

277 
	mTCP_RECV_QUEUE
,

278 
	mTCP_SEND_QUEUE
,

279 
	mTCP_QUEUES_NR
,

283 
	#TCP_COOKIE_MIN
 8

	)

284 
	#TCP_COOKIE_MAX
 16

	)

285 
	#TCP_COOKIE_PAIR_SIZE
 (2*
TCP_COOKIE_MAX
)

	)

288 
	#TCP_COOKIE_IN_ALWAYS
 (1 << 0è

	)

289 
	#TCP_COOKIE_OUT_NEVER
 (1 << 1è

	)

293 
	#TCP_S_DATA_IN
 (1 << 2è

	)

294 
	#TCP_S_DATA_OUT
 (1 << 3è

	)

296 
	#TCP_MSS_DEFAULT
 536U

	)

297 
	#TCP_MSS_DESIRED
 1220U

	)

299 
	stı_cook›_Œª§ùiÚs


301 
u_št16_t
 
	mtıù_æags
;

302 
u_št8_t
 
	m__tıù_·d1
;

303 
u_št8_t
 
	mtıù_cook›_desœed
;

304 
u_št16_t
 
	mtıù_s_d©a_desœed
;

305 
u_št16_t
 
	mtıù_u£d
;

306 
u_št8_t
 
	mtıù_v®ue
[
TCP_MSS_DEFAULT
];

	@/usr/include/poll.h

1 
	~<sys/pŞl.h
>

	@/usr/include/pthread.h

18 #iâdeà
_PTHREAD_H


19 
	#_PTHREAD_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	~<’dŸn.h
>

23 
	~<sched.h
>

24 
	~<time.h
>

26 
	~<b™s/±h»adty³s.h
>

27 
	~<b™s/£tjmp.h
>

28 
	~<b™s/wÜdsize.h
>

34 
	mPTHREAD_CREATE_JOINABLE
,

35 
	#PTHREAD_CREATE_JOINABLE
 
PTHREAD_CREATE_JOINABLE


	)

36 
	mPTHREAD_CREATE_DETACHED


37 
	#PTHREAD_CREATE_DETACHED
 
PTHREAD_CREATE_DETACHED


	)

44 
	mPTHREAD_MUTEX_TIMED_NP
,

45 
	mPTHREAD_MUTEX_RECURSIVE_NP
,

46 
	mPTHREAD_MUTEX_ERRORCHECK_NP
,

47 
	mPTHREAD_MUTEX_ADAPTIVE_NP


48 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


50 
	mPTHREAD_MUTEX_NORMAL
 = 
PTHREAD_MUTEX_TIMED_NP
,

51 
	mPTHREAD_MUTEX_RECURSIVE
 = 
PTHREAD_MUTEX_RECURSIVE_NP
,

52 
	mPTHREAD_MUTEX_ERRORCHECK
 = 
PTHREAD_MUTEX_ERRORCHECK_NP
,

53 
	mPTHREAD_MUTEX_DEFAULT
 = 
PTHREAD_MUTEX_NORMAL


55 #ifdeà
__USE_GNU


57 , 
	mPTHREAD_MUTEX_FAST_NP
 = 
PTHREAD_MUTEX_TIMED_NP


62 #ifdeà
__USE_XOPEN2K


66 
	mPTHREAD_MUTEX_STALLED
,

67 
	mPTHREAD_MUTEX_STALLED_NP
 = 
PTHREAD_MUTEX_STALLED
,

68 
	mPTHREAD_MUTEX_ROBUST
,

69 
	mPTHREAD_MUTEX_ROBUST_NP
 = 
PTHREAD_MUTEX_ROBUST


74 #ià
defšed
 
__USE_POSIX199506
 || defšed 
__USE_UNIX98


78 
	mPTHREAD_PRIO_NONE
,

79 
	mPTHREAD_PRIO_INHERIT
,

80 
	mPTHREAD_PRIO_PROTECT


85 #ifdeà
__PTHREAD_MUTEX_HAVE_PREV


86 
	#PTHREAD_MUTEX_INITIALIZER
 \

87 { { 0, 0, 0, 0, 0, 
__PTHREAD_SPINS
, { 0, 0 } } }

	)

88 #ifdeà
__USE_GNU


89 
	#PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP
 \

90 { { 0, 0, 0, 0, 
PTHREAD_MUTEX_RECURSIVE_NP
, 
__PTHREAD_SPINS
, { 0, 0 } } }

	)

91 
	#PTHREAD_ERRORCHECK_MUTEX_INITIALIZER_NP
 \

92 { { 0, 0, 0, 0, 
PTHREAD_MUTEX_ERRORCHECK_NP
, 
__PTHREAD_SPINS
, { 0, 0 } } }

	)

93 
	#PTHREAD_ADAPTIVE_MUTEX_INITIALIZER_NP
 \

94 { { 0, 0, 0, 0, 
PTHREAD_MUTEX_ADAPTIVE_NP
, 
__PTHREAD_SPINS
, { 0, 0 } } }

	)

98 
	#PTHREAD_MUTEX_INITIALIZER
 \

99 { { 0, 0, 0, 0, 0, { 
__PTHREAD_SPINS
 } } }

	)

100 #ifdeà
__USE_GNU


101 
	#PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP
 \

102 { { 0, 0, 0, 
PTHREAD_MUTEX_RECURSIVE_NP
, 0, { 
__PTHREAD_SPINS
 } } }

	)

103 
	#PTHREAD_ERRORCHECK_MUTEX_INITIALIZER_NP
 \

104 { { 0, 0, 0, 
PTHREAD_MUTEX_ERRORCHECK_NP
, 0, { 
__PTHREAD_SPINS
 } } }

	)

105 
	#PTHREAD_ADAPTIVE_MUTEX_INITIALIZER_NP
 \

106 { { 0, 0, 0, 
PTHREAD_MUTEX_ADAPTIVE_NP
, 0, { 
__PTHREAD_SPINS
 } } }

	)

113 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


116 
	mPTHREAD_RWLOCK_PREFER_READER_NP
,

117 
	mPTHREAD_RWLOCK_PREFER_WRITER_NP
,

118 
	mPTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
,

119 
	mPTHREAD_RWLOCK_DEFAULT_NP
 = 
PTHREAD_RWLOCK_PREFER_READER_NP


125 #iâdeà
__PTHREAD_RWLOCK_INT_FLAGS_SHARED


126 #ià
__WORDSIZE
 == 64

127 
	#__PTHREAD_RWLOCK_INT_FLAGS_SHARED
 1

	)

132 
	#PTHREAD_RWLOCK_INITIALIZER
 \

133 { { 0, 0, 0, 0, 0, 0, 0, 0, 
__PTHREAD_RWLOCK_ELISION_EXTRA
, 0, 0 } }

	)

134 #ifdeà
__USE_GNU


135 #ifdeà
__PTHREAD_RWLOCK_INT_FLAGS_SHARED


136 
	#PTHREAD_RWLOCK_WRITER_NONRECURSIVE_INITIALIZER_NP
 \

137 { { 0, 0, 0, 0, 0, 0, 0, 0, 
__PTHREAD_RWLOCK_ELISION_EXTRA
, 0, \

138 
PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
 } }

	)

140 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


141 
	#PTHREAD_RWLOCK_WRITER_NONRECURSIVE_INITIALIZER_NP
 \

142 { { 0, 0, 0, 0, 0, 0, 
PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
, \

143 0, 
__PTHREAD_RWLOCK_ELISION_EXTRA
, 0, 0 } }

	)

145 
	#PTHREAD_RWLOCK_WRITER_NONRECURSIVE_INITIALIZER_NP
 \

146 { { 0, 0, 0, 0, 0, 0, 0, 0, 0, 
PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
,\

147 0 } }

	)

157 
	mPTHREAD_INHERIT_SCHED
,

158 
	#PTHREAD_INHERIT_SCHED
 
PTHREAD_INHERIT_SCHED


	)

159 
	mPTHREAD_EXPLICIT_SCHED


160 
	#PTHREAD_EXPLICIT_SCHED
 
PTHREAD_EXPLICIT_SCHED


	)

167 
	mPTHREAD_SCOPE_SYSTEM
,

168 
	#PTHREAD_SCOPE_SYSTEM
 
PTHREAD_SCOPE_SYSTEM


	)

169 
	mPTHREAD_SCOPE_PROCESS


170 
	#PTHREAD_SCOPE_PROCESS
 
PTHREAD_SCOPE_PROCESS


	)

177 
	mPTHREAD_PROCESS_PRIVATE
,

178 
	#PTHREAD_PROCESS_PRIVATE
 
PTHREAD_PROCESS_PRIVATE


	)

179 
	mPTHREAD_PROCESS_SHARED


180 
	#PTHREAD_PROCESS_SHARED
 
PTHREAD_PROCESS_SHARED


	)

186 
	#PTHREAD_COND_INITIALIZER
 { { 0, 0, 0, 0, 0, (*è0, 0, 0 } }

	)

190 
	s_±h»ad_ş—nup_bufãr


192 (*
	m__routše
) (*);

193 *
	m__¬g
;

194 
	m__ÿnûÉy³
;

195 
_±h»ad_ş—nup_bufãr
 *
	m__´ev
;

201 
	mPTHREAD_CANCEL_ENABLE
,

202 
	#PTHREAD_CANCEL_ENABLE
 
PTHREAD_CANCEL_ENABLE


	)

203 
	mPTHREAD_CANCEL_DISABLE


204 
	#PTHREAD_CANCEL_DISABLE
 
PTHREAD_CANCEL_DISABLE


	)

208 
	mPTHREAD_CANCEL_DEFERRED
,

209 
	#PTHREAD_CANCEL_DEFERRED
 
PTHREAD_CANCEL_DEFERRED


	)

210 
	mPTHREAD_CANCEL_ASYNCHRONOUS


211 
	#PTHREAD_CANCEL_ASYNCHRONOUS
 
PTHREAD_CANCEL_ASYNCHRONOUS


	)

213 
	#PTHREAD_CANCELED
 ((*è-1)

	)

217 
	#PTHREAD_ONCE_INIT
 0

	)

220 #ifdeà
__USE_XOPEN2K


224 
	#PTHREAD_BARRIER_SERIAL_THREAD
 -1

	)

228 
__BEGIN_DECLS


233 
	$±h»ad_ü—‹
 (
±h»ad_t
 *
__»¡riù
 
__Ãwth»ad
,

234 cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

235 *(*
__¡¬t_routše
) (*),

236 *
__»¡riù
 
__¬g
è
__THROWNL
 
	`__nÚnuÎ
 ((1, 3));

242 
	$±h»ad_ex™
 (*
__»tv®
è
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

250 
	`±h»ad_još
 (
±h»ad_t
 
__th
, **
__th»ad_»tuº
);

252 #ifdeà
__USE_GNU


255 
	$±h»ad_Œyjoš_Å
 (
±h»ad_t
 
__th
, **
__th»ad_»tuº
è
__THROW
;

263 
	`±h»ad_timedjoš_Å
 (
±h»ad_t
 
__th
, **
__th»ad_»tuº
,

264 cÚ¡ 
time¥ec
 *
__ab¡ime
);

271 
	$±h»ad_d‘ach
 (
±h»ad_t
 
__th
è
__THROW
;

275 
±h»ad_t
 
	$±h»ad_£lf
 (è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

278 
	$±h»ad_equ®
 (
±h»ad_t
 
__th»ad1
,…th»ad_ˆ
__th»ad2
)

279 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

287 
	$±h»ad_©Œ_š™
 (
±h»ad_©Œ_t
 *
__©Œ
è
__THROW
 
	`__nÚnuÎ
 ((1));

290 
	$±h»ad_©Œ_de¡roy
 (
±h»ad_©Œ_t
 *
__©Œ
)

291 
__THROW
 
	`__nÚnuÎ
 ((1));

294 
	$±h»ad_©Œ_g‘d‘ach¡©e
 (cÚ¡ 
±h»ad_©Œ_t
 *
__©Œ
,

295 *
__d‘ach¡©e
)

296 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

299 
	$±h»ad_©Œ_£td‘ach¡©e
 (
±h»ad_©Œ_t
 *
__©Œ
,

300 
__d‘ach¡©e
)

301 
__THROW
 
	`__nÚnuÎ
 ((1));

305 
	$±h»ad_©Œ_g‘gu¬dsize
 (cÚ¡ 
±h»ad_©Œ_t
 *
__©Œ
,

306 
size_t
 *
__gu¬dsize
)

307 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

310 
	$±h»ad_©Œ_£tgu¬dsize
 (
±h»ad_©Œ_t
 *
__©Œ
,

311 
size_t
 
__gu¬dsize
)

312 
__THROW
 
	`__nÚnuÎ
 ((1));

316 
	$±h»ad_©Œ_g‘sched·¿m
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

317 
sched_·¿m
 *
__»¡riù
 
__·¿m
)

318 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

321 
	$±h»ad_©Œ_£tsched·¿m
 (
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

322 cÚ¡ 
sched_·¿m
 *
__»¡riù


323 
__·¿m
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

326 
	$±h»ad_©Œ_g‘schedpŞicy
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù


327 
__©Œ
, *
__»¡riù
 
__pŞicy
)

328 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

331 
	$±h»ad_©Œ_£tschedpŞicy
 (
±h»ad_©Œ_t
 *
__©Œ
, 
__pŞicy
)

332 
__THROW
 
	`__nÚnuÎ
 ((1));

335 
	$±h»ad_©Œ_g‘šh”™sched
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù


336 
__©Œ
, *
__»¡riù
 
__šh”™
)

337 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

340 
	$±h»ad_©Œ_£tšh”™sched
 (
±h»ad_©Œ_t
 *
__©Œ
,

341 
__šh”™
)

342 
__THROW
 
	`__nÚnuÎ
 ((1));

346 
	$±h»ad_©Œ_g‘scİe
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

347 *
__»¡riù
 
__scİe
)

348 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

351 
	$±h»ad_©Œ_£tscİe
 (
±h»ad_©Œ_t
 *
__©Œ
, 
__scİe
)

352 
__THROW
 
	`__nÚnuÎ
 ((1));

355 
	$±h»ad_©Œ_g‘¡ackaddr
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù


356 
__©Œ
, **
__»¡riù
 
__¡ackaddr
)

357 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__©Œibu‹_d•»ÿ‹d__
;

363 
	$±h»ad_©Œ_£t¡ackaddr
 (
±h»ad_©Œ_t
 *
__©Œ
,

364 *
__¡ackaddr
)

365 
__THROW
 
	`__nÚnuÎ
 ((1)è
__©Œibu‹_d•»ÿ‹d__
;

368 
	$±h»ad_©Œ_g‘¡acksize
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù


369 
__©Œ
, 
size_t
 *
__»¡riù
 
__¡acksize
)

370 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

375 
	$±h»ad_©Œ_£t¡acksize
 (
±h»ad_©Œ_t
 *
__©Œ
,

376 
size_t
 
__¡acksize
)

377 
__THROW
 
	`__nÚnuÎ
 ((1));

379 #ifdeà
__USE_XOPEN2K


381 
	$±h»ad_©Œ_g‘¡ack
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

382 **
__»¡riù
 
__¡ackaddr
,

383 
size_t
 *
__»¡riù
 
__¡acksize
)

384 
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3));

389 
	$±h»ad_©Œ_£t¡ack
 (
±h»ad_©Œ_t
 *
__©Œ
, *
__¡ackaddr
,

390 
size_t
 
__¡acksize
è
__THROW
 
	`__nÚnuÎ
 ((1));

393 #ifdeà
__USE_GNU


396 
	$±h»ad_©Œ_£ffš™y_Å
 (
±h»ad_©Œ_t
 *
__©Œ
,

397 
size_t
 
__ıu£tsize
,

398 cÚ¡ 
ıu_£t_t
 *
__ıu£t
)

399 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

403 
	$±h»ad_©Œ_g‘affš™y_Å
 (cÚ¡ 
±h»ad_©Œ_t
 *
__©Œ
,

404 
size_t
 
__ıu£tsize
,

405 
ıu_£t_t
 *
__ıu£t
)

406 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

409 
	$±h»ad_g‘©Œ_deçuÉ_Å
 (
±h»ad_©Œ_t
 *
__©Œ
)

410 
__THROW
 
	`__nÚnuÎ
 ((1));

414 
	$±h»ad_£‰r_deçuÉ_Å
 (cÚ¡ 
±h»ad_©Œ_t
 *
__©Œ
)

415 
__THROW
 
	`__nÚnuÎ
 ((1));

420 
	$±h»ad_g‘©Œ_Å
 (
±h»ad_t
 
__th
, 
±h»ad_©Œ_t
 *
__©Œ
)

421 
__THROW
 
	`__nÚnuÎ
 ((2));

429 
	$±h»ad_£tsched·¿m
 (
±h»ad_t
 
__rg‘_th»ad
, 
__pŞicy
,

430 cÚ¡ 
sched_·¿m
 *
__·¿m
)

431 
__THROW
 
	`__nÚnuÎ
 ((3));

434 
	$±h»ad_g‘sched·¿m
 (
±h»ad_t
 
__rg‘_th»ad
,

435 *
__»¡riù
 
__pŞicy
,

436 
sched_·¿m
 *
__»¡riù
 
__·¿m
)

437 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

440 
	$±h»ad_£tsched´io
 (
±h»ad_t
 
__rg‘_th»ad
, 
__´io
)

441 
__THROW
;

444 #ifdeà
__USE_GNU


446 
	$±h»ad_g‘Çme_Å
 (
±h»ad_t
 
__rg‘_th»ad
, *
__buf
,

447 
size_t
 
__buæ’
)

448 
__THROW
 
	`__nÚnuÎ
 ((2));

451 
	$±h»ad_£Šame_Å
 (
±h»ad_t
 
__rg‘_th»ad
, cÚ¡ *
__Çme
)

452 
__THROW
 
	`__nÚnuÎ
 ((2));

456 #ifdeà
__USE_UNIX98


458 
	$±h»ad_g‘cÚcu¼’cy
 (è
__THROW
;

461 
	$±h»ad_£tcÚcu¼’cy
 (
__Ëv–
è
__THROW
;

464 #ifdeà
__USE_GNU


469 
	$±h»ad_y›ld
 (è
__THROW
;

474 
	$±h»ad_£ffš™y_Å
 (
±h»ad_t
 
__th
, 
size_t
 
__ıu£tsize
,

475 cÚ¡ 
ıu_£t_t
 *
__ıu£t
)

476 
__THROW
 
	`__nÚnuÎ
 ((3));

479 
	$±h»ad_g‘affš™y_Å
 (
±h»ad_t
 
__th
, 
size_t
 
__ıu£tsize
,

480 
ıu_£t_t
 *
__ıu£t
)

481 
__THROW
 
	`__nÚnuÎ
 ((3));

494 
	$±h»ad_Úû
 (
±h»ad_Úû_t
 *
__Úû_cÚŒŞ
,

495 (*
__š™_routše
è()è
	`__nÚnuÎ
 ((1, 2));

506 
	`±h»ad_£tÿnûl¡©e
 (
__¡©e
, *
__Şd¡©e
);

510 
	`±h»ad_£tÿnûÉy³
 (
__ty³
, *
__Şdty³
);

513 
	`±h»ad_ÿnûl
 (
±h»ad_t
 
__th
);

518 
	`±h»ad_‹¡ÿnûl
 ();

527 
__jmp_buf
 
__ÿnûl_jmp_buf
;

528 
__mask_was_§ved
;

529 } 
__ÿnûl_jmp_buf
[1];

530 *
__·d
[4];

531 } 
	t__±h»ad_unwšd_buf_t
 
	t__©Œibu‹__
 ((
	t__®igÃd__
));

534 #iâdeà
__ş—nup_fù_©Œibu‹


535 
	#__ş—nup_fù_©Œibu‹


	)

540 
	s__±h»ad_ş—nup_äame


542 (*
__ÿnûl_routše
) (*);

543 *
__ÿnûl_¬g
;

544 
__do_™
;

545 
__ÿnûl_ty³
;

548 #ià
defšed
 
__GNUC__
 && defšed 
__EXCEPTIONS


549 #ifdeà
__ılu¥lus


551 şas 
	c__±h»ad_ş—nup_şass


553 (*
__ÿnûl_routše
) (*);

554 *
__ÿnûl_¬g
;

555 
__do_™
;

556 
__ÿnûl_ty³
;

558 
public
:

559 
	$__±h»ad_ş—nup_şass
 ((*
__fù
è(*), *
__¬g
)

560 : 
	`__ÿnûl_routše
 (
__fù
), 
	`__ÿnûl_¬g
 (
__¬g
), 
	$__do_™
 (1) { }

561 ~
	$__±h»ad_ş—nup_şass
 (è{ ià(
__do_™
è
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); 
	}
}

562 
	$__£tdo™
 (
__Ãwv®
è{ 
__do_™
 = __Ãwv®; 
	}
}

563 
	$__deãr
 (è{ 
	`±h»ad_£tÿnûÉy³
 (
PTHREAD_CANCEL_DEFERRED
,

564 &
__ÿnûl_ty³
); 
	}
}

565 
	$__»¡Üe
 (ècÚ¡ { 
	`±h»ad_£tÿnûÉy³
 (
__ÿnûl_ty³
, 0); 
	}
}

575 
	#±h»ad_ş—nup_push
(
routše
, 
¬g
) \

577 
__±h»ad_ş—nup_şass
 
	`__şäame
 (
routše
, 
¬g
)

	)

581 
	#±h»ad_ş—nup_pİ
(
execu‹
) \

582 
__şäame
.
	`__£tdo™
 (
execu‹
); \

583 } 0)

	)

585 #ifdeà
__USE_GNU


589 
	#±h»ad_ş—nup_push_deãr_Å
(
routše
, 
¬g
) \

591 
__±h»ad_ş—nup_şass
 
	`__şäame
 (
routše
, 
¬g
); \

592 
__şäame
.
	`__deãr
 ()

	)

597 
	#±h»ad_ş—nup_pİ_»¡Üe_Å
(
execu‹
) \

598 
__şäame
.
	`__»¡Üe
 (); \

599 
__şäame
.
	`__£tdo™
 (
execu‹
); \

600 } 0)

	)

607 
__ex‹º_šlše
 

608 
	$__±h»ad_ş—nup_routše
 (
__±h»ad_ş—nup_äame
 *
__äame
)

610 ià(
__äame
->
__do_™
)

611 
__äame
->
	`__ÿnûl_routše
 (__äame->
__ÿnûl_¬g
);

612 
	}
}

621 
	#±h»ad_ş—nup_push
(
routše
, 
¬g
) \

623 
__±h»ad_ş—nup_äame
 
__şäame
 \

624 
	`__©Œibu‹__
 ((
	`__ş—nup__
 (
__±h»ad_ş—nup_routše
))) \

625 ğ{ .
__ÿnûl_routše
 = (
routše
), .
__ÿnûl_¬g
 = (
¬g
), \

626 .
__do_™
 = 1 };

	)

630 
	#±h»ad_ş—nup_pİ
(
execu‹
) \

631 
__şäame
.
__do_™
 = (
execu‹
); \

632 } 0)

	)

634 #ifdeà
__USE_GNU


638 
	#±h»ad_ş—nup_push_deãr_Å
(
routše
, 
¬g
) \

640 
__±h»ad_ş—nup_äame
 
__şäame
 \

641 
	`__©Œibu‹__
 ((
	`__ş—nup__
 (
__±h»ad_ş—nup_routše
))) \

642 ğ{ .
__ÿnûl_routše
 = (
routše
), .
__ÿnûl_¬g
 = (
¬g
), \

643 .
__do_™
 = 1 }; \

644 (è
	`±h»ad_£tÿnûÉy³
 (
PTHREAD_CANCEL_DEFERRED
, \

645 &
__şäame
.
__ÿnûl_ty³
)

	)

650 
	#±h»ad_ş—nup_pİ_»¡Üe_Å
(
execu‹
) \

651 (è
	`±h»ad_£tÿnûÉy³
 (
__şäame
.
__ÿnûl_ty³
, 
NULL
); \

652 
__şäame
.
__do_™
 = (
execu‹
); \

653 } 0)

	)

664 
	#±h»ad_ş—nup_push
(
routše
, 
¬g
) \

666 
__±h»ad_unwšd_buf_t
 
__ÿnûl_buf
; \

667 (*
__ÿnûl_routše
è(*èğ(
routše
); \

668 *
__ÿnûl_¬g
 = (
¬g
); \

669 
__nÙ_fœ¡_ÿÎ
 = 
	`__sig£tjmp
 ((
__jmp_buf_g
 *) (*) \

670 
__ÿnûl_buf
.
__ÿnûl_jmp_buf
, 0); \

671 ià(
	`__glibc_uÆik–y
 (
__nÙ_fœ¡_ÿÎ
)) \

673 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

674 
	`__±h»ad_unwšd_Ãxt
 (&
__ÿnûl_buf
); \

678 
	`__±h»ad_»gi¡”_ÿnûl
 (&
__ÿnûl_buf
); \

679 dØ{

	)

680 
__±h»ad_»gi¡”_ÿnûl
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

681 
__ş—nup_fù_©Œibu‹
;

685 
	#±h»ad_ş—nup_pİ
(
execu‹
) \

688 
	`__±h»ad_uÄegi¡”_ÿnûl
 (&
__ÿnûl_buf
); \

689 ià(
execu‹
) \

690 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

691 } 0)

	)

692 
	$__±h»ad_uÄegi¡”_ÿnûl
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

693 
__ş—nup_fù_©Œibu‹
;

695 #ifdeà
__USE_GNU


699 
	#±h»ad_ş—nup_push_deãr_Å
(
routše
, 
¬g
) \

701 
__±h»ad_unwšd_buf_t
 
__ÿnûl_buf
; \

702 (*
__ÿnûl_routše
è(*èğ(
routše
); \

703 *
__ÿnûl_¬g
 = (
¬g
); \

704 
__nÙ_fœ¡_ÿÎ
 = 
	`__sig£tjmp
 ((
__jmp_buf_g
 *) (*) \

705 
__ÿnûl_buf
.
__ÿnûl_jmp_buf
, 0); \

706 ià(
	`__glibc_uÆik–y
 (
__nÙ_fœ¡_ÿÎ
)) \

708 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

709 
	`__±h»ad_unwšd_Ãxt
 (&
__ÿnûl_buf
); \

713 
	`__±h»ad_»gi¡”_ÿnûl_deãr
 (&
__ÿnûl_buf
); \

714 dØ{

	)

715 
	`__±h»ad_»gi¡”_ÿnûl_deãr
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

716 
__ş—nup_fù_©Œibu‹
;

721 
	#±h»ad_ş—nup_pİ_»¡Üe_Å
(
execu‹
) \

724 
	`__±h»ad_uÄegi¡”_ÿnûl_»¡Üe
 (&
__ÿnûl_buf
); \

725 ià(
execu‹
) \

726 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

727 
	}
} 0)

	)

728 
	$__±h»ad_uÄegi¡”_ÿnûl_»¡Üe
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

729 
__ş—nup_fù_©Œibu‹
;

733 
	$__±h»ad_unwšd_Ãxt
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

734 
__ş—nup_fù_©Œibu‹
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
))

735 #iâdeà
SHARED


736 
	`__©Œibu‹__
 ((
__w—k__
))

742 
__jmp_buf_g
;

743 
	$__sig£tjmp
 (
__jmp_buf_g
 *
__’v
, 
__§vemask
è
__THROWNL
;

749 
	$±h»ad_mu‹x_š™
 (
±h»ad_mu‹x_t
 *
__mu‹x
,

750 cÚ¡ 
±h»ad_mu‹x©Œ_t
 *
__mu‹x©Œ
)

751 
__THROW
 
	`__nÚnuÎ
 ((1));

754 
	$±h»ad_mu‹x_de¡roy
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

755 
__THROW
 
	`__nÚnuÎ
 ((1));

758 
	$±h»ad_mu‹x_Œylock
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

759 
__THROWNL
 
	`__nÚnuÎ
 ((1));

762 
	$±h»ad_mu‹x_lock
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

763 
__THROWNL
 
	`__nÚnuÎ
 ((1));

765 #ifdeà
__USE_XOPEN2K


767 
	$±h»ad_mu‹x_timedlock
 (
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
,

768 cÚ¡ 
time¥ec
 *
__»¡riù


769 
__ab¡ime
è
__THROWNL
 
	`__nÚnuÎ
 ((1, 2));

773 
	$±h»ad_mu‹x_uÆock
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

774 
__THROWNL
 
	`__nÚnuÎ
 ((1));

778 
	$±h»ad_mu‹x_g‘´ioûšg
 (cÚ¡ 
±h»ad_mu‹x_t
 *

779 
__»¡riù
 
__mu‹x
,

780 *
__»¡riù
 
__´ioûšg
)

781 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

785 
	$±h»ad_mu‹x_£rioûšg
 (
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
,

786 
__´ioûšg
,

787 *
__»¡riù
 
__Şd_ûšg
)

788 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

791 #ifdeà
__USE_XOPEN2K8


793 
	$±h»ad_mu‹x_cÚsi¡’t
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

794 
__THROW
 
	`__nÚnuÎ
 ((1));

795 #ifdeà
__USE_GNU


796 
	$±h»ad_mu‹x_cÚsi¡’t_Å
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

797 
__THROW
 
	`__nÚnuÎ
 ((1));

806 
	$±h»ad_mu‹x©Œ_š™
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
)

807 
__THROW
 
	`__nÚnuÎ
 ((1));

810 
	$±h»ad_mu‹x©Œ_de¡roy
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
)

811 
__THROW
 
	`__nÚnuÎ
 ((1));

814 
	$±h»ad_mu‹x©Œ_g‘psh¬ed
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *

815 
__»¡riù
 
__©Œ
,

816 *
__»¡riù
 
__psh¬ed
)

817 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

820 
	$±h»ad_mu‹x©Œ_£sh¬ed
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

821 
__psh¬ed
)

822 
__THROW
 
	`__nÚnuÎ
 ((1));

824 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


826 
	$±h»ad_mu‹x©Œ_g‘ty³
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *
__»¡riù


827 
__©Œ
, *
__»¡riù
 
__kšd
)

828 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

833 
	$±h»ad_mu‹x©Œ_£‰y³
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
, 
__kšd
)

834 
__THROW
 
	`__nÚnuÎ
 ((1));

838 
	$±h»ad_mu‹x©Œ_g‘´ÙocŞ
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *

839 
__»¡riù
 
__©Œ
,

840 *
__»¡riù
 
__´ÙocŞ
)

841 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

845 
	$±h»ad_mu‹x©Œ_£rÙocŞ
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

846 
__´ÙocŞ
)

847 
__THROW
 
	`__nÚnuÎ
 ((1));

850 
	$±h»ad_mu‹x©Œ_g‘´ioûšg
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *

851 
__»¡riù
 
__©Œ
,

852 *
__»¡riù
 
__´ioûšg
)

853 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

856 
	$±h»ad_mu‹x©Œ_£rioûšg
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

857 
__´ioûšg
)

858 
__THROW
 
	`__nÚnuÎ
 ((1));

860 #ifdeà
__USE_XOPEN2K


862 
	$±h»ad_mu‹x©Œ_g‘robu¡
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

863 *
__robu¡Ãss
)

864 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

865 #ifdeà
__USE_GNU


866 
	$±h»ad_mu‹x©Œ_g‘robu¡_Å
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

867 *
__robu¡Ãss
)

868 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

872 
	$±h»ad_mu‹x©Œ_£Œobu¡
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

873 
__robu¡Ãss
)

874 
__THROW
 
	`__nÚnuÎ
 ((1));

875 #ifdeà
__USE_GNU


876 
	$±h»ad_mu‹x©Œ_£Œobu¡_Å
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

877 
__robu¡Ãss
)

878 
__THROW
 
	`__nÚnuÎ
 ((1));

883 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


888 
	$±h»ad_rwlock_š™
 (
±h»ad_rwlock_t
 *
__»¡riù
 
__rwlock
,

889 cÚ¡ 
±h»ad_rwlock©Œ_t
 *
__»¡riù


890 
__©Œ
è
__THROW
 
	`__nÚnuÎ
 ((1));

893 
	$±h»ad_rwlock_de¡roy
 (
±h»ad_rwlock_t
 *
__rwlock
)

894 
__THROW
 
	`__nÚnuÎ
 ((1));

897 
	$±h»ad_rwlock_rdlock
 (
±h»ad_rwlock_t
 *
__rwlock
)

898 
__THROWNL
 
	`__nÚnuÎ
 ((1));

901 
	$±h»ad_rwlock_Œyrdlock
 (
±h»ad_rwlock_t
 *
__rwlock
)

902 
__THROWNL
 
	`__nÚnuÎ
 ((1));

904 #ifdeà
__USE_XOPEN2K


906 
	$±h»ad_rwlock_timedrdlock
 (
±h»ad_rwlock_t
 *
__»¡riù
 
__rwlock
,

907 cÚ¡ 
time¥ec
 *
__»¡riù


908 
__ab¡ime
è
__THROWNL
 
	`__nÚnuÎ
 ((1, 2));

912 
	$±h»ad_rwlock_w¾ock
 (
±h»ad_rwlock_t
 *
__rwlock
)

913 
__THROWNL
 
	`__nÚnuÎ
 ((1));

916 
	$±h»ad_rwlock_Œyw¾ock
 (
±h»ad_rwlock_t
 *
__rwlock
)

917 
__THROWNL
 
	`__nÚnuÎ
 ((1));

919 #ifdeà
__USE_XOPEN2K


921 
	$±h»ad_rwlock_timedw¾ock
 (
±h»ad_rwlock_t
 *
__»¡riù
 
__rwlock
,

922 cÚ¡ 
time¥ec
 *
__»¡riù


923 
__ab¡ime
è
__THROWNL
 
	`__nÚnuÎ
 ((1, 2));

927 
	$±h»ad_rwlock_uÆock
 (
±h»ad_rwlock_t
 *
__rwlock
)

928 
__THROWNL
 
	`__nÚnuÎ
 ((1));

934 
	$±h»ad_rwlock©Œ_š™
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
)

935 
__THROW
 
	`__nÚnuÎ
 ((1));

938 
	$±h»ad_rwlock©Œ_de¡roy
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
)

939 
__THROW
 
	`__nÚnuÎ
 ((1));

942 
	$±h»ad_rwlock©Œ_g‘psh¬ed
 (cÚ¡ 
±h»ad_rwlock©Œ_t
 *

943 
__»¡riù
 
__©Œ
,

944 *
__»¡riù
 
__psh¬ed
)

945 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

948 
	$±h»ad_rwlock©Œ_£sh¬ed
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
,

949 
__psh¬ed
)

950 
__THROW
 
	`__nÚnuÎ
 ((1));

953 
	$±h»ad_rwlock©Œ_g‘kšd_Å
 (cÚ¡ 
±h»ad_rwlock©Œ_t
 *

954 
__»¡riù
 
__©Œ
,

955 *
__»¡riù
 
__´ef
)

956 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

959 
	$±h»ad_rwlock©Œ_£tkšd_Å
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
,

960 
__´ef
è
__THROW
 
	`__nÚnuÎ
 ((1));

968 
	$±h»ad_cÚd_š™
 (
±h»ad_cÚd_t
 *
__»¡riù
 
__cÚd
,

969 cÚ¡ 
±h»ad_cÚd©Œ_t
 *
__»¡riù
 
__cÚd_©Œ
)

970 
__THROW
 
	`__nÚnuÎ
 ((1));

973 
	$±h»ad_cÚd_de¡roy
 (
±h»ad_cÚd_t
 *
__cÚd
)

974 
__THROW
 
	`__nÚnuÎ
 ((1));

977 
	$±h»ad_cÚd_sigÇl
 (
±h»ad_cÚd_t
 *
__cÚd
)

978 
__THROWNL
 
	`__nÚnuÎ
 ((1));

981 
	$±h»ad_cÚd_brßdÿ¡
 (
±h»ad_cÚd_t
 *
__cÚd
)

982 
__THROWNL
 
	`__nÚnuÎ
 ((1));

989 
	$±h»ad_cÚd_wa™
 (
±h»ad_cÚd_t
 *
__»¡riù
 
__cÚd
,

990 
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
)

991 
	`__nÚnuÎ
 ((1, 2));

1000 
	$±h»ad_cÚd_timedwa™
 (
±h»ad_cÚd_t
 *
__»¡riù
 
__cÚd
,

1001 
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
,

1002 cÚ¡ 
time¥ec
 *
__»¡riù
 
__ab¡ime
)

1003 
	`__nÚnuÎ
 ((1, 2, 3));

1008 
	$±h»ad_cÚd©Œ_š™
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
)

1009 
__THROW
 
	`__nÚnuÎ
 ((1));

1012 
	$±h»ad_cÚd©Œ_de¡roy
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
)

1013 
__THROW
 
	`__nÚnuÎ
 ((1));

1016 
	$±h»ad_cÚd©Œ_g‘psh¬ed
 (cÚ¡ 
±h»ad_cÚd©Œ_t
 *

1017 
__»¡riù
 
__©Œ
,

1018 *
__»¡riù
 
__psh¬ed
)

1019 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1022 
	$±h»ad_cÚd©Œ_£sh¬ed
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
,

1023 
__psh¬ed
è
__THROW
 
	`__nÚnuÎ
 ((1));

1025 #ifdeà
__USE_XOPEN2K


1027 
	$±h»ad_cÚd©Œ_g‘şock
 (cÚ¡ 
±h»ad_cÚd©Œ_t
 *

1028 
__»¡riù
 
__©Œ
,

1029 
__şockid_t
 *
__»¡riù
 
__şock_id
)

1030 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1033 
	$±h»ad_cÚd©Œ_£tşock
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
,

1034 
__şockid_t
 
__şock_id
)

1035 
__THROW
 
	`__nÚnuÎ
 ((1));

1039 #ifdeà
__USE_XOPEN2K


1044 
	$±h»ad_¥š_š™
 (
±h»ad_¥šlock_t
 *
__lock
, 
__psh¬ed
)

1045 
__THROW
 
	`__nÚnuÎ
 ((1));

1048 
	$±h»ad_¥š_de¡roy
 (
±h»ad_¥šlock_t
 *
__lock
)

1049 
__THROW
 
	`__nÚnuÎ
 ((1));

1052 
	$±h»ad_¥š_lock
 (
±h»ad_¥šlock_t
 *
__lock
)

1053 
__THROWNL
 
	`__nÚnuÎ
 ((1));

1056 
	$±h»ad_¥š_Œylock
 (
±h»ad_¥šlock_t
 *
__lock
)

1057 
__THROWNL
 
	`__nÚnuÎ
 ((1));

1060 
	$±h»ad_¥š_uÆock
 (
±h»ad_¥šlock_t
 *
__lock
)

1061 
__THROWNL
 
	`__nÚnuÎ
 ((1));

1068 
	$±h»ad_b¬r›r_š™
 (
±h»ad_b¬r›r_t
 *
__»¡riù
 
__b¬r›r
,

1069 cÚ¡ 
±h»ad_b¬r›¿‰r_t
 *
__»¡riù


1070 
__©Œ
, 
__couÁ
)

1071 
__THROW
 
	`__nÚnuÎ
 ((1));

1074 
	$±h»ad_b¬r›r_de¡roy
 (
±h»ad_b¬r›r_t
 *
__b¬r›r
)

1075 
__THROW
 
	`__nÚnuÎ
 ((1));

1078 
	$±h»ad_b¬r›r_wa™
 (
±h»ad_b¬r›r_t
 *
__b¬r›r
)

1079 
__THROWNL
 
	`__nÚnuÎ
 ((1));

1083 
	$±h»ad_b¬r›¿‰r_š™
 (
±h»ad_b¬r›¿‰r_t
 *
__©Œ
)

1084 
__THROW
 
	`__nÚnuÎ
 ((1));

1087 
	$±h»ad_b¬r›¿‰r_de¡roy
 (
±h»ad_b¬r›¿‰r_t
 *
__©Œ
)

1088 
__THROW
 
	`__nÚnuÎ
 ((1));

1091 
	$±h»ad_b¬r›¿‰r_g‘psh¬ed
 (cÚ¡ 
±h»ad_b¬r›¿‰r_t
 *

1092 
__»¡riù
 
__©Œ
,

1093 *
__»¡riù
 
__psh¬ed
)

1094 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1097 
	$±h»ad_b¬r›¿‰r_£sh¬ed
 (
±h»ad_b¬r›¿‰r_t
 *
__©Œ
,

1098 
__psh¬ed
)

1099 
__THROW
 
	`__nÚnuÎ
 ((1));

1111 
	$±h»ad_key_ü—‹
 (
±h»ad_key_t
 *
__key
,

1112 (*
__de¡r_funùiÚ
) (*))

1113 
__THROW
 
	`__nÚnuÎ
 ((1));

1116 
	$±h»ad_key_d–‘e
 (
±h»ad_key_t
 
__key
è
__THROW
;

1119 *
	$±h»ad_g‘¥ecific
 (
±h»ad_key_t
 
__key
è
__THROW
;

1122 
	$±h»ad_£t¥ecific
 (
±h»ad_key_t
 
__key
,

1123 cÚ¡ *
__poš‹r
è
__THROW
 ;

1126 #ifdeà
__USE_XOPEN2K


1128 
	$±h»ad_g‘ıuşockid
 (
±h»ad_t
 
__th»ad_id
,

1129 
__şockid_t
 *
__şock_id
)

1130 
__THROW
 
	`__nÚnuÎ
 ((2));

1145 
	$±h»ad_©fÜk
 ((*
__´•¬e
) (),

1146 (*
__·»Á
) (),

1147 (*
__chd
è()è
__THROW
;

1150 #ifdeà
__USE_EXTERN_INLINES


1152 
__ex‹º_šlše
 

1153 
	`__NTH
 (
	$±h»ad_equ®
 (
±h»ad_t
 
__th»ad1
,…th»ad_ˆ
__th»ad2
))

1155  
__th»ad1
 =ğ
__th»ad2
;

1156 
	}
}

1159 
	g__END_DECLS


	@/usr/include/signal.h

22 #iâdef 
_SIGNAL_H


24 #ià!
defšed
 
__Ãed_sig_©omic_t
 && !defšed 
__Ãed_sig£t_t


25 
	#_SIGNAL_H


	)

28 
	~<ã©u»s.h
>

30 
	g__BEGIN_DECLS


32 
	~<b™s/sig£t.h
>

36 #ià
defšed
 
__Ãed_sig_©omic_t
 || defšed 
_SIGNAL_H


37 #iâdeà
__sig_©omic_t_defšed


38 
	#__sig_©omic_t_defšed


	)

39 
__BEGIN_NAMESPACE_STD


40 
__sig_©omic_t
 
	tsig_©omic_t
;

41 
	g__END_NAMESPACE_STD


43 #undeà
__Ãed_sig_©omic_t


46 #ià
defšed
 
__Ãed_sig£t_t
 || (defšed 
_SIGNAL_H
 && defšed 
__USE_POSIX
)

47 #iâdeà
__sig£t_t_defšed


48 
	#__sig£t_t_defšed


	)

49 
__sig£t_t
 
	tsig£t_t
;

51 #undeà
__Ãed_sig£t_t


54 #ifdeà
_SIGNAL_H


56 
	~<b™s/ty³s.h
>

57 
	~<b™s/signum.h
>

59 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K


60 #iâdeà
__pid_t_defšed


61 
__pid_t
 
	tpid_t
;

62 
	#__pid_t_defšed


	)

64 #ifdeà
__USE_XOPEN


66 #iâdeà
__uid_t_defšed


67 
__uid_t
 
	tuid_t
;

68 
	#__uid_t_defšed


	)

72 #ifdeà
__USE_POSIX199309


74 
	#__Ãed_time¥ec


	)

75 
	~<time.h
>

78 #ià
defšed
 
__USE_POSIX199309
 || defšed 
__USE_XOPEN_EXTENDED


80 
	~<b™s/sigšfo.h
>

85 (*
	t__sighªdËr_t
) ();

90 
__sighªdËr_t
 
	$__sysv_sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

91 
__THROW
;

92 #ifdeà
__USE_GNU


93 
__sighªdËr_t
 
	$sysv_sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

94 
__THROW
;

100 
__BEGIN_NAMESPACE_STD


101 #ifdeà
__USE_MISC


102 
__sighªdËr_t
 
	$sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

103 
__THROW
;

106 #ifdeà
__REDIRECT_NTH


107 
__sighªdËr_t
 
	`__REDIRECT_NTH
 (
sigÇl
,

108 (
__sig
, 
__sighªdËr_t
 
__hªdËr
),

109 
__sysv_sigÇl
);

111 
	#sigÇl
 
__sysv_sigÇl


	)

114 
__END_NAMESPACE_STD


116 #ifdeà
__USE_XOPEN


119 
__sighªdËr_t
 
	$bsd_sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

120 
__THROW
;

126 #ifdeà
__USE_POSIX


127 
	$kl
 (
__pid_t
 
__pid
, 
__sig
è
__THROW
;

130 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


134 
	$kÍg
 (
__pid_t
 
__pg½
, 
__sig
è
__THROW
;

137 
__BEGIN_NAMESPACE_STD


139 
	$¿i£
 (
__sig
è
__THROW
;

140 
__END_NAMESPACE_STD


142 #ifdeà
__USE_MISC


144 
__sighªdËr_t
 
	$ssigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

145 
__THROW
;

146 
	$gsigÇl
 (
__sig
è
__THROW
;

149 #ifdeà
__USE_XOPEN2K8


151 
	`psigÇl
 (
__sig
, cÚ¡ *
__s
);

154 
	`psigšfo
 (cÚ¡ 
sigšfo_t
 *
__pšfo
, cÚ¡ *
__s
);

166 #ifdeà
__USE_XOPEN


167 #ifdeà
__GNUC__


168 
	$sig·u£
 (
__sig
è
	`__asm__
 ("__xpg_sigpause");

170 
	`__sig·u£
 (
__sig_Ü_mask
, 
__is_sig
);

172 
	#sig·u£
(
sig
è
	`__sig·u£
 ((sig), 1)

	)

177 #ifdeà
__USE_MISC


184 
	#sigmask
(
sig
è
	`__sigmask
(sig)

	)

187 
	$sigblock
 (
__mask
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

190 
	$sig£tmask
 (
__mask
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

193 
	$sigg‘mask
 (è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

197 #ifdeà
__USE_MISC


198 
	#NSIG
 
_NSIG


	)

201 #ifdeà
__USE_GNU


202 
__sighªdËr_t
 
	tsighªdËr_t
;

206 #ifdeà
__USE_MISC


207 
__sighªdËr_t
 
	tsig_t
;

210 #ifdeà
__USE_POSIX


213 
	$sigem±y£t
 (
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

216 
	$sigfl£t
 (
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

219 
	$sigadd£t
 (
sig£t_t
 *
__£t
, 
__signo
è
__THROW
 
	`__nÚnuÎ
 ((1));

222 
	$sigd–£t
 (
sig£t_t
 *
__£t
, 
__signo
è
__THROW
 
	`__nÚnuÎ
 ((1));

225 
	$sigismemb”
 (cÚ¡ 
sig£t_t
 *
__£t
, 
__signo
)

226 
__THROW
 
	`__nÚnuÎ
 ((1));

228 #ifdeà
__USE_GNU


230 
	$sigi£m±y£t
 (cÚ¡ 
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

233 
	$sigªd£t
 (
sig£t_t
 *
__£t
, cÚ¡ sig£t_ˆ*
__Ëá
,

234 cÚ¡ 
sig£t_t
 *
__right
è
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3));

237 
	$sigÜ£t
 (
sig£t_t
 *
__£t
, cÚ¡ sig£t_ˆ*
__Ëá
,

238 cÚ¡ 
sig£t_t
 *
__right
è
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3));

243 
	~<b™s/sigaùiÚ.h
>

246 
	$sig´ocmask
 (
__how
, cÚ¡ 
sig£t_t
 *
__»¡riù
 
__£t
,

247 
sig£t_t
 *
__»¡riù
 
__o£t
è
__THROW
;

254 
	$sigsu¥’d
 (cÚ¡ 
sig£t_t
 *
__£t
è
	`__nÚnuÎ
 ((1));

257 
	$sigaùiÚ
 (
__sig
, cÚ¡ 
sigaùiÚ
 *
__»¡riù
 
__aù
,

258 
sigaùiÚ
 *
__»¡riù
 
__ßù
è
__THROW
;

261 
	$sig³ndšg
 (
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

268 
	$sigwa™
 (cÚ¡ 
sig£t_t
 *
__»¡riù
 
__£t
, *__»¡riù 
__sig
)

269 
	`__nÚnuÎ
 ((1, 2));

271 #ifdeà
__USE_POSIX199309


276 
	$sigwa™šfo
 (cÚ¡ 
sig£t_t
 *
__»¡riù
 
__£t
,

277 
sigšfo_t
 *
__»¡riù
 
__šfo
è
	`__nÚnuÎ
 ((1));

284 
	$sigtimedwa™
 (cÚ¡ 
sig£t_t
 *
__»¡riù
 
__£t
,

285 
sigšfo_t
 *
__»¡riù
 
__šfo
,

286 cÚ¡ 
time¥ec
 *
__»¡riù
 
__timeout
)

287 
	`__nÚnuÎ
 ((1));

291 
	$sigqueue
 (
__pid_t
 
__pid
, 
__sig
, cÚ¡ 
sigv®
 
__v®
)

292 
__THROW
;

297 #ifdeà
__USE_MISC


301 cÚ¡ *cÚ¡ 
_sys_sigli¡
[
_NSIG
];

302 cÚ¡ *cÚ¡ 
sys_sigli¡
[
_NSIG
];

306 
	~<b™s/sigcÚ‹xt.h
>

309 
	$sig»tuº
 (
sigcÚ‹xt
 *
__sı
è
__THROW
;

314 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


315 
	#__Ãed_size_t


	)

316 
	~<¡ddef.h
>

321 
	$sigš‹¼u±
 (
__sig
, 
__š‹¼u±
è
__THROW
;

323 
	~<b™s/sig¡ack.h
>

324 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


326 
	~<sys/ucÚ‹xt.h
>

332 
	$sig¡ack
 (
sig¡ack
 *
__ss
, sig¡ack *
__oss
)

333 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

337 
	$sig®t¡ack
 (cÚ¡ 
sig®t¡ack
 *
__»¡riù
 
__ss
,

338 
sig®t¡ack
 *
__»¡riù
 
__oss
è
__THROW
;

342 #ifdeà
__USE_XOPEN_EXTENDED


346 
	$sighŞd
 (
__sig
è
__THROW
;

349 
	$sig»l£
 (
__sig
è
__THROW
;

352 
	$sigignÜe
 (
__sig
è
__THROW
;

355 
__sighªdËr_t
 
	$sig£t
 (
__sig
, 
__sighªdËr_t
 
__di¥
è
__THROW
;

358 #ià
defšed
 
__USE_POSIX199506
 || defšed 
__USE_UNIX98


361 
	~<b™s/±h»adty³s.h
>

362 
	~<b™s/sigth»ad.h
>

369 
	$__libc_cu¼’t_sig¹mš
 (è
__THROW
;

371 
	$__libc_cu¼’t_sig¹max
 (è
__THROW
;

375 
__END_DECLS


	@/usr/include/stdint.h

22 #iâdeà
_STDINT_H


23 
	#_STDINT_H
 1

	)

25 
	~<ã©u»s.h
>

26 
	~<b™s/wch¬.h
>

27 
	~<b™s/wÜdsize.h
>

34 #iâdeà
__št8_t_defšed


35 
	#__št8_t_defšed


	)

36 sigÃd 
	tšt8_t
;

37 
	tšt16_t
;

38 
	tšt32_t
;

39 #ià
__WORDSIZE
 == 64

40 
	tšt64_t
;

42 
__ex‹nsiÚ__


43 
	tšt64_t
;

48 
	tušt8_t
;

49 
	tušt16_t
;

50 #iâdeà
__ušt32_t_defšed


51 
	tušt32_t
;

52 
	#__ušt32_t_defšed


	)

54 #ià
__WORDSIZE
 == 64

55 
	tušt64_t
;

57 
__ex‹nsiÚ__


58 
	tušt64_t
;

65 sigÃd 
	tšt_Ëa¡8_t
;

66 
	tšt_Ëa¡16_t
;

67 
	tšt_Ëa¡32_t
;

68 #ià
__WORDSIZE
 == 64

69 
	tšt_Ëa¡64_t
;

71 
__ex‹nsiÚ__


72 
	tšt_Ëa¡64_t
;

76 
	tušt_Ëa¡8_t
;

77 
	tušt_Ëa¡16_t
;

78 
	tušt_Ëa¡32_t
;

79 #ià
__WORDSIZE
 == 64

80 
	tušt_Ëa¡64_t
;

82 
__ex‹nsiÚ__


83 
	tušt_Ëa¡64_t
;

90 sigÃd 
	tšt_ç¡8_t
;

91 #ià
__WORDSIZE
 == 64

92 
	tšt_ç¡16_t
;

93 
	tšt_ç¡32_t
;

94 
	tšt_ç¡64_t
;

96 
	tšt_ç¡16_t
;

97 
	tšt_ç¡32_t
;

98 
__ex‹nsiÚ__


99 
	tšt_ç¡64_t
;

103 
	tušt_ç¡8_t
;

104 #ià
__WORDSIZE
 == 64

105 
	tušt_ç¡16_t
;

106 
	tušt_ç¡32_t
;

107 
	tušt_ç¡64_t
;

109 
	tušt_ç¡16_t
;

110 
	tušt_ç¡32_t
;

111 
__ex‹nsiÚ__


112 
	tušt_ç¡64_t
;

117 #ià
__WORDSIZE
 == 64

118 #iâdeà
__šŒ_t_defšed


119 
	tšŒ_t
;

120 
	#__šŒ_t_defšed


	)

122 
	tušŒ_t
;

124 #iâdeà
__šŒ_t_defšed


125 
	tšŒ_t
;

126 
	#__šŒ_t_defšed


	)

128 
	tušŒ_t
;

133 #ià
__WORDSIZE
 == 64

134 
	tštmax_t
;

135 
	tuštmax_t
;

137 
__ex‹nsiÚ__


138 
	tštmax_t
;

139 
__ex‹nsiÚ__


140 
	tuštmax_t
;

144 #ià
__WORDSIZE
 == 64

145 
	#__INT64_C
(
c
èø## 
L


	)

146 
	#__UINT64_C
(
c
èø## 
UL


	)

148 
	#__INT64_C
(
c
èø## 
LL


	)

149 
	#__UINT64_C
(
c
èø## 
ULL


	)

155 
	#INT8_MIN
 (-128)

	)

156 
	#INT16_MIN
 (-32767-1)

	)

157 
	#INT32_MIN
 (-2147483647-1)

	)

158 
	#INT64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

160 
	#INT8_MAX
 (127)

	)

161 
	#INT16_MAX
 (32767)

	)

162 
	#INT32_MAX
 (2147483647)

	)

163 
	#INT64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

166 
	#UINT8_MAX
 (255)

	)

167 
	#UINT16_MAX
 (65535)

	)

168 
	#UINT32_MAX
 (4294967295U)

	)

169 
	#UINT64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

173 
	#INT_LEAST8_MIN
 (-128)

	)

174 
	#INT_LEAST16_MIN
 (-32767-1)

	)

175 
	#INT_LEAST32_MIN
 (-2147483647-1)

	)

176 
	#INT_LEAST64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

178 
	#INT_LEAST8_MAX
 (127)

	)

179 
	#INT_LEAST16_MAX
 (32767)

	)

180 
	#INT_LEAST32_MAX
 (2147483647)

	)

181 
	#INT_LEAST64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

184 
	#UINT_LEAST8_MAX
 (255)

	)

185 
	#UINT_LEAST16_MAX
 (65535)

	)

186 
	#UINT_LEAST32_MAX
 (4294967295U)

	)

187 
	#UINT_LEAST64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

191 
	#INT_FAST8_MIN
 (-128)

	)

192 #ià
__WORDSIZE
 == 64

193 
	#INT_FAST16_MIN
 (-9223372036854775807L-1)

	)

194 
	#INT_FAST32_MIN
 (-9223372036854775807L-1)

	)

196 
	#INT_FAST16_MIN
 (-2147483647-1)

	)

197 
	#INT_FAST32_MIN
 (-2147483647-1)

	)

199 
	#INT_FAST64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

201 
	#INT_FAST8_MAX
 (127)

	)

202 #ià
__WORDSIZE
 == 64

203 
	#INT_FAST16_MAX
 (9223372036854775807L)

	)

204 
	#INT_FAST32_MAX
 (9223372036854775807L)

	)

206 
	#INT_FAST16_MAX
 (2147483647)

	)

207 
	#INT_FAST32_MAX
 (2147483647)

	)

209 
	#INT_FAST64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

212 
	#UINT_FAST8_MAX
 (255)

	)

213 #ià
__WORDSIZE
 == 64

214 
	#UINT_FAST16_MAX
 (18446744073709551615UL)

	)

215 
	#UINT_FAST32_MAX
 (18446744073709551615UL)

	)

217 
	#UINT_FAST16_MAX
 (4294967295U)

	)

218 
	#UINT_FAST32_MAX
 (4294967295U)

	)

220 
	#UINT_FAST64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

224 #ià
__WORDSIZE
 == 64

225 
	#INTPTR_MIN
 (-9223372036854775807L-1)

	)

226 
	#INTPTR_MAX
 (9223372036854775807L)

	)

227 
	#UINTPTR_MAX
 (18446744073709551615UL)

	)

229 
	#INTPTR_MIN
 (-2147483647-1)

	)

230 
	#INTPTR_MAX
 (2147483647)

	)

231 
	#UINTPTR_MAX
 (4294967295U)

	)

236 
	#INTMAX_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

238 
	#INTMAX_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

241 
	#UINTMAX_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

247 #ià
__WORDSIZE
 == 64

248 
	#PTRDIFF_MIN
 (-9223372036854775807L-1)

	)

249 
	#PTRDIFF_MAX
 (9223372036854775807L)

	)

251 
	#PTRDIFF_MIN
 (-2147483647-1)

	)

252 
	#PTRDIFF_MAX
 (2147483647)

	)

256 
	#SIG_ATOMIC_MIN
 (-2147483647-1)

	)

257 
	#SIG_ATOMIC_MAX
 (2147483647)

	)

260 #ià
__WORDSIZE
 == 64

261 
	#SIZE_MAX
 (18446744073709551615UL)

	)

263 #ifdeà
__WORDSIZE32_SIZE_ULONG


264 
	#SIZE_MAX
 (4294967295UL)

	)

266 
	#SIZE_MAX
 (4294967295U)

	)

271 #iâdeà
WCHAR_MIN


273 
	#WCHAR_MIN
 
__WCHAR_MIN


	)

274 
	#WCHAR_MAX
 
__WCHAR_MAX


	)

278 
	#WINT_MIN
 (0u)

	)

279 
	#WINT_MAX
 (4294967295u)

	)

282 
	#INT8_C
(
c
è
	)
c

283 
	#INT16_C
(
c
è
	)
c

284 
	#INT32_C
(
c
è
	)
c

285 #ià
__WORDSIZE
 == 64

286 
	#INT64_C
(
c
èø## 
L


	)

288 
	#INT64_C
(
c
èø## 
LL


	)

292 
	#UINT8_C
(
c
è
	)
c

293 
	#UINT16_C
(
c
è
	)
c

294 
	#UINT32_C
(
c
èø## 
U


	)

295 #ià
__WORDSIZE
 == 64

296 
	#UINT64_C
(
c
èø## 
UL


	)

298 
	#UINT64_C
(
c
èø## 
ULL


	)

302 #ià
__WORDSIZE
 == 64

303 
	#INTMAX_C
(
c
èø## 
L


	)

304 
	#UINTMAX_C
(
c
èø## 
UL


	)

306 
	#INTMAX_C
(
c
èø## 
LL


	)

307 
	#UINTMAX_C
(
c
èø## 
ULL


	)

	@/usr/include/stdio.h

23 #iâdeà
_STDIO_H


25 #ià!
defšed
 
__Ãed_FILE
 && !defšed 
__Ãed___FILE


26 
	#_STDIO_H
 1

	)

27 
	~<ã©u»s.h
>

29 
	g__BEGIN_DECLS


31 
	#__Ãed_size_t


	)

32 
	#__Ãed_NULL


	)

33 
	~<¡ddef.h
>

35 
	~<b™s/ty³s.h
>

36 
	#__Ãed_FILE


	)

37 
	#__Ãed___FILE


	)

41 #ià!
defšed
 
__FILE_defšed
 && defšed 
__Ãed_FILE


44 
	g_IO_FILE
;

46 
__BEGIN_NAMESPACE_STD


48 
_IO_FILE
 
	tFILE
;

49 
	g__END_NAMESPACE_STD


50 #ià
defšed
 
__USE_LARGEFILE64
 || defšed 
__USE_POSIX
 \

51 || 
defšed
 
	g__USE_ISOC99
 || defšed 
	g__USE_XOPEN
 \

52 || 
defšed
 
__USE_POSIX2


53 
	$__USING_NAMESPACE_STD
(
FILE
)

56 
	#__FILE_defšed
 1

	)

58 #undeà
__Ãed_FILE


61 #ià!
defšed
 
____FILE_defšed
 && defšed 
__Ãed___FILE


64 
_IO_FILE
 
	t__FILE
;

66 
	#____FILE_defšed
 1

	)

68 #undeà
__Ãed___FILE


71 #ifdef 
_STDIO_H


72 
	#_STDIO_USES_IOSTREAM


	)

74 
	~<libio.h
>

76 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


77 #ifdeà
__GNUC__


78 #iâdeà
_VA_LIST_DEFINED


79 
_G_va_li¡
 
	tva_li¡
;

80 
	#_VA_LIST_DEFINED


	)

83 
	~<¡d¬g.h
>

87 #ifdeà
__USE_XOPEN2K8


88 #iâdeà
__off_t_defšed


89 #iâdeà
__USE_FILE_OFFSET64


90 
__off_t
 
	toff_t
;

92 
__off64_t
 
	toff_t
;

94 
	#__off_t_defšed


	)

96 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__off64_t_defšed


97 
__off64_t
 
	toff64_t
;

98 
	#__off64_t_defšed


	)

101 #iâdeà
__ssize_t_defšed


102 
__ssize_t
 
	tssize_t
;

103 
	#__ssize_t_defšed


	)

108 
__BEGIN_NAMESPACE_STD


109 #iâdeà
__USE_FILE_OFFSET64


110 
_G_åos_t
 
	tåos_t
;

112 
_G_åos64_t
 
	tåos_t
;

114 
__END_NAMESPACE_STD


115 #ifdeà
__USE_LARGEFILE64


116 
_G_åos64_t
 
	tåos64_t
;

120 
	#_IOFBF
 0

	)

121 
	#_IOLBF
 1

	)

122 
	#_IONBF
 2

	)

126 #iâdeà
BUFSIZ


127 
	#BUFSIZ
 
_IO_BUFSIZ


	)

133 #iâdeà
EOF


134 
	#EOF
 (-1)

	)

140 
	#SEEK_SET
 0

	)

141 
	#SEEK_CUR
 1

	)

142 
	#SEEK_END
 2

	)

143 #ifdeà
__USE_GNU


144 
	#SEEK_DATA
 3

	)

145 
	#SEEK_HOLE
 4

	)

149 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


151 
	#P_tmpdœ
 "/tmp"

	)

164 
	~<b™s/¡dio_lim.h
>

168 
_IO_FILE
 *
¡dš
;

169 
_IO_FILE
 *
¡dout
;

170 
_IO_FILE
 *
¡d”r
;

172 
	#¡dš
 
¡dš


	)

173 
	#¡dout
 
¡dout


	)

174 
	#¡d”r
 
¡d”r


	)

176 
__BEGIN_NAMESPACE_STD


178 
	$»move
 (cÚ¡ *
__f’ame
è
__THROW
;

180 
	$»Çme
 (cÚ¡ *
__Şd
, cÚ¡ *
__Ãw
è
__THROW
;

181 
__END_NAMESPACE_STD


183 #ifdeà
__USE_ATFILE


185 
	$»Çm—t
 (
__Şdfd
, cÚ¡ *
__Şd
, 
__Ãwfd
,

186 cÚ¡ *
__Ãw
è
__THROW
;

189 
__BEGIN_NAMESPACE_STD


194 #iâdeà
__USE_FILE_OFFSET64


195 
FILE
 *
	$tmpfe
 (è
__wur
;

197 #ifdeà
__REDIRECT


198 
FILE
 *
	`__REDIRECT
 (
tmpfe
, (), 
tmpfe64
è
__wur
;

200 
	#tmpfe
 
tmpfe64


	)

204 #ifdeà
__USE_LARGEFILE64


205 
FILE
 *
	$tmpfe64
 (è
__wur
;

209 *
	$tm²am
 (*
__s
è
__THROW
 
__wur
;

210 
__END_NAMESPACE_STD


212 #ifdeà
__USE_MISC


215 *
	$tm²am_r
 (*
__s
è
__THROW
 
__wur
;

219 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


227 *
	$‹m²am
 (cÚ¡ *
__dœ
, cÚ¡ *
__pfx
)

228 
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

232 
__BEGIN_NAMESPACE_STD


237 
	`fşo£
 (
FILE
 *
__¡»am
);

242 
	`fæush
 (
FILE
 *
__¡»am
);

243 
__END_NAMESPACE_STD


245 #ifdeà
__USE_MISC


252 
	`fæush_uÆocked
 (
FILE
 *
__¡»am
);

255 #ifdeà
__USE_GNU


262 
	`fşo£®l
 ();

266 
__BEGIN_NAMESPACE_STD


267 #iâdeà
__USE_FILE_OFFSET64


272 
FILE
 *
	$fİ’
 (cÚ¡ *
__»¡riù
 
__f’ame
,

273 cÚ¡ *
__»¡riù
 
__modes
è
__wur
;

278 
FILE
 *
	$äeİ’
 (cÚ¡ *
__»¡riù
 
__f’ame
,

279 cÚ¡ *
__»¡riù
 
__modes
,

280 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

282 #ifdeà
__REDIRECT


283 
FILE
 *
	`__REDIRECT
 (
fİ’
, (cÚ¡ *
__»¡riù
 
__f’ame
,

284 cÚ¡ *
__»¡riù
 
__modes
), 
fİ’64
)

285 
__wur
;

286 
FILE
 *
	`__REDIRECT
 (
äeİ’
, (cÚ¡ *
__»¡riù
 
__f’ame
,

287 cÚ¡ *
__»¡riù
 
__modes
,

288 
FILE
 *
__»¡riù
 
__¡»am
), 
äeİ’64
)

289 
__wur
;

291 
	#fİ’
 
fİ’64


	)

292 
	#äeİ’
 
äeİ’64


	)

295 
__END_NAMESPACE_STD


296 #ifdeà
__USE_LARGEFILE64


297 
FILE
 *
	$fİ’64
 (cÚ¡ *
__»¡riù
 
__f’ame
,

298 cÚ¡ *
__»¡riù
 
__modes
è
__wur
;

299 
FILE
 *
	$äeİ’64
 (cÚ¡ *
__»¡riù
 
__f’ame
,

300 cÚ¡ *
__»¡riù
 
__modes
,

301 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

304 #ifdef 
__USE_POSIX


306 
FILE
 *
	$fdİ’
 (
__fd
, cÚ¡ *
__modes
è
__THROW
 
__wur
;

309 #ifdef 
__USE_GNU


312 
FILE
 *
	$fİ’cook›
 (*
__»¡riù
 
__magic_cook›
,

313 cÚ¡ *
__»¡riù
 
__modes
,

314 
_IO_cook›_io_funùiÚs_t
 
__io_funcs
è
__THROW
 
__wur
;

317 #ifdeà
__USE_XOPEN2K8


319 
FILE
 *
	$fmemİ’
 (*
__s
, 
size_t
 
__Ën
, cÚ¡ *
__modes
)

320 
__THROW
 
__wur
;

325 
FILE
 *
	$İ’_mem¡»am
 (**
__buæoc
, 
size_t
 *
__siz–oc
è
__THROW
 
__wur
;

329 
__BEGIN_NAMESPACE_STD


332 
	$£tbuf
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
è
__THROW
;

336 
	$£tvbuf
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
,

337 
__modes
, 
size_t
 
__n
è
__THROW
;

338 
__END_NAMESPACE_STD


340 #ifdef 
__USE_MISC


343 
	$£tbufãr
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
,

344 
size_t
 
__size
è
__THROW
;

347 
	$£šebuf
 (
FILE
 *
__¡»am
è
__THROW
;

351 
__BEGIN_NAMESPACE_STD


356 
	`årštf
 (
FILE
 *
__»¡riù
 
__¡»am
,

357 cÚ¡ *
__»¡riù
 
__fÜm©
, ...);

362 
	`´štf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, ...);

364 
	$¥rštf
 (*
__»¡riù
 
__s
,

365 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__THROWNL
;

371 
	`vårštf
 (
FILE
 *
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__fÜm©
,

372 
_G_va_li¡
 
__¬g
);

377 
	`v´štf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
);

379 
	$v¥rštf
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__fÜm©
,

380 
_G_va_li¡
 
__¬g
è
__THROWNL
;

381 
__END_NAMESPACE_STD


383 #ià
defšed
 
__USE_ISOC99
 || defšed 
__USE_UNIX98


384 
__BEGIN_NAMESPACE_C99


386 
	$¢´štf
 (*
__»¡riù
 
__s
, 
size_t
 
__maxËn
,

387 cÚ¡ *
__»¡riù
 
__fÜm©
, ...)

388 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 3, 4)));

390 
	$v¢´štf
 (*
__»¡riù
 
__s
, 
size_t
 
__maxËn
,

391 cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

392 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 3, 0)));

393 
__END_NAMESPACE_C99


396 #ifdeà
__USE_GNU


399 
	$va¥rštf
 (**
__»¡riù
 
__±r
, cÚ¡ *__»¡riù 
__f
,

400 
_G_va_li¡
 
__¬g
)

401 
__THROWNL
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 0))è
__wur
;

402 
	$__a¥rštf
 (**
__»¡riù
 
__±r
,

403 cÚ¡ *
__»¡riù
 
__fmt
, ...)

404 
__THROWNL
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 3))è
__wur
;

405 
	$a¥rštf
 (**
__»¡riù
 
__±r
,

406 cÚ¡ *
__»¡riù
 
__fmt
, ...)

407 
__THROWNL
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 3))è
__wur
;

410 #ifdeà
__USE_XOPEN2K8


412 
	$vd´štf
 (
__fd
, cÚ¡ *
__»¡riù
 
__fmt
,

413 
_G_va_li¡
 
__¬g
)

414 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 0)));

415 
	$d´štf
 (
__fd
, cÚ¡ *
__»¡riù
 
__fmt
, ...)

416 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 3)));

420 
__BEGIN_NAMESPACE_STD


425 
	$fsÿnf
 (
FILE
 *
__»¡riù
 
__¡»am
,

426 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

431 
	$sÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

433 
	$ssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

434 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__THROW
;

436 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__USE_GNU
 \

437 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

438 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

439 #ifdeà
__REDIRECT


443 
	`__REDIRECT
 (
fsÿnf
, (
FILE
 *
__»¡riù
 
__¡»am
,

444 cÚ¡ *
__»¡riù
 
__fÜm©
, ...),

445 
__isoc99_fsÿnf
è
__wur
;

446 
	`__REDIRECT
 (
sÿnf
, (cÚ¡ *
__»¡riù
 
__fÜm©
, ...),

447 
__isoc99_sÿnf
è
__wur
;

448 
	`__REDIRECT_NTH
 (
ssÿnf
, (cÚ¡ *
__»¡riù
 
__s
,

449 cÚ¡ *
__»¡riù
 
__fÜm©
, ...),

450 
__isoc99_ssÿnf
);

452 
	$__isoc99_fsÿnf
 (
FILE
 *
__»¡riù
 
__¡»am
,

453 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

454 
	$__isoc99_sÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

455 
	$__isoc99_ssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

456 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__THROW
;

457 
	#fsÿnf
 
__isoc99_fsÿnf


	)

458 
	#sÿnf
 
__isoc99_sÿnf


	)

459 
	#ssÿnf
 
__isoc99_ssÿnf


	)

463 
__END_NAMESPACE_STD


465 #ifdef 
__USE_ISOC99


466 
__BEGIN_NAMESPACE_C99


471 
	$vfsÿnf
 (
FILE
 *
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__fÜm©
,

472 
_G_va_li¡
 
__¬g
)

473 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 2, 0))è
__wur
;

479 
	$vsÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

480 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 1, 0))è
__wur
;

483 
	$vssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

484 cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

485 
__THROW
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__sÿnf__
, 2, 0)));

487 #ià!
defšed
 
__USE_GNU
 \

488 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

489 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

490 #ifdeà
__REDIRECT


494 
	`__REDIRECT
 (
vfsÿnf
,

495 (
FILE
 *
__»¡riù
 
__s
,

496 cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
),

497 
__isoc99_vfsÿnf
)

498 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 2, 0))è
__wur
;

499 
	`__REDIRECT
 (
vsÿnf
, (cÚ¡ *
__»¡riù
 
__fÜm©
,

500 
_G_va_li¡
 
__¬g
), 
__isoc99_vsÿnf
)

501 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 1, 0))è
__wur
;

502 
	`__REDIRECT_NTH
 (
vssÿnf
,

503 (cÚ¡ *
__»¡riù
 
__s
,

504 cÚ¡ *
__»¡riù
 
__fÜm©
,

505 
_G_va_li¡
 
__¬g
), 
__isoc99_vssÿnf
)

506 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__sÿnf__
, 2, 0)));

508 
	$__isoc99_vfsÿnf
 (
FILE
 *
__»¡riù
 
__s
,

509 cÚ¡ *
__»¡riù
 
__fÜm©
,

510 
_G_va_li¡
 
__¬g
è
__wur
;

511 
	$__isoc99_vsÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
,

512 
_G_va_li¡
 
__¬g
è
__wur
;

513 
	$__isoc99_vssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

514 cÚ¡ *
__»¡riù
 
__fÜm©
,

515 
_G_va_li¡
 
__¬g
è
__THROW
;

516 
	#vfsÿnf
 
__isoc99_vfsÿnf


	)

517 
	#vsÿnf
 
__isoc99_vsÿnf


	)

518 
	#vssÿnf
 
__isoc99_vssÿnf


	)

522 
__END_NAMESPACE_C99


526 
__BEGIN_NAMESPACE_STD


531 
	`fg‘c
 (
FILE
 *
__¡»am
);

532 
	`g‘c
 (
FILE
 *
__¡»am
);

538 
	`g‘ch¬
 ();

539 
__END_NAMESPACE_STD


543 
	#g‘c
(
_å
è
	`_IO_g‘c
 (_å)

	)

545 #ifdeà
__USE_POSIX


550 
	`g‘c_uÆocked
 (
FILE
 *
__¡»am
);

551 
	`g‘ch¬_uÆocked
 ();

554 #ifdeà
__USE_MISC


561 
	`fg‘c_uÆocked
 (
FILE
 *
__¡»am
);

565 
__BEGIN_NAMESPACE_STD


573 
	`åutc
 (
__c
, 
FILE
 *
__¡»am
);

574 
	`putc
 (
__c
, 
FILE
 *
__¡»am
);

580 
	`putch¬
 (
__c
);

581 
__END_NAMESPACE_STD


585 
	#putc
(
_ch
, 
_å
è
	`_IO_putc
 (_ch, _å)

	)

587 #ifdeà
__USE_MISC


594 
	`åutc_uÆocked
 (
__c
, 
FILE
 *
__¡»am
);

597 #ifdeà
__USE_POSIX


602 
	`putc_uÆocked
 (
__c
, 
FILE
 *
__¡»am
);

603 
	`putch¬_uÆocked
 (
__c
);

607 #ià
defšed
 
__USE_MISC
 \

608 || (
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
)

610 
	`g‘w
 (
FILE
 *
__¡»am
);

613 
	`putw
 (
__w
, 
FILE
 *
__¡»am
);

617 
__BEGIN_NAMESPACE_STD


622 *
	$fg‘s
 (*
__»¡riù
 
__s
, 
__n
, 
FILE
 *__»¡riù 
__¡»am
)

623 
__wur
;

625 #ià!
defšed
 
__USE_ISOC11
 \

626 || (
defšed
 
__ılu¥lus
 && __cplusplus <= 201103L)

638 *
	$g‘s
 (*
__s
è
__wur
 
__©Œibu‹_d•»ÿ‹d__
;

640 
__END_NAMESPACE_STD


642 #ifdeà
__USE_GNU


649 *
	$fg‘s_uÆocked
 (*
__»¡riù
 
__s
, 
__n
,

650 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

654 #ifdef 
__USE_XOPEN2K8


665 
_IO_ssize_t
 
	$__g‘d–im
 (**
__»¡riù
 
__lš•Œ
,

666 
size_t
 *
__»¡riù
 
__n
, 
__d–im™”
,

667 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

668 
_IO_ssize_t
 
	$g‘d–im
 (**
__»¡riù
 
__lš•Œ
,

669 
size_t
 *
__»¡riù
 
__n
, 
__d–im™”
,

670 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

678 
_IO_ssize_t
 
	$g‘lše
 (**
__»¡riù
 
__lš•Œ
,

679 
size_t
 *
__»¡riù
 
__n
,

680 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

684 
__BEGIN_NAMESPACE_STD


689 
	`åuts
 (cÚ¡ *
__»¡riù
 
__s
, 
FILE
 *__»¡riù 
__¡»am
);

695 
	`puts
 (cÚ¡ *
__s
);

702 
	`ung‘c
 (
__c
, 
FILE
 *
__¡»am
);

709 
size_t
 
	$ä—d
 (*
__»¡riù
 
__±r
, 
size_t
 
__size
,

710 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

715 
size_t
 
	`fwr™e
 (cÚ¡ *
__»¡riù
 
__±r
, size_ˆ
__size
,

716 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__s
);

717 
__END_NAMESPACE_STD


719 #ifdeà
__USE_GNU


726 
	`åuts_uÆocked
 (cÚ¡ *
__»¡riù
 
__s
,

727 
FILE
 *
__»¡riù
 
__¡»am
);

730 #ifdeà
__USE_MISC


737 
size_t
 
	$ä—d_uÆocked
 (*
__»¡riù
 
__±r
, 
size_t
 
__size
,

738 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

739 
size_t
 
	`fwr™e_uÆocked
 (cÚ¡ *
__»¡riù
 
__±r
, size_ˆ
__size
,

740 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
);

744 
__BEGIN_NAMESPACE_STD


749 
	`f£ek
 (
FILE
 *
__¡»am
, 
__off
, 
__wh’û
);

754 
	$á–l
 (
FILE
 *
__¡»am
è
__wur
;

759 
	`»wšd
 (
FILE
 *
__¡»am
);

760 
__END_NAMESPACE_STD


767 #ià
defšed
 
__USE_LARGEFILE
 || defšed 
__USE_XOPEN2K


768 #iâdeà
__USE_FILE_OFFSET64


773 
	`f£eko
 (
FILE
 *
__¡»am
, 
__off_t
 
__off
, 
__wh’û
);

778 
__off_t
 
	$á–lo
 (
FILE
 *
__¡»am
è
__wur
;

780 #ifdeà
__REDIRECT


781 
	`__REDIRECT
 (
f£eko
,

782 (
FILE
 *
__¡»am
, 
__off64_t
 
__off
, 
__wh’û
),

783 
f£eko64
);

784 
__off64_t
 
	`__REDIRECT
 (
á–lo
, (
FILE
 *
__¡»am
), 
á–lo64
);

786 
	#f£eko
 
f£eko64


	)

787 
	#á–lo
 
á–lo64


	)

792 
__BEGIN_NAMESPACE_STD


793 #iâdeà
__USE_FILE_OFFSET64


798 
	`fg‘pos
 (
FILE
 *
__»¡riù
 
__¡»am
, 
åos_t
 *__»¡riù 
__pos
);

803 
	`f£os
 (
FILE
 *
__¡»am
, cÚ¡ 
åos_t
 *
__pos
);

805 #ifdeà
__REDIRECT


806 
	`__REDIRECT
 (
fg‘pos
, (
FILE
 *
__»¡riù
 
__¡»am
,

807 
åos_t
 *
__»¡riù
 
__pos
), 
fg‘pos64
);

808 
	`__REDIRECT
 (
f£os
,

809 (
FILE
 *
__¡»am
, cÚ¡ 
åos_t
 *
__pos
), 
f£os64
);

811 
	#fg‘pos
 
fg‘pos64


	)

812 
	#f£os
 
f£os64


	)

815 
__END_NAMESPACE_STD


817 #ifdeà
__USE_LARGEFILE64


818 
	`f£eko64
 (
FILE
 *
__¡»am
, 
__off64_t
 
__off
, 
__wh’û
);

819 
__off64_t
 
	$á–lo64
 (
FILE
 *
__¡»am
è
__wur
;

820 
	`fg‘pos64
 (
FILE
 *
__»¡riù
 
__¡»am
, 
åos64_t
 *__»¡riù 
__pos
);

821 
	`f£os64
 (
FILE
 *
__¡»am
, cÚ¡ 
åos64_t
 *
__pos
);

824 
__BEGIN_NAMESPACE_STD


826 
	$ş—»¼
 (
FILE
 *
__¡»am
è
__THROW
;

828 
	$ãof
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

830 
	$ã¼Ü
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

831 
__END_NAMESPACE_STD


833 #ifdeà
__USE_MISC


835 
	$ş—»¼_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
;

836 
	$ãof_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

837 
	$ã¼Ü_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

841 
__BEGIN_NAMESPACE_STD


846 
	`³¼Ü
 (cÚ¡ *
__s
);

847 
__END_NAMESPACE_STD


853 
	~<b™s/sys_”¾i¡.h
>

856 #ifdef 
__USE_POSIX


858 
	$f’o
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

861 #ifdeà
__USE_MISC


863 
	$f’o_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

867 #ifdeà
__USE_POSIX2


872 
FILE
 *
	$pİ’
 (cÚ¡ *
__commªd
, cÚ¡ *
__modes
è
__wur
;

878 
	`pşo£
 (
FILE
 *
__¡»am
);

882 #ifdef 
__USE_POSIX


884 *
	$ù”mid
 (*
__s
è
__THROW
;

888 #ifdeà
__USE_XOPEN


890 *
	`cu£rid
 (*
__s
);

894 #ifdef 
__USE_GNU


895 
ob¡ack
;

898 
	$ob¡ack_´štf
 (
ob¡ack
 *
__»¡riù
 
__ob¡ack
,

899 cÚ¡ *
__»¡riù
 
__fÜm©
, ...)

900 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 3)));

901 
	$ob¡ack_v´štf
 (
ob¡ack
 *
__»¡riù
 
__ob¡ack
,

902 cÚ¡ *
__»¡riù
 
__fÜm©
,

903 
_G_va_li¡
 
__¬gs
)

904 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 0)));

908 #ifdeà
__USE_POSIX


912 
	$æockfe
 (
FILE
 *
__¡»am
è
__THROW
;

916 
	$árylockfe
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

919 
	$fuÆockfe
 (
FILE
 *
__¡»am
è
__THROW
;

922 #ià
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
 && !defšed 
__USE_GNU


926 
	#__Ãed_g‘İt


	)

927 
	~<g‘İt.h
>

932 #ifdeà
__USE_EXTERN_INLINES


933 
	~<b™s/¡dio.h
>

935 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


936 
	~<b™s/¡dio2.h
>

938 #ifdeà
__LDBL_COMPAT


939 
	~<b™s/¡dio-ldbl.h
>

942 
__END_DECLS


	@/usr/include/stdlib.h

22 #iâdef 
_STDLIB_H


24 
	~<ã©u»s.h
>

27 
	#__Ãed_size_t


	)

28 #iâdeà
__Ãed_m®loc_ªd_ÿÎoc


29 
	#__Ãed_wch¬_t


	)

30 
	#__Ãed_NULL


	)

32 
	~<¡ddef.h
>

34 
	g__BEGIN_DECLS


36 #iâdeà
__Ãed_m®loc_ªd_ÿÎoc


37 
	#_STDLIB_H
 1

	)

39 #ià(
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8
è&& !defšed 
_SYS_WAIT_H


41 
	~<b™s/wa™æags.h
>

42 
	~<b™s/wa™¡©us.h
>

44 #ifdeà
__USE_MISC


49 #ià
defšed
 
__GNUC__
 && !defšed 
__ılu¥lus


50 
	#__WAIT_INT
(
¡©us
) \

51 (
	`__ex‹nsiÚ__
 (((uniÚ { 
	`__ty³of
(
¡©us
è
__š
; 
__i
; }) \

52 { .
__š
 = (
¡©us
è}).
__i
))

	)

54 
	#__WAIT_INT
(
¡©us
è(*(*è&(¡©us))

	)

62 #ià!
defšed
 
__GNUC__
 || __GNUC__ < 2 || defšed 
__ılu¥lus


63 
	#__WAIT_STATUS
 *

	)

64 
	#__WAIT_STATUS_DEFN
 *

	)

69 
wa™
 *
	m__u±r
;

70 *
	m__Œ
;

71 } 
	t__WAIT_STATUS
 
	t__©Œibu‹__
 ((
	t__Œª¥¬’t_uniÚ__
));

72 
	#__WAIT_STATUS_DEFN
 *

	)

77 
	#__WAIT_INT
(
¡©us
è(¡©us)

	)

78 
	#__WAIT_STATUS
 *

	)

79 
	#__WAIT_STATUS_DEFN
 *

	)

84 
	#WEXITSTATUS
(
¡©us
è
	`__WEXITSTATUS
 (
	`__WAIT_INT
 (¡©us))

	)

85 
	#WTERMSIG
(
¡©us
è
	`__WTERMSIG
 (
	`__WAIT_INT
 (¡©us))

	)

86 
	#WSTOPSIG
(
¡©us
è
	`__WSTOPSIG
 (
	`__WAIT_INT
 (¡©us))

	)

87 
	#WIFEXITED
(
¡©us
è
	`__WIFEXITED
 (
	`__WAIT_INT
 (¡©us))

	)

88 
	#WIFSIGNALED
(
¡©us
è
	`__WIFSIGNALED
 (
	`__WAIT_INT
 (¡©us))

	)

89 
	#WIFSTOPPED
(
¡©us
è
	`__WIFSTOPPED
 (
	`__WAIT_INT
 (¡©us))

	)

90 #ifdeà
__WIFCONTINUED


91 
	#WIFCONTINUED
(
¡©us
è
	`__WIFCONTINUED
 (
	`__WAIT_INT
 (¡©us))

	)

95 
__BEGIN_NAMESPACE_STD


99 
	mquÙ
;

100 
	m»m
;

101 } 
	tdiv_t
;

104 #iâdeà
__ldiv_t_defšed


107 
	mquÙ
;

108 
	m»m
;

109 } 
	tldiv_t
;

110 
	#__ldiv_t_defšed
 1

	)

112 
	g__END_NAMESPACE_STD


114 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__Îdiv_t_defšed


115 
__BEGIN_NAMESPACE_C99


117 
__ex‹nsiÚ__
 struct

119 
	mquÙ
;

120 
	m»m
;

121 } 
	tÎdiv_t
;

122 
	#__Îdiv_t_defšed
 1

	)

123 
	g__END_NAMESPACE_C99


128 
	#RAND_MAX
 2147483647

	)

133 
	#EXIT_FAILURE
 1

	)

134 
	#EXIT_SUCCESS
 0

	)

138 
	#MB_CUR_MAX
 (
	`__ùy³_g‘_mb_cur_max
 ())

	)

139 
size_t
 
	$__ùy³_g‘_mb_cur_max
 (è
__THROW
 
__wur
;

142 
__BEGIN_NAMESPACE_STD


144 
	$©of
 (cÚ¡ *
__ÅŒ
)

145 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

147 
	$©oi
 (cÚ¡ *
__ÅŒ
)

148 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

150 
	$©Ş
 (cÚ¡ *
__ÅŒ
)

151 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

152 
__END_NAMESPACE_STD


154 #ifdeà
__USE_ISOC99


155 
__BEGIN_NAMESPACE_C99


157 
__ex‹nsiÚ__
 
	$©Şl
 (cÚ¡ *
__ÅŒ
)

158 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

159 
__END_NAMESPACE_C99


162 
__BEGIN_NAMESPACE_STD


164 
	$¡¹od
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

165 **
__»¡riù
 
__’d±r
)

166 
__THROW
 
	`__nÚnuÎ
 ((1));

167 
__END_NAMESPACE_STD


169 #ifdef 
__USE_ISOC99


170 
__BEGIN_NAMESPACE_C99


172 
	$¡¹of
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

173 **
__»¡riù
 
__’d±r
è
__THROW
 
	`__nÚnuÎ
 ((1));

175 
	$¡¹Şd
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

176 **
__»¡riù
 
__’d±r
)

177 
__THROW
 
	`__nÚnuÎ
 ((1));

178 
__END_NAMESPACE_C99


181 
__BEGIN_NAMESPACE_STD


183 
	$¡¹Ş
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

184 **
__»¡riù
 
__’d±r
, 
__ba£
)

185 
__THROW
 
	`__nÚnuÎ
 ((1));

187 
	$¡¹oul
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

188 **
__»¡riù
 
__’d±r
, 
__ba£
)

189 
__THROW
 
	`__nÚnuÎ
 ((1));

190 
__END_NAMESPACE_STD


192 #ifdeà
__USE_MISC


194 
__ex‹nsiÚ__


195 
	$¡¹oq
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

196 **
__»¡riù
 
__’d±r
, 
__ba£
)

197 
__THROW
 
	`__nÚnuÎ
 ((1));

199 
__ex‹nsiÚ__


200 
	$¡¹ouq
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

201 **
__»¡riù
 
__’d±r
, 
__ba£
)

202 
__THROW
 
	`__nÚnuÎ
 ((1));

205 #ifdeà
__USE_ISOC99


206 
__BEGIN_NAMESPACE_C99


208 
__ex‹nsiÚ__


209 
	$¡¹Şl
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

210 **
__»¡riù
 
__’d±r
, 
__ba£
)

211 
__THROW
 
	`__nÚnuÎ
 ((1));

213 
__ex‹nsiÚ__


214 
	$¡¹ouÎ
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

215 **
__»¡riù
 
__’d±r
, 
__ba£
)

216 
__THROW
 
	`__nÚnuÎ
 ((1));

217 
__END_NAMESPACE_C99


221 #ifdeà
__USE_GNU


235 
	~<xloÿË.h
>

239 
	$¡¹Ş_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

240 **
__»¡riù
 
__’d±r
, 
__ba£
,

241 
__loÿË_t
 
__loc
è
__THROW
 
	`__nÚnuÎ
 ((1, 4));

243 
	$¡¹oul_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

244 **
__»¡riù
 
__’d±r
,

245 
__ba£
, 
__loÿË_t
 
__loc
)

246 
__THROW
 
	`__nÚnuÎ
 ((1, 4));

248 
__ex‹nsiÚ__


249 
	$¡¹Şl_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

250 **
__»¡riù
 
__’d±r
, 
__ba£
,

251 
__loÿË_t
 
__loc
)

252 
__THROW
 
	`__nÚnuÎ
 ((1, 4));

254 
__ex‹nsiÚ__


255 
	$¡¹ouÎ_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

256 **
__»¡riù
 
__’d±r
,

257 
__ba£
, 
__loÿË_t
 
__loc
)

258 
__THROW
 
	`__nÚnuÎ
 ((1, 4));

260 
	$¡¹od_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

261 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

262 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

264 
	$¡¹of_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

265 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

266 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

268 
	$¡¹Şd_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

269 **
__»¡riù
 
__’d±r
,

270 
__loÿË_t
 
__loc
)

271 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

275 #ifdeà
__USE_EXTERN_INLINES


276 
__BEGIN_NAMESPACE_STD


277 
__ex‹º_šlše
 

278 
	`__NTH
 (
	$©oi
 (cÚ¡ *
__ÅŒ
))

280  (è
	`¡¹Ş
 (
__ÅŒ
, (**è
NULL
, 10);

281 
	}
}

282 
__ex‹º_šlše
 

283 
__NTH
 (
	$©Ş
 (cÚ¡ *
__ÅŒ
))

285  
	`¡¹Ş
 (
__ÅŒ
, (**è
NULL
, 10);

286 
	}
}

287 
	g__END_NAMESPACE_STD


289 #ifdeà
__USE_ISOC99


290 
__BEGIN_NAMESPACE_C99


291 
__ex‹nsiÚ__
 
__ex‹º_šlše
 

292 
__NTH
 (
	$©Şl
 (cÚ¡ *
__ÅŒ
))

294  
	`¡¹Şl
 (
__ÅŒ
, (**è
NULL
, 10);

295 
	}
}

296 
	g__END_NAMESPACE_C99


301 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


305 *
	$l64a
 (
__n
è
__THROW
 
__wur
;

308 
	$a64l
 (cÚ¡ *
__s
)

309 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

313 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


314 
	~<sys/ty³s.h
>

321 
	$¿ndom
 (è
__THROW
;

324 
	$¤ªdom
 (
__£ed
è
__THROW
;

330 *
	$š™¡©e
 (
__£ed
, *
__¡©ebuf
,

331 
size_t
 
__¡©–’
è
__THROW
 
	`__nÚnuÎ
 ((2));

335 *
	$£t¡©e
 (*
__¡©ebuf
è
__THROW
 
	`__nÚnuÎ
 ((1));

338 #ifdeà
__USE_MISC


343 
	s¿ndom_d©a


345 
št32_t
 *
åŒ
;

346 
št32_t
 *
½Œ
;

347 
št32_t
 *
¡©e
;

348 
¿nd_ty³
;

349 
¿nd_deg
;

350 
¿nd_£p
;

351 
št32_t
 *
’d_±r
;

354 
	$¿ndom_r
 (
¿ndom_d©a
 *
__»¡riù
 
__buf
,

355 
št32_t
 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

357 
	$¤ªdom_r
 (
__£ed
, 
¿ndom_d©a
 *
__buf
)

358 
__THROW
 
	`__nÚnuÎ
 ((2));

360 
	$š™¡©e_r
 (
__£ed
, *
__»¡riù
 
__¡©ebuf
,

361 
size_t
 
__¡©–’
,

362 
¿ndom_d©a
 *
__»¡riù
 
__buf
)

363 
__THROW
 
	`__nÚnuÎ
 ((2, 4));

365 
	$£t¡©e_r
 (*
__»¡riù
 
__¡©ebuf
,

366 
¿ndom_d©a
 *
__»¡riù
 
__buf
)

367 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

372 
__BEGIN_NAMESPACE_STD


374 
	$¿nd
 (è
__THROW
;

376 
	$¤ªd
 (
__£ed
è
__THROW
;

377 
__END_NAMESPACE_STD


379 #ifdeà
__USE_POSIX


381 
	$¿nd_r
 (*
__£ed
è
__THROW
;

385 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


389 
	$d¿nd48
 (è
__THROW
;

390 
	$”ªd48
 (
__xsubi
[3]è
__THROW
 
	`__nÚnuÎ
 ((1));

393 
	$Ìªd48
 (è
__THROW
;

394 
	$Äªd48
 (
__xsubi
[3])

395 
__THROW
 
	`__nÚnuÎ
 ((1));

398 
	$m¿nd48
 (è
__THROW
;

399 
	$j¿nd48
 (
__xsubi
[3])

400 
__THROW
 
	`__nÚnuÎ
 ((1));

403 
	$¤ªd48
 (
__£edv®
è
__THROW
;

404 *
	$£ed48
 (
__£ed16v
[3])

405 
__THROW
 
	`__nÚnuÎ
 ((1));

406 
	$lcÚg48
 (
__·¿m
[7]è
__THROW
 
	`__nÚnuÎ
 ((1));

408 #ifdeà
__USE_MISC


412 
	sd¿nd48_d©a


414 
__x
[3];

415 
__Şd_x
[3];

416 
__c
;

417 
__š™
;

418 
__ex‹nsiÚ__
 
__a
;

423 
	$d¿nd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

424 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

425 
	$”ªd48_r
 (
__xsubi
[3],

426 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

427 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

430 
	$Ìªd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

431 *
__»¡riù
 
__»suÉ
)

432 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

433 
	$Äªd48_r
 (
__xsubi
[3],

434 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

435 *
__»¡riù
 
__»suÉ
)

436 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

439 
	$m¿nd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

440 *
__»¡riù
 
__»suÉ
)

441 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

442 
	$j¿nd48_r
 (
__xsubi
[3],

443 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

444 *
__»¡riù
 
__»suÉ
)

445 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

448 
	$¤ªd48_r
 (
__£edv®
, 
d¿nd48_d©a
 *
__bufãr
)

449 
__THROW
 
	`__nÚnuÎ
 ((2));

451 
	$£ed48_r
 (
__£ed16v
[3],

452 
d¿nd48_d©a
 *
__bufãr
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

454 
	$lcÚg48_r
 (
__·¿m
[7],

455 
d¿nd48_d©a
 *
__bufãr
)

456 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

462 #iâdeà
__m®loc_ªd_ÿÎoc_defšed


463 
	#__m®loc_ªd_ÿÎoc_defšed


	)

464 
__BEGIN_NAMESPACE_STD


466 *
	$m®loc
 (
size_t
 
__size
è
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

468 *
	$ÿÎoc
 (
size_t
 
__nmemb
, size_ˆ
__size
)

469 
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

470 
__END_NAMESPACE_STD


473 #iâdeà
__Ãed_m®loc_ªd_ÿÎoc


474 
__BEGIN_NAMESPACE_STD


480 *
	$»®loc
 (*
__±r
, 
size_t
 
__size
)

481 
__THROW
 
__©Œibu‹_w¬n_unu£d_»suÉ__
;

483 
	$ä“
 (*
__±r
è
__THROW
;

484 
__END_NAMESPACE_STD


486 #ifdef 
__USE_MISC


488 
	$cä“
 (*
__±r
è
__THROW
;

491 #ifdeà
__USE_MISC


492 
	~<®loÿ.h
>

495 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K
) \

496 || 
defšed
 
__USE_MISC


498 *
	$v®loc
 (
size_t
 
__size
è
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

501 #ifdeà
__USE_XOPEN2K


503 
	$posix_mem®ign
 (**
__mem±r
, 
size_t
 
__®ignm’t
, size_ˆ
__size
)

504 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

507 #ifdeà
__USE_ISOC11


509 *
	$®igÃd_®loc
 (
size_t
 
__®ignm’t
, size_ˆ
__size
)

510 
__THROW
 
__©Œibu‹_m®loc__
 
	`__©Œibu‹_®loc_size__
 ((2)è
__wur
;

513 
__BEGIN_NAMESPACE_STD


515 
	$abÜt
 (è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

519 
	$©ex™
 ((*
__func
è()è
__THROW
 
	`__nÚnuÎ
 ((1));

521 #ià
defšed
 
__USE_ISOC11
 || defšed 
__USE_ISOCXX11


523 #ifdeà
__ılu¥lus


524 "C++" 
	$©_quick_ex™
 ((*
__func
) ())

525 
__THROW
 
	`__asm
 ("©_quick_ex™"è
	`__nÚnuÎ
 ((1));

527 
	$©_quick_ex™
 ((*
__func
è()è
__THROW
 
	`__nÚnuÎ
 ((1));

530 
__END_NAMESPACE_STD


532 #ifdef 
__USE_MISC


535 
	$Ú_ex™
 ((*
__func
è(
__¡©us
, *
__¬g
), *__arg)

536 
__THROW
 
	`__nÚnuÎ
 ((1));

539 
__BEGIN_NAMESPACE_STD


543 
	$ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

545 #ià
defšed
 
__USE_ISOC11
 || defšed 
__USE_ISOCXX11


549 
	$quick_ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

551 
__END_NAMESPACE_STD


553 #ifdeà
__USE_ISOC99


554 
__BEGIN_NAMESPACE_C99


557 
	$_Ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

558 
__END_NAMESPACE_C99


562 
__BEGIN_NAMESPACE_STD


564 *
	$g‘’v
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

565 
__END_NAMESPACE_STD


567 #ifdeà
__USE_GNU


570 *
	$£cu»_g‘’v
 (cÚ¡ *
__Çme
)

571 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

574 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


578 
	$pu‹nv
 (*
__¡ršg
è
__THROW
 
	`__nÚnuÎ
 ((1));

581 #ifdeà
__USE_XOPEN2K


584 
	$£‹nv
 (cÚ¡ *
__Çme
, cÚ¡ *
__v®ue
, 
__»¶aû
)

585 
__THROW
 
	`__nÚnuÎ
 ((2));

588 
	$un£‹nv
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

591 #ifdef 
__USE_MISC


595 
	$ş—»nv
 (è
__THROW
;

599 #ià
defšed
 
__USE_MISC
 \

600 || (
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
)

606 *
	$mk‹mp
 (*
__‹m¶©e
è
__THROW
 
	`__nÚnuÎ
 ((1));

609 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


618 #iâdeà
__USE_FILE_OFFSET64


619 
	$mk¡emp
 (*
__‹m¶©e
è
	`__nÚnuÎ
 ((1)è
__wur
;

621 #ifdeà
__REDIRECT


622 
	`__REDIRECT
 (
mk¡emp
, (*
__‹m¶©e
), 
mk¡emp64
)

623 
	`__nÚnuÎ
 ((1)è
__wur
;

625 
	#mk¡emp
 
mk¡emp64


	)

628 #ifdeà
__USE_LARGEFILE64


629 
	$mk¡emp64
 (*
__‹m¶©e
è
	`__nÚnuÎ
 ((1)è
__wur
;

633 #ifdeà
__USE_MISC


640 #iâdeà
__USE_FILE_OFFSET64


641 
	$mk¡emps
 (*
__‹m¶©e
, 
__suffixËn
è
	`__nÚnuÎ
 ((1)è
__wur
;

643 #ifdeà
__REDIRECT


644 
	`__REDIRECT
 (
mk¡emps
, (*
__‹m¶©e
, 
__suffixËn
),

645 
mk¡emps64
è
	`__nÚnuÎ
 ((1)è
__wur
;

647 
	#mk¡emps
 
mk¡emps64


	)

650 #ifdeà
__USE_LARGEFILE64


651 
	$mk¡emps64
 (*
__‹m¶©e
, 
__suffixËn
)

652 
	`__nÚnuÎ
 ((1)è
__wur
;

656 #ifdeà
__USE_XOPEN2K8


662 *
	$mkd‹mp
 (*
__‹m¶©e
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

665 #ifdeà
__USE_GNU


672 #iâdeà
__USE_FILE_OFFSET64


673 
	$mko¡emp
 (*
__‹m¶©e
, 
__æags
è
	`__nÚnuÎ
 ((1)è
__wur
;

675 #ifdeà
__REDIRECT


676 
	`__REDIRECT
 (
mko¡emp
, (*
__‹m¶©e
, 
__æags
), 
mko¡emp64
)

677 
	`__nÚnuÎ
 ((1)è
__wur
;

679 
	#mko¡emp
 
mko¡emp64


	)

682 #ifdeà
__USE_LARGEFILE64


683 
	$mko¡emp64
 (*
__‹m¶©e
, 
__æags
è
	`__nÚnuÎ
 ((1)è
__wur
;

692 #iâdeà
__USE_FILE_OFFSET64


693 
	$mko¡emps
 (*
__‹m¶©e
, 
__suffixËn
, 
__æags
)

694 
	`__nÚnuÎ
 ((1)è
__wur
;

696 #ifdeà
__REDIRECT


697 
	`__REDIRECT
 (
mko¡emps
, (*
__‹m¶©e
, 
__suffixËn
,

698 
__æags
), 
mko¡emps64
)

699 
	`__nÚnuÎ
 ((1)è
__wur
;

701 
	#mko¡emps
 
mko¡emps64


	)

704 #ifdeà
__USE_LARGEFILE64


705 
	$mko¡emps64
 (*
__‹m¶©e
, 
__suffixËn
, 
__æags
)

706 
	`__nÚnuÎ
 ((1)è
__wur
;

711 
__BEGIN_NAMESPACE_STD


716 
	$sy¡em
 (cÚ¡ *
__commªd
è
__wur
;

717 
__END_NAMESPACE_STD


720 #ifdef 
__USE_GNU


723 *
	$ÿnÚiÿlize_fe_Çme
 (cÚ¡ *
__Çme
)

724 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

727 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


733 *
	$»®·th
 (cÚ¡ *
__»¡riù
 
__Çme
,

734 *
__»¡riù
 
__»sŞved
è
__THROW
 
__wur
;

739 #iâdeà
__COMPAR_FN_T


740 
	#__COMPAR_FN_T


	)

741 (*
	t__com·r_â_t
) (const *, const *);

743 #ifdef 
__USE_GNU


744 
__com·r_â_t
 
	tcom·risÚ_â_t
;

747 #ifdeà
__USE_GNU


748 (*
	t__com·r_d_â_t
) (const *, const *, *);

751 
__BEGIN_NAMESPACE_STD


754 *
	$b£¬ch
 (cÚ¡ *
__key
, cÚ¡ *
__ba£
,

755 
size_t
 
__nmemb
, size_ˆ
__size
, 
__com·r_â_t
 
__com·r
)

756 
	`__nÚnuÎ
 ((1, 2, 5)è
__wur
;

758 #ifdeà
__USE_EXTERN_INLINES


759 
	~<b™s/¡dlib-b£¬ch.h
>

764 
	$qsÜt
 (*
__ba£
, 
size_t
 
__nmemb
, size_ˆ
__size
,

765 
__com·r_â_t
 
__com·r
è
	`__nÚnuÎ
 ((1, 4));

766 #ifdeà
__USE_GNU


767 
	$qsÜt_r
 (*
__ba£
, 
size_t
 
__nmemb
, size_ˆ
__size
,

768 
__com·r_d_â_t
 
__com·r
, *
__¬g
)

769 
	`__nÚnuÎ
 ((1, 4));

774 
	$abs
 (
__x
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

775 
	$Ïbs
 (
__x
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

776 
__END_NAMESPACE_STD


778 #ifdeà
__USE_ISOC99


779 
__ex‹nsiÚ__
 
	$Îabs
 (
__x
)

780 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

784 
__BEGIN_NAMESPACE_STD


788 
div_t
 
	$div
 (
__num”
, 
__d’om
)

789 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

790 
ldiv_t
 
	$ldiv
 (
__num”
, 
__d’om
)

791 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

792 
__END_NAMESPACE_STD


794 #ifdeà
__USE_ISOC99


795 
__BEGIN_NAMESPACE_C99


796 
__ex‹nsiÚ__
 
Îdiv_t
 
	$Îdiv
 (
__num”
,

797 
__d’om
)

798 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

799 
__END_NAMESPACE_C99


803 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

804 || 
defšed
 
__USE_MISC


811 *
	$ecvt
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

812 *
__»¡riù
 
__sign
è
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

817 *
	$fcvt
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

818 *
__»¡riù
 
__sign
è
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

823 *
	$gcvt
 (
__v®ue
, 
__ndig™
, *
__buf
)

824 
__THROW
 
	`__nÚnuÎ
 ((3)è
__wur
;

827 #ifdeà
__USE_MISC


829 *
	$qecvt
 (
__v®ue
, 
__ndig™
,

830 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
)

831 
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

832 *
	$qfcvt
 (
__v®ue
, 
__ndig™
,

833 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
)

834 
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

835 *
	$qgcvt
 (
__v®ue
, 
__ndig™
, *
__buf
)

836 
__THROW
 
	`__nÚnuÎ
 ((3)è
__wur
;

841 
	$ecvt_r
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

842 *
__»¡riù
 
__sign
, *__»¡riù 
__buf
,

843 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

844 
	$fcvt_r
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

845 *
__»¡riù
 
__sign
, *__»¡riù 
__buf
,

846 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

848 
	$qecvt_r
 (
__v®ue
, 
__ndig™
,

849 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
,

850 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

851 
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

852 
	$qfcvt_r
 (
__v®ue
, 
__ndig™
,

853 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
,

854 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

855 
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

859 
__BEGIN_NAMESPACE_STD


862 
	$mbËn
 (cÚ¡ *
__s
, 
size_t
 
__n
è
__THROW
;

865 
	$mbtowc
 (
wch¬_t
 *
__»¡riù
 
__pwc
,

866 cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
è
__THROW
;

869 
	$wùomb
 (*
__s
, 
wch¬_t
 
__wch¬
è
__THROW
;

873 
size_t
 
	$mb¡owcs
 (
wch¬_t
 *
__»¡riù
 
__pwcs
,

874 cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
è
__THROW
;

876 
size_t
 
	$wc¡ombs
 (*
__»¡riù
 
__s
,

877 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__pwcs
, 
size_t
 
__n
)

878 
__THROW
;

879 
__END_NAMESPACE_STD


882 #ifdeà
__USE_MISC


887 
	$½m©ch
 (cÚ¡ *
__»¥Ú£
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

891 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


898 
	$g‘subİt
 (**
__»¡riù
 
__İtiÚp
,

899 *cÚ¡ *
__»¡riù
 
__tok’s
,

900 **
__»¡riù
 
__v®u•
)

901 
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3)è
__wur
;

905 #ifdeà
__USE_XOPEN


907 
	$£tkey
 (cÚ¡ *
__key
è
__THROW
 
	`__nÚnuÎ
 ((1));

913 #ifdeà
__USE_XOPEN2KXSI


915 
	$posix_İ’±
 (
__oæag
è
__wur
;

918 #ifdeà
__USE_XOPEN


923 
	$g¿Á±
 (
__fd
è
__THROW
;

927 
	$uÆock±
 (
__fd
è
__THROW
;

932 *
	$±¢ame
 (
__fd
è
__THROW
 
__wur
;

935 #ifdeà
__USE_GNU


939 
	$±¢ame_r
 (
__fd
, *
__buf
, 
size_t
 
__buæ’
)

940 
__THROW
 
	`__nÚnuÎ
 ((2));

943 
	`g‘±
 ();

946 #ifdeà
__USE_MISC


950 
	$g‘lßdavg
 (
__lßdavg
[], 
__ÃËm
)

951 
__THROW
 
	`__nÚnuÎ
 ((1));

954 
	~<b™s/¡dlib-æßt.h
>

957 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


958 
	~<b™s/¡dlib.h
>

960 #ifdeà
__LDBL_COMPAT


961 
	~<b™s/¡dlib-ldbl.h
>

965 #undeà
__Ãed_m®loc_ªd_ÿÎoc


967 
__END_DECLS


	@/usr/include/string.h

22 #iâdef 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	g__BEGIN_DECLS


30 
	#__Ãed_size_t


	)

31 
	#__Ãed_NULL


	)

32 
	~<¡ddef.h
>

35 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (4, 4)

36 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

40 
__BEGIN_NAMESPACE_STD


42 *
	$memıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

43 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

46 *
	$memmove
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
)

47 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

48 
__END_NAMESPACE_STD


53 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


54 *
	$memcıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

55 
__c
, 
size_t
 
__n
)

56 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

60 
__BEGIN_NAMESPACE_STD


62 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

65 
	$memcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

66 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

69 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


72 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

73 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

74 cÚ¡ *
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

75 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

77 #ifdeà
__OPTIMIZE__


78 
__ex‹º_®ways_šlše
 *

79 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW


81  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

84 
__ex‹º_®ways_šlše
 const *

85 
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
è
__THROW


87  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

90 
	}
}

92 *
	$memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

93 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

95 
__END_NAMESPACE_STD


97 #ifdeà
__USE_GNU


100 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


101 "C++" *
	$¿wmemchr
 (*
__s
, 
__c
)

102 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

103 "C++" cÚ¡ *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

104 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

106 *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

107 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

111 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


112 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

113 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

114 "C++" cÚ¡ *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

115 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

117 *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

118 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

123 
__BEGIN_NAMESPACE_STD


125 *
	$¡rıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

126 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

128 *
	$¡ºıy
 (*
__»¡riù
 
__de¡
,

129 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

130 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

133 *
	$¡rÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

134 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

136 *
	$¡ºÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

137 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

140 
	$¡rcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

141 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

143 
	$¡ºcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

144 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

147 
	$¡rcŞl
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

148 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

150 
size_t
 
	$¡rxäm
 (*
__»¡riù
 
__de¡
,

151 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

152 
__THROW
 
	`__nÚnuÎ
 ((2));

153 
__END_NAMESPACE_STD


155 #ifdeà
__USE_XOPEN2K8


159 
	~<xloÿË.h
>

162 
	$¡rcŞl_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
__loÿË_t
 
__l
)

163 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

165 
size_t
 
	$¡rxäm_l
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
,

166 
__loÿË_t
 
__l
è
__THROW
 
	`__nÚnuÎ
 ((2, 4));

169 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


171 *
	$¡rdup
 (cÚ¡ *
__s
)

172 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

178 #ià
defšed
 
__USE_XOPEN2K8


179 *
	$¡ºdup
 (cÚ¡ *
__¡ršg
, 
size_t
 
__n
)

180 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

183 #ià
defšed
 
__USE_GNU
 && defšed 
__GNUC__


185 
	#¡rdu·
(
s
) \

186 (
__ex‹nsiÚ__
 \

188 cÚ¡ *
__Şd
 = (
s
); \

189 
size_t
 
__Ën
 = 
	`¡¾’
 (
__Şd
) + 1; \

190 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
); \

191 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

192 
	}
}))

	)

195 
	#¡ºdu·
(
s
, 
n
) \

196 (
__ex‹nsiÚ__
 \

198 cÚ¡ *
__Şd
 = (
s
); \

199 
size_t
 
__Ën
 = 
	`¡ºËn
 (
__Şd
, (
n
)); \

200 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
 + 1); \

201 
__Ãw
[
__Ën
] = '\0'; \

202 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

203 }))

	)

206 
	g__BEGIN_NAMESPACE_STD


208 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


211 *
¡rchr
 (*
__s
, 
__c
)

212 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

213 cÚ¡ *
¡rchr
 (cÚ¡ *
__s
, 
__c
)

214 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

216 #ifdeà
__OPTIMIZE__


217 
__ex‹º_®ways_šlše
 *

218 
¡rchr
 (*
__s
, 
__c
è
	g__THROW


220  
__butš_¡rchr
 (
__s
, 
__c
);

223 
__ex‹º_®ways_šlše
 const *

224 
¡rchr
 (cÚ¡ *
__s
, 
__c
è
	g__THROW


226  
__butš_¡rchr
 (
__s
, 
__c
);

231 *
	$¡rchr
 (cÚ¡ *
__s
, 
__c
)

232 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

235 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


238 *
	`¡¼chr
 (*
__s
, 
__c
)

239 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

240 cÚ¡ *
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
)

241 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

243 #ifdeà
__OPTIMIZE__


244 
__ex‹º_®ways_šlše
 *

245 
	`¡¼chr
 (*
__s
, 
__c
è
__THROW


247  
	`__butš_¡¼chr
 (
__s
, 
__c
);

250 
__ex‹º_®ways_šlše
 const *

251 
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
è
__THROW


253  
	`__butš_¡¼chr
 (
__s
, 
__c
);

256 
	}
}

258 *
	$¡¼chr
 (cÚ¡ *
__s
, 
__c
)

259 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

261 
__END_NAMESPACE_STD


263 #ifdeà
__USE_GNU


266 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


267 "C++" *
	$¡rchºul
 (*
__s
, 
__c
)

268 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

269 "C++" cÚ¡ *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

270 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

272 *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

273 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

277 
__BEGIN_NAMESPACE_STD


280 
size_t
 
	$¡rc¥n
 (cÚ¡ *
__s
, cÚ¡ *
__»jeù
)

281 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

284 
size_t
 
	$¡r¥n
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

285 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

287 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


290 *
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
)

291 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

292 cÚ¡ *
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

293 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

295 #ifdeà
__OPTIMIZE__


296 
__ex‹º_®ways_šlše
 *

297 
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
è
__THROW


299  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

302 
__ex‹º_®ways_šlše
 const *

303 
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
è
__THROW


305  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

308 
	}
}

310 *
	$¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

311 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

314 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


317 *
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

318 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

319 cÚ¡ *
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

320 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

322 #ifdeà
__OPTIMIZE__


323 
__ex‹º_®ways_šlše
 *

324 
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


326  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

329 
__ex‹º_®ways_šlše
 const *

330 
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


332  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

335 
	}
}

337 *
	$¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

338 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

343 *
	$¡¹ok
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
)

344 
__THROW
 
	`__nÚnuÎ
 ((2));

345 
__END_NAMESPACE_STD


349 *
	$__¡¹ok_r
 (*
__»¡riù
 
__s
,

350 cÚ¡ *
__»¡riù
 
__d–im
,

351 **
__»¡riù
 
__§ve_±r
)

352 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

353 #ifdeà
__USE_POSIX


354 *
	$¡¹ok_r
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
,

355 **
__»¡riù
 
__§ve_±r
)

356 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

359 #ifdeà
__USE_GNU


361 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


362 "C++" *
	$¡rÿ£¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

363 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

364 "C++" cÚ¡ *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
,

365 cÚ¡ *
__ÃedË
)

366 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

368 *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

369 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

373 #ifdeà
__USE_GNU


377 *
	$memmem
 (cÚ¡ *
__hay¡ack
, 
size_t
 
__hay¡ackËn
,

378 cÚ¡ *
__ÃedË
, 
size_t
 
__ÃedËËn
)

379 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 3));

383 *
	$__mempıy
 (*
__»¡riù
 
__de¡
,

384 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

385 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

386 *
	$mempıy
 (*
__»¡riù
 
__de¡
,

387 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

388 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

392 
__BEGIN_NAMESPACE_STD


394 
size_t
 
	$¡¾’
 (cÚ¡ *
__s
)

395 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

396 
__END_NAMESPACE_STD


398 #ifdef 
__USE_XOPEN2K8


401 
size_t
 
	$¡ºËn
 (cÚ¡ *
__¡ršg
, 
size_t
 
__maxËn
)

402 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

406 
__BEGIN_NAMESPACE_STD


408 *
	$¡»¼Ü
 (
__”ºum
è
__THROW
;

409 
__END_NAMESPACE_STD


410 #ifdeà
__USE_XOPEN2K


418 #ià
defšed
 
__USE_XOPEN2K
 && !defšed 
__USE_GNU


421 #ifdeà
__REDIRECT_NTH


422 
	`__REDIRECT_NTH
 (
¡»¼Ü_r
,

423 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
),

424 
__xpg_¡»¼Ü_r
è
	`__nÚnuÎ
 ((2));

426 
	$__xpg_¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

427 
__THROW
 
	`__nÚnuÎ
 ((2));

428 
	#¡»¼Ü_r
 
__xpg_¡»¼Ü_r


	)

433 *
	$¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

434 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

438 #ifdeà
__USE_XOPEN2K8


440 *
	$¡»¼Ü_l
 (
__”ºum
, 
__loÿË_t
 
__l
è
__THROW
;

446 
	$__bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

448 #ifdeà
__USE_MISC


450 
	$bcİy
 (cÚ¡ *
__¤c
, *
__de¡
, 
size_t
 
__n
)

451 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

454 
	$bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

457 
	$bcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

458 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

461 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


464 *
	`šdex
 (*
__s
, 
__c
)

465 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

466 cÚ¡ *
	`šdex
 (cÚ¡ *
__s
, 
__c
)

467 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

469 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


470 
__ex‹º_®ways_šlše
 *

471 
	`šdex
 (*
__s
, 
__c
è
__THROW


473  
	`__butš_šdex
 (
__s
, 
__c
);

476 
__ex‹º_®ways_šlše
 const *

477 
	`šdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


479  
	`__butš_šdex
 (
__s
, 
__c
);

482 
	}
}

484 *
	$šdex
 (cÚ¡ *
__s
, 
__c
)

485 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

489 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


492 *
	`ršdex
 (*
__s
, 
__c
)

493 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

494 cÚ¡ *
	`ršdex
 (cÚ¡ *
__s
, 
__c
)

495 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

497 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


498 
__ex‹º_®ways_šlše
 *

499 
	`ršdex
 (*
__s
, 
__c
è
__THROW


501  
	`__butš_ršdex
 (
__s
, 
__c
);

504 
__ex‹º_®ways_šlše
 const *

505 
	`ršdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


507  
	`__butš_ršdex
 (
__s
, 
__c
);

510 
	}
}

512 *
	$ršdex
 (cÚ¡ *
__s
, 
__c
)

513 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

518 
	$ffs
 (
__i
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

522 #ifdef 
__USE_GNU


523 
	$ff¦
 (
__l
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

524 
__ex‹nsiÚ__
 
	$ff¦l
 (
__Î
)

525 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

529 
	$¡rÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

530 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

533 
	$¡ºÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

534 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

537 #ifdef 
__USE_GNU


540 
	$¡rÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
,

541 
__loÿË_t
 
__loc
)

542 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

544 
	$¡ºÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
,

545 
size_t
 
__n
, 
__loÿË_t
 
__loc
)

546 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 4));

549 #ifdef 
__USE_MISC


552 *
	$¡r£p
 (**
__»¡riù
 
__¡ršgp
,

553 cÚ¡ *
__»¡riù
 
__d–im
)

554 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

557 #ifdef 
__USE_XOPEN2K8


559 *
	$¡rsigÇl
 (
__sig
è
__THROW
;

562 *
	$__¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

563 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

564 *
	$¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

565 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

569 *
	$__¡²ıy
 (*
__»¡riù
 
__de¡
,

570 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

571 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

572 *
	$¡²ıy
 (*
__»¡riù
 
__de¡
,

573 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

574 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

577 #ifdef 
__USE_GNU


579 
	$¡rv”scmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

580 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

583 *
	$¡räy
 (*
__¡ršg
è
__THROW
 
	`__nÚnuÎ
 ((1));

586 *
	$memäob
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

588 #iâdeà
ba£Çme


593 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


594 "C++" *
	$ba£Çme
 (*
__f’ame
)

595 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

596 "C++" cÚ¡ *
	$ba£Çme
 (cÚ¡ *
__f’ame
)

597 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

599 *
	$ba£Çme
 (cÚ¡ *
__f’ame
è
__THROW
 
	`__nÚnuÎ
 ((1));

605 #ià
defšed
 
__GNUC__
 && __GNUC__ >= 2

606 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__OPTIMIZE_SIZE__
 \

607 && !
defšed
 
__NO_INLINE__
 && !defšed 
__ılu¥lus


627 
	~<b™s/¡ršg.h
>

630 
	~<b™s/¡ršg2.h
>

633 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


635 
	~<b™s/¡ršg3.h
>

639 #ià
defšed
 
__USE_GNU
 && defšed 
__OPTIMIZE__
 \

640 && 
defšed
 
__ex‹º_®ways_šlše
 && 
	$__GNUC_PREREQ
 (3,2)

641 #ià!
defšed
 
_FORCE_INLINES
 && !defšed 
_HAVE_STRING_ARCH_mempıy


643 #undeà
mempıy


644 #undeà
__mempıy


645 
	#mempıy
(
de¡
, 
¤c
, 
n
è
	`__mempıy_šlše
 (de¡, src,‚)

	)

646 
	#__mempıy
(
de¡
, 
¤c
, 
n
è
	`__mempıy_šlše
 (de¡, src,‚)

	)

648 
__ex‹º_®ways_šlše
 *

649 
	$__mempıy_šlše
 (*
__»¡riù
 
__de¡
,

650 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

652  (*è
	`memıy
 (
__de¡
, 
__¤c
, 
__n
) + __n;

653 
	}
}

658 
	g__END_DECLS


	@/usr/include/stropts.h

18 #iâdeà
_STROPTS_H


19 
	#_STROPTS_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	~<b™s/ty³s.h
>

23 
	~<b™s/xt™y³s.h
>

25 #iâdeà
__gid_t_defšed


26 
__gid_t
 
	tgid_t
;

27 
	#__gid_t_defšed


	)

30 #iâdeà
__uid_t_defšed


31 
__uid_t
 
	tuid_t
;

32 
	#__uid_t_defšed


	)

35 
__t_sÿÏr_t
 
	tt_sÿÏr_t
;

36 
__t_usÿÏr_t
 
	tt_usÿÏr_t
;

39 
	~<b™s/¡rİts.h
>

42 
__BEGIN_DECLS


45 
	$i§¡»am
 (
__fdes
è
__THROW
;

51 
	`g‘msg
 (
__fdes
, 
¡rbuf
 *
__»¡riù
 
__ùÍŒ
,

52 
¡rbuf
 *
__»¡riù
 
__d©­Œ
,

53 *
__»¡riù
 
__æag¥
);

60 
	`g‘pmsg
 (
__fdes
, 
¡rbuf
 *
__»¡riù
 
__ùÍŒ
,

61 
¡rbuf
 *
__»¡riù
 
__d©­Œ
,

62 *
__»¡riù
 
__bªdp
, *__»¡riù 
__æag¥
);

67 
	$ioùl
 (
__fd
, 
__»que¡
, ...è
__THROW
;

73 
	`putmsg
 (
__fdes
, cÚ¡ 
¡rbuf
 *
__ùÍŒ
,

74 cÚ¡ 
¡rbuf
 *
__d©­Œ
, 
__æags
);

80 
	`pumsg
 (
__fdes
, cÚ¡ 
¡rbuf
 *
__ùÍŒ
,

81 cÚ¡ 
¡rbuf
 *
__d©­Œ
, 
__bªd
, 
__æags
);

85 
	$ç‰ach
 (
__fdes
, cÚ¡ *
__·th
è
__THROW
;

88 
	$fd‘ach
 (cÚ¡ *
__·th
è
__THROW
;

90 
__END_DECLS


	@/usr/include/syslog.h

1 
	~<sys/sy¦og.h
>

	@/usr/include/termios.h

22 #iâdef 
_TERMIOS_H


23 
	#_TERMIOS_H
 1

	)

25 
	~<ã©u»s.h
>

26 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


28 
	~<b™s/ty³s.h
>

29 #iâdeà
__pid_t_defšed


30 
__pid_t
 
	tpid_t
;

31 
	#__pid_t_defšed


	)

35 
	g__BEGIN_DECLS


39 
	~<b™s/‹rmios.h
>

41 #ifdeà
__USE_MISC


44 
	#CCEQ
(
v®
, 
c
è((cè=ğ(v®è&& (v®è!ğ
_POSIX_VDISABLE
)

	)

48 
¥“d_t
 
	$cfg‘o¥“d
 (cÚ¡ 
‹rmios
 *
__‹rmios_p
è
__THROW
;

51 
¥“d_t
 
	$cfg‘i¥“d
 (cÚ¡ 
‹rmios
 *
__‹rmios_p
è
__THROW
;

54 
	$cf£to¥“d
 (
‹rmios
 *
__‹rmios_p
, 
¥“d_t
 
__¥“d
è
__THROW
;

57 
	$cf£ti¥“d
 (
‹rmios
 *
__‹rmios_p
, 
¥“d_t
 
__¥“d
è
__THROW
;

59 #ifdef 
__USE_MISC


61 
	$cf£t¥“d
 (
‹rmios
 *
__‹rmios_p
, 
¥“d_t
 
__¥“d
è
__THROW
;

66 
	$tcg‘©Œ
 (
__fd
, 
‹rmios
 *
__‹rmios_p
è
__THROW
;

70 
	$tc£‰r
 (
__fd
, 
__İtiÚ®_aùiÚs
,

71 cÚ¡ 
‹rmios
 *
__‹rmios_p
è
__THROW
;

74 #ifdef 
__USE_MISC


76 
	$cfmak”aw
 (
‹rmios
 *
__‹rmios_p
è
__THROW
;

80 
	$tc£ndb»ak
 (
__fd
, 
__du¿tiÚ
è
__THROW
;

86 
	`tcd¿š
 (
__fd
);

90 
	$tcæush
 (
__fd
, 
__queue_£ËùÜ
è
__THROW
;

94 
	$tcæow
 (
__fd
, 
__aùiÚ
è
__THROW
;

97 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


99 
__pid_t
 
	$tcg‘sid
 (
__fd
è
__THROW
;

103 #ifdeà
__USE_MISC


104 
	~<sys/‰ydeçuÉs.h
>

107 
__END_DECLS


	@/usr/include/time.h

22 #iâdef 
_TIME_H


24 #ià(! 
defšed
 
__Ãed_time_t
 && !defšed 
__Ãed_şock_t
 && \

25 ! 
defšed
 
	g__Ãed_time¥ec
)

26 
	#_TIME_H
 1

	)

27 
	~<ã©u»s.h
>

29 
	g__BEGIN_DECLS


33 #ifdef 
_TIME_H


35 
	#__Ãed_size_t


	)

36 
	#__Ãed_NULL


	)

37 
	~<¡ddef.h
>

41 
	~<b™s/time.h
>

44 #ià!
defšed
 
__STRICT_ANSI__
 && !defšed 
__USE_XOPEN2K


45 #iâdeà
CLK_TCK


46 
	#CLK_TCK
 
CLOCKS_PER_SEC


	)

52 #ià!
defšed
 
__şock_t_defšed
 && (defšed 
_TIME_H
 || defšed 
__Ãed_şock_t
)

53 
	#__şock_t_defšed
 1

	)

55 
	~<b™s/ty³s.h
>

57 
__BEGIN_NAMESPACE_STD


59 
__şock_t
 
	tşock_t
;

60 
	g__END_NAMESPACE_STD


61 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_POSIX


62 
	$__USING_NAMESPACE_STD
(
şock_t
)

66 #undeà
__Ãed_şock_t


68 #ià!
defšed
 
__time_t_defšed
 && (defšed 
_TIME_H
 || defšed 
__Ãed_time_t
)

69 
	#__time_t_defšed
 1

	)

71 
	~<b™s/ty³s.h
>

73 
__BEGIN_NAMESPACE_STD


75 
__time_t
 
	ttime_t
;

76 
__END_NAMESPACE_STD


77 #ifdeà
__USE_POSIX


78 
	$__USING_NAMESPACE_STD
(
time_t
)

82 #undeà
__Ãed_time_t


84 #ià!
defšed
 
__şockid_t_defšed
 && \

85 ((
defšed
 
_TIME_H
 && defšed 
__USE_POSIX199309
è|| defšed 
__Ãed_şockid_t
)

86 
	#__şockid_t_defšed
 1

	)

88 
	~<b™s/ty³s.h
>

91 
__şockid_t
 
	tşockid_t
;

94 #undeà
__şockid_time_t


96 #ià!
defšed
 
__tim”_t_defšed
 && \

97 ((
defšed
 
_TIME_H
 && defšed 
__USE_POSIX199309
è|| defšed 
__Ãed_tim”_t
)

98 
	#__tim”_t_defšed
 1

	)

100 
	~<b™s/ty³s.h
>

103 
__tim”_t
 
	ttim”_t
;

106 #undeà
__Ãed_tim”_t


109 #ià(!
defšed
 
__time¥ec_defšed
 \

110 && ((
defšed
 
_TIME_H
 \

111 && (
defšed
 
__USE_POSIX199309
 \

112 || 
defšed
 
__USE_ISOC11
)) \

113 || 
defšed
 
__Ãed_time¥ec
))

114 
	#__time¥ec_defšed
 1

	)

116 
	~<b™s/ty³s.h
>

120 
	stime¥ec


122 
__time_t
 
tv_£c
;

123 
__sysÿÎ_¦Úg_t
 
tv_n£c
;

127 #undeà
__Ãed_time¥ec


130 #ifdef 
_TIME_H


131 
__BEGIN_NAMESPACE_STD


133 
	stm


135 
tm_£c
;

136 
tm_mš
;

137 
tm_hour
;

138 
tm_mday
;

139 
tm_mÚ
;

140 
tm_y—r
;

141 
tm_wday
;

142 
tm_yday
;

143 
tm_isd¡
;

145 #ifdef 
__USE_MISC


146 
tm_gmtoff
;

147 cÚ¡ *
tm_zÚe
;

149 
__tm_gmtoff
;

150 cÚ¡ *
__tm_zÚe
;

153 
__END_NAMESPACE_STD


154 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_POSIX


155 
	$__USING_NAMESPACE_STD
(
tm
)

159 #ifdeà
__USE_POSIX199309


161 
	s™im”¥ec


163 
time¥ec
 
™_š‹rv®
;

164 
time¥ec
 
™_v®ue
;

168 
sigev’t
;

172 #ifdeà
__USE_XOPEN2K


173 #iâdeà
__pid_t_defšed


174 
__pid_t
 
	tpid_t
;

175 
	#__pid_t_defšed


	)

180 #ifdeà
__USE_ISOC11


182 
	#TIME_UTC
 1

	)

186 
__BEGIN_NAMESPACE_STD


189 
şock_t
 
	$şock
 (è
__THROW
;

192 
time_t
 
	$time
 (
time_t
 *
__tim”
è
__THROW
;

195 
	$difáime
 (
time_t
 
__time1
,ime_ˆ
__time0
)

196 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

199 
time_t
 
	$mktime
 (
tm
 *
__
è
__THROW
;

205 
size_t
 
	$¡ráime
 (*
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

206 cÚ¡ *
__»¡riù
 
__fÜm©
,

207 cÚ¡ 
tm
 *
__»¡riù
 
__
è
__THROW
;

208 
__END_NAMESPACE_STD


210 #ifdeà
__USE_XOPEN


213 *
	$¡½time
 (cÚ¡ *
__»¡riù
 
__s
,

214 cÚ¡ *
__»¡riù
 
__fmt
, 
tm
 *
__
)

215 
__THROW
;

218 #ifdeà
__USE_XOPEN2K8


221 
	~<xloÿË.h
>

223 
size_t
 
	$¡ráime_l
 (*
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

224 cÚ¡ *
__»¡riù
 
__fÜm©
,

225 cÚ¡ 
tm
 *
__»¡riù
 
__
,

226 
__loÿË_t
 
__loc
è
__THROW
;

229 #ifdeà
__USE_GNU


230 *
	$¡½time_l
 (cÚ¡ *
__»¡riù
 
__s
,

231 cÚ¡ *
__»¡riù
 
__fmt
, 
tm
 *
__
,

232 
__loÿË_t
 
__loc
è
__THROW
;

236 
__BEGIN_NAMESPACE_STD


239 
tm
 *
	$gmtime
 (cÚ¡ 
time_t
 *
__tim”
è
__THROW
;

243 
tm
 *
	$loÿÉime
 (cÚ¡ 
time_t
 *
__tim”
è
__THROW
;

244 
__END_NAMESPACE_STD


246 #ifdeà
__USE_POSIX


249 
tm
 *
	$gmtime_r
 (cÚ¡ 
time_t
 *
__»¡riù
 
__tim”
,

250 
tm
 *
__»¡riù
 
__
è
__THROW
;

254 
tm
 *
	$loÿÉime_r
 (cÚ¡ 
time_t
 *
__»¡riù
 
__tim”
,

255 
tm
 *
__»¡riù
 
__
è
__THROW
;

258 
__BEGIN_NAMESPACE_STD


261 *
	$asùime
 (cÚ¡ 
tm
 *
__
è
__THROW
;

264 *
	$ùime
 (cÚ¡ 
time_t
 *
__tim”
è
__THROW
;

265 
__END_NAMESPACE_STD


267 #ifdeà
__USE_POSIX


272 *
	$asùime_r
 (cÚ¡ 
tm
 *
__»¡riù
 
__
,

273 *
__»¡riù
 
__buf
è
__THROW
;

276 *
	$ùime_r
 (cÚ¡ 
time_t
 *
__»¡riù
 
__tim”
,

277 *
__»¡riù
 
__buf
è
__THROW
;

282 *
__tzÇme
[2];

283 
__daylight
;

284 
__timezÚe
;

287 #ifdef 
__USE_POSIX


289 *
tzÇme
[2];

293 
	$tz£t
 (è
__THROW
;

296 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


297 
daylight
;

298 
timezÚe
;

301 #ifdeà
__USE_MISC


304 
	$¡ime
 (cÚ¡ 
time_t
 *
__wh’
è
__THROW
;

310 
	#__i¦—p
(
y—r
) \

311 ((
y—r
è% 4 =ğ0 && ((y—rè% 100 !ğ0 || (y—rè% 400 =ğ0))

	)

314 #ifdeà
__USE_MISC


319 
time_t
 
	$timegm
 (
tm
 *
__
è
__THROW
;

322 
time_t
 
	$tim–oÿl
 (
tm
 *
__
è
__THROW
;

325 
	$dysize
 (
__y—r
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

329 #ifdeà
__USE_POSIX199309


334 
	`Çno¦“p
 (cÚ¡ 
time¥ec
 *
__»que¡ed_time
,

335 
time¥ec
 *
__»maššg
);

339 
	$şock_g‘»s
 (
şockid_t
 
__şock_id
, 
time¥ec
 *
__»s
è
__THROW
;

342 
	$şock_g‘time
 (
şockid_t
 
__şock_id
, 
time¥ec
 *
__
è
__THROW
;

345 
	$şock_£‰ime
 (
şockid_t
 
__şock_id
, cÚ¡ 
time¥ec
 *
__
)

346 
__THROW
;

348 #ifdeà
__USE_XOPEN2K


353 
	`şock_Çno¦“p
 (
şockid_t
 
__şock_id
, 
__æags
,

354 cÚ¡ 
time¥ec
 *
__»q
,

355 
time¥ec
 *
__»m
);

358 
	$şock_g‘ıuşockid
 (
pid_t
 
__pid
, 
şockid_t
 *
__şock_id
è
__THROW
;

363 
	$tim”_ü—‹
 (
şockid_t
 
__şock_id
,

364 
sigev’t
 *
__»¡riù
 
__evp
,

365 
tim”_t
 *
__»¡riù
 
__tim”id
è
__THROW
;

368 
	$tim”_d–‘e
 (
tim”_t
 
__tim”id
è
__THROW
;

371 
	$tim”_£‰ime
 (
tim”_t
 
__tim”id
, 
__æags
,

372 cÚ¡ 
™im”¥ec
 *
__»¡riù
 
__v®ue
,

373 
™im”¥ec
 *
__»¡riù
 
__ov®ue
è
__THROW
;

376 
	$tim”_g‘time
 (
tim”_t
 
__tim”id
, 
™im”¥ec
 *
__v®ue
)

377 
__THROW
;

380 
	$tim”_g‘ov”run
 (
tim”_t
 
__tim”id
è
__THROW
;

384 #ifdeà
__USE_ISOC11


386 
	$time¥ec_g‘
 (
time¥ec
 *
__ts
, 
__ba£
)

387 
__THROW
 
	`__nÚnuÎ
 ((1));

391 #ifdeà
__USE_XOPEN_EXTENDED


403 
g‘d©e_”r
;

412 
tm
 *
	`g‘d©e
 (cÚ¡ *
__¡ršg
);

415 #ifdeà
__USE_GNU


426 
	`g‘d©e_r
 (cÚ¡ *
__»¡riù
 
__¡ršg
,

427 
tm
 *
__»¡riù
 
__»sbuå
);

430 
__END_DECLS


	@/usr/include/ucontext.h

20 #iâdeà
_UCONTEXT_H


21 
	#_UCONTEXT_H
 1

	)

23 
	~<ã©u»s.h
>

26 
	~<sys/ucÚ‹xt.h
>

28 
__BEGIN_DECLS


31 
	$g‘cÚ‹xt
 (
ucÚ‹xt_t
 *
__uı
è
__THROWNL
;

34 
	$£tcÚ‹xt
 (cÚ¡ 
ucÚ‹xt_t
 *
__uı
è
__THROWNL
;

38 
	$sw­cÚ‹xt
 (
ucÚ‹xt_t
 *
__»¡riù
 
__ouı
,

39 cÚ¡ 
ucÚ‹xt_t
 *
__»¡riù
 
__uı
è
__THROWNL
;

47 
	$makecÚ‹xt
 (
ucÚ‹xt_t
 *
__uı
, (*
__func
) (),

48 
__¬gc
, ...è
__THROW
;

50 
__END_DECLS


	@/usr/include/unistd.h

22 #iâdef 
_UNISTD_H


23 
	#_UNISTD_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	g__BEGIN_DECLS


32 #ifdeà
__USE_XOPEN2K8


34 
	#_POSIX_VERSION
 200809L

	)

35 #–ià
defšed
 
__USE_XOPEN2K


37 
	#_POSIX_VERSION
 200112L

	)

38 #–ià
defšed
 
__USE_POSIX199506


40 
	#_POSIX_VERSION
 199506L

	)

41 #–ià
defšed
 
__USE_POSIX199309


43 
	#_POSIX_VERSION
 199309L

	)

46 
	#_POSIX_VERSION
 199009L

	)

52 #ifdeà
__USE_XOPEN2K8


53 
	#__POSIX2_THIS_VERSION
 200809L

	)

55 #–ià
defšed
 
__USE_XOPEN2K


57 
	#__POSIX2_THIS_VERSION
 200112L

	)

58 #–ià
defšed
 
__USE_POSIX199506


60 
	#__POSIX2_THIS_VERSION
 199506L

	)

63 
	#__POSIX2_THIS_VERSION
 199209L

	)

67 
	#_POSIX2_VERSION
 
__POSIX2_THIS_VERSION


	)

70 
	#_POSIX2_C_VERSION
 
__POSIX2_THIS_VERSION


	)

74 
	#_POSIX2_C_BIND
 
__POSIX2_THIS_VERSION


	)

78 
	#_POSIX2_C_DEV
 
__POSIX2_THIS_VERSION


	)

82 
	#_POSIX2_SW_DEV
 
__POSIX2_THIS_VERSION


	)

86 
	#_POSIX2_LOCALEDEF
 
__POSIX2_THIS_VERSION


	)

89 #ifdeà
__USE_XOPEN2K8


90 
	#_XOPEN_VERSION
 700

	)

91 #–ià
defšed
 
__USE_XOPEN2K


92 
	#_XOPEN_VERSION
 600

	)

93 #–ià
defšed
 
__USE_UNIX98


94 
	#_XOPEN_VERSION
 500

	)

96 
	#_XOPEN_VERSION
 4

	)

100 
	#_XOPEN_XCU_VERSION
 4

	)

103 
	#_XOPEN_XPG2
 1

	)

104 
	#_XOPEN_XPG3
 1

	)

105 
	#_XOPEN_XPG4
 1

	)

108 
	#_XOPEN_UNIX
 1

	)

111 
	#_XOPEN_CRYPT
 1

	)

115 
	#_XOPEN_ENH_I18N
 1

	)

118 
	#_XOPEN_LEGACY
 1

	)

205 
	~<b™s/posix_İt.h
>

208 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


209 
	~<b™s/’vœÚm’ts.h
>

213 
	#STDIN_FILENO
 0

	)

214 
	#STDOUT_FILENO
 1

	)

215 
	#STDERR_FILENO
 2

	)

220 
	~<b™s/ty³s.h
>

222 #iâdef 
__ssize_t_defšed


223 
__ssize_t
 
	tssize_t
;

224 
	#__ssize_t_defšed


	)

227 
	#__Ãed_size_t


	)

228 
	#__Ãed_NULL


	)

229 
	~<¡ddef.h
>

231 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K


234 #iâdeà
__gid_t_defšed


235 
__gid_t
 
	tgid_t
;

236 
	#__gid_t_defšed


	)

239 #iâdeà
__uid_t_defšed


240 
__uid_t
 
	tuid_t
;

241 
	#__uid_t_defšed


	)

244 #iâdeà
__off_t_defšed


245 #iâdeà
__USE_FILE_OFFSET64


246 
__off_t
 
	toff_t
;

248 
__off64_t
 
	toff_t
;

250 
	#__off_t_defšed


	)

252 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__off64_t_defšed


253 
__off64_t
 
	toff64_t
;

254 
	#__off64_t_defšed


	)

257 #iâdeà
__u£cÚds_t_defšed


258 
__u£cÚds_t
 
	tu£cÚds_t
;

259 
	#__u£cÚds_t_defšed


	)

262 #iâdeà
__pid_t_defšed


263 
__pid_t
 
	tpid_t
;

264 
	#__pid_t_defšed


	)

268 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


269 #iâdeà
__šŒ_t_defšed


270 
__šŒ_t
 
	tšŒ_t
;

271 
	#__šŒ_t_defšed


	)

275 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


276 #iâdeà
__sockËn_t_defšed


277 
__sockËn_t
 
	tsockËn_t
;

278 
	#__sockËn_t_defšed


	)

284 
	#R_OK
 4

	)

285 
	#W_OK
 2

	)

286 
	#X_OK
 1

	)

287 
	#F_OK
 0

	)

290 
	$acûss
 (cÚ¡ *
__Çme
, 
__ty³
è
__THROW
 
	`__nÚnuÎ
 ((1));

292 #ifdeà
__USE_GNU


295 
	$euidacûss
 (cÚ¡ *
__Çme
, 
__ty³
)

296 
__THROW
 
	`__nÚnuÎ
 ((1));

299 
	$—cûss
 (cÚ¡ *
__Çme
, 
__ty³
)

300 
__THROW
 
	`__nÚnuÎ
 ((1));

303 #ifdeà
__USE_ATFILE


307 
	$çcûs§t
 (
__fd
, cÚ¡ *
__fe
, 
__ty³
, 
__æag
)

308 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

313 #iâdef 
_STDIO_H


314 
	#SEEK_SET
 0

	)

315 
	#SEEK_CUR
 1

	)

316 
	#SEEK_END
 2

	)

317 #ifdeà
__USE_GNU


318 
	#SEEK_DATA
 3

	)

319 
	#SEEK_HOLE
 4

	)

323 #ià
defšed
 
__USE_MISC
 && !defšed 
L_SET


325 
	#L_SET
 
SEEK_SET


	)

326 
	#L_INCR
 
SEEK_CUR


	)

327 
	#L_XTND
 
SEEK_END


	)

336 #iâdeà
__USE_FILE_OFFSET64


337 
__off_t
 
	$l£ek
 (
__fd
, 
__off_t
 
__off£t
, 
__wh’û
è
__THROW
;

339 #ifdeà
__REDIRECT_NTH


340 
__off64_t
 
	`__REDIRECT_NTH
 (
l£ek
,

341 (
__fd
, 
__off64_t
 
__off£t
, 
__wh’û
),

342 
l£ek64
);

344 
	#l£ek
 
l£ek64


	)

347 #ifdeà
__USE_LARGEFILE64


348 
__off64_t
 
	$l£ek64
 (
__fd
, 
__off64_t
 
__off£t
, 
__wh’û
)

349 
__THROW
;

356 
	`şo£
 (
__fd
);

363 
ssize_t
 
	$»ad
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
è
__wur
;

369 
ssize_t
 
	$wr™e
 (
__fd
, cÚ¡ *
__buf
, 
size_t
 
__n
è
__wur
;

371 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


372 #iâdeà
__USE_FILE_OFFSET64


379 
ssize_t
 
	$´—d
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

380 
__off_t
 
__off£t
è
__wur
;

387 
ssize_t
 
	$pwr™e
 (
__fd
, cÚ¡ *
__buf
, 
size_t
 
__n
,

388 
__off_t
 
__off£t
è
__wur
;

390 #ifdeà
__REDIRECT


391 
ssize_t
 
	`__REDIRECT
 (
´—d
, (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

392 
__off64_t
 
__off£t
),

393 
´—d64
è
__wur
;

394 
ssize_t
 
	`__REDIRECT
 (
pwr™e
, (
__fd
, cÚ¡ *
__buf
,

395 
size_t
 
__nby‹s
, 
__off64_t
 
__off£t
),

396 
pwr™e64
è
__wur
;

398 
	#´—d
 
´—d64


	)

399 
	#pwr™e
 
pwr™e64


	)

403 #ifdeà
__USE_LARGEFILE64


407 
ssize_t
 
	$´—d64
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

408 
__off64_t
 
__off£t
è
__wur
;

411 
ssize_t
 
	$pwr™e64
 (
__fd
, cÚ¡ *
__buf
, 
size_t
 
__n
,

412 
__off64_t
 
__off£t
è
__wur
;

420 
	$pe
 (
__pedes
[2]è
__THROW
 
__wur
;

422 #ifdeà
__USE_GNU


425 
	$pe2
 (
__pedes
[2], 
__æags
è
__THROW
 
__wur
;

435 
	$®¬m
 (
__£cÚds
è
__THROW
;

447 
	`¦“p
 (
__£cÚds
);

449 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

450 || 
defšed
 
__USE_MISC


455 
__u£cÚds_t
 
	$u®¬m
 (
__u£cÚds_t
 
__v®ue
, __u£cÚds_ˆ
__š‹rv®
)

456 
__THROW
;

463 
	`u¦“p
 (
__u£cÚds_t
 
__u£cÚds
);

472 
	`·u£
 ();

476 
	$chown
 (cÚ¡ *
__fe
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
)

477 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

479 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


481 
	$fchown
 (
__fd
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
è
__THROW
 
__wur
;

486 
	$lchown
 (cÚ¡ *
__fe
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
)

487 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

491 #ifdeà
__USE_ATFILE


494 
	$fchowÇt
 (
__fd
, cÚ¡ *
__fe
, 
__uid_t
 
__owÃr
,

495 
__gid_t
 
__group
, 
__æag
)

496 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

500 
	$chdœ
 (cÚ¡ *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

502 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


504 
	$fchdœ
 (
__fd
è
__THROW
 
__wur
;

514 *
	$g‘cwd
 (*
__buf
, 
size_t
 
__size
è
__THROW
 
__wur
;

516 #ifdef 
__USE_GNU


520 *
	$g‘_cu¼’t_dœ_Çme
 (è
__THROW
;

523 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

524 || 
defšed
 
__USE_MISC


528 *
	$g‘wd
 (*
__buf
)

529 
__THROW
 
	`__nÚnuÎ
 ((1)è
__©Œibu‹_d•»ÿ‹d__
 
__wur
;

534 
	$dup
 (
__fd
è
__THROW
 
__wur
;

537 
	$dup2
 (
__fd
, 
__fd2
è
__THROW
;

539 #ifdeà
__USE_GNU


542 
	$dup3
 (
__fd
, 
__fd2
, 
__æags
è
__THROW
;

546 **
__’vœÚ
;

547 #ifdeà
__USE_GNU


548 **
’vœÚ
;

554 
	$execve
 (cÚ¡ *
__·th
, *cÚ¡ 
__¬gv
[],

555 *cÚ¡ 
__’vp
[]è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

557 #ifdeà
__USE_XOPEN2K8


560 
	$ãxecve
 (
__fd
, *cÚ¡ 
__¬gv
[], *cÚ¡ 
__’vp
[])

561 
__THROW
 
	`__nÚnuÎ
 ((2));

566 
	$execv
 (cÚ¡ *
__·th
, *cÚ¡ 
__¬gv
[])

567 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

571 
	$exeşe
 (cÚ¡ *
__·th
, cÚ¡ *
__¬g
, ...)

572 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

576 
	$exeş
 (cÚ¡ *
__·th
, cÚ¡ *
__¬g
, ...)

577 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

581 
	$execvp
 (cÚ¡ *
__fe
, *cÚ¡ 
__¬gv
[])

582 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

587 
	$exeşp
 (cÚ¡ *
__fe
, cÚ¡ *
__¬g
, ...)

588 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

590 #ifdeà
__USE_GNU


593 
	$execv³
 (cÚ¡ *
__fe
, *cÚ¡ 
__¬gv
[],

594 *cÚ¡ 
__’vp
[])

595 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

599 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


601 
	$niû
 (
__šc
è
__THROW
 
__wur
;

606 
	$_ex™
 (
__¡©us
è
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

612 
	~<b™s/cÚâame.h
>

615 
	$·thcÚf
 (cÚ¡ *
__·th
, 
__Çme
)

616 
__THROW
 
	`__nÚnuÎ
 ((1));

619 
	$å©hcÚf
 (
__fd
, 
__Çme
è
__THROW
;

622 
	$syscÚf
 (
__Çme
è
__THROW
;

624 #ifdef 
__USE_POSIX2


626 
size_t
 
	$cÚf¡r
 (
__Çme
, *
__buf
, 
size_t
 
__Ën
è
__THROW
;

631 
__pid_t
 
	$g‘pid
 (è
__THROW
;

634 
__pid_t
 
	$g‘µid
 (è
__THROW
;

637 
__pid_t
 
	$g‘pg½
 (è
__THROW
;

640 
__pid_t
 
	$__g‘pgid
 (
__pid_t
 
__pid
è
__THROW
;

641 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


642 
__pid_t
 
	$g‘pgid
 (
__pid_t
 
__pid
è
__THROW
;

649 
	$£gid
 (
__pid_t
 
__pid
, __pid_ˆ
__pgid
è
__THROW
;

651 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


663 
	$£g½
 (è
__THROW
;

670 
__pid_t
 
	$£tsid
 (è
__THROW
;

672 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


674 
__pid_t
 
	$g‘sid
 (
__pid_t
 
__pid
è
__THROW
;

678 
__uid_t
 
	$g‘uid
 (è
__THROW
;

681 
__uid_t
 
	$g‘euid
 (è
__THROW
;

684 
__gid_t
 
	$g‘gid
 (è
__THROW
;

687 
__gid_t
 
	$g‘egid
 (è
__THROW
;

692 
	$g‘groups
 (
__size
, 
__gid_t
 
__li¡
[]è
__THROW
 
__wur
;

694 #ifdef 
__USE_GNU


696 
	$group_memb”
 (
__gid_t
 
__gid
è
__THROW
;

703 
	$£tuid
 (
__uid_t
 
__uid
è
__THROW
 
__wur
;

705 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


708 
	$£Œeuid
 (
__uid_t
 
__ruid
, __uid_ˆ
__euid
è
__THROW
 
__wur
;

711 #ifdeà
__USE_XOPEN2K


713 
	$£‹uid
 (
__uid_t
 
__uid
è
__THROW
 
__wur
;

720 
	$£tgid
 (
__gid_t
 
__gid
è
__THROW
 
__wur
;

722 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


725 
	$£Œegid
 (
__gid_t
 
__rgid
, __gid_ˆ
__egid
è
__THROW
 
__wur
;

728 #ifdeà
__USE_XOPEN2K


730 
	$£‹gid
 (
__gid_t
 
__gid
è
__THROW
 
__wur
;

733 #ifdeà
__USE_GNU


736 
	$g‘»suid
 (
__uid_t
 *
__ruid
, __uid_ˆ*
__euid
, __uid_ˆ*
__suid
)

737 
__THROW
;

741 
	$g‘»sgid
 (
__gid_t
 *
__rgid
, __gid_ˆ*
__egid
, __gid_ˆ*
__sgid
)

742 
__THROW
;

746 
	$£Œesuid
 (
__uid_t
 
__ruid
, __uid_ˆ
__euid
, __uid_ˆ
__suid
)

747 
__THROW
 
__wur
;

751 
	$£Œesgid
 (
__gid_t
 
__rgid
, __gid_ˆ
__egid
, __gid_ˆ
__sgid
)

752 
__THROW
 
__wur
;

759 
__pid_t
 
	$fÜk
 (è
__THROWNL
;

761 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

762 || 
defšed
 
__USE_MISC


767 
__pid_t
 
	$vfÜk
 (è
__THROW
;

773 *
	$‰yÇme
 (
__fd
è
__THROW
;

777 
	$‰yÇme_r
 (
__fd
, *
__buf
, 
size_t
 
__buæ’
)

778 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

782 
	$i§‰y
 (
__fd
è
__THROW
;

784 #ià
defšed
 
__USE_MISC
 \

785 || (
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_UNIX98
)

788 
	$‰y¦Ù
 (è
__THROW
;

793 
	$lšk
 (cÚ¡ *
__äom
, cÚ¡ *
__to
)

794 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

796 #ifdeà
__USE_ATFILE


799 
	$lšk©
 (
__äomfd
, cÚ¡ *
__äom
, 
__tofd
,

800 cÚ¡ *
__to
, 
__æags
)

801 
__THROW
 
	`__nÚnuÎ
 ((2, 4)è
__wur
;

804 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


806 
	$symlšk
 (cÚ¡ *
__äom
, cÚ¡ *
__to
)

807 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

812 
ssize_t
 
	$»adlšk
 (cÚ¡ *
__»¡riù
 
__·th
,

813 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

814 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

817 #ifdeà
__USE_ATFILE


819 
	$symlšk©
 (cÚ¡ *
__äom
, 
__tofd
,

820 cÚ¡ *
__to
è
__THROW
 
	`__nÚnuÎ
 ((1, 3)è
__wur
;

823 
ssize_t
 
	$»adlšk©
 (
__fd
, cÚ¡ *
__»¡riù
 
__·th
,

824 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

825 
__THROW
 
	`__nÚnuÎ
 ((2, 3)è
__wur
;

829 
	$uÆšk
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

831 #ifdeà
__USE_ATFILE


833 
	$uÆšk©
 (
__fd
, cÚ¡ *
__Çme
, 
__æag
)

834 
__THROW
 
	`__nÚnuÎ
 ((2));

838 
	$rmdœ
 (cÚ¡ *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1));

842 
__pid_t
 
	$tcg‘pg½
 (
__fd
è
__THROW
;

845 
	$tc£g½
 (
__fd
, 
__pid_t
 
__pg½_id
è
__THROW
;

852 *
	`g‘logš
 ();

853 #ià
defšed
 
__USE_REENTRANT
 || defšed 
__USE_POSIX199506


860 
	$g‘logš_r
 (*
__Çme
, 
size_t
 
__Çme_Ën
è
	`__nÚnuÎ
 ((1));

863 #ifdef 
__USE_MISC


865 
	$£ogš
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

869 #ifdef 
__USE_POSIX2


873 
	#__Ãed_g‘İt


	)

874 
	~<g‘İt.h
>

878 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


882 
	$g‘ho¡Çme
 (*
__Çme
, 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((1));

886 #ià
defšed
 
__USE_MISC


889 
	$£tho¡Çme
 (cÚ¡ *
__Çme
, 
size_t
 
__Ën
)

890 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

894 
	$£tho¡id
 (
__id
è
__THROW
 
__wur
;

900 
	$g‘domašÇme
 (*
__Çme
, 
size_t
 
__Ën
)

901 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

902 
	$£tdomašÇme
 (cÚ¡ *
__Çme
, 
size_t
 
__Ën
)

903 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

909 
	$vhªgup
 (è
__THROW
;

912 
	$»voke
 (cÚ¡ *
__fe
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

920 
	$´of
 (*
__§m¶e_bufãr
, 
size_t
 
__size
,

921 
size_t
 
__off£t
, 
__sÿË
)

922 
__THROW
 
	`__nÚnuÎ
 ((1));

928 
	$acù
 (cÚ¡ *
__Çme
è
__THROW
;

932 *
	$g‘u£rsh–l
 (è
__THROW
;

933 
	$’du£rsh–l
 (è
__THROW
;

934 
	$£tu£rsh–l
 (è
__THROW
;

940 
	$d«mÚ
 (
__nochdœ
, 
__noşo£
è
__THROW
 
__wur
;

944 #ià
defšed
 
__USE_MISC
 || (defšed 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
)

947 
	$chroÙ
 (cÚ¡ *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

951 *
	$g‘·ss
 (cÚ¡ *
__´om±
è
	`__nÚnuÎ
 ((1));

959 
	`fsync
 (
__fd
);

962 #ifdeà
__USE_GNU


965 
	$syncfs
 (
__fd
è
__THROW
;

969 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


972 
	`g‘ho¡id
 ();

975 
	$sync
 (è
__THROW
;

978 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K


981 
	$g‘·gesize
 (è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

986 
	$g‘dbËsize
 (è
__THROW
;

992 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


995 #iâdeà
__USE_FILE_OFFSET64


996 
	$Œunÿ‹
 (cÚ¡ *
__fe
, 
__off_t
 
__Ëngth
)

997 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

999 #ifdeà
__REDIRECT_NTH


1000 
	`__REDIRECT_NTH
 (
Œunÿ‹
,

1001 (cÚ¡ *
__fe
, 
__off64_t
 
__Ëngth
),

1002 
Œunÿ‹64
è
	`__nÚnuÎ
 ((1)è
__wur
;

1004 
	#Œunÿ‹
 
Œunÿ‹64


	)

1007 #ifdeà
__USE_LARGEFILE64


1008 
	$Œunÿ‹64
 (cÚ¡ *
__fe
, 
__off64_t
 
__Ëngth
)

1009 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

1014 #ià
defšed
 
__USE_POSIX199309
 \

1015 || 
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


1018 #iâdeà
__USE_FILE_OFFSET64


1019 
	$árunÿ‹
 (
__fd
, 
__off_t
 
__Ëngth
è
__THROW
 
__wur
;

1021 #ifdeà
__REDIRECT_NTH


1022 
	`__REDIRECT_NTH
 (
árunÿ‹
, (
__fd
, 
__off64_t
 
__Ëngth
),

1023 
árunÿ‹64
è
__wur
;

1025 
	#árunÿ‹
 
árunÿ‹64


	)

1028 #ifdeà
__USE_LARGEFILE64


1029 
	$árunÿ‹64
 (
__fd
, 
__off64_t
 
__Ëngth
è
__THROW
 
__wur
;

1035 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K
) \

1036 || 
defšed
 
__USE_MISC


1040 
	$brk
 (*
__addr
è
__THROW
 
__wur
;

1046 *
	$sbrk
 (
šŒ_t
 
__d–
è
__THROW
;

1050 #ifdeà
__USE_MISC


1061 
	$sysÿÎ
 (
__sy¢o
, ...è
__THROW
;

1066 #ià(
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED
è&& !defšed 
F_LOCK


1078 
	#F_ULOCK
 0

	)

1079 
	#F_LOCK
 1

	)

1080 
	#F_TLOCK
 2

	)

1081 
	#F_TEST
 3

	)

1083 #iâdeà
__USE_FILE_OFFSET64


1084 
	$lockf
 (
__fd
, 
__cmd
, 
__off_t
 
__Ën
è
__wur
;

1086 #ifdeà
__REDIRECT


1087 
	`__REDIRECT
 (
lockf
, (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
),

1088 
lockf64
è
__wur
;

1090 
	#lockf
 
lockf64


	)

1093 #ifdeà
__USE_LARGEFILE64


1094 
	$lockf64
 (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
è
__wur
;

1099 #ifdeà
__USE_GNU


1104 
	#TEMP_FAILURE_RETRY
(
ex´essiÚ
) \

1105 (
__ex‹nsiÚ__
 \

1106 ({ 
__»suÉ
; \

1107 dØ
__»suÉ
 = (è(
ex´essiÚ
); \

1108 
__»suÉ
 =ğ-1L && 
”ºo
 =ğ
EINTR
); \

1109 
__»suÉ
; 
	}
}))

	)

1112 #ià
defšed
 
__USE_POSIX199309
 || defšed 
__USE_UNIX98


1115 
fd©async
 (
__fdes
);

1121 #ifdef 
__USE_XOPEN


1123 *
	$üy±
 (cÚ¡ *
__key
, cÚ¡ *
__§É
)

1124 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1128 
	$’üy±
 (*
__glibc_block
, 
__edæag
)

1129 
__THROW
 
	`__nÚnuÎ
 ((1));

1136 
	$swab
 (cÚ¡ *
__»¡riù
 
__äom
, *__»¡riù 
__to
,

1137 
ssize_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1143 #ià
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K


1145 *
	$ù”mid
 (*
__s
è
__THROW
;

1150 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


1151 
	~<b™s/uni¡d.h
>

1154 
__END_DECLS


	@/usr/include/alloca.h

18 #iâdef 
_ALLOCA_H


19 
	#_ALLOCA_H
 1

	)

21 
	~<ã©u»s.h
>

23 
	#__Ãed_size_t


	)

24 
	~<¡ddef.h
>

26 
	g__BEGIN_DECLS


29 #undeà
®loÿ


32 *
	$®loÿ
 (
size_t
 
__size
è
__THROW
;

34 #ifdef 
__GNUC__


35 
	#®loÿ
(
size
è
	`__butš_®loÿ
 (size)

	)

38 
__END_DECLS


	@/usr/include/getopt.h

19 #iâdeà
_GETOPT_H


21 #iâdeà
__Ãed_g‘İt


22 
	#_GETOPT_H
 1

	)

32 #ià!
defšed
 
__GNU_LIBRARY__


33 
	~<ùy³.h
>

36 #iâdeà
__THROW


37 #iâdeà
__GNUC_PREREQ


38 
	#__GNUC_PREREQ
(
maj
, 
mš
è(0)

	)

40 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (2,8)

41 
	#__THROW
 
	`throw
 ()

	)

43 
	#__THROW


	)

47 #ifdef 
__ılu¥lus


57 *
İrg
;

71 
İtšd
;

76 
İ‹¼
;

80 
İtİt
;

82 #iâdeà
__Ãed_g‘İt


104 
	sİtiÚ


106 cÚ¡ *
	gÇme
;

109 
	ghas_¬g
;

110 *
	gæag
;

111 
	gv®
;

116 
	#no_¬gum’t
 0

	)

117 
	#»quœed_¬gum’t
 1

	)

118 
	#İtiÚ®_¬gum’t
 2

	)

146 #ifdeà
__GNU_LIBRARY__


150 
g‘İt
 (
___¬gc
, *cÚ¡ *
___¬gv
, cÚ¡ *
__shÜtİts
)

151 
__THROW
;

153 #ià
defšed
 
__Ãed_g‘İt
 && defšed 
__USE_POSIX2
 \

154 && !
defšed
 
	g__USE_POSIX_IMPLICITLY
 && !defšed 
	g__USE_GNU


158 #ifdeà
__REDIRECT


159 
__REDIRECT_NTH
 (
g‘İt
, (
___¬gc
, *cÚ¡ *
___¬gv
,

160 cÚ¡ *
__shÜtİts
),

161 
__posix_g‘İt
);

163 
__posix_g‘İt
 (
___¬gc
, *cÚ¡ *
___¬gv
,

164 cÚ¡ *
__shÜtİts
è
__THROW
;

165 
	#g‘İt
 
__posix_g‘İt


	)

169 
g‘İt
 ();

172 #iâdeà
__Ãed_g‘İt


173 
g‘İt_lÚg
 (
___¬gc
, *cÚ¡ *
___¬gv
,

174 cÚ¡ *
__shÜtİts
,

175 cÚ¡ 
İtiÚ
 *
__lÚgİts
, *
__lÚgšd
)

176 
__THROW
;

177 
g‘İt_lÚg_Úly
 (
___¬gc
, *cÚ¡ *
___¬gv
,

178 cÚ¡ *
__shÜtİts
,

179 cÚ¡ 
İtiÚ
 *
__lÚgİts
, *
__lÚgšd
)

180 
__THROW
;

184 #ifdef 
__ılu¥lus


189 #undeà
__Ãed_g‘İt


	@/usr/include/libio.h

28 #iâdeà
_IO_STDIO_H


29 
	#_IO_STDIO_H


	)

31 
	~<_G_cÚfig.h
>

33 
	#_IO_åos_t
 
_G_åos_t


	)

34 
	#_IO_åos64_t
 
_G_åos64_t


	)

35 
	#_IO_size_t
 
size_t


	)

36 
	#_IO_ssize_t
 
__ssize_t


	)

37 
	#_IO_off_t
 
__off_t


	)

38 
	#_IO_off64_t
 
__off64_t


	)

39 
	#_IO_pid_t
 
__pid_t


	)

40 
	#_IO_uid_t
 
__uid_t


	)

41 
	#_IO_icÚv_t
 
_G_icÚv_t


	)

42 
	#_IO_HAVE_ST_BLKSIZE
 
_G_HAVE_ST_BLKSIZE


	)

43 
	#_IO_BUFSIZ
 
_G_BUFSIZ


	)

44 
	#_IO_va_li¡
 
_G_va_li¡


	)

45 
	#_IO_wšt_t
 
wšt_t


	)

48 
	#__Ãed___va_li¡


	)

49 
	~<¡d¬g.h
>

50 #ifdeà
__GNUC_VA_LIST


51 #undeà
_IO_va_li¡


52 
	#_IO_va_li¡
 
__gnuc_va_li¡


	)

55 #iâdeà
__P


56 
	~<sys/cdefs.h
>

59 
	#_IO_UNIFIED_JUMPTABLES
 1

	)

61 #iâdeà
EOF


62 
	#EOF
 (-1)

	)

64 #iâdeà
NULL


65 #ià
defšed
 
__GNUG__
 && \

66 (
	g__GNUC__
 > 2 || (__GNUC__ =ğ2 && 
__GNUC_MINOR__
 >= 8))

67 
	#NULL
 (
__nuÎ
)

	)

69 #ià!
defšed
(
__ılu¥lus
)

70 
	#NULL
 ((*)0)

	)

72 
	#NULL
 (0)

	)

77 
	#_IOS_INPUT
 1

	)

78 
	#_IOS_OUTPUT
 2

	)

79 
	#_IOS_ATEND
 4

	)

80 
	#_IOS_APPEND
 8

	)

81 
	#_IOS_TRUNC
 16

	)

82 
	#_IOS_NOCREATE
 32

	)

83 
	#_IOS_NOREPLACE
 64

	)

84 
	#_IOS_BIN
 128

	)

92 
	#_IO_MAGIC
 0xFBAD0000

	)

93 
	#_OLD_STDIO_MAGIC
 0xFABC0000

	)

94 
	#_IO_MAGIC_MASK
 0xFFFF0000

	)

95 
	#_IO_USER_BUF
 1

	)

96 
	#_IO_UNBUFFERED
 2

	)

97 
	#_IO_NO_READS
 4

	)

98 
	#_IO_NO_WRITES
 8

	)

99 
	#_IO_EOF_SEEN
 0x10

	)

100 
	#_IO_ERR_SEEN
 0x20

	)

101 
	#_IO_DELETE_DONT_CLOSE
 0x40

	)

102 
	#_IO_LINKED
 0x80

	)

103 
	#_IO_IN_BACKUP
 0x100

	)

104 
	#_IO_LINE_BUF
 0x200

	)

105 
	#_IO_TIED_PUT_GET
 0x400

	)

106 
	#_IO_CURRENTLY_PUTTING
 0x800

	)

107 
	#_IO_IS_APPENDING
 0x1000

	)

108 
	#_IO_IS_FILEBUF
 0x2000

	)

109 
	#_IO_BAD_SEEN
 0x4000

	)

110 
	#_IO_USER_LOCK
 0x8000

	)

112 
	#_IO_FLAGS2_MMAP
 1

	)

113 
	#_IO_FLAGS2_NOTCANCEL
 2

	)

114 #ifdeà
_LIBC


115 
	#_IO_FLAGS2_FORTIFY
 4

	)

117 
	#_IO_FLAGS2_USER_WBUF
 8

	)

118 #ifdeà
_LIBC


119 
	#_IO_FLAGS2_SCANF_STD
 16

	)

120 
	#_IO_FLAGS2_NOCLOSE
 32

	)

121 
	#_IO_FLAGS2_CLOEXEC
 64

	)

125 
	#_IO_SKIPWS
 01

	)

126 
	#_IO_LEFT
 02

	)

127 
	#_IO_RIGHT
 04

	)

128 
	#_IO_INTERNAL
 010

	)

129 
	#_IO_DEC
 020

	)

130 
	#_IO_OCT
 040

	)

131 
	#_IO_HEX
 0100

	)

132 
	#_IO_SHOWBASE
 0200

	)

133 
	#_IO_SHOWPOINT
 0400

	)

134 
	#_IO_UPPERCASE
 01000

	)

135 
	#_IO_SHOWPOS
 02000

	)

136 
	#_IO_SCIENTIFIC
 04000

	)

137 
	#_IO_FIXED
 010000

	)

138 
	#_IO_UNITBUF
 020000

	)

139 
	#_IO_STDIO
 040000

	)

140 
	#_IO_DONT_CLOSE
 0100000

	)

141 
	#_IO_BOOLALPHA
 0200000

	)

144 
_IO_jump_t
; 
	g_IO_FILE
;

147 #ifdeà
_IO_MTSAFE_IO


150 
	t_IO_lock_t
;

156 
	s_IO_m¬k”
 {

157 
_IO_m¬k”
 *
	m_Ãxt
;

158 
_IO_FILE
 *
	m_sbuf
;

162 
	m_pos
;

164 
£t_¡»ampos
(
¡»ampos
 
¥
è{ 
	m_¥os
 = sp; }

165 
£t_off£t
(
off£t
è{ 
	m_pos
 = off£t; 
	m_¥os
 = (
¡»ampos
)(-2); }

166 
	mpublic
:

167 
¡»amm¬k”
(
¡»ambuf
 *
sb
);

168 ~
¡»amm¬k”
();

169 
§všg
(è{  
	m_¥os
 == -2; }

170 
d–
(
¡»amm¬k”
&);

171 
d–
();

176 
	e__codecvt_»suÉ


178 
	m__codecvt_ok
,

179 
	m__codecvt_·¹Ÿl
,

180 
	m__codecvt_”rÜ
,

181 
	m__codecvt_nocÚv


184 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


187 
	s_IO_codecvt


189 (*
	m__codecvt_de¡r
è(
	m_IO_codecvt
 *);

190 
__codecvt_»suÉ
 (*
__codecvt_do_out
è(
	m_IO_codecvt
 *,

191 
	m__mb¡©e_t
 *,

192 cÚ¡ 
	mwch¬_t
 *,

193 cÚ¡ 
	mwch¬_t
 *,

194 cÚ¡ 
	mwch¬_t
 **, *,

196 
__codecvt_»suÉ
 (*
__codecvt_do_unshiá
è(
	m_IO_codecvt
 *,

197 
	m__mb¡©e_t
 *, *,

199 
__codecvt_»suÉ
 (*
__codecvt_do_š
è(
	m_IO_codecvt
 *,

200 
	m__mb¡©e_t
 *,

202 cÚ¡ **, 
	mwch¬_t
 *,

203 
	mwch¬_t
 *, wchar_t **);

204 (*
	m__codecvt_do_’codšg
è(
	m_IO_codecvt
 *);

205 (*
	m__codecvt_do_®ways_nocÚv
è(
	m_IO_codecvt
 *);

206 (*
	m__codecvt_do_Ëngth
è(
	m_IO_codecvt
 *, 
	m__mb¡©e_t
 *,

207 cÚ¡ *, cÚ¡ *, 
	m_IO_size_t
);

208 (*
	m__codecvt_do_max_Ëngth
è(
	m_IO_codecvt
 *);

210 
_IO_icÚv_t
 
	m__cd_š
;

211 
_IO_icÚv_t
 
	m__cd_out
;

215 
	s_IO_wide_d©a


217 
wch¬_t
 *
	m_IO_»ad_±r
;

218 
wch¬_t
 *
	m_IO_»ad_’d
;

219 
wch¬_t
 *
	m_IO_»ad_ba£
;

220 
wch¬_t
 *
	m_IO_wr™e_ba£
;

221 
wch¬_t
 *
	m_IO_wr™e_±r
;

222 
wch¬_t
 *
	m_IO_wr™e_’d
;

223 
wch¬_t
 *
	m_IO_buf_ba£
;

224 
wch¬_t
 *
	m_IO_buf_’d
;

226 
wch¬_t
 *
	m_IO_§ve_ba£
;

227 
wch¬_t
 *
	m_IO_backup_ba£
;

229 
wch¬_t
 *
	m_IO_§ve_’d
;

231 
__mb¡©e_t
 
	m_IO_¡©e
;

232 
__mb¡©e_t
 
	m_IO_Ï¡_¡©e
;

233 
_IO_codecvt
 
	m_codecvt
;

235 
wch¬_t
 
	m_shÜtbuf
[1];

237 cÚ¡ 
_IO_jump_t
 *
	m_wide_vbË
;

241 
	s_IO_FILE
 {

242 
	m_æags
;

243 
	#_IO_fe_æags
 
_æags


	)

247 * 
	m_IO_»ad_±r
;

248 * 
	m_IO_»ad_’d
;

249 * 
	m_IO_»ad_ba£
;

250 * 
	m_IO_wr™e_ba£
;

251 * 
	m_IO_wr™e_±r
;

252 * 
	m_IO_wr™e_’d
;

253 * 
	m_IO_buf_ba£
;

254 * 
	m_IO_buf_’d
;

256 *
	m_IO_§ve_ba£
;

257 *
	m_IO_backup_ba£
;

258 *
	m_IO_§ve_’d
;

260 
_IO_m¬k”
 *
	m_m¬k”s
;

262 
_IO_FILE
 *
	m_chaš
;

264 
	m_f’o
;

266 
	m_blksize
;

268 
	m_æags2
;

270 
_IO_off_t
 
	m_Şd_off£t
;

272 
	#__HAVE_COLUMN


	)

274 
	m_cur_cŞumn
;

275 sigÃd 
	m_vbË_off£t
;

276 
	m_shÜtbuf
[1];

280 
_IO_lock_t
 *
	m_lock
;

281 #ifdeà
_IO_USE_OLD_IO_FILE


284 
	s_IO_FILE_com¶‘e


286 
_IO_FILE
 
	m_fe
;

288 #ià
defšed
 
_G_IO_IO_FILE_VERSION
 && _G_IO_IO_FILE_VERSION == 0x20001

289 
_IO_off64_t
 
	m_off£t
;

290 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


292 
_IO_codecvt
 *
	m_codecvt
;

293 
_IO_wide_d©a
 *
	m_wide_d©a
;

294 
_IO_FILE
 *
	m_ä“»s_li¡
;

295 *
	m_ä“»s_buf
;

297 *
	m__·d1
;

298 *
	m__·d2
;

299 *
	m__·d3
;

300 *
	m__·d4
;

302 
size_t
 
	m__·d5
;

303 
	m_mode
;

305 
	m_unu£d2
[15 *  (è- 4 *  (*è-  (
size_t
)];

309 #iâdeà
__ılu¥lus


310 
_IO_FILE
 
	t_IO_FILE
;

313 
	g_IO_FILE_¶us
;

315 
_IO_FILE_¶us
 
_IO_2_1_¡dš_
;

316 
_IO_FILE_¶us
 
_IO_2_1_¡dout_
;

317 
_IO_FILE_¶us
 
_IO_2_1_¡d”r_
;

318 #iâdeà
_LIBC


319 
	#_IO_¡dš
 ((
_IO_FILE
*)(&
_IO_2_1_¡dš_
))

	)

320 
	#_IO_¡dout
 ((
_IO_FILE
*)(&
_IO_2_1_¡dout_
))

	)

321 
	#_IO_¡d”r
 ((
_IO_FILE
*)(&
_IO_2_1_¡d”r_
))

	)

323 
_IO_FILE
 *
_IO_¡dš
 
©Œibu‹_hidd’
;

324 
_IO_FILE
 *
_IO_¡dout
 
©Œibu‹_hidd’
;

325 
_IO_FILE
 *
_IO_¡d”r
 
©Œibu‹_hidd’
;

333 
__ssize_t
 
	t__io_»ad_â
 (*
	t__cook›
, *
	t__buf
, 
	tsize_t
 
	t__nby‹s
);

341 
__ssize_t
 
	t__io_wr™e_â
 (*
	t__cook›
, cÚ¡ *
	t__buf
,

342 
	tsize_t
 
	t__n
);

350 
	t__io_£ek_â
 (*
	t__cook›
, 
	t_IO_off64_t
 *
	t__pos
, 
	t__w
);

353 
	t__io_şo£_â
 (*
	t__cook›
);

356 #ifdeà
_GNU_SOURCE


358 
__io_»ad_â
 
	tcook›_»ad_funùiÚ_t
;

359 
__io_wr™e_â
 
	tcook›_wr™e_funùiÚ_t
;

360 
__io_£ek_â
 
	tcook›_£ek_funùiÚ_t
;

361 
__io_şo£_â
 
	tcook›_şo£_funùiÚ_t
;

366 
__io_»ad_â
 *
	m»ad
;

367 
__io_wr™e_â
 *
	mwr™e
;

368 
__io_£ek_â
 *
	m£ek
;

369 
__io_şo£_â
 *
	mşo£
;

370 } 
	t_IO_cook›_io_funùiÚs_t
;

371 
_IO_cook›_io_funùiÚs_t
 
	tcook›_io_funùiÚs_t
;

373 
	g_IO_cook›_fe
;

376 
_IO_cook›_š™
 (
_IO_cook›_fe
 *
__cfe
, 
__»ad_wr™e
,

377 *
__cook›
, 
_IO_cook›_io_funùiÚs_t
 
__âs
);

381 #ifdeà
__ılu¥lus


385 
__und”æow
 (
_IO_FILE
 *);

386 
__uæow
 (
_IO_FILE
 *);

387 
__ov”æow
 (
_IO_FILE
 *, );

388 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


389 
_IO_wšt_t
 
__wund”æow
 (
_IO_FILE
 *);

390 
_IO_wšt_t
 
__wuæow
 (
_IO_FILE
 *);

391 
_IO_wšt_t
 
__wov”æow
 (
_IO_FILE
 *, _IO_wint_t);

394 #ià 
__GNUC__
 >= 3

395 
	#_IO_BE
(
ex´
, 
»s
è
	`__butš_ex³ù
 (Óx´),„es)

	)

397 
	#_IO_BE
(
ex´
, 
»s
èÓx´)

	)

400 
	#_IO_g‘c_uÆocked
(
_å
) \

401 (
	`_IO_BE
 ((
_å
)->
_IO_»ad_±r
 >ğ(_å)->
_IO_»ad_’d
, 0) \

402 ? 
	`__uæow
 (
_å
è: *(*è(_å)->
_IO_»ad_±r
++)

	)

403 
	#_IO_³ekc_uÆocked
(
_å
) \

404 (
	`_IO_BE
 ((
_å
)->
_IO_»ad_±r
 >ğ(_å)->
_IO_»ad_’d
, 0) \

405 && 
	`__und”æow
 (
_å
è=ğ
EOF
 ? EOF \

406 : *(*è(
_å
)->
_IO_»ad_±r
)

	)

407 
	#_IO_putc_uÆocked
(
_ch
, 
_å
) \

408 (
	`_IO_BE
 ((
_å
)->
_IO_wr™e_±r
 >ğ(_å)->
_IO_wr™e_’d
, 0) \

409 ? 
	`__ov”æow
 (
_å
, (è(
_ch
)) \

410 : (è(*(
_å
)->
_IO_wr™e_±r
++ = (
_ch
)))

	)

412 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


413 
	#_IO_g‘wc_uÆocked
(
_å
) \

414 (
	`_IO_BE
 ((
_å
)->
_wide_d©a
 =ğ
NULL
 \

415 || ((
_å
)->
_wide_d©a
->
_IO_»ad_±r
 \

416 >ğ(
_å
)->
_wide_d©a
->
_IO_»ad_’d
), 0) \

417 ? 
	`__wuæow
 (
_å
è: (
_IO_wšt_t
è*(_å)->
_wide_d©a
->
_IO_»ad_±r
++)

	)

418 
	#_IO_putwc_uÆocked
(
_wch
, 
_å
) \

419 (
	`_IO_BE
 ((
_å
)->
_wide_d©a
 =ğ
NULL
 \

420 || ((
_å
)->
_wide_d©a
->
_IO_wr™e_±r
 \

421 >ğ(
_å
)->
_wide_d©a
->
_IO_wr™e_’d
), 0) \

422 ? 
	`__wov”æow
 (
_å
, 
_wch
) \

423 : (
_IO_wšt_t
è(*(
_å
)->
_wide_d©a
->
_IO_wr™e_±r
++ = (
_wch
)))

	)

426 
	#_IO_ãof_uÆocked
(
__å
è(((__å)->
_æags
 & 
_IO_EOF_SEEN
è!ğ0)

	)

427 
	#_IO_ã¼Ü_uÆocked
(
__å
è(((__å)->
_æags
 & 
_IO_ERR_SEEN
è!ğ0)

	)

429 
_IO_g‘c
 (
_IO_FILE
 *
__å
);

430 
_IO_putc
 (
__c
, 
_IO_FILE
 *
__å
);

431 
_IO_ãof
 (
_IO_FILE
 *
__å
è
__THROW
;

432 
_IO_ã¼Ü
 (
_IO_FILE
 *
__å
è
__THROW
;

434 
_IO_³ekc_locked
 (
_IO_FILE
 *
__å
);

437 
	#_IO_PENDING_OUTPUT_COUNT
(
_å
) \

438 ((
_å
)->
_IO_wr™e_±r
 - (_å)->
_IO_wr™e_ba£
)

	)

440 
_IO_æockfe
 (
_IO_FILE
 *è
__THROW
;

441 
_IO_fuÆockfe
 (
_IO_FILE
 *è
__THROW
;

442 
_IO_árylockfe
 (
_IO_FILE
 *è
__THROW
;

444 #ifdeà
_IO_MTSAFE_IO


445 
	#_IO_³ekc
(
_å
è
	`_IO_³ekc_locked
 (_å)

	)

446 
	#_IO_æockfe
(
_å
) \

447 ià(((
_å
)->
_æags
 & 
_IO_USER_LOCK
è=ğ0è
	`_IO_æockfe
 (_å)

	)

448 
	#_IO_fuÆockfe
(
_å
) \

449 ià(((
_å
)->
_æags
 & 
_IO_USER_LOCK
è=ğ0è
	`_IO_fuÆockfe
 (_å)

	)

451 
	#_IO_³ekc
(
_å
è
	`_IO_³ekc_uÆocked
 (_å)

	)

452 
	#_IO_æockfe
(
_å
è

	)

453 
	#_IO_fuÆockfe
(
_å
è

	)

454 
	#_IO_árylockfe
(
_å
è

	)

455 
	#_IO_ş—nup_»giÚ_¡¬t
(
_fù
, 
_å
è

	)

456 
	#_IO_ş—nup_»giÚ_’d
(
_Do™
è

	)

459 
_IO_vfsÿnf
 (
_IO_FILE
 * 
__»¡riù
, const * __restrict,

460 
_IO_va_li¡
, *
__»¡riù
);

461 
_IO_vårštf
 (
_IO_FILE
 *
__»¡riù
, const *__restrict,

462 
_IO_va_li¡
);

463 
_IO_ssize_t
 
_IO_·dn
 (
_IO_FILE
 *, , _IO_ssize_t);

464 
_IO_size_t
 
_IO_sg‘n
 (
_IO_FILE
 *, *, _IO_size_t);

466 
_IO_off64_t
 
_IO_£ekoff
 (
_IO_FILE
 *, _IO_off64_t, , );

467 
_IO_off64_t
 
_IO_£ekpos
 (
_IO_FILE
 *, _IO_off64_t, );

469 
_IO_ä“_backup_¬—
 (
_IO_FILE
 *è
__THROW
;

471 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


472 
_IO_wšt_t
 
_IO_g‘wc
 (
_IO_FILE
 *
__å
);

473 
_IO_wšt_t
 
_IO_putwc
 (
wch¬_t
 
__wc
, 
_IO_FILE
 *
__å
);

474 
_IO_fwide
 (
_IO_FILE
 *
__å
, 
__mode
è
__THROW
;

475 #ià
__GNUC__
 >= 2

478 #ià
defšed
 
_LIBC
 && defšed 
SHARED


479 
	~<shlib-com·t.h
>

480 #ià
SHLIB_COMPAT
 (
libc
, 
GLIBC_2_0
, 
GLIBC_2_1
)

481 
	#_IO_fwide_maybe_šcom·tibË
 \

482 (
	`__butš_ex³ù
 (&
_IO_¡dš_u£d
 =ğ
NULL
, 0))

	)

483 cÚ¡ 
_IO_¡dš_u£d
;

484 
w—k_ex‹º
 (
_IO_¡dš_u£d
);

487 #iâdeà
_IO_fwide_maybe_šcom·tibË


488 
	#_IO_fwide_maybe_šcom·tibË
 (0)

	)

492 
	#_IO_fwide
(
__å
, 
__mode
) \

493 ({ 
__»suÉ
 = (
__mode
); \

494 ià(
__»suÉ
 < 0 && ! 
_IO_fwide_maybe_šcom·tibË
) \

496 ià((
__å
)->
_mode
 == 0) \

498 (
__å
)->
_mode
 = -1; \

499 
__»suÉ
 = (
__å
)->
_mode
; \

501 ià(
	`__butš_cÚ¡ªt_p
 (
__mode
) && (__mode) == 0) \

502 
__»suÉ
 = 
_IO_fwide_maybe_šcom·tibË
 ? -1 : (
__å
)->
_mode
; \

504 
__»suÉ
 = 
	`_IO_fwide
 (
__å
, __result); \

505 
__»suÉ
; })

	)

508 
_IO_vfwsÿnf
 (
_IO_FILE
 * 
__»¡riù
, cÚ¡ 
wch¬_t
 * __restrict,

509 
_IO_va_li¡
, *
__»¡riù
);

510 
_IO_vfw´štf
 (
_IO_FILE
 *
__»¡riù
, cÚ¡ 
wch¬_t
 *__restrict,

511 
_IO_va_li¡
);

512 
_IO_ssize_t
 
_IO_w·dn
 (
_IO_FILE
 *, 
wšt_t
, _IO_ssize_t);

513 
_IO_ä“_wbackup_¬—
 (
_IO_FILE
 *è
__THROW
;

516 #ifdeà
__LDBL_COMPAT


517 
	~<b™s/libio-ldbl.h
>

520 #ifdeà
__ılu¥lus


	@/usr/include/rpc/netdb.h

36 #iâdeà
_RPC_NETDB_H


37 
	#_RPC_NETDB_H
 1

	)

39 
	~<ã©u»s.h
>

41 
	#__Ãed_size_t


	)

42 
	~<¡ddef.h
>

44 
__BEGIN_DECLS


46 
	s½ûÁ


48 *
	mr_Çme
;

49 **
	mr_®Ÿ£s
;

50 
	mr_numb”
;

53 
	$£ŒpûÁ
 (
__¡ayİ’
è
__THROW
;

54 
	$’d½ûÁ
 (è
__THROW
;

55 
½ûÁ
 *
	$g‘½cbyÇme
 (cÚ¡ *
__Çme
è
__THROW
;

56 
½ûÁ
 *
	$g‘½cbynumb”
 (
__numb”
è
__THROW
;

57 
½ûÁ
 *
	$g‘½ûÁ
 (è
__THROW
;

59 #ifdeà
__USE_MISC


60 
	$g‘½cbyÇme_r
 (cÚ¡ *
__Çme
, 
½ûÁ
 *
__»suÉ_buf
,

61 *
__bufãr
, 
size_t
 
__buæ’
,

62 
½ûÁ
 **
__»suÉ
è
__THROW
;

64 
	$g‘½cbynumb”_r
 (
__numb”
, 
½ûÁ
 *
__»suÉ_buf
,

65 *
__bufãr
, 
size_t
 
__buæ’
,

66 
½ûÁ
 **
__»suÉ
è
__THROW
;

68 
	$g‘½ûÁ_r
 (
½ûÁ
 *
__»suÉ_buf
, *
__bufãr
,

69 
size_t
 
__buæ’
, 
½ûÁ
 **
__»suÉ
è
__THROW
;

72 
__END_DECLS


	@/usr/include/sched.h

19 #iâdef 
_SCHED_H


20 
	#_SCHED_H
 1

	)

22 
	~<ã©u»s.h
>

25 
	~<b™s/ty³s.h
>

27 
	#__Ãed_size_t


	)

28 
	~<¡ddef.h
>

30 #ifdeà
__USE_XOPEN2K


31 
	#__Ãed_time_t


	)

32 
	#__Ãed_time¥ec


	)

34 
	~<time.h
>

36 #iâdeà
__pid_t_defšed


37 
__pid_t
 
	tpid_t
;

38 
	#__pid_t_defšed


	)

43 
	~<b™s/sched.h
>

45 
	#sched_´iÜ™y
 
__sched_´iÜ™y


	)

48 
__BEGIN_DECLS


51 
	$sched_£¬am
 (
__pid_t
 
__pid
, cÚ¡ 
sched_·¿m
 *
__·¿m
)

52 
__THROW
;

55 
	$sched_g‘·¿m
 (
__pid_t
 
__pid
, 
sched_·¿m
 *
__·¿m
è
__THROW
;

58 
	$sched_£tscheduËr
 (
__pid_t
 
__pid
, 
__pŞicy
,

59 cÚ¡ 
sched_·¿m
 *
__·¿m
è
__THROW
;

62 
	$sched_g‘scheduËr
 (
__pid_t
 
__pid
è
__THROW
;

65 
	$sched_y›ld
 (è
__THROW
;

68 
	$sched_g‘_´iÜ™y_max
 (
__®gÜ™hm
è
__THROW
;

71 
	$sched_g‘_´iÜ™y_mš
 (
__®gÜ™hm
è
__THROW
;

74 
	$sched_¼_g‘_š‹rv®
 (
__pid_t
 
__pid
, 
time¥ec
 *
__t
è
__THROW
;

77 #ifdeà
__USE_GNU


79 
	#CPU_SETSIZE
 
__CPU_SETSIZE


	)

80 
	#CPU_SET
(
ıu
, 
ıu£
è
	`__CPU_SET_S
 (ıu,  (
ıu_£t_t
), cpu£)

	)

81 
	#CPU_CLR
(
ıu
, 
ıu£
è
	`__CPU_CLR_S
 (ıu,  (
ıu_£t_t
), cpu£)

	)

82 
	#CPU_ISSET
(
ıu
, 
ıu£
è
	`__CPU_ISSET_S
 (ıu,  (
ıu_£t_t
), \

83 
ıu£
)

	)

84 
	#CPU_ZERO
(
ıu£
è
	`__CPU_ZERO_S
 ( (
ıu_£t_t
), cpu£)

	)

85 
	#CPU_COUNT
(
ıu£
è
	`__CPU_COUNT_S
 ( (
ıu_£t_t
), cpu£)

	)

87 
	#CPU_SET_S
(
ıu
, 
£tsize
, 
ıu£
è
	`__CPU_SET_S
 (ıu, s‘size, cpu£)

	)

88 
	#CPU_CLR_S
(
ıu
, 
£tsize
, 
ıu£
è
	`__CPU_CLR_S
 (ıu, s‘size, cpu£)

	)

89 
	#CPU_ISSET_S
(
ıu
, 
£tsize
, 
ıu£
è
	`__CPU_ISSET_S
 (cpu, setsize, \

90 
ıu£
)

	)

91 
	#CPU_ZERO_S
(
£tsize
, 
ıu£
è
	`__CPU_ZERO_S
 (£tsize, cpu£)

	)

92 
	#CPU_COUNT_S
(
£tsize
, 
ıu£
è
	`__CPU_COUNT_S
 (£tsize, cpu£)

	)

94 
	#CPU_EQUAL
(
ıu£1
, 
ıu£2
) \

95 
	`__CPU_EQUAL_S
 ( (
ıu_£t_t
), 
ıu£1
, 
ıu£2
)

	)

96 
	#CPU_EQUAL_S
(
£tsize
, 
ıu£1
, 
ıu£2
) \

97 
	`__CPU_EQUAL_S
 (
£tsize
, 
ıu£1
, 
ıu£2
)

	)

99 
	#CPU_AND
(
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

100 
	`__CPU_OP_S
 ( (
ıu_£t_t
), 
de¡£t
, 
¤c£t1
, 
¤c£t2
, &)

	)

101 
	#CPU_OR
(
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

102 
	`__CPU_OP_S
 ( (
ıu_£t_t
), 
de¡£t
, 
¤c£t1
, 
¤c£t2
, |)

	)

103 
	#CPU_XOR
(
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

104 
	`__CPU_OP_S
 ( (
ıu_£t_t
), 
de¡£t
, 
¤c£t1
, 
¤c£t2
, ^)

	)

105 
	#CPU_AND_S
(
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

106 
	`__CPU_OP_S
 (
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
, &)

	)

107 
	#CPU_OR_S
(
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

108 
	`__CPU_OP_S
 (
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
, |)

	)

109 
	#CPU_XOR_S
(
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

110 
	`__CPU_OP_S
 (
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
, ^)

	)

112 
	#CPU_ALLOC_SIZE
(
couÁ
è
	`__CPU_ALLOC_SIZE
 (couÁ)

	)

113 
	#CPU_ALLOC
(
couÁ
è
	`__CPU_ALLOC
 (couÁ)

	)

114 
	#CPU_FREE
(
ıu£t
è
	`__CPU_FREE
 (ıu£t)

	)

118 
	$sched_£ffš™y
 (
__pid_t
 
__pid
, 
size_t
 
__ıu£tsize
,

119 cÚ¡ 
ıu_£t_t
 *
__ıu£t
è
__THROW
;

122 
	$sched_g‘affš™y
 (
__pid_t
 
__pid
, 
size_t
 
__ıu£tsize
,

123 
ıu_£t_t
 *
__ıu£t
è
__THROW
;

126 
__END_DECLS


	@/usr/include/stdc-predef.h

18 #iâdef 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifdeà
__GCC_IEC_559


37 #ià
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

41 
	#__STDC_IEC_559__
 1

	)

44 #ifdeà
__GCC_IEC_559_COMPLEX


45 #ià
__GCC_IEC_559_COMPLEX
 > 0

46 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_559_COMPLEX__
 1

	)

55 
	#__STDC_ISO_10646__
 201505L

	)

58 
	#__STDC_NO_THREADS__
 1

	)

	@/usr/include/xlocale.h

20 #iâdeà
_XLOCALE_H


21 
	#_XLOCALE_H
 1

	)

27 
	s__loÿË_¡ruù


30 
__loÿË_d©a
 *
	m__loÿËs
[13];

33 cÚ¡ *
	m__ùy³_b
;

34 cÚ¡ *
	m__ùy³_tŞow”
;

35 cÚ¡ *
	m__ùy³_touµ”
;

38 cÚ¡ *
	m__Çmes
[13];

39 } *
	t__loÿË_t
;

42 
__loÿË_t
 
	tloÿË_t
;

	@/usr/include/_G_config.h

4 #iâdeà
_G_cÚfig_h


5 
	#_G_cÚfig_h
 1

	)

9 
	~<b™s/ty³s.h
>

10 
	#__Ãed_size_t


	)

11 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


12 
	#__Ãed_wch¬_t


	)

14 
	#__Ãed_NULL


	)

15 
	~<¡ddef.h
>

16 
	#__Ãed_mb¡©e_t


	)

17 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


18 
	#__Ãed_wšt_t


	)

20 
	~<wch¬.h
>

23 
__off_t
 
	m__pos
;

24 
__mb¡©e_t
 
	m__¡©e
;

25 } 
	t_G_åos_t
;

28 
__off64_t
 
	m__pos
;

29 
__mb¡©e_t
 
	m__¡©e
;

30 } 
	t_G_åos64_t
;

31 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


32 
	~<gcÚv.h
>

35 
__gcÚv_šfo
 
	m__cd
;

38 
__gcÚv_šfo
 
	m__cd
;

39 
__gcÚv_¡•_d©a
 
	m__d©a
;

40 } 
	m__combšed
;

41 } 
	t_G_icÚv_t
;

46 
	#_G_va_li¡
 
__gnuc_va_li¡


	)

48 
	#_G_HAVE_MMAP
 1

	)

49 
	#_G_HAVE_MREMAP
 1

	)

51 
	#_G_IO_IO_FILE_VERSION
 0x20001

	)

54 
	#_G_HAVE_ST_BLKSIZE
 
	`defšed
 (
_STATBUF_ST_BLKSIZE
)

	)

56 
	#_G_BUFSIZ
 8192

	)

	@/usr/include/gconv.h

22 #iâdeà
_GCONV_H


23 
	#_GCONV_H
 1

	)

25 
	~<ã©u»s.h
>

26 
	#__Ãed_mb¡©e_t


	)

27 
	#__Ãed_wšt_t


	)

28 
	~<wch¬.h
>

29 
	#__Ãed_size_t


	)

30 
	#__Ãed_wch¬_t


	)

31 
	~<¡ddef.h
>

34 
	#__UNKNOWN_10646_CHAR
 ((
wch¬_t
è0xfffd)

	)

39 
	m__GCONV_OK
 = 0,

40 
	m__GCONV_NOCONV
,

41 
	m__GCONV_NODB
,

42 
	m__GCONV_NOMEM
,

44 
	m__GCONV_EMPTY_INPUT
,

45 
	m__GCONV_FULL_OUTPUT
,

46 
	m__GCONV_ILLEGAL_INPUT
,

47 
	m__GCONV_INCOMPLETE_INPUT
,

49 
	m__GCONV_ILLEGAL_DESCRIPTOR
,

50 
	m__GCONV_INTERNAL_ERROR


57 
	m__GCONV_IS_LAST
 = 0x0001,

58 
	m__GCONV_IGNORE_ERRORS
 = 0x0002,

59 
	m__GCONV_SWAP
 = 0x0004,

60 
	m__GCONV_TRANSLIT
 = 0x0008

65 
	g__gcÚv_¡•
;

66 
	g__gcÚv_¡•_d©a
;

67 
	g__gcÚv_lßded_objeù
;

71 (*
	t__gcÚv_fù
è(
	t__gcÚv_¡•
 *, 
	t__gcÚv_¡•_d©a
 *,

73 **, 
	tsize_t
 *, , );

76 
	$wšt_t
 (*
	t__gcÚv_btowc_fù
è(
	t__gcÚv_¡•
 *, );

79 (*
	t__gcÚv_š™_fù
è(
	t__gcÚv_¡•
 *);

80 (*
	t__gcÚv_’d_fù
è(
	t__gcÚv_¡•
 *);

84 
	s__gcÚv_¡•


86 
__gcÚv_lßded_objeù
 *
__shlib_hªdË
;

87 cÚ¡ *
__modÇme
;

89 
__couÁ”
;

91 *
__äom_Çme
;

92 *
__to_Çme
;

94 
__gcÚv_fù
 
__fù
;

95 
__gcÚv_btowc_fù
 
__btowc_fù
;

96 
__gcÚv_š™_fù
 
__š™_fù
;

97 
__gcÚv_’d_fù
 
__’d_fù
;

101 
__mš_Ãeded_äom
;

102 
__max_Ãeded_äom
;

103 
__mš_Ãeded_to
;

104 
__max_Ãeded_to
;

107 
__¡©eful
;

109 *
__d©a
;

114 
	s__gcÚv_¡•_d©a


116 *
__outbuf
;

117 *
__outbuãnd
;

121 
__æags
;

125 
__švoÿtiÚ_couÁ”
;

129 
__š‹º®_u£
;

131 
__mb¡©e_t
 *
__¡©•
;

132 
__mb¡©e_t
 
__¡©e
;

138 
	s__gcÚv_šfo


140 
size_t
 
__n¡•s
;

141 
__gcÚv_¡•
 *
__¡•s
;

142 
__ex‹nsiÚ__
 
__gcÚv_¡•_d©a
 
__d©a
 
__æex¬r
;

143 } *
	t__gcÚv_t
;

146 
	`__gcÚv_Œª¦™”©e
 (
__gcÚv_¡•
 *
¡•
,

147 
__gcÚv_¡•_d©a
 *
¡•_d©a
,

148 cÚ¡ *
šbuf¡¬t
,

149 cÚ¡ **
šbuå
,

150 cÚ¡ *
šbuãnd
,

151 **
outbuf¡¬t
,

152 
size_t
 *
œ»v”sibË
);

	@/usr/include/wchar.h

23 #iâdeà
_WCHAR_H


25 #ià!
defšed
 
__Ãed_mb¡©e_t
 && !defšed 
__Ãed_wšt_t


26 
	#_WCHAR_H
 1

	)

27 
	~<ã©u»s.h
>

30 #ifdeà
_WCHAR_H


32 
	#__Ãed___FILE


	)

33 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


34 
	#__Ãed_FILE


	)

36 
	~<¡dio.h
>

38 
	#__Ãed___va_li¡


	)

39 
	~<¡d¬g.h
>

41 
	~<b™s/wch¬.h
>

44 
	#__Ãed_size_t


	)

45 
	#__Ãed_wch¬_t


	)

46 
	#__Ãed_NULL


	)

48 #ià
defšed
 
_WCHAR_H
 || defšed 
__Ãed_wšt_t
 || !defšed 
__WINT_TYPE__


49 #undeà
__Ãed_wšt_t


50 
	#__Ãed_wšt_t


	)

51 
	~<¡ddef.h
>

55 #iâdeà
_WINT_T


60 
	#_WINT_T


	)

61 
	twšt_t
;

65 #ià
defšed
 
__ılu¥lus
 && defšed 
_GLIBCPP_USE_NAMESPACES
 \

66 && 
defšed
 
__WINT_TYPE__


67 
__BEGIN_NAMESPACE_STD


68 
__WINT_TYPE__
 
	twšt_t
;

69 
	g__END_NAMESPACE_STD


74 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (4, 4)

75 
	#__CORRECT_ISO_CPP_WCHAR_H_PROTO


	)

79 #ià(
defšed
 
_WCHAR_H
 || defšed 
__Ãed_mb¡©e_t
è&& !defšed 
____mb¡©e_t_defšed


80 
	#____mb¡©e_t_defšed
 1

	)

84 
	m__couÁ
;

87 #ifdeà
__WINT_TYPE__


88 
__WINT_TYPE__
 
	m__wch
;

90 
wšt_t
 
	m__wch
;

92 
	m__wchb
[4];

93 } 
	m__v®ue
;

94 } 
	t__mb¡©e_t
;

96 #undeà
__Ãed_mb¡©e_t


101 #ifdeà
_WCHAR_H


103 #iâdeà
__mb¡©e_t_defšed


104 
__BEGIN_NAMESPACE_C99


106 
__mb¡©e_t
 
	tmb¡©e_t
;

107 
	g__END_NAMESPACE_C99


108 
	#__mb¡©e_t_defšed
 1

	)

111 #ifdeà
__USE_GNU


112 
	$__USING_NAMESPACE_C99
(
mb¡©e_t
)

115 #iâdeà
WCHAR_MIN


117 
	#WCHAR_MIN
 
__WCHAR_MIN


	)

118 
	#WCHAR_MAX
 
__WCHAR_MAX


	)

121 #iâdeà
WEOF


122 
	#WEOF
 (0xffffffffu)

	)

127 #ià
defšed
 
__USE_XOPEN
 && !defšed 
__USE_UNIX98


128 
	~<wùy³.h
>

132 
__BEGIN_DECLS


134 
__BEGIN_NAMESPACE_STD


137 
tm
;

138 
__END_NAMESPACE_STD


142 
	$__USING_NAMESPACE_STD
(
tm
)

145 
__BEGIN_NAMESPACE_STD


147 
wch¬_t
 *
	$wcsıy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

148 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
)

149 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

152 
wch¬_t
 *
	$wc¢ıy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

153 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

154 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

157 
wch¬_t
 *
	$wcsÿt
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

158 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
)

159 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

161 
wch¬_t
 *
	$wc¢ÿt
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

162 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

163 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

166 
	$wcscmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
)

167 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

169 
	$wc¢cmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
, 
size_t
 
__n
)

170 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

171 
__END_NAMESPACE_STD


173 #ifdeà
__USE_XOPEN2K8


175 
	$wcsÿ£cmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
è
__THROW
;

178 
	$wc¢ÿ£cmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

179 
size_t
 
__n
è
__THROW
;

183 
	~<xloÿË.h
>

185 
	$wcsÿ£cmp_l
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

186 
__loÿË_t
 
__loc
è
__THROW
;

188 
	$wc¢ÿ£cmp_l
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

189 
size_t
 
__n
, 
__loÿË_t
 
__loc
è
__THROW
;

192 
__BEGIN_NAMESPACE_STD


195 
	$wcscŞl
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
è
__THROW
;

199 
size_t
 
	$wcsxäm
 (
wch¬_t
 *
__»¡riù
 
__s1
,

200 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
è
__THROW
;

201 
__END_NAMESPACE_STD


203 #ifdeà
__USE_XOPEN2K8


209 
	$wcscŞl_l
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

210 
__loÿË_t
 
__loc
è
__THROW
;

215 
size_t
 
	$wcsxäm_l
 (
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

216 
size_t
 
__n
, 
__loÿË_t
 
__loc
è
__THROW
;

219 
wch¬_t
 *
	$wcsdup
 (cÚ¡ 
wch¬_t
 *
__s
è
__THROW
 
__©Œibu‹_m®loc__
;

222 
__BEGIN_NAMESPACE_STD


224 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


225 "C++" 
wch¬_t
 *
	$wcschr
 (
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

226 
__THROW
 
	`__asm
 ("wcschr"è
__©Œibu‹_pu»__
;

227 "C++" cÚ¡ 
wch¬_t
 *
	$wcschr
 (cÚ¡ 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

228 
__THROW
 
	`__asm
 ("wcschr"è
__©Œibu‹_pu»__
;

230 
wch¬_t
 *
	$wcschr
 (cÚ¡ 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

231 
__THROW
 
__©Œibu‹_pu»__
;

234 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


235 "C++" 
wch¬_t
 *
	$wc¤chr
 (
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

236 
__THROW
 
	`__asm
 ("wc¤chr"è
__©Œibu‹_pu»__
;

237 "C++" cÚ¡ 
wch¬_t
 *
	$wc¤chr
 (cÚ¡ 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

238 
__THROW
 
	`__asm
 ("wc¤chr"è
__©Œibu‹_pu»__
;

240 
wch¬_t
 *
	$wc¤chr
 (cÚ¡ 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

241 
__THROW
 
__©Œibu‹_pu»__
;

243 
__END_NAMESPACE_STD


245 #ifdeà
__USE_GNU


248 
wch¬_t
 *
	$wcschºul
 (cÚ¡ 
wch¬_t
 *
__s
, wch¬_ˆ
__wc
)

249 
__THROW
 
__©Œibu‹_pu»__
;

252 
__BEGIN_NAMESPACE_STD


255 
size_t
 
	$wcsc¥n
 (cÚ¡ 
wch¬_t
 *
__wcs
, cÚ¡ wch¬_ˆ*
__»jeù
)

256 
__THROW
 
__©Œibu‹_pu»__
;

259 
size_t
 
	$wcs¥n
 (cÚ¡ 
wch¬_t
 *
__wcs
, cÚ¡ wch¬_ˆ*
__acû±
)

260 
__THROW
 
__©Œibu‹_pu»__
;

262 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


263 "C++" 
wch¬_t
 *
	$wc¥brk
 (
wch¬_t
 *
__wcs
, cÚ¡ wch¬_ˆ*
__acû±
)

264 
__THROW
 
	`__asm
 ("wc¥brk"è
__©Œibu‹_pu»__
;

265 "C++" cÚ¡ 
wch¬_t
 *
	$wc¥brk
 (cÚ¡ 
wch¬_t
 *
__wcs
,

266 cÚ¡ 
wch¬_t
 *
__acû±
)

267 
__THROW
 
	`__asm
 ("wc¥brk"è
__©Œibu‹_pu»__
;

269 
wch¬_t
 *
	$wc¥brk
 (cÚ¡ 
wch¬_t
 *
__wcs
, cÚ¡ wch¬_ˆ*
__acû±
)

270 
__THROW
 
__©Œibu‹_pu»__
;

273 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


274 "C++" 
wch¬_t
 *
	$wcs¡r
 (
wch¬_t
 *
__hay¡ack
, cÚ¡ wch¬_ˆ*
__ÃedË
)

275 
__THROW
 
	`__asm
 ("wcs¡r"è
__©Œibu‹_pu»__
;

276 "C++" cÚ¡ 
wch¬_t
 *
	$wcs¡r
 (cÚ¡ 
wch¬_t
 *
__hay¡ack
,

277 cÚ¡ 
wch¬_t
 *
__ÃedË
)

278 
__THROW
 
	`__asm
 ("wcs¡r"è
__©Œibu‹_pu»__
;

280 
wch¬_t
 *
	$wcs¡r
 (cÚ¡ 
wch¬_t
 *
__hay¡ack
, cÚ¡ wch¬_ˆ*
__ÃedË
)

281 
__THROW
 
__©Œibu‹_pu»__
;

285 
wch¬_t
 *
	$wc¡ok
 (
wch¬_t
 *
__»¡riù
 
__s
,

286 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__d–im
,

287 
wch¬_t
 **
__»¡riù
 
__±r
è
__THROW
;

290 
size_t
 
	$wc¦’
 (cÚ¡ 
wch¬_t
 *
__s
è
__THROW
 
__©Œibu‹_pu»__
;

291 
__END_NAMESPACE_STD


293 #ifdeà
__USE_XOPEN


295 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


296 "C++" 
wch¬_t
 *
	$wcswcs
 (
wch¬_t
 *
__hay¡ack
, cÚ¡ wch¬_ˆ*
__ÃedË
)

297 
__THROW
 
	`__asm
 ("wcswcs"è
__©Œibu‹_pu»__
;

298 "C++" cÚ¡ 
wch¬_t
 *
	$wcswcs
 (cÚ¡ 
wch¬_t
 *
__hay¡ack
,

299 cÚ¡ 
wch¬_t
 *
__ÃedË
)

300 
__THROW
 
	`__asm
 ("wcswcs"è
__©Œibu‹_pu»__
;

302 
wch¬_t
 *
	$wcswcs
 (cÚ¡ 
wch¬_t
 *
__hay¡ack
, cÚ¡ wch¬_ˆ*
__ÃedË
)

303 
__THROW
 
__©Œibu‹_pu»__
;

307 #ifdeà
__USE_XOPEN2K8


309 
size_t
 
	$wc¢Ën
 (cÚ¡ 
wch¬_t
 *
__s
, 
size_t
 
__maxËn
)

310 
__THROW
 
__©Œibu‹_pu»__
;

314 
__BEGIN_NAMESPACE_STD


316 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


317 "C++" 
wch¬_t
 *
	$wmemchr
 (
wch¬_t
 *
__s
, wch¬_ˆ
__c
, 
size_t
 
__n
)

318 
__THROW
 
	`__asm
 ("wmemchr"è
__©Œibu‹_pu»__
;

319 "C++" cÚ¡ 
wch¬_t
 *
	$wmemchr
 (cÚ¡ 
wch¬_t
 *
__s
, wch¬_ˆ
__c
,

320 
size_t
 
__n
)

321 
__THROW
 
	`__asm
 ("wmemchr"è
__©Œibu‹_pu»__
;

323 
wch¬_t
 *
	$wmemchr
 (cÚ¡ 
wch¬_t
 *
__s
, wch¬_ˆ
__c
, 
size_t
 
__n
)

324 
__THROW
 
__©Œibu‹_pu»__
;

328 
	$wmemcmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
, 
size_t
 
__n
)

329 
__THROW
 
__©Œibu‹_pu»__
;

332 
wch¬_t
 *
	$wmemıy
 (
wch¬_t
 *
__»¡riù
 
__s1
,

333 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
è
__THROW
;

337 
wch¬_t
 *
	$wmemmove
 (
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
, 
size_t
 
__n
)

338 
__THROW
;

341 
wch¬_t
 *
	$wmem£t
 (
wch¬_t
 *
__s
, wch¬_ˆ
__c
, 
size_t
 
__n
è
__THROW
;

342 
__END_NAMESPACE_STD


344 #ifdeà
__USE_GNU


347 
wch¬_t
 *
	$wmempıy
 (
wch¬_t
 *
__»¡riù
 
__s1
,

348 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
)

349 
__THROW
;

353 
__BEGIN_NAMESPACE_STD


356 
wšt_t
 
	$btowc
 (
__c
è
__THROW
;

360 
	$wùob
 (
wšt_t
 
__c
è
__THROW
;

364 
	$mbsš™
 (cÚ¡ 
mb¡©e_t
 *
__ps
è
__THROW
 
__©Œibu‹_pu»__
;

368 
size_t
 
	$mb¹owc
 (
wch¬_t
 *
__»¡riù
 
__pwc
,

369 cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
,

370 
mb¡©e_t
 *
__»¡riù
 
__p
è
__THROW
;

373 
size_t
 
	$wütomb
 (*
__»¡riù
 
__s
, 
wch¬_t
 
__wc
,

374 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

377 
size_t
 
	$__mb¾’
 (cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
,

378 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

379 
size_t
 
	$mb¾’
 (cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
,

380 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

381 
__END_NAMESPACE_STD


383 #ifdeà
__USE_EXTERN_INLINES


389 
wšt_t
 
	$__btowc_®Ÿs
 (
__c
è
	`__asm
 ("btowc");

390 
__ex‹º_šlše
 
wšt_t


391 
	`__NTH
 (
	$btowc
 (
__c
))

392 {  (
	`__butš_cÚ¡ªt_p
 (
__c
) && __c >= '\0' && __c <= '\x7f'

393 ? (
wšt_t
è
__c
 : 
	`__btowc_®Ÿs
 (__c)); 
	}
}

395 
	$__wùob_®Ÿs
 (
wšt_t
 
__c
è
	`__asm
 ("wctob");

396 
__ex‹º_šlše
 

397 
	`__NTH
 (
	$wùob
 (
wšt_t
 
__wc
))

398 {  (
	`__butš_cÚ¡ªt_p
 (
__wc
è&& __wø>ğ
L
'\0' && __wc <= L'\x7f'

399 ? (è
__wc
 : 
	`__wùob_®Ÿs
 (__wc)); 
	}
}

401 
__ex‹º_šlše
 
size_t


402 
__NTH
 (
	$mb¾’
 (cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
,

403 
mb¡©e_t
 *
__»¡riù
 
__ps
))

404 {  (
__ps
 !ğ
NULL


405 ? 
	`mb¹owc
 (
NULL
, 
__s
, 
__n
, 
__ps
è: 
	`__mb¾’
 (__s, __n, NULL)); 
	}
}

408 
__BEGIN_NAMESPACE_STD


411 
size_t
 
	$mb¤towcs
 (
wch¬_t
 *
__»¡riù
 
__d¡
,

412 cÚ¡ **
__»¡riù
 
__¤c
, 
size_t
 
__Ën
,

413 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

417 
size_t
 
	$wc¤tombs
 (*
__»¡riù
 
__d¡
,

418 cÚ¡ 
wch¬_t
 **
__»¡riù
 
__¤c
, 
size_t
 
__Ën
,

419 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

420 
__END_NAMESPACE_STD


423 #ifdef 
__USE_XOPEN2K8


426 
size_t
 
	$mb¢¹owcs
 (
wch¬_t
 *
__»¡riù
 
__d¡
,

427 cÚ¡ **
__»¡riù
 
__¤c
, 
size_t
 
__nmc
,

428 
size_t
 
__Ën
, 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

432 
size_t
 
	$wc¢¹ombs
 (*
__»¡riù
 
__d¡
,

433 cÚ¡ 
wch¬_t
 **
__»¡riù
 
__¤c
,

434 
size_t
 
__nwc
, size_ˆ
__Ën
,

435 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

440 #ifdeà
__USE_XOPEN


442 
	$wcwidth
 (
wch¬_t
 
__c
è
__THROW
;

446 
	$wcswidth
 (cÚ¡ 
wch¬_t
 *
__s
, 
size_t
 
__n
è
__THROW
;

450 
__BEGIN_NAMESPACE_STD


453 
	$wc¡od
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

454 
wch¬_t
 **
__»¡riù
 
__’d±r
è
__THROW
;

455 
__END_NAMESPACE_STD


457 #ifdeà
__USE_ISOC99


458 
__BEGIN_NAMESPACE_C99


460 
	$wc¡of
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

461 
wch¬_t
 **
__»¡riù
 
__’d±r
è
__THROW
;

462 
	$wc¡Şd
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

463 
wch¬_t
 **
__»¡riù
 
__’d±r
è
__THROW
;

464 
__END_NAMESPACE_C99


468 
__BEGIN_NAMESPACE_STD


471 
	$wc¡Ş
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

472 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
è
__THROW
;

476 
	$wc¡oul
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

477 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

478 
__THROW
;

479 
__END_NAMESPACE_STD


481 #ifdeà
__USE_ISOC99


482 
__BEGIN_NAMESPACE_C99


485 
__ex‹nsiÚ__


486 
	$wc¡Şl
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

487 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

488 
__THROW
;

492 
__ex‹nsiÚ__


493 
	$wc¡ouÎ
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

494 
wch¬_t
 **
__»¡riù
 
__’d±r
,

495 
__ba£
è
__THROW
;

496 
__END_NAMESPACE_C99


499 #ifdeà
__USE_GNU


502 
__ex‹nsiÚ__


503 
	$wc¡oq
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

504 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

505 
__THROW
;

509 
__ex‹nsiÚ__


510 
	$wc¡ouq
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

511 
wch¬_t
 **
__»¡riù
 
__’d±r
,

512 
__ba£
è
__THROW
;

515 #ifdeà
__USE_GNU


529 
	~<xloÿË.h
>

533 
	$wc¡Ş_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

534 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
,

535 
__loÿË_t
 
__loc
è
__THROW
;

537 
	$wc¡oul_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

538 
wch¬_t
 **
__»¡riù
 
__’d±r
,

539 
__ba£
, 
__loÿË_t
 
__loc
è
__THROW
;

541 
__ex‹nsiÚ__


542 
	$wc¡Şl_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

543 
wch¬_t
 **
__»¡riù
 
__’d±r
,

544 
__ba£
, 
__loÿË_t
 
__loc
è
__THROW
;

546 
__ex‹nsiÚ__


547 
	$wc¡ouÎ_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

548 
wch¬_t
 **
__»¡riù
 
__’d±r
,

549 
__ba£
, 
__loÿË_t
 
__loc
)

550 
__THROW
;

552 
	$wc¡od_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

553 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

554 
__THROW
;

556 
	$wc¡of_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

557 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

558 
__THROW
;

560 
	$wc¡Şd_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

561 
wch¬_t
 **
__»¡riù
 
__’d±r
,

562 
__loÿË_t
 
__loc
è
__THROW
;

566 #ifdeà
__USE_XOPEN2K8


569 
wch¬_t
 *
	$wııy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

570 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
è
__THROW
;

574 
wch¬_t
 *
	$wınıy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

575 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

576 
__THROW
;

583 
__FILE
 *
	$İ’_wmem¡»am
 (
wch¬_t
 **
__buæoc
, 
size_t
 *
__siz–oc
è
__THROW
;

586 #ià
defšed
 
__USE_ISOC95
 || defšed 
__USE_UNIX98


587 
__BEGIN_NAMESPACE_STD


590 
	$fwide
 (
__FILE
 *
__å
, 
__mode
è
__THROW
;

597 
	`fw´štf
 (
__FILE
 *
__»¡riù
 
__¡»am
,

598 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

604 
	`w´štf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

607 
	$sw´štf
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__n
,

608 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

609 
__THROW
 ;

615 
	`vfw´štf
 (
__FILE
 *
__»¡riù
 
__s
,

616 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

617 
__gnuc_va_li¡
 
__¬g
)

623 
	`vw´štf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

624 
__gnuc_va_li¡
 
__¬g
)

628 
	$vsw´štf
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__n
,

629 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

630 
__gnuc_va_li¡
 
__¬g
)

631 
__THROW
 ;

638 
	`fwsÿnf
 (
__FILE
 *
__»¡riù
 
__¡»am
,

639 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

645 
	`wsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

648 
	$swsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

649 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

650 
__THROW
 ;

652 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__USE_GNU
 \

653 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

654 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

655 #ifdeà
__REDIRECT


659 
	`__REDIRECT
 (
fwsÿnf
, (
__FILE
 *
__»¡riù
 
__¡»am
,

660 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...),

661 
__isoc99_fwsÿnf
)

663 
	`__REDIRECT
 (
wsÿnf
, (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...),

664 
__isoc99_wsÿnf
)

666 
	`__REDIRECT_NTH
 (
swsÿnf
, (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

667 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

668 ...), 
__isoc99_swsÿnf
)

671 
	`__isoc99_fwsÿnf
 (
__FILE
 *
__»¡riù
 
__¡»am
,

672 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...);

673 
	`__isoc99_wsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...);

674 
	$__isoc99_swsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

675 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

676 
__THROW
;

677 
	#fwsÿnf
 
__isoc99_fwsÿnf


	)

678 
	#wsÿnf
 
__isoc99_wsÿnf


	)

679 
	#swsÿnf
 
__isoc99_swsÿnf


	)

683 
__END_NAMESPACE_STD


686 #ifdeà
__USE_ISOC99


687 
__BEGIN_NAMESPACE_C99


692 
	`vfwsÿnf
 (
__FILE
 *
__»¡riù
 
__s
,

693 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

694 
__gnuc_va_li¡
 
__¬g
)

700 
	`vwsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

701 
__gnuc_va_li¡
 
__¬g
)

704 
	$vswsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

705 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

706 
__gnuc_va_li¡
 
__¬g
)

707 
__THROW
 ;

709 #ià!
defšed
 
__USE_GNU
 \

710 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

711 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

712 #ifdeà
__REDIRECT


713 
	`__REDIRECT
 (
vfwsÿnf
, (
__FILE
 *
__»¡riù
 
__s
,

714 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

715 
__gnuc_va_li¡
 
__¬g
), 
__isoc99_vfwsÿnf
)

717 
	`__REDIRECT
 (
vwsÿnf
, (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

718 
__gnuc_va_li¡
 
__¬g
), 
__isoc99_vwsÿnf
)

720 
	`__REDIRECT_NTH
 (
vswsÿnf
, (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

721 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

722 
__gnuc_va_li¡
 
__¬g
), 
__isoc99_vswsÿnf
)

725 
	`__isoc99_vfwsÿnf
 (
__FILE
 *
__»¡riù
 
__s
,

726 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

727 
__gnuc_va_li¡
 
__¬g
);

728 
	`__isoc99_vwsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

729 
__gnuc_va_li¡
 
__¬g
);

730 
	$__isoc99_vswsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

731 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

732 
__gnuc_va_li¡
 
__¬g
è
__THROW
;

733 
	#vfwsÿnf
 
__isoc99_vfwsÿnf


	)

734 
	#vwsÿnf
 
__isoc99_vwsÿnf


	)

735 
	#vswsÿnf
 
__isoc99_vswsÿnf


	)

739 
__END_NAMESPACE_C99


743 
__BEGIN_NAMESPACE_STD


748 
wšt_t
 
	`fg‘wc
 (
__FILE
 *
__¡»am
);

749 
wšt_t
 
	`g‘wc
 (
__FILE
 *
__¡»am
);

755 
wšt_t
 
	`g‘wch¬
 ();

762 
wšt_t
 
	`åutwc
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

763 
wšt_t
 
	`putwc
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

769 
wšt_t
 
	`putwch¬
 (
wch¬_t
 
__wc
);

777 
wch¬_t
 *
	`fg‘ws
 (wch¬_ˆ*
__»¡riù
 
__ws
, 
__n
,

778 
__FILE
 *
__»¡riù
 
__¡»am
);

784 
	`åutws
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ws
,

785 
__FILE
 *
__»¡riù
 
__¡»am
);

792 
wšt_t
 
	`ung‘wc
 (wšt_ˆ
__wc
, 
__FILE
 *
__¡»am
);

793 
__END_NAMESPACE_STD


796 #ifdeà
__USE_GNU


804 
wšt_t
 
	`g‘wc_uÆocked
 (
__FILE
 *
__¡»am
);

805 
wšt_t
 
	`g‘wch¬_uÆocked
 ();

813 
wšt_t
 
	`fg‘wc_uÆocked
 (
__FILE
 *
__¡»am
);

821 
wšt_t
 
	`åutwc_uÆocked
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

830 
wšt_t
 
	`putwc_uÆocked
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

831 
wšt_t
 
	`putwch¬_uÆocked
 (
wch¬_t
 
__wc
);

840 
wch¬_t
 *
	`fg‘ws_uÆocked
 (wch¬_ˆ*
__»¡riù
 
__ws
, 
__n
,

841 
__FILE
 *
__»¡riù
 
__¡»am
);

849 
	`åutws_uÆocked
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ws
,

850 
__FILE
 *
__»¡riù
 
__¡»am
);

854 
__BEGIN_NAMESPACE_C99


858 
size_t
 
	$wcsáime
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

859 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

860 cÚ¡ 
tm
 *
__»¡riù
 
__
è
__THROW
;

861 
__END_NAMESPACE_C99


863 #ifdeà
__USE_GNU


864 
	~<xloÿË.h
>

868 
size_t
 
	$wcsáime_l
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

869 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

870 cÚ¡ 
tm
 *
__»¡riù
 
__
,

871 
__loÿË_t
 
__loc
è
__THROW
;

880 #ià
defšed
 
__USE_UNIX98
 && !defšed 
__USE_GNU


881 
	#__Ãed_iswxxx


	)

882 
	~<wùy³.h
>

886 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


887 
	~<b™s/wch¬2.h
>

890 #ifdeà
__LDBL_COMPAT


891 
	~<b™s/wch¬-ldbl.h
>

894 
__END_DECLS


902 #undeà
__Ãed_mb¡©e_t


903 #undeà
__Ãed_wšt_t


	@/usr/include/wctype.h

23 #iâdeà
_WCTYPE_H


25 
	~<ã©u»s.h
>

26 
	~<b™s/ty³s.h
>

28 #iâdeà
__Ãed_iswxxx


29 
	#_WCTYPE_H
 1

	)

32 
	#__Ãed_wšt_t


	)

33 
	~<wch¬.h
>

37 #iâdeà
WEOF


38 
	#WEOF
 (0xffffffffu)

	)

41 #undeà
__Ãed_iswxxx


46 #iâdeà
__iswxxx_defšed


47 
	#__iswxxx_defšed
 1

	)

49 
__BEGIN_NAMESPACE_C99


52 
	twùy³_t
;

53 
	g__END_NAMESPACE_C99


55 #iâdeà
_ISwb™


60 
	~<’dŸn.h
>

61 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


62 
	#_ISwb™
(
b™
è(1 << (b™))

	)

64 
	#_ISwb™
(
b™
) \

65 ((
b™
) < 8 ? () ((1UL << (bit)) << 24) \

66 : ((
b™
) < 16 ? () ((1UL << (bit)) << 8) \

67 : ((
b™
) < 24 ? () ((1UL << (bit)) >> 8) \

68 : (è((1UL << (
b™
)è>> 24))))

	)

73 
	m__ISwuµ”
 = 0,

74 
	m__ISwlow”
 = 1,

75 
	m__ISw®pha
 = 2,

76 
	m__ISwdig™
 = 3,

77 
	m__ISwxdig™
 = 4,

78 
	m__ISw¥aû
 = 5,

79 
	m__ISw´št
 = 6,

80 
	m__ISwg¿ph
 = 7,

81 
	m__ISwbÏnk
 = 8,

82 
	m__ISwúŒl
 = 9,

83 
	m__ISwpunù
 = 10,

84 
	m__ISw®num
 = 11,

86 
	m_ISwuµ”
 = 
_ISwb™
 (
__ISwuµ”
),

87 
	m_ISwlow”
 = 
_ISwb™
 (
__ISwlow”
),

88 
	m_ISw®pha
 = 
_ISwb™
 (
__ISw®pha
),

89 
	m_ISwdig™
 = 
_ISwb™
 (
__ISwdig™
),

90 
	m_ISwxdig™
 = 
_ISwb™
 (
__ISwxdig™
),

91 
	m_ISw¥aû
 = 
_ISwb™
 (
__ISw¥aû
),

92 
	m_ISw´št
 = 
_ISwb™
 (
__ISw´št
),

93 
	m_ISwg¿ph
 = 
_ISwb™
 (
__ISwg¿ph
),

94 
	m_ISwbÏnk
 = 
_ISwb™
 (
__ISwbÏnk
),

95 
	m_ISwúŒl
 = 
_ISwb™
 (
__ISwúŒl
),

96 
	m_ISwpunù
 = 
_ISwb™
 (
__ISwpunù
),

97 
	m_ISw®num
 = 
_ISwb™
 (
__ISw®num
)

102 
__BEGIN_DECLS


104 
__BEGIN_NAMESPACE_C99


111 
	$isw®num
 (
wšt_t
 
__wc
è
__THROW
;

117 
	$isw®pha
 (
wšt_t
 
__wc
è
__THROW
;

120 
	$iswúŒl
 (
wšt_t
 
__wc
è
__THROW
;

124 
	$iswdig™
 (
wšt_t
 
__wc
è
__THROW
;

128 
	$iswg¿ph
 (
wšt_t
 
__wc
è
__THROW
;

133 
	$iswlow”
 (
wšt_t
 
__wc
è
__THROW
;

136 
	$isw´št
 (
wšt_t
 
__wc
è
__THROW
;

141 
	$iswpunù
 (
wšt_t
 
__wc
è
__THROW
;

146 
	$isw¥aû
 (
wšt_t
 
__wc
è
__THROW
;

151 
	$iswuµ”
 (
wšt_t
 
__wc
è
__THROW
;

156 
	$iswxdig™
 (
wšt_t
 
__wc
è
__THROW
;

161 #ifdeà
__USE_ISOC99


162 
	$iswbÏnk
 (
wšt_t
 
__wc
è
__THROW
;

171 
wùy³_t
 
	$wùy³
 (cÚ¡ *
__´İ”ty
è
__THROW
;

175 
	$iswùy³
 (
wšt_t
 
__wc
, 
wùy³_t
 
__desc
è
__THROW
;

176 
__END_NAMESPACE_C99


183 
__BEGIN_NAMESPACE_C99


186 cÚ¡ 
	t__št32_t
 *
	twù¿ns_t
;

187 
__END_NAMESPACE_C99


188 #ifdeà
__USE_GNU


189 
	$__USING_NAMESPACE_C99
(
wù¿ns_t
)

192 
__BEGIN_NAMESPACE_C99


194 
wšt_t
 
	$towlow”
 (
wšt_t
 
__wc
è
__THROW
;

197 
wšt_t
 
	$towuµ”
 (
wšt_t
 
__wc
è
__THROW
;

198 
__END_NAMESPACE_C99


200 
__END_DECLS


207 #ifdeà
_WCTYPE_H


213 
__BEGIN_DECLS


215 
__BEGIN_NAMESPACE_C99


218 
wù¿ns_t
 
	$wù¿ns
 (cÚ¡ *
__´İ”ty
è
__THROW
;

221 
wšt_t
 
	$towù¿ns
 (
wšt_t
 
__wc
, 
wù¿ns_t
 
__desc
è
__THROW
;

222 
__END_NAMESPACE_C99


224 #ifdeà
__USE_XOPEN2K8


226 
	~<xloÿË.h
>

230 
	$isw®num_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

236 
	$isw®pha_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

239 
	$iswúŒl_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

243 
	$iswdig™_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

247 
	$iswg¿ph_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

252 
	$iswlow”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

255 
	$isw´št_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

260 
	$iswpunù_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

265 
	$isw¥aû_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

270 
	$iswuµ”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

275 
	$iswxdig™_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

280 
	$iswbÏnk_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

284 
wùy³_t
 
	$wùy³_l
 (cÚ¡ *
__´İ”ty
, 
__loÿË_t
 
__loÿË
)

285 
__THROW
;

289 
	$iswùy³_l
 (
wšt_t
 
__wc
, 
wùy³_t
 
__desc
, 
__loÿË_t
 
__loÿË
)

290 
__THROW
;

298 
wšt_t
 
	$towlow”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

301 
wšt_t
 
	$towuµ”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

305 
wù¿ns_t
 
	$wù¿ns_l
 (cÚ¡ *
__´İ”ty
, 
__loÿË_t
 
__loÿË
)

306 
__THROW
;

309 
wšt_t
 
	$towù¿ns_l
 (
wšt_t
 
__wc
, 
wù¿ns_t
 
__desc
,

310 
__loÿË_t
 
__loÿË
è
__THROW
;

314 
__END_DECLS


	@
1
.
1
/usr/include
159
2109
adlist.c
adlist.h
ae.c
ae.h
ae_epoll.c
ae_evport.c
ae_kqueue.c
ae_select.c
anet.c
anet.h
aof.c
asciilogo.h
atomicvar.h
bio.c
bio.h
bitops.c
blocked.c
childinfo.c
cluster.c
cluster.h
config.c
config.h
crc16.c
crc64.c
crc64.h
db.c
debug.c
debugmacro.h
defrag.c
dict.c
dict.h
endianconv.c
endianconv.h
evict.c
expire.c
fmacros.h
geo.c
geo.h
geohash.c
geohash.h
geohash_helper.c
geohash_helper.h
help.h
hyperloglog.c
intset.c
intset.h
latency.c
latency.h
lazyfree.c
lzf.h
lzfP.h
lzf_c.c
lzf_d.c
memtest.c
module.c
modules/helloblock.c
modules/hellotype.c
modules/helloworld.c
modules/testmodule.c
multi.c
networking.c
notify.c
object.c
pqsort.c
pqsort.h
pubsub.c
quicklist.c
quicklist.h
rand.c
rand.h
rax.c
rax.h
rax_malloc.h
rdb.c
rdb.h
redis-benchmark.c
redis-check-aof.c
redis-check-rdb.c
redis-cli.c
redisassert.h
redismodule.h
release.c
replication.c
rio.c
rio.h
scripting.c
sds.c
sds.h
sdsalloc.h
sentinel.c
server.c
server.h
setproctitle.c
sha1.c
sha1.h
siphash.c
slowlog.c
slowlog.h
solarisfixes.h
sort.c
sparkline.c
sparkline.h
syncio.c
t_hash.c
t_list.c
t_set.c
t_string.c
t_zset.c
testhelp.h
util.c
util.h
version.h
ziplist.c
ziplist.h
zipmap.c
zipmap.h
zmalloc.c
zmalloc.h
/usr/include/arpa/inet.h
/usr/include/assert.h
/usr/include/ctype.h
/usr/include/dlfcn.h
/usr/include/endian.h
/usr/include/errno.h
/usr/include/execinfo.h
/usr/include/fcntl.h
/usr/include/features.h
/usr/include/inttypes.h
/usr/include/limits.h
/usr/include/linux/version.h
/usr/include/locale.h
/usr/include/math.h
/usr/include/netdb.h
/usr/include/netinet/in.h
/usr/include/netinet/tcp.h
/usr/include/poll.h
/usr/include/pthread.h
/usr/include/signal.h
/usr/include/stdint.h
/usr/include/stdio.h
/usr/include/stdlib.h
/usr/include/string.h
/usr/include/stropts.h
/usr/include/syslog.h
/usr/include/termios.h
/usr/include/time.h
/usr/include/ucontext.h
/usr/include/unistd.h
/usr/include/alloca.h
/usr/include/getopt.h
/usr/include/libio.h
/usr/include/rpc/netdb.h
/usr/include/sched.h
/usr/include/stdc-predef.h
/usr/include/xlocale.h
/usr/include/_G_config.h
/usr/include/gconv.h
/usr/include/wchar.h
/usr/include/wctype.h
